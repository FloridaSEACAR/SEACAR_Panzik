---
title: "SEACAR Oyster Analyses - Status and Trends"
author: "Stephen R. Durham"
date: "4/30/2021"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: "cerulean"
    code_folding: "hide"
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
div.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
#knitr::opts_chunk$set(include = FALSE)
library(Rmisc)
library(lubridate)
library(tidyverse)
library(ggplot2)
library(here)
library(sf)
library(mapview)
library(quantreg)
library(rcompanion)
library(data.table)
library(kableExtra)
library(DT)
library(nlme)
library(brms)
library(modelr)
library(tidybayes)
library(gamlss)
library(doFuture)
library(tictoc)
library(doRNG)
library(nlme)
library(lme4)
library(piecewiseSEM)
library(ggthemes)
```

```{r Load-oysterraw-rds, echo=TRUE, message=FALSE, warning=FALSE}
oysterraw <- readRDS(here::here("oysterraw_2021-02-09_wRegions.rds"))
oysterraw[, MA_plotlab := paste0(ManagedAreaName, "_", HabitatClassification)]
subtidal <- c(4044, 5007, 5071, 5073)
oysterraw[, Subtidal := ifelse(ProgramID %in% subtidal, 1, 0)]
oysterraw[, Subtidal := as.logical(Subtidal)]
oysterraw[!is.na(ShellHeight_mm), SHIndex := ObsIndex]
oysterraw[!is.na(Density_m2), DensIndex := ObsIndex]
oysterraw[!is.na(PercentLive_pct), PctIndex := ObsIndex]
oysterraw[!is.na(Number_of_Oysters_Counted_Total_Count), NTotIndex := ObsIndex]
oysterraw[!is.na(Number_of_Oysters_Counted_Live_Count), NLiveIndex := ObsIndex]
oysterraw[!is.na(Number_of_Oysters_Counted_Dead_Count), NDeadIndex := ObsIndex]

#Add in NumberMeasured_n value for ID5070 and ID5072; correct reefIDcrosswalk for ID5072
oysterraw[ProgramID == 5070, NumberMeasured_n := "ALL"]
oysterraw[ProgramID == 5072, NumberMeasured_n := "ALL"]
oysterraw[ProgramID == 5072, reefIDcrosswalk := "Unknown reef"]

#Other minor fixes
oysterraw[ProgramID == "5035", SampleDate := paste0(SampleDate, ":00")]
oysterraw[ProgramLocationID == "8859", SampleDate := "9/5/2018 19:28:00"]
LBs <- c("LB_R1", "LB_R2", "LB_R3")
oysterraw[ReefIdentifier %in% LBs, Month := "10"]

```

# All Sample Dates

```{r Indicator-data-subsets, echo=TRUE, message=FALSE, warning=FALSE}
# Separate oyster data into broad categories by indicator

#Reformat dataframe so that metadata rows are not duplicated for each data column. Based on solution posted here: https://stackoverflow.com/questions/54132853/how-to-collapse-a-dataframe-with-duplicate-ids-and-varying-missing-values-per-id

#oysterraw2 <- oysterraw[, c(2:32)] %>% 
#  dplyr::group_by(ProgramID, ProgramName, ProgramLocationID, QuadIdentifier, ReefIdentifier, LiveDate, 
#                  LiveDate_Qualifier, LiveDate_MinEstDate, LiveDate_MaxEstDate, GISUniqueID, SampleDate, 
#                  Year, Month, ManagedAreaName, Region, SurveyMethod, PercentLiveMethod, 
#                  HabitatClassification, MinimumSizeMeasured_mm, NumberMeasured_n, QuadSize_m2, MADup, 
#                  DataFileName, reefIDcrosswalk) %>%
#  tidyr::fill(Density_m2, PercentLive_pct, ShellHeight_mm, Number_of_Oysters_Counted_Total_Count, 
#              Number_of_Oysters_Counted_Live_Count, Number_of_Oysters_Counted_Dead_Count, ReefHeight_mm)%>%
#  tidyr::fill(Density_m2, PercentLive_pct, ShellHeight_mm, Number_of_Oysters_Counted_Total_Count, 
#              Number_of_Oysters_Counted_Live_Count, Number_of_Oysters_Counted_Dead_Count, ReefHeight_mm, 
#              .direction = 'up') %>%
#  dplyr::distinct()
#write.csv(oysterraw2, here::here("All_Parameters_but_Hectares_2020-Oct-06_noNA_srdedit.csv"))

#Create data table of shell heights
#oysterraw_sh <- oysterraw[, c(2:24, 27, 32:35)] %>%
oysterraw_sh <- oysterraw[, c("ProgramID", "ProgramName", "ProgramLocationID", "QuadIdentifier", "ReefIdentifier", "LiveDate", "LiveDate_Qualifier", "LiveDate_MinEstDate", "LiveDate_MaxEstDate", "GISUniqueID", "SampleDate", "Year", "Month", "ManagedAreaName", "Region.x", "SurveyMethod", "HabitatClassification", "MinimumSizeMeasured_mm", "NumberMeasured_n", "QuadSize_m2", "MADup", "DataFileName", "ShellHeight_mm", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "SHIndex")] %>%
            dplyr::group_by(ProgramID, ProgramName, ProgramLocationID, QuadIdentifier, ReefIdentifier, 
                            LiveDate, LiveDate_Qualifier, LiveDate_MinEstDate, LiveDate_MaxEstDate, 
                            GISUniqueID, SampleDate, Year, Month, ManagedAreaName, Region.x, SurveyMethod, 
                            HabitatClassification, MinimumSizeMeasured_mm, NumberMeasured_n, QuadSize_m2, 
                            MADup, DataFileName, reefIDcrosswalk, Region.y, MA_plotlab, Subtidal) %>%
            tidyr::fill(ShellHeight_mm, SHIndex) %>%
            tidyr::fill(ShellHeight_mm, SHIndex, .direction = 'up') %>%
            dplyr::distinct()
oysterraw_sh <- subset(oysterraw_sh, !is.na(oysterraw_sh$ShellHeight_mm) | !is.na(oysterraw_sh$SHIndex))


#oysterraw_old_sh <- oysterraw_old[, c(2:24,27)] %>%
#            dplyr::group_by(ProgramID, ProgramName, ProgramLocationID, QuadIdentifier, ReefIdentifier, 
#                            LiveDate, LiveDate_Qualifier, LiveDate_MinEstDate, LiveDate_MaxEstDate, 
#                            GISUniqueID, SampleDate, Year, Month, ManagedAreaName, Region, SurveyMethod, 
#                            PercentLiveMethod, HabitatClassification, MinimumSizeMeasured_mm, 
#                            NumberMeasured_n, QuadSize_m2, MADup, DataFileName) %>%
#            tidyr::fill(ShellHeight_mm) %>%
#            tidyr::fill(ShellHeight_mm, .direction = 'up') %>%
#            dplyr::distinct()
#oysterraw_old_sh <- subset(oysterraw_old_sh, !is.na(oysterraw_old_sh$ShellHeight_mm))


#Create data table of density and counts
#oysterraw_den <- oysterraw[, c(2:6, 11:17, 19, 22:23, 25, 28:30, 32:35)]
oysterraw_den <- oysterraw[, c("ProgramID", "ProgramName", "ProgramLocationID", "QuadIdentifier", "ReefIdentifier", "GISUniqueID", "SampleDate", "Year", "Month", "ManagedAreaName", "Region.x", "SurveyMethod", "HabitatClassification", "QuadSize_m2", "MADup", "Density_m2", "Number_of_Oysters_Counted_Total_Count", "Number_of_Oysters_Counted_Live_Count", "Number_of_Oysters_Counted_Dead_Count", "DensIndex", "NTotIndex", "NLiveIndex", "NDeadIndex", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal")]
oysterraw_den <- unique(oysterraw_den)
oysterraw_den <- oysterraw_den %>% 
                     dplyr::group_by(ProgramID, ProgramName, ProgramLocationID, QuadIdentifier, 
                                     ReefIdentifier, GISUniqueID, SampleDate, Year, Month, ManagedAreaName,
                                     Region.x, SurveyMethod, HabitatClassification, QuadSize_m2, MADup, reefIDcrosswalk, 
                                     Region.y, MA_plotlab, Subtidal) %>%
                     tidyr::fill(Density_m2, Number_of_Oysters_Counted_Total_Count, 
                                 Number_of_Oysters_Counted_Live_Count, Number_of_Oysters_Counted_Dead_Count,
                                 DensIndex, NTotIndex, NLiveIndex, NDeadIndex) %>%
                     tidyr::fill(Density_m2, Number_of_Oysters_Counted_Total_Count, 
                                 Number_of_Oysters_Counted_Live_Count, Number_of_Oysters_Counted_Dead_Count, 
                                 DensIndex, NTotIndex, NLiveIndex, NDeadIndex, .direction = 'up') %>%
                     dplyr::distinct()



oysterraw_den <- subset(oysterraw_den, !is.na(oysterraw_den$Density_m2) |
                             !is.na(oysterraw_den$Number_of_Oysters_Counted_Total_Count) | 
                             !is.na(oysterraw_den$Number_of_Oysters_Counted_Live_Count) | 
                             !is.na(oysterraw_den$Number_of_Oysters_Counted_Dead_Count) |
                             !is.na(oysterraw_den$DensIndex) | !is.na(oysterraw_den$NTotIndex) |
                             !is.na(oysterraw_den$NLiveIndex) | !is.na(oysterraw_den$NDeadIndex))


#4/12/2021 - Adding in updated raw data for ID972 from "All_Parameters_but_Hectares-2021-Mar-12.csv" because it has MADup duplication issues that prevent me from running the script with it from the beginning.

#Produce the new 972 data subset file.
# new972 <- fread(here::here("All_Parameters_but_Hectares-2021-Mar-12.csv"))
# setnames(new972, "Region", "Region.x")
# new972 <- new972[ProgramID == 972, ]
# new972[, `:=` (reefIDcrosswalk = character(), Region.y = character(), MA_plotlab = character(), Subtidal = logical(), SHIndex = integer(), DensIndex = integer(), PctIndex = integer(), NTotIndex = integer(), NLiveIndex = integer(), NDeadIndex = integer())]
# new972[, LiveDate_MinEstDate := as.numeric(LiveDate_MinEstDate)]
# new972[, LiveDate_MaxEstDate := as.numeric(LiveDate_MaxEstDate)]
# new972[, Year := as.character(Year)]
# new972[, Month := as.character(Month)]
# ColsFornew972 <- setdiff(colnames(oysterraw), colnames(new972))
# ColsFornew972 <- append(ColsFornew972, "ProgramLocationID")
# DatFornew972 <- oysterraw[, ..ColsFornew972]
# new972 <- merge(new972, DatFornew972, by = "ProgramLocationID")
# 
# new972_den <- new972[, c("ProgramID", "ProgramName", "ProgramLocationID", "QuadIdentifier", "ReefIdentifier", "GISUniqueID", "SampleDate", "Year", "Month", "ManagedAreaName", "Region.x", "SurveyMethod", "HabitatClassification", "QuadSize_m2", "MADup", "Density_m2", "Number_of_Oysters_Counted_Total_Count", "Number_of_Oysters_Counted_Live_Count", "Number_of_Oysters_Counted_Dead_Count", "DensIndex", "NTotIndex", "NLiveIndex", "NDeadIndex", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal")]
# new972_den <- unique(new972_den)
# new972_den <- new972_den %>% 
#                      dplyr::group_by(ProgramID, ProgramName, ProgramLocationID, QuadIdentifier, 
#                                      ReefIdentifier, GISUniqueID, SampleDate, Year, Month, ManagedAreaName,
#                                      Region.x, SurveyMethod, HabitatClassification, QuadSize_m2, MADup, reefIDcrosswalk, 
#                                      Region.y, MA_plotlab, Subtidal) %>%
#                      tidyr::fill(Density_m2, Number_of_Oysters_Counted_Total_Count, 
#                                  Number_of_Oysters_Counted_Live_Count, Number_of_Oysters_Counted_Dead_Count,
#                                  DensIndex, NTotIndex, NLiveIndex, NDeadIndex) %>%
#                      tidyr::fill(Density_m2, Number_of_Oysters_Counted_Total_Count, 
#                                  Number_of_Oysters_Counted_Live_Count, Number_of_Oysters_Counted_Dead_Count, 
#                                  DensIndex, NTotIndex, NLiveIndex, NDeadIndex, .direction = 'up') %>%
#                      dplyr::distinct()
# 
# new972_den <- subset(new972_den, !is.na(new972_den$Density_m2) |
#                              !is.na(new972_den$Number_of_Oysters_Counted_Total_Count) | 
#                              !is.na(new972_den$Number_of_Oysters_Counted_Live_Count) | 
#                              !is.na(new972_den$Number_of_Oysters_Counted_Dead_Count) |
#                              !is.na(new972_den$DensIndex) | !is.na(new972_den$NTotIndex) |
#                              !is.na(new972_den$NLiveIndex) | !is.na(new972_den$NDeadIndex))
# write.csv(new972_den, here::here("new972_den.csv"))

#Merge the new 972 data with the data for analysis.
new972_den_edited <- fread(here::here("new972_den_edited.csv"))
new972_den_edited[, V1 := NULL]
#c(max(oysterraw_den$DensIndex, na.rm = TRUE), max(oysterraw_den$NTotIndex, na.rm = TRUE), max(oysterraw_den$NLiveIndex, na.rm = TRUE), max(oysterraw_den$NDeadIndex, na.rm = TRUE))
new972_den_edited[, `:=` (DensIndex = seq(max(oysterraw_den$DensIndex, na.rm = TRUE) + 1, max(oysterraw_den$DensIndex, na.rm = TRUE) + length(new972_den_edited$ProgramID)), NTotIndex = seq(max(oysterraw_den$NTotIndex, na.rm = TRUE) + 1, max(oysterraw_den$NTotIndex, na.rm = TRUE) + length(new972_den_edited$ProgramID)), NLiveIndex = seq(max(oysterraw_den$NLiveIndex, na.rm = TRUE) + 1, max(oysterraw_den$NLiveIndex, na.rm = TRUE) + length(new972_den_edited$ProgramID)), NDeadIndex = seq(max(oysterraw_den$NDeadIndex, na.rm = TRUE) + 1, max(oysterraw_den$NDeadIndex, na.rm = TRUE) + length(new972_den_edited$ProgramID)), Subtidal = FALSE)]
new972_den_edited[, MA_plotlab := paste0(ManagedAreaName, "_", HabitatClassification)]
new972_den_edited[, Density_m2 := Number_of_Oysters_Counted_Live_Count/QuadSize_m2]
new972_den_edited[, QuadIdentifier := paste0(ProgramLocationID, "_", Month, Year, "_", QuadIdentifier)]
new972_den_edited[, Year := as.character(Year)]
new972_den_edited[, Month := as.character(Month)]
new972_den_edited[, reefIDcrosswalk := as.character(ReefIdentifier)]

#setdiff(colnames(oysterraw_den), colnames(new972_den_edited))

oysterraw_den_no972 <- subset(oysterraw_den, oysterraw_den$ProgramID != 972)
oysterraw_den <- rbind(oysterraw_den_no972, new972_den_edited)


#Create data table of percent live
#oysterraw_pct <- oysterraw[, c(2:6, 11:17, 18:19, 22:23, 26, 28:30, 32:35)]
oysterraw_pct <- oysterraw[, c("ProgramID", "ProgramName", "ProgramLocationID", "QuadIdentifier", "ReefIdentifier", "GISUniqueID", "SampleDate", "Year", "Month", "ManagedAreaName", "Region.x", "SurveyMethod", "PercentLiveMethod", "HabitatClassification", "QuadSize_m2", "MADup", "PercentLive_pct", "Number_of_Oysters_Counted_Total_Count", "Number_of_Oysters_Counted_Live_Count", "Number_of_Oysters_Counted_Dead_Count", "PctIndex", "NTotIndex", "NLiveIndex", "NDeadIndex", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal")]
oysterraw_pct <- unique(oysterraw_pct)
oysterraw_pct <- oysterraw_pct %>% 
                     dplyr::group_by(ProgramID, ProgramName, ProgramLocationID, QuadIdentifier, 
                                     ReefIdentifier, GISUniqueID, SampleDate, Year, Month, ManagedAreaName,
                                     Region.x, SurveyMethod, PercentLiveMethod, HabitatClassification, QuadSize_m2, MADup, 
                                     reefIDcrosswalk, Region.y, MA_plotlab, Subtidal) %>%
                     tidyr::fill(PercentLive_pct, Number_of_Oysters_Counted_Total_Count, 
                                 Number_of_Oysters_Counted_Live_Count, Number_of_Oysters_Counted_Dead_Count, 
                                 PctIndex, NTotIndex, NLiveIndex, NDeadIndex) %>%
                     tidyr::fill(PercentLive_pct, Number_of_Oysters_Counted_Total_Count, 
                                 Number_of_Oysters_Counted_Live_Count, Number_of_Oysters_Counted_Dead_Count, 
                                 PctIndex, NTotIndex, NLiveIndex, NDeadIndex, .direction = 'up') %>%
                     dplyr::distinct()



oysterraw_pct <- subset(oysterraw_pct, !is.na(oysterraw_pct$PercentLive_pct) |
                             !is.na(oysterraw_pct$Number_of_Oysters_Counted_Total_Count) | 
                             !is.na(oysterraw_pct$Number_of_Oysters_Counted_Live_Count) | 
                             !is.na(oysterraw_pct$Number_of_Oysters_Counted_Dead_Count) |
                             !is.na(oysterraw_pct$PctIndex) | !is.na(oysterraw_den$NTotIndex) |
                             !is.na(oysterraw_den$NLiveIndex) | !is.na(oysterraw_den$NDeadIndex))


#Add new RowIDs
#oysterraw_sh$RowID <- c(1:length(oysterraw_sh$ProgramID))
#oysterraw_den$RowID <- c(1:length(oysterraw_den$ProgramID))

#4/12/2021 - Adding in updated raw data for ID972 from "All_Parameters_but_Hectares-2021-Mar-12.csv" because it has MADup duplication issues that prevent me from running the script with it from the beginning. Modify existing new 972 file for density to percent live and merge with data for percent live analyses.
new972_pct_edited <- copy(new972_den_edited)
new972_pct_edited[, PercentLive_pct := (Number_of_Oysters_Counted_Live_Count/Number_of_Oysters_Counted_Total_Count)*100]
setnames(new972_pct_edited, "DensIndex", "PctIndex")
new972_pct_edited[, Density_m2 := NULL]
new972_pct_edited[, PercentLiveMethod := "Percent"]
new972_pct_edited[, `:=` (PctIndex = seq(max(oysterraw_pct$PctIndex, na.rm = TRUE) + 1, max(oysterraw_pct$PctIndex, na.rm = TRUE) + length(new972_pct_edited$ProgramID)), NTotIndex = seq(max(oysterraw_pct$NTotIndex, na.rm = TRUE) + 1, max(oysterraw_pct$NTotIndex, na.rm = TRUE) + length(new972_pct_edited$ProgramID)), NLiveIndex = seq(max(oysterraw_pct$NLiveIndex, na.rm = TRUE) + 1, max(oysterraw_pct$NLiveIndex, na.rm = TRUE) + length(new972_pct_edited$ProgramID)), NDeadIndex = seq(max(oysterraw_pct$NDeadIndex, na.rm = TRUE) + 1, max(oysterraw_pct$NDeadIndex, na.rm = TRUE) + length(new972_pct_edited$ProgramID)), Subtidal = FALSE)]

#setdiff(colnames(oysterraw_pct), colnames(new972_pct_edited))

oysterraw_pct_no972 <- subset(oysterraw_pct, oysterraw_pct$ProgramID != 972)
oysterraw_pct <- rbind(oysterraw_pct_no972, new972_pct_edited)

```

***

## Oyster size class

```{r Process-and-summarize-shell-height-data, echo=TRUE, message=FALSE, warning=FALSE}

oysterraw_sh <- oysterraw_sh %>% mutate(SampleDate = mdy_hms(SampleDate)) #convert Time to a timestamp
setDT(oysterraw_sh)
oysterraw_sh <- oysterraw_sh[LiveDate == "LiveDate unknown for dead shells", LiveDate := year(SampleDate)]
oysterraw_sh[, LiveDate2 := ifelse(LiveDate %in% "", year(SampleDate), ifelse(grepl("/", LiveDate, fixed = 
             TRUE), year(mdy(LiveDate)), ifelse(grepl("-", LiveDate, fixed = TRUE), year(ymd(LiveDate)), 
             LiveDate)))] 
oysterraw_sh[, LiveDate2 := as.numeric(LiveDate2)][, ('LiveDate2') := round(.SD, 0), .SDcols = 'LiveDate2']
oysterraw_sh <- oysterraw_sh[!is.na(LiveDate2)]
oysterraw_sh[, LiveDate2 := strptime(LiveDate2, "%Y")]
#oysterraw_sh[, MinimumSizeMeasured_mm := as.integer(MinimumSizeMeasured_mm)][ProgramID == 5035, MinimumSizeMeasured_mm := 20][ProgramID == 4016, NumberMeasured_n := 50]
oysterraw_sh[, LiveDate2 := year(ymd(LiveDate2))]

#Remove unrealistically high shell heights from ID_5017
Fix5017 <- oysterraw_sh[ProgramID == 5017, ][ShellHeight_mm < 165, ]
no5017 <- oysterraw_sh[ProgramID != 5017, ]
oysterraw_sh <- rbind(Fix5017, no5017)

#Make all LiveDate_Qualifier values that say "Exact (for live specimens only)" just say "Exact"
oysterraw_sh <- oysterraw_sh[LiveDate_Qualifier == "Exact (for live specimens only)", LiveDate_Qualifier := "Exact"]

#Save a copy of oysterraw_sh to make it faster to run portions of the scripts in the future
saveRDS(oysterraw_sh, here::here('oysterraw_sh.rds'))

#summarize shell height data
sh_all_sum <- summarySE(oysterraw_sh, measurevar = 'ShellHeight_mm', groupvars = c('ManagedAreaName', 
                        'LiveDate_Qualifier', 'LiveDate2'))
```

```{r TaveragedSHvModernSH, echo=TRUE, message=FALSE, warning=FALSE}
sh_o25 <- readRDS(here::here("GLMMs/sh_o25.rds"))
sh_25to75 <- subset(sh_o25, sh_o25$ShellHeight_mm < 75)
sh_o75 <- readRDS(here::here("GLMMs/sh_o75.rds"))

#Compare time-averaged HOBS samples with average of modern oyster samples (>25mm shell height)
sh_o25_avgmod_all <- sh_o25[LiveDate_Qualifier != "Estimate", ][, MeanSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, sdModSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, semModSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, nYears := length(unique(LiveDate2)), by = c('ManagedAreaName', 'HabitatClassification')][, MeanReefSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, sdReefSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, semReefSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, nYearsReef := length(unique(LiveDate2)), by = c('ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')]
#sh_o25_avgmod_reef <- unique(sh_o25_avgmod_all[, c(1:2, 5, 7, 14, 25:29, 42:45)])
sh_o25_avgmod_reef <- unique(sh_o25_avgmod_all[, c("ProgramID", "ProgramName", "ReefIdentifier", "LiveDate_Qualifier", "ManagedAreaName", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "LiveDate2", "MeanReefSH", "sdReefSH", "semReefSH", "nYearsReef")])

sh_o25_histdat_all <- sh_o25[LiveDate_Qualifier == "Estimate", ][, MeanSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, sdModSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, semModSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, nYears := length(unique(LiveDate2)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, MeanReefSH := mean(ShellHeight_mm), by = c('LiveDate2','ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, sdReefSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, semReefSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, nYearsReef := length(unique(LiveDate2)), by = c('ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')]
#sh_o25_histdat_reef <- unique(sh_o25_histdat_all[, c(1:2, 5, 7, 14, 25:29, 42:45)])
sh_o25_histdat_reef <- unique(sh_o25_histdat_all[, c("ProgramID", "ProgramName", "ReefIdentifier", "LiveDate_Qualifier", "ManagedAreaName", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "LiveDate2", "MeanReefSH", "sdReefSH", "semReefSH", "nYearsReef")])

sh_o25_avgReef <- rbind(sh_o25_avgmod_reef, sh_o25_histdat_reef)

#Compare time-averaged HOBS samples with average of modern oyster samples (25-75mm shell height)
sh_25to75_avgmod_all <- sh_25to75[LiveDate_Qualifier != "Estimate", ][, MeanSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, sdModSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, semModSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, nYears := length(unique(LiveDate2)), by = c('ManagedAreaName', 'HabitatClassification')][, MeanReefSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, sdReefSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, semReefSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, nYearsReef := length(unique(LiveDate2)), by = c('ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')]
#sh_25to75_avgmod_reef <- unique(sh_25to75_avgmod_all[, c(1:2, 5, 7, 14, 25:29, 42:45)])
sh_25to75_avgmod_reef <- unique(sh_25to75_avgmod_all[, c("ProgramID", "ProgramName", "ReefIdentifier", "LiveDate_Qualifier", "ManagedAreaName", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "LiveDate2", "MeanReefSH", "sdReefSH", "semReefSH", "nYearsReef")])

sh_25to75_histdat_all <- sh_25to75[LiveDate_Qualifier == "Estimate", ][, MeanSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, sdModSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, semModSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, nYears := length(unique(LiveDate2)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, MeanReefSH := mean(ShellHeight_mm), by = c('LiveDate2','ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, sdReefSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, semReefSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, nYearsReef := length(unique(LiveDate2)), by = c('ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')]
#sh_25to75_histdat_reef <- unique(sh_25to75_histdat_all[, c(1:2, 5, 7, 14, 25:29, 42:45)])
sh_25to75_histdat_reef <- unique(sh_25to75_histdat_all[, c("ProgramID", "ProgramName", "ReefIdentifier", "LiveDate_Qualifier", "ManagedAreaName", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "LiveDate2", "MeanReefSH", "sdReefSH", "semReefSH", "nYearsReef")])

sh_25to75_avgReef <- rbind(sh_25to75_avgmod_reef, sh_25to75_histdat_reef)

#Compare time-averaged HOBS samples with average of modern oyster samples (>75mm shell height)
sh_o75_avgmod_all <- sh_o75[LiveDate_Qualifier != "Estimate", ][, MeanSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, sdModSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, semModSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, nYears := length(unique(LiveDate2)), by = c('ManagedAreaName', 'HabitatClassification')][, MeanReefSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, sdReefSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, semReefSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, nYearsReef := length(unique(LiveDate2)), by = c('ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')]
#sh_o75_avgmod_reef <- unique(sh_o75_avgmod_all[, c(1:2, 5, 7, 14, 25:29, 42:45)])
sh_o75_avgmod_reef <- unique(sh_o75_avgmod_all[, c("ProgramID", "ProgramName", "ReefIdentifier", "LiveDate_Qualifier", "ManagedAreaName", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "LiveDate2", "MeanReefSH", "sdReefSH", "semReefSH", "nYearsReef")])

sh_o75_histdat_all <- sh_o75[LiveDate_Qualifier == "Estimate", ][, MeanSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, sdModSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, semModSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, nYears := length(unique(LiveDate2)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, MeanReefSH := mean(ShellHeight_mm), by = c('LiveDate2','ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, sdReefSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, semReefSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, nYearsReef := length(unique(LiveDate2)), by = c('ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')]
#sh_o75_histdat_reef <- unique(sh_o75_histdat_all[, c(1:2, 5, 7, 14, 25:29, 42:45)])
sh_o75_histdat_reef <- unique(sh_o75_histdat_all[, c("ProgramID", "ProgramName", "ReefIdentifier", "LiveDate_Qualifier", "ManagedAreaName", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "LiveDate2", "MeanReefSH", "sdReefSH", "semReefSH", "nYearsReef")])

sh_o75_avgReef <- rbind(sh_o75_avgmod_reef, sh_o75_histdat_reef)
```


### View the data {.tabset .tabset-fade}

#### Histograms (modern data only) {.tabset .tabset-fade .tabset-pills}

##### Shell height >25mm

```{r AvgSHbyReefandYRo25-hist, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#histogram of average shell height by reef and year
SH_AllDates_byRandYR_o25 <- ggplot(sh_o25_avgmod_reef, aes(MeanReefSH)) +
  geom_histogram(color = "black") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme_bw() + theme(axis.line = element_line()) #+
  #guides(color = FALSE) +
  #scale_x_continuous(limits = c(0, 150)) #+
  #scale_y_continuous(limits = c(0, 80))
  #coord_cartesian(ylim = c(-15, 40))
SH_AllDates_byRandYR_o25

ggsave(here::here(paste0("OA_plots/SH_AllDates_byRandYR_o25_", Sys.Date(), ".jpeg")),
       SH_AllDates_byRandYR_o25,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Shell height 25-75mm

```{r AvgSHbyReefandYR25to75-hist, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#histogram of average shell height by reef and year
SH_AllDates_byRandYR_25to75 <- ggplot(sh_25to75_avgmod_reef, aes(MeanReefSH)) +
  geom_histogram(color = "black") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme_bw() + theme(axis.line = element_line()) #+
  #guides(color = FALSE) +
  #scale_x_continuous(limits = c(0, 150)) #+
  #scale_y_continuous(limits = c(0, 80))
  #coord_cartesian(ylim = c(-15, 40))
SH_AllDates_byRandYR_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_byRandYR_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_byRandYR_o25,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Shell height >75mm

```{r AvgSHbyReefandYRo75-hist, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#histogram of average shell height by reef and year
SH_AllDates_byRandYR_o75 <- ggplot(sh_o75_avgmod_reef, aes(MeanReefSH)) +
  geom_histogram(color = "black") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme_bw() + theme(axis.line = element_line()) #+
  #guides(color = FALSE) +
  #scale_x_continuous(limits = c(0, 150)) #+
  #scale_y_continuous(limits = c(0, 80))
  #coord_cartesian(ylim = c(-15, 40))
SH_AllDates_byRandYR_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_byRandYR_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_byRandYR_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

#### Normal QQ plots (modern data only) {.tabset .tabset-fade .tabset-pills}

##### Shell height >25mm

```{r AvgSHbyReefandYRo25-qqplot, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#QQ plot of average shell height by reef and year
SH_AllDates_QQbyRandYR_o25 <- ggplot(sh_o25_avgmod_reef, aes(sample = MeanReefSH)) +
  geom_qq(shape = 1) +
  geom_qq_line(color = "red") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme_bw() + theme(axis.line = element_line()) #+
  #guides(color = FALSE) +
  #scale_x_continuous(limits = c(0, 150)) #+
  #scale_y_continuous(limits = c(0, 80))
  #coord_cartesian(ylim = c(-15, 40))
SH_AllDates_QQbyRandYR_o25

ggsave(here::here(paste0("OA_plots/SH_AllDates_QQbyRandYR_o25_", Sys.Date(), ".jpeg")),
       SH_AllDates_QQbyRandYR_o25,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Shell height 25-75mm

```{r AvgSHbyReefandYR25to75-qqplot, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#QQ plot of average shell height by reef and year
SH_AllDates_QQbyRandYR_25to75 <- ggplot(sh_25to75_avgmod_reef, aes(sample = MeanReefSH)) +
  geom_qq(shape = 1) +
  geom_qq_line(color = "red") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme_bw() + theme(axis.line = element_line()) #+
  #guides(color = FALSE) +
  #scale_x_continuous(limits = c(0, 150)) #+
  #scale_y_continuous(limits = c(0, 80))
  #coord_cartesian(ylim = c(-15, 40))
SH_AllDates_QQbyRandYR_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_QQbyRandYR_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_QQbyRandYR_25to75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Shell height >75mm

```{r AvgSHbyReefandYRo75-qqplot, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#QQ plot of average shell height by reef and year
SH_AllDates_QQbyRandYR_o75 <- ggplot(sh_o75_avgmod_reef, aes(sample = MeanReefSH)) +
  geom_qq(shape = 1) +
  geom_qq_line(color = "red") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme_bw() + theme(axis.line = element_line()) #+
  #guides(color = FALSE) +
  #scale_x_continuous(limits = c(0, 150)) #+
  #scale_y_continuous(limits = c(0, 80))
  #coord_cartesian(ylim = c(-15, 40))
SH_AllDates_QQbyRandYR_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_QQbyRandYR_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_QQbyRandYR_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

### Regression summary tables {.tabset .tabset-fade}

#### Quantile Regression  {.tabset .tabset-fade .tabset-pills}

##### Shell height >25mm

```{r AvgSHbyReefandYRo25-QuantReg, echo=TRUE, message = FALSE, warning = FALSE}
#Run nonparametric regression (quantile regression) on average >25mm SH reef-level data by year, if there are >4 years of data
#Followed quantile regression example here: https://rcompanion.org/handbook/F_12.html; accessed 10/14/2020
qreg_results_o25 <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), pvalue = numeric(), pseudoR2 = numeric())
for(i in unique(sh_o25_avgReef$MA_plotlab)){
  qrdat <- sh_o25_avgReef[MA_plotlab == i, ]
  if(length(unique(qrdat$LiveDate2)) < 5) next
  quantregs <- rq(MeanReefSH ~ LiveDate2, data = qrdat, tau = 0.5)
  nullmod <- rq(MeanReefSH ~ 1, data = qrdat, tau = 0.5)
  anov <- anova(quantregs, nullmod)
  PseudR <- nagelkerke(quantregs)
  iresult <- data.table(MA_plotlab = i, intercept = quantregs$coefficients[[1]], slope = quantregs$coefficients[[2]], pvalue = anov$table[[4]], 
                        pseudoR2 = PseudR$Pseudo.R.squared.for.model.vs.null[[3]])
  qreg_results_o25 <- rbind(qreg_results_o25, iresult)
}

setorder(qreg_results_o25, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
qreg_results_o25_renamed <- setnames(qreg_results_o25, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(qreg_results_o25, 'Managed Area_Habitat Class.', 'MA_plotlab')

qreg_results_o25_renamed %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)

```

<br><br><br>

##### Shell height 25-75mm

```{r AvgSHbyReefandYR25to75-QuantReg, echo=TRUE, message = FALSE, warning = FALSE}
#Run nonparametric regression (quantile regression) on average >25mm SH reef-level data by year, if there are >4 years of data
#Followed quantile regression example here: https://rcompanion.org/handbook/F_12.html; accessed 10/14/2020
qreg_results_25to75 <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), pvalue = numeric(), pseudoR2 = numeric())
for(i in unique(sh_25to75_avgReef$MA_plotlab)){
  qrdat <- sh_25to75_avgReef[MA_plotlab == i, ]
  if(length(unique(qrdat$LiveDate2)) < 5) next
  quantregs <- rq(MeanReefSH ~ LiveDate2, data = qrdat, tau = 0.5)
  nullmod <- rq(MeanReefSH ~ 1, data = qrdat, tau = 0.5)
  anov <- anova(quantregs, nullmod)
  PseudR <- nagelkerke(quantregs)
  iresult <- data.table(MA_plotlab = i, intercept = quantregs$coefficients[[1]], slope = quantregs$coefficients[[2]], pvalue = anov$table[[4]], 
                        pseudoR2 = PseudR$Pseudo.R.squared.for.model.vs.null[[3]])
  qreg_results_25to75 <- rbind(qreg_results_25to75, iresult)
}

setorder(qreg_results_25to75, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
qreg_results_25to75_renamed <- setnames(qreg_results_25to75, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(qreg_results_25to75, 'Managed Area_Habitat Class.', 'MA_plotlab')

qreg_results_25to75_renamed %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)

```

<br><br><br>

##### Shell height >75mm

```{r AvgSHbyReefandYRo75-QuantReg, echo=TRUE, message = FALSE, warning = FALSE}
#Run nonparametric regression (quantile regression) on average >75mm SH reef-level data by year, if there are >4 years of data
#Followed quantile regression example here: https://rcompanion.org/handbook/F_12.html; accessed 10/14/2020
qreg_results_o75 <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), pvalue = numeric(), pseudoR2 = numeric())
for(i in unique(sh_o75_avgReef$MA_plotlab)){
  qrdat <- sh_o75_avgReef[MA_plotlab == i, ]
  if(length(unique(qrdat$LiveDate2)) < 5) next
  quantregs <- rq(MeanReefSH ~ LiveDate2, data = qrdat, tau = 0.5)
  nullmod <- rq(MeanReefSH ~ 1, data = qrdat, tau = 0.5)
  anov <- anova(quantregs, nullmod)
  PseudR <- nagelkerke(quantregs)
  iresult <- data.table(MA_plotlab = i, intercept = quantregs$coefficients[[1]], slope = quantregs$coefficients[[2]], pvalue = anov$table[[4]], 
                        pseudoR2 = PseudR$Pseudo.R.squared.for.model.vs.null[[3]])
  qreg_results_o75 <- rbind(qreg_results_o75, iresult)
}

setorder(qreg_results_o75, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
qreg_results_o75_renamed <- setnames(qreg_results_o75, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(qreg_results_o75, 'Managed Area_Habitat Class.', 'MA_plotlab')

qreg_results_o75_renamed %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)

```

<br><br><br>

#### Linear Regression  {.tabset .tabset-fade .tabset-pills}

##### Shell height >25mm

```{r AvgSHbyReefandYRo25-LinReg, echo=TRUE, message = FALSE, warning = FALSE}
#Run linear regression on average >25mm SH reef-level data by year, if there are >4 years of data
lm_results_o25 <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), Fstatistic = numeric(), numdf = numeric(), dendf = numeric(), pvalue = numeric(), adjustedR2 = numeric())
for(i in unique(sh_o25_avgReef$MA_plotlab)){
  lmdat <- sh_o25_avgReef[MA_plotlab == i, ]
  if(length(unique(lmdat$LiveDate2)) < 5) next
  lms <- lm(MeanReefSH ~ LiveDate2, data = lmdat)
  iresult <- data.table(MA_plotlab = i, intercept = lms$coefficients[[1]], slope = lms$coefficients[[2]], Fstatistic = summary(lms)$fstatistic[[1]], numdf = summary(lms)$fstatistic[[2]], dendf = summary(lms)$fstatistic[[3]], pvalue = anova(lms)$Pr[1], adjustedR2 = summary(lms)$adj.r.squared)
  lm_results_o25 <- rbind(lm_results_o25, iresult)
}

setorder(lm_results_o25, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
lm_results_o25_renamed <- setnames(lm_results_o25, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(lm_results_o25, 'Managed Area_Habitat Class.', 'MA_plotlab')

lm_results_o25_renamed %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)

```

<br><br><br>

##### Shell height 25-75mm

```{r AvgSHbyReefandYR25to75-LinReg, echo=TRUE, message = FALSE, warning = FALSE}
#Run linear regression on average >25mm SH reef-level data by year, if there are >4 years of data
lm_results_25to75 <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), Fstatistic = numeric(), numdf = numeric(), dendf = numeric(), pvalue = numeric(), adjustedR2 = numeric())
for(i in unique(sh_25to75_avgReef$MA_plotlab)){
  lmdat <- sh_25to75_avgReef[MA_plotlab == i, ]
  if(length(unique(lmdat$LiveDate2)) < 5) next
  lms <- lm(MeanReefSH ~ LiveDate2, data = lmdat)
  iresult <- data.table(MA_plotlab = i, intercept = lms$coefficients[[1]], slope = lms$coefficients[[2]], Fstatistic = summary(lms)$fstatistic[[1]], numdf = summary(lms)$fstatistic[[2]], dendf = summary(lms)$fstatistic[[3]], pvalue = anova(lms)$Pr[1], adjustedR2 = summary(lms)$adj.r.squared)
  lm_results_25to75 <- rbind(lm_results_25to75, iresult)
}

setorder(lm_results_25to75, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
lm_results_25to75_renamed <- setnames(lm_results_25to75, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(lm_results_25to75, 'Managed Area_Habitat Class.', 'MA_plotlab')

lm_results_25to75_renamed %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)

```

<br><br><br>

##### Shell height >75mm

```{r AvgSHbyReefandYRo75-LinReg, echo=TRUE, message = FALSE, warning = FALSE}
#Run linear regression on average >75mm SH reef-level data by year, if there are >4 years of data
lm_results_o75 <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), Fstatistic = numeric(), numdf = numeric(), dendf = numeric(), pvalue = numeric(), adjustedR2 = numeric())
for(i in unique(sh_o75_avgReef$MA_plotlab)){
  lmdat <- sh_o75_avgReef[MA_plotlab == i, ]
  if(length(unique(lmdat$LiveDate2)) < 5) next
  lms <- lm(MeanReefSH ~ LiveDate2, data = lmdat)
  iresult <- data.table(MA_plotlab = i, intercept = lms$coefficients[[1]], slope = lms$coefficients[[2]], Fstatistic = summary(lms)$fstatistic[[1]], numdf = summary(lms)$fstatistic[[2]], dendf = summary(lms)$fstatistic[[3]], pvalue = anova(lms)$Pr[1], adjustedR2 = summary(lms)$adj.r.squared)
  lm_results_o75 <- rbind(lm_results_o75, iresult)
}

setorder(lm_results_o75, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
lm_results_o75_renamed <- setnames(lm_results_o75, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(lm_results_o75, 'Managed Area_Habitat Class.', 'MA_plotlab')

lm_results_o75_renamed %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)

```

<br><br><br>

### Linear regression diagnostic plots {.tabset .tabset-fade}

#### Shell height >25mm {.tabset .tabset-fade .tabset-pills}

##### Apalachicola Bay_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 4)

```

<br><br><br>

##### Apalachicola NERR_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 4)

```

<br><br><br>

##### Big Bend Seagrasses_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Big Bend Seagrasses_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Big Bend Seagrasses_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Big Bend Seagrasses_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Big Bend Seagrasses_Natural", ]), which = 4)

```

<br><br><br>

##### Estero Bay_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Estero Bay_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Estero Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Estero Bay_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Estero Bay_Natural", ]), which = 4)

```

<br><br><br>

##### Guana River Marsh_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 4)

```

<br><br><br>

##### Guana Tolomato Matanzas NERR_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 4)

```

<br><br><br>

##### Indian River-Vero Beach to Ft. Pierce_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural", ]), which = 4)

```

<br><br><br>

##### Lemon Bay_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Lemon Bay_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Lemon Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Lemon Bay_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Lemon Bay_Natural", ]), which = 4)

```

<br><br><br>

<!-- ```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"} -->
<!-- ##### Pellicer Creek_Natural -->
<!-- #plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Pellicer Creek_Natural", ]), which = 1) -->

<!-- #plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Pellicer Creek_Natural", ]), which = 2) -->

<!-- ``` -->

<!-- ```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"} -->

<!-- #plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Pellicer Creek_Natural", ]), which = 3) -->

<!-- #plot(lm(MeanReefSH ~ LiveDate2, data = sh_o25_avgReef[MA_plotlab == "Pellicer Creek_Natural", ]), which = 4) -->
<!-- #<br><br><br> -->
<!-- ``` -->


#### Shell height 25-75mm {.tabset .tabset-fade .tabset-pills}

##### Apalachicola Bay_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 4)

```

<br><br><br>

##### Apalachicola NERR_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 4)

```

<br><br><br>

##### Big Bend Seagrasses_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Big Bend Seagrasses_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Big Bend Seagrasses_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Big Bend Seagrasses_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Big Bend Seagrasses_Natural", ]), which = 4)

```

<br><br><br>

##### Estero Bay_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Estero Bay_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Estero Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Estero Bay_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Estero Bay_Natural", ]), which = 4)

```

<br><br><br>

##### Guana River Marsh_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 4)

```

<br><br><br>

##### Guana Tolomato Matanzas NERR_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 4)

```

<br><br><br>

##### Indian River-Vero Beach to Ft. Pierce_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural", ]), which = 4)

```

<br><br><br>

##### Lemon Bay_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Lemon Bay_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Lemon Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Lemon Bay_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_25to75_avgReef[MA_plotlab == "Lemon Bay_Natural", ]), which = 4)

```

<br><br><br>

#### Shell height >75mm {.tabset .tabset-fade .tabset-pills}

##### Apalachicola Bay_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 4)

```

<br><br><br>

##### Apalachicola NERR_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 4)

```

<br><br><br>

##### Big Bend Seagrasses_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Big Bend Seagrasses_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Big Bend Seagrasses_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Big Bend Seagrasses_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Big Bend Seagrasses_Natural", ]), which = 4)

```

<br><br><br>

##### Estero Bay_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Estero Bay_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Estero Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Estero Bay_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Estero Bay_Natural", ]), which = 4)

```

<br><br><br>

##### Guana River Marsh_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 4)

```

<br><br><br>

##### Guana Tolomato Matanzas NERR_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 4)

```

<br><br><br>

##### Indian River-Vero Beach to Ft. Pierce_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural", ]), which = 4)

```

<br><br><br>

##### Lemon Bay_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Lemon Bay_Natural", ]), which = 1)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Lemon Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Lemon Bay_Natural", ]), which = 3)

plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Lemon Bay_Natural", ]), which = 4)

```

<br><br><br>

<!-- ```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"} -->
<!-- ##### Pellicer Creek_Natural -->
<!-- #plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Pellicer Creek_Natural", ]), which = 1) -->

<!-- #plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Pellicer Creek_Natural", ]), which = 2) -->

<!-- ``` -->

<!-- ```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"} -->

<!-- #plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Pellicer Creek_Natural", ]), which = 3) -->

<!-- #plot(lm(MeanReefSH ~ LiveDate2, data = sh_o75_avgReef[MA_plotlab == "Pellicer Creek_Natural", ]), which = 4) -->
<!-- #<br><br><br> -->
<!-- ``` -->




### Regression plots {.tabset .tabset-fade}

#### Quantile regression  {.tabset .tabset-fade}

##### Shell height >25mm {.tabset .tabset-fade .tabset-pills}

###### 1950-2020

```{r AvgSHbyReefandYRo25-QuantRegPlot-1950-2020, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot reef-level average shell height >25mm, including quantile regression lines, as applicable, and restricted to years 1950 - 2020.
SH_AllDates_QuantReg1950to2020_o25 <- ggplot(sh_o25_avgmod_reef, aes(LiveDate2, MeanReefSH, fill = reefIDcrosswalk)) +
  geom_point(shape = 21) +
  geom_point(data = sh_o25_histdat_reef, shape = 24) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = qreg_results_o25, aes(intercept = intercept, slope = slope)) +
  #xlim(1950, 2020) +
  guides(fill = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(1950, 2020)) +
  scale_y_continuous(limits = c(25, 140))
  
SH_AllDates_QuantReg1950to2020_o25

ggsave(here::here(paste0("OA_plots/SH_AllDates_QuantReg1950to2020_o25_", Sys.Date(), ".jpeg")),
       SH_AllDates_QuantReg1950to2020_o25,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### All years

```{r AvgSHbyReefandYRo25-QuantRegPlot-allyears, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot reef-level average shell height >25mm, including quantile regression lines, as applicable, and full range of years.
SH_AllDates_QuantRegAllYears_o25 <- ggplot(sh_o25_avgmod_reef, aes(LiveDate2, MeanReefSH, fill = ReefIdentifier)) +
  geom_point(shape = 21) +
  geom_point(data = sh_o25_histdat_reef, shape = 24) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = qreg_results_o25, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(100, 2020)) +
  scale_y_continuous(limits = c(25, 140))
SH_AllDates_QuantRegAllYears_o25

ggsave(here::here(paste0("OA_plots/SH_AllDates_QuantRegAllYears_o25_", Sys.Date(), ".jpeg")),
       SH_AllDates_QuantRegAllYears_o25,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Shell height 25-75mm {.tabset .tabset-fade .tabset-pills}

###### 1950-2020

```{r AvgSHbyReefandYR25to75-QuantRegPlot-1950-2020, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot reef-level average shell height >25mm, including quantile regression lines, as applicable, and restricted to years 1950 - 2020.
SH_AllDates_QuantReg1950to2020_25to75 <- ggplot(sh_25to75_avgmod_reef, aes(LiveDate2, MeanReefSH, fill = reefIDcrosswalk)) +
  geom_point(shape = 21) +
  geom_point(data = sh_25to75_histdat_reef, shape = 24) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = qreg_results_25to75, aes(intercept = intercept, slope = slope)) +
  #xlim(1950, 2020) +
  guides(fill = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(1950, 2020)) +
  scale_y_continuous(limits = c(25, 140))
  
SH_AllDates_QuantReg1950to2020_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_QuantReg1950to2020_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_QuantReg1950to2020_25to75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### All years

```{r AvgSHbyReefandYR25to75-QuantRegPlot-allyears, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot reef-level average shell height >25mm, including quantile regression lines, as applicable, and full range of years.
SH_AllDates_QuantRegAllYears_25to75 <- ggplot(sh_25to75_avgmod_reef, aes(LiveDate2, MeanReefSH, fill = ReefIdentifier)) +
  geom_point(shape = 21) +
  geom_point(data = sh_25to75_histdat_reef, shape = 24) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = qreg_results_25to75, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(100, 2020)) +
  scale_y_continuous(limits = c(25, 140))
SH_AllDates_QuantRegAllYears_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_QuantRegAllYears_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_QuantRegAllYears_25to75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Shell height >75mm {.tabset .tabset-fade .tabset-pills}

###### 1950-2020

```{r AvgSHbyReefandYRo75-QuantRegPlot-1950-2020, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot reef-level average shell height >75mm, including quantile regression lines, as applicable, and restricted to years 1950 - 2020.
SH_AllDates_QuantReg1950to2020_o75 <- ggplot(sh_o75_avgmod_reef, aes(LiveDate2, MeanReefSH, fill = ReefIdentifier)) +
  geom_point(shape = 21) +
  geom_point(data = sh_o75_histdat_reef, shape = 24) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = qreg_results_o75, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(1950, 2020)) +
  scale_y_continuous(limits = c(25, 140))
SH_AllDates_QuantReg1950to2020_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_QuantReg1950to2020_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_QuantReg1950to2020_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### All years

```{r AvgSHbyReefandYRo75-QuantRegPlot-allyears, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot reef-level average shell height >75mm, including quantile regression lines, as applicable, and full range of years.
SH_AllDates_QuantRegAllYears_o75 <- ggplot(sh_o75_avgmod_reef, aes(LiveDate2, MeanReefSH, fill = ReefIdentifier)) +
  geom_point(shape = 21) +
  geom_point(data = sh_o75_histdat_reef, shape = 24) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = qreg_results_o75, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(100, 2020)) +
  scale_y_continuous(limits = c(25, 140))
SH_AllDates_QuantRegAllYears_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_QuantRegAllYears_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_QuantRegAllYears_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

#### Linear regression  {.tabset .tabset-fade}

##### Shell height >25mm {.tabset .tabset-fade .tabset-pills}

###### 1950-2020

```{r AvgSHbyReefandYRo25-LinRegPlot-1950-2020, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot reef-level average shell height >25mm, including linear regression lines, as applicable, and restricted to years 1950 - 2020.
SH_AllDates_LinReg1950to2020_o25 <- ggplot(sh_o25_avgmod_reef, aes(LiveDate2, MeanReefSH, fill = reefIDcrosswalk)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_point(shape = 21) +
  geom_point(data = sh_o25_histdat_reef, shape = 24) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = lm_results_o25, aes(intercept = intercept, slope = slope)) +
  xlim(1950, 2020) +
  guides(fill = FALSE)
SH_AllDates_LinReg1950to2020_o25

ggsave(here::here(paste0("OA_plots/SH_AllDates_LinReg1950to2020_o25_", Sys.Date(), ".jpeg")),
       SH_AllDates_LinReg1950to2020_o25,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### All years

```{r AvgSHbyReefandYRo25-LinRegPlot-allyears, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot reef-level average shell height >25mm, including quantile regression lines, as applicable, and full range of years.
SH_AllDates_LinRegAllYears_o25 <- ggplot(sh_o25_avgmod_reef, aes(LiveDate2, MeanReefSH, fill = ReefIdentifier)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_point(shape = 21) +
  geom_point(data = sh_o25_histdat_reef, shape = 24) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = lm_results_o25, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 90))
SH_AllDates_LinRegAllYears_o25

ggsave(here::here(paste0("OA_plots/SH_AllDates_LinRegAllYears_o25_", Sys.Date(), ".jpeg")),
       SH_AllDates_LinRegAllYears_o25,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Shell height 2-75mm {.tabset .tabset-fade .tabset-pills}

###### 1950-2020

```{r AvgSHbyReefandYR25to75-LinRegPlot-1950-2020, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot reef-level average shell height >25mm, including linear regression lines, as applicable, and restricted to years 1950 - 2020.
SH_AllDates_LinReg1950to2020_25to75 <- ggplot(sh_25to75_avgmod_reef, aes(LiveDate2, MeanReefSH, fill = reefIDcrosswalk)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_point(shape = 21) +
  geom_point(data = sh_25to75_histdat_reef, shape = 24) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = lm_results_25to75, aes(intercept = intercept, slope = slope)) +
  xlim(1950, 2020) +
  guides(fill = FALSE)
SH_AllDates_LinReg1950to2020_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_LinReg1950to2020_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_LinReg1950to2020_25to75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### All years

```{r AvgSHbyReefandYR25to75-LinRegPlot-allyears, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot reef-level average shell height >25mm, including quantile regression lines, as applicable, and full range of years.
SH_AllDates_LinRegAllYears_25to75 <- ggplot(sh_25to75_avgmod_reef, aes(LiveDate2, MeanReefSH, fill = ReefIdentifier)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_point(shape = 21) +
  geom_point(data = sh_25to75_histdat_reef, shape = 24) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = lm_results_25to75, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 90))
SH_AllDates_LinRegAllYears_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_LinRegAllYears_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_LinRegAllYears_25to75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Shell height >75mm {.tabset .tabset-fade .tabset-pills}

###### 1950-2020

```{r AvgSHbyReefandYRo75-LinRegPlot-1950-2020, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot reef-level average shell height >75mm, including quantile regression lines, as applicable, and restricted to years 1950 - 2020.
SH_AllDates_LinReg1950to2020_o75 <- ggplot(sh_o75_avgmod_reef, aes(LiveDate2, MeanReefSH, fill = ReefIdentifier)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_point(shape = 21) +
  geom_point(data = sh_o75_histdat_reef, shape = 24) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = lm_results_o75, aes(intercept = intercept, slope = slope)) +
  xlim(1950, 2020) +
  guides(fill = FALSE)
SH_AllDates_LinReg1950to2020_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_LinReg1950to2020_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_LinReg1950to2020_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### All years

```{r AvgSHbyReefandYRo75-LinRegPlot-allyears, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot reef-level average shell height >75mm, including quantile regression lines, as applicable, and full range of years.
SH_AllDates_LinRegAllYears_o75 <- ggplot(sh_o75_avgmod_reef, aes(LiveDate2, MeanReefSH, fill = ReefIdentifier)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_point(shape = 21) +
  geom_point(data = sh_o75_histdat_reef, shape = 24) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = lm_results_o75, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 90))
SH_AllDates_LinRegAllYears_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_LinRegAllYears_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_LinRegAllYears_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

### Generalized Linear Mixed Effects Models {.tabset .tabset-fade}

#### Apalachicola Bay_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# 
 ab_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Apalachicola Bay_Natural")
 ab_sho25[, QuadSize_m2 := as.factor(QuadSize_m2)]
 ab_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
 ab_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
 ab_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
 ab_sho25[ShellHeight_mm < 75, SizeClass := "25to75mm"]
 ab_sho25[ShellHeight_mm >= 75, SizeClass := "o75mm"]

#Exclude the five samples that don't have counts less than the "NumberMeasured" value for the corresponding program (see variable exploration graphs in the 25to75mm section for the rationale and graphs for this step.)
ab_sho25[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", LiveDate2, "-", Month)]
numValves <- ab_sho25[, counts := length(ShellHeight_mm), by = c("rc_quad_yrmo")]
numValves <- unique(numValves[, c("ProgramID", "RelYear2", "counts", "rc_quad_yrmo", "Subtidal", "QuadSize_m2", "LiveDate_Qualifier", "NumberMeasured_n")])
exclude_samps <- subset(numValves, numValves$NumberMeasured_n == "20" & numValves$counts > 19)$rc_quad_yrmo
ab_sho25 <- subset(ab_sho25, ab_sho25$rc_quad_yrmo %in% setdiff(ab_sho25$rc_quad_yrmo, exclude_samps))

saveRDS(ab_sho25, here::here(paste0('GLMMs/AllDates/Data/ab_sho25_', Sys.Date(), '.rds')))
# 
# ab_sh25to75 <- subset(ab_sho25, ab_sho25$ShellHeight_mm < 75)
# 
# ab_sho25_glmm <- brm(formula = ShellHeight_mm ~ RelYear + QuadSize_m2 + NumberMeasured_n + LiveDate_Qualifier + Subtidal + (1 + RelYear|reefIDcrosswalk), data = ab_sho25, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "identity"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# ab_sho25_glmm <- add_criterion(ab_sho25_glmm, "loo")
# 
# #I am writing down the separate models I tried after already running them and the reported information for 11:13 are largely the same; some of the differences had to do with increasing the adapt_delta and max_treedepth arguments, but I don't know exactly what they were for 11 and 12. I am also not confident in the adapt_delta or max_treedepth values for the other models in this list.
# 
# ab_sho25_glmm1 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + QuadSize_m2 + NumberMeasured_n + Subtidal, data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 2000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# 
# ab_sho25_glmm2 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear, data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/ab_sho25_glmm2.rds")
# ab_sho25_glmm2 <- add_criterion(ab_sho25_glmm2, "loo")
# 
# ab_sho25_glmm3 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + QuadSize_m2, data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# 
# ab_sho25_glmm4 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + NumberMeasured_n, data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/ab_sho25_glmm4.rds")
# ab_sho25_glmm4 <- add_criterion(ab_sho25_glmm4, "loo")
# 
# ab_sho25_glmm5 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear2 + Subtidal, data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2)) #, file = "GLMMs/ab_sho25_glmm5.rds")
# ab_sho25_glmm5 <- add_criterion(ab_sho25_glmm5, "loo")
# 
# ab_sho25_glmm6 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + NumberMeasured_n + Subtidal, data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# 
# #there is no model 7
# ab_sho25_glmm8 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + (0 + RelYear | NumberMeasured_n), data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# ab_sho25_glmm8 <- add_criterion(ab_sho25_glmm8, "loo")
# 
# ab_sho25_glmm9 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + (1 + RelYear | NumberMeasured_n), data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# ab_sho25_glmm9 <- add_criterion(ab_sho25_glmm9, "loo")
# 
# ab_sho25_glmm10 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + (1 | Subtidal), data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# ab_sho25_glmm10 <- add_criterion(ab_sho25_glmm10, "loo")
# 
# ab_sho25_glmm11 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + (1 + RelYear | Subtidal), data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# 
# ab_sho25_glmm12 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + (1 + RelYear | Subtidal), data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# 
# ab_sho25_glmm13 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + (1 + RelYear | Subtidal), data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), family = skew_normal, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 10), iter = 4000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# 
# #GLMM 5 is the best fit to the data when compared with the other major parameterizations that successfully converged.
# ab_comp <- loo_compare(ab_sho25_glmm4, ab_sho25_glmm5, ab_sho25_glmm8, ab_sho25_glmm9, ab_sho25_glmm10)
# print(ab_comp, simplify = FALSE, digits = 3)
# 
# #predtest <- predict(ab_sho25_glmm9, newdata = subset(ab_sho25, ab_sho25$LiveDate_Qualifier == "Estimate"))
# 
# saveRDS(ab_sho25_glmm5, here::here('GLMMs/AllDates/ab_sho25_glmm.rds'))
# 
# 
# 
# ab_sho25_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ me(RelYear2, Sample_age_stdev), data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/ab_sho25_glmm_hist1.rds")
# ab_sho25_glmm_hist1 <- add_criterion(ab_sho25_glmm_hist1, "loo")
# 
# ab_sho25_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ me(RelYear2, Sample_age_stdev), data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(0,10)", class = "b")), cores = 4, control= list(adapt_delta = 0.9, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/ab_sho25_glmm_hist2.rds")
# ab_sho25_glmm_hist2 <- add_criterion(ab_sho25_glmm_hist2, "loo")
# 
# ab_sho25_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ RelYear2, data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.9, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/ab_sho25_glmm_hist3.rds")
# ab_sho25_glmm_hist3 <- add_criterion(ab_sho25_glmm_hist3, "loo")
# 
# ab_sho25_glmm_hist4 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.9, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/ab_sho25_glmm_hist4.rds")
# ab_sho25_glmm_hist4 <- add_criterion(ab_sho25_glmm_hist4, "loo")
# 
# ab_sho25_glmm_hist5 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ RelYear2 + (0 + RelYear2 | reefIDcrosswalk), data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.9, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/ab_sho25_glmm_hist5.rds")
# ab_sho25_glmm_hist5 <- add_criterion(ab_sho25_glmm_hist5, "loo")
# 
# ab_sho25_glmm_hist6 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear2 | reefIDcrosswalk), data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/ab_sho25_glmm_hist6.rds")
# ab_sho25_glmm_hist6 <- add_criterion(ab_sho25_glmm_hist6, "loo")
# 
# #GLMM6 is the best model for the historical data
# loo_compare(ab_sho25_glmm_hist1, ab_sho25_glmm_hist2, ab_sho25_glmm_hist3, ab_sho25_glmm_hist4, ab_sho25_glmm_hist5, ab_sho25_glmm_hist6)

```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}

ab_sh25to75 <- subset(ab_sho25, ab_sho25$ShellHeight_mm < 75)
#ab_sh25to75[, QuadSize_m2 := as.numeric(QuadSize_m2)]
#ab_sh25to75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
#ab_sh25to75[, RelYear := LiveDate2 - min(LiveDate2)]
#ab_sh25to75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(ab_sh25to75, here::here(paste0('GLMMs/AllDates/Data/ab_sh25to75_', Sys.Date(), '.rds')))

# ab_sho25_glmm <- brm(formula = ShellHeight_mm ~ RelYear + QuadSize_m2 + NumberMeasured_n + LiveDate_Qualifier + Subtidal + (1 + RelYear|reefIDcrosswalk), data = ab_sho25, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "identity"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# ab_sho25_glmm <- add_criterion(ab_sho25_glmm, "loo")

ggplot(subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() #+
  #theme(legend.position = "none")

ggplot(subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() #+
  #theme(legend.position = "none")

ggplot(subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = as.factor(QuadSize_m2), color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")

#Subtidal samples and intertidal samples don't look super different, but it doesn't look like there is a systematic effect of QuadSize_m2 on the median ShellHeight_mm
ggplot(subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = ShellHeight_mm)) +
  geom_jitter(aes(color = QuadIdentifier)) +
  geom_boxplot(aes(group = RelYear2, color = Subtidal), alpha = 0.5) +
  facet_wrap(~ as.factor(QuadSize_m2)) +
  theme(legend.position = "none")

#colors need to be fixed.
ggplot(subset(numValves, numValves$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = counts)) +
  geom_jitter(aes(color = rc_quad_yrmo)) +
  geom_boxplot(aes(x = RelYear2, y = counts, group = RelYear2, color = Subtidal), alpha = 0.5, inherit.aes = FALSE) +
  facet_wrap(~ as.factor(QuadSize_m2)) #+
  #theme(legend.position = "none")

#Counts for only four samples equal the corresponding NumberMeasured_n values, suggesting that, effectively, all live specimens were measured for the other samples. Dropping those four samples from the model could allow us to drop the NumberMeasured_n variable.
ggplot(subset(numValves, numValves$LiveDate_Qualifier != "Estimate"), aes(x = NumberMeasured_n, y = counts)) +
  geom_jitter(aes(color = as.factor(ProgramID))) +
  #geom_boxplot(aes(group = RelYear2, color = Subtidal), alpha = 0.5) +
  facet_wrap(~ as.factor(QuadSize_m2)) #+
  #theme(legend.position = "none")

ggplot(subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = Subtidal, color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")

ggplot(subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = NumberMeasured_n, color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")

ggplot(subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = as.factor(QuadSize_m2), y = NumberMeasured_n, color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")

# ab_sh25to75_glmm1 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + Subtidal, data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/ab_sh25to75_glmm1.rds")
# ab_sh25to75_glmm1 <- add_criterion(ab_sh25to75_glmm1, "loo")
# 
# #Model converged, intercept not significant.
# ab_sh25to75_glmm1b <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ 1, data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/ab_sh25to75_glmm1b.rds")
# ab_sh25to75_glmm1b <- add_criterion(ab_sh25to75_glmm1b, "loo")
# 
# #Model converged, RelYear2 was significant.
# ab_sh25to75_glmm2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2, data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/ab_sh25to75_glmm2.rds")
# ab_sh25to75_glmm2 <- add_criterion(ab_sh25to75_glmm2, "loo")
# 
# #Model converged, Subtidal was significant.
# ab_sh25to75_glmm2b <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ Subtidal, data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/ab_sh25to75_glmm2b.rds")
# ab_sh25to75_glmm2b <- add_criterion(ab_sh25to75_glmm2b, "loo")
# 
# #Model converged, QuadSize_m2 was significant.
# ab_sh25to75_glmm2c <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ QuadSize_m2, data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/ab_sh25to75_glmm2c.rds")
# ab_sh25to75_glmm2c <- add_criterion(ab_sh25to75_glmm2c, "loo")
# 
# ab_sh25to75_glmm3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + NumberMeasured_n, data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/ab_sh25to75_glmm3.rds")
# ab_sh25to75_glmm3 <- add_criterion(ab_sh25to75_glmm3, "loo")
# 
# ab_sh25to75_glmm4 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/ab_sh25to75_glmm4.rds")
# ab_sh25to75_glmm4 <- add_criterion(ab_sh25to75_glmm4, "loo")
# 
# #Model converged.
# ab_sh25to75_glmm4b <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + QuadSize_m2 + (1 | reefIDcrosswalk), data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sh25to75_glmm4b.rds")
# ab_sh25to75_glmm4b <- add_criterion(ab_sh25to75_glmm4b, "loo")
# 
# #NEED TO RE-RUN THIS MODEL SINCE RE-CODING ID5073 AS SUBTIDAL (it was taking a long time and this model is not going to be included in the output so I moved on.)
# ab_sh25to75_glmm4b_nosub <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + QuadSize_m2 + (1 | reefIDcrosswalk), data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate" & ab_sh25to75$Subtidal == FALSE), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sh25to75_glmm4b_nosub.rds")
# ab_sh25to75_glmm4b_nosub <- add_criterion(ab_sh25to75_glmm4b_nosub, "loo")
# 
# ab_sh25to75_glmm5 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), family = skew_normal, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/ab_sh25to75_glmm5.rds")
# ab_sh25to75_glmm5 <- add_criterion(ab_sh25to75_glmm5, "loo")
# 
# ab_sh25to75_glmm6 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + (1 + RelYear2 | reefIDcrosswalk), data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/ab_sh25to75_glmm6.rds")
# ab_sh25to75_glmm6 <- add_criterion(ab_sh25to75_glmm6, "loo")
# 
# ab_sh25to75_glmm7 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + (0 + RelYear2 | reefIDcrosswalk), data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/ab_sh25to75_glmm7.rds")
# ab_sh25to75_glmm7 <- add_criterion(ab_sh25to75_glmm7, "loo")
# 
# #Model converged.
# ab_sh25to75_glmm7b <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + QuadSize_m2 + (0 + RelYear2 | reefIDcrosswalk), data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sh25to75_glmm7b.rds")
# ab_sh25to75_glmm7b <- add_criterion(ab_sh25to75_glmm7b, "loo")
# 
# # Commented these out because none of these models included QuadSize_m2.
# # #GLMM 4 is the best fit.
# # loo_compare(ab_sh25to75_glmm1, ab_sh25to75_glmm2, ab_sh25to75_glmm3, ab_sh25to75_glmm4, ab_sh25to75_glmm5, ab_sh25to75_glmm6, ab_sh25to75_glmm7)
# 
# #GLMM 4b is the better fit.
# loo_compare(ab_sh25to75_glmm4b, ab_sh25to75_glmm7b)
# 
# #GLMM 4b is the better fit, but of the two models that include the interaction of RelYear and Region, GLMM 12 is the better fit.
# loo_compare(ab_sh25to75_glmm4b, ab_sh25to75_glmm12, ab_sh25to75_glmm12b, ab_sh25to75_glmm13)


#Model converged. RelYear term was significant.
ab_sh25to75_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sh25to75_glmm_hist1.rds")
ab_sh25to75_glmm_hist1 <- add_criterion(ab_sh25to75_glmm_hist1, "loo")

#Trying previous model again with priors for meanme, sdme, and sd. Stopped the run because the model was taking a long time and one chain still hadn't started. Will try this one again if I have time.
ab_sh25to75_glmm_hist1b <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear2 | reefIDcrosswalk), data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(329.2, 200)", class = "meanme"), set_prior("normal(73.75, 160)", class = "sdme"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control = list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sh25to75_glmm_hist1b.rds")
ab_sh25to75_glmm_hist1b <- add_criterion(ab_sh25to75_glmm_hist1b, "loo")

#Model converged, RelYear term was significant.
ab_sh25to75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sh25to75_glmm_hist2.rds")
ab_sh25to75_glmm_hist2 <- add_criterion(ab_sh25to75_glmm_hist2, "loo")

#Model converged (though ESS is low), RelYear term was not significant.
ab_sh25to75_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) | reefIDcrosswalk), data = subset(ab_sh25to75, ab_sh25to75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sh25to75_glmm_hist3.rds")
ab_sh25to75_glmm_hist3 <- add_criterion(ab_sh25to75_glmm_hist3, "loo")

#GLMM 1 is the best fit, but GLMM 2 is the best fit of the two models that includes reef as a grouping variable, so I chose that one.
loo_compare(ab_sh25to75_glmm_hist1, ab_sh25to75_glmm_hist2, ab_sh25to75_glmm_hist3)

```


```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}

ab_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Apalachicola Bay_Natural")
ab_sho75[, QuadSize_m2 := as.factor(QuadSize_m2)]
ab_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
ab_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
ab_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]

#Exclude the five samples that don't have counts less than the "NumberMeasured" value for the corresponding program (see variable exploration graphs in the 25to75mm section for the rationale and graphs for this step.)
ab_sho75[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", LiveDate2, "-", Month)]
numValves_o75 <- ab_sho75[, counts := length(ShellHeight_mm), by = c("rc_quad_yrmo")]
numValves_o75 <- unique(numValves_o75[, c("ProgramID", "RelYear2", "counts", "rc_quad_yrmo", "Subtidal", "QuadSize_m2", "LiveDate_Qualifier", "NumberMeasured_n")])
exclude_samps_o75 <- subset(numValves_o75, numValves_o75$NumberMeasured_n == "20" & numValves_o75$counts > 19)$rc_quad_yrmo
ab_sho75 <- subset(ab_sho75, ab_sho75$rc_quad_yrmo %in% setdiff(ab_sho75$rc_quad_yrmo, exclude_samps_o75))

saveRDS(ab_sho75, here::here(paste0('GLMMs/AllDates/Data/ab_sho75_', Sys.Date(), '.rds')))


ggplot(subset(ab_sho75, ab_sho75$Sample_age_qualifier == "Exact"), aes(RelYear2, ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_point() +
  theme_bw()

# ab_sho75_glmm <- brm(formula = ShellHeight_mm ~ RelYear + QuadSize_m2 + NumberMeasured_n + LiveDate_Qualifier + Subtidal + (1 + RelYear|reefIDcrosswalk), data = ab_sho75, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "identity"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# ab_sho75_glmm <- add_criterion(ab_sho75_glmm, "loo")
# 
# ab_sho75_glmm1 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + Subtidal, data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 80) #, file = "GLMMs/ab_sho75_glmm1.rds")
# ab_sho75_glmm1 <- add_criterion(ab_sho75_glmm1, "loo")
# 
# #Model converged, intercept was significant.
# ab_sho75_glmm1b <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ 1, data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sho75_glmm1b.rds")
# ab_sho75_glmm1b <- add_criterion(ab_sho75_glmm1b, "loo")
# 
# ab_sho75_glmm2 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2, data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 80) #, file = "GLMMs/ab_sho75_glmm1.rds")
# ab_sho75_glmm2 <- add_criterion(ab_sho75_glmm2, "loo")
# 
# #Model converged, RelYear2 was not significant.
# ab_sho75_glmm2b <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2, data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sho75_glmm2b.rds")
# ab_sho75_glmm2b <- add_criterion(ab_sho75_glmm2b, "loo")
# 
# #Model converged, QuadSize_m2 was not significant.
# ab_sho75_glmm2c <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ QuadSize_m2, data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sho75_glmm2c.rds")
# ab_sho75_glmm2c <- add_criterion(ab_sho75_glmm2c, "loo")
# 
# #Model converged, Subtidal was significant.
# ab_sho75_glmm2d <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ Subtidal, data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sho75_glmm2d.rds")
# ab_sho75_glmm2d <- add_criterion(ab_sho75_glmm2d, "loo")
# 
# ab_sho75_glmm3 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + NumberMeasured_n, data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 80) #, file = "GLMMs/ab_sho75_glmm1.rds")
# ab_sho75_glmm3 <- add_criterion(ab_sho75_glmm3, "loo")
# 
# ab_sho75_glmm4 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 80) #, file = "GLMMs/ab_sho75_glmm1.rds")
# ab_sho75_glmm4 <- add_criterion(ab_sho75_glmm4, "loo")
# 
# #Model converged, RelYear2 was not significant.
# ab_sho75_glmm4b <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sho75_glmm4b.rds")
# ab_sho75_glmm4b <- add_criterion(ab_sho75_glmm4b, "loo")
# 
# #Model did not converge.
# ab_sho75_glmm4b_nosub <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate" & ab_sho75$Subtidal == FALSE), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sho75_glmm4b_nosub.rds")
# ab_sho75_glmm4b_nosub <- add_criterion(ab_sho75_glmm4b_nosub, "loo")
# 
# #Model converged, RelYear2 was not significant
# ab_sho75_glmm4c <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + Subtidal + (1 | reefIDcrosswalk), data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sho75_glmm4c.rds")
# ab_sho75_glmm4c <- add_criterion(ab_sho75_glmm4c, "loo")
# 
# #Model converged, RelYear2 was not significant
# ab_sho75_glmm4d <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + Subtidal + (0 + RelYear2 | reefIDcrosswalk), data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sho75_glmm4d.rds")
# ab_sho75_glmm4d <- add_criterion(ab_sho75_glmm4d, "loo")
# 
# ab_sho75_glmm5 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = skew_normal, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 80) #, file = "GLMMs/ab_sho75_glmm1.rds")
# ab_sho75_glmm5 <- add_criterion(ab_sho75_glmm5, "loo")
# 
# ab_sho75_glmm6 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + (1 + RelYear2 | reefIDcrosswalk), data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 80) #, file = "GLMMs/ab_sho75_glmm1.rds")
# ab_sho75_glmm6 <- add_criterion(ab_sho75_glmm6, "loo")
# 
# ab_sho75_glmm7 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + (0 + RelYear2 | reefIDcrosswalk), data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 80) #, file = "GLMMs/ab_sho75_glmm1.rds")
# ab_sho75_glmm7 <- add_criterion(ab_sho75_glmm7, "loo")
# 
# #Model converged, RelYear2 was not significant.
# ab_sho75_glmm7b <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (0 + RelYear2 | reefIDcrosswalk), data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sho75_glmm7b.rds")
# ab_sho75_glmm7b <- add_criterion(ab_sho75_glmm7b, "loo")
# 
# # Commented these lines out because I re-did a number of the models to include QuadSize_m2 and an upper bound on ShellHeight_mm.
# # #GLMM #2 is the best fit.
# # loo_compare(ab_sho75_glmm1, ab_sho75_glmm2, ab_sho75_glmm3, ab_sho75_glmm4, ab_sho75_glmm5, ab_sho75_glmm6, ab_sho75_glmm7)
# 
# #GLMM 4b is the better fit, but of the models including the "Subtidal" variable, GLMM 4c is the best fit.
# loo_compare(ab_sho75_glmm4b, ab_sho75_glmm4c, ab_sho75_glmm4d, ab_sho75_glmm7b)

#Model converged, RelYear term was not significant.
ab_sho75_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sho75_glmm_hist1.rds")
ab_sho75_glmm_hist1 <- add_criterion(ab_sho75_glmm_hist1, "loo")

#Model converged, RelYear term was not significant.
ab_sho75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sho75_glmm_hist2.rds")
ab_sho75_glmm_hist2 <- add_criterion(ab_sho75_glmm_hist2, "loo")

#Model converged, RelYear term was not significant.
ab_sho75_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) | reefIDcrosswalk), data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 20), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_sho75_glmm_hist3.rds")
ab_sho75_glmm_hist3 <- add_criterion(ab_sho75_glmm_hist3, "loo")

#GLMM 1 is the best fit, but GLMM 2 is the better fit of the two models that included reef as a grouping variable, so I chose that one.
loo_compare(ab_sho75_glmm_hist1, ab_sho75_glmm_hist2, ab_sho75_glmm_hist3)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
ab_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Apalachicola Bay_Natural")
ab_sho25[, QuadSize_m2 := as.factor(QuadSize_m2)]
ab_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
ab_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
ab_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
ab_sho25[ShellHeight_mm < 75, SizeClass := "25to75mm"]
ab_sho25[ShellHeight_mm >= 75, SizeClass := "o75mm"]

#Exclude the five samples that don't have counts less than the "NumberMeasured" value for the corresponding program (see variable exploration graphs in the 25to75mm section for the rationale and graphs for this step.)
ab_sho25[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", LiveDate2, "-", Month)]
numValves <- ab_sho25[, counts := length(ShellHeight_mm), by = c("rc_quad_yrmo")]
numValves <- unique(numValves[, c("ProgramID", "RelYear2", "counts", "rc_quad_yrmo", "Subtidal", "QuadSize_m2", "LiveDate_Qualifier", "NumberMeasured_n")])
exclude_samps <- subset(numValves, numValves$NumberMeasured_n == "20" & numValves$counts > 19)$rc_quad_yrmo
ab_sho25 <- subset(ab_sho25, ab_sho25$rc_quad_yrmo %in% setdiff(ab_sho25$rc_quad_yrmo, exclude_samps))

saveRDS(ab_sho25, here::here(paste0('GLMMs/AllDates/Data/ab_sho25_', Sys.Date(), '.rds')))

#ab_sho25_glmm <- readRDS(here::here('GLMMs/AllDates/ab_sho25_glmm.rds'))


ab_sh25to75 <- subset(ab_sho25, ab_sho25$ShellHeight_mm < 75)

#ab_sh25to75_glmm <- readRDS(here::here('GLMMs/AllDates/ab_sh25to75_glmm12.rds'))
ab_sh25to75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/ab_sh25to75_glmm_hist2.rds'))


ab_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Apalachicola Bay_Natural")
ab_sho75[, QuadSize_m2 := as.factor(QuadSize_m2)]
ab_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
ab_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
ab_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]

#Exclude the five samples that don't have counts less than the "NumberMeasured" value for the corresponding program (see variable exploration graphs in the 25to75mm section for the rationale and graphs for this step.)
ab_sho75[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", LiveDate2, "-", Month)]
numValves_o75 <- ab_sho75[, counts := length(ShellHeight_mm), by = c("rc_quad_yrmo")]
numValves_o75 <- unique(numValves_o75[, c("ProgramID", "RelYear2", "counts", "rc_quad_yrmo", "Subtidal", "QuadSize_m2", "LiveDate_Qualifier", "NumberMeasured_n")])
exclude_samps_o75 <- subset(numValves_o75, numValves_o75$NumberMeasured_n == "20" & numValves_o75$counts > 19)$rc_quad_yrmo
ab_sho75 <- subset(ab_sho75, ab_sho75$rc_quad_yrmo %in% setdiff(ab_sho75$rc_quad_yrmo, exclude_samps_o75))

saveRDS(ab_sho75, here::here(paste0('GLMMs/AllDates/Data/ab_sho75_', Sys.Date(), '.rds')))

#ab_sho75_glmm <- readRDS(here::here('GLMMs/AllDates/ab_sho75_glmm4c.rds'))
ab_sho75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/ab_sho75_glmm_hist2.rds'))

```

##### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

ab_sho25[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
ab_sho25[, SampleDay := day(SampleDate)]

sh_t <- copy(ab_sho25[0, ])
sh_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(ab_sho25$Month))){
  mo <- subset(ab_sho25, as.numeric(ab_sho25$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  sh_t <- rbind(mo, sh_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

```

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.height=6, fig.width=10, out.width = "100%"}
SampleDatesPlot <- ggplot(subset(sh_t, sh_t$LiveDate_Qualifier == "Exact"), aes(x = DayNum, y = as.factor(ProgramID), color = Year, shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
SampleDatesPlot
```

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.height=6, fig.width=10, out.width = "100%"}
rm(sh_t, monthnames, SampleDatesPlot)
```

<br><br><br>

##### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_specimens = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for size class 25-75mm first.
sh25to75_status <- subset(ab_sh25to75, ab_sh25to75$Sample_mean_age %in% StatusYears)
sh25to75_status[, `:=` (Indicator = "Size Class", 
                        SizeClass = "25-75mm", 
                        Year = as.numeric(Sample_mean_age), 
                        n_reefs = length(unique(ReefIdentifier)),
                        n_programs = length(unique(ProgramID)),
                        ProgIDs = list(unique(ProgramID)),
                        n_specimens = length(ShellHeight_mm),
                        Median = median(ShellHeight_mm),
                        Mean = round(mean(ShellHeight_mm), digits = 2),
                        SD = round(sd(ShellHeight_mm), digits = 2), 
                        Min. = min(ShellHeight_mm),
                        Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sh25to75_status <- unique(sh25to75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sh25to75_status <- sh25to75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sh25to75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sh25to75_status$Year)){
    MissingYr_i <- data.table(Indicator = unique(sh25to75_status$Indicator), 
                              SizeClass = unique(sh25to75_status$SizeClass),
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sh25to75_status <- rbind(sh25to75_status, MissingYr_i)
  }
}

#Build status table for size class >75mm next.
sho75_status <- subset(ab_sho75, ab_sho75$Sample_mean_age %in% StatusYears)
sho75_status[, `:=` (Indicator = "Size Class", 
                     SizeClass = ">75mm", 
                     Year = as.numeric(Sample_mean_age), 
                     n_reefs = length(unique(ReefIdentifier)),
                     n_programs = length(unique(ProgramID)),
                     ProgIDs = list(unique(ProgramID)),
                     n_specimens = length(ShellHeight_mm),
                     Median = median(ShellHeight_mm),
                     Mean = round(mean(ShellHeight_mm), digits = 2),
                     SD = round(sd(ShellHeight_mm), digits = 2), 
                     Min. = min(ShellHeight_mm),
                     Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sho75_status <- unique(sho75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sho75_status <- sho75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sho75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sho75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = ">75mm",
                              Year = i,
                              n_reefs = ifelse(sh25to75_status[Year == i, n_reefs] > 0, sh25to75_status[Year == i, n_reefs], 0),
                              n_programs = ifelse(sh25to75_status[Year == i, n_programs] > 0, sh25to75_status[Year == i, n_programs], 0),
                              ProgIDs = ifelse(!is.na(sh25to75_status[Year == i, ProgIDs]), sh25to75_status[Year == i, ProgIDs], NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sho75_status <- rbind(sho75_status, MissingYr_i)
  }
}

#Merge individual size class tables and set row order
Status <- rbind(Status, sh25to75_status)
Status <- rbind(Status, sho75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) %>%
  kable_styling() %>%
  row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, sh25to75_status, MissingYr_i, sho75_status)
```

<br><br><br>

##### Variable exploration: {.tabset .tabset-fade .tabset-pills}

<br>

Subtidal is confounded with RelYear (only one year with Subtidal data, and there are no intertidal data for that year), so is NumberMeasured_n (only one n value has more than one year of data and they don't overlap with any other n value), and although two of the quad sizes have two years of data, two sizes are confounded with NumberMeasured_n. There are only five years of data, so if any of these variables drop out, there are not 5 years of data to analyze. It seems like there simply isn't enough data to run a solid model on this dataset.

<br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
ggplot(subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() #+
  #theme(legend.position = "none")

ggplot(subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() #+
  #theme(legend.position = "none")
```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
ggplot(subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = as.factor(QuadSize_m2), color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")

#Subtidal samples should be removed, but it doesn't look like there is a systematic effect of QuadSize_m2 on the median ShellHeight_mm
ggplot(subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate")) +
  geom_jitter(aes(x = RelYear2, y = ShellHeight_mm, group = RelYear2, fill = QuadIdentifier), color = "black", shape = 21) +
  geom_boxplot(aes(x = RelYear2, y = ShellHeight_mm, group = RelYear2, color = Subtidal), alpha = 0.5, lwd = 1, inherit.aes = FALSE) +
  facet_wrap(~ as.factor(QuadSize_m2)) +
  labs(caption = "Subtidal samples have a slightly different distribution, but it doesn't \nlook like there is a systematic effect of QuadSize_m2 on the median \nShellHeight_mm. Point color corresponds to QuadIdentifier.") +
  guides(fill = FALSE) +
  theme(plot.caption = element_text(hjust = 0))
```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
ab_sho25[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", LiveDate2, "-", Month)]
numValves <- ab_sho25[, counts := length(ShellHeight_mm), by = c("rc_quad_yrmo")]
numValves <- unique(numValves[, c("ProgramID", "RelYear2", "counts", "rc_quad_yrmo", "Subtidal", "QuadSize_m2", "LiveDate_Qualifier", "NumberMeasured_n")])

ggplot(subset(numValves, numValves$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = counts)) +
  geom_jitter(aes(fill = rc_quad_yrmo), color = "black", shape = 21) +
  geom_boxplot(aes(group = RelYear2, color = Subtidal), alpha = 0.5, lwd = 1) +
  facet_wrap(~ as.factor(QuadSize_m2)) +
  guides(fill = FALSE) +
  theme_bw()

#Counts for only four samples equal the corresponding NumberMeasured_n values, suggesting that, effectively, all live specimens were measured for the other samples. Dropping those four samples from the model could allow us to drop the NumberMeasured_n variable.
ggplot(subset(numValves, numValves$LiveDate_Qualifier != "Estimate"), aes(x = NumberMeasured_n, y = counts)) +
  geom_jitter(aes(color = as.factor(ProgramID))) +
  #geom_boxplot(aes(group = RelYear2, color = Subtidal), alpha = 0.5) +
  geom_hline(yintercept = 20, color = "light blue") +
  geom_hline(yintercept = 30, color = "red") +
  facet_wrap(~ as.factor(QuadSize_m2)) +
  labs(caption = "Counts for only five samples equal the corresponding NumberMeasured_n values, suggesting that, effectively, all live specimens were measured for the other \nsamples. Dropping those five samples from the model could allow us to drop the NumberMeasured_n variable.") +
  theme(plot.caption = element_text(hjust = 0, size = 12))

# exclude_samps <- subset(numValves, numValves$NumberMeasured_n == "20" & numValves$counts > 19)$rc_quad_yrmo
# ab_sho25 <- subset(ab_sho25, ab_sho25$rc_quad_yrmo %in% setdiff(ab_sho25$rc_quad_yrmo, exclude_samps))
```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
ggplot(subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = Subtidal, color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")

ggplot(subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = NumberMeasured_n, color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")
```

<br><br>

```{r echo=TRUE, message=FALSE, warning=FALSE, out.width="50%"}
ggplot(subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), aes(x = as.factor(QuadSize_m2), y = NumberMeasured_n, color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")
```

<br><br><br><br>

##### Model Output: {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- summary(ab_sho25_glmm) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height 25-75mm

<!-- Real-time data: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- summary(ab_sh25to75_glmm) -->
<!-- ``` -->

<!-- <br><br> -->

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(ab_sh25to75_glmm_hist)
```

<br><br><br>

###### Shell height >75mm

<!-- Real-time data: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- summary(ab_sho75_glmm) -->
<!-- ``` -->

<!-- <br><br> -->

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(ab_sho75_glmm_hist)
```

<br><br><br>

##### Diagnostic Plots {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- Posterior distributions and Markov chains: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_AB_PDistandMChains_o25 <- plot(ab_sho25_glmm) -->
<!-- SH_AllDates_GLMM_AB_PDistandMChains_o25 -->

<!-- len <- length(SH_AllDates_GLMM_AB_PDistandMChains_o25) -->
<!-- for(i in 1:len){ -->
<!--   jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_PDistandMChains_o25_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300) -->
<!--   print(SH_AllDates_GLMM_AB_PDistandMChains_o25[i]) -->
<!--   dev.off() -->
<!-- } -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- Posterior predictive check plot: -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_AB_PPcheck_o25 <- pp_check(ab_sho25_glmm) -->
<!-- SH_AllDates_GLMM_AB_PPcheck_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_PPcheck_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_AB_PPcheck_o25, -->
<!--        width = 4, -->
<!--        height = 3, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height 25-75mm

Posterior distributions and Markov chains:

<!-- <br> -->

<!-- Real-time data: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_AB_PDistandMChains_25to75 <- plot(ab_sh25to75_glmm) -->
<!-- SH_AllDates_GLMM_AB_PDistandMChains_25to75 -->

<!-- len <- length(SH_AllDates_GLMM_AB_PDistandMChains_25to75) -->
<!-- for(i in 1:len){ -->
<!--   jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_PDistandMChains_25to75_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300) -->
<!--   print(SH_AllDates_GLMM_AB_PDistandMChains_25to75[i]) -->
<!--   dev.off() -->
<!-- } -->
<!-- ``` -->

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_AB_PDistandMChains_25to75_hist <- plot(ab_sh25to75_glmm_hist)
SH_AllDates_GLMM_AB_PDistandMChains_25to75_hist

len <- length(SH_AllDates_GLMM_AB_PDistandMChains_25to75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_PDistandMChains_25to75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_AB_PDistandMChains_25to75_hist[i])
  dev.off()
}
```

<br><br>

Posterior predictive check plot:

<!-- <br> -->

<!-- Real-time data: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_AB_PPcheck_25to75 <- pp_check(ab_sh25to75_glmm) -->
<!-- SH_AllDates_GLMM_AB_PPcheck_25to75 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_PPcheck_25to75_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_AB_PPcheck_25to75, -->
<!--        width = 4, -->
<!--        height = 3, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_AB_PPcheck_25to75_hist <- tryCatch(pp_check(ab_sh25to75_glmm_hist),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_AB_PPcheck_25to75_hist) == TRUE){
    SH_AllDates_GLMM_AB_PPcheck_25to75_hist <- tryCatch(pp_check(ab_sh25to75_glmm_hist), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_AB_PPcheck_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_PPcheck_25to75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_AB_PPcheck_25to75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Shell height >75mm

Posterior distributions and Markov chains:

<!-- <br> -->

<!-- Real-time data: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_AB_PDistandMChains_o75 <- plot(ab_sho75_glmm) -->
<!-- SH_AllDates_GLMM_AB_PDistandMChains_o75 -->

<!-- len <- length(SH_AllDates_GLMM_AB_PDistandMChains_o75) -->
<!-- for(i in 1:len){ -->
<!--   jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_PDistandMChains_o75_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300) -->
<!--   print(SH_AllDates_GLMM_AB_PDistandMChains_o75[i]) -->
<!--   dev.off() -->
<!-- } -->
<!-- ``` -->


<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_AB_PDistandMChains_o75_hist <- plot(ab_sho75_glmm_hist)
SH_AllDates_GLMM_AB_PDistandMChains_o75_hist

len <- length(SH_AllDates_GLMM_AB_PDistandMChains_o75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_PDistandMChains_o75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_AB_PDistandMChains_o75_hist[i])
  dev.off()
}
```

<br><br>

Posterior predictive check plot:

<!-- <br> -->

<!-- Real-time data: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_AB_PPcheck_o75 <- tryCatch(pp_check(ab_sho75_glmm), -->
<!--                                                    error = function(e) NA) -->
<!-- while(is.na(SH_AllDates_GLMM_AB_PPcheck_o75) == TRUE){ -->
<!--     SH_AllDates_GLMM_AB_PPcheck_o75 <- tryCatch(pp_check(ab_sho75_glmm),  -->
<!--                                                        error = function(e) NA)} -->
<!-- SH_AllDates_GLMM_AB_PPcheck_o75 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_PPcheck_o75_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_AB_PPcheck_o75, -->
<!--        width = 4, -->
<!--        height = 3, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_AB_PPcheck_o75_hist <- tryCatch(pp_check(ab_sho75_glmm_hist),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_AB_PPcheck_o75_hist) == TRUE){
    SH_AllDates_GLMM_AB_PPcheck_o75_hist <- tryCatch(pp_check(ab_sho75_glmm_hist), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_AB_PPcheck_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_PPcheck_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_AB_PPcheck_o75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Marginal Effects Plots {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- Comparing the model fit to the real-time monitoring data (filled circles/red trendline) with predicted values for the historical (dead shell) data (open circles/blue trendline). The dead shell sample ages (i.e., the "RelYears") are estimated as the mean median calibrated age from ~5 radiocarbon-dated specimens per sample). Several older samples (i.e., lower RelYear values) are cut out of the plot below so that the modern data and their model fit are visible. -->

<!-- ```{r echo=TRUE, message=FALSE, warning=FALSE, out.width="100%"} -->
<!-- #Marginal effects plot including random effects -->
<!-- SH_AllDates_GLMM_AB_MEPlivedat_o25 <- subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate") %>% -->
<!--   data_grid(RelYear, Subtidal) %>% -->
<!--   add_fitted_draws(ab_sho25_glmm5, allow_new_levels = TRUE) %>% -->
<!--   ggplot(aes(x = RelYear, y = ShellHeight_mm)) + -->
<!--   stat_lineribbon(aes(y = .value), color = "firebrick1") + -->
<!--   geom_point(data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier != "Estimate"), shape = 21, color = "black", fill = "firebrick2") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   scale_color_brewer(palette = "Set2") -->
<!-- #SH_AllDates_GLMM_AB_MEPrand_o25   -->

<!-- ab_sho25_histpred <- base::subset(ab_sho25, ab_sho25$LiveDate_Qualifier == "Estimate")  -->
<!-- #ab_sho25_quads <- unique(ab_sho25_histpred[, c("reefIDcrosswalk", "QuadIdentifier", "Sample_age_stdev")]) -->
<!-- #ab_sho25_histpred <- unique(ab_sho25_histpred[, c("RelYear2", "Sample_age_stdev")]) -->
<!-- #ab_sho25_histpred <- droplevels(ab_sho25_histpred) -->
<!-- ab_sho25_histpred2 <- ab_sho25_histpred %>% -->
<!--   #data_grid(RelYear, Subtidal) %>% -->
<!--   #data_grid(RelYear2, Sample_age_stdev) %>% -->
<!--   #left_join(., ab_sho25_quads, by = "Sample_age_stdev") %>% -->
<!--   add_fitted_draws(ab_sho25_glmm_hist6) -->
<!-- ab_sho25_histpred2$RelYear <- NULL -->
<!-- setnames(ab_sho25_histpred2, "RelYear2", "RelYear") -->

<!-- SH_AllDates_GLMM_AB_MEPalldat_o25 <- SH_AllDates_GLMM_AB_MEPlivedat_o25 + -->
<!--   geom_smooth(data = ab_sho25_histpred2, aes(y = .value), color = "dodgerblue1") + -->
<!--   geom_point(data = subset(ab_sho25, ab_sho25$LiveDate_Qualifier == "Estimate"), shape = 21, color = "black", fill = "dodgerblue2") + -->
<!--   #geom_errorbarh(aes(xmax = RelYear2 + TA/2, xmin = RelYear - TA/2)) -->
<!--   #coord_cartesian(ylim=c(0, 275), xlim=c(420, 440)) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_AB_MEPalldat_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_MEPalldat_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_AB_MEPalldat_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->


<!-- ```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"} -->
<!-- #Including the random effect of reef (i.e., sampled population credible interval): -->
<!-- #Marginal effects plot excluding random effects -->
<!-- ab_sho25_1 <- plot(conditional_effects(ab_sho25_glmm5), plot = FALSE)[[1]] -->
<!-- ab_sho25_1b <- plot(conditional_effects(ab_sho25_glmm_hist6), plot = FALSE)[[1]] -->

<!-- lowerlab <- c(1688, 1706, 1813, 1933, 1979, 1987, 1991, 1993, 1997, 2014, 2017) -->
<!-- upperlab <- c(1580, 1704, 1757, 1899, 1972, 1982, 1989, 1992, 1995, 2013, 2016, 2019) -->

<!-- ab_sho25$RelYear_lab1 <- 1 -->
<!-- for(i in 1:nrow(ab_sho25)){  -->
<!--   ab_sho25$RelYear_lab1[i] <- as.character(ifelse(ab_sho25$Sample_mean_age[i] %in% upperlab, ab_sho25$Sample_mean_age[i], "")) -->
<!-- } -->

<!-- ab_sho25$RelYear_lab2 <- 1 -->
<!-- for(i in 1:nrow(ab_sho25)){  -->
<!--   ab_sho25$RelYear_lab2[i] <- as.character(ifelse(ab_sho25$Sample_mean_age[i] %in% lowerlab, ab_sho25$Sample_mean_age[i], "")) -->
<!-- } -->


<!-- SH_AllDates_GLMM_AB_MEP_o25 <- ggplot(ab_sho25_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) + -->
<!--   geom_point(data = ab_sho25, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!--   geom_ribbon(fill = "grey", alpha = 0.4) + -->
<!--   geom_line(aes(y = estimate__), color = "blue", lwd = 1) + -->
<!--   geom_ribbon(data = ab_sho25_1b$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) + -->
<!--   geom_line(data = ab_sho25_1b$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) + -->
<!--   geom_text(data = ab_sho25, aes(y = 23, label = RelYear_lab1, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) + -->
<!--   geom_text(data = ab_sho25, aes(y = 20, label = RelYear_lab2, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) + -->
<!--   theme_bw() + -->
<!--   coord_cartesian(xlim = c(350, 450), ylim = c(20, 150)) -->
<!-- SH_AllDates_GLMM_AB_MEP_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_MEP_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_AB_MEPrand_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- ```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"} -->
<!-- #Excluding the random effect of reef (i.e., sampled population credible interval): -->
<!-- #Marginal effects plot excluding random effects -->
<!-- ab_sho25_2 <- plot(conditional_effects(ab_sho25_glmm, re_formula = NA), plot = FALSE)[[1]] -->
<!-- SH_AllDates_GLMM_AB_MEPnorand_o25 <- ab_sho25_2 + -->
<!--   geom_point(data = ab_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_AB_MEPnorand_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_MEPnorand_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_AB_MEPnorand_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->


<!-- ```{r eval=FALSE, fig.height=50, fig.width=10, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"} -->
<!-- #Individual effects plots: -->
<!-- #Individual effects plots -->
<!-- SH_AllDates_GLMM_AB_IEP_o25 <- ab_sho25 %>% -->
<!--   group_by(reefIDcrosswalk) %>% -->
<!--   add_fitted_draws(ab_sho25_glmm) %>% -->
<!--   ggplot(aes(x = RelYear, y = ShellHeight_mm, color = reefIDcrosswalk)) + -->
<!--   stat_lineribbon(aes(y = .value), size = 1) + -->
<!--   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) + -->
<!--   geom_point(data = ab_sho25) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") + -->
<!--   #geom_line(aes(y = .value), linetype = "dashed", color = "black") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   #scale_color_brewer(palette = "Set2") + -->
<!--   theme_bw() + -->
<!--   facet_wrap(~ reefIDcrosswalk, ncol = 3) -->
<!-- SH_AllDates_GLMM_AB_IEP_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_IEP_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_AB_IEP_o25, -->
<!--        width = 10, -->
<!--        height = 30, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->


###### Shell height 25-75mm

<br>

Including the random effect of reef:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

#Marginal effects plot including random effects

#labs1 <- sort(unique(ab_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- c(1704, 1813, 1899, 1933, 1997, 2017)
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))
#labs1 <- labs1[c(-3, -4, -6)]
#labs2 <- sort(unique(ab_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- c(1987, 2013) #1706, 1979, 1987, 1991, 1993, 1997, 2014, 2017

set.seed(987)
#ab_sh25to75_1 <- plot(conditional_effects(ab_sh25to75_glmm, re_formula = NULL), plot = FALSE)[[1]]
ab_sh25to75_hist_1 <- plot(conditional_effects(ab_sh25to75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]

SH_AllDates_GLMM_AB_MEPrand_25to75_allYr <- ggplot() +#ab_sh25to75_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = ab_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  #geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = ab_sh25to75_hist_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = ab_sh25to75_hist_1$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(ab_sh25to75, ab_sh25to75$Sample_mean_age %in% labs1), aes(y = 22.75, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(ab_sh25to75, ab_sh25to75$Sample_mean_age %in% labs2), aes(y = 21, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  theme(legend.position = "none") +
  coord_cartesian(ylim = c(20, 80))
SH_AllDates_GLMM_AB_MEPrand_25to75_allYr

SH_AllDates_GLMM_AB_MEPrand_25to75_post1994 <- SH_AllDates_GLMM_AB_MEPrand_25to75_allYr +
                                                    geom_boxplot(data = subset(ab_sh25to75, ab_sh25to75$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = ShellHeight_mm), color = "blue", alpha = 0.5, lwd = 1, inherit.aes = FALSE) +
                                                    coord_cartesian(xlim = c(290, 315)) +
                                                    theme(legend.position = "right")
SH_AllDates_GLMM_AB_MEPrand_25to75_post1994

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_MEPrand_25to75_allYr_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_AB_MEPrand_25to75_allYr,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_MEPrand_25to75_post1994_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_AB_MEPrand_25to75_post1994,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

#Marginal effects plot excluding random effects
#labs1 <- sort(unique(ab_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- c(1704, 1813, 1899, 1933, 1997, 2017)
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))
#labs1 <- labs1[c(-3, -4, -6)]
#labs2 <- sort(unique(ab_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- c(1987, 2013) #1706, 1979, 1987, 1991, 1993, 1997, 2014, 2017

set.seed(654)
#ab_sh25to75_2 <- plot(conditional_effects(ab_sh25to75_glmm, re_formula = NA), plot = FALSE)[[1]]
ab_sh25to75_hist_2 <- plot(conditional_effects(ab_sh25to75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]

SH_AllDates_GLMM_AB_MEPnorand_25to75_allYr <- ggplot() +#ab_sh25to75_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = ab_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  #geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = ab_sh25to75_hist_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = ab_sh25to75_hist_2$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(ab_sh25to75, ab_sh25to75$Sample_mean_age %in% labs1), aes(y = 22.75, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(ab_sh25to75, ab_sh25to75$Sample_mean_age %in% labs2), aes(y = 21, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  theme(legend.position = "none") +
  coord_cartesian(ylim = c(20, 80))
SH_AllDates_GLMM_AB_MEPnorand_25to75_allYr

SH_AllDates_GLMM_AB_MEPnorand_25to75_post1994 <- SH_AllDates_GLMM_AB_MEPrand_25to75_allYr +
                                                    geom_boxplot(data = subset(ab_sh25to75, ab_sh25to75$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = ShellHeight_mm), color = "blue", alpha = 0.5, lwd = 1, inherit.aes = FALSE) +
                                                    coord_cartesian(xlim = c(290, 315)) +
                                                    theme(legend.position = "right")
SH_AllDates_GLMM_AB_MEPrand_25to75_post1994

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_MEPnorand_25to75_allYr_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_AB_MEPnorand_25to75_allYr,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_MEPnorand_25to75_post1994_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_AB_MEPnorand_25to75_post1994,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:

<br>

<!-- Real-time data: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=50, fig.width=10, out.width="100%"} -->

<!-- #Individual effects plots -->
<!-- ab_sh25to75_rt <- subset(ab_sh25to75, ab_sh25to75$Sample_mean_age_qualifier != "Estimate") -->
<!-- ab_sh25to75_rt[, QuadSize_m2 := droplevels(QuadSize_m2)] -->

<!-- set.seed(987) -->
<!-- SH_AllDates_GLMM_AB_IEP_25to75 <- ab_sh25to75_rt %>% -->
<!--   group_by(reefIDcrosswalk) %>% -->
<!--   add_fitted_draws(ab_sh25to75_glmm) %>% -->
<!--   ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) + -->
<!--   stat_lineribbon(aes(y = .value), size = 1) + -->
<!--   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) + -->
<!--   geom_point(data = ab_sh25to75_rt) + #aes(fill = Region.y), shape = 21, color = "black") + -->
<!--   #geom_line(aes(y = .value), linetype = "dashed", color = "black") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   #scale_color_brewer(palette = "Set2") + -->
<!--   geom_text(data = ab_sh25to75_rt, aes(y = 20, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) + -->
<!--   #geom_text(data = subset(gtmn_sh25to75, gtmn_sh25to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) + -->
<!--   theme_bw() + theme(axis.line = element_line()) + -->
<!--   scale_x_continuous(limits = c(min(ab_sh25to75_rt$RelYear2) - 1, max(ab_sh25to75_rt$RelYear2) + 1)) + -->
<!--   scale_y_continuous(limits = c(15, 75)) + -->
<!--   #theme(legend.position = "none") + -->
<!--   #labs(color = "Reef ID", fill = "Credible Interval") + -->
<!--   facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free") -->
<!-- SH_AllDates_GLMM_AB_IEP_25to75 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_IEP_25to75_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_AB_IEP_25to75, -->
<!--        width = 10, -->
<!--        height = 30, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br> -->

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=8, fig.width=10, out.width="100%"}

#Individual effects plots
labs1 <- sort(unique(ab_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- labs1[seq(1, length(labs1), 1)]
labs2 <- sort(unique(ab_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- labs2[seq(1, length(labs2), 2)]
labs1 <- setdiff(labs1, labs2)

ab_sh25to75_h <- subset(ab_sh25to75, ab_sh25to75$Sample_mean_age_qualifier == "Estimate")
ab_sh25to75_h[, QuadSize_m2 := droplevels(QuadSize_m2)]
ab_sh25to75_h[, reefIDcrosswalk := droplevels(reefIDcrosswalk)]

set.seed(765)
SH_AllDates_GLMM_AB_IEP_25to75_hist <- ab_sh25to75_h %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(ab_sh25to75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = ab_sh25to75_h) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(ab_sh25to75_h, ab_sh25to75_h$Sample_mean_age %in% labs1), aes(y = 21, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(ab_sh25to75_h, ab_sh25to75_h$Sample_mean_age %in% labs2), aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(ab_sh25to75_h$RelYear2) - 30, max(ab_sh25to75_h$RelYear2) + 30)) +
  scale_y_continuous(limits = c(15, 80)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_AB_IEP_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_IEP_25to75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_AB_IEP_25to75_hist,
       width = 10,
       height = 8,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Shell height >75mm

<!-- ```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"} -->
<!-- #Comparing the model fit to the real-time monitoring data (filled circles/red trendline) with predicted values for the historical (dead shell) data (open circles/blue trendline). The dead shell sample ages (i.e., the "RelYears") are estimated as the mean median calibrated age from ~5 radiocarbon-dated specimens per sample). Several older samples (i.e., lower RelYear values) are cut out of the plot below so that the modern data and their model fit are visible. -->

<!-- #Marginal effects plot including random effects -->
<!-- SH_AllDates_GLMM_AB_MEPlivedat_o75 <- subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate") %>% -->
<!--   data_grid(RelYear, Subtidal) %>% -->
<!--   add_fitted_draws(ab_sho75_glmm1, allow_new_levels = TRUE) %>% -->
<!--   ggplot(aes(x = RelYear, y = ShellHeight_mm)) + -->
<!--   stat_lineribbon(aes(y = .value), color = "firebrick1") + -->
<!--   geom_point(data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier != "Estimate"), shape = 21, color = "black", fill = "firebrick2") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   scale_color_brewer(palette = "Set2") -->
<!-- #SH_AllDates_GLMM_AB_MEPrand_o75   -->

<!-- ab_sho75_histpred <- subset(ab_sho75, ab_sho75$LiveDate_Qualifier == "Estimate") %>% -->
<!--   data_grid(RelYear, Subtidal) %>% -->
<!--   add_fitted_draws(ab_sho75_glmm1, allow_new_levels = TRUE) -->

<!-- SH_AllDates_GLMM_AB_MEPalldat_o75 <- SH_AllDates_GLMM_AB_MEPlivedat_o75 + -->
<!--   stat_lineribbon(data = ab_sho75_histpred, aes(y = .value), color = "dodgerblue1") + -->
<!--   geom_point(data = subset(ab_sho75, ab_sho75$LiveDate_Qualifier == "Estimate"), shape = 21, color = "black", fill = "dodgerblue2") + -->
<!--   coord_cartesian(ylim=c(60, 140), xlim=c(390, 440)) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_AB_MEPalldat_o75 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_MEPalldat_o75_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_AB_MEPalldat_o75, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<br>

Including the random effect of reef (i.e., managed area-wide credible interval):

```{r echo=TRUE, fig.show="hold", message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="50%"}
#Marginal effects plot including random effects
#labs1 <- sort(unique(ab_sho75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- c(1704, 1813, 1899, 1933, 1997, 2016)
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))
#labs1 <- labs1[c(-3, -4, -6)]
#labs2 <- sort(unique(ab_sho75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- c(1987, 2013) #1706, 1979, 1987, 1991, 1993, 1997, 2014, 2017

set.seed(987)
#ab_sho75_1 <- plot(conditional_effects(ab_sho75_glmm, re_formula = NULL), plot = FALSE)[[1]]
ab_sho75_hist_1 <- plot(conditional_effects(ab_sho75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]

SH_AllDates_GLMM_AB_MEPrand_o75_allYr <- ggplot() +#ab_sho75_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = ab_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_boxplot(data = subset(ab_sho75, ab_sho75$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = ShellHeight_mm), color = "blue", alpha = 0.5, lwd = 1, inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  #geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = ab_sho75_hist_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = ab_sho75_hist_1$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(ab_sho75, ab_sho75$Sample_mean_age %in% labs1), aes(y = 73, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(ab_sho75, ab_sho75$Sample_mean_age %in% labs2), aes(y = 69, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  theme(legend.position = "none") +
  coord_cartesian(ylim = c(68, 150))
SH_AllDates_GLMM_AB_MEPrand_o75_allYr

SH_AllDates_GLMM_AB_MEPrand_o75_post1994 <- SH_AllDates_GLMM_AB_MEPrand_o75_allYr +
                                                    geom_boxplot(data = subset(ab_sho75, ab_sho75$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = ShellHeight_mm), color = "blue", alpha = 0.5, lwd = 1, inherit.aes = FALSE) +
                                                    coord_cartesian(xlim = c(285, 315)) +
                                                    theme(legend.position = "right")
SH_AllDates_GLMM_AB_MEPrand_o75_post1994

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_MEPrand_o75_allYr_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_AB_MEPrand_o75_allYr,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_MEPrand_o75_post1994_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_AB_MEPrand_o75_post1994,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):

```{r echo=TRUE, fig.show="hold", message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="50%"}
#Marginal effects plot excluding random effects
#labs1 <- sort(unique(ab_sho75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- c(1704, 1813, 1899, 1933, 1997, 2016)
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))
#labs1 <- labs1[c(-3, -4, -6)]
#labs2 <- sort(unique(ab_sho75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- c(1987, 2013) #1706, 1979, 1987, 1991, 1993, 1997, 2014, 2017

set.seed(654)
#ab_sho75_2 <- plot(conditional_effects(ab_sho75_glmm, re_formula = NA), plot = FALSE)[[1]]
ab_sho75_hist_2 <- plot(conditional_effects(ab_sho75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]

SH_AllDates_GLMM_AB_MEPnorand_o75_allYr <- ggplot() +#ab_sho75_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = ab_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_boxplot(data = subset(ab_sho75, ab_sho75$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = ShellHeight_mm), color = "blue", alpha = 0.5, lwd = 1, inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  #geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = ab_sho75_hist_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = ab_sho75_hist_2$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(ab_sho75, ab_sho75$Sample_mean_age %in% labs1), aes(y = 73, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(ab_sho75, ab_sho75$Sample_mean_age %in% labs2), aes(y = 69, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  theme(legend.position = "none") +
  coord_cartesian(ylim = c(68, 150))
SH_AllDates_GLMM_AB_MEPnorand_o75_allYr

SH_AllDates_GLMM_AB_MEPnorand_o75_post1994 <- SH_AllDates_GLMM_AB_MEPrand_o75_allYr +
                                                    geom_boxplot(data = subset(ab_sho75, ab_sho75$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = ShellHeight_mm), color = "blue", alpha = 0.5, lwd = 1, inherit.aes = FALSE) +
                                                    coord_cartesian(xlim = c(285, 315)) +
                                                    theme(legend.position = "right")
SH_AllDates_GLMM_AB_MEPnorand_o75_post1994

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_MEPnorand_o75_allYr_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_AB_MEPnorand_o75_allYr,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_MEPnorand_o75_post1994_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_AB_MEPnorand_o75_post1994,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br>

Individual effects plots:

<!-- <br> -->

<!-- Real-time data: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"} -->
<!-- #Individual effects plots -->

<!-- #labs1 <- sort(unique(ab_sho75$Sample_mean_age))#[c(TRUE, FALSE)] -->
<!-- #labs1 <- labs1[seq(1, length(labs1), 4)] -->
<!-- #labs1 <- append(labs1, c(1954)) -->

<!-- ab_sho75_rt <- subset(ab_sho75, ab_sho75$Sample_mean_age_qualifier != "Estimate") -->

<!-- set.seed(987) -->
<!-- SH_AllDates_GLMM_AB_IEP_o75 <- ab_sho75_rt %>% -->
<!--   group_by(reefIDcrosswalk) %>% -->
<!--   add_fitted_draws(ab_sho75_glmm) %>% -->
<!--   ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) + -->
<!--   stat_lineribbon(aes(y = .value), size = 1) + -->
<!--   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) + -->
<!--   geom_point(data = ab_sho75_rt) + #aes(fill = Region.y), shape = 21, color = "black") + -->
<!--   #geom_line(aes(y = .value), linetype = "dashed", color = "black") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   #scale_color_brewer(palette = "Set2") + -->
<!--   geom_text(data = ab_sho75_rt, aes(y = 71, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) + -->
<!--   #geom_text(data = subset(ab_sho75, ab_sho75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) + -->
<!--   theme_bw() + theme(axis.line = element_line()) + -->
<!--   scale_x_continuous(limits = c(min(ab_sho75_rt$RelYear2) - 1, max(ab_sho75_rt$RelYear2) + 1)) + -->
<!--   scale_y_continuous(limits = c(70, 150)) + -->
<!--   #theme(legend.position = "none") + -->
<!--   labs(color = "Reef ID", fill = "Credible Interval") + -->
<!--   facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free") -->
<!-- SH_AllDates_GLMM_AB_IEP_o75 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_IEP_o75_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_AB_IEP_o75, -->
<!--        width = 10, -->
<!--        height = 30, -->
<!--        units = "in", -->
<!--        dpi = 300, limitsize = FALSE) -->
<!-- ``` -->

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=8, fig.width=10, out.width="100%"}

labs1 <- sort(unique(ab_sho75$Sample_mean_age))[c(TRUE, FALSE)]
labs2 <- sort(unique(ab_sho75$Sample_mean_age))[c(FALSE, TRUE)]
#labs1 <- labs1[labs1 != 1972]
#labs2 <- labs2[labs2 != 1706]

ab_sho75_h <- subset(ab_sho75, ab_sho75$Sample_mean_age_qualifier == "Estimate")

set.seed(654)
SH_AllDates_GLMM_AB_IEP_o75_hist <- ab_sho75_h %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(ab_sho75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = ab_sho75_h) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(ab_sho75_h, ab_sho75_h$Sample_mean_age %in% labs1), aes(y = 73.5, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(ab_sho75_h, ab_sho75_h$Sample_mean_age %in% labs2), aes(y = 71.5, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(ab_sho75, ab_sho75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(ab_sho75_h$RelYear2) - 40, max(ab_sho75_h$RelYear2) + 40)) +
  scale_y_continuous(limits = c(70, 115)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_AB_IEP_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_AB_IEP_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_AB_IEP_o75_hist,
       width = 10,
       height = 8,
       units = "in",
       dpi = 300, limitsize = FALSE)
```

<!-- <br><br><br> -->

```{r include=FALSE}
# Remove created objects to save memory.
rm(ab_sh25to75, ab_sh25to75_glmm, 
   ab_sh25to75_hist, ab_sho75_glmm_hist, 
   SH_AllDates_GLMM_AB_PDistandMChains_sh25to75, SH_AllDates_GLMM_AB_PDistandMChains_o75,
   SH_AllDates_GLMM_AB_PDistandMChains_sh25to75_hist, SH_AllDates_GLMM_AB_PDistandMChains_o75_hist,
   SH_AllDates_GLMM_AB_PPcheck_sh25to75, SH_AllDates_GLMM_AB_PPcheck_o75,
   SH_AllDates_GLMM_AB_PPcheck_sh25to75_hist, SH_AllDates_GLMM_AB_PPcheck_o75_hist,
   SH_AllDates_GLMM_AB_MEPrand_sh25to75, SH_AllDates_GLMM_AB_MEPrand_o75,
   SH_AllDates_GLMM_AB_MEPnorand_sh25to75, SH_AllDates_GLMM_AB_MEPnorand_o75,
   SH_AllDates_GLMM_AB_IEP_sh25to75, SH_AllDates_GLMM_AB_IEP_o75,
   SH_AllDates_GLMM_AB_IEP_sh25to75_hist, SH_AllDates_GLMM_AB_IEP_o75_hist
   )

```

<br><br><br>

#### Apalachicola NERR_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# 
 an_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Apalachicola NERR_Natural")
 an_sho25[, QuadSize_m2 := as.factor(QuadSize_m2)]
 an_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
 an_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
 an_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
 an_sho25[ShellHeight_mm < 75, SizeClass := "25to75mm"]
 an_sho25[ShellHeight_mm >= 75, SizeClass := "o75mm"]

#Exclude the five samples that don't have counts less than the "NumberMeasured" value for the corresponding program (see variable exploration graphs in the 25to75mm section for the rationale and graphs for this step.)
an_sho25[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", LiveDate2, "-", Month)]
numValves <- an_sho25[, counts := length(ShellHeight_mm), by = c("rc_quad_yrmo")]
numValves <- unique(numValves[, c("ProgramID", "RelYear2", "counts", "rc_quad_yrmo", "Subtidal", "QuadSize_m2", "LiveDate_Qualifier", "NumberMeasured_n")])
exclude_samps <- subset(numValves, numValves$NumberMeasured_n == "20" & numValves$counts > 19)$rc_quad_yrmo
an_sho25 <- subset(an_sho25, an_sho25$rc_quad_yrmo %in% setdiff(an_sho25$rc_quad_yrmo, exclude_samps))

saveRDS(an_sho25, here::here(paste0('GLMMs/AllDates/Data/an_sho25_', Sys.Date(), '.rds')))
# 
# an_sh25to75 <- subset(an_sho25, an_sho25$ShellHeight_mm < 75)
# 
# an_sho25_glmm <- brm(formula = ShellHeight_mm ~ RelYear + QuadSize_m2 + NumberMeasured_n + LiveDate_Qualifier + Subtidal + (1 + RelYear|reefIDcrosswalk), data = an_sho25, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "identity"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# an_sho25_glmm <- add_criterion(an_sho25_glmm, "loo")
# 
# #I am writing down the separate models I tried after already running them and the reported information for 11:13 are largely the same; some of the differences had to do with increasing the adapt_delta and max_treedepth arguments, but I don't know exactly what they were for 11 and 12. I am also not confident in the adapt_delta or max_treedepth values for the other models in this list.
# 
# an_sho25_glmm1 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + QuadSize_m2 + NumberMeasured_n + Subtidal, data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 2000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# 
# an_sho25_glmm2 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear, data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/an_sho25_glmm2.rds")
# an_sho25_glmm2 <- add_criterion(an_sho25_glmm2, "loo")
# 
# an_sho25_glmm3 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + QuadSize_m2, data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# 
# an_sho25_glmm4 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + NumberMeasured_n, data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/an_sho25_glmm4.rds")
# an_sho25_glmm4 <- add_criterion(an_sho25_glmm4, "loo")
# 
# an_sho25_glmm5 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear2 + Subtidal, data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2)) #, file = "GLMMs/an_sho25_glmm5.rds")
# an_sho25_glmm5 <- add_criterion(an_sho25_glmm5, "loo")
# 
# an_sho25_glmm6 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + NumberMeasured_n + Subtidal, data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# 
# #there is no model 7
# an_sho25_glmm8 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + (0 + RelYear | NumberMeasured_n), data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# an_sho25_glmm8 <- add_criterion(an_sho25_glmm8, "loo")
# 
# an_sho25_glmm9 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + (1 + RelYear | NumberMeasured_n), data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# an_sho25_glmm9 <- add_criterion(an_sho25_glmm9, "loo")
# 
# an_sho25_glmm10 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + (1 | Subtidal), data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# an_sho25_glmm10 <- add_criterion(an_sho25_glmm10, "loo")
# 
# an_sho25_glmm11 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + (1 + RelYear | Subtidal), data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# 
# an_sho25_glmm12 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + (1 + RelYear | Subtidal), data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# 
# an_sho25_glmm13 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear + (1 + RelYear | Subtidal), data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), family = skew_normal, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 10), iter = 4000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2))
# 
# #GLMM 5 is the best fit to the data when compared with the other major parameterizations that successfully converged.
# an_comp <- loo_compare(an_sho25_glmm4, an_sho25_glmm5, an_sho25_glmm8, an_sho25_glmm9, an_sho25_glmm10)
# print(an_comp, simplify = FALSE, digits = 3)
# 
# #predtest <- predict(an_sho25_glmm9, newdata = subset(an_sho25, an_sho25$LiveDate_Qualifier == "Estimate"))
# 
# saveRDS(an_sho25_glmm5, here::here('GLMMs/AllDates/an_sho25_glmm.rds'))
# 
# 
# 
# an_sho25_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ me(RelYear2, Sample_age_stdev), data = subset(an_sho25, an_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/an_sho25_glmm_hist1.rds")
# an_sho25_glmm_hist1 <- add_criterion(an_sho25_glmm_hist1, "loo")
# 
# an_sho25_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ me(RelYear2, Sample_age_stdev), data = subset(an_sho25, an_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(0,10)", class = "b")), cores = 4, control= list(adapt_delta = 0.9, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/an_sho25_glmm_hist2.rds")
# an_sho25_glmm_hist2 <- add_criterion(an_sho25_glmm_hist2, "loo")
# 
# an_sho25_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ RelYear2, data = subset(an_sho25, an_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.9, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/an_sho25_glmm_hist3.rds")
# an_sho25_glmm_hist3 <- add_criterion(an_sho25_glmm_hist3, "loo")
# 
# an_sho25_glmm_hist4 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(an_sho25, an_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.9, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/an_sho25_glmm_hist4.rds")
# an_sho25_glmm_hist4 <- add_criterion(an_sho25_glmm_hist4, "loo")
# 
# an_sho25_glmm_hist5 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ RelYear2 + (0 + RelYear2 | reefIDcrosswalk), data = subset(an_sho25, an_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.9, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/an_sho25_glmm_hist5.rds")
# an_sho25_glmm_hist5 <- add_criterion(an_sho25_glmm_hist5, "loo")
# 
# an_sho25_glmm_hist6 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear2 | reefIDcrosswalk), data = subset(an_sho25, an_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/an_sho25_glmm_hist6.rds")
# an_sho25_glmm_hist6 <- add_criterion(an_sho25_glmm_hist6, "loo")
# 
# #GLMM6 is the best model for the historical data
# loo_compare(an_sho25_glmm_hist1, an_sho25_glmm_hist2, an_sho25_glmm_hist3, an_sho25_glmm_hist4, an_sho25_glmm_hist5, an_sho25_glmm_hist6)

```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}

an_sh25to75 <- subset(an_sho25, an_sho25$ShellHeight_mm < 75)
#an_sh25to75[, QuadSize_m2 := as.numeric(QuadSize_m2)]
#an_sh25to75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
#an_sh25to75[, RelYear := LiveDate2 - min(LiveDate2)]
#an_sh25to75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(an_sh25to75, here::here(paste0('GLMMs/AllDates/Data/an_sh25to75_', Sys.Date(), '.rds')))

# an_sho25_glmm <- brm(formula = ShellHeight_mm ~ RelYear + QuadSize_m2 + NumberMeasured_n + LiveDate_Qualifier + Subtidal + (1 + RelYear|reefIDcrosswalk), data = an_sho25, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "identity"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# an_sho25_glmm <- add_criterion(an_sho25_glmm, "loo")

ggplot(subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() #+
  #theme(legend.position = "none")

ggplot(subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() #+
  #theme(legend.position = "none")

ggplot(subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = as.factor(QuadSize_m2), color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")

#Subtidal samples should be removed, but it doesn't look like there is a systematic effect of QuadSize_m2 on the median ShellHeight_mm
ggplot(subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = ShellHeight_mm)) +
  geom_jitter(aes(color = QuadIdentifier)) +
  geom_boxplot(aes(group = RelYear2, color = Subtidal), alpha = 0.5) +
  facet_wrap(~ as.factor(QuadSize_m2)) +
  theme(legend.position = "none")

# I commented this out because I applied this to the an_sho25 file when it was created above, so the changes automatically apply to the an_sh25to75 data table.
# an_sh25to75[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", LiveDate2, "-", Month)]
# numValves <- an_sh25to75[, counts := length(ShellHeight_mm), by = c("rc_quad_yrmo")]
# numValves <- unique(numValves[, c("ProgramID", "RelYear2", "counts", "rc_quad_yrmo", "Subtidal", "QuadSize_m2", "LiveDate_Qualifier", "NumberMeasured_n")])

ggplot(subset(numValves, numValves$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = counts)) +
  geom_jitter(aes(color = rc_quad_yrmo)) +
  geom_boxplot(aes(group = RelYear2, color = Subtidal), alpha = 0.5) +
  facet_wrap(~ as.factor(QuadSize_m2)) +
  theme(legend.position = "none")

#Counts for only four samples equal the corresponding NumberMeasured_n values, suggesting that, effectively, all live specimens were measured for the other samples. Dropping those four samples from the model could allow us to drop the NumberMeasured_n variable.
ggplot(subset(numValves, numValves$LiveDate_Qualifier != "Estimate"), aes(x = NumberMeasured_n, y = counts)) +
  geom_jitter(aes(color = as.factor(ProgramID))) +
  #geom_boxplot(aes(group = RelYear2, color = Subtidal), alpha = 0.5) +
  facet_wrap(~ as.factor(QuadSize_m2)) #+
  #theme(legend.position = "none")

# I commented this out because I applied this to the an_sho25 file when it was created above, so the changes automatically apply to the an_sh25to75 data table.
# exclude_samps <- subset(numValves, numValves$NumberMeasured_n == "20" & numValves$counts > 19)$rc_quad_yrmo
# an_sh25to75 <- subset(an_sh25to75, an_sh25to75$rc_quad_yrmo %in% setdiff(an_sh25to75$rc_quad_yrmo, exclude_samps))

ggplot(subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = Subtidal, color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")

ggplot(subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = NumberMeasured_n, color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")

ggplot(subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = as.factor(QuadSize_m2), y = NumberMeasured_n, color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")

#Started over with some basic models, but continued numbering scheme to avoid overwriting previous model outputs.
#Intercept model converged, but was not significant.
an_sh25to75_glmm8 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ 1, data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate" & an_sh25to75$Subtidal == FALSE), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sh25to75_glmm8.rds")
an_sh25to75_glmm8 <- add_criterion(an_sh25to75_glmm8, "loo")

#Model converged, RelYear was significant.
an_sh25to75_glmm9 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2, data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sh25to75_glmm9.rds")
an_sh25to75_glmm9 <- add_criterion(an_sh25to75_glmm9, "loo")

#Model converged, Subtidal was significant
an_sh25to75_glmm10 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ Subtidal, data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sh25to75_glmm10.rds")
an_sh25to75_glmm10 <- add_criterion(an_sh25to75_glmm10, "loo")

#Model converged, QuadSize_m2 was significant
an_sh25to75_glmm11 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ as.factor(QuadSize_m2), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sh25to75_glmm11.rds")
an_sh25to75_glmm11 <- add_criterion(an_sh25to75_glmm11, "loo")

#Model converged, RelYear term was significant.
an_sh25to75_glmm12 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + QuadSize_m2 + Subtidal + (1 | reefIDcrosswalk), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sh25to75_glmm12.rds")
an_sh25to75_glmm12 <- add_criterion(an_sh25to75_glmm12, "loo")

#Adding Subtidal term to the grouping variable for GLMM 12.
an_sh25to75_glmm12b <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + QuadSize_m2 + Subtidal + (1 | gr(reefIDcrosswalk, by = Subtidal)), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sh25to75_glmm12b.rds")
an_sh25to75_glmm12b <- add_criterion(an_sh25to75_glmm12b, "loo")

#Model converged, RelYear term was significant.
an_sh25to75_glmm13 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + QuadSize_m2 + Subtidal + (0 + RelYear2 | reefIDcrosswalk), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sh25to75_glmm13.rds")
an_sh25to75_glmm13 <- add_criterion(an_sh25to75_glmm13, "loo")

#Trying a model with the size classes built into the model instead of split out using truncation.
#an_sho25[ShellHeight_mm < 75, SizeClass := "25-75mm"]
#an_sho25[ShellHeight_mm >= 75, SizeClass := ">75mm"]
an_sho25c_glmm1 <- brm(formula = ShellHeight_mm ~ 0 + RelYear2 + SizeClass + as.factor(QuadSize_m2) + Subtidal + RelYear2:SizeClass + (1 | reefIDcrosswalk), data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sho25c_glmm1.rds")
an_sho25c_glmm1 <- add_criterion(an_sho25c_glmm1, "loo")

#Model did not converge.
an_sho25c_glmm2 <- brm(formula = ShellHeight_mm ~ 0 + RelYear2 + SizeClass + as.factor(QuadSize_m2) + Subtidal + RelYear2:SizeClass + (0 + RelYear2 | reefIDcrosswalk), data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sho25c_glmm2.rds")
an_sho25c_glmm2 <- add_criterion(an_sho25c_glmm2, "loo")

#Subtidal is confounded with RelYear (only one year with Subtidal data, and there are no intertidal data for that year), so is NumberMeasured_n (only one n value has more than one year of data and they don't overlap with any other n value), and although two of the quad sizes have two years of data, two sizes are confounded with NumberMeasured_n. There are only five years of data, so if any of these variables drop out, there are not 5 years of data to analyze. It seems like there simply isn't enough data to run a solid model on this dataset.


an_sh25to75_glmm1 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + Subtidal, data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sh25to75_glmm1.rds")
an_sh25to75_glmm1 <- add_criterion(an_sh25to75_glmm1, "loo")

#Model converged, intercept not significant.
an_sh25to75_glmm1b <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ 1, data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sh25to75_glmm1b.rds")
an_sh25to75_glmm1b <- add_criterion(an_sh25to75_glmm1b, "loo")

#Model converged, RelYear2 was significant.
an_sh25to75_glmm2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2, data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sh25to75_glmm2.rds")
an_sh25to75_glmm2 <- add_criterion(an_sh25to75_glmm2, "loo")

#Model converged, Subtidal was significant.
an_sh25to75_glmm2b <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ Subtidal, data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sh25to75_glmm2b.rds")
an_sh25to75_glmm2b <- add_criterion(an_sh25to75_glmm2b, "loo")

#Model converged, QuadSize_m2 was significant.
an_sh25to75_glmm2c <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ QuadSize_m2, data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sh25to75_glmm2c.rds")
an_sh25to75_glmm2c <- add_criterion(an_sh25to75_glmm2c, "loo")

an_sh25to75_glmm3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + NumberMeasured_n, data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sh25to75_glmm3.rds")
an_sh25to75_glmm3 <- add_criterion(an_sh25to75_glmm3, "loo")

an_sh25to75_glmm4 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sh25to75_glmm4.rds")
an_sh25to75_glmm4 <- add_criterion(an_sh25to75_glmm4, "loo")

#Model converged.
an_sh25to75_glmm4b <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + QuadSize_m2 + (1 | reefIDcrosswalk), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sh25to75_glmm4b.rds")
an_sh25to75_glmm4b <- add_criterion(an_sh25to75_glmm4b, "loo")

#NEED TO RE-RUN THIS MODEL SINCE RE-CODING ID5073 AS SUBTIDAL (it was taking a long time and this model is not going to be included in the output so I moved on.)
an_sh25to75_glmm4b_nosub <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + QuadSize_m2 + (1 | reefIDcrosswalk), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate" & an_sh25to75$Subtidal == FALSE), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sh25to75_glmm4b_nosub.rds")
an_sh25to75_glmm4b_nosub <- add_criterion(an_sh25to75_glmm4b_nosub, "loo")

an_sh25to75_glmm5 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = skew_normal, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sh25to75_glmm5.rds")
an_sh25to75_glmm5 <- add_criterion(an_sh25to75_glmm5, "loo")

an_sh25to75_glmm6 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + (1 + RelYear2 | reefIDcrosswalk), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sh25to75_glmm6.rds")
an_sh25to75_glmm6 <- add_criterion(an_sh25to75_glmm6, "loo")

an_sh25to75_glmm7 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + (0 + RelYear2 | reefIDcrosswalk), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/an_sh25to75_glmm7.rds")
an_sh25to75_glmm7 <- add_criterion(an_sh25to75_glmm7, "loo")

#Model converged.
an_sh25to75_glmm7b <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + QuadSize_m2 + (0 + RelYear2 | reefIDcrosswalk), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sh25to75_glmm7b.rds")
an_sh25to75_glmm7b <- add_criterion(an_sh25to75_glmm7b, "loo")

# Commented these out because none of these models included QuadSize_m2.
# #GLMM 4 is the best fit.
# loo_compare(an_sh25to75_glmm1, an_sh25to75_glmm2, an_sh25to75_glmm3, an_sh25to75_glmm4, an_sh25to75_glmm5, an_sh25to75_glmm6, an_sh25to75_glmm7)

#GLMM 4b is the better fit.
loo_compare(an_sh25to75_glmm4b, an_sh25to75_glmm7b)

#GLMM 4b is the better fit, but of the two models that include the interaction of RelYear and Region, GLMM 12 is the better fit.
loo_compare(an_sh25to75_glmm4b, an_sh25to75_glmm12, an_sh25to75_glmm12b, an_sh25to75_glmm13)

#Model did not converge.
an_sh25to75_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear2 | reefIDcrosswalk), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sh25to75_glmm_hist1.rds")
an_sh25to75_glmm_hist1 <- add_criterion(an_sh25to75_glmm_hist1, "loo")

#Trying previous model again with priors for meanme, sdme, and sd. Stopped the run because the model was taking a long time and one chain still hadn't started. Will try this one again if I have time.
an_sh25to75_glmm_hist1b <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear2 | reefIDcrosswalk), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(329.2, 200)", class = "meanme"), set_prior("normal(73.75, 160)", class = "sdme"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control = list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sh25to75_glmm_hist1b.rds")
an_sh25to75_glmm_hist1b <- add_criterion(an_sh25to75_glmm_hist1b, "loo")

#Model converged, RelYear term was significant.
an_sh25to75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sh25to75_glmm_hist2.rds")
an_sh25to75_glmm_hist2 <- add_criterion(an_sh25to75_glmm_hist2, "loo")

#Model converged.
an_sh25to75_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = subset(an_sh25to75, an_sh25to75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sh25to75_glmm_hist3.rds")
an_sh25to75_glmm_hist3 <- add_criterion(an_sh25to75_glmm_hist3, "loo")


```


```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}

an_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Apalachicola NERR_Natural")
an_sho75[, QuadSize_m2 := as.factor(QuadSize_m2)]
an_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
an_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
an_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]

#Exclude the five samples that don't have counts less than the "NumberMeasured" value for the corresponding program (see variable exploration graphs in the 25to75mm section for the rationale and graphs for this step.)
an_sho75[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", LiveDate2, "-", Month)]
numValves_o75 <- an_sho75[, counts := length(ShellHeight_mm), by = c("rc_quad_yrmo")]
numValves_o75 <- unique(numValves_o75[, c("ProgramID", "RelYear2", "counts", "rc_quad_yrmo", "Subtidal", "QuadSize_m2", "LiveDate_Qualifier", "NumberMeasured_n")])
exclude_samps_o75 <- subset(numValves_o75, numValves_o75$NumberMeasured_n == "20" & numValves_o75$counts > 19)$rc_quad_yrmo
an_sho75 <- subset(an_sho75, an_sho75$rc_quad_yrmo %in% setdiff(an_sho75$rc_quad_yrmo, exclude_samps_o75))

saveRDS(an_sho75, here::here(paste0('GLMMs/AllDates/Data/an_sho75_', Sys.Date(), '.rds')))


ggplot(subset(an_sho75, an_sho75$Sample_age_qualifier == "Exact"), aes(RelYear2, ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_point() +
  theme_bw()

an_sho75_glmm <- brm(formula = ShellHeight_mm ~ RelYear + QuadSize_m2 + NumberMeasured_n + LiveDate_Qualifier + Subtidal + (1 + RelYear|reefIDcrosswalk), data = an_sho75, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "identity"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
an_sho75_glmm <- add_criterion(an_sho75_glmm, "loo")

an_sho75_glmm1 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + Subtidal, data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 80) #, file = "GLMMs/an_sho75_glmm1.rds")
an_sho75_glmm1 <- add_criterion(an_sho75_glmm1, "loo")

#Model converged, intercept was significant.
an_sho75_glmm1b <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ 1, data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sho75_glmm1b.rds")
an_sho75_glmm1b <- add_criterion(an_sho75_glmm1b, "loo")

an_sho75_glmm2 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2, data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 80) #, file = "GLMMs/an_sho75_glmm1.rds")
an_sho75_glmm2 <- add_criterion(an_sho75_glmm2, "loo")

#Model converged, RelYear2 was not significant.
an_sho75_glmm2b <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2, data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sho75_glmm2b.rds")
an_sho75_glmm2b <- add_criterion(an_sho75_glmm2b, "loo")

#Model converged, QuadSize_m2 was not significant.
an_sho75_glmm2c <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ QuadSize_m2, data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sho75_glmm2c.rds")
an_sho75_glmm2c <- add_criterion(an_sho75_glmm2c, "loo")

#Model converged, Subtidal was significant.
an_sho75_glmm2d <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ Subtidal, data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sho75_glmm2d.rds")
an_sho75_glmm2d <- add_criterion(an_sho75_glmm2d, "loo")

an_sho75_glmm3 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + NumberMeasured_n, data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 80) #, file = "GLMMs/an_sho75_glmm1.rds")
an_sho75_glmm3 <- add_criterion(an_sho75_glmm3, "loo")

an_sho75_glmm4 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 80) #, file = "GLMMs/an_sho75_glmm1.rds")
an_sho75_glmm4 <- add_criterion(an_sho75_glmm4, "loo")

#Model converged, RelYear2 was not significant.
an_sho75_glmm4b <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sho75_glmm4b.rds")
an_sho75_glmm4b <- add_criterion(an_sho75_glmm4b, "loo")

#Model did not converge.
an_sho75_glmm4b_nosub <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate" & an_sho75$Subtidal == FALSE), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sho75_glmm4b_nosub.rds")
an_sho75_glmm4b_nosub <- add_criterion(an_sho75_glmm4b_nosub, "loo")

#Model converged, RelYear2 was not significant
an_sho75_glmm4c <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + Subtidal + (1 | reefIDcrosswalk), data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sho75_glmm4c.rds")
an_sho75_glmm4c <- add_criterion(an_sho75_glmm4c, "loo")

#Model converged, RelYear2 was not significant
an_sho75_glmm4d <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + Subtidal + (0 + RelYear2 | reefIDcrosswalk), data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sho75_glmm4d.rds")
an_sho75_glmm4d <- add_criterion(an_sho75_glmm4d, "loo")

an_sho75_glmm5 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = skew_normal, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 80) #, file = "GLMMs/an_sho75_glmm1.rds")
an_sho75_glmm5 <- add_criterion(an_sho75_glmm5, "loo")

an_sho75_glmm6 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + (1 + RelYear2 | reefIDcrosswalk), data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 80) #, file = "GLMMs/an_sho75_glmm1.rds")
an_sho75_glmm6 <- add_criterion(an_sho75_glmm6, "loo")

an_sho75_glmm7 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + (0 + RelYear2 | reefIDcrosswalk), data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 80) #, file = "GLMMs/an_sho75_glmm1.rds")
an_sho75_glmm7 <- add_criterion(an_sho75_glmm7, "loo")

#Model converged, RelYear2 was not significant.
an_sho75_glmm7b <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (0 + RelYear2 | reefIDcrosswalk), data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sho75_glmm7b.rds")
an_sho75_glmm7b <- add_criterion(an_sho75_glmm7b, "loo")

# Commented these lines out because I re-did a number of the models to include QuadSize_m2 and an upper bound on ShellHeight_mm.
# #GLMM #2 is the best fit.
# loo_compare(an_sho75_glmm1, an_sho75_glmm2, an_sho75_glmm3, an_sho75_glmm4, an_sho75_glmm5, an_sho75_glmm6, an_sho75_glmm7)

#GLMM 4b is the better fit, but of the models including the "Subtidal" variable, GLMM 4c is the best fit.
loo_compare(an_sho75_glmm4b, an_sho75_glmm4c, an_sho75_glmm4d, an_sho75_glmm7b)

#Model converged, RelYear term was significant.
an_sho75_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear2 | reefIDcrosswalk), data = subset(an_sho75, an_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sho75_glmm_hist1.rds")
an_sho75_glmm_hist1 <- add_criterion(an_sho75_glmm_hist1, "loo")

an_sho75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(an_sho75, an_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2)) #, file = "GLMMs/an_sho75_glmm_hist2.rds")
an_sho75_glmm_hist2 <- add_criterion(an_sho75_glmm_hist2, "loo")

#Model converged, RelYear term was significant.
an_sho75_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = subset(an_sho75, an_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_sho75_glmm_hist3.rds")
an_sho75_glmm_hist3 <- add_criterion(an_sho75_glmm_hist3, "loo")

#GLMM 3 is the better fit.
loo_compare(an_sho75_glmm_hist1, an_sho75_glmm_hist3)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
an_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Apalachicola NERR_Natural")
an_sho25[, QuadSize_m2 := as.factor(QuadSize_m2)]
an_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
an_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
an_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
an_sho25[ShellHeight_mm < 75, SizeClass := "25to75mm"]
an_sho25[ShellHeight_mm >= 75, SizeClass := "o75mm"]
saveRDS(an_sho25, here::here(paste0('GLMMs/AllDates/Data/an_sho25_', Sys.Date(), '.rds')))

#an_sho25_glmm <- readRDS(here::here('GLMMs/AllDates/an_sho25_glmm.rds'))


an_sh25to75 <- subset(an_sho25, an_sho25$ShellHeight_mm < 75)

an_sh25to75_glmm <- readRDS(here::here('GLMMs/AllDates/an_sh25to75_glmm12.rds'))
an_sh25to75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/an_sh25to75_glmm_hist3.rds'))


an_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Apalachicola NERR_Natural")
an_sho75[, QuadSize_m2 := as.factor(QuadSize_m2)]
an_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
an_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
an_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(an_sho75, here::here(paste0('GLMMs/AllDates/Data/an_sho75_', Sys.Date(), '.rds')))

an_sho75_glmm <- readRDS(here::here('GLMMs/AllDates/an_sho75_glmm4c.rds'))
an_sho75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/an_sho75_glmm_hist3.rds'))

```

##### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

an_sho25[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
an_sho25[, SampleDay := day(SampleDate)]

sh_t <- copy(an_sho25[0, ])
sh_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(an_sho25$Month))){
  mo <- subset(an_sho25, as.numeric(an_sho25$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  sh_t <- rbind(mo, sh_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

```

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.height=6, fig.width=10, out.width = "100%"}
SampleDatesPlot <- ggplot(subset(sh_t, sh_t$LiveDate_Qualifier == "Exact"), aes(x = DayNum, y = as.factor(ProgramID), color = Year, shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
SampleDatesPlot
```

```{r, echo=TRUE, message=FALSE, warning=FALSE, fig.height=6, fig.width=10, out.width = "100%"}
rm(sh_t, monthnames, SampleDatesPlot)
```

<br><br><br>

##### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_specimens = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for size class 25-75mm first.
sh25to75_status <- subset(an_sh25to75, an_sh25to75$Sample_mean_age %in% StatusYears)
sh25to75_status[, `:=` (Indicator = "Size Class", 
                        SizeClass = "25-75mm", 
                        Year = as.numeric(Sample_mean_age), 
                        n_reefs = length(unique(ReefIdentifier)),
                        n_programs = length(unique(ProgramID)),
                        ProgIDs = list(unique(ProgramID)),
                        n_specimens = length(ShellHeight_mm),
                        Median = median(ShellHeight_mm),
                        Mean = round(mean(ShellHeight_mm), digits = 2),
                        SD = round(sd(ShellHeight_mm), digits = 2), 
                        Min. = min(ShellHeight_mm),
                        Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sh25to75_status <- unique(sh25to75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sh25to75_status <- sh25to75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sh25to75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sh25to75_status$Year)){
    MissingYr_i <- data.table(Indicator = unique(sh25to75_status$Indicator), 
                              SizeClass = unique(sh25to75_status$SizeClass),
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sh25to75_status <- rbind(sh25to75_status, MissingYr_i)
  }
}

#Build status table for size class >75mm next.
sho75_status <- subset(an_sho75, an_sho75$Sample_mean_age %in% StatusYears)
sho75_status[, `:=` (Indicator = "Size Class", 
                     SizeClass = ">75mm", 
                     Year = as.numeric(Sample_mean_age), 
                     n_reefs = length(unique(ReefIdentifier)),
                     n_programs = length(unique(ProgramID)),
                     ProgIDs = list(unique(ProgramID)),
                     n_specimens = length(ShellHeight_mm),
                     Median = median(ShellHeight_mm),
                     Mean = round(mean(ShellHeight_mm), digits = 2),
                     SD = round(sd(ShellHeight_mm), digits = 2), 
                     Min. = min(ShellHeight_mm),
                     Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sho75_status <- unique(sho75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sho75_status <- sho75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sho75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sho75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = ">75mm",
                              Year = i,
                              n_reefs = ifelse(sh25to75_status[Year == i, n_reefs] > 0, sh25to75_status[Year == i, n_reefs], 0),
                              n_programs = ifelse(sh25to75_status[Year == i, n_programs] > 0, sh25to75_status[Year == i, n_programs], 0),
                              ProgIDs = ifelse(!is.na(sh25to75_status[Year == i, ProgIDs]), sh25to75_status[Year == i, ProgIDs], NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sho75_status <- rbind(sho75_status, MissingYr_i)
  }
}

#Merge individual size class tables and set row order
Status <- rbind(Status, sh25to75_status)
Status <- rbind(Status, sho75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) %>%
  kable_styling() %>%
  row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, sh25to75_status, MissingYr_i, sho75_status)
```

<br><br><br>

##### Variable Exploration {.tabset .tabset-fade .tabset-pills}

<br>

Subtidal is confounded with RelYear (only one year with Subtidal data, and there are no intertidal data for that year), so is NumberMeasured_n (only one n value has more than one year of data and they don't overlap with any other n value), and although two of the quad sizes have two years of data, two sizes are confounded with NumberMeasured_n. There are only five years of data, so if any of these variables drop out, there are not 5 years of data to analyze. It seems like there simply isn't enough data to run a solid model on this dataset.

<br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
ggplot(subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() #+
  #theme(legend.position = "none")

ggplot(subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() #+
  #theme(legend.position = "none")
```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
ggplot(subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = as.factor(QuadSize_m2), color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")

#Subtidal samples should be removed, but it doesn't look like there is a systematic effect of QuadSize_m2 on the median ShellHeight_mm
ggplot(subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate")) +
  geom_jitter(aes(x = RelYear2, y = ShellHeight_mm, group = RelYear2, fill = QuadIdentifier), color = "black", shape = 21) +
  geom_boxplot(aes(x = RelYear2, y = ShellHeight_mm, group = RelYear2, color = Subtidal), alpha = 0.5, lwd = 1, inherit.aes = FALSE) +
  facet_wrap(~ as.factor(QuadSize_m2)) +
  labs(caption = "Subtidal samples have a slightly different distribution, but it doesn't \nlook like there is a systematic effect of QuadSize_m2 on the median \nShellHeight_mm. Point color corresponds to QuadIdentifier.") +
  guides(fill = FALSE) +
  theme(plot.caption = element_text(hjust = 0))
```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
an_sho25[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", LiveDate2, "-", Month)]
numValves <- an_sho25[, counts := length(ShellHeight_mm), by = c("rc_quad_yrmo")]
numValves <- unique(numValves[, c("ProgramID", "RelYear2", "counts", "rc_quad_yrmo", "Subtidal", "QuadSize_m2", "LiveDate_Qualifier", "NumberMeasured_n")])

ggplot(subset(numValves, numValves$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = counts)) +
  geom_jitter(aes(fill = rc_quad_yrmo), color = "black", shape = 21) +
  geom_boxplot(aes(group = RelYear2, color = Subtidal), alpha = 0.5, lwd = 1) +
  facet_wrap(~ as.factor(QuadSize_m2)) +
  guides(fill = FALSE) +
  theme_bw()

#Counts for only four samples equal the corresponding NumberMeasured_n values, suggesting that, effectively, all live specimens were measured for the other samples. Dropping those four samples from the model could allow us to drop the NumberMeasured_n variable.
ggplot(subset(numValves, numValves$LiveDate_Qualifier != "Estimate"), aes(x = NumberMeasured_n, y = counts)) +
  geom_jitter(aes(color = as.factor(ProgramID))) +
  #geom_boxplot(aes(group = RelYear2, color = Subtidal), alpha = 0.5) +
  geom_hline(yintercept = 20, color = "light blue") +
  geom_hline(yintercept = 30, color = "red") +
  facet_wrap(~ as.factor(QuadSize_m2)) +
  labs(caption = "Counts for only five samples equal the corresponding NumberMeasured_n values, suggesting that, effectively, all live specimens were measured for the other \nsamples. Dropping those five samples from the model could allow us to drop the NumberMeasured_n variable.") +
  theme(plot.caption = element_text(hjust = 0, size = 12))

exclude_samps <- subset(numValves, numValves$NumberMeasured_n == "20" & numValves$counts > 19)$rc_quad_yrmo
an_sho25 <- subset(an_sho25, an_sho25$rc_quad_yrmo %in% setdiff(an_sho25$rc_quad_yrmo, exclude_samps))
```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
ggplot(subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = Subtidal, color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")

ggplot(subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = NumberMeasured_n, color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")
```

<br><br>

```{r echo=TRUE, message=FALSE, warning=FALSE, out.width="50%"}
ggplot(subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), aes(x = as.factor(QuadSize_m2), y = NumberMeasured_n, color = as.factor(ProgramID))) +
  geom_jitter() #+
  #theme(legend.position = "none")
```

<br><br><br><br>

##### Model Output {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- summary(an_sho25_glmm) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height 25-75mm

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(an_sh25to75_glmm)
```

<br><br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(an_sh25to75_glmm_hist)
```

<br><br><br>

###### Shell height >75mm

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(an_sho75_glmm)
```

<br><br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(an_sho75_glmm_hist)
```

<br><br><br>

##### Diagnostic Plots {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- Posterior distributions and Markov chains: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_ANERR_PDistandMChains_o25 <- plot(an_sho25_glmm) -->
<!-- SH_AllDates_GLMM_ANERR_PDistandMChains_o25 -->

<!-- len <- length(SH_AllDates_GLMM_ANERR_PDistandMChains_o25) -->
<!-- for(i in 1:len){ -->
<!--   jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_PDistandMChains_o25_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300) -->
<!--   print(SH_AllDates_GLMM_ANERR_PDistandMChains_o25[i]) -->
<!--   dev.off() -->
<!-- } -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- Posterior predictive check plot: -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_ANERR_PPcheck_o25 <- pp_check(an_sho25_glmm) -->
<!-- SH_AllDates_GLMM_ANERR_PPcheck_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_PPcheck_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_ANERR_PPcheck_o25, -->
<!--        width = 4, -->
<!--        height = 3, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height 25-75mm

Posterior distributions and Markov chains:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_ANERR_PDistandMChains_25to75 <- plot(an_sh25to75_glmm)
SH_AllDates_GLMM_ANERR_PDistandMChains_25to75

len <- length(SH_AllDates_GLMM_ANERR_PDistandMChains_25to75)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_PDistandMChains_25to75_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_ANERR_PDistandMChains_25to75[i])
  dev.off()
}
```

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_ANERR_PDistandMChains_25to75_hist <- plot(an_sh25to75_glmm_hist)
SH_AllDates_GLMM_ANERR_PDistandMChains_25to75_hist

len <- length(SH_AllDates_GLMM_ANERR_PDistandMChains_25to75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_PDistandMChains_25to75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_ANERR_PDistandMChains_25to75_hist[i])
  dev.off()
}
```

<br><br>

Posterior predictive check plot:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_ANERR_PPcheck_25to75 <- pp_check(an_sh25to75_glmm)
SH_AllDates_GLMM_ANERR_PPcheck_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_PPcheck_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_PPcheck_25to75,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_ANERR_PPcheck_25to75_hist <- tryCatch(pp_check(an_sh25to75_glmm_hist),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_ANERR_PPcheck_25to75_hist) == TRUE){
    SH_AllDates_GLMM_ANERR_PPcheck_25to75_hist <- tryCatch(pp_check(an_sh25to75_glmm_hist), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_ANERR_PPcheck_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_PPcheck_25to75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_PPcheck_25to75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Shell height >75mm

Posterior distributions and Markov chains:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_ANERR_PDistandMChains_o75 <- plot(an_sho75_glmm)
SH_AllDates_GLMM_ANERR_PDistandMChains_o75

len <- length(SH_AllDates_GLMM_ANERR_PDistandMChains_o75)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_PDistandMChains_o75_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_ANERR_PDistandMChains_o75[i])
  dev.off()
}
```


<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_ANERR_PDistandMChains_o75_hist <- plot(an_sho75_glmm_hist)
SH_AllDates_GLMM_ANERR_PDistandMChains_o75_hist

len <- length(SH_AllDates_GLMM_ANERR_PDistandMChains_o75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_PDistandMChains_o75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_ANERR_PDistandMChains_o75_hist[i])
  dev.off()
}
```

<br><br>

Posterior predictive check plot:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_ANERR_PPcheck_o75 <- tryCatch(pp_check(an_sho75_glmm),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_ANERR_PPcheck_o75) == TRUE){
    SH_AllDates_GLMM_ANERR_PPcheck_o75 <- tryCatch(pp_check(an_sho75_glmm), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_ANERR_PPcheck_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_PPcheck_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_PPcheck_o75,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_ANERR_PPcheck_o75_hist <- tryCatch(pp_check(an_sho75_glmm_hist),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_ANERR_PPcheck_o75_hist) == TRUE){
    SH_AllDates_GLMM_ANERR_PPcheck_o75_hist <- tryCatch(pp_check(an_sho75_glmm_hist), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_ANERR_PPcheck_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_PPcheck_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_PPcheck_o75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Marginal Effects Plots {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- Comparing the model fit to the real-time monitoring data (filled circles/red trendline) with predicted values for the historical (dead shell) data (open circles/blue trendline). The dead shell sample ages (i.e., the "RelYears") are estimated as the mean median calibrated age from ~5 radiocarbon-dated specimens per sample). Several older samples (i.e., lower RelYear values) are cut out of the plot below so that the modern data and their model fit are visible. -->

<!-- ```{r echo=TRUE, message=FALSE, warning=FALSE, out.width="100%"} -->
<!-- #Marginal effects plot including random effects -->
<!-- SH_AllDates_GLMM_ANERR_MEPlivedat_o25 <- subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate") %>% -->
<!--   data_grid(RelYear, Subtidal) %>% -->
<!--   add_fitted_draws(an_sho25_glmm5, allow_new_levels = TRUE) %>% -->
<!--   ggplot(aes(x = RelYear, y = ShellHeight_mm)) + -->
<!--   stat_lineribbon(aes(y = .value), color = "firebrick1") + -->
<!--   geom_point(data = subset(an_sho25, an_sho25$LiveDate_Qualifier != "Estimate"), shape = 21, color = "black", fill = "firebrick2") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   scale_color_brewer(palette = "Set2") -->
<!-- #SH_AllDates_GLMM_ANERR_MEPrand_o25   -->

<!-- an_sho25_histpred <- base::subset(an_sho25, an_sho25$LiveDate_Qualifier == "Estimate")  -->
<!-- #an_sho25_quads <- unique(an_sho25_histpred[, c("reefIDcrosswalk", "QuadIdentifier", "Sample_age_stdev")]) -->
<!-- #an_sho25_histpred <- unique(an_sho25_histpred[, c("RelYear2", "Sample_age_stdev")]) -->
<!-- #an_sho25_histpred <- droplevels(an_sho25_histpred) -->
<!-- an_sho25_histpred2 <- an_sho25_histpred %>% -->
<!--   #data_grid(RelYear, Subtidal) %>% -->
<!--   #data_grid(RelYear2, Sample_age_stdev) %>% -->
<!--   #left_join(., an_sho25_quads, by = "Sample_age_stdev") %>% -->
<!--   add_fitted_draws(an_sho25_glmm_hist6) -->
<!-- an_sho25_histpred2$RelYear <- NULL -->
<!-- setnames(an_sho25_histpred2, "RelYear2", "RelYear") -->

<!-- SH_AllDates_GLMM_ANERR_MEPalldat_o25 <- SH_AllDates_GLMM_ANERR_MEPlivedat_o25 + -->
<!--   geom_smooth(data = an_sho25_histpred2, aes(y = .value), color = "dodgerblue1") + -->
<!--   geom_point(data = subset(an_sho25, an_sho25$LiveDate_Qualifier == "Estimate"), shape = 21, color = "black", fill = "dodgerblue2") + -->
<!--   #geom_errorbarh(aes(xmax = RelYear2 + TA/2, xmin = RelYear - TA/2)) -->
<!--   #coord_cartesian(ylim=c(0, 275), xlim=c(420, 440)) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_ANERR_MEPalldat_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_MEPalldat_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_ANERR_MEPalldat_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->


<!-- ```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"} -->
<!-- #Including the random effect of reef (i.e., sampled population credible interval): -->
<!-- #Marginal effects plot excluding random effects -->
<!-- an_sho25_1 <- plot(conditional_effects(an_sho25_glmm5), plot = FALSE)[[1]] -->
<!-- an_sho25_1b <- plot(conditional_effects(an_sho25_glmm_hist6), plot = FALSE)[[1]] -->

<!-- lowerlab <- c(1688, 1706, 1813, 1933, 1979, 1987, 1991, 1993, 1997, 2014, 2017) -->
<!-- upperlab <- c(1580, 1704, 1757, 1899, 1972, 1982, 1989, 1992, 1995, 2013, 2016, 2019) -->

<!-- an_sho25$RelYear_lab1 <- 1 -->
<!-- for(i in 1:nrow(an_sho25)){  -->
<!--   an_sho25$RelYear_lab1[i] <- as.character(ifelse(an_sho25$Sample_mean_age[i] %in% upperlab, an_sho25$Sample_mean_age[i], "")) -->
<!-- } -->

<!-- an_sho25$RelYear_lab2 <- 1 -->
<!-- for(i in 1:nrow(an_sho25)){  -->
<!--   an_sho25$RelYear_lab2[i] <- as.character(ifelse(an_sho25$Sample_mean_age[i] %in% lowerlab, an_sho25$Sample_mean_age[i], "")) -->
<!-- } -->


<!-- SH_AllDates_GLMM_ANERR_MEP_o25 <- ggplot(an_sho25_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) + -->
<!--   geom_point(data = an_sho25, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!--   geom_ribbon(fill = "grey", alpha = 0.4) + -->
<!--   geom_line(aes(y = estimate__), color = "blue", lwd = 1) + -->
<!--   geom_ribbon(data = an_sho25_1b$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) + -->
<!--   geom_line(data = an_sho25_1b$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) + -->
<!--   geom_text(data = an_sho25, aes(y = 23, label = RelYear_lab1, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) + -->
<!--   geom_text(data = an_sho25, aes(y = 20, label = RelYear_lab2, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) + -->
<!--   theme_bw() + -->
<!--   coord_cartesian(xlim = c(350, 450), ylim = c(20, 150)) -->
<!-- SH_AllDates_GLMM_ANERR_MEP_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_MEP_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_ANERR_MEPrand_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- ```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"} -->
<!-- #Excluding the random effect of reef (i.e., sampled population credible interval): -->
<!-- #Marginal effects plot excluding random effects -->
<!-- an_sho25_2 <- plot(conditional_effects(an_sho25_glmm, re_formula = NA), plot = FALSE)[[1]] -->
<!-- SH_AllDates_GLMM_ANERR_MEPnorand_o25 <- an_sho25_2 + -->
<!--   geom_point(data = an_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_ANERR_MEPnorand_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_MEPnorand_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_ANERR_MEPnorand_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->


<!-- ```{r eval=FALSE, fig.height=50, fig.width=10, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"} -->
<!-- #Individual effects plots: -->
<!-- #Individual effects plots -->
<!-- SH_AllDates_GLMM_ANERR_IEP_o25 <- an_sho25 %>% -->
<!--   group_by(reefIDcrosswalk) %>% -->
<!--   add_fitted_draws(an_sho25_glmm) %>% -->
<!--   ggplot(aes(x = RelYear, y = ShellHeight_mm, color = reefIDcrosswalk)) + -->
<!--   stat_lineribbon(aes(y = .value), size = 1) + -->
<!--   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) + -->
<!--   geom_point(data = an_sho25) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") + -->
<!--   #geom_line(aes(y = .value), linetype = "dashed", color = "black") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   #scale_color_brewer(palette = "Set2") + -->
<!--   theme_bw() + -->
<!--   facet_wrap(~ reefIDcrosswalk, ncol = 3) -->
<!-- SH_AllDates_GLMM_ANERR_IEP_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_IEP_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_ANERR_IEP_o25, -->
<!--        width = 10, -->
<!--        height = 30, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->


###### Shell height 25-75mm

<br>

Including the random effect of reef:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

#Marginal effects plot including random effects

#labs1 <- sort(unique(an_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- c(1580, 1704, 1757, 1899, 1972, 2013) #, 1982, 1989, 1992, 2013, 2016
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))
#labs1 <- labs1[c(-3, -4, -6)]
#labs2 <- sort(unique(an_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- c(1688, 1813, 1933, 1995, 2019) #1706, 1979, 1987, 1991, 1993, 1997, 2014, 2017

set.seed(987)
an_sh25to75_1 <- plot(conditional_effects(an_sh25to75_glmm, re_formula = NULL), plot = FALSE)[[1]]
an_sh25to75_hist_1 <- plot(conditional_effects(an_sh25to75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]

SH_AllDates_GLMM_ANERR_MEPrand_25to75_allYr <- ggplot(an_sh25to75_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = an_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = an_sh25to75_hist_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = an_sh25to75_hist_1$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(an_sh25to75, an_sh25to75$Sample_mean_age %in% labs1), aes(y = 22, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(an_sh25to75, an_sh25to75$Sample_mean_age %in% labs2), aes(y = 20, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  theme(legend.position = "none") +
  coord_cartesian(ylim = c(20, 80))
SH_AllDates_GLMM_ANERR_MEPrand_25to75_allYr

SH_AllDates_GLMM_ANERR_MEPrand_25to75_post1994 <- SH_AllDates_GLMM_ANERR_MEPrand_25to75_allYr +
                                                    coord_cartesian(xlim = c(414, 440)) +
                                                    theme(legend.position = "right")
SH_AllDates_GLMM_ANERR_MEPrand_25to75_post1994

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_MEPrand_25to75_allYr_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_MEPrand_25to75_allYr,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_MEPrand_25to75_post1994_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_MEPrand_25to75_post1994,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):

```{r echo=TRUE, message=FALSE, warning=FALSE, out.width="100%"}

#Marginal effects plot excluding random effects
#labs1 <- sort(unique(an_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- c(1580, 1704, 1757, 1899, 1972, 2013) #, 1982, 1989, 1992, 2013, 2016
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))
#labs1 <- labs1[c(-3, -4, -6)]
#labs2 <- sort(unique(an_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- c(1688, 1813, 1933, 1995, 2019) #1706, 1979, 1987, 1991, 1993, 1997, 2014, 2017

set.seed(654)
an_sh25to75_2 <- plot(conditional_effects(an_sh25to75_glmm, re_formula = NA), plot = FALSE)[[1]]
an_sh25to75_hist_2 <- plot(conditional_effects(an_sh25to75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]

SH_AllDates_GLMM_ANERR_MEPnorand_25to75_allYr <- ggplot(an_sh25to75_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = an_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = an_sh25to75_hist_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = an_sh25to75_hist_2$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(an_sh25to75, an_sh25to75$Sample_mean_age %in% labs1), aes(y = 22, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(an_sh25to75, an_sh25to75$Sample_mean_age %in% labs2), aes(y = 20, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  theme(legend.position = "none") +
  coord_cartesian(ylim = c(20, 80))
SH_AllDates_GLMM_ANERR_MEPnorand_25to75_allYr

SH_AllDates_GLMM_ANERR_MEPnorand_25to75_post1994 <- SH_AllDates_GLMM_ANERR_MEPnorand_25to75_allYr +
                                                    coord_cartesian(xlim = c(414, 440)) +
                                                    theme(legend.position = "right")
SH_AllDates_GLMM_ANERR_MEPnorand_25to75_post1994

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_MEPnorand_25to75_allYr_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_MEPnorand_25to75_allYr,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_MEPnorand_25to75_post1994_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_MEPnorand_25to75_post1994,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:

<br>

Real-time data:

```{r echo=TRUE, fig.height=50, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}

#Individual effects plots
an_sh25to75_rt <- subset(an_sh25to75, an_sh25to75$Sample_mean_age_qualifier != "Estimate")
an_sh25to75_rt[, QuadSize_m2 := droplevels(QuadSize_m2)]

set.seed(987)
SH_AllDates_GLMM_ANERR_IEP_25to75 <- an_sh25to75_rt %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(an_sh25to75_glmm) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = an_sh25to75_rt) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = an_sh25to75_rt, aes(y = 20, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sh25to75, gtmn_sh25to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(an_sh25to75_rt$RelYear2) - 1, max(an_sh25to75_rt$RelYear2) + 1)) +
  scale_y_continuous(limits = c(15, 75)) +
  #theme(legend.position = "none") +
  #labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_ANERR_IEP_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_IEP_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_IEP_25to75,
       width = 10,
       height = 30,
       units = "in",
       dpi = 300)
```

<br><br><br>

Historical data:

```{r echo=TRUE, fig.height=50, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}

#Individual effects plots
labs1 <- sort(unique(an_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- labs1[seq(1, length(labs1), 1)]
labs2 <- sort(unique(an_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- labs2[seq(1, length(labs2), 2)]
labs1 <- setdiff(labs1, labs2)

an_sh25to75_h <- subset(an_sh25to75, an_sh25to75$Sample_mean_age_qualifier == "Estimate")
an_sh25to75_h[, QuadSize_m2 := droplevels(QuadSize_m2)]

set.seed(765)
SH_AllDates_GLMM_ANERR_IEP_25to75_hist <- an_sh25to75_h %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(an_sh25to75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = an_sh25to75_h) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(an_sh25to75_h, an_sh25to75_h$Sample_mean_age %in% labs1), aes(y = 21, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(an_sh25to75_h, an_sh25to75_h$Sample_mean_age %in% labs2), aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(an_sh25to75_h$RelYear2) - 2, max(an_sh25to75_h$RelYear2) + 2)) +
  scale_y_continuous(limits = c(15, 80)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_ANERR_IEP_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_IEP_25to75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_IEP_25to75_hist,
       width = 10,
       height = 30,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Shell height >75mm

<!-- ```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"} -->
<!-- #Comparing the model fit to the real-time monitoring data (filled circles/red trendline) with predicted values for the historical (dead shell) data (open circles/blue trendline). The dead shell sample ages (i.e., the "RelYears") are estimated as the mean median calibrated age from ~5 radiocarbon-dated specimens per sample). Several older samples (i.e., lower RelYear values) are cut out of the plot below so that the modern data and their model fit are visible. -->

<!-- #Marginal effects plot including random effects -->
<!-- SH_AllDates_GLMM_ANERR_MEPlivedat_o75 <- subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate") %>% -->
<!--   data_grid(RelYear, Subtidal) %>% -->
<!--   add_fitted_draws(an_sho75_glmm1, allow_new_levels = TRUE) %>% -->
<!--   ggplot(aes(x = RelYear, y = ShellHeight_mm)) + -->
<!--   stat_lineribbon(aes(y = .value), color = "firebrick1") + -->
<!--   geom_point(data = subset(an_sho75, an_sho75$LiveDate_Qualifier != "Estimate"), shape = 21, color = "black", fill = "firebrick2") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   scale_color_brewer(palette = "Set2") -->
<!-- #SH_AllDates_GLMM_ANERR_MEPrand_o75   -->

<!-- an_sho75_histpred <- subset(an_sho75, an_sho75$LiveDate_Qualifier == "Estimate") %>% -->
<!--   data_grid(RelYear, Subtidal) %>% -->
<!--   add_fitted_draws(an_sho75_glmm1, allow_new_levels = TRUE) -->

<!-- SH_AllDates_GLMM_ANERR_MEPalldat_o75 <- SH_AllDates_GLMM_ANERR_MEPlivedat_o75 + -->
<!--   stat_lineribbon(data = an_sho75_histpred, aes(y = .value), color = "dodgerblue1") + -->
<!--   geom_point(data = subset(an_sho75, an_sho75$LiveDate_Qualifier == "Estimate"), shape = 21, color = "black", fill = "dodgerblue2") + -->
<!--   coord_cartesian(ylim=c(60, 140), xlim=c(390, 440)) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_ANERR_MEPalldat_o75 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_MEPalldat_o75_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_ANERR_MEPalldat_o75, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<br>

Including the random effect of reef (i.e., managed area-wide credible interval):

```{r echo=TRUE, fig.height=6, fig.show="hold", fig.width=10, message=FALSE, warning=FALSE, out.width="50%"}
#Marginal effects plot including random effects
#labs1 <- sort(unique(an_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- c(1580, 1704, 1757, 1899, 1972, 2013) #, 1982, 1989, 1992, 2013, 2016
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))
#labs1 <- labs1[c(-3, -4, -6)]
#labs2 <- sort(unique(an_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- c(1688, 1813, 1933, 1992, 2017) #1706, 1979, 1987, 1991, 1993, 1997, 2014, 2017

set.seed(987)
an_sho75_1 <- plot(conditional_effects(an_sho75_glmm, re_formula = NULL), plot = FALSE)[[1]]
an_sho75_hist_1 <- plot(conditional_effects(an_sho75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]

SH_AllDates_GLMM_ANERR_MEPrand_o75_allYr <- ggplot(an_sho75_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = an_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = an_sho75_hist_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = an_sho75_hist_1$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(an_sho75, an_sho75$Sample_mean_age %in% labs1), aes(y = 71, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(an_sho75, an_sho75$Sample_mean_age %in% labs2), aes(y = 68, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  theme(legend.position = "none") +
  coord_cartesian(ylim = c(70, 250))
SH_AllDates_GLMM_ANERR_MEPrand_o75_allYr

SH_AllDates_GLMM_ANERR_MEPrand_o75_post1994 <- SH_AllDates_GLMM_ANERR_MEPrand_o75_allYr +
                                                  coord_cartesian(xlim = c(414, 440)) +
                                                  theme(legend.position = "right")
SH_AllDates_GLMM_ANERR_MEPrand_o75_post1994

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_MEPrand_o75_allYr_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_MEPrand_o75_allYr,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_MEPrand_o75_post1994_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_MEPrand_o75_post1994,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):

```{r echo=TRUE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#Marginal effects plot excluding random effects
#labs1 <- sort(unique(an_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- c(1580, 1704, 1757, 1899, 1972, 2013) #, 1982, 1989, 1992, 2013, 2016
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))
#labs1 <- labs1[c(-3, -4, -6)]
#labs2 <- sort(unique(an_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- c(1688, 1813, 1933, 1992, 2017) #1706, 1979, 1987, 1991, 1993, 1997, 2014, 2017

set.seed(987)
an_sho75_2 <- plot(conditional_effects(an_sho75_glmm, re_formula = NA), plot = FALSE)[[1]]
an_sho75_hist_2 <- plot(conditional_effects(an_sho75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]

SH_AllDates_GLMM_ANERR_MEPnorand_o75_allYr <- ggplot(an_sho75_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = an_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = an_sho75_hist_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = an_sho75_hist_2$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(an_sho75, an_sho75$Sample_mean_age %in% labs1), aes(y = 71, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(an_sho75, an_sho75$Sample_mean_age %in% labs2), aes(y = 68, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  theme(legend.position = "none") +
  coord_cartesian(ylim = c(70, 250))
SH_AllDates_GLMM_ANERR_MEPnorand_o75_allYr

SH_AllDates_GLMM_ANERR_MEPnorand_o75_post1994 <- SH_AllDates_GLMM_ANERR_MEPnorand_o75_allYr +
                                                  coord_cartesian(xlim = c(414, 440)) +
                                                  theme(legend.position = "right")
SH_AllDates_GLMM_ANERR_MEPnorand_o75_post1994

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_MEPnorand_o75_allYr_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_MEPnorand_o75_allYr,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_MEPnorand_o75_post1994_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_MEPnorand_o75_post1994,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br>

Individual effects plots:

<br>

Real-time data:

```{r echo=TRUE, fig.height=80, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#Individual effects plots

#labs1 <- sort(unique(an_sho75$Sample_mean_age))#[c(TRUE, FALSE)]
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))

an_sho75_rt <- subset(an_sho75, an_sho75$Sample_mean_age_qualifier != "Estimate")

set.seed(987)
SH_AllDates_GLMM_ANERR_IEP_o75 <- an_sho75_rt %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(an_sho75_glmm) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = an_sho75_rt) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = an_sho75_rt, aes(y = 71, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(an_sho75, an_sho75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(an_sho75_rt$RelYear2) - 1, max(an_sho75_rt$RelYear2) + 1)) +
  scale_y_continuous(limits = c(70, 150)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_ANERR_IEP_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_IEP_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_IEP_o75,
       width = 10,
       height = 30,
       units = "in",
       dpi = 300, limitsize = FALSE)
```

<br>

Historical data:

```{r echo=TRUE, fig.height=10, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}

labs1 <- sort(unique(an_sho75$Sample_mean_age))[c(TRUE, FALSE)]
labs2 <- sort(unique(an_sho75$Sample_mean_age))[c(FALSE, TRUE)]
labs1 <- labs1[labs1 != 1972]
labs2 <- labs2[labs2 != 1706]

an_sho75_h <- subset(an_sho75, an_sho75$Sample_mean_age_qualifier == "Estimate")

set.seed(654)
SH_AllDates_GLMM_ANERR_IEP_o75_hist <- an_sho75_h %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(an_sho75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = an_sho75_h) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(an_sho75_h, an_sho75_h$Sample_mean_age %in% labs1), aes(y = 71, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(an_sho75_h, an_sho75_h$Sample_mean_age %in% labs2), aes(y = 67, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(an_sho75, an_sho75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(an_sho75_h$RelYear2) - 15, max(an_sho75_h$RelYear2) + 15)) +
  #scale_y_continuous(limits = c(65, 180)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_ANERR_IEP_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_ANERR_IEP_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_ANERR_IEP_o75_hist,
       width = 10,
       height = 10,
       units = "in",
       dpi = 300, limitsize = FALSE)
```

<!-- <br><br><br> -->

```{r include=FALSE}
# Remove created objects to save memory.
rm(an_sh25to75, an_sh25to75_glmm, 
   an_sh25to75_hist, an_sho75_glmm_hist, 
   SH_AllDates_GLMM_ANERR_PDistandMChains_sh25to75, SH_AllDates_GLMM_ANERR_PDistandMChains_o75,
   SH_AllDates_GLMM_ANERR_PDistandMChains_sh25to75_hist, SH_AllDates_GLMM_ANERR_PDistandMChains_o75_hist,
   SH_AllDates_GLMM_ANERR_PPcheck_sh25to75, SH_AllDates_GLMM_ANERR_PPcheck_o75,
   SH_AllDates_GLMM_ANERR_PPcheck_sh25to75_hist, SH_AllDates_GLMM_ANERR_PPcheck_o75_hist,
   SH_AllDates_GLMM_ANERR_MEPrand_sh25to75, SH_AllDates_GLMM_ANERR_MEPrand_o75,
   SH_AllDates_GLMM_ANERR_MEPnorand_sh25to75, SH_AllDates_GLMM_ANERR_MEPnorand_o75,
   SH_AllDates_GLMM_ANERR_IEP_sh25to75, SH_AllDates_GLMM_ANERR_IEP_o75,
   SH_AllDates_GLMM_ANERR_IEP_sh25to75_hist, SH_AllDates_GLMM_ANERR_IEP_o75_hist
   )

```

<br><br><br>

#### Big Bend Seagrasses_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}
# 
bbs_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Big Bend Seagrasses_Natural")
bbs_sho25[, QuadSize_m2 := as.factor(QuadSize_m2)]
bbs_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
bbs_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
bbs_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
bbs_sho25[ShellHeight_mm < 75, SizeClass := "25to75mm"]
bbs_sho25[ShellHeight_mm >= 75, SizeClass := "o75mm"]
saveRDS(bbs_sho25, here::here(paste0('GLMMs/AllDates/Data/bbs_sho25_', Sys.Date(), '.rds')))
# 
# bbs_sho25_glmm <- brm(formula = ShellHeight_mm ~ me(RelYear, Sample_age_stdev) + (1 + RelYear|reefIDcrosswalk), data = bbs_sho25, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "identity"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# bbs_sho25_glmm <- add_criterion(bbs_sho25_glmm, "loo")
# 
# saveRDS(bbs_sho25_glmm, here::here(paste0('GLMMs/AllDates/bbs_sho25_glmm.rds')))

#Intercept model converged and is significant.
bbs_sho25c_glmm_hist1 <- brm(formula = ShellHeight_mm ~ 1, data = bbs_sho25, family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/bbs_sho25c_glmm_hist1.rds")
bbs_sho25c_glmm_hist1 <- add_criterion(bbs_sho25c_glmm_hist1, "loo")

#Model converged, RelYear was not significant.
bbs_sho25c_glmm_hist2 <- brm(formula = ShellHeight_mm ~ RelYear2, data = bbs_sho25, family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/bbs_sho25c_glmm_hist2.rds")
bbs_sho25c_glmm_hist2 <- add_criterion(bbs_sho25c_glmm_hist2, "loo")

#Model converged, RelYear was not significant.
bbs_sho25c_glmm_hist2b <- brm(formula = ShellHeight_mm ~ me(RelYear2, Sample_age_stdev), data = bbs_sho25, family = gaussian, prior = set_prior("normal(126, 75)", class = "b", coef = "meRelYear2Sample_age_stdev"), cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/bbs_sho25c_glmm_hist2b.rds")
bbs_sho25c_glmm_hist2b <- add_criterion(bbs_sho25c_glmm_hist2b, "loo")

#Model converged, SizeClass was significant.
bbs_sho25c_glmm_hist3 <- brm(formula = ShellHeight_mm ~ SizeClass, data = bbs_sho25, family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/bbs_sho25c_glmm_hist3.rds")
bbs_sho25c_glmm_hist3 <- add_criterion(bbs_sho25c_glmm_hist3, "loo")

#Model did not converge, but was pretty close (all Rhats < 2).
bbs_sho25c_glmm_hist4 <- brm(formula = ShellHeight_mm ~ me(RelYear2, Sample_age_stdev) + SizeClass + me(RelYear2, Sample_age_stdev):SizeClass, data = bbs_sho25, family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), inits = 30, file = "GLMMs/AllDates/bbs_sho25c_glmm_hist4.rds")
bbs_sho25c_glmm_hist4 <- add_criterion(bbs_sho25c_glmm_hist4, "loo")

#Trying the previous model with some priors. First time almost converged (all Rhats < 1.2), so I tried again with limits on Shellheight_mm and 1000 more iterations. Also increased max_treedepth because many iterations hit the prior max of 15.
bbs_sho25c_glmm_hist5 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ me(RelYear2, Sample_age_stdev) + SizeClass + me(RelYear2, Sample_age_stdev):SizeClass, data = bbs_sho25, family = gaussian, prior = c(set_prior("normal(126, 40)", class = "meanme", coef = "meRelYear2"), set_prior("normal(49, 50)", class = "sdme", coef = "meRelYear2")), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 20), iter = 4000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(3), inits = 0, file = "GLMMs/AllDates/bbs_sho25c_glmm_hist5.rds")
bbs_sho25c_glmm_hist5 <- add_criterion(bbs_sho25c_glmm_hist5, "loo")

#Did not run this model, moved on to the models for each size class in the interest of time.
bbs_sho25c_glmm_hist6 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + SizeClass + me(RelYear2, Sample_age_stdev):SizeClass, data = bbs_sho25, family = gaussian, prior = c(set_prior("normal(126, 40)", class = "meanme", coef = "meRelYear2"), set_prior("normal(49, 50)", class = "sdme", coef = "meRelYear2")), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 20), iter = 4000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(3), inits = 0, file = "GLMMs/AllDates/bbs_sho25c_glmm_hist6.rds")
bbs_sho25c_glmm_hist6 <- add_criterion(bbs_sho25c_glmm_hist6, "loo")


```

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}
# 
bbs_sh25to75 <- subset(bbs_sho25, bbs_sho25$ShellHeight_mm < 75)
saveRDS(bbs_sh25to75, here::here(paste0('GLMMs/AllDates/Data/bbs_sh25to75_', Sys.Date(), '.rds')))
# 
# bbs_sho25_glmm <- brm(formula = ShellHeight_mm ~ me(RelYear, Sample_age_stdev) + (1 + RelYear|reefIDcrosswalk), data = bbs_sho25, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "identity"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# bbs_sho25_glmm <- add_criterion(bbs_sho25_glmm, "loo")
# 
# saveRDS(bbs_sho25_glmm, here::here(paste0('GLMMs/AllDates/bbs_sho25_glmm.rds')))

#Model converged, intercept significant.
bbs_sh25to75_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ 1, data = bbs_sh25to75, family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, inits = 30, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/bbs_sh25to75_glmm_hist1.rds")
bbs_sh25to75_glmm_hist1 <- add_criterion(bbs_sh25to75_glmm_hist1, "loo")

#Model did not converge, but came close (Rhats < 1.2).
bbs_sh25to75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = bbs_sh25to75, family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/bbs_sh25to75_glmm_hist2.rds")
bbs_sh25to75_glmm_hist2 <- add_criterion(bbs_sh25to75_glmm_hist2, "loo")

#Model converged, RelYear term was significant.
bbs_sh25to75_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = bbs_sh25to75, family = gaussian, prior = c(set_prior("normal(125.4, 80)", class = "meanme"), set_prior("normal(49.59, 100)", class = "sdme"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/bbs_sh25to75_glmm_hist3.rds")
bbs_sh25to75_glmm_hist3 <- add_criterion(bbs_sh25to75_glmm_hist3, "loo")

#Model converged, RelYear term was significant.
bbs_sh25to75_glmm_hist4 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) | reefIDcrosswalk), data = bbs_sh25to75, family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/bbs_sh25to75_glmm_hist4.rds")
bbs_sh25to75_glmm_hist4 <- add_criterion(bbs_sh25to75_glmm_hist4, "loo")

#GLMM 2 was the best fit, but it did not completely converge and did not include reefID. GLMM 3 was the second best fit and includes reefID.
loo_compare(bbs_sh25to75_glmm_hist2, bbs_sh25to75_glmm_hist3, bbs_sh25to75_glmm_hist4)

```

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}
#See "SEACAR_Oyster_Analyses_SecondaryWorkingVersion.rmd" for the o75 models.
bbs_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Big Bend Seagrasses_Natural")
bbs_sho75[, QuadSize_m2 := as.numeric(QuadSize_m2)]
bbs_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
#bbs_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
bbs_sho75[, RelYear := Sample_mean_age - min(Sample_mean_age)]
saveRDS(bbs_sho75, here::here(paste0('GLMMs/AllDates/Data/bbs_sho75_', Sys.Date(), '.rds')))

bbs_sho75_glmm <- brm(formula = ShellHeight_mm ~ me(RelYear, Sample_age_stdev) + (1 + RelYear|reefIDcrosswalk), data = bbs_sho75, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "identity"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
bbs_sho75_glmm <- add_criterion(bbs_sho75_glmm, "loo")

saveRDS(bbs_sho75_glmm, here::here('GLMMs/AllDates/bbs_sho75_glmm.rds'))
```

```{r message=FALSE, warning=FALSE, include=FALSE}
bbs_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Big Bend Seagrasses_Natural")
bbs_sho25[, QuadSize_m2 := as.factor(QuadSize_m2)]
bbs_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
bbs_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
bbs_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
bbs_sho25[ShellHeight_mm < 75, SizeClass := "25to75mm"]
bbs_sho25[ShellHeight_mm >= 75, SizeClass := "o75mm"]
saveRDS(bbs_sho25, here::here(paste0('GLMMs/AllDates/Data/bbs_sho25_', Sys.Date(), '.rds')))

#bbs_sho25_glmm <- readRDS(here::here('GLMMs/AllDates/bbs_sho25_glmm.rds'))

bbs_sh25to75 <- subset(bbs_sho25, bbs_sho25$ShellHeight_mm < 75)
saveRDS(bbs_sh25to75, here::here(paste0('GLMMs/AllDates/Data/bbs_sh25to75_', Sys.Date(), '.rds')))

#No modern data
#bbs_sh25to75_glmm <- readRDS(here::here('GLMMs/AllDates/bbs_sh25to75_glmm?.rds'))
bbs_sh25to75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/bbs_sh25to75_glmm_hist3.rds'))

bbs_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Big Bend Seagrasses_Natural")
bbs_sho75[, QuadSize_m2 := as.numeric(QuadSize_m2)]
bbs_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
bbs_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
bbs_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(bbs_sho75, here::here(paste0('GLMMs/AllDates/Data/bbs_sho75_', Sys.Date(), '.rds')))

#No modern data
#bbs_sho75_glmm <- readRDS(here::here('GLMMs/AllDates/bbs_sho75_glmm?.rds'))
bbs_sho75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/bbs_sho75_glmm_hist3.rds'))

```

##### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

bbs_sho25[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
bbs_sho25[, SampleDay := day(SampleDate)]

if(length(subset(bbs_sho25, bbs_sho25$Sample_mean_age_qualifier == "Exact")$ShellHeight_mm) > 0){
  sh_t <- copy(bbs_sho25[0, ])
  sh_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
  for(i in unique(as.numeric(bbs_sho25$Month))){
    mo <- subset(bbs_sho25, as.numeric(bbs_sho25$Month) == i)
    ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
           ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                  ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                         ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                                ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                       ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                              ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                     ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                            ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                   ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                          ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
    sh_t <- rbind(mo, sh_t)
  }
  
  monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))
  
  #Create the sampling dates correspondence plot
  SampleDatesPlot <- ggplot(subset(sh_t, sh_t$LiveDate_Qualifier == "Exact"), aes(x = DayNum, y = as.factor(ProgramID), color = Year, shape = Season)) +
                        geom_point(size = 3) +
                        geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                        geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                        xlim(1,365) +
                        scale_x_continuous(breaks = NULL) +
                        coord_cartesian(xlim = c(1, 366)) +
                        theme_bw()+labs(x = "Sample Date", y = "Program ID")
  SampleDatesPlot
  
  #Remove the objects after the plot is done.
  rm(sh_t, monthnames, SampleDatesPlot)

} else{
  
  print("There are no real-time data for this managed area.")
  
}

```

<br><br><br>

##### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_specimens = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for size class 25-75mm first.
sh25to75_status <- subset(bbs_sh25to75, bbs_sh25to75$Sample_mean_age %in% StatusYears)
sh25to75_status[, `:=` (Indicator = "Size Class", 
                        SizeClass = "25-75mm", 
                        Year = as.numeric(Sample_mean_age), 
                        n_reefs = length(unique(ReefIdentifier)),
                        n_programs = length(unique(ProgramID)),
                        ProgIDs = list(unique(ProgramID)),
                        n_specimens = length(ShellHeight_mm),
                        Median = median(ShellHeight_mm),
                        Mean = round(mean(ShellHeight_mm), digits = 2),
                        SD = round(sd(ShellHeight_mm), digits = 2), 
                        Min. = min(ShellHeight_mm),
                        Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sh25to75_status <- unique(sh25to75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sh25to75_status <- sh25to75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sh25to75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sh25to75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = "25-75mm",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sh25to75_status <- rbind(sh25to75_status, MissingYr_i)
  }
}

#Build status table for size class >75mm next.
sho75_status <- subset(bbs_sho75, bbs_sho75$Sample_mean_age %in% StatusYears)
sho75_status[, `:=` (Indicator = "Size Class", 
                     SizeClass = ">75mm", 
                     Year = as.numeric(Sample_mean_age), 
                     n_reefs = length(unique(ReefIdentifier)),
                     n_programs = length(unique(ProgramID)),
                     ProgIDs = list(unique(ProgramID)),
                     n_specimens = length(ShellHeight_mm),
                     Median = median(ShellHeight_mm),
                     Mean = round(mean(ShellHeight_mm), digits = 2),
                     SD = round(sd(ShellHeight_mm), digits = 2), 
                     Min. = min(ShellHeight_mm),
                     Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sho75_status <- unique(sho75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sho75_status <- sho75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sho75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sho75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = ">75mm",
                              Year = i,
                              n_reefs = ifelse(sh25to75_status[Year == i, n_reefs] > 0, sh25to75_status[Year == i, n_reefs], 0),
                              n_programs = ifelse(sh25to75_status[Year == i, n_programs] > 0, sh25to75_status[Year == i, n_programs], 0),
                              ProgIDs = ifelse(!is.na(sh25to75_status[Year == i, ProgIDs]), sh25to75_status[Year == i, ProgIDs], NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sho75_status <- rbind(sho75_status, MissingYr_i)
  }
}

#Merge individual size class tables and set row order
Status <- rbind(Status, sh25to75_status)
Status <- rbind(Status, sho75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) %>%
  kable_styling() %>%
  row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, sh25to75_status, MissingYr_i, sho75_status)
```

<br><br><br>

##### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(bbs_sho25, aes(x = RelYear, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() #+
  #theme(legend.position = "none")

ggplot(bbs_sho25, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() #+
  #theme(legend.position = "none")

```

##### Model Output {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- summary(bbs_sho25_glmm) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height 25-75mm

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(bbs_sh25to75_glmm_hist)
```

<br><br><br>

###### Shell height >75mm

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(bbs_sho75_glmm_hist)
```

<br><br><br>

##### Diagnostic Plots {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- Posterior distributions and Markov chains: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_BBS_PDistandMChains_o25 <- plot(bbs_sho25_glmm) -->
<!-- SH_AllDates_GLMM_BBS_PDistandMChains_o25 -->

<!-- len <- length(SH_AllDates_GLMM_BBS_PDistandMChains_o25) -->
<!-- for(i in 1:len){ -->
<!--   jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_PDistandMChains_o25_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300) -->
<!--   print(SH_AllDates_GLMM_BBS_PDistandMChains_o25[i]) -->
<!--   dev.off() -->
<!-- } -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- Posterior predictive check plot: -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_BBS_PPcheck_o25 <- pp_check(bbs_sho25_glmm) -->
<!-- SH_AllDates_GLMM_BBS_PPcheck_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_PPcheck_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_BBS_PPcheck_o25, -->
<!--        width = 4, -->
<!--        height = 3, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height 25-75mm

Posterior distributions and Markov chains:

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_BBS_PDistandMChains_25to75_hist <- plot(bbs_sh25to75_glmm_hist)
SH_AllDates_GLMM_BBS_PDistandMChains_25to75_hist

len <- length(SH_AllDates_GLMM_BBS_PDistandMChains_25to75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plotsSH_AllDates_GLMM_BBS_PDistandMChains_25to75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_BBS_PDistandMChains_25to75_hist[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_BBS_PPcheck_25to75_hist <- tryCatch(pp_check(bbs_sh25to75_glmm_hist),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_BBS_PPcheck_25to75_hist) == TRUE){
    SH_AllDates_GLMM_BBS_PPcheck_25to75_hist <- tryCatch(pp_check(bbs_sh25to75_glmm_hist), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_BBS_PPcheck_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_PPcheck_25to75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_BBS_PPcheck_25to75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Shell height >75mm

Posterior distributions and Markov chains:

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_BBS_PDistandMChains_o75_hist <- plot(bbs_sho75_glmm_hist)
SH_AllDates_GLMM_BBS_PDistandMChains_o75_hist

len <- length(SH_AllDates_GLMM_BBS_PDistandMChains_o75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plotsSH_AllDates_GLMM_BBS_PDistandMChains_o75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_BBS_PDistandMChains_o75_hist[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_BBS_PPcheck_o75_hist <- tryCatch(pp_check(bbs_sho75_glmm_hist),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_BBS_PPcheck_o75_hist) == TRUE){
    SH_AllDates_GLMM_BBS_PPcheck_o75_hist <- tryCatch(pp_check(bbs_sho75_glmm_hist), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_BBS_PPcheck_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_PPcheck_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_BBS_PPcheck_o75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Marginal Effects Plots {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- Including the random effect of reef (i.e., managed area-wide credible interval): -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Marginal effects plot including random effects -->
<!-- bbs_sho25_1 <- plot(conditional_effects(bbs_sho25_glmm, re_formula = NULL), plot = FALSE)[[1]] -->
<!-- SH_AllDates_GLMM_BBS_MEPrand_o25 <- bbs_sho25_1 + -->
<!--   geom_point(data = bbs_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_BBS_MEPrand_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_MEPrand_o25", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_BBS_MEPrand_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- Excluding the random effect of reef (i.e., sampled population credible interval): -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Marginal effects plot excluding random effects -->
<!-- bbs_sho25_2 <- plot(conditional_effects(bbs_sho25_glmm, re_formula = NA), plot = FALSE)[[1]] -->
<!-- SH_AllDates_GLMM_BBS_MEPnorand_o25 <- bbs_sho25_2 + -->
<!--   geom_point(data = bbs_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_BBS_MEPnorand_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_MEPnorand_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_BBS_MEPnorand_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- Individual effects plots: -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Individual effects plots -->
<!-- SH_AllDates_GLMM_BBS_IEP_o25 <- bbs_sho25 %>% -->
<!--   group_by(reefIDcrosswalk) %>% -->
<!--   add_fitted_draws(bbs_sho25_glmm) %>% -->
<!--   ggplot(aes(x = RelYear, y = ShellHeight_mm, color = reefIDcrosswalk)) + -->
<!--   stat_lineribbon(aes(y = .value), size = 1) + -->
<!--   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) + -->
<!--   geom_point(data = bbs_sho25) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") + -->
<!--   #geom_line(aes(y = .value), linetype = "dashed", color = "black") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   #scale_color_brewer(palette = "Set2") + -->
<!--   theme_bw() + -->
<!--   facet_wrap(~ reefIDcrosswalk, ncol = 3) -->
<!-- SH_AllDates_GLMM_BBS_IEP_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_IEP_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_BBS_IEP_o25, -->
<!--        width = 10, -->
<!--        height = 30, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height 25-75mm

<br>

Including the random effect of reef (i.e., managed area-wide credible interval):

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
labs1 <- sort(unique(bbs_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- labs1[seq(1, length(labs1), 2)]
labs2 <- sort(unique(bbs_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- labs2[seq(1, length(labs2), 2)]

set.seed(987)
#bbs_sh25to75_1 <- plot(conditional_effects(bbs_sh25to75_glmm, re_formula = NULL), plot = FALSE)[[1]]
bbs_sh25to75_hist_1 <- plot(conditional_effects(bbs_sh25to75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]

SH_AllDates_GLMM_BBS_MEPrand_25to75 <- ggplot() + #bbs_sh25to75_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = bbs_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  #geom_ribbon(fill = "grey", alpha = 0.4) +
  #geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = bbs_sh25to75_hist_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = bbs_sh25to75_hist_1$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(bbs_sh25to75, bbs_sh25to75$Sample_mean_age %in% labs1), aes(y = 22, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(bbs_sh25to75, bbs_sh25to75$Sample_mean_age %in% labs2), aes(y = 20, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(19, 80))
SH_AllDates_GLMM_BBS_MEPrand_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_MEPrand_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_BBS_MEPrand_25to75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
labs1 <- sort(unique(bbs_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- labs1[seq(1, length(labs1), 2)]
labs2 <- sort(unique(bbs_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- labs2[seq(1, length(labs2), 2)]

set.seed(876)
#bbs_sh25to75_2 <- plot(conditional_effects(bbs_sh25to75_glmm, re_formula = NA), plot = FALSE)[[1]]
bbs_sh25to75_hist_2 <- plot(conditional_effects(bbs_sh25to75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]

SH_AllDates_GLMM_BBS_MEPnorand_25to75 <- ggplot() + #bbs_sh25to75_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = bbs_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  #geom_ribbon(fill = "grey", alpha = 0.4) +
  #geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = bbs_sh25to75_hist_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = bbs_sh25to75_hist_2$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(bbs_sh25to75, bbs_sh25to75$Sample_mean_age %in% labs1), aes(y = 22, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(bbs_sh25to75, bbs_sh25to75$Sample_mean_age %in% labs2), aes(y = 20, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(19, 80))
SH_AllDates_GLMM_BBS_MEPnorand_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_MEPnorand_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_BBS_MEPnorand_25to75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br>

Individual effects plots:

<!-- <br> -->

<!-- Real-time data: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"} -->
<!-- #Individual effects plots -->

<!-- #labs1 <- sort(unique(bbs_sh25to75$Sample_mebbs_age))#[c(TRUE, FALSE)] -->
<!-- #labs1 <- labs1[seq(1, length(labs1), 4)] -->
<!-- #labs1 <- append(labs1, c(1954)) -->

<!-- bbs_sh25to75_rt <- subset(bbs_sh25to75, bbs_sh25to75$Sample_mebbs_age_qualifier != "Estimate") -->

<!-- set.seed(987) -->
<!-- SH_AllDates_GLMM_BBS_IEP_25to75 <- bbs_sh25to75_rt %>% -->
<!--   group_by(reefIDcrosswalk) %>% -->
<!--   add_fitted_draws(bbs_sh25to75_glmm) %>% -->
<!--   ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) + -->
<!--   stat_lineribbon(aes(y = .value), size = 1) + -->
<!--   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) + -->
<!--   geom_point(data = bbs_sh25to75_rt) + #aes(fill = Region.y), shape = 21, color = "black") + -->
<!--   #geom_line(aes(y = .value), linetype = "dashed", color = "black") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   #scale_color_brewer(palette = "Set2") + -->
<!--   geom_text(data = bbs_sh25to75_rt, aes(y = 71, label = Sample_mebbs_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) + -->
<!--   #geom_text(data = subset(bbs_sh25to75, bbs_sh25to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) + -->
<!--   theme_bw() + theme(axis.line = element_line()) + -->
<!--   scale_x_continuous(limits = c(min(bbs_sh25to75_rt$RelYear2) - 1, max(bbs_sh25to75_rt$RelYear2) + 1)) + -->
<!--   scale_y_continuous(limits = c(70, 150)) + -->
<!--   #theme(legend.position = "none") + -->
<!--   labs(color = "Reef ID", fill = "Credible Interval") + -->
<!--   facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free") -->
<!-- SH_AllDates_GLMM_BBS_IEP_25to75 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_IEP_25to75_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_BBS_IEP_25to75, -->
<!--        width = 10, -->
<!--        height = 30, -->
<!--        units = "in", -->
<!--        dpi = 300, limitsize = FALSE) -->
<!-- ``` -->

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=10, fig.width=10, out.width="100%"}

labs1 <- sort(unique(bbs_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs2 <- sort(unique(bbs_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]
labs1 <- labs1[seq(1, length(labs1), 2)]
labs2 <- labs2[seq(1, length(labs2), 2)]
#labs1 <- labs1[labs1 != 1972]
#labs2 <- labs2[labs2 != 1706]

bbs_sh25to75_h <- subset(bbs_sh25to75, bbs_sh25to75$Sample_mean_age_qualifier == "Estimate")

set.seed(654)
SH_AllDates_GLMM_BBS_IEP_25to75_hist <- bbs_sh25to75_h %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(bbs_sh25to75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = bbs_sh25to75_h) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(bbs_sh25to75_h, bbs_sh25to75_h$Sample_mean_age %in% labs1), aes(y = 22, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(bbs_sh25to75_h, bbs_sh25to75_h$Sample_mean_age %in% labs2), aes(y = 20, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(bbs_sh25to75, bbs_sh25to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  #scale_x_continuous(limits = c(min(bbs_sh25to75_h$RelYear2) - 15, max(bbs_sh25to75_h$RelYear2) + 15)) +
  #scale_y_continuous(limits = c(65, 500)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")

#I'm not sure why the stat_lineribbons are not showing.
SH_AllDates_GLMM_BBS_IEP_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_IEP_25to75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_BBS_IEP_25to75_hist,
       width = 10,
       height = 10,
       units = "in",
       dpi = 300, limitsize = FALSE)
```

<br><br><br>

###### Shell height >75mm

<br>

Including the random effect of reef (i.e., managed area-wide credible interval):

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
labs1 <- sort(unique(bbs_sho75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- labs1[seq(1, length(labs1), 2)]
labs2 <- sort(unique(bbs_sho75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- labs2[seq(1, length(labs2), 2)]

set.seed(987)
#bbs_sho75_1 <- plot(conditional_effects(bbs_sho75_glmm, re_formula = NULL), plot = FALSE)[[1]]
bbs_sho75_hist_1 <- plot(conditional_effects(bbs_sho75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]

SH_AllDates_GLMM_BBS_MEPrand_o75 <- ggplot() + #bbs_sho75_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = bbs_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  #geom_ribbon(fill = "grey", alpha = 0.4) +
  #geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = bbs_sho75_hist_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = bbs_sho75_hist_1$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(bbs_sho75, bbs_sho75$Sample_mean_age %in% labs1), aes(y = 71, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(bbs_sho75, bbs_sho75$Sample_mean_age %in% labs2), aes(y = 68, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  theme(legend.position = "none") +
  coord_cartesian(ylim = c(70, 250))
SH_AllDates_GLMM_BBS_MEPrand_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_MEPrand_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_BBS_MEPrand_o75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
labs1 <- sort(unique(bbs_sho75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- labs1[seq(1, length(labs1), 2)]
labs2 <- sort(unique(bbs_sho75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- labs2[seq(1, length(labs2), 2)]

set.seed(876)
#bbs_sho75_2 <- plot(conditional_effects(bbs_sho75_glmm, re_formula = NA), plot = FALSE)[[1]]
bbs_sho75_hist_2 <- plot(conditional_effects(bbs_sho75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]

SH_AllDates_GLMM_BBS_MEPnorand_o75 <- ggplot() + #bbs_sho75_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = bbs_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  #geom_ribbon(fill = "grey", alpha = 0.4) +
  #geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = bbs_sho75_hist_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = bbs_sho75_hist_2$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(bbs_sho75, bbs_sho75$Sample_mean_age %in% labs1), aes(y = 71, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(bbs_sho75, bbs_sho75$Sample_mean_age %in% labs2), aes(y = 68, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  theme(legend.position = "none") +
  coord_cartesian(ylim = c(70, 250))
SH_AllDates_GLMM_BBS_MEPnorand_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_MEPnorand_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_BBS_MEPnorand_o75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br>

Individual effects plots:

<!-- <br> -->

<!-- Real-time data: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"} -->
<!-- #Individual effects plots -->

<!-- #labs1 <- sort(unique(bbs_sho75$Sample_mebbs_age))#[c(TRUE, FALSE)] -->
<!-- #labs1 <- labs1[seq(1, length(labs1), 4)] -->
<!-- #labs1 <- append(labs1, c(1954)) -->

<!-- bbs_sho75_rt <- subset(bbs_sho75, bbs_sho75$Sample_mebbs_age_qualifier != "Estimate") -->

<!-- set.seed(987) -->
<!-- SH_AllDates_GLMM_BBS_IEP_o75 <- bbs_sho75_rt %>% -->
<!--   group_by(reefIDcrosswalk) %>% -->
<!--   add_fitted_draws(bbs_sho75_glmm) %>% -->
<!--   ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) + -->
<!--   stat_lineribbon(aes(y = .value), size = 1) + -->
<!--   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) + -->
<!--   geom_point(data = bbs_sho75_rt) + #aes(fill = Region.y), shape = 21, color = "black") + -->
<!--   #geom_line(aes(y = .value), linetype = "dashed", color = "black") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   #scale_color_brewer(palette = "Set2") + -->
<!--   geom_text(data = bbs_sho75_rt, aes(y = 71, label = Sample_mebbs_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) + -->
<!--   #geom_text(data = subset(bbs_sho75, bbs_sho75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) + -->
<!--   theme_bw() + theme(axis.line = element_line()) + -->
<!--   scale_x_continuous(limits = c(min(bbs_sho75_rt$RelYear2) - 1, max(bbs_sho75_rt$RelYear2) + 1)) + -->
<!--   scale_y_continuous(limits = c(70, 150)) + -->
<!--   #theme(legend.position = "none") + -->
<!--   labs(color = "Reef ID", fill = "Credible Interval") + -->
<!--   facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free") -->
<!-- SH_AllDates_GLMM_BBS_IEP_o75 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_IEP_o75_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_BBS_IEP_o75, -->
<!--        width = 10, -->
<!--        height = 30, -->
<!--        units = "in", -->
<!--        dpi = 300, limitsize = FALSE) -->
<!-- ``` -->

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=10, fig.width=10, out.width="100%"}

labs1 <- sort(unique(bbs_sho75$Sample_mean_age))[c(TRUE, FALSE)]
labs2 <- sort(unique(bbs_sho75$Sample_mean_age))[c(FALSE, TRUE)]
labs1 <- labs1[seq(1, length(labs1), 2)]
labs2 <- labs2[seq(1, length(labs2), 2)]
#labs1 <- labs1[labs1 != 1972]
#labs2 <- labs2[labs2 != 1706]

bbs_sho75_h <- subset(bbs_sho75, bbs_sho75$Sample_mean_age_qualifier == "Estimate")

set.seed(654)
SH_AllDates_GLMM_BBS_IEP_o75_hist <- bbs_sho75_h %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(bbs_sho75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = bbs_sho75_h) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(bbs_sho75_h, bbs_sho75_h$Sample_mean_age %in% labs1), aes(y = 71, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(bbs_sho75_h, bbs_sho75_h$Sample_mean_age %in% labs2), aes(y = 67, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(bbs_sho75, bbs_sho75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(bbs_sho75_h$RelYear2) - 15, max(bbs_sho75_h$RelYear2) + 15)) +
  #scale_y_continuous(limits = c(65, 500)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")

#Note I tried several combinations of x and y axes limits, but could not get the geom_lineribbons to show on the plots; I'm not sure how to fix it.
SH_AllDates_GLMM_BBS_IEP_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_BBS_IEP_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_BBS_IEP_o75_hist,
       width = 10,
       height = 10,
       units = "in",
       dpi = 300, limitsize = FALSE)
```

```{r include=FALSE}
# Remove created objects to save memory.
rm(bbs_sho25, bbs_sh25to75_glmm_hist, 
   bbs_sho75, bbs_sho75_glmm_hist, 
   SH_AllDates_GLMM_BBS_PDistandMChains_25to75_hist, SH_AllDates_GLMM_BBS_PDistandMChains_o75_hist,
   SH_AllDates_GLMM_BBS_PPcheck_25to75_hist, SH_AllDates_GLMM_BBS_PPcheck_o75_hist,
   SH_AllDates_GLMM_BBS_MEPrand_25to75_hist, SH_AllDates_GLMM_BBS_MEPrand_o75_hist,
   SH_AllDates_GLMM_BBS_MEPnorand_25to75_hist, SH_AllDates_GLMM_BBS_MEPnorand_o75_hist,
   SH_AllDates_GLMM_BBS_IEP_25to75_hist, SH_AllDates_GLMM_BBS_IEP_o75_hist
   )

```

<br><br><br>

#### Estero Bay_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

eb_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Estero Bay_Natural")
eb_sho25[, QuadSize_m2 := as.factor(QuadSize_m2)]
eb_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
eb_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
eb_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
eb_sho25[ShellHeight_mm < 75, SizeClass := "25to75mm"]
eb_sho25[ShellHeight_mm >= 75, SizeClass := "o75mm"]
saveRDS(eb_sho25, here::here(paste0('GLMMs/AllDates/Data/eb_sho25_', Sys.Date(), '.rds')))

# eb_sho25_glmm <- brm(formula = ShellHeight_mm ~ RelYear + QuadSize_m2 + LiveDate_Qualifier + (1 + RelYear|reefIDcrosswalk), data = eb_sho25, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# eb_sho25_glmm <- add_criterion(eb_sho25_glmm, "loo")

ggplot(eb_sho25, aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw()

ggplot(eb_sho25, aes(x = RelYear2, y = ShellHeight_mm, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

ggplot(eb_sho25, aes(x = RelYear2, y = QuadSize_m2, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

#Little overlap in quad sizes in any particular year; no replication of the 1m2 quad size by year and only one replicate year for 0.33m2.
ggplot(subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = QuadSize_m2, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

ggplot(subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = NumberMeasured_n, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

#Model converged, intercept significant.
eb_sho25_glmm1 <- brm(formula = ShellHeight_mm ~ 1, data = subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho25_glmm1.rds")
eb_sho25_glmm1 <- add_criterion(eb_sho25_glmm1, "loo")

#Model converged, RelYear not significant.
eb_sho25_glmm2 <- brm(formula = ShellHeight_mm ~ RelYear2, data = subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho25_glmm2.rds")
eb_sho25_glmm2 <- add_criterion(eb_sho25_glmm2, "loo")

#Model converged, QuadSize_m2 significant.
eb_sho25_glmm3 <- brm(formula = ShellHeight_mm ~ QuadSize_m2, data = subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho25_glmm3.rds")
eb_sho25_glmm3 <- add_criterion(eb_sho25_glmm3, "loo")

#Model converged.
eb_sho25_glmm4 <- brm(formula = ShellHeight_mm ~ RelYear2 + QuadSize_m2 + (1 | reefIDcrosswalk), data = subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho25_glmm4.rds")
eb_sho25_glmm4 <- add_criterion(eb_sho25_glmm4, "loo")

#Model converged.
eb_sho25_glmm5 <- brm(formula = ShellHeight_mm ~ RelYear2 + QuadSize_m2 + (0 + RelYear2 | reefIDcrosswalk), data = subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho25_glmm5.rds")
eb_sho25_glmm5 <- add_criterion(eb_sho25_glmm5, "loo")

#Model converged, size class is significant.
eb_sho25_glmm6 <- brm(formula = ShellHeight_mm ~ SizeClass, data = subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho25_glmm6.rds")
eb_sho25_glmm6 <- add_criterion(eb_sho25_glmm6, "loo")

#Model converged.
eb_sho25_glmm7 <- brm(formula = ShellHeight_mm ~ RelYear2 + SizeClass + QuadSize_m2 + RelYear2:SizeClass + (1 | reefIDcrosswalk), data = subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho25_glmm7.rds")
eb_sho25_glmm7 <- add_criterion(eb_sho25_glmm7, "loo")

#Model converged.
eb_sho25_glmm8 <- brm(formula = ShellHeight_mm ~ RelYear2 + SizeClass + QuadSize_m2 + RelYear2:SizeClass + (0 + RelYear2 | reefIDcrosswalk), data = subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho25_glmm8.rds")
eb_sho25_glmm8 <- add_criterion(eb_sho25_glmm8, "loo")

#GLMM 8 is the best fit to the data.
loo_compare(eb_sho25_glmm1, eb_sho25_glmm2, eb_sho25_glmm3, eb_sho25_glmm4, eb_sho25_glmm5, eb_sho25_glmm6, eb_sho25_glmm7, eb_sho25_glmm8)


#Model converged, intercept significant.
eb_sho25_glmm_hist1 <- brm(formula = ShellHeight_mm ~ 1, data = subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho25_glmm_hist1.rds")
eb_sho25_glmm_hist1 <- add_criterion(eb_sho25_glmm_hist1, "loo")

#Model did not converge, so trying again with added priors for meanme and sdme. Model did not converge, so increased adapt_delta, iterations, and narrowed sigma of priors, and tried again. Model still did not converge.
eb_sho25_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(66.17, 25)", class = "meanme"), set_prior("normal(16.48, 50)", class = "sdme")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho25_glmm_hist2.rds")
eb_sho25_glmm_hist2 <- add_criterion(eb_sho25_glmm_hist2, "loo")

#Model converged, SizeClass significant
eb_sho25_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ SizeClass, data = subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 3, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho25_glmm_hist3.rds")
eb_sho25_glmm_hist3 <- add_criterion(eb_sho25_glmm_hist3, "loo")

#Model converged, but the conditional_effects plot doesn't make much sense when plotted with the data.
eb_sho25_glmm_hist4 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + SizeClass + me(RelYear2, Sample_age_stdev, gr = QuadIdentifier):SizeClass, data = subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 3, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho25_glmm_hist4.rds")
eb_sho25_glmm_hist4 <- add_criterion(eb_sho25_glmm_hist4, "loo")

#Previous model again but with the reef grouping variable. Model converged.
eb_sho25_glmm_hist5 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + SizeClass + me(RelYear2, Sample_age_stdev, gr = QuadIdentifier):SizeClass + (1 | reefIDcrosswalk), data = subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho25_glmm_hist5.rds")
eb_sho25_glmm_hist5 <- add_criterion(eb_sho25_glmm_hist5, "loo")

#Previous model again but with a variable slope and intercept by reef.
eb_sho25_glmm_hist6 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + SizeClass + me(RelYear2, Sample_age_stdev, gr = QuadIdentifier):SizeClass + (0 + me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) | reefIDcrosswalk), data = subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho25_glmm_hist6.rds")
eb_sho25_glmm_hist6 <- add_criterion(eb_sho25_glmm_hist6, "loo")


```

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

eb_sh25to75 <- subset(eb_sho25, eb_sho25$ShellHeight_mm < 75)
saveRDS(eb_sh25to75, here::here(paste0('GLMMs/AllDates/Data/eb_sh25to75_', Sys.Date(), '.rds')))

#Model converged, intercept significant.
eb_sh25to75_glmm1 <- brm(formula = ShellHeight_mm ~ 1, data = subset(eb_sh25to75, eb_sh25to75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sh25to75_glmm1.rds")
eb_sh25to75_glmm1 <- add_criterion(eb_sh25to75_glmm1, "loo")

#Model converged, RelYear not significant.
eb_sh25to75_glmm2 <- brm(formula = ShellHeight_mm ~ RelYear2, data = subset(eb_sh25to75, eb_sh25to75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sh25to75_glmm2.rds")
eb_sh25to75_glmm2 <- add_criterion(eb_sh25to75_glmm2, "loo")

#Model converged, QuadSize_m2 significant.
eb_sh25to75_glmm3 <- brm(formula = ShellHeight_mm ~ QuadSize_m2, data = subset(eb_sh25to75, eb_sh25to75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sh25to75_glmm3.rds")
eb_sh25to75_glmm3 <- add_criterion(eb_sh25to75_glmm3, "loo")

#Model converged.
eb_sh25to75_glmm4 <- brm(formula = ShellHeight_mm ~ RelYear2 + QuadSize_m2 + (1 | reefIDcrosswalk), data = subset(eb_sh25to75, eb_sh25to75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sh25to75_glmm4.rds")
eb_sh25to75_glmm4 <- add_criterion(eb_sh25to75_glmm4, "loo")

#Model converged.
eb_sh25to75_glmm5 <- brm(formula = ShellHeight_mm ~ RelYear2 + QuadSize_m2 + (0 + RelYear2 | reefIDcrosswalk), data = subset(eb_sh25to75, eb_sh25to75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sh25to75_glmm5.rds")
eb_sh25to75_glmm5 <- add_criterion(eb_sh25to75_glmm5, "loo")

#GLMM 5 is the best fit to the data.
loo_compare(eb_sh25to75_glmm1, eb_sh25to75_glmm2, eb_sh25to75_glmm3, eb_sh25to75_glmm4, eb_sh25to75_glmm5)


#Model converged, intercept significant.
eb_sh25to75_glmm_hist1 <- brm(formula = ShellHeight_mm ~ 1, data = subset(eb_sh25to75, eb_sh25to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sh25to75_glmm_hist1.rds")
eb_sh25to75_glmm_hist1 <- add_criterion(eb_sh25to75_glmm_hist1, "loo")

#Model converged, RelYear was significant.
eb_sh25to75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(eb_sh25to75, eb_sh25to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sh25to75_glmm_hist2.rds")
eb_sh25to75_glmm_hist2 <- add_criterion(eb_sh25to75_glmm_hist2, "loo")

#Model converged.
eb_sh25to75_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = subset(eb_sh25to75, eb_sh25to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 20), iter = 3000, warmup = 1000, chains = 4, thin = 3, inits = 30, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sh25to75_glmm_hist3.rds")
eb_sh25to75_glmm_hist3 <- add_criterion(eb_sh25to75_glmm_hist3, "loo")

#Model did not converge. Tried again with priors for meanme and sdme. Model still did not converge.
eb_sh25to75_glmm_hist4b <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear2 | reefIDcrosswalk), data = subset(eb_sh25to75, eb_sh25to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(66.27, 35)", class = "meanme"), set_prior("normal(16.83, 50)", class = "sdme")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, inits = 30, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sh25to75_glmm_hist4b.rds")
eb_sh25to75_glmm_hist4b <- add_criterion(eb_sh25to75_glmm_hist4b, "loo")


```

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

eb_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Estero Bay_Natural")
eb_sho75[, QuadSize_m2 := as.factor(QuadSize_m2)]
eb_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
eb_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
eb_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(eb_sho75, here::here(paste0('GLMMs/AllDates/Data/eb_sho75_', Sys.Date(), '.rds')))

# eb_sho75_glmm <- brm(formula = ShellHeight_mm ~ RelYear + QuadSize_m2 + LiveDate_Qualifier + (1 + RelYear|reefIDcrosswalk), data = eb_sho75, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# eb_sho75_glmm <- add_criterion(eb_sho75_glmm, "loo")

ggplot(eb_sho75, aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw()

ggplot(eb_sho75, aes(x = RelYear2, y = ShellHeight_mm, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

ggplot(eb_sho75, aes(x = RelYear2, y = QuadSize_m2, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

#Model converged, intercept significant.
eb_sho75_glmm1 <- brm(formula = ShellHeight_mm ~ 1, data = subset(eb_sho75, eb_sho75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho75_glmm1.rds")
eb_sho75_glmm1 <- add_criterion(eb_sho75_glmm1, "loo")

#Model converged, RelYear not significant.
eb_sho75_glmm2 <- brm(formula = ShellHeight_mm ~ RelYear2, data = subset(eb_sho75, eb_sho75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho75_glmm2.rds")
eb_sho75_glmm2 <- add_criterion(eb_sho75_glmm2, "loo")

#Model converged, QuadSize_m2 not significant.
eb_sho75_glmm3 <- brm(formula = ShellHeight_mm ~ QuadSize_m2, data = subset(eb_sho75, eb_sho75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho75_glmm3.rds")
eb_sho75_glmm3 <- add_criterion(eb_sho75_glmm3, "loo")

#Model converged.
eb_sho75_glmm4 <- brm(formula = ShellHeight_mm ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(eb_sho75, eb_sho75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho75_glmm4.rds")
eb_sho75_glmm4 <- add_criterion(eb_sho75_glmm4, "loo")

#Model converged.
eb_sho75_glmm5 <- brm(formula = ShellHeight_mm ~ RelYear2 + (0 + RelYear2 | reefIDcrosswalk), data = subset(eb_sho75, eb_sho75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho75_glmm5.rds")
eb_sho75_glmm5 <- add_criterion(eb_sho75_glmm5, "loo")

#GLMM 2 is the best fit to the data overall, but GLMM 4 is the best one that includes effect of reef.
loo_compare(eb_sho75_glmm1, eb_sho75_glmm2, eb_sho75_glmm3, eb_sho75_glmm4, eb_sho75_glmm5)


#Model converged, intercept significant.
eb_sho75_glmm_hist1 <- brm(formula = ShellHeight_mm ~ 1, data = subset(eb_sho75, eb_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho75_glmm_hist1.rds")
eb_sho75_glmm_hist1 <- add_criterion(eb_sho75_glmm_hist1, "loo")

#Model converged, RelYear was significant.
eb_sho75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(eb_sho75, eb_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho75_glmm_hist2.rds")
eb_sho75_glmm_hist2 <- add_criterion(eb_sho75_glmm_hist2, "loo")

#Model converged. RelYear term was significant.
eb_sho75_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = subset(eb_sho75, eb_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 20), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho75_glmm_hist3.rds")
eb_sho75_glmm_hist3 <- add_criterion(eb_sho75_glmm_hist3, "loo")

#Model converged. RelYear term was significant.
eb_sho75_glmm_hist4 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear2 | reefIDcrosswalk), data = subset(eb_sho75, eb_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_sho75_glmm_hist4.rds")
eb_sho75_glmm_hist4 <- add_criterion(eb_sho75_glmm_hist4, "loo")

#GLMM 3 is the better fit.
loo_compare(eb_sho75_glmm_hist3, eb_sho75_glmm_hist4)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
eb_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Estero Bay_Natural")
eb_sho25[, QuadSize_m2 := as.factor(QuadSize_m2)]
eb_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
eb_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
eb_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
eb_sho25[ShellHeight_mm < 75, SizeClass := "25to75mm"]
eb_sho25[ShellHeight_mm >= 75, SizeClass := "o75mm"]
saveRDS(eb_sho25, here::here(paste0('GLMMs/AllDates/Data/eb_sho25_', Sys.Date(), '.rds')))

#eb_sho25_glmm <- readRDS(here::here('GLMMs/AllDates/eb_sho25_glmm.rds'))

eb_sh25to75 <- subset(eb_sho25, eb_sho25$ShellHeight_mm < 75)
saveRDS(eb_sh25to75, here::here(paste0('GLMMs/AllDates/Data/eb_sh25to75_', Sys.Date(), '.rds')))

eb_sh25to75_glmm <- readRDS(here::here('GLMMs/AllDates/eb_sh25to75_glmm5.rds'))
eb_sh25to75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/eb_sh25to75_glmm_hist3.rds'))

eb_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Estero Bay_Natural")
eb_sho75[, QuadSize_m2 := as.numeric(QuadSize_m2)]
eb_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
eb_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
eb_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(eb_sho75, here::here(paste0('GLMMs/AllDates/Data/eb_sho75_', Sys.Date(), '.rds')))

eb_sho75_glmm <- readRDS(here::here('GLMMs/AllDates/eb_sho75_glmm4.rds'))
eb_sho75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/eb_sho75_glmm_hist3.rds'))

```

##### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

eb_sho25[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
eb_sho25[, SampleDay := day(SampleDate)]

if(length(subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Exact")$ShellHeight_mm) > 0){
  sh_t <- copy(eb_sho25[0, ])
  sh_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
  for(i in unique(as.numeric(eb_sho25$Month))){
    mo <- subset(eb_sho25, as.numeric(eb_sho25$Month) == i)
    ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
           ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                  ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                         ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                                ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                       ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                              ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                     ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                            ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                   ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                          ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
    sh_t <- rbind(mo, sh_t)
  }
  
  monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))
  
  #Create the sampling dates correspondence plot
  SampleDatesPlot <- ggplot(subset(sh_t, sh_t$LiveDate_Qualifier == "Exact"), aes(x = DayNum, y = as.factor(ProgramID), color = Year, shape = Season)) +
                        geom_point(size = 3) +
                        geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                        geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                        xlim(1,365) +
                        scale_x_continuous(breaks = NULL) +
                        coord_cartesian(xlim = c(1, 366)) +
                        theme_bw()+labs(x = "Sample Date", y = "Program ID")
  print(SampleDatesPlot)
  
  #Remove the objects after the plot is done.
  rm(sh_t, monthnames, SampleDatesPlot)

} else{
  
  print("There are no real-time data for this managed area.")
  
}

```

<br><br><br>

##### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_specimens = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for size class 25-75mm first.
sh25to75_status <- subset(eb_sh25to75, eb_sh25to75$Sample_mean_age %in% StatusYears)
sh25to75_status[, `:=` (Indicator = "Size Class", 
                        SizeClass = "25-75mm", 
                        Year = as.numeric(Sample_mean_age), 
                        n_reefs = length(unique(ReefIdentifier)),
                        n_programs = length(unique(ProgramID)),
                        ProgIDs = list(unique(ProgramID)),
                        n_specimens = length(ShellHeight_mm),
                        Median = median(ShellHeight_mm),
                        Mean = round(mean(ShellHeight_mm), digits = 2),
                        SD = round(sd(ShellHeight_mm), digits = 2), 
                        Min. = min(ShellHeight_mm),
                        Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sh25to75_status <- unique(sh25to75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sh25to75_status <- sh25to75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sh25to75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sh25to75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = "25-75mm",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sh25to75_status <- rbind(sh25to75_status, MissingYr_i)
  }
}

#Build status table for size class >75mm next.
sho75_status <- subset(eb_sho75, eb_sho75$Sample_mean_age %in% StatusYears)
sho75_status[, `:=` (Indicator = "Size Class", 
                     SizeClass = ">75mm", 
                     Year = as.numeric(Sample_mean_age), 
                     n_reefs = length(unique(ReefIdentifier)),
                     n_programs = length(unique(ProgramID)),
                     ProgIDs = list(unique(ProgramID)),
                     n_specimens = length(ShellHeight_mm),
                     Median = median(ShellHeight_mm),
                     Mean = round(mean(ShellHeight_mm), digits = 2),
                     SD = round(sd(ShellHeight_mm), digits = 2), 
                     Min. = min(ShellHeight_mm),
                     Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sho75_status <- unique(sho75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sho75_status <- sho75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sho75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sho75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = ">75mm",
                              Year = i,
                              n_reefs = ifelse(sh25to75_status[Year == i, n_reefs] > 0, sh25to75_status[Year == i, n_reefs], 0),
                              n_programs = ifelse(sh25to75_status[Year == i, n_programs] > 0, sh25to75_status[Year == i, n_programs], 0),
                              ProgIDs = ifelse(!is.na(sh25to75_status[Year == i, ProgIDs]), sh25to75_status[Year == i, ProgIDs], NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sho75_status <- rbind(sho75_status, MissingYr_i)
  }
}

#Merge individual size class tables and set row order
Status <- rbind(Status, sh25to75_status)
Status <- rbind(Status, sho75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) %>%
  kable_styling() %>%
  row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, sh25to75_status, MissingYr_i, sho75_status)
```

<br><br><br>

##### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(eb_sho25, aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw()

ggplot(eb_sho25, aes(x = RelYear2, y = ShellHeight_mm, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()
```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
ggplot(eb_sho25, aes(x = RelYear2, y = QuadSize_m2, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

#Little overlap in quad sizes in any particular year; no replication of the 1m2 quad size by year and only one replicate year for 0.33m2.
ggplot(subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = QuadSize_m2, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw() +
  labs(caption = "Little overlap in quad sizes in any particular year; no replication of the 1m2 quad size by year and only one replicate year for 0.33m2.")
```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
ggplot(subset(eb_sho25, eb_sho25$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = NumberMeasured_n, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

```

<br><br><br>

##### Model Output {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- summary(eb_sho25_glmm) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height 25-75mm

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(eb_sh25to75_glmm)
```

<br><br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(eb_sh25to75_glmm_hist)
```

<br><br><br>

###### Shell height >75mm

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(eb_sho75_glmm)
```

<br><br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(eb_sho75_glmm_hist)
```

<br><br><br>

##### Diagnostic Plots {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- Posterior distributions and Markov chains: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_EB_PDistandMChains_o25 <- plot(eb_sho25_glmm) -->
<!-- SH_AllDates_GLMM_EB_PDistandMChains_o25 -->

<!-- len <- length(SH_AllDates_GLMM_EB_PDistandMChains_o25) -->
<!-- for(i in 1:len){ -->
<!--   jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_PDistandMChains_o25_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300) -->
<!--   print(SH_AllDates_GLMM_EB_PDistandMChains_o25[i]) -->
<!--   dev.off() -->
<!-- } -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- Posterior predictive check plot: -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_EB_PPcheck_o25 <- pp_check(eb_sho25_glmm) -->
<!-- SH_AllDates_GLMM_EB_PPcheck_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_PPcheck_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_EB_PPcheck_o25, -->
<!--        width = 4, -->
<!--        height = 3, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height 25-75mm

Posterior distributions and Markov chains:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_EB_PDistandMChains_25to75 <- plot(eb_sh25to75_glmm)
SH_AllDates_GLMM_EB_PDistandMChains_25to75

len <- length(SH_AllDates_GLMM_EB_PDistandMChains_25to75)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_PDistandMChains_25to75_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_EB_PDistandMChains_25to75[i])
  dev.off()
}
```

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_EB_PDistandMChains_25to75_hist <- plot(eb_sh25to75_glmm_hist)
SH_AllDates_GLMM_EB_PDistandMChains_25to75_hist

len <- length(SH_AllDates_GLMM_EB_PDistandMChains_25to75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_PDistandMChains_25to75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_EB_PDistandMChains_25to75_hist[i])
  dev.off()
}
```

<br><br>

Posterior predictive check plot:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_EB_PPcheck_25to75 <- pp_check(eb_sh25to75_glmm)
SH_AllDates_GLMM_EB_PPcheck_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_PPcheck_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_EB_PPcheck_25to75,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_EB_PPcheck_25to75_hist <- tryCatch(pp_check(eb_sh25to75_glmm_hist),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_EB_PPcheck_25to75_hist) == TRUE){
    SH_AllDates_GLMM_EB_PPcheck_25to75_hist <- tryCatch(pp_check(eb_sh25to75_glmm_hist), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_EB_PPcheck_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_PPcheck_25to75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_EB_PPcheck_25to75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Shell height >75mm

Posterior distributions and Markov chains:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_EB_PDistandMChains_o75 <- plot(eb_sho75_glmm)
SH_AllDates_GLMM_EB_PDistandMChains_o75

len <- length(SH_AllDates_GLMM_EB_PDistandMChains_o75)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_PDistandMChains_o75_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_EB_PDistandMChains_o75[i])
  dev.off()
}
```

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_EB_PDistandMChains_o75_hist <- plot(eb_sho75_glmm_hist)
SH_AllDates_GLMM_EB_PDistandMChains_o75_hist

len <- length(SH_AllDates_GLMM_EB_PDistandMChains_o75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_PDistandMChains_o75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_EB_PDistandMChains_o75_hist[i])
  dev.off()
}
```

<br><br>

Posterior predictive check plot:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_EB_PPcheck_o75 <- pp_check(eb_sho75_glmm)
SH_AllDates_GLMM_EB_PPcheck_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_PPcheck_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_EB_PPcheck_o75,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_EB_PPcheck_o75_hist <- tryCatch(pp_check(eb_sho75_glmm_hist),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_EB_PPcheck_o75_hist) == TRUE){
    SH_AllDates_GLMM_EB_PPcheck_o75_hist <- tryCatch(pp_check(eb_sho75_glmm_hist), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_EB_PPcheck_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_PPcheck_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_EB_PPcheck_o75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Marginal Effects Plots {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- Including the random effect of reef (i.e., managed area-wide credible interval): -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Marginal effects plot including random effects -->
<!-- eb_sho25_1 <- plot(conditional_effects(eb_sho25_glmm_hist6, re_formula = NULL), plot = FALSE)[[3]] -->
<!-- SH_AllDates_GLMM_EB_MEPrand_o25 <- eb_sho25_1 + -->
<!--   geom_point(data = eb_sho25, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_EB_MEPrand_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_MEPrand_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_EB_MEPrand_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- Excluding the random effect of reef (i.e., sampled population credible interval): -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Marginal effects plot excluding random effects -->
<!-- eb_sho25_2 <- plot(conditional_effects(eb_sho25_glmm, re_formula = NA), plot = FALSE)[[1]] -->
<!-- SH_AllDates_GLMM_EB_MEPnorand_o25 <- eb_sho25_2 + -->
<!--   geom_point(data = eb_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_EB_MEPnorand_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_MEPnorand_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_EB_MEPnorand_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- Individual effects plots: -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=50, fig.width=10, out.width="100%"} -->
<!-- #Individual effects plots -->
<!-- SH_AllDates_GLMM_EB_IEP_o25 <- eb_sho25 %>% -->
<!--   group_by(reefIDcrosswalk) %>% -->
<!--   add_fitted_draws(eb_sho25_glmm) %>% -->
<!--   ggplot(aes(x = RelYear, y = ShellHeight_mm, color = reefIDcrosswalk)) + -->
<!--   stat_lineribbon(aes(y = .value), size = 1) + -->
<!--   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) + -->
<!--   geom_point(data = eb_sho25) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") + -->
<!--   #geom_line(aes(y = .value), linetype = "dashed", color = "black") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   #scale_color_brewer(palette = "Set2") + -->
<!--   theme_bw() + -->
<!--   facet_wrap(~ reefIDcrosswalk, ncol = 3) -->
<!-- SH_AllDates_GLMM_EB_IEP_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_IEP_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_EB_IEP_o25, -->
<!--        width = 10, -->
<!--        height = 30, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height 25-75mm

<br>

Including the random effect of reef (i.e., managed area-wide credible interval):

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
#Marginal effects plot including random effects
labs1 <- sort(unique(eb_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- c(labs1[seq(1, length(labs1), 4)], 2018)
#labs1 <- append(labs1, c(1954))
#labs1 <- labs1[c(-3, -4, -6)]
labs2 <- sort(unique(eb_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- labs2[seq(1, length(labs2), 4)]

set.seed(987)
eb_sh25to75_1 <- plot(conditional_effects(eb_sh25to75_glmm, re_formula = NULL), plot = FALSE)[[1]]
eb_sh25to75_hist_1 <- plot(conditional_effects(eb_sh25to75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]

SH_AllDates_GLMM_EB_MEPrand_25to75 <- ggplot(eb_sh25to75_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = eb_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = eb_sh25to75_hist_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = eb_sh25to75_hist_1$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(eb_sh25to75, eb_sh25to75$Sample_mean_age %in% labs1), aes(y = 23, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(eb_sh25to75, eb_sh25to75$Sample_mean_age %in% labs2), aes(y = 20, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(20, 80))
SH_AllDates_GLMM_EB_MEPrand_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_MEPrand_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_EB_MEPrand_25to75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
#Marginal effects plot excluding random effects
labs1 <- sort(unique(eb_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- c(labs1[seq(1, length(labs1), 4)], 2018)
#labs1 <- append(labs1, c(1954))
#labs1 <- labs1[c(-3, -4, -6)]
labs2 <- sort(unique(eb_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- labs2[seq(1, length(labs2), 4)]

set.seed(765)
eb_sh25to75_2 <- plot(conditional_effects(eb_sh25to75_glmm, re_formula = NA), plot = FALSE)[[1]]
eb_sh25to75_hist_2 <- plot(conditional_effects(eb_sh25to75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]

SH_AllDates_GLMM_EB_MEPnorand_25to75 <- ggplot(eb_sh25to75_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = eb_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = eb_sh25to75_hist_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = eb_sh25to75_hist_2$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(eb_sh25to75, eb_sh25to75$Sample_mean_age %in% labs1), aes(y = 23, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(eb_sh25to75, eb_sh25to75$Sample_mean_age %in% labs2), aes(y = 20, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(20, 80))
SH_AllDates_GLMM_EB_MEPnorand_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_MEPnorand_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_EB_MEPnorand_25to75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=50, fig.width=10, out.width="100%"}
#Individual effects plots

#labs1 <- sort(unique(eb_sh25to75$Sample_mean_age))#[c(TRUE, FALSE)]
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))

eb_sh25to75_rt <- subset(eb_sh25to75, eb_sh25to75$Sample_mean_age_qualifier != "Estimate")

set.seed(987)
SH_AllDates_GLMM_EB_IEP_25to75 <- eb_sh25to75_rt %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(eb_sh25to75_glmm) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = eb_sh25to75_rt) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = eb_sh25to75_rt, aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sh25t25to75, gtmn_sh25t25to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(eb_sh25to75_rt$RelYear2) - 1, max(eb_sh25to75_rt$RelYear2) + 1)) +
  scale_y_continuous(limits = c(15, 80)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_EB_IEP_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_IEP_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_EB_IEP_25to75,
       width = 10,
       height = 30,
       units = "in",
       dpi = 300)
```

<br><br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=10, fig.width=10, out.width="100%"}

labs1 <- sort(unique(eb_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs2 <- sort(unique(eb_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]

eb_sh25to75_h <- subset(eb_sh25to75, eb_sh25to75$Sample_mean_age_qualifier == "Estimate")

set.seed(654)
SH_AllDates_GLMM_EB_IEP_25to75_hist <- eb_sh25to75_h %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(eb_sh25to75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = eb_sh25to75_h) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(eb_sh25to75_h, eb_sh25to75_h$Sample_mean_age %in% labs1), aes(y = 23, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(eb_sh25to75_h, eb_sh25to75_h$Sample_mean_age %in% labs2), aes(y = 19, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sh25t25to75, gtmn_sh25t25to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  #scale_x_continuous(limits = c(min(eb_sh25to75_h$RelYear2) - 1, max(eb_sh25to75_h$RelYear2) + 1)) +
  #scale_y_continuous(limits = c(65, 130)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_EB_IEP_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_IEP_25to75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_EB_IEP_25to75_hist,
       width = 10,
       height = 10,
       units = "in",
       dpi = 300, limitsize = FALSE)
```

<br><br><br>

###### Shell height >75mm

<br>

Including the random effect of reef (i.e., managed area-wide credible interval):

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
#Marginal effects plot including random effects
labs1 <- sort(unique(eb_sho75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))
#labs1 <- labs1[c(-3, -4, -6)]
labs2 <- sort(unique(eb_sho75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- labs2[seq(1, length(labs2), 4)]

set.seed(987)
eb_sho75_1 <- plot(conditional_effects(eb_sho75_glmm, re_formula = NULL), plot = FALSE)[[1]]
eb_sho75_hist_1 <- plot(conditional_effects(eb_sho75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]

SH_AllDates_GLMM_EB_MEPrand_o75 <- ggplot(eb_sho75_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = eb_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = eb_sho75_hist_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = eb_sho75_hist_1$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(eb_sho75, eb_sho75$Sample_mean_age %in% labs1), aes(y = 73, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(eb_sho75, eb_sho75$Sample_mean_age %in% labs2), aes(y = 70, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(70, 150))
SH_AllDates_GLMM_EB_MEPrand_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_MEPrand_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_EB_MEPrand_o75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
#Marginal effects plot excluding random effects
labs1 <- sort(unique(eb_sho75$Sample_mean_age))[c(TRUE, FALSE)]
labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))
#labs1 <- labs1[c(-3, -4, -6)]
labs2 <- sort(unique(eb_sho75$Sample_mean_age))[c(FALSE, TRUE)]
labs2 <- labs2[seq(1, length(labs2), 4)]

set.seed(765)
eb_sho75_2 <- plot(conditional_effects(eb_sho75_glmm, re_formula = NA), plot = FALSE)[[1]]
eb_sho75_hist_2 <- plot(conditional_effects(eb_sho75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]

SH_AllDates_GLMM_EB_MEPnorand_o75 <- ggplot(eb_sho75_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = eb_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = eb_sho75_hist_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = eb_sho75_hist_2$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(eb_sho75, eb_sho75$Sample_mean_age %in% labs1), aes(y = 73, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(eb_sho75, eb_sho75$Sample_mean_age %in% labs2), aes(y = 70, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(70, 150))
SH_AllDates_GLMM_EB_MEPnorand_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_MEPnorand_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_EB_MEPnorand_o75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=50, fig.width=10, out.width="100%"}
#Individual effects plots

#labs1 <- sort(unique(eb_sho75$Sample_mean_age))#[c(TRUE, FALSE)]
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))

eb_sho75_rt <- subset(eb_sho75, eb_sho75$Sample_mean_age_qualifier != "Estimate")

set.seed(987)
SH_AllDates_GLMM_EB_IEP_o75 <- eb_sho75_rt %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(eb_sho75_glmm) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = eb_sho75_rt) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = eb_sho75_rt, aes(y = 68, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sh25to75, gtmn_sh25to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(eb_sho75_rt$RelYear2) - 1, max(eb_sho75_rt$RelYear2) + 1)) +
  scale_y_continuous(limits = c(65, 120)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_EB_IEP_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_IEP_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_EB_IEP_o75,
       width = 10,
       height = 30,
       units = "in",
       dpi = 300)
```

<br><br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=10, fig.width=10, out.width="100%"}

labs1 <- sort(unique(eb_sho75$Sample_mean_age))[c(TRUE, FALSE)]
labs2 <- sort(unique(eb_sho75$Sample_mean_age))[c(FALSE, TRUE)]

eb_sho75_h <- subset(eb_sho75, eb_sho75$Sample_mean_age_qualifier == "Estimate")

set.seed(654)
SH_AllDates_GLMM_EB_IEP_o75_hist <- eb_sho75_h %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(eb_sho75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = eb_sho75_h) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(eb_sho75_h, eb_sho75_h$Sample_mean_age %in% labs1), aes(y = 73, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(eb_sho75_h, eb_sho75_h$Sample_mean_age %in% labs2), aes(y = 69, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sh25to75, gtmn_sh25to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  #scale_x_continuous(limits = c(min(eb_sho75_h$RelYear2) - 1, max(eb_sho75_h$RelYear2) + 1)) +
  #scale_y_continuous(limits = c(65, 130)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_EB_IEP_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_EB_IEP_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_EB_IEP_o75_hist,
       width = 10,
       height = 10,
       units = "in",
       dpi = 300, limitsize = FALSE)
```


```{r include=FALSE}
# Remove created objects to save memory.
rm(eb_sho25, eb_sho25_glmm, eb_sho25_hist, eb_sho25_glmm_hist, 
   eb_sho75, eb_sho75_glmm, eb_sho75_hist, eb_sho75_glmm_hist, 
   SH_AllDates_GLMM_EB_PDistandMChains_o25, SH_AllDates_GLMM_EB_PDistandMChains_o75,
   SH_AllDates_GLMM_EB_PPcheck_o25, SH_AllDates_GLMM_EB_PPcheck_o75,
   SH_AllDates_GLMM_EB_MEPrand_o25, SH_AllDates_GLMM_EB_MEPrand_o75,
   SH_AllDates_GLMM_EB_MEPnorand_o25, SH_AllDates_GLMM_EB_MEPnorand_o75,
   SH_AllDates_GLMM_EB_IEP_o25, SH_AllDates_GLMM_EB_IEP_o75
   )

```

<br><br><br>


#### Guana River Marsh_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

grm_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Guana River Marsh_Natural")
grm_sho25[ProgramID == 4000 & LiveDate2 == 2015, NumberMeasured_n := "50"]
grm_sho25[, QuadSize_m2 := as.factor(QuadSize_m2)]
grm_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
grm_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
grm_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
grm_sho25[ShellHeight_mm < 75, SizeClass := "25to75mm"]
grm_sho25[ShellHeight_mm >= 75, SizeClass := "o75mm"]
saveRDS(grm_sho25, here::here(paste0('GLMMs/AllDates/Data/grm_sho25_', Sys.Date(), '.rds')))

# grm_sho25_glmm <- brm(formula = ShellHeight_mm ~ RelYear + QuadSize_m2 + NumberMeasured_n + LiveDate_Qualifier + (1 + RelYear|reefIDcrosswalk), data = grm_sho25, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "log"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# grm_sho25_glmm <- add_criterion(grm_sho25_glmm, "loo")

ggplot(grm_sho25, aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(subset(grm_sho25, grm_sho25$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = QuadSize_m2, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(subset(grm_sho25, grm_sho25$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = NumberMeasured_n, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

#Model converged, intercept was significant.
grm_sho25_glmm1 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ 1, data = subset(grm_sho25, grm_sho25$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho25_glmm1.rds")
grm_sho25_glmm1 <- add_criterion(grm_sho25_glmm1, "loo")

#Model converged, RelYear2 was significant.
grm_sho25_glmm2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ RelYear2, data = subset(grm_sho25, grm_sho25$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho25_glmm2.rds")
grm_sho25_glmm2 <- add_criterion(grm_sho25_glmm2, "loo")

#Model converged, NumberMeasured_n was significant.
grm_sho25_glmm3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ NumberMeasured_n, data = subset(grm_sho25, grm_sho25$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho25_glmm3.rds")
grm_sho25_glmm3 <- add_criterion(grm_sho25_glmm3, "loo")

#Model converged, SizeClass was significant.
grm_sho25_glmm4 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ SizeClass, data = subset(grm_sho25, grm_sho25$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho25_glmm4.rds")
grm_sho25_glmm4 <- add_criterion(grm_sho25_glmm4, "loo")

#Model converged.
grm_sho25_glmm5 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ RelYear2 + SizeClass + NumberMeasured_n + RelYear2:SizeClass + (1 | reefIDcrosswalk), data = subset(grm_sho25, grm_sho25$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho25_glmm5.rds")
grm_sho25_glmm5 <- add_criterion(grm_sho25_glmm5, "loo")

#Model converged.
grm_sho25_glmm6 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 250) ~ RelYear2 + SizeClass + NumberMeasured_n + RelYear2:SizeClass + (0 + RelYear2 | reefIDcrosswalk), data = subset(grm_sho25, grm_sho25$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho25_glmm6.rds")
grm_sho25_glmm6 <- add_criterion(grm_sho25_glmm6, "loo")

#GLMM 5 is the better fit.
loo_compare(grm_sho25_glmm5, grm_sho25_glmm6)

```


```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

grm_sh25to75 <- subset(grm_sho25, grm_sho25$ShellHeight_mm < 75)
saveRDS(grm_sh25to75, here::here(paste0('GLMMs/AllDates/Data/grm_sh25to75_', Sys.Date(), '.rds')))

ggplot(grm_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = QuadSize_m2, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = NumberMeasured_n, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

#Model converged, intercept was not significant.
grm_sh25to75_glmm1 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ 1, data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, inits = 30, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sh25to75_glmm1.rds")
grm_sh25to75_glmm1 <- add_criterion(grm_sh25to75_glmm1, "loo")

#Model converged, RelYear2 was not significant.
grm_sh25to75_glmm2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2, data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, inits = 30, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sh25to75_glmm2.rds")
grm_sh25to75_glmm2 <- add_criterion(grm_sh25to75_glmm2, "loo")

#Model converged, NumberMeasured_n was significant.
grm_sh25to75_glmm3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ NumberMeasured_n, data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, inits = 30, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sh25to75_glmm3.rds")
grm_sh25to75_glmm3 <- add_criterion(grm_sh25to75_glmm3, "loo")

#Model converged.
grm_sh25to75_glmm4 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + NumberMeasured_n + (1 | reefIDcrosswalk), data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sh25to75_glmm4.rds")
grm_sh25to75_glmm4 <- add_criterion(grm_sh25to75_glmm4, "loo")

#Model converged.
grm_sh25to75_glmm5 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + NumberMeasured_n + (0 + RelYear2 | reefIDcrosswalk), data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sh25to75_glmm5.rds")
grm_sh25to75_glmm5 <- add_criterion(grm_sh25to75_glmm5, "loo")

#GLMM 4 is the better fit.
loo_compare(grm_sh25to75_glmm4, grm_sh25to75_glmm5)


#Model converged, intercept was not significant.
grm_sh25to75_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ 1, data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 3, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, inits = 30, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sh25to75_glmm_hist1.rds")
grm_sh25to75_glmm_hist1 <- add_criterion(grm_sh25to75_glmm_hist1, "loo")

#Model did not converge, so I added priors and increased adapt_delta and max_treedepth. Model still did not converge.
grm_sh25to75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(6.25, 7)", class = "meanme"), set_prior("normal(15.27, 5)", class = "sdme")), cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, inits = 30, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sh25to75_glmm_hist2.rds")
grm_sh25to75_glmm_hist2 <- add_criterion(grm_sh25to75_glmm_hist2, "loo")

#Model did not converge.
grm_sh25to75_glmm_hist3b <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(6.25, 7)", class = "meanme", coef = "meRelYear2"), set_prior("normal(15.27, 5)", class = "sdme", coef = "meRelYear2"), set_prior("cauchy(0,2)", class = "sd")), cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sh25to75_glmm_hist3b.rds")
grm_sh25to75_glmm_hist3b <- add_criterion(grm_sh25to75_glmm_hist3b, "loo")

#Tried previous model again without the inits value (has sometimes helped with other models). Model converged (barely)!
grm_sh25to75_glmm_hist3c <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(6.25, 7)", class = "meanme", coef = "meRelYear2"), set_prior("normal(15.27, 5)", class = "sdme", coef = "meRelYear2"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sh25to75_glmm_hist3c.rds")
grm_sh25to75_glmm_hist3c <- add_criterion(grm_sh25to75_glmm_hist3c, "loo")

#Model did not converge. Tried again with priors for meanme and sdme. Model still did not converge.
grm_sh25to75_glmm_hist4b <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) | reefIDcrosswalk), data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(6.25, 7)", class = "meanme", coef = "meRelYear2"), set_prior("normal(15.27, 5)", class = "sdme", coef = "meRelYear2"), set_prior("cauchy(0,2)", class = "sd")), cores = 3, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sh25to75_glmm_hist4b.rds")
grm_sh25to75_glmm_hist4b <- add_criterion(grm_sh25to75_glmm_hist4b, "loo")

#Tried previous model again without the inits value (has sometimes helped with other models).
grm_sh25to75_glmm_hist4c <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) | reefIDcrosswalk), data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(6.25, 7)", class = "meanme", coef = "meRelYear2"), set_prior("normal(15.27, 5)", class = "sdme", coef = "meRelYear2"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sh25to75_glmm_hist4c.rds")
grm_sh25to75_glmm_hist4c <- add_criterion(grm_sh25to75_glmm_hist4c, "loo")

#GLMM 3c is the better fit.
loo_compare(grm_sh25to75_glmm_hist3c, grm_sh25to75_glmm_hist4c)

```


```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

grm_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Guana River Marsh_Natural")
grm_sho75[, QuadSize_m2 := as.numeric(QuadSize_m2)]
grm_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
grm_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
grm_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(grm_sho75, here::here(paste0('GLMMs/AllDates/Data/grm_sho75_', Sys.Date(), '.rds')))

# grm_sho75_glmm <- brm(formula = ShellHeight_mm ~ RelYear + QuadSize_m2 + NumberMeasured_n + LiveDate_Qualifier + (1 + RelYear|reefIDcrosswalk), data = grm_sho75, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "log"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# grm_sho75_glmm <- add_criterion(grm_sho75_glmm, "loo")

#Model converged, intercept was significant.
grm_sho75_glmm1 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ 1, data = subset(grm_sho75, grm_sho75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, inits = 30, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho75_glmm1.rds")
grm_sho75_glmm1 <- add_criterion(grm_sho75_glmm1, "loo")

#Model converged, RelYear2 was not significant.
grm_sho75_glmm2 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2, data = subset(grm_sho75, grm_sho75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, inits = 30, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho75_glmm2.rds")
grm_sho75_glmm2 <- add_criterion(grm_sho75_glmm2, "loo")

#Model converged, NumberMeasured_n was significant.
grm_sho75_glmm3 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ NumberMeasured_n, data = subset(grm_sho75, grm_sho75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, inits = 30, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho75_glmm3.rds")
grm_sho75_glmm3 <- add_criterion(grm_sho75_glmm3, "loo")

#Model converged.
grm_sho75_glmm4 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + NumberMeasured_n + (1 | reefIDcrosswalk), data = subset(grm_sho75, grm_sho75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho75_glmm4.rds")
grm_sho75_glmm4 <- add_criterion(grm_sho75_glmm4, "loo")

#Model converged.
grm_sho75_glmm5 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + NumberMeasured_n + (0 + RelYear2 | reefIDcrosswalk), data = subset(grm_sho75, grm_sho75$Sample_mean_age_qualifier == "Exact"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho75_glmm5.rds")
grm_sho75_glmm5 <- add_criterion(grm_sho75_glmm5, "loo")

#GLMM 4 is the better fit.
loo_compare(grm_sho75_glmm4, grm_sho75_glmm5)


#Model converged, intercept was significant.
grm_sho75_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ 1, data = subset(grm_sho75, grm_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, inits = 30, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho75_glmm_hist1.rds")
grm_sho75_glmm_hist1 <- add_criterion(grm_sho75_glmm_hist1, "loo")

#Model did not converge, so I added priors and tried again. Model converged, RelYear was significant.
grm_sho75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(grm_sho75, grm_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(7.36, 6)", class = "meanme"), set_prior("normal(15.54, 4)", class = "sdme")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, inits = 30, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho75_glmm_hist2.rds")
grm_sho75_glmm_hist2 <- add_criterion(grm_sho75_glmm_hist2, "loo")

#Running previous model again with an inits value in the response range. Model did not converge.
grm_sho75_glmm_hist2b <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(grm_sho75, grm_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(7.36, 6)", class = "meanme"), set_prior("normal(15.54, 4)", class = "sdme")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, inits = 80, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho75_glmm_hist2b.rds")
grm_sho75_glmm_hist2b <- add_criterion(grm_sho75_glmm_hist2b, "loo")

#Model did not converge. Tried again after removing the inits value (previously was 80). Nearly converged (all Rhats < 1.2), so increased adapt_delta to 0.999 and tried again. Still did not converge, so I narrowed the sigma values of the prior distributions by 1 and increased iterations by 1000, then tried again. Model still did not converge. Tried again with a cauchy prior for sd. Model did not converge.
grm_sho75_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = subset(grm_sho75, grm_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(7.36, 5)", class = "meanme"), set_prior("normal(15.54, 3)", class = "sdme"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho75_glmm_hist3.rds")
grm_sho75_glmm_hist3 <- add_criterion(grm_sho75_glmm_hist3, "loo")

#Model converged.
grm_sho75_glmm_hist4 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) | reefIDcrosswalk), data = subset(grm_sho75, grm_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(7.36, 6)", class = "meanme"), set_prior("normal(15.54, 4)", class = "sdme"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_sho75_glmm_hist4.rds")
grm_sho75_glmm_hist4 <- add_criterion(grm_sho75_glmm_hist4, "loo")

```

```{r message=FALSE, warning=FALSE, include=FALSE}
grm_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Guana River Marsh_Natural")
grm_sho25[ProgramID == 4000 & LiveDate2 == 2015, NumberMeasured_n := "50"]
grm_sho25[, QuadSize_m2 := as.factor(QuadSize_m2)]
grm_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
grm_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
grm_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
grm_sho25[ShellHeight_mm < 75, SizeClass := "25to75mm"]
grm_sho25[ShellHeight_mm >= 75, SizeClass := "o75mm"]
saveRDS(grm_sho25, here::here(paste0('GLMMs/AllDates/Data/grm_sho25_', Sys.Date(), '.rds')))

#grm_sho25_glmm <- readRDS(here::here('GLMMs/AllDates/grm_sho25_glmm5.rds'))

grm_sh25to75 <- subset(grm_sho25, grm_sho25$ShellHeight_mm < 75)
saveRDS(grm_sh25to75, here::here(paste0('GLMMs/AllDates/Data/grm_sh25to75_', Sys.Date(), '.rds')))

grm_sh25to75_glmm <- readRDS(here::here('GLMMs/AllDates/grm_sh25to75_glmm4.rds'))
grm_sh25to75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/grm_sh25to75_glmm_hist3c.rds'))

grm_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Guana River Marsh_Natural")
grm_sho75[, QuadSize_m2 := as.numeric(QuadSize_m2)]
grm_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
grm_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
grm_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(grm_sho75, here::here(paste0('GLMMs/AllDates/Data/grm_sho75_', Sys.Date(), '.rds')))

grm_sho75_glmm <- readRDS(here::here('GLMMs/AllDates/grm_sho75_glmm4.rds'))
grm_sho75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/grm_sho75_glmm_hist4.rds'))

```

##### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

grm_sho25[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
grm_sho25[, SampleDay := day(SampleDate)]

if(length(subset(grm_sho25, grm_sho25$Sample_mean_age_qualifier == "Exact")$ShellHeight_mm) > 0){
  sh_t <- copy(grm_sho25[0, ])
  sh_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
  for(i in unique(as.numeric(grm_sho25$Month))){
    mo <- subset(grm_sho25, as.numeric(grm_sho25$Month) == i)
    ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
           ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                  ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                         ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                                ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                       ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                              ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                     ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                            ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                   ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                          ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
    sh_t <- rbind(mo, sh_t)
  }
  
  monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))
  
  #Create the sampling dates correspondence plot
  SampleDatesPlot <- ggplot(subset(sh_t, sh_t$LiveDate_Qualifier == "Exact"), aes(x = DayNum, y = as.factor(ProgramID), color = Year, shape = Season)) +
                        geom_point(size = 3) +
                        geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                        geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                        xlim(1,365) +
                        scale_x_continuous(breaks = NULL) +
                        coord_cartesian(xlim = c(1, 366)) +
                        theme_bw()+labs(x = "Sample Date", y = "Program ID")
  print(SampleDatesPlot)
  
  #Remove the objects after the plot is done.
  rm(sh_t, monthnames, SampleDatesPlot)

} else{
  
  print("There are no real-time data for this managed area.")
  
}

```

<br><br><br>

##### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_specimens = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for size class 25-75mm first.
sh25to75_status <- subset(grm_sh25to75, grm_sh25to75$Sample_mean_age %in% StatusYears)
sh25to75_status[, `:=` (Indicator = "Size Class", 
                        SizeClass = "25-75mm", 
                        Year = as.numeric(Sample_mean_age), 
                        n_reefs = length(unique(ReefIdentifier)),
                        n_programs = length(unique(ProgramID)),
                        ProgIDs = list(unique(ProgramID)),
                        n_specimens = length(ShellHeight_mm),
                        Median = median(ShellHeight_mm),
                        Mean = round(mean(ShellHeight_mm), digits = 2),
                        SD = round(sd(ShellHeight_mm), digits = 2), 
                        Min. = min(ShellHeight_mm),
                        Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sh25to75_status <- unique(sh25to75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sh25to75_status <- sh25to75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sh25to75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sh25to75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = "25-75mm",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sh25to75_status <- rbind(sh25to75_status, MissingYr_i)
  }
}

#Build status table for size class >75mm next.
sho75_status <- subset(grm_sho75, grm_sho75$Sample_mean_age %in% StatusYears)
sho75_status[, `:=` (Indicator = "Size Class", 
                     SizeClass = ">75mm", 
                     Year = as.numeric(Sample_mean_age), 
                     n_reefs = length(unique(ReefIdentifier)),
                     n_programs = length(unique(ProgramID)),
                     ProgIDs = list(unique(ProgramID)),
                     n_specimens = length(ShellHeight_mm),
                     Median = median(ShellHeight_mm),
                     Mean = round(mean(ShellHeight_mm), digits = 2),
                     SD = round(sd(ShellHeight_mm), digits = 2), 
                     Min. = min(ShellHeight_mm),
                     Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sho75_status <- unique(sho75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sho75_status <- sho75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sho75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sho75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = ">75mm",
                              Year = i,
                              n_reefs = ifelse(sh25to75_status[Year == i, n_reefs] > 0, sh25to75_status[Year == i, n_reefs], 0),
                              n_programs = ifelse(sh25to75_status[Year == i, n_programs] > 0, sh25to75_status[Year == i, n_programs], 0),
                              ProgIDs = ifelse(!is.na(sh25to75_status[Year == i, ProgIDs]), sh25to75_status[Year == i, ProgIDs], NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sho75_status <- rbind(sho75_status, MissingYr_i)
  }
}

#Merge individual size class tables and set row order
Status <- rbind(Status, sh25to75_status)
Status <- rbind(Status, sho75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) %>%
  kable_styling() %>%
  row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, sh25to75_status, MissingYr_i, sho75_status)
```

<br><br><br>

##### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(grm_sho25, aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk, shape = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw() +
  guides(color = FALSE) #+
  #theme(legend.position = "none")

ggplot(subset(grm_sho25, grm_sho25$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = QuadSize_m2, color = reefIDcrosswalk, shape = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw() +
  guides(color = FALSE) #+
  #theme(legend.position = "none")

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(subset(grm_sho25, grm_sho25$Sample_mean_age_qualifier == "Exact"), aes(x = RelYear2, y = NumberMeasured_n, color = reefIDcrosswalk, shape = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw() +
  guides(color = FALSE) #+
  #theme(legend.position = "none")

```

<br><br><br>

##### Model Output {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- summary(grm_sho25_glmm) -->
<!-- ``` -->

<!-- <br><br><br> -->

###### Shell height 25-75mm

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(grm_sh25to75_glmm)
```

<br><br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(grm_sh25to75_glmm_hist)
```

<br><br><br>

###### Shell height >75mm

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(grm_sho75_glmm)
```

<br><br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(grm_sho75_glmm_hist)
```

<br><br><br>

##### Diagnostic Plots {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- Posterior distributions and Markov chains: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_GRM_PDistandMChains_o25 <- plot(grm_sho25_glmm) -->
<!-- SH_AllDates_GLMM_GRM_PDistandMChains_o25 -->

<!-- len <- length(SH_AllDates_GLMM_GRM_PDistandMChains_o25) -->
<!-- for(i in 1:len){ -->
<!--   jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_PDistandMChains_o25_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300) -->
<!--   print(SH_AllDates_GLMM_GRM_PDistandMChains_o25[i]) -->
<!--   dev.off() -->
<!-- } -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- Posterior predictive check plot: -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_GRM_PPcheck_o25 <- pp_check(grm_sho25_glmm) -->
<!-- SH_AllDates_GLMM_GRM_PPcheck_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_PPcheck_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_GRM_PPcheck_o25, -->
<!--        width = 4, -->
<!--        height = 3, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height 25-75mm

Posterior distributions and Markov chains:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_GRM_PDistandMChains_25to75 <- plot(grm_sh25to75_glmm)
SH_AllDates_GLMM_GRM_PDistandMChains_25to75

len <- length(SH_AllDates_GLMM_GRM_PDistandMChains_25to75)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_PDistandMChains_25to75_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_GRM_PDistandMChains_25to75[i])
  dev.off()
}
```

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_GRM_PDistandMChains_25to75_hist <- plot(grm_sh25to75_glmm_hist)
SH_AllDates_GLMM_GRM_PDistandMChains_25to75_hist

len <- length(SH_AllDates_GLMM_GRM_PDistandMChains_25to75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_PDistandMChains_25to75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_GRM_PDistandMChains_25to75_hist[i])
  dev.off()
}
```

<br><br>

Posterior predictive check plot:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_GRM_PPcheck_25to75 <- pp_check(grm_sh25to75_glmm)
SH_AllDates_GLMM_GRM_PPcheck_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_PPcheck_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GRM_PPcheck_25to75,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_GRM_PPcheck_25to75_hist <- tryCatch(pp_check(grm_sh25to75_glmm_hist),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_GRM_PPcheck_25to75_hist) == TRUE){
    SH_AllDates_GLMM_GRM_PPcheck_25to75_hist <- tryCatch(pp_check(grm_sh25to75_glmm_hist), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_GRM_PPcheck_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_PPcheck_25to75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GRM_PPcheck_25to75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Shell height >75mm

Posterior distributions and Markov chains:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_GRM_PDistandMChains_o75 <- plot(grm_sho75_glmm)
SH_AllDates_GLMM_GRM_PDistandMChains_o75

len <- length(SH_AllDates_GLMM_GRM_PDistandMChains_o75)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_PDistandMChains_o75_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_GRM_PDistandMChains_o75[i])
  dev.off()
}
```

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_GRM_PDistandMChains_o75_hist <- plot(grm_sho75_glmm_hist)
SH_AllDates_GLMM_GRM_PDistandMChains_o75_hist

len <- length(SH_AllDates_GLMM_GRM_PDistandMChains_o75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_PDistandMChains_o75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_GRM_PDistandMChains_o75_hist[i])
  dev.off()
}
```

<br><br>

Posterior predictive check plot:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_GRM_PPcheck_o75 <- pp_check(grm_sho75_glmm)
SH_AllDates_GLMM_GRM_PPcheck_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_PPcheck_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GRM_PPcheck_o75,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_GRM_PPcheck_o75_hist <- tryCatch(pp_check(grm_sho75_glmm_hist),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_GRM_PPcheck_o75_hist) == TRUE){
    SH_AllDates_GLMM_GRM_PPcheck_o75_hist <- tryCatch(pp_check(grm_sho75_glmm_hist), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_GRM_PPcheck_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_PPcheck_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GRM_PPcheck_o75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Marginal Effects Plots {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- Including the random effect of reef (i.e., managed area-wide credible interval): -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Marginal effects plot including random effects -->
<!-- grm_sho25_1 <- plot(conditional_effects(grm_sho25_glmm, re_formula = NULL), plot = FALSE)[[1]] -->
<!-- SH_AllDates_GLMM_GRM_MEPrand_o25 <- grm_sho25_1 + -->
<!--   geom_point(data = grm_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_GRM_MEPrand_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_MEPrand_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_GRM_MEPrand_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- Excluding the random effect of reef (i.e., sampled population credible interval): -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Marginal effects plot excluding random effects -->
<!-- grm_sho25_2 <- plot(conditional_effects(grm_sho25_glmm, re_formula = NA), plot = FALSE)[[1]] -->
<!-- SH_AllDates_GLMM_GRM_MEPnorand_o25 <- grm_sho25_2 + -->
<!--   geom_point(data = grm_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_GRM_MEPnorand_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_MEPnorand_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_GRM_MEPnorand_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- Individual effects plots: -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=50, fig.width=10, out.width="100%"} -->
<!-- #Individual effects plots -->
<!-- SH_AllDates_GLMM_GRM_IEP_o25 <- grm_sho25 %>% -->
<!--   group_by(reefIDcrosswalk) %>% -->
<!--   add_fitted_draws(grm_sho25_glmm) %>% -->
<!--   ggplot(aes(x = RelYear, y = ShellHeight_mm, color = reefIDcrosswalk)) + -->
<!--   stat_lineribbon(aes(y = .value), size = 1) + -->
<!--   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) + -->
<!--   geom_point(data = grm_sho25) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") + -->
<!--   #geom_line(aes(y = .value), linetype = "dashed", color = "black") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   #scale_color_brewer(palette = "Set2") + -->
<!--   theme_bw() + -->
<!--   facet_wrap(~ reefIDcrosswalk, ncol = 3) -->
<!-- SH_AllDates_GLMM_GRM_IEP_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_IEP_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_GRM_IEP_o25, -->
<!--        width = 10, -->
<!--        height = 30, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->


###### Shell height 25-75mm

<br>

Including the random effect of reef (i.e., managed area-wide credible interval):

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
#Marginal effects plot including random effects
labs1 <- sort(unique(grm_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))
labs2 <- sort(unique(grm_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]

set.seed(987)
grm_sh25to75_1 <- plot(conditional_effects(grm_sh25to75_glmm, re_formula = NULL), plot = FALSE)[[1]]
grm_sh25to75_hist_1 <- plot(conditional_effects(grm_sh25to75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]

SH_AllDates_GLMM_GRM_MEPrand_25to75 <- ggplot(grm_sh25to75_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = grm_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = grm_sh25to75_hist_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = grm_sh25to75_hist_1$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age %in% labs1), aes(y = 23, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age %in% labs2), aes(y = 21, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(20, 80))
SH_AllDates_GLMM_GRM_MEPrand_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_MEPrand_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GRM_MEPrand_25to75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
#Marginal effects plot excluding random effects
labs1 <- sort(unique(grm_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))
labs2 <- sort(unique(grm_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]

set.seed(765)
grm_sh25to75_2 <- plot(conditional_effects(grm_sh25to75_glmm, re_formula = NA), plot = FALSE)[[1]]
grm_sh25to75_hist_2 <- plot(conditional_effects(grm_sh25to75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]

SH_AllDates_GLMM_GRM_MEPnorand_25to75 <- ggplot(grm_sh25to75_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = grm_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = grm_sh25to75_hist_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = grm_sh25to75_hist_2$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age %in% labs1), aes(y = 23, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(grm_sh25to75, grm_sh25to75$Sample_mean_age %in% labs2), aes(y = 21, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(20, 80))
SH_AllDates_GLMM_GRM_MEPnorand_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_MEPnorand_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GRM_MEPnorand_25to75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br><br>

Individual effects plots:

<br>

Real-time data: 

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=50, fig.width=10, out.width="100%"}
#Individual effects plots

grm_sh25to75_rt <- subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier != "Estimate")

set.seed(987)
SH_AllDates_GLMM_GRM_IEP_25to75 <- grm_sh25to75_rt %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(grm_sh25to75_glmm) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = grm_sh25to75_rt) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = grm_sh25to75_rt, aes(y = 17, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sh25to75, gtmn_sh25to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(grm_sh25to75_rt$RelYear2) - 1, max(grm_sh25to75_rt$RelYear2) + 1)) +
  scale_y_continuous(limits = c(15, 80)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_GRM_IEP_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_IEP_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GRM_IEP_25to75,
       width = 10,
       height = 30,
       units = "in",
       dpi = 300)
```


<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}

labs1 <- sort(unique(grm_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs2 <- sort(unique(grm_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]

grm_sh25to75_h <- subset(grm_sh25to75, grm_sh25to75$Sample_mean_age_qualifier == "Estimate")

set.seed(876)
SH_AllDates_GLMM_GRM_IEP_25to75_hist <- grm_sh25to75_h %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(grm_sh25to75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = grm_sh25to75_h) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(grm_sh25to75_h, grm_sh25to75_h$Sample_mean_age %in% labs1), aes(y = 23, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(grm_sh25to75_h, grm_sh25to75_h$Sample_mean_age %in% labs2), aes(y = 21, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(grm_sh25to75, grm_sh25to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(grm_sh25to75_h$RelYear2) - 1, max(grm_sh25to75_h$RelYear2) + 1)) +
  scale_y_continuous(limits = c(15, 100)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")

#I am not sure why the stat_lineribbons are not showing.
SH_AllDates_GLMM_GRM_IEP_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_IEP_25to75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GRM_IEP_25to75_hist,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300, limitsize = FALSE)
```

<br><br><br>

###### Shell height >75mm

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
#Marginal effects plot including random effects
labs1 <- sort(unique(grm_sho75$Sample_mean_age))[c(TRUE, FALSE)]
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))
labs2 <- sort(unique(grm_sho75$Sample_mean_age))[c(FALSE, TRUE)]

set.seed(987)
grm_sho75_1 <- plot(conditional_effects(grm_sho75_glmm, re_formula = NULL), plot = FALSE)[[1]]
grm_sho75_hist_1 <- plot(conditional_effects(grm_sho75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]

SH_AllDates_GLMM_GRM_MEPrand_o75 <- ggplot(grm_sho75_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = grm_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = grm_sho75_hist_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = grm_sho75_hist_1$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(grm_sho75, grm_sho75$Sample_mean_age %in% labs1), aes(y = 72, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(grm_sho75, grm_sho75$Sample_mean_age %in% labs2), aes(y = 68, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(70, 250))
SH_AllDates_GLMM_GRM_MEPrand_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_MEPrand_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GRM_MEPrand_o75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
#Marginal effects plot excluding random effects
labs1 <- sort(unique(grm_sho75$Sample_mean_age))[c(TRUE, FALSE)]
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))
labs2 <- sort(unique(grm_sho75$Sample_mean_age))[c(FALSE, TRUE)]

set.seed(765)
grm_sho75_2 <- plot(conditional_effects(grm_sho75_glmm, re_formula = NA), plot = FALSE)[[1]]
grm_sho75_hist_2 <- plot(conditional_effects(grm_sho75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]

SH_AllDates_GLMM_GRM_MEPnorand_o75 <- ggplot(grm_sho75_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = grm_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = grm_sho75_hist_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = grm_sho75_hist_2$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(grm_sho75, grm_sho75$Sample_mean_age %in% labs1), aes(y = 72, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(grm_sho75, grm_sho75$Sample_mean_age %in% labs2), aes(y = 68, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(70, 250))
SH_AllDates_GLMM_GRM_MEPnorand_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_MEPnorand_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GRM_MEPnorand_o75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br><br>

Individual effects plots:

<br>

Real-time data: 

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=50, fig.width=10, out.width="100%"}
#Individual effects plots

grm_sho75_rt <- subset(grm_sho75, grm_sho75$Sample_mean_age_qualifier != "Estimate")

set.seed(987)
SH_AllDates_GLMM_GRM_IEP_o75 <- grm_sho75_rt %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(grm_sho75_glmm) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = grm_sho75_rt) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = grm_sho75_rt, aes(y = 67, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sho75, gtmn_sho75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(grm_sho75_rt$RelYear2) - 1, max(grm_sho75_rt$RelYear2) + 1)) +
  #scale_y_continuous(limits = c(70, 250)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_GRM_IEP_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_IEP_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GRM_IEP_o75,
       width = 10,
       height = 30,
       units = "in",
       dpi = 300)
```


<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=10, fig.width=10, out.width="100%"}

labs1 <- sort(unique(grm_sho75$Sample_mean_age))[c(TRUE, FALSE)]
labs2 <- sort(unique(grm_sho75$Sample_mean_age))[c(FALSE, TRUE)]

grm_sho75_h <- subset(grm_sho75, grm_sho75$Sample_mean_age_qualifier == "Estimate")

set.seed(876)
SH_AllDates_GLMM_GRM_IEP_o75_hist <- grm_sho75_h %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(grm_sho75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = grm_sho75_h) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(grm_sho75_h, grm_sho75_h$Sample_mean_age %in% labs1), aes(y = 73, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(grm_sho75_h, grm_sho75_h$Sample_mean_age %in% labs2), aes(y = 71, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(grm_sho75, grm_sho75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(grm_sho75_h$RelYear2) - 1, max(grm_sho75_h$RelYear2) + 1)) +
  #scale_y_continuous(limits = c(69, 160)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")

#I am not sure why the stat_lineribbons are not showing for all plots.
SH_AllDates_GLMM_GRM_IEP_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GRM_IEP_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GRM_IEP_o75_hist,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300, limitsize = FALSE)
```

```{r include=FALSE}
# Remove created objects to save memory.
rm(grm_sh25to75, grm_sh25to75_glmm, grm_sh25to75_glmm_hist,
   grm_sho75, grm_sho75_glmm, grm_sho75_glmm_hist, 
   SH_AllDates_GLMM_GRM_PDistandMChains_25to75, SH_AllDates_GLMM_GRM_PDistandMChains_o75,
   SH_AllDates_GLMM_GRM_PPcheck_25to75, SH_AllDates_GLMM_GRM_PPcheck_o75,
   SH_AllDates_GLMM_GRM_MEPrand_25to75, SH_AllDates_GLMM_GRM_MEPrand_o75,
   SH_AllDates_GLMM_GRM_MEPnorand_25to75, SH_AllDates_GLMM_GRM_MEPnorand_o75,
   SH_AllDates_GLMM_GRM_IEP_25to75, SH_AllDates_GLMM_GRM_IEP_o75
   )

```

<br><br><br>

#### Guana Tolomato Matanzas NERR_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

# gtmn_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Guana Tolomato Matanzas NERR_Natural")
# gtmn_sho25[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# gtmn_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# gtmn_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
# gtmn_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
# saveRDS(gtmn_sho25, here::here(paste0('GLMMs/AllDates/Data/gtmn_sho25_', Sys.Date(), '.rds')))
# 
# ggplot(subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = Region.y, color = reefIDcrosswalk)) +
#   geom_jitter() +
#   theme(legend.position = "none")
# 
# ggplot(subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
#   geom_jitter() +
#   theme(legend.position = "none")
# 
# ggplot(subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = NumberMeasured_n, color = reefIDcrosswalk)) +
#   geom_jitter() +
#   theme(legend.position = "none")
# 
# gtmn_sho25_glmm <- brm(formula = ShellHeight_mm ~ RelYear + QuadSize_m2 + NumberMeasured_n + LiveDate_Qualifier + Region.y + (1 + RelYear|reefIDcrosswalk), data = gtmn_sho25, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "log"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# gtmn_sho25_glmm <- add_criterion(gtmn_sho25_glmm, "loo")
# 
# gtmn_sho25_glmm1 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear2, data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control = list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sho25_glmm1.rds")
# gtmn_sho25_glmm1 <- add_criterion(gtmn_sho25_glmm1, "loo")
# 
# gtmn_sho25_glmm2 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear2 + NumberMeasured_n, data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control = list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sho25_glmm2.rds")
# gtmn_sho25_glmm2 <- add_criterion(gtmn_sho25_glmm2, "loo")
# 
# gtmn_sho25_glmm3 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear2 + Region.y, data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sho25_glmm3.rds")
# gtmn_sho25_glmm3 <- add_criterion(gtmn_sho25_glmm3, "loo")
# 
# gtmn_sho25_glmm4 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear2 + Region.y + (1 | reefIDcrosswalk), data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control = list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sho25_glmm4.rds")
# gtmn_sho25_glmm4 <- add_criterion(gtmn_sho25_glmm4, "loo")
# 
# gtmn_sho25_glmm5 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ RelYear2 + Region.y + (0 + RelYear2 | reefIDcrosswalk), data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control = list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sho25_glmm5.rds")
# gtmn_sho25_glmm5 <- add_criterion(gtmn_sho25_glmm5, "loo")
# 
# #GLMM? is the best model for the historical data
# loo_compare(gtmn_sho25_glmm1, gtmn_sho25_glmm2, gtmn_sho25_glmm3, gtmn_sho25_glmm4, gtmn_sho25_glmm5)
# 
# saveRDS(gtmn_sho25_glmm, here::here('GLMMs/AllDates/gtmn_sho25_glmm.rds'))
# 
# 
# gtmn_sho25_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ me(RelYear2, Sample_age_stdev), data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sho25_glmm_hist1.rds")
# gtmn_sho25_glmm_hist1 <- add_criterion(gtmn_sho25_glmm_hist1, "loo")
# 
# gtmn_sho25_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ me(RelYear2, Sample_age_stdev) + Region.y, data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sho25_glmm_hist2.rds")
# gtmn_sho25_glmm_hist2 <- add_criterion(gtmn_sho25_glmm_hist2, "loo")
# 
# gtmn_sho25_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ me(RelYear2, Sample_age_stdev) + Region.y + (1 | reefIDcrosswalk), data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sho25_glmm_hist3.rds")
# gtmn_sho25_glmm_hist3 <- add_criterion(gtmn_sho25_glmm_hist3, "loo")
# 
# gtmn_sho25_glmm_hist4 <- brm(formula = ShellHeight_mm | trunc(lb = 25) ~ me(RelYear2, Sample_age_stdev) + Region.y + (1 + RelYear2 | reefIDcrosswalk), data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sho25_glmm_hist4.rds")
# gtmn_sho25_glmm_hist4 <- add_criterion(gtmn_sho25_glmm_hist4, "loo")
# 
# #GLMM? is the best model for the historical data
# loo_compare(gtmn_sho25_glmm_hist1, gtmn_sho25_glmm_hist2, gtmn_sho25_glmm_hist3, gtmn_sho25_glmm_hist4)

```


```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

gtmn_sh25to75 <- subset(gtmn_sho25, gtmn_sho25$ShellHeight_mm < 75)
#gtmn_sh25to75[, QuadSize_m2 := as.numeric(QuadSize_m2)]
#gtmn_sh25to75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
#gtmn_sh25to75[, RelYear := LiveDate2 - min(LiveDate2)]
#gtmn_sh25to75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(gtmn_sh25to75, here::here(paste0('GLMMs/AllDates/Data/gtmn_sh25to75_', Sys.Date(), '.rds')))

ggplot(subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = Region.y, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = NumberMeasured_n, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier != "Estimate"), aes(x = NumberMeasured_n, y = Region.y, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

gtmn_sh25to75_glmm1 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2, data = subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sh25to75_glmm1.rds")
gtmn_sh25to75_glmm1 <- add_criterion(gtmn_sh25to75_glmm1, "loo")

gtmn_sh25to75_glmm2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + NumberMeasured_n, data = subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sh25to75_glmm2.rds")
gtmn_sh25to75_glmm2 <- add_criterion(gtmn_sh25to75_glmm2, "loo")

gtmn_sh25to75_glmm3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + Region.y, data = subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sh25to75_glmm3.rds")
gtmn_sh25to75_glmm3 <- add_criterion(gtmn_sh25to75_glmm3, "loo")

gtmn_sh25to75_glmm4 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + NumberMeasured_n + Region.y, data = subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sh25to75_glmm4.rds")
gtmn_sh25to75_glmm4 <- add_criterion(gtmn_sh25to75_glmm4, "loo")

gtmn_sh25to75_glmm5 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + NumberMeasured_n + Region.y + (1 | reefIDcrosswalk), data = subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sh25to75_glmm5.rds")
gtmn_sh25to75_glmm5 <- add_criterion(gtmn_sh25to75_glmm5, "loo")

gtmn_sh25to75_glmm6 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + NumberMeasured_n + Region.y + (0 + RelYear2 | reefIDcrosswalk), data = subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sh25to75_glmm6.rds")
gtmn_sh25to75_glmm6 <- add_criterion(gtmn_sh25to75_glmm6, "loo")

#Was taking a very long time to run and the gaussian models fit the data pretty well, so stopped this model and moved on.
gtmn_sh25to75_glmm7 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ RelYear2 + NumberMeasured_n + Region.y + (1 | reefIDcrosswalk), data = subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier != "Estimate"), family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "log"), cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/gtmn_sh25to75_glmm7.rds")
gtmn_sh25to75_glmm7 <- add_criterion(gtmn_sh25to75_glmm7, "loo")

#GLMM5 is the best model for the 25-75mm data
loo_compare(gtmn_sh25to75_glmm1, gtmn_sh25to75_glmm2, gtmn_sh25to75_glmm3, gtmn_sh25to75_glmm4, gtmn_sh25to75_glmm5, gtmn_sh25to75_glmm6)

#DID NOT CONVERGE
gtmn_sh25to75_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev), data = subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 12), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sh25to75_glmm_hist1.rds")
gtmn_sh25to75_glmm_hist1 <- add_criterion(gtmn_sh25to75_glmm_hist1, "loo")

#DID NOT CONVERGE
gtmn_sh25to75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + Region.y, data = subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sh25to75_glmm_hist2.rds")
gtmn_sh25to75_glmm_hist2 <- add_criterion(gtmn_sh25to75_glmm_hist2, "loo")

gtmn_sh25to75_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + Region.y + (1 | reefIDcrosswalk), data = subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(0,1)", class = "b"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sh25to75_glmm_hist3.rds")
gtmn_sh25to75_glmm_hist3 <- add_criterion(gtmn_sh25to75_glmm_hist3, "loo")

gtmn_sh25to75_glmm_hist4 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + Region.y + (1 + RelYear2 | reefIDcrosswalk), data = subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(0,1)", class = "b"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.9, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sh25to75_glmm_hist4.rds")
gtmn_sh25to75_glmm_hist4 <- add_criterion(gtmn_sh25to75_glmm_hist4, "loo")

#Previous two models converged quickly but I think had much too informative priors.
gtmn_sh25to75_glmm_hist5 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + Region.y + (1 + RelYear2 | reefIDcrosswalk), data = subset(gtmn_sh25to75, gtmn_sh25to75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,25)", class = "b"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.9, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sh25to75_glmm_hist5.rds")
gtmn_sh25to75_glmm_hist5 <- add_criterion(gtmn_sh25to75_glmm_hist5, "loo")

#GLMM5 is the best model for the historical data (among those with what I think are reasonable priors).
loo_compare(gtmn_sh25to75_glmm_hist1, gtmn_sh25to75_glmm_hist2, gtmn_sh25to75_glmm_hist3, gtmn_sh25to75_glmm_hist4, gtmn_sh25to75_glmm_hist5)

```


```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

gtmn_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Guana Tolomato Matanzas NERR_Natural")
gtmn_sho75[, QuadSize_m2 := as.numeric(QuadSize_m2)]
gtmn_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
gtmn_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
gtmn_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(gtmn_sho75, here::here(paste0('GLMMs/AllDates/Data/gtmn_sho75_', Sys.Date(), '.rds')))

gtmn_sho75_glmm <- brm(formula = ShellHeight_mm ~ RelYear + QuadSize_m2 + NumberMeasured_n + LiveDate_Qualifier + Region.y + (1 + RelYear|reefIDcrosswalk), data = gtmn_sho75, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "log"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
gtmn_sho75_glmm <- add_criterion(gtmn_sho75_glmm, "loo")


ggplot(subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = Region.y, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = NumberMeasured_n, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier != "Estimate"), aes(x = NumberMeasured_n, y = Region.y, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

gtmn_sho75_glmm1 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2, data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm1.rds")
gtmn_sho75_glmm1 <- add_criterion(gtmn_sho75_glmm1, "loo")

gtmn_sho75_glmm2 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ NumberMeasured_n, data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm2.rds")
gtmn_sho75_glmm2 <- add_criterion(gtmn_sho75_glmm2, "loo")

#DID NOT CONVERGE, BUT SEVERAL REGION.Y CI'S DID NOT INCLUDE ZERO.
gtmn_sho75_glmm3 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ Region.y, data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm3.rds")
gtmn_sho75_glmm3 <- add_criterion(gtmn_sho75_glmm3, "loo")

gtmn_sho75_glmm4_3 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + NumberMeasured_n + Region.y, data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, prior = set_prior("normal(171,10)", class = "b", lb = 0, ub = 175), cores = 4, control = list(adapt_delta = 0.9, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 80, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm4_3.rds")
gtmn_sho75_glmm4_3 <- add_criterion(gtmn_sho75_glmm4_3, "loo")

gtmn_sho75_glmm5 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + NumberMeasured_n + Region.y + (1 | reefIDcrosswalk), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, prior = c(set_prior("normal(171,10)", class = "b", coef = "RelYear2"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 80, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm5.rds")
gtmn_sho75_glmm5 <- add_criterion(gtmn_sho75_glmm5, "loo")

gtmn_sho75_glmm6 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + NumberMeasured_n + Region.y + (0 + RelYear2 | reefIDcrosswalk), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier != "Estimate"), family = gaussian, prior = c(set_prior("normal(171,10)", class = "b", coef = "RelYear2"), set_prior("cauchy(0,2)")), cores = 4, control = list(adapt_delta = 0.99, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 30, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm6.rds")
gtmn_sho75_glmm6 <- add_criterion(gtmn_sho75_glmm6, "loo")

#Model did not converge and the gaussian models fit the data pretty well according to pp_checks, so I did not re-try this model.
gtmn_sho75_glmm7 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2 + NumberMeasured_n + Region.y + (1 | reefIDcrosswalk), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier != "Estimate"), family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "log"), prior = c(set_prior("normal(171,10)", class = "b", coef = "RelYear2"), set_prior("cauchy(0,2)")), cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm7.rds")
gtmn_sho75_glmm7 <- add_criterion(gtmn_sho75_glmm7, "loo")

#GLMM6 is the best model for the >75mm data
loo_compare(gtmn_sho75_glmm1, gtmn_sho75_glmm2, gtmn_sho75_glmm3, gtmn_sho75_glmm4, gtmn_sho75_glmm5, gtmn_sho75_glmm6)

#Model failed to completely converge, but it came close and the RelYear term was significant, so I moved on.
gtmn_sho75_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("student_t(0.6, 160, 2)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 12), iter = 3000, warmup = 1000, chains = 4, inits = 80, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist1.rds")
gtmn_sho75_glmm_hist1 <- add_criterion(gtmn_sho75_glmm_hist1, "loo")

#Trying a student-t prior that is loosely based on a GAMLSS fit to the RelYear2 data, but with much greater sigma and df (assumed here that the order in parentheses is (df, mu, sigma), but this information was surprisingly hard to find.
gtmn_sho75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + Region.y, data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("student_t(10, 160, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier")), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 80, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist2.rds")
gtmn_sho75_glmm_hist2 <- add_criterion(gtmn_sho75_glmm_hist2, "loo")

#Previous model failed to converge, so I wrote it again with a broad normal prior, based on rNO (gamlss) fit to RelYear2. I ran the next model first though, with this same prior, in the interest of time.
gtmn_sho75_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + Region.y, data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146, 50)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 80, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist3.rds")
gtmn_sho75_glmm_hist3 <- add_criterion(gtmn_sho75_glmm_hist3, "loo")

#Model failed to converge
gtmn_sho75_glmm_hist4 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + Region.y + (1 | reefIDcrosswalk), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,50)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 80, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist4.rds")
gtmn_sho75_glmm_hist4 <- add_criterion(gtmn_sho75_glmm_hist4, "loo")

#Trying previous model again but with an upper bound of RelYear = 175 (i.e., Year = 2020) in the prior instead of specifying coef. Model failed to converge.
gtmn_sho75_glmm_hist5 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + Region.y + (1 | reefIDcrosswalk), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,50)", class = "b", ub = 175), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 80, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist5.rds")
gtmn_sho75_glmm_hist5 <- add_criterion(gtmn_sho75_glmm_hist5, "loo")

#Trying nested grouping variables rather than including Region.y as a fixed effect.
gtmn_sho75_glmm_hist6 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear2 | reefIDcrosswalk/Region.y), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,50)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 80, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist6.rds")
gtmn_sho75_glmm_hist6 <- add_criterion(gtmn_sho75_glmm_hist6, "loo")

#Previous model did not converge, so I am trying again without the RelYear prior.
gtmn_sho75_glmm_hist7 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear2 | reefIDcrosswalk/Region.y), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = set_prior("cauchy(0,2)", class = "sd"), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 80, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist7.rds")
gtmn_sho75_glmm_hist7 <- add_criterion(gtmn_sho75_glmm_hist7, "loo")

#Previous model did not converge, so I am starting again from an intercept model.
gtmn_sho75_glmm_hist8 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ 1, data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 80, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist8.rds")
gtmn_sho75_glmm_hist8 <- add_criterion(gtmn_sho75_glmm_hist8, "loo")

#Model did not completely converge, but RelYear was significant.
gtmn_sho75_glmm_hist9 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ RelYear2, data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 80, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist9.rds")
gtmn_sho75_glmm_hist9 <- add_criterion(gtmn_sho75_glmm_hist9, "loo")

#Trying a derivative of model 6 again with a more informative year prior, higher max_treedepth, more iterations, and a upper bound on ShellHeight_mm. Model did not converge.
gtmn_sho75_glmm_hist10 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear2 | reefIDcrosswalk/Region.y), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,25)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 20), iter = 4000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(3), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist10.rds")
gtmn_sho75_glmm_hist10 <- add_criterion(gtmn_sho75_glmm_hist10, "loo")

gtmn_sho75_glmm_hist11 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2, data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = set_prior("normal(146,25)", class = "b", coef = "RelYear2"), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 88, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist11.rds")
gtmn_sho75_glmm_hist11 <- add_criterion(gtmn_sho75_glmm_hist11, "loo")

#Examining the effect of a less informative prior on the previous fit (they were essentially identical).
gtmn_sho75_glmm_hist12 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2, data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = set_prior("normal(146,50)", class = "b", coef = "RelYear2"), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 88, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist12.rds")
gtmn_sho75_glmm_hist12 <- add_criterion(gtmn_sho75_glmm_hist12, "loo")

gtmn_sho75_glmm_hist13 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (1 | QuadIdentifier), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,50)", class = "b", coef = "RelYear2"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 88, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist13.rds")
gtmn_sho75_glmm_hist13 <- add_criterion(gtmn_sho75_glmm_hist13, "loo")

#Model did not converge, I think perhaps because RelYear and QuadIdentifier are confounded.
gtmn_sho75_glmm_hist14 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (1 + RelYear2 | QuadIdentifier), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,50)", class = "b", coef = "RelYear2"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 88, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist14.rds")
gtmn_sho75_glmm_hist14 <- add_criterion(gtmn_sho75_glmm_hist14, "loo")

gtmn_sho75_glmm_hist15 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (1 | QuadIdentifier/reefIDcrosswalk), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,50)", class = "b", coef = "RelYear2")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 88, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist15.rds")
gtmn_sho75_glmm_hist15 <- add_criterion(gtmn_sho75_glmm_hist15, "loo")

#Model did not converge.
gtmn_sho75_glmm_hist16 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (1 | QuadIdentifier/reefIDcrosswalk/Region.y) + (0 + RelYear2 | reefIDcrosswalk/Region.y), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,50)", class = "b", coef = "RelYear2")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 88, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist16.rds")
gtmn_sho75_glmm_hist16 <- add_criterion(gtmn_sho75_glmm_hist16, "loo")

#Model did not converge.
gtmn_sho75_glmm_hist17 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (0 + RelYear2 | reefIDcrosswalk/Region.y), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,50)", class = "b", coef = "RelYear2"), set_prior("cauchy(0,2)", class = "sd")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 88, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist17.rds")
gtmn_sho75_glmm_hist17 <- add_criterion(gtmn_sho75_glmm_hist17, "loo")

#Model nearly converged.
gtmn_sho75_glmm_hist18 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (1 | reefIDcrosswalk/Region.y), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,50)", class = "b", coef = "RelYear2")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 88, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist18.rds")
gtmn_sho75_glmm_hist18 <- add_criterion(gtmn_sho75_glmm_hist18, "loo")

#Model did not converge.
gtmn_sho75_glmm_hist19 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (1 | reefIDcrosswalk/Region.y), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,25)", class = "b", coef = "RelYear2")), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 88, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist19.rds")
gtmn_sho75_glmm_hist19 <- add_criterion(gtmn_sho75_glmm_hist19, "loo")

gtmn_sho75_glmm_hist20 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + Region.y + (1 | reefIDcrosswalk), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,25)", class = "b", coef = "RelYear2")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist20.rds")
gtmn_sho75_glmm_hist20 <- add_criterion(gtmn_sho75_glmm_hist20, "loo")

gtmn_sho75_glmm_hist21 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + Region.y + (1 + RelYear2 | reefIDcrosswalk), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,25)", class = "b", coef = "RelYear2")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist21.rds")
gtmn_sho75_glmm_hist21 <- add_criterion(gtmn_sho75_glmm_hist21, "loo")

#Model 21 but including the RelYear measurement error
gtmn_sho75_glmm_hist22 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + Region.y + (1 + RelYear2 | reefIDcrosswalk), data = subset(gtmn_sho75, gtmn_sho75$LiveDate_Qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(146,25)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier")), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_sho75_glmm_hist22.rds")
gtmn_sho75_glmm_hist22 <- add_criterion(gtmn_sho75_glmm_hist22, "loo")

#Fit #22 makes the most sense.
#GLMM4 is the best model for the historical data
#loo_compare(gtmn_sho75_glmm_hist1, gtmn_sho75_glmm_hist2, gtmn_sho75_glmm_hist3, gtmn_sho75_glmm_hist4)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
gtmn_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Guana Tolomato Matanzas NERR_Natural")
gtmn_sho25[, QuadSize_m2 := as.factor(QuadSize_m2)]
gtmn_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
gtmn_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
gtmn_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
gtmn_sho25[ProgramID == 4000 & LiveDate2 == 2015, NumberMeasured_n := "50"]
saveRDS(gtmn_sho25, here::here(paste0('GLMMs/AllDates/Data/gtmn_sho25_', Sys.Date(), '.rds')))

#gtmn_sho25_glmm <- readRDS(here::here('GLMMs/AllDates/gtmn_sho25_glmm.rds'))

gtmn_sh25to75 <- subset(gtmn_sho25, gtmn_sho25$ShellHeight_mm < 75)
saveRDS(gtmn_sh25to75, here::here(paste0('GLMMs/AllDates/Data/gtmn_sh25to75_', Sys.Date(), '.rds')))

gtmn_sh25to75_glmm <- readRDS(here::here('GLMMs/AllDates/gtmn_sh25to75_glmm6.rds'))
gtmn_sh25to75_glmm_hist <- readRDS(here::here("GLMMs/AllDates/gtmn_sh25to75_glmm_hist5.rds"))

gtmn_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Guana Tolomato Matanzas NERR_Natural")
gtmn_sho75[, QuadSize_m2 := as.numeric(QuadSize_m2)]
gtmn_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
gtmn_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
gtmn_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(gtmn_sho75, here::here(paste0('GLMMs/AllDates/Data/gtmn_sho75_', Sys.Date(), '.rds')))

gtmn_sho75_glmm <- readRDS(here::here('GLMMs/AllDates/gtmn_sho75_glmm6.rds'))
gtmn_sho75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/gtmn_sho75_glmm_hist22.rds'))

```

##### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

gtmn_sho25[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
gtmn_sho25[, SampleDay := day(SampleDate)]

if(length(subset(gtmn_sho25, gtmn_sho25$Sample_mean_age_qualifier == "Exact")$ShellHeight_mm) > 0){
  sh_t <- copy(gtmn_sho25[0, ])
  sh_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
  for(i in unique(as.numeric(gtmn_sho25$Month))){
    mo <- subset(gtmn_sho25, as.numeric(gtmn_sho25$Month) == i)
    ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
           ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                  ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                         ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                                ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                       ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                              ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                     ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                            ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                   ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                          ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
    sh_t <- rbind(mo, sh_t)
  }
  
  monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))
  
  #Create the sampling dates correspondence plot
  SampleDatesPlot <- ggplot(subset(sh_t, sh_t$LiveDate_Qualifier == "Exact"), aes(x = DayNum, y = as.factor(ProgramID), color = Year, shape = Season)) +
                        geom_point(size = 3) +
                        geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                        geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                        xlim(1,365) +
                        scale_x_continuous(breaks = NULL) +
                        coord_cartesian(xlim = c(1, 366)) +
                        theme_bw()+labs(x = "Sample Date", y = "Program ID")
  print(SampleDatesPlot)
  
  #Remove the objects after the plot is done.
  rm(sh_t, monthnames, SampleDatesPlot)

} else{
  
  print("There are no real-time data for this managed area.")
  
}

```

<br><br><br>

##### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_specimens = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for size class 25-75mm first.
sh25to75_status <- subset(gtmn_sh25to75, gtmn_sh25to75$Sample_mean_age %in% StatusYears)
sh25to75_status[, `:=` (Indicator = "Size Class", 
                        SizeClass = "25-75mm", 
                        Year = as.numeric(Sample_mean_age), 
                        n_reefs = length(unique(ReefIdentifier)),
                        n_programs = length(unique(ProgramID)),
                        ProgIDs = list(unique(ProgramID)),
                        n_specimens = length(ShellHeight_mm),
                        Median = median(ShellHeight_mm),
                        Mean = round(mean(ShellHeight_mm), digits = 2),
                        SD = round(sd(ShellHeight_mm), digits = 2), 
                        Min. = min(ShellHeight_mm),
                        Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sh25to75_status <- unique(sh25to75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sh25to75_status <- sh25to75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sh25to75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sh25to75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = "25-75mm",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sh25to75_status <- rbind(sh25to75_status, MissingYr_i)
  }
}

#Build status table for size class >75mm next.
sho75_status <- subset(gtmn_sho75, gtmn_sho75$Sample_mean_age %in% StatusYears)
sho75_status[, `:=` (Indicator = "Size Class", 
                     SizeClass = ">75mm", 
                     Year = as.numeric(Sample_mean_age), 
                     n_reefs = length(unique(ReefIdentifier)),
                     n_programs = length(unique(ProgramID)),
                     ProgIDs = list(unique(ProgramID)),
                     n_specimens = length(ShellHeight_mm),
                     Median = median(ShellHeight_mm),
                     Mean = round(mean(ShellHeight_mm), digits = 2),
                     SD = round(sd(ShellHeight_mm), digits = 2), 
                     Min. = min(ShellHeight_mm),
                     Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sho75_status <- unique(sho75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sho75_status <- sho75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sho75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sho75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = ">75mm",
                              Year = i,
                              n_reefs = ifelse(sh25to75_status[Year == i, n_reefs] > 0, sh25to75_status[Year == i, n_reefs], 0),
                              n_programs = ifelse(sh25to75_status[Year == i, n_programs] > 0, sh25to75_status[Year == i, n_programs], 0),
                              ProgIDs = ifelse(!is.na(sh25to75_status[Year == i, ProgIDs]), sh25to75_status[Year == i, ProgIDs], NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sho75_status <- rbind(sho75_status, MissingYr_i)
  }
}

#Merge individual size class tables and set row order
Status <- rbind(Status, sh25to75_status)
Status <- rbind(Status, sho75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) %>%
  kable_styling() %>%
  row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, sh25to75_status, MissingYr_i, sho75_status)
```

<br><br><br>

##### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = Region.y, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
ggplot(subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = NumberMeasured_n, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate"), aes(x = NumberMeasured_n, y = Region.y, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")
```

<br><br>

For the years and reefs for which both 50 spec and ALL spec were measured, it does look like shell height in the n=50 samples tends to be larger than when all specimens are measured (selection bias against smaller, harder to see specimens?). The pattern is there both when the n=50 samples were from the summer and n=ALL were from the winter and vice versa. For what it's worth, the final plot shows that when ShellHeight_mm is compared within 2016 across all monitored reefs, the median and quartiles are quite close (includes most months of the year). These findings suggest perhaps it would be good to try dropping the n=50 samples from the models, but then we would drop below 5 years of real-time data overall, the threshold for triggering a trend analysis for SEACAR.

<br>

```{r echo=TRUE, message=FALSE, warning=FALSE, out.width="100%"}
gtmn_sho25[, RelYrMo := paste0(RelYear2, "_", Month)]
commonreefs14to15 <- intersect(unique(subset(gtmn_sho25, gtmn_sho25$RelYear2 == 169)$reefIDcrosswalk), 
                         unique(subset(gtmn_sho25, gtmn_sho25$RelYrMo %in% c("170_1", "170_2"))$reefIDcrosswalk))

commonreefs15to16 <- intersect(unique(subset(gtmn_sho25, gtmn_sho25$RelYrMo %in% c("170_6", "170_7", "170_8", "170_9", "170_12", "171_1", "171_2", "171_3") & gtmn_sho25$NumberMeasured_n == "50")$reefIDcrosswalk), 
                         unique(subset(gtmn_sho25, gtmn_sho25$RelYrMo %in% c("170_6", "170_7", "170_8", "170_9", "170_12", "171_1", "171_2", "171_3") & gtmn_sho25$NumberMeasured_n == "ALL")$reefIDcrosswalk))

commonreefs16to16 <- intersect(unique(subset(gtmn_sho25, gtmn_sho25$RelYear2 == 171 & gtmn_sho25$NumberMeasured_n == "50")$reefIDcrosswalk), 
                         unique(subset(gtmn_sho25, gtmn_sho25$RelYear2 == 171 & gtmn_sho25$NumberMeasured_n == "ALL")$reefIDcrosswalk))
```

There are no reefs in common between Programs 4000 and 5017, which both monitored in GTM during July and August of 2016 (measuring ALL live oysters and up to 50 live oysters, respectively). This would have been the only comparison of NumberMeasured_n without being confounded with season.

<br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
#There are no reefs in common between Programs 4000 and 5017, which both monitored in GTM during July and August of 2016 (measuring ALL live oysters and up to 50 live oysters, respectively). This would have been the only comparison of NumberMeasured_n without being confounded with season.
intersect(unique(subset(gtmn_sho25, gtmn_sho25$LiveDate2 == 2016 & gtmn_sho25$ProgramID == 4000 & gtmn_sho25$reefIDcrosswalk %in% commonreefs16to16)$Month), unique(subset(gtmn_sho25, gtmn_sho25$LiveDate2 == 2016 & gtmn_sho25$ProgramID == 5017 & gtmn_sho25$reefIDcrosswalk %in% commonreefs16to16)$Month))
```

<br>

Summer 2014 vs Winter 2015

```{r echo=TRUE, message=FALSE, warning=FALSE, out.width="100%"}
#Summer 2014 vs Winter 2015
ggplot(subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate" & gtmn_sho25$RelYrMo %in% c("169_5", "169_10", "169_6", "169_7", "170_1", "170_2") & gtmn_sho25$reefIDcrosswalk %in% commonreefs14to15), aes(fill = NumberMeasured_n)) +
  geom_jitter(aes(x = RelYear2, y = ShellHeight_mm, color = NumberMeasured_n, shape = Month)) +
  geom_boxplot(data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate" & gtmn_sho25$RelYrMo %in% c("169_5", "169_10", "169_6", "169_7", "170_1", "170_2") & gtmn_sho25$NumberMeasured_n == "50" & gtmn_sho25$reefIDcrosswalk %in% commonreefs14to15), aes(x = 172, y = ShellHeight_mm), alpha = 0.5) +
  geom_boxplot(data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate" & gtmn_sho25$RelYrMo %in% c("169_5", "169_10", "169_6", "169_7", "170_1", "170_2") & gtmn_sho25$NumberMeasured_n == "ALL" & gtmn_sho25$reefIDcrosswalk %in% commonreefs14to15), aes(x = 171, y = ShellHeight_mm), alpha = 0.5) +
  facet_wrap(~ as.factor(reefIDcrosswalk)) #+
  #theme(legend.position = "none")
```

<br><br>

Summer 2015 vs Winter 2016

```{r echo=TRUE, message=FALSE, warning=FALSE, out.width="100%"}
#Summer 2015 vs Winter 2016
ggplot(subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate" & gtmn_sho25$RelYrMo %in% c("170_6", "170_7", "170_8", "170_9", "170_12", "171_1", "171_2", "171_3") & gtmn_sho25$reefIDcrosswalk %in% commonreefs15to16), aes(fill = NumberMeasured_n)) +
  geom_jitter(aes(x = RelYear2, y = ShellHeight_mm, color = NumberMeasured_n, shape = Month)) +
  geom_boxplot(data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate" & gtmn_sho25$RelYrMo %in% c("170_6", "170_7", "170_8", "170_9", "170_12", "171_1", "171_2", "171_3") & gtmn_sho25$NumberMeasured_n == "50" & gtmn_sho25$reefIDcrosswalk %in% commonreefs15to16), aes(x = 172, y = ShellHeight_mm), alpha = 0.5) +
  geom_boxplot(data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate" & gtmn_sho25$RelYrMo %in% c("170_6", "170_7", "170_8", "170_9", "170_12", "171_1", "171_2", "171_3") & gtmn_sho25$NumberMeasured_n == "ALL" & gtmn_sho25$reefIDcrosswalk %in% commonreefs15to16), aes(x = 173, y = ShellHeight_mm), alpha = 0.5) +
  facet_wrap(~ as.factor(reefIDcrosswalk)) #+
  #theme(legend.position = "none")
```

<br><br>

Winter 2016 vs Summer 2016

```{r echo=TRUE, message=FALSE, warning=FALSE, out.width="100%"}
#Winter 2016 vs Summer 2016
ggplot(subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate" & gtmn_sho25$RelYear2 == 171 & gtmn_sho25$reefIDcrosswalk %in% commonreefs16to16), aes(fill = NumberMeasured_n)) +
  geom_jitter(aes(x = RelYear2, y = ShellHeight_mm, color = NumberMeasured_n, shape = Month)) +
  geom_boxplot(data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate" & gtmn_sho25$RelYear2 == 171 & gtmn_sho25$NumberMeasured_n == "50" & gtmn_sho25$reefIDcrosswalk %in% commonreefs16to16), aes(x = 172, y = ShellHeight_mm), alpha = 0.5) +
  geom_boxplot(data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate" & gtmn_sho25$RelYear2 == 171 & gtmn_sho25$NumberMeasured_n == "ALL" & gtmn_sho25$reefIDcrosswalk %in% commonreefs16to16), aes(x = 173, y = ShellHeight_mm), alpha = 0.5) +
  facet_wrap(~ as.factor(reefIDcrosswalk)) #+
  #theme(legend.position = "none")
```

<br><br>

All 2016

```{r echo=TRUE, message=FALSE, warning=FALSE, out.width="100%"}
#All 2016
ggplot(subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate" & gtmn_sho25$RelYear2 == 171), aes(fill = NumberMeasured_n)) +
  geom_jitter(aes(x = RelYear2, y = ShellHeight_mm, color = Month, shape = NumberMeasured_n), size = 2, alpha = 0.75, width = 6, inherit.aes = FALSE) +
  geom_boxplot(data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate" & gtmn_sho25$RelYear2 == 171 & gtmn_sho25$NumberMeasured_n == "50"), aes(x = 178, y = ShellHeight_mm), alpha = 0.5) +
  geom_boxplot(data = subset(gtmn_sho25, gtmn_sho25$LiveDate_Qualifier != "Estimate" & gtmn_sho25$RelYear2 == 171 & gtmn_sho25$NumberMeasured_n == "ALL"), aes(x = 179, y = ShellHeight_mm), alpha = 0.5) #+
  #facet_wrap(~ as.factor(reefIDcrosswalk)) +
  #guides(color = FALSE)
```

<br><br><br>

##### Model Output {.tabset .tabset-fade .tabset-pills}


```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
###### Shell height >25mm

#summary(gtmn_sho25_glmm)
```

<!-- <br><br><br> -->

###### Shell height 25-75mm

Real-time data:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
summary(gtmn_sh25to75_glmm)
```

<br><br>

Historical data:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
summary(gtmn_sh25to75_glmm_hist)
```

<br><br><br>

###### Shell height >75mm

Real-time data:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
summary(gtmn_sho75_glmm)
```

<br><br>

Historical data:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
summary(gtmn_sho75_glmm_hist)
```

<br><br><br>

##### Diagnostic Plots {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
###### Shell height >25mm

#Posterior distributions and Markov chains:

SH_AllDates_GLMM_GTMNERR_PDistandMChains_o25 <- plot(gtmn_sho25_glmm)
SH_AllDates_GLMM_GTMNERR_PDistandMChains_o25

len <- length(SH_AllDates_GLMM_GTMNERR_PDistandMChains_o25)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_PDistandMChains_o25_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_GTMNERR_PDistandMChains_o25[i])
  dev.off()
}
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
#<br><br><br>

#Posterior predictive check plot:

SH_AllDates_GLMM_GTMNERR_PPcheck_o25 <- pp_check(gtmn_sho25_glmm)
SH_AllDates_GLMM_GTMNERR_PPcheck_o25

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_PPcheck_o25_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_PPcheck_o25,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)

#<br><br><br>
```



###### Shell height 25-75mm

Posterior distributions and Markov chains:

<br>

Real-time data:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="100%"}
SH_AllDates_GLMM_GTMNERR_PDistandMChains_25to75 <- plot(gtmn_sh25to75_glmm)
SH_AllDates_GLMM_GTMNERR_PDistandMChains_25to75

len <- length(SH_AllDates_GLMM_GTMNERR_PDistandMChains_25to75)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_PDistandMChains_25to75_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_GTMNERR_PDistandMChains_25to75[i])
  dev.off()
}
```

<br>

Historical data:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="100%"}
SH_AllDates_GLMM_GTMNERR_PDistandMChains_25to75_hist <- plot(gtmn_sh25to75_glmm_hist)
SH_AllDates_GLMM_GTMNERR_PDistandMChains_25to75_hist

len <- length(SH_AllDates_GLMM_GTMNERR_PDistandMChains_25to75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_PDistandMChains_25to75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_GTMNERR_PDistandMChains_25to75_hist[i])
  dev.off()
}
```

<br><br>

Posterior predictive check plot:

<br>

Real-time data:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
SH_AllDates_GLMM_GTMNERR_PPcheck_25to75 <- pp_check(gtmn_sh25to75_glmm)
SH_AllDates_GLMM_GTMNERR_PPcheck_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_PPcheck_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_PPcheck_25to75,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br>

Historical data:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
SH_AllDates_GLMM_GTMNERR_PPcheck_25to75_hist <- tryCatch(pp_check(gtmn_sh25to75_glmm_hist),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_GTMNERR_PPcheck_25to75_hist) == TRUE){
    SH_AllDates_GLMM_GTMNERR_PPcheck_25to75_hist <- tryCatch(pp_check(gtmn_sh25to75_glmm_hist), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_GTMNERR_PPcheck_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_PPcheck_25to75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_PPcheck_25to75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>


###### Shell height >75mm

Posterior distributions and Markov chains:

<br>

Real-time data:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
SH_AllDates_GLMM_GTMNERR_PDistandMChains_o75 <- plot(gtmn_sho75_glmm)
SH_AllDates_GLMM_GTMNERR_PDistandMChains_o75

len <- length(SH_AllDates_GLMM_GTMNERR_PDistandMChains_o75)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_PDistandMChains_o75_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_GTMNERR_PDistandMChains_o75[i])
  dev.off()
}
```

<br>

Historical data:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
SH_AllDates_GLMM_GTMNERR_PDistandMChains_o75_hist <- plot(gtmn_sho75_glmm_hist)
SH_AllDates_GLMM_GTMNERR_PDistandMChains_o75_hist

len <- length(SH_AllDates_GLMM_GTMNERR_PDistandMChains_o75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_PDistandMChains_o75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_GTMNERR_PDistandMChains_o75_hist[i])
  dev.off()
}
```

<br><br>

Posterior predictive check plot:

<br>

Real-time data:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
SH_AllDates_GLMM_GTMNERR_PPcheck_o75 <- tryCatch(pp_check(gtmn_sho75_glmm),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_GTMNERR_PPcheck_o75) == TRUE){
    SH_AllDates_GLMM_GTMNERR_PPcheck_o75 <- tryCatch(pp_check(gtmn_sho75_glmm), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_GTMNERR_PPcheck_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_PPcheck_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_PPcheck_o75,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br>

Historical data:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
SH_AllDates_GLMM_GTMNERR_PPcheck_o75_hist <- tryCatch(pp_check(gtmn_sho75_glmm_hist),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_GTMNERR_PPcheck_o75_hist) == TRUE){
    SH_AllDates_GLMM_GTMNERR_PPcheck_o75_hist <- tryCatch(pp_check(gtmn_sho75_glmm_hist), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_GTMNERR_PPcheck_o75_hist


ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_PPcheck_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_PPcheck_o75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Marginal Effects Plots {.tabset .tabset-fade .tabset-pills}


```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}

# ###### Shell height >25mm
# 
# #Including the random effect of reef (i.e., managed area-wide credible interval):
#   
# #Marginal effects plot including random effects
# gtmn_sho25_1 <- plot(conditional_effects(gtmn_sho25_glmm, re_formula = NULL), plot = FALSE)[[1]]
# SH_AllDates_GLMM_GTMNERR_MEPrand_o25 <- gtmn_sho25_1 +
#   geom_point(data = gtmn_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# SH_AllDates_GLMM_GTMNERR_MEPrand_o25
# 
# ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_MEPrand_o25_", Sys.Date(), ".jpeg")),
#        SH_AllDates_GLMM_GTMNERR_MEPrand_o25,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# ```
# 
# 
# ```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #<br><br><br>
# 
# #Excluding the random effect of reef (i.e., sampled population credible interval):
# 
# #Marginal effects plot excluding random effects
# gtmn_sho25_2 <- plot(conditional_effects(gtmn_sho25_glmm, re_formula = NA), plot = FALSE)[[1]]
# SH_AllDates_GLMM_GTMNERR_MEPnorand_o25 <- gtmn_sho25_2 +
#   geom_point(data = gtmn_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# SH_AllDates_GLMM_GTMNERR_MEPnorand_o25
# 
# ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_MEPnorand_o25_", Sys.Date(), ".jpeg")),
#        SH_AllDates_GLMM_GTMNERR_MEPnorand_o25,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# ```
# 
# 
# ```{r eval=FALSE, fig.height=50, fig.width=10, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #<br><br><br>
# 
# #Individual effects plots:
# 
# #Individual effects plots
# SH_AllDates_GLMM_GTMNERR_IEP_o25 <- gtmn_sho25 %>%
#   group_by(reefIDcrosswalk) %>%
#   add_fitted_draws(gtmn_sho25_glmm) %>%
#   ggplot(aes(x = RelYear, y = ShellHeight_mm, color = reefIDcrosswalk)) +
#   stat_lineribbon(aes(y = .value), size = 1) +
#   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
#   geom_point(data = gtmn_sho25) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
#   #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
#   scale_fill_brewer(palette = "Greys") +
#   #scale_color_brewer(palette = "Set2") +
#   theme_bw() +
#   facet_wrap(~ reefIDcrosswalk, ncol = 3)
# SH_AllDates_GLMM_GTMNERR_IEP_o25
# 
# ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_IEP_o25_", Sys.Date(), ".jpeg")),
#        SH_AllDates_GLMM_GTMNERR_IEP_o25,
#        width = 10,
#        height = 30,
#        units = "in",
#        dpi = 300)

#<br><br><br>
```


###### Shell height 25-75mm

<br>

Including the random effect of reef (i.e., managed area-wide credible interval):

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
labs1 <- sort(unique(gtmn_sh25to75$Sample_mean_age))#[c(TRUE, FALSE)]
labs1 <- labs1[seq(1, length(labs1), 4)]
labs1 <- append(labs1, c(1954))
labs1 <- labs1[c(-3, -4, -6)]
#labs2 <- sort(unique(gtmn_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]

set.seed(987)
gtmn_sh25to75_1 <- plot(conditional_effects(gtmn_sh25to75_glmm, re_formula = NULL), plot = FALSE)[[1]]
gtmn_sh25to75_hist <- plot(conditional_effects(gtmn_sh25to75_glmm_hist, re_formula = NULL), plot = FALSE)[[2]]

SH_AllDates_GLMM_GTMNERR_MEPrand_25to75 <- ggplot(gtmn_sh25to75_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = gtmn_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = Region.y), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = gtmn_sh25to75_hist$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = gtmn_sh25to75_hist$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(gtmn_sh25to75, gtmn_sh25to75$Sample_mean_age %in% labs1), aes(y = 22, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
    #geom_text(data = subset(gtmn_sh25to75, gtmn_sh25to75$Sample_mean_age %in% labs2), aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Region") +
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(20, 80))
SH_AllDates_GLMM_GTMNERR_MEPrand_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_MEPrand_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_MEPrand_25to75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br>

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
meanSH_test_hist <- plot(conditional_effects(gtmn_sh25to75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]$data
meanSH_test <- plot(conditional_effects(gtmn_sh25to75_glmm, re_formula = NULL), plot = FALSE)[[3]]$data
meanSH_test_hist$data <- "Historical data"
meanSH_test$data <- "Real-time data"
meanSH <- rbind(meanSH_test[, c("effect1__", "estimate__", "se__", "lower__", "upper__", "data")],
                meanSH_test_hist[, c("effect1__", "estimate__", "se__", "lower__", "upper__", "data")])
setnames(meanSH, c("effect1__"), c("Region"))

SH_AllDates_GLMM_GTMNERR_MEPrand_25to75_MeanRes <- ggplot(meanSH, aes(x = Region, y = estimate__, ymin = lower__, ymax = upper__, fill = data)) +
  geom_pointinterval(position = position_jitter(width = 0.35, height = 0), size = 3, fatten_point = 4, shape = 21, color = "black") +
  ylab("ShellHeight_mm | trunc(lb = 25, ub = 75)") +
  theme_bw()  + 
  theme(axis.title = element_text(size = 13), 
        axis.text = element_text(size = 12), 
        legend.text = element_text(size = 12), 
        legend.title = element_text(size = 13), 
        axis.text.x = element_text(angle = 90))+labs(fill = NULL)
SH_AllDates_GLMM_GTMNERR_MEPrand_25to75_MeanRes

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_MEPrand_25to75_MeanRes_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_MEPrand_25to75_MeanRes,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects

#gtmn_sh25to75_2 <- plot(conditional_effects(gtmn_sh25to75_glmm, re_formula = NA), plot = FALSE)[[1]]
#SH_AllDates_GLMM_GTMNERR_MEPnorand_25to75 <- gtmn_sh25to75_2 +
#  geom_point(data = gtmn_sh25to75, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, #color = "black", inherit.aes = FALSE) +
#  theme_bw()

labs1 <- sort(unique(gtmn_sh25to75$Sample_mean_age))#[c(TRUE, FALSE)]
labs1 <- labs1[seq(1, length(labs1), 4)]
labs1 <- append(labs1, c(1954))
#labs2 <- sort(unique(gtmn_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]

set.seed(988)
gtmn_sh25to75_2 <- plot(conditional_effects(gtmn_sh25to75_glmm, re_formula = NA), plot = FALSE)[[1]]
gtmn_sh25to75_hist_2 <- plot(conditional_effects(gtmn_sh25to75_glmm_hist, re_formula = NA), plot = FALSE)[[2]]

SH_AllDates_GLMM_GTMNERR_MEPnorand_25to75 <- ggplot(gtmn_sh25to75_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = gtmn_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = Region.y), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = gtmn_sh25to75_hist_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = gtmn_sh25to75_hist_2$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(gtmn_sh25to75, gtmn_sh25to75$Sample_mean_age %in% labs1), aes(y = 22, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
    #geom_text(data = subset(gtmn_sh25to75, gtmn_sh25to75$Sample_mean_age %in% labs2), aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Region") +
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(20, 80))
SH_AllDates_GLMM_GTMNERR_MEPnorand_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_MEPnorand_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_MEPnorand_25to75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br><br>

Individual effects plots:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"}
#Individual effects plots

#labs1 <- sort(unique(gtmn_sh25to75$Sample_mean_age))#[c(TRUE, FALSE)]
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))

gtmn_sh25to75_rt <- subset(gtmn_sh25to75, gtmn_sh25to75$Sample_mean_age_qualifier != "Estimate")

SH_AllDates_GLMM_GTMNERR_IEP_25to75 <- gtmn_sh25to75_rt %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(gtmn_sh25to75_glmm) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = Region.y)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = gtmn_sh25to75_rt) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = gtmn_sh25to75_rt, aes(y = 20, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sh25to75, gtmn_sh25to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(gtmn_sh25to75_rt$RelYear2) - 1, max(gtmn_sh25to75_rt$RelYear2) + 1)) +
  scale_y_continuous(limits = c(15, 75)) +
  #theme(legend.position = "none") +
  #labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_GTMNERR_IEP_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_IEP_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_IEP_25to75,
       width = 10,
       height = 80,
       units = "in",
       dpi = 300, limitsize = FALSE)
```

<br><br><br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=10, fig.width=10, out.width="100%"}

labs1 <- sort(unique(gtmn_sh25to75$Sample_mean_age))[c(TRUE, FALSE)]
labs2 <- sort(unique(gtmn_sh25to75$Sample_mean_age))[c(FALSE, TRUE)]

gtmn_sh25to75_h <- subset(gtmn_sh25to75, gtmn_sh25to75$Sample_mean_age_qualifier == "Estimate")

set.seed(987)
SH_AllDates_GLMM_GTMNERR_IEP_25to75_hist <- gtmn_sh25to75_h %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(gtmn_sh25to75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = Region.y)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = gtmn_sh25to75_h) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(gtmn_sh25to75_h, gtmn_sh25to75_h$Sample_mean_age %in% labs1), aes(y = 23, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(gtmn_sh25to75_h, gtmn_sh25to75_h$Sample_mean_age %in% labs2), aes(y = 19, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sh25to75, gtmn_sh25to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  #scale_x_continuous(limits = c(min(gtmn_sh25to75_h$RelYear2) - 1, max(gtmn_sh25to75_h$RelYear2) + 1)) +
  #scale_y_continuous(limits = c(10, 90)) +
  #theme(legend.position = "none") +
  #labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_GTMNERR_IEP_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_IEP_25to75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_IEP_25to75_hist,
       width = 10,
       height = 10,
       units = "in",
       dpi = 300, limitsize = FALSE)
```

<br><br><br>

###### Shell height >75mm

<br>

Including the random effect of reef (i.e., managed area-wide credible interval):

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
labs1 <- sort(unique(gtmn_sho75$Sample_mean_age))#[c(TRUE, FALSE)]
labs1 <- labs1[seq(1, length(labs1), 4)]
labs1 <- append(labs1, c(1954))
#labs2 <- sort(unique(gtmn_sho75$Sample_mean_age))[c(FALSE, TRUE)]

set.seed(987)
gtmn_sho75_1 <- plot(conditional_effects(gtmn_sho75_glmm, re_formula = NULL), plot = FALSE)[[1]]
gtmn_sho75_hist <- plot(conditional_effects(gtmn_sho75_glmm_hist, re_formula = NULL), plot = FALSE)[[2]]

SH_AllDates_GLMM_GTMNERR_MEPrand_o75 <- ggplot(gtmn_sho75_1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = gtmn_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = Region.y), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = gtmn_sho75_hist$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = gtmn_sho75_hist$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(gtmn_sho75, gtmn_sho75$Sample_mean_age %in% labs1), aes(y = 70, label = Sample_mean_age, x = RelYear2), size = 4, col = "grey30", inherit.aes = FALSE) +
    #geom_text(data = subset(gtmn_sho75, gtmn_sho75$Sample_mean_age %in% labs2), aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Region") +
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(70, 250))
SH_AllDates_GLMM_GTMNERR_MEPrand_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_MEPrand_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_MEPrand_o75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br>

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
meanSH_test_hist2 <- plot(conditional_effects(gtmn_sho75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]$data
meanSH_test2 <- plot(conditional_effects(gtmn_sho75_glmm, re_formula = NULL), plot = FALSE)[[3]]$data
meanSH_test_hist2$data <- "Historical data"
meanSH_test2$data <- "Real-time data"
meanSH2 <- rbind(meanSH_test2[, c("effect1__", "estimate__", "se__", "lower__", "upper__", "data")],
                meanSH_test_hist2[, c("effect1__", "estimate__", "se__", "lower__", "upper__", "data")])
setnames(meanSH2, c("effect1__"), c("Region"))

SH_AllDates_GLMM_GTMNERR_MEPrand_o75_MeanRes <- ggplot(meanSH2, aes(x = Region, y = estimate__, ymin = lower__, ymax = upper__, fill = data)) +
  geom_pointinterval(position = position_jitter(width = 0.35, height = 0), size = 3, fatten_point = 4, shape = 21, color = "black") +
  ylab("ShellHeight_mm | trunc(lb = 75, ub = 250)") +
  theme_bw()  + 
  theme(axis.title = element_text(size = 13), 
        axis.text = element_text(size = 12), 
        legend.text = element_text(size = 12), 
        legend.title = element_text(size = 13),
        axis.text.x = element_text(angle = 90)) #+labs(fill = NULL)
SH_AllDates_GLMM_GTMNERR_MEPrand_o75_MeanRes

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_MEPrand_o75_MeanRes_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_MEPrand_o75_MeanRes,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
labs1 <- sort(unique(gtmn_sho75$Sample_mean_age))#[c(TRUE, FALSE)]
labs1 <- labs1[seq(1, length(labs1), 4)]
labs1 <- append(labs1, c(1954))
#labs2 <- sort(unique(gtmn_sho75$Sample_mean_age))[c(FALSE, TRUE)]

set.seed(988)
gtmn_sho75_2 <- plot(conditional_effects(gtmn_sho75_glmm, re_formula = NA), plot = FALSE)[[1]]
gtmn_sho75_hist_2 <- plot(conditional_effects(gtmn_sho75_glmm_hist, re_formula = NA), plot = FALSE)[[2]]

SH_AllDates_GLMM_GTMNERR_MEPnorand_o75 <- ggplot(gtmn_sho75_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_point(data = gtmn_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "blue", lwd = 1) +
  geom_ribbon(data = gtmn_sho75_hist_2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  geom_line(data = gtmn_sho75_hist_2$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(gtmn_sho75, gtmn_sho75$Sample_mean_age %in% labs1), aes(y = 70, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
    #geom_text(data = subset(gtmn_sho75, gtmn_sho75$Sample_mean_age %in% labs2), aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") +
  theme(legend.position = "none") +
  coord_cartesian(ylim = c(70, 250))
SH_AllDates_GLMM_GTMNERR_MEPnorand_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_MEPnorand_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_MEPnorand_o75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br>

Individual effects plots:

<br>

Real-time data:

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"}
#Individual effects plots

#labs1 <- sort(unique(gtmn_sho75$Sample_mean_age))#[c(TRUE, FALSE)]
#labs1 <- labs1[seq(1, length(labs1), 4)]
#labs1 <- append(labs1, c(1954))

gtmn_sho75_rt <- subset(gtmn_sho75, gtmn_sho75$Sample_mean_age_qualifier != "Estimate")

SH_AllDates_GLMM_GTMNERR_IEP_o75 <- gtmn_sho75_rt %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(gtmn_sho75_glmm) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = Region.y)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = gtmn_sho75_rt) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = gtmn_sho75_rt, aes(y = 71, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sho75, gtmn_sho75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(gtmn_sho75_rt$RelYear2) - 1, max(gtmn_sho75_rt$RelYear2) + 1)) +
  scale_y_continuous(limits = c(70, 250)) +
  #theme(legend.position = "none") +
  #labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_GTMNERR_IEP_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_IEP_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_IEP_o75,
       width = 10,
       height = 80,
       units = "in",
       dpi = 300, limitsize = FALSE)
```

<br>

Historical data:

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=10, fig.width=10, out.width="100%"}

labs1 <- sort(unique(gtmn_sho75$Sample_mean_age))[c(TRUE, FALSE)]
labs2 <- sort(unique(gtmn_sho75$Sample_mean_age))[c(FALSE, TRUE)]

gtmn_sho75_h <- subset(gtmn_sho75, gtmn_sho75$Sample_mean_age_qualifier == "Estimate")

set.seed(987)
SH_AllDates_GLMM_GTMNERR_IEP_o75_hist <- gtmn_sho75_h %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(gtmn_sho75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = Region.y)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = gtmn_sho75_h) + #aes(fill = Region.y), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(gtmn_sho75_h, gtmn_sho75_h$Sample_mean_age %in% labs1), aes(y = 23, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(gtmn_sho75_h, gtmn_sho75_h$Sample_mean_age %in% labs2), aes(y = 19, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sho75, gtmn_sho75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  #scale_x_continuous(limits = c(min(gtmn_sho75_h$RelYear2) - 1, max(gtmn_sho75_h$RelYear2) + 1)) +
  #scale_y_continuous(limits = c(10, 90)) +
  #theme(legend.position = "none") +
  #labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
SH_AllDates_GLMM_GTMNERR_IEP_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_GTMNERR_IEP_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_GTMNERR_IEP_o75_hist,
       width = 10,
       height = 10,
       units = "in",
       dpi = 300, limitsize = FALSE)
```

<!-- <br><br><br> -->

```{r include=FALSE}
# Remove created objects to save memory.
rm(gtmn_sh25to75, gtmn_sh25to75_glmm, 
   gtmn_sh25to75_hist, gtmn_sho75_glmm_hist, 
   SH_AllDates_GLMM_GTMNERR_PDistandMChains_sh25to75, SH_AllDates_GLMM_GTMNERR_PDistandMChains_o75,
   SH_AllDates_GLMM_GTMNERR_PDistandMChains_sh25to75_hist, SH_AllDates_GLMM_GTMNERR_PDistandMChains_o75_hist,
   SH_AllDates_GLMM_GTMNERR_PPcheck_sh25to75, SH_AllDates_GLMM_GTMNERR_PPcheck_o75,
   SH_AllDates_GLMM_GTMNERR_PPcheck_sh25to75_hist, SH_AllDates_GLMM_GTMNERR_PPcheck_o75_hist,
   SH_AllDates_GLMM_GTMNERR_MEPrand_sh25to75, SH_AllDates_GLMM_GTMNERR_MEPrand_o75,
   SH_AllDates_GLMM_GTMNERR_MEPnorand_sh25to75, SH_AllDates_GLMM_GTMNERR_MEPnorand_o75,
   SH_AllDates_GLMM_GTMNERR_IEP_sh25to75, SH_AllDates_GLMM_GTMNERR_IEP_o75,
   SH_AllDates_GLMM_GTMNERR_IEP_sh25to75_hist, SH_AllDates_GLMM_GTMNERR_IEP_o75_hist
   )

```

<br><br><br>


#### Indian River-Vero Beach to Ft. Pierce_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

# irvbfp_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural")
# irvbfp_sho25[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# irvbfp_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# #irvbfp_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
# irvbfp_sho25[, RelYear := Sample_mean_age - min(Sample_mean_age)]
# saveRDS(irvbfp_sho25, here::here(paste0('GLMMs/AllDates/Data/irvbfp_sho25_', Sys.Date(), '.rds')))
# 
# irvbfp_sho25_glmm <- brm(formula = ShellHeight_mm ~ me(RelYear, Sample_age_stdev) + QuadSize_m2 + NumberMeasured_n + LiveDate_Qualifier + (1 + RelYear|reefIDcrosswalk), data = irvbfp_sho25, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "log"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# irvbfp_sho25_glmm <- add_criterion(irvbfp_sho25_glmm, "loo")
# 
# #TEST LME, BASED ON MODEL KML USED FOR SAV BB DATA
# #Using untransformed shell heights, the residuals were not normal (SEP3-distributed), so tried again with log-transformed sH
# irvbfp_sho25[, logSH := log(ShellHeight_mm)]
# 
# #Let's try a mixed effects model to look for a trend.
# #First row: Model BB over year
# #Second row: vary slope and intercept of Year by ProgramLocationID
# #Third row: omit NA's
# #Fourth row: get the data from this dataset
# ctrl <- lmeControl(opt='optim')
# modelirvbfp_sho25 <- lme(logSH ~ RelYear,
#                          random = ~ RelYear | reefIDcrosswalk,
#                          #na.action = na.omit,
#                          control = ctrl,
#                          data = irvbfp_sho25)
# 
# #plot histogram of residuals to check for normality
# hist(resid(modelirvbfp_sho25))
# fitDist(resid(modelirvbfp_sho25))
# histDist(resid(modelirvbfp_sho25), family = "NO")
# #plot residuals
# plot(modelirvbfp_sho25)
# 
# #print coefficients. Estimate tells you the trend, eg here, for every year you expect a .01%
# #decrease. P-value shows (if) it is significant
# piecewiseSEM::coefs(modelirvbfp_sho25)
# irvbfp_sho25_coefs<-piecewiseSEM::coefs(modelirvbfp_sho25)
# piecewiseSEM::rsquared(modelirvbfp_sho25)
# 
# #plot the actual model to visualize what the Estimate and p-value told you
# library(effects)
# plot(effect("RelYear", modelirvbfp_sho25))
# 
# 
# saveRDS(irvbfp_sho25_glmm, here::here('GLMMs/AllDates/irvbfp_sho25_glmm.rds'))
```


```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

irvbfp_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural")
irvbfp_sho25[, QuadSize_m2 := as.numeric(QuadSize_m2)]
irvbfp_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
irvbfp_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
irvbfp_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]

irvbfp_sh25to75 <- subset(irvbfp_sho25, irvbfp_sho25$ShellHeight_mm < 75)
saveRDS(irvbfp_sh25to75, here::here(paste0('GLMMs/AllDates/Data/irvbfp_sh25to75_', Sys.Date(), '.rds')))

ggplot(irvbfp_sh25to75, aes(x = RelYear2, y = factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(subset(irvbfp_sh25to75, irvbfp_sh25to75$Sample_mean_age_qualifier == "Estimate"), aes(x = RelYear2, y = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(irvbfp_sh25to75, aes(x = RelYear2, y = factor(NumberMeasured_n), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(irvbfp_sh25to75, aes(x = RelYear2, y = Sample_mean_age_qualifier, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(irvbfp_sh25to75, aes(x = RelYear2, y = Sample_age_stdev, color = reefIDcrosswalk)) +
  geom_jitter() +
  geom_smooth(aes(x = RelYear2, y = Sample_age_stdev), method = "lm", inherit.aes = FALSE) +
  theme(legend.position = "none")
summary(lm(Sample_age_stdev ~ RelYear2, data = irvbfp_sh25to75))

irvbfp_sh25to75_glmm1 <- brm(formula = ShellHeight_mm ~ RelYear2 + QuadSize_m2 + NumberMeasured_n + LiveDate_Qualifier + (1 + RelYear|reefIDcrosswalk), data = irvbfp_sho75, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
irvbfp_sho75_glmm <- add_criterion(irvbfp_sho75_glmm, "loo")

irvbfp_sh25to75_glmm1 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ 1, data = subset(irvbfp_sh25to75, irvbfp_sh25to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sh25to75_glmm1.rds")
irvbfp_sh25to75_glmm1 <- add_criterion(irvbfp_sh25to75_glmm1, "loo")

#Model converged; RelYear was significant.
irvbfp_sh25to75_glmm2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(irvbfp_sh25to75, irvbfp_sh25to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = set_prior("normal(113, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sh25to75_glmm2.rds")
irvbfp_sh25to75_glmm2 <- add_criterion(irvbfp_sh25to75_glmm2, "loo")

#Model converged.
irvbfp_sh25to75_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = subset(irvbfp_sh25to75, irvbfp_sh25to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = set_prior("normal(113, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sh25to75_glmm_hist3.rds")
irvbfp_sh25to75_glmm_hist3 <- add_criterion(irvbfp_sh25to75_glmm_hist3, "loo")

#This model did not converge; possibly too few RelYears per reefID?
irvbfp_sh25to75_glmm4 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 + RelYear2 | reefIDcrosswalk), data = subset(irvbfp_sh25to75, irvbfp_sh25to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = set_prior("normal(113, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sh25to75_glmm4.rds")
irvbfp_sh25to75_glmm4 <- add_criterion(irvbfp_sh25to75_glmm4, "loo")

#GLMM 1 is the best fit, but it is just the intercept model, so model 3 is the one to go with.
loo_compare(irvbfp_sh25to75_glmm1, irvbfp_sh25to75_glmm2, irvbfp_sh25to75_glmm3, irvbfp_sh25to75_glmm4)

```


```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

irvbfp_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural")
irvbfp_sho75[, QuadSize_m2 := as.numeric(QuadSize_m2)]
irvbfp_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
irvbfp_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
irvbfp_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(irvbfp_sho75, here::here(paste0('GLMMs/AllDates/Data/irvbfp_sho75_', Sys.Date(), '.rds')))

ggplot(subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age_qualifier == "Estimate"), aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age_qualifier == "Estimate"), aes(x = factor(RelYear2), y = reefIDcrosswalk, color = ShellHeight_mm)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

irvbfp_sho75_glmm <- brm(formula = ShellHeight_mm ~ RelYear + QuadSize_m2 + NumberMeasured_n + LiveDate_Qualifier + (1 + RelYear|reefIDcrosswalk), data = irvbfp_sho75, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
irvbfp_sho75_glmm <- add_criterion(irvbfp_sho75_glmm, "loo")

#Converged. Intercept significant.
irvbfp_sho75_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ 1, data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sho75_glmm_hist1.rds")
irvbfp_sho75_glmm_hist1 <- add_criterion(irvbfp_sho75_glmm_hist1, "loo")

#Model did not converge.
irvbfp_sho75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = set_prior("normal(113, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sho75_glmm_hist2.rds")
irvbfp_sho75_glmm_hist2 <- add_criterion(irvbfp_sho75_glmm_hist2, "loo")

#Model did not converge with the measurement error, but it does converge without the measurement error.
irvbfp_sho75_glmm_hist2b <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2, data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sho75_glmm_hist2b.rds")
irvbfp_sho75_glmm_hist2b <- add_criterion(irvbfp_sho75_glmm_hist2b, "loo")

#Model did not converge
irvbfp_sho75_glmm_hist2c <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = set_prior("normal(79, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sho75_glmm_hist2c.rds")
irvbfp_sho75_glmm_hist2c <- add_criterion(irvbfp_sho75_glmm_hist2c, "loo")

#Converged!
irvbfp_sho75_glmm_hist2d <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sho75_glmm_hist2d.rds")
irvbfp_sho75_glmm_hist2d <- add_criterion(irvbfp_sho75_glmm_hist2d, "loo")

#Trying GLMM 2d again with the prior back in, because I was having an error with pp_check ("NAs not allowed in 'yrep'.") that apparently is related to brms not being able to evaluate predictions properly at lower bound (https://discourse.mc-stan.org/t/bugs-for-pp-check-brms-to-emmeans-communication-and-strange-features/10115). The model did not converge with this prior.
irvbfp_sho75_glmm_hist2e <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = set_prior("normal(79, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sho75_glmm_hist2e.rds")
irvbfp_sho75_glmm_hist2e <- add_criterion(irvbfp_sho75_glmm_hist2e, "loo")

#Model converged.
irvbfp_sho75_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = set_prior("normal(79, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 5000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sho75_glmm_hist3.rds")
irvbfp_sho75_glmm_hist3 <- add_criterion(irvbfp_sho75_glmm_hist3, "loo")

#Tried adding a prior for "sd". Model did not converge.
irvbfp_sho75_glmm_hist4 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = c(set_prior("normal(79, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), set_prior("cauchy(0,10)", class = "sd")), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 20), iter = 3000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sho75_glmm_hist4.rds")
irvbfp_sho75_glmm_hist4 <- add_criterion(irvbfp_sho75_glmm_hist4, "loo")

#One or two model chains kept getting stuck.
irvbfp_sho75_glmm_hist5 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear2 | reefIDcrosswalk), data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, prior = set_prior("normal(79, 30)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 20), iter = 3000, warmup = 1000, chains = 4, inits = 80, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sho75_glmm_hist5.rds")
irvbfp_sho75_glmm_hist5 <- add_criterion(irvbfp_sho75_glmm_hist5, "loo")

irvbfp_sho75_glmm_hist6 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (1 | reefIDcrosswalk), data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 5000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sho75_glmm_hist6.rds")
irvbfp_sho75_glmm_hist6 <- add_criterion(irvbfp_sho75_glmm_hist6, "loo")

#Model did not converge, though came close (Rhats < 2).
irvbfp_sho75_glmm_hist7 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (0 + RelYear2 | reefIDcrosswalk), data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 5000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/irvbfp_sho75_glmm_hist7.rds")
irvbfp_sho75_glmm_hist7 <- add_criterion(irvbfp_sho75_glmm_hist7, "loo")

#GLMM 1 is the best fit of the models that converged, but it is the intercept model, so I am going with the best fit model that included the RelYear parameter of interest (GLMM 3). When I re-ran GLMM 3 it did not converge, so I may have gotten lucky the first time. A similar model to GLMM 4 fit (measurement error and RelYear prior removed) did converge (i.e., GLMM 6), so that is the one I have gone with just for illustrative purposes.
loo_compare(irvbfp_sho75_glmm_hist1, irvbfp_sho75_glmm_hist2d, irvbfp_sho75_glmm_hist3)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
irvbfp_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural")
irvbfp_sho25[, QuadSize_m2 := as.numeric(QuadSize_m2)]
irvbfp_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
irvbfp_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
irvbfp_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]

irvbfp_sh25to75 <- subset(irvbfp_sho25, irvbfp_sho25$ShellHeight_mm < 75)
saveRDS(irvbfp_sh25to75, here::here(paste0('GLMMs/AllDates/Data/irvbfp_sh25to75_', Sys.Date(), '.rds')))

irvbfp_sh25to75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/irvbfp_sh25to75_glmm_hist3.rds'))

irvbfp_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural")
irvbfp_sho75[, QuadSize_m2 := as.numeric(QuadSize_m2)]
irvbfp_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
irvbfp_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
irvbfp_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(irvbfp_sho75, here::here(paste0('GLMMs/AllDates/Data/irvbfp_sho75_', Sys.Date(), '.rds')))

irvbfp_sho75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/irvbfp_sho75_glmm_hist6.rds'))

```

##### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

irvbfp_sho25[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
irvbfp_sho25[, SampleDay := day(SampleDate)]

if(length(subset(irvbfp_sho25, irvbfp_sho25$Sample_mean_age_qualifier == "Exact")$ShellHeight_mm) > 0){
  sh_t <- copy(irvbfp_sho25[0, ])
  sh_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
  for(i in unique(as.numeric(irvbfp_sho25$Month))){
    mo <- subset(irvbfp_sho25, as.numeric(irvbfp_sho25$Month) == i)
    ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
           ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                  ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                         ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                                ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                       ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                              ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                     ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                            ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                   ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                          ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
    sh_t <- rbind(mo, sh_t)
  }
  
  monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))
  
  #Create the sampling dates correspondence plot
  SampleDatesPlot <- ggplot(subset(sh_t, sh_t$LiveDate_Qualifier == "Exact"), aes(x = DayNum, y = as.factor(ProgramID), color = Year, shape = Season)) +
                        geom_point(size = 3) +
                        geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                        geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                        xlim(1,365) +
                        scale_x_continuous(breaks = NULL) +
                        coord_cartesian(xlim = c(1, 366)) +
                        theme_bw()+labs(x = "Sample Date", y = "Program ID")
  print(SampleDatesPlot)
  
  #Remove the objects after the plot is done.
  rm(sh_t, monthnames, SampleDatesPlot)

} else{
  
  print("There are no real-time data for this managed area.")
  
}

```

<br><br><br>

##### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_specimens = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for size class 25-75mm first.
sh25to75_status <- subset(irvbfp_sh25to75, irvbfp_sh25to75$Sample_mean_age %in% StatusYears)
sh25to75_status[, `:=` (Indicator = "Size Class", 
                        SizeClass = "25-75mm", 
                        Year = as.numeric(Sample_mean_age), 
                        n_reefs = length(unique(ReefIdentifier)),
                        n_programs = length(unique(ProgramID)),
                        ProgIDs = list(unique(ProgramID)),
                        n_specimens = length(ShellHeight_mm),
                        Median = median(ShellHeight_mm),
                        Mean = round(mean(ShellHeight_mm), digits = 2),
                        SD = round(sd(ShellHeight_mm), digits = 2), 
                        Min. = min(ShellHeight_mm),
                        Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sh25to75_status <- unique(sh25to75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sh25to75_status <- sh25to75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sh25to75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sh25to75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = "25-75mm",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sh25to75_status <- rbind(sh25to75_status, MissingYr_i)
  }
}

#Build status table for size class >75mm next.
sho75_status <- subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age %in% StatusYears)
sho75_status[, `:=` (Indicator = "Size Class", 
                     SizeClass = ">75mm", 
                     Year = as.numeric(Sample_mean_age), 
                     n_reefs = length(unique(ReefIdentifier)),
                     n_programs = length(unique(ProgramID)),
                     ProgIDs = list(unique(ProgramID)),
                     n_specimens = length(ShellHeight_mm),
                     Median = median(ShellHeight_mm),
                     Mean = round(mean(ShellHeight_mm), digits = 2),
                     SD = round(sd(ShellHeight_mm), digits = 2), 
                     Min. = min(ShellHeight_mm),
                     Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sho75_status <- unique(sho75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sho75_status <- sho75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sho75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sho75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = ">75mm",
                              Year = i,
                              n_reefs = ifelse(sh25to75_status[Year == i, n_reefs] > 0, sh25to75_status[Year == i, n_reefs], 0),
                              n_programs = ifelse(sh25to75_status[Year == i, n_programs] > 0, sh25to75_status[Year == i, n_programs], 0),
                              ProgIDs = ifelse(!is.na(sh25to75_status[Year == i, ProgIDs]), sh25to75_status[Year == i, ProgIDs], NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sho75_status <- rbind(sho75_status, MissingYr_i)
  }
}

#Merge individual size class tables and set row order
Status <- rbind(Status, sh25to75_status)
Status <- rbind(Status, sho75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) %>%
  kable_styling() %>%
  row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, sh25to75_status, MissingYr_i, sho75_status)
```

<br><br><br>

##### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(irvbfp_sho25, aes(x = RelYear2, y = factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(subset(irvbfp_sho25, irvbfp_sho25$Sample_mean_age_qualifier == "Estimate"), aes(x = RelYear2, y = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")
```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(irvbfp_sho25, aes(x = RelYear2, y = factor(NumberMeasured_n), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(irvbfp_sho25, aes(x = RelYear2, y = Sample_mean_age_qualifier, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")
```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
ggplot(irvbfp_sho25, aes(x = RelYear2, y = Sample_age_stdev, color = reefIDcrosswalk)) +
  geom_jitter() +
  geom_smooth(aes(x = RelYear2, y = Sample_age_stdev), method = "lm", inherit.aes = FALSE) +
  theme(legend.position = "none")

summary(lm(Sample_age_stdev ~ RelYear2, data = irvbfp_sho25))
```

<br><br><br>

##### Model Output {.tabset .tabset-fade .tabset-pills}


<!-- ```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"} -->
<!-- ###### Shell height >25mm -->

<!-- #summary(irvbfp_sho25_glmm) -->
<!-- ``` -->

###### Shell height 25-75mm

```{r echo=TRUE, message=FALSE, warning=FALSE, out.width="100%"}
summary(irvbfp_sh25to75_glmm_hist)
```

<br><br><br>

###### Shell height >75mm

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(irvbfp_sho75_glmm_hist)
```

<br><br><br>

##### Diagnostic Plots {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
###### Shell height >25mm

# Posterior distributions and Markov chains:
# 
# SH_AllDates_GLMM_IRVBFP_PDistandMChains_o25 <- plot(irvbfp_sho25_glmm)
# SH_AllDates_GLMM_IRVBFP_PDistandMChains_o25
# 
# len <- length(SH_AllDates_GLMM_IRVBFP_PDistandMChains_o25)
# for(i in 1:len){
#   jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_PDistandMChains_o25_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
#   print(SH_AllDates_GLMM_IRVBFP_PDistandMChains_o25[i])
#   dev.off()
# }
# 
# <br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# Posterior predictive check plot:
# 
# SH_AllDates_GLMM_IRVBFP_PPcheck_o25 <- pp_check(irvbfp_sho25_glmm)
# SH_AllDates_GLMM_IRVBFP_PPcheck_o25
# 
# ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_PPcheck_o25_", Sys.Date(), ".jpeg")),
#        SH_AllDates_GLMM_IRVBFP_PPcheck_o25,
#        width = 4,
#        height = 3,
#        units = "in",
#        dpi = 300)
# 
# <br><br><br>
```


###### Shell height 25-75mm

<br>

Posterior distributions and Markov chains:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_IRVBFP_PDistandMChains_25to75 <- plot(irvbfp_sh25to75_glmm_hist)
SH_AllDates_GLMM_IRVBFP_PDistandMChains_25to75

len <- length(SH_AllDates_GLMM_IRVBFP_PDistandMChains_25to75)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_PDistandMChains_25to75_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_IRVBFP_PDistandMChains_25to75[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}

SH_AllDates_GLMM_IRVBFP_PPcheck_25to75 <- tryCatch(pp_check(irvbfp_sh25to75_glmm_hist),
                                                   error = function(e) NA)
while(is.na(SH_AllDates_GLMM_IRVBFP_PPcheck_25to75) == TRUE){
    SH_AllDates_GLMM_IRVBFP_PPcheck_25to75 <- tryCatch(pp_check(irvbfp_sh25to75_glmm_hist), 
                                                       error = function(e) NA)}
SH_AllDates_GLMM_IRVBFP_PPcheck_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_PPcheck_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_IRVBFP_PPcheck_25to75,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Shell height >75mm

<br>

Posterior distributions and Markov chains:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_IRVBFP_PDistandMChains_o75 <- plot(irvbfp_sho75_glmm_hist)
SH_AllDates_GLMM_IRVBFP_PDistandMChains_o75

len <- length(SH_AllDates_GLMM_IRVBFP_PDistandMChains_o75)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_PDistandMChains_o75_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_IRVBFP_PDistandMChains_o75[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_IRVBFP_PPcheck_o75 <- pp_check(irvbfp_sho75_glmm_hist)
SH_AllDates_GLMM_IRVBFP_PPcheck_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_PPcheck_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_IRVBFP_PPcheck_o75,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Marginal Effects Plots {.tabset .tabset-fade .tabset-pills}

<!-- ```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"} -->
<!-- # ###### Shell height >25mm -->
<!-- #  -->
<!-- # Including the random effect of reef (i.e., managed area-wide credible interval): -->
<!-- #  -->
<!-- # #Marginal effects plot including random effects -->
<!-- # irvbfp_sho25_1 <- plot(conditional_effects(irvbfp_sho25_glmm, re_formula = NULL), plot = FALSE)[[1]] -->
<!-- # SH_AllDates_GLMM_IRVBFP_MEPrand_o25 <- irvbfp_sho25_1 + -->
<!-- #   geom_point(data = irvbfp_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!-- #   theme_bw() -->
<!-- # SH_AllDates_GLMM_IRVBFP_MEPrand_o25 -->
<!-- #  -->
<!-- # ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_MEPrand_o25_", Sys.Date(), ".jpeg")), -->
<!-- #        SH_AllDates_GLMM_IRVBFP_MEPrand_o25, -->
<!-- #        width = 10, -->
<!-- #        height = 6, -->
<!-- #        units = "in", -->
<!-- #        dpi = 300) -->
<!-- #  -->
<!-- # <br><br><br> -->
<!-- ``` -->

<!-- ```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"} -->
<!-- # Excluding the random effect of reef (i.e., sampled population credible interval): -->
<!-- #  -->
<!-- # #Marginal effects plot excluding random effects -->
<!-- # irvbfp_sho25_2 <- plot(conditional_effects(irvbfp_sho25_glmm, re_formula = NA), plot = FALSE)[[1]] -->
<!-- # SH_AllDates_GLMM_IRVBFP_MEPnorand_o25 <- irvbfp_sho25_2 + -->
<!-- #   geom_point(data = irvbfp_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!-- #   theme_bw() -->
<!-- # SH_AllDates_GLMM_IRVBFP_MEPnorand_o25 -->
<!-- #  -->
<!-- # ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_MEPnorand_o25_", Sys.Date(), ".jpeg")), -->
<!-- #        SH_AllDates_GLMM_IRVBFP_MEPnorand_o25, -->
<!-- #        width = 10, -->
<!-- #        height = 6, -->
<!-- #        units = "in", -->
<!-- #        dpi = 300) -->
<!-- #  -->
<!-- # <br><br><br> -->
<!-- ``` -->

<!-- ```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"} -->
<!-- # Individual effects plots: -->
<!-- #  -->
<!-- # #Individual effects plots -->
<!-- # SH_AllDates_GLMM_IRVBFP_IEP_o25 <- irvbfp_sho25 %>% -->
<!-- #   group_by(reefIDcrosswalk) %>% -->
<!-- #   add_fitted_draws(irvbfp_sho25_glmm) %>% -->
<!-- #   ggplot(aes(x = RelYear, y = ShellHeight_mm, color = reefIDcrosswalk)) + -->
<!-- #   stat_lineribbon(aes(y = .value), size = 1) + -->
<!-- #   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) + -->
<!-- #   geom_point(data = irvbfp_sho25) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") + -->
<!-- #   #geom_line(aes(y = .value), linetype = "dashed", color = "black") + -->
<!-- #   scale_fill_brewer(palette = "Greys") + -->
<!-- #   #scale_color_brewer(palette = "Set2") + -->
<!-- #   theme_bw() + -->
<!-- #   facet_wrap(~ reefIDcrosswalk, ncol = 3) -->
<!-- # SH_AllDates_GLMM_IRVBFP_IEP_o25 -->
<!-- #  -->
<!-- # ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_IEP_o25_", Sys.Date(), ".jpeg")), -->
<!-- #        SH_AllDates_GLMM_IRVBFP_IEP_o25, -->
<!-- #        width = 10, -->
<!-- #        height = 30, -->
<!-- #        units = "in", -->
<!-- #        dpi = 300) -->
<!-- #  -->
<!-- # <br><br><br> -->
<!-- ``` -->

###### Shell height 25-75mm

<br>

Including the random effect of reef (i.e., managed area-wide credible interval). Note that the CI upper limit is 250mm, but I set the y-axis limits at 20-100mm to make it easier to read.

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
#sort(unique(irvbfp_sh25to75$Sample_mean_age))
labs1 <- c(1840, 1943, 1993, 2001, 2019)

set.seed(987)
#irvbfp_sh25to75_1 <- plot(conditional_effects(irvbfp_sh25to75_glmm, re_formula = NULL), plot = FALSE)[[1]]
irvbfp_sh25to75_hist1 <- plot(conditional_effects(irvbfp_sh25to75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]

SH_AllDates_GLMM_IRVBFP_MEPrand_25to75 <- ggplot(irvbfp_sh25to75_hist1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = irvbfp_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "red", lwd = 1) +
  geom_boxplot(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$LiveDate_Qualifier == "Exact"), aes(x = RelYear2, y = ShellHeight_mm), color = "blue", fill = "light blue", lwd = 1, alpha = 0.5, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$LiveDate_Qualifier == "Exact" & irvbfp_sh25to75$reefIDcrosswalk == 198340), aes(x = 186, y = ShellHeight_mm), color = "salmon", fill = "salmon", lwd = 1, alpha = 0.5, width = 1, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$LiveDate_Qualifier == "Exact" & irvbfp_sh25to75$reefIDcrosswalk == 198341), aes(x = 188, y = ShellHeight_mm), color = "gold", fill = "gold", lwd = 1, alpha = 0.5, width = 1, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$LiveDate_Qualifier == "Exact" & irvbfp_sh25to75$reefIDcrosswalk == 198352), aes(x = 192, y = ShellHeight_mm), color = "turquoise", fill = "turquoise", lwd = 1, alpha = 0.5, width = 1, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$LiveDate_Qualifier == "Exact" & irvbfp_sh25to75$reefIDcrosswalk == 198360), aes(x = 194, y = ShellHeight_mm), color = "dodgerblue", fill = "dodgerblue", lwd = 1, alpha = 0.5, width = 1, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$LiveDate_Qualifier == "Exact" & irvbfp_sh25to75$reefIDcrosswalk == 198362), aes(x = 196, y = ShellHeight_mm), color = "purple", fill = "purple", lwd = 1, alpha = 0.5, width = 1, inherit.aes = FALSE) +
  #geom_ribbon(data = irvbfp_sh25to75_hist$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  #geom_line(data = irvbfp_sh25to75_hist$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$Sample_mean_age %in% labs1), aes(y = 22, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  geom_text(aes(y = 23.5, label = "Real-time data \n by reef", x = 192), size = 2.6, col = "grey50", inherit.aes = FALSE) +
    #geom_text(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$Sample_mean_age %in% labs2), aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(20, 100))
SH_AllDates_GLMM_IRVBFP_MEPrand_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_MEPrand_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_IRVBFP_MEPrand_25to75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval). Note that the CI upper limit is 250mm, but I set the y-axis limits at 20-100mm to make it easier to read.

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
#sort(unique(irvbfp_sh25to75$Sample_mean_age))
labs1 <- c(1840, 1943, 1993, 2001, 2019)

set.seed(986)
#irvbfp_sh25to75_2 <- plot(conditional_effects(irvbfp_sh25to75_glmm, re_formula = NULL), plot = FALSE)[[1]]
irvbfp_sh25to75_hist2 <- plot(conditional_effects(irvbfp_sh25to75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]

SH_AllDates_GLMM_IRVBFP_MEPnorand_25to75 <- ggplot(irvbfp_sh25to75_hist2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = irvbfp_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "red", lwd = 1) +
  geom_boxplot(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$LiveDate_Qualifier == "Exact"), aes(x = RelYear2, y = ShellHeight_mm), color = "blue", fill = "light blue", lwd = 1, alpha = 0.5, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$LiveDate_Qualifier == "Exact" & irvbfp_sh25to75$reefIDcrosswalk == 198340), aes(x = 186, y = ShellHeight_mm), color = "salmon", fill = "salmon", lwd = 1, alpha = 0.5, width = 1, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$LiveDate_Qualifier == "Exact" & irvbfp_sh25to75$reefIDcrosswalk == 198341), aes(x = 188, y = ShellHeight_mm), color = "gold", fill = "gold", lwd = 1, alpha = 0.5, width = 1, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$LiveDate_Qualifier == "Exact" & irvbfp_sh25to75$reefIDcrosswalk == 198352), aes(x = 192, y = ShellHeight_mm), color = "turquoise", fill = "turquoise", lwd = 1, alpha = 0.5, width = 1, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$LiveDate_Qualifier == "Exact" & irvbfp_sh25to75$reefIDcrosswalk == 198360), aes(x = 194, y = ShellHeight_mm), color = "dodgerblue", fill = "dodgerblue", lwd = 1, alpha = 0.5, width = 1, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$LiveDate_Qualifier == "Exact" & irvbfp_sh25to75$reefIDcrosswalk == 198362), aes(x = 196, y = ShellHeight_mm), color = "purple", fill = "purple", lwd = 1, alpha = 0.5, width = 1, inherit.aes = FALSE) +
  #geom_ribbon(data = irvbfp_sh25to75_hist$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  #geom_line(data = irvbfp_sh25to75_hist$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$Sample_mean_age %in% labs1), aes(y = 22, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  geom_text(aes(y = 23.5, label = "Real-time data \n by reef", x = 192), size = 2.6, col = "grey50", inherit.aes = FALSE) +
    #geom_text(data = subset(irvbfp_sh25to75, irvbfp_sh25to75$Sample_mean_age %in% labs2), aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") #+
  #theme(legend.position = "none") +
  coord_cartesian(ylim = c(20, 100))
SH_AllDates_GLMM_IRVBFP_MEPnorand_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_MEPnorand_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_IRVBFP_MEPnorand_25to75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Individual effects plots
irvbfp_sh25to75_hist <- subset(irvbfp_sh25to75, irvbfp_sh25to75$Sample_mean_age_qualifier == "Estimate")
#irvbfp_sh25to75_hist$reefIDcrosswalk <- droplevels(irvbfp_sh25to75_hist$reefIDcrosswalk)

SH_AllDates_GLMM_IRVBFP_IEP_25to75 <- irvbfp_sh25to75_hist %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(irvbfp_sh25to75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk), size = 3) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = irvbfp_sh25to75_hist) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = irvbfp_sh25to75_hist, aes(y = 20, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sh25to75, gtmn_sh25to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(irvbfp_sh25to75_hist$RelYear2) - 1, max(irvbfp_sh25to75_hist$RelYear2) + 1)) +
  #scale_y_continuous(limits = c(0, 50000)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 1, scales = "free")
SH_AllDates_GLMM_IRVBFP_IEP_25to75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_IEP_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_IRVBFP_IEP_25to75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br><br>

###### Shell height >75mm

<br>

Important: note that time-averaging is not accounted for in the model fit for the data on shell height >75mm. The measurement error approach I was taking did not result in any models that converged, possibly because the combination of the data and degree of measurement error leads to multiple possible solutions. This means the model reported in this section makes the unrealistic assumption that the estimated sample ages are exactly correct.

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
sort(unique(irvbfp_sho75$Sample_mean_age))
labs1 <- c(1840, 1943, 2001, 2019)

set.seed(986)
#irvbfp_sho75_1 <- plot(conditional_effects(irvbfp_sho75_glmm, re_formula = NULL), plot = FALSE)[[1]]
irvbfp_sho75_hist1 <- plot(conditional_effects(irvbfp_sho75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]

SH_AllDates_GLMM_IRVBFP_MEPrand_o75 <- ggplot(irvbfp_sho75_hist1$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = irvbfp_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "red", lwd = 1) +
  geom_vline(xintercept = 185, lwd = 0.5) +
  geom_vline(xintercept = 206, lwd = 0.5, lty = 2, color = "grey50") +
  geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Exact"), aes(x = RelYear2, y = ShellHeight_mm), color = "blue", fill = "light blue", lwd = 1, alpha = 0.5, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Estimate" & irvbfp_sho75$reefIDcrosswalk == 198340), aes(x = 190, y = ShellHeight_mm), color = "salmon", fill = "salmon", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Estimate" & irvbfp_sho75$reefIDcrosswalk == 198341), aes(x = 193, y = ShellHeight_mm), color = "gold", fill = "gold", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Estimate" & irvbfp_sho75$reefIDcrosswalk == 198345), aes(x = 196, y = ShellHeight_mm), color = "turquoise", fill = "turquoise", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Estimate" & irvbfp_sho75$reefIDcrosswalk == 198360), aes(x = 199, y = ShellHeight_mm), color = "dodgerblue", fill = "dodgerblue", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Estimate" & irvbfp_sho75$reefIDcrosswalk == 198362), aes(x = 202, y = ShellHeight_mm), color = "purple", fill = "purple", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Exact" & irvbfp_sho75$reefIDcrosswalk == 198340), aes(x = 209, y = ShellHeight_mm), color = "salmon", fill = "salmon", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Exact" & irvbfp_sho75$reefIDcrosswalk == 198341), aes(x = 212, y = ShellHeight_mm), color = "gold", fill = "gold", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Exact" & irvbfp_sho75$reefIDcrosswalk == 198345), aes(x = 215, y = ShellHeight_mm), color = "turquoise", fill = "turquoise", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Exact" & irvbfp_sho75$reefIDcrosswalk == 198360), aes(x = 218, y = ShellHeight_mm), color = "dodgerblue", fill = "dodgerblue", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Exact" & irvbfp_sho75$reefIDcrosswalk == 198362), aes(x = 221, y = ShellHeight_mm), color = "purple", fill = "purple", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  #geom_ribbon(data = irvbfp_sho75_hist$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  #geom_line(data = irvbfp_sho75_hist$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age %in% labs1), aes(y = 65, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  geom_text(aes(y = 72, label = "Historical \n data by \n reef", x = 197), size = 2.6, col = "grey50", inherit.aes = FALSE) +
  geom_text(aes(y = 72, label = "Real-time \n data by \n reef", x = 219), size = 2.6, col = "grey50", inherit.aes = FALSE) +
  geom_text(aes(y = 107, label = "Note that time-averaging is not accounted for in this \n model fit (model makes the unrealistic assumption \n that the estimated sample ages are exactly correct).", x = 0), size = 3, col = "grey50", hjust = 0, inherit.aes = FALSE) +
    #geom_text(data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age %in% labs2), aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") #+
  #theme(legend.position = "none") +
  #coord_cartesian(xlim = c(150, 180))
SH_AllDates_GLMM_IRVBFP_MEPrand_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_MEPrand_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_IRVBFP_MEPrand_o75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
#sort(unique(irvbfp_sho75$Sample_mean_age))
labs1 <- c(1840, 1943, 2001, 2019)

set.seed(986)
#irvbfp_sho75_2 <- plot(conditional_effects(irvbfp_sho75_glmm, re_formula = NA), plot = FALSE)[[1]]
irvbfp_sho75_hist2 <- plot(conditional_effects(irvbfp_sho75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]

SH_AllDates_GLMM_IRVBFP_MEPnorand_o75 <- ggplot(irvbfp_sho75_hist2$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__)) +
  geom_jitter(data = irvbfp_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "red", lwd = 1) +
  geom_vline(xintercept = 185, lwd = 0.5) +
  geom_vline(xintercept = 206, lwd = 0.5, lty = 2, color = "grey50") +
  geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Exact"), aes(x = RelYear2, y = ShellHeight_mm), color = "blue", fill = "light blue", lwd = 1, alpha = 0.5, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Estimate" & irvbfp_sho75$reefIDcrosswalk == 198340), aes(x = 190, y = ShellHeight_mm), color = "salmon", fill = "salmon", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Estimate" & irvbfp_sho75$reefIDcrosswalk == 198341), aes(x = 193, y = ShellHeight_mm), color = "gold", fill = "gold", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Estimate" & irvbfp_sho75$reefIDcrosswalk == 198345), aes(x = 196, y = ShellHeight_mm), color = "turquoise", fill = "turquoise", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Estimate" & irvbfp_sho75$reefIDcrosswalk == 198360), aes(x = 199, y = ShellHeight_mm), color = "dodgerblue", fill = "dodgerblue", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Estimate" & irvbfp_sho75$reefIDcrosswalk == 198362), aes(x = 202, y = ShellHeight_mm), color = "purple", fill = "purple", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Exact" & irvbfp_sho75$reefIDcrosswalk == 198340), aes(x = 209, y = ShellHeight_mm), color = "salmon", fill = "salmon", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Exact" & irvbfp_sho75$reefIDcrosswalk == 198341), aes(x = 212, y = ShellHeight_mm), color = "gold", fill = "gold", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Exact" & irvbfp_sho75$reefIDcrosswalk == 198345), aes(x = 215, y = ShellHeight_mm), color = "turquoise", fill = "turquoise", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Exact" & irvbfp_sho75$reefIDcrosswalk == 198360), aes(x = 218, y = ShellHeight_mm), color = "dodgerblue", fill = "dodgerblue", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_boxplot(data = subset(irvbfp_sho75, irvbfp_sho75$LiveDate_Qualifier == "Exact" & irvbfp_sho75$reefIDcrosswalk == 198362), aes(x = 221, y = ShellHeight_mm), color = "purple", fill = "purple", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  #geom_ribbon(data = irvbfp_sho75_hist$data, aes(x = RelYear2, y = ShellHeight_mm, ymin = lower__, ymax = upper__), fill = "grey", alpha = 0.4, inherit.aes = FALSE) +
  #geom_line(data = irvbfp_sho75_hist$data, aes(x = RelYear2, y = estimate__), color = "red", lwd = 1, inherit.aes = FALSE) +
  geom_text(data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age %in% labs1), aes(y = 65, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  geom_text(aes(y = 72, label = "Historical \n data by \n reef", x = 197), size = 2.6, col = "grey50", inherit.aes = FALSE) +
  geom_text(aes(y = 72, label = "Real-time \n data by \n reef", x = 219), size = 2.6, col = "grey50", inherit.aes = FALSE) +
  geom_text(aes(y = 107, label = "Note that time-averaging is not accounted for in this \n model fit (model makes the unrealistic assumption \n that the estimated sample ages are exactly correct).", x = 0), size = 3, col = "grey50", hjust = 0, inherit.aes = FALSE) +
    #geom_text(data = subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age %in% labs2), aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") #+
  #theme(legend.position = "none") +
  #coord_cartesian(xlim = c(150, 180))
SH_AllDates_GLMM_IRVBFP_MEPnorand_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_MEPnorand_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_IRVBFP_MEPnorand_o75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Individual effects plots
irvbfp_sho75_hist <- subset(irvbfp_sho75, irvbfp_sho75$Sample_mean_age_qualifier == "Estimate")
#irvbfp_sho75_hist$reefIDcrosswalk <- droplevels(irvbfp_sho75_hist$reefIDcrosswalk)

SH_AllDates_GLMM_IRVBFP_IEP_o75 <- irvbfp_sho75_hist %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(irvbfp_sho75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk), size = 3) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = irvbfp_sho75_hist) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = irvbfp_sho75_hist, aes(y = 69, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sho75, gtmn_sho75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(irvbfp_sho75_hist$RelYear2) - 1, max(irvbfp_sho75_hist$RelYear2) + 1)) +
  #scale_y_continuous(limits = c(50, 500)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 1, scales = "free")
SH_AllDates_GLMM_IRVBFP_IEP_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_IEP_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_IRVBFP_IEP_o75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

```{r include=FALSE}
# Remove created objects to save memory.
rm(irvbfp_sho25, irvbfp_sho25_glmm, 
   irvbfp_sho75, irvbfp_sho75_glmm, 
   SH_AllDates_GLMM_IRVBFP_PDistandMChains_o25, SH_AllDates_GLMM_IRVBFP_PDistandMChains_o75,
   SH_AllDates_GLMM_IRVBFP_PPcheck_o25, SH_AllDates_GLMM_IRVBFP_PPcheck_o75,
   SH_AllDates_GLMM_IRVBFP_MEPrand_o25, SH_AllDates_GLMM_IRVBFP_MEPrand_o75,
   SH_AllDates_GLMM_IRVBFP_MEPnorand_o25, SH_AllDates_GLMM_IRVBFP_MEPnorand_o75,
   SH_AllDates_GLMM_IRVBFP_IEP_o25, SH_AllDates_GLMM_IRVBFP_IEP_o75
   )

```

<br><br><br>


#### Lemon Bay_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

lb_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Lemon Bay_Natural")
lb_sho25[, QuadSize_m2 := as.numeric(QuadSize_m2)]
lb_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
lb_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
lb_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(lb_sho25, here::here(paste0('GLMMs/AllDates/Data/lb_sho25_', Sys.Date(), '.rds')))
# 
# # registerDoFuture()
# # plan(list(tweak(multisession, workers = 15), tweak(multisession, workers = 3)))
# 
# lb_sho25_glmm %<-% brm(formula = ShellHeight_mm ~ me(RelYear, Sample_age_stdev) + (1 + RelYear|reefIDcrosswalk), data = lb_sho25, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3, future = TRUE)
# lb_sho25_glmm <- add_criterion(lb_sho25_glmm, "loo")
# 
# # #TEST LME, BASED ON MODEL KML USED FOR SAV BB DATA
# # #Using untransformed shell heights, the residuals were not normal (SEP3-distributed), so tried again with log-transformed sH
# # lb_sho25[, logSH := log(ShellHeight_mm)]
# #
# # #Let's try a mixed effects model to look for a trend.
# # #First row: Model BB over year
# # #Second row: vary slope and intercept of Year by ProgramLocationID
# # #Third row: omit NA's
# # #Fourth row: get the data from this dataset
# # ctrl <- lmeControl(opt='optim')
# # modellb_sho25 <- lme(ShellHeight_mm ~ RelYear,
# #                          random = ~ RelYear | reefIDcrosswalk,
# #                          na.action = na.omit,
# #                          control = ctrl,
# #                          data = lb_sho25)
# # 
# # #plot histogram of residuals to check for normality
# # hist(resid(modellb_sho25))
# # fitDist(resid(modellb_sho25))
# # histDist(resid(modellb_sho25), family = "NO")
# # #plot residuals
# # plot(modellb_sho25)
# # 
# # #print coefficients. Estimate tells you the trend, eg here, for every year you expect a .01%
# # #decrease. P-value shows (if) it is significant
# # piecewiseSEM::coefs(modellb_sho25)
# # irvbfp_sho25_coefs<-piecewiseSEM::coefs(modellb_sho25)
# # piecewiseSEM::rsquared(modellb_sho25)
# # 
# # #plot the actual model to visualize what the Estimate and p-value told you
# # library(effects)
# # plot(effect("RelYear", modellb_sho25))
# 
# 
# ggplot(lb_sho25, aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
#   geom_jitter() +
#   theme_bw() +
#   theme(legend.position = "none")
# 
# ggplot(lb_sho25, aes(x = RelYear2, y = Sample_mean_age_qualifier, color = reefIDcrosswalk)) +
#   geom_jitter() +
#   theme_bw() +
#   theme(legend.position = "none")
# 
# 
# saveRDS(lb_sho25_glmm, here::here('GLMMs/AllDates/lb_sho25_glmm.rds'))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

lb_sh25to75 <- subset(lb_sho25, lb_sho25$ShellHeight_mm < 75)
saveRDS(lb_sh25to75, here::here(paste0('GLMMs/AllDates/Data/lb_sh25to75_', Sys.Date(), '.rds')))

ggplot(lb_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(lb_sh25to75, aes(x = RelYear2, y = Sample_mean_age_qualifier, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(lb_sh25to75, aes(x = RelYear2, y = reefIDcrosswalk, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

#Converged, intercept not significant.
lb_sh25to75_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ 1, data = lb_sh25to75, family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sh25to75_glmm_hist1.rds")
lb_sh25to75_glmm_hist1 <- add_criterion(lb_sh25to75_glmm_hist1, "loo")

#model nearly converged
lb_sh25to75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = lb_sh25to75, family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sh25to75_glmm_hist2.rds")
lb_sh25to75_glmm_hist2 <- add_criterion(lb_sh25to75_glmm_hist2, "loo")

#adding a RelYear prior to previous model. Model nearly converged.
lb_sh25to75_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = lb_sh25to75, family = gaussian, prior = set_prior("normal(53, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sh25to75_glmm_hist3.rds")
lb_sh25to75_glmm_hist3 <- add_criterion(lb_sh25to75_glmm_hist3, "loo")

#Model converged.
lb_sh25to75_glmm_hist4 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = lb_sh25to75, family = gaussian, prior = set_prior("normal(53, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sh25to75_glmm_hist4.rds")
lb_sh25to75_glmm_hist4 <- add_criterion(lb_sh25to75_glmm_hist4, "loo")

#Model converged, but bulk and tail ESS values seem a bit low.
lb_sh25to75_glmm_hist5 <- brm(formula = ShellHeight_mm | trunc(lb = 25, ub = 75) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear | reefIDcrosswalk), data = lb_sh25to75, family = gaussian, prior = set_prior("normal(53, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sh25to75_glmm_hist5.rds")
lb_sh25to75_glmm_hist5 <- add_criterion(lb_sh25to75_glmm_hist5, "loo")

#GLMM4 is the best fit to the data.
loo_compare(lb_sh25to75_glmm_hist2, lb_sh25to75_glmm_hist3, lb_sh25to75_glmm_hist4, lb_sh25to75_glmm_hist5)

```

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

lb_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Lemon Bay_Natural")
lb_sho75[, QuadSize_m2 := as.factor(QuadSize_m2)]
lb_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
lb_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
lb_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(lb_sho75, here::here(paste0('GLMMs/AllDates/Data/lb_sho75_', Sys.Date(), '.rds')))

lb_sho75_glmm <- brm(formula = ShellHeight_mm ~ RelYear + (1 + RelYear|reefIDcrosswalk), data = lb_sho75, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
lb_sho75_glmm <- add_criterion(lb_sho75_glmm, "loo")

ggplot(lb_sho75, aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(lb_sho75, aes(x = RelYear2, y = Sample_mean_age_qualifier, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(lb_sho75, aes(x = RelYear2, y = reefIDcrosswalk, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(lb_sho75, aes(x = RelYear2, y = Sample_age_stdev, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

#Converged, intercept is significant.
lb_sho75_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ 1, data = lb_sho75, family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist1.rds")
lb_sho75_glmm_hist1 <- add_criterion(lb_sho75_glmm_hist1, "loo")

#model did not converge.
lb_sho75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = lb_sho75, family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist2.rds")
lb_sho75_glmm_hist2 <- add_criterion(lb_sho75_glmm_hist2, "loo")

#adding a RelYear prior to previous model. Model did not converge.
lb_sho75_glmm_hist3 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = lb_sho75, family = gaussian, prior = set_prior("normal(47, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist3.rds")
lb_sho75_glmm_hist3 <- add_criterion(lb_sho75_glmm_hist3, "loo")

#Model did not converge.
lb_sho75_glmm_hist4 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = lb_sho75, family = gaussian, prior = set_prior("normal(47, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist4.rds")
lb_sho75_glmm_hist4 <- add_criterion(lb_sho75_glmm_hist4, "loo")

#Model did not converge.
lb_sho75_glmm_hist5 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear | reefIDcrosswalk), data = lb_sho75, family = gaussian, prior = set_prior("normal(47, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist5.rds")
lb_sho75_glmm_hist5 <- add_criterion(lb_sho75_glmm_hist5, "loo")

#Trying a narrower sigma on the RelYear prior. Model did not converge.
lb_sho75_glmm_hist6 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear | reefIDcrosswalk), data = lb_sho75, family = gaussian, prior = set_prior("normal(47, 10)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist6.rds")
lb_sho75_glmm_hist6 <- add_criterion(lb_sho75_glmm_hist6, "loo")

#Trying a broader sigma on the RelYear prior and replacing the coef argument with an upper bound (RelYear2 = 91 is equivalent to 2020). Nearly converged (Rhats < 2).
lb_sho75_glmm_hist7 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear | reefIDcrosswalk), data = lb_sho75, family = gaussian, prior = set_prior("normal(47, 30)", class = "b", ub = 91), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist7.rds")
lb_sho75_glmm_hist7 <- add_criterion(lb_sho75_glmm_hist7, "loo")

#Trying the new RelYear prior without the reefIDcrosswalk grouping variable. Model did not converge.
lb_sho75_glmm_hist8 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier), data = lb_sho75, family = gaussian, prior = set_prior("normal(47, 30)", class = "b", ub = 91), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist8.rds")
lb_sho75_glmm_hist8 <- add_criterion(lb_sho75_glmm_hist8, "loo")

#Trying the new RelYear prior with the reefIDcrosswalk grouping variable and just a variable intercept. Model did not converge.
lb_sho75_glmm_hist9 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = lb_sho75, family = gaussian, prior = set_prior("normal(47, 30)", class = "b", ub = 91), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 4000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist9.rds")
lb_sho75_glmm_hist9 <- add_criterion(lb_sho75_glmm_hist9, "loo")

#Trying adding a sd prior to model 7, increasing max_treedepth and adding another 1000 iterations, removed sd prior. I also adjusted the RelYear prior to have mu = 1986, the average estimated median age across all of the individually dated shells for Lemon Bay (maybe the "arbitrary-ness" of assigning average sample ages to each specimen is messing with the histograms I am using to estimate the priors somehow). Model converged, but sd/sigma estimates are 0.00, which seems suspicious.
lb_sho75_glmm_hist10 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear | reefIDcrosswalk), data = lb_sho75, family = gaussian, prior = set_prior("normal(57, 15)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 20), iter = 5000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist10.rds")
lb_sho75_glmm_hist10 <- add_criterion(lb_sho75_glmm_hist10, "loo")

#Model did not converge.
lb_sho75_glmm_hist11 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear | reefIDcrosswalk), data = lb_sho75, family = gaussian, prior = set_prior("normal(57, 20)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 20), iter = 5000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist11.rds")
lb_sho75_glmm_hist11 <- add_criterion(lb_sho75_glmm_hist11, "loo")

#Same as model 10; seeing if RelYear prior sigma value being 15 is really that important to the model fit (did not fit with sigma = 20). First time I ran this, one chain didn't move. Second time the model was still going to take days to fit. Perhaps model 10 just got lucky with the inits?
lb_sho75_glmm_hist11b <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (0 + RelYear | reefIDcrosswalk), data = lb_sho75, family = gaussian, prior = set_prior("normal(57, 15)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 20), iter = 5000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist11b.rds")
lb_sho75_glmm_hist11b <- add_criterion(lb_sho75_glmm_hist11b, "loo")

#Model nearly converged (Rhats < 2).
lb_sho75_glmm_hist12 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = lb_sho75, family = gaussian, prior = set_prior("normal(57, 10)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 20), iter = 5000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist12.rds")
lb_sho75_glmm_hist12 <- add_criterion(lb_sho75_glmm_hist12, "loo")

#One chain got stuck.
lb_sho75_glmm_hist13 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = lb_sho75, family = gaussian, prior = set_prior("normal(47, 10)", class = "b", coef = "meRelYear2Sample_age_stdevgrEQQuadIdentifier"), cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 20), iter = 5000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist13.rds")
lb_sho75_glmm_hist13 <- add_criterion(lb_sho75_glmm_hist13, "loo")

#One chain got stuck. The second and third times I ran it, it was still going to take many hours.
lb_sho75_glmm_hist14 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ me(RelYear2, Sample_age_stdev, gr = QuadIdentifier) + (1 | reefIDcrosswalk), data = lb_sho75, family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 20), iter = 5000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist14.rds")
lb_sho75_glmm_hist14 <- add_criterion(lb_sho75_glmm_hist14, "loo")

#Trying without the measurement error. Model converged very quickly.
lb_sho75_glmm_hist14 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2 + (1 | reefIDcrosswalk), data = lb_sho75, family = gaussian, cores = 4, control= list(adapt_delta = 0.999, max_treedepth = 20), iter = 5000, warmup = 1000, chains = 4, inits = 75, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_sho75_glmm_hist14.rds")
lb_sho75_glmm_hist14 <- add_criterion(lb_sho75_glmm_hist14, "loo")


#GLMM4 is the best fit to the data.
loo_compare(lb_sho75_glmm_hist2, lb_sho75_glmm_hist3, lb_sho75_glmm_hist4, lb_sho75_glmm_hist5)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
lb_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "Lemon Bay_Natural")
lb_sho25[, QuadSize_m2 := as.factor(QuadSize_m2)]
lb_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
lb_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
lb_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(lb_sho25, here::here(paste0('GLMMs/AllDates/Data/lb_sho25_', Sys.Date(), '.rds')))

#lb_sho25_glmm <- readRDS(here::here('GLMMs/AllDates/lb_sho25_glmm.rds'))

lb_sh25to75 <- subset(lb_sho25, lb_sho25$ShellHeight_mm < 75)
saveRDS(lb_sh25to75, here::here(paste0('GLMMs/AllDates/Data/lb_sh25to75_', Sys.Date(), '.rds')))

lb_sh25to75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/lb_sh25to75_glmm_hist4.rds'))

lb_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "Lemon Bay_Natural")
lb_sho75[, QuadSize_m2 := as.factor(QuadSize_m2)]
lb_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
lb_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
lb_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(lb_sho75, here::here(paste0('GLMMs/AllDates/Data/lb_sho75_', Sys.Date(), '.rds')))

lb_sho75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/lb_sho75_glmm_hist14.rds'))

```

##### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Load live SH measurements from 5035 raw file. Final combined table update had issues and these data were skipped in the load altogether; this code will likely be unnecessary in the future after the load issues with 5035 are sorted out.
library(openxlsx)
LBLiveSH_5035 <- openxlsx::read.xlsx(here::here("ID5035_HOBS_LBLiveSH.xlsx"), 1)
setDT(LBLiveSH_5035)
LBLiveSH_5035[, Year := 2018]
LBLiveSH_5035[, RelYear2 := 2018 - min(lb_sh25to75$Sample_mean_age)]
LBLiveSH_5035[, Reef_code := substring(Sample_code, 1, 5)]
LBLiveSH_5035[, reefIDcrosswalk := as.character(ifelse(Reef_code == "LB_R1", 168802, ifelse(Reef_code == "LB_R2", 168801, 169320)))]
LBLiveSH_5035[, ShellHeight_mm := LV_H_mm]
LBLiveSH_5035[, Sample_mean_age_qualifier := "Exact"]
LBLiveSH_5035[, ProgramID := 5035]
LBLiveSH_5035[, SampleDate := "2018-10-29"]
LBLiveSH_5035[, SampleDate := ymd(SampleDate)]
LBLiveSH_5035[, Month := month(SampleDate)]
LBLiveSH_5035[, c("Spec_num", "Spec_ID") := NULL]
LBLiveSH_5035[, Sample_mean_age := 2018]
LBLiveSH_5035 <- subset(LBLiveSH_5035, LBLiveSH_5035$LV_H_mm > 25 & LBLiveSH_5035$LV_H_mm < 75)


LBLiveSH_5035[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
LBLiveSH_5035[, SampleDay := day(SampleDate)]

if(length(subset(LBLiveSH_5035, LBLiveSH_5035$Sample_mean_age_qualifier == "Exact")$ShellHeight_mm) > 0){
  sh_t <- copy(LBLiveSH_5035[0, ])
  sh_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
  for(i in unique(as.numeric(LBLiveSH_5035$Month))){
    mo <- subset(LBLiveSH_5035, as.numeric(LBLiveSH_5035$Month) == i)
    ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
           ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                  ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                         ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                                ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                       ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                              ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                     ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                            ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                   ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                          ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
    sh_t <- rbind(mo, sh_t)
  }
  
  monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))
  
  #Create the sampling dates correspondence plot
  SampleDatesPlot <- ggplot(subset(sh_t, sh_t$Sample_mean_age_qualifier == "Exact"), aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                        geom_point(size = 3) +
                        geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                        geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                        xlim(1,365) +
                        scale_x_continuous(breaks = NULL) +
                        coord_cartesian(xlim = c(1, 366)) +
                        theme_bw()+labs(x = "Sample Date", y = "Program ID")
  print(SampleDatesPlot)
  
  #Remove the objects after the plot is done.
  rm(sh_t, monthnames, SampleDatesPlot)

} else{
  
  print("There are no real-time data for this managed area.")
  
}

```

<br><br><br>

##### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_specimens = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for size class 25-75mm first.
sh25to75_status <- subset(LBLiveSH_5035, LBLiveSH_5035$Sample_mean_age %in% StatusYears)
sh25to75_status[, `:=` (Indicator = "Size Class", 
                        SizeClass = "25-75mm", 
                        Year = as.numeric(Sample_mean_age), 
                        n_reefs = length(unique(reefIDcrosswalk)),
                        n_programs = length(unique(ProgramID)),
                        ProgIDs = list(unique(ProgramID)),
                        n_specimens = length(ShellHeight_mm),
                        Median = median(ShellHeight_mm),
                        Mean = round(mean(ShellHeight_mm), digits = 2),
                        SD = round(sd(ShellHeight_mm), digits = 2), 
                        Min. = min(ShellHeight_mm),
                        Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sh25to75_status <- unique(sh25to75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sh25to75_status <- sh25to75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sh25to75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sh25to75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = "25-75mm",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sh25to75_status <- rbind(sh25to75_status, MissingYr_i)
  }
}

#Build status table for size class >75mm next.
sho75_status <- subset(lb_sho75, lb_sho75$Sample_mean_age %in% StatusYears)
sho75_status[, `:=` (Indicator = "Size Class", 
                     SizeClass = ">75mm", 
                     Year = as.numeric(Sample_mean_age), 
                     n_reefs = length(unique(reefIDcrosswalk)),
                     n_programs = length(unique(ProgramID)),
                     ProgIDs = list(unique(ProgramID)),
                     n_specimens = length(ShellHeight_mm),
                     Median = median(ShellHeight_mm),
                     Mean = round(mean(ShellHeight_mm), digits = 2),
                     SD = round(sd(ShellHeight_mm), digits = 2), 
                     Min. = min(ShellHeight_mm),
                     Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sho75_status <- unique(sho75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sho75_status <- sho75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sho75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sho75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = ">75mm",
                              Year = i,
                              n_reefs = ifelse(sh25to75_status[Year == i, n_reefs] > 0, sh25to75_status[Year == i, n_reefs], 0),
                              n_programs = ifelse(sh25to75_status[Year == i, n_programs] > 0, sh25to75_status[Year == i, n_programs], 0),
                              ProgIDs = ifelse(!is.na(sh25to75_status[Year == i, ProgIDs]), sh25to75_status[Year == i, ProgIDs], NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sho75_status <- rbind(sho75_status, MissingYr_i)
  }
}

#Merge individual size class tables and set row order
Status <- rbind(Status, sh25to75_status)
Status <- rbind(Status, sho75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) %>%
  kable_styling() %>%
  row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, sh25to75_status, MissingYr_i, sho75_status)
```

<br><br><br>

##### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(lb_sho25, aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() #+
  #theme(legend.position = "none")

ggplot(lb_sho25, aes(x = RelYear2, y = Sample_mean_age_qualifier, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() #+
  #theme(legend.position = "none")
```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
ggplot(lb_sho25, aes(x = RelYear2, y = reefIDcrosswalk, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() #+
  #theme(legend.position = "none")

ggplot(lb_sho25, aes(x = RelYear2, y = Sample_age_stdev, color = reefIDcrosswalk)) +
  geom_jitter() +
  geom_smooth(aes(x = RelYear2, y = Sample_age_stdev), method = "lm", inherit.aes = FALSE) +
  theme_bw() #+
  #theme(legend.position = "none")
```

<br><br><br>

##### Model Output {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- summary(lb_sho25_glmm) -->
<!-- ``` -->

<!-- <br><br><br> -->

###### Shell height 25-75mm

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(lb_sh25to75_glmm_hist)
```

<br><br><br>


###### Shell height >75mm

Important: note that time-averaging is not accounted for in the model fit for the data on shell height >75mm. The measurement error approach I was taking did not result in any models that converged, possibly because the combination of the data and degree of measurement error leads to multiple possible solutions. This means the model reported in this section makes the unrealistic assumption that the estimated sample ages are exactly correct.

<br><br>

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(lb_sho75_glmm_hist)
```

<br><br><br>

##### Diagnostic Plots {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- Posterior distributions and Markov chains: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_LB_PDistandMChains_o25 <- plot(lb_sho25_glmm) -->
<!-- SH_AllDates_GLMM_LB_PDistandMChains_o25 -->

<!-- len <- length(SH_AllDates_GLMM_LB_PDistandMChains_o25) -->
<!-- for(i in 1:len){ -->
<!--   jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_LB_PDistandMChains_o25_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300) -->
<!--   print(SH_AllDates_GLMM_LB_PDistandMChains_o25[i]) -->
<!--   dev.off() -->
<!-- } -->
<!-- ``` -->

<!-- <br><br><br> -->

<!-- Posterior predictive check plot: -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_LB_PPcheck_o25 <- pp_check(lb_sho25_glmm) -->
<!-- SH_AllDates_GLMM_LB_PPcheck_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_LB_PPcheck_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_LB_PPcheck_o25, -->
<!--        width = 4, -->
<!--        height = 3, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br> -->

###### Shell height 25-75mm

Posterior distributions and Markov chains:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_LB_PDistandMChains_25to75_hist <- plot(lb_sh25to75_glmm_hist)
SH_AllDates_GLMM_LB_PDistandMChains_25to75_hist

len <- length(SH_AllDates_GLMM_LB_PDistandMChains_25to75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_LB_PDistandMChains_25to75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_LB_PDistandMChains_25to75_hist[i])
  dev.off()
}
```

<br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_LB_PPcheck_25to75_hist <- pp_check(lb_sh25to75_glmm_hist)
SH_AllDates_GLMM_LB_PPcheck_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_LB_PPcheck_25to75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_LB_PPcheck_25to75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>


###### Shell height >75mm

<br>

Important: note that time-averaging is not accounted for in the model fit for the data on shell height >75mm. The measurement error approach I was taking did not result in any models that converged, possibly because the combination of the data and degree of measurement error leads to multiple possible solutions. This means the model reported in this section makes the unrealistic assumption that the estimated sample ages are exactly correct.

<br>

Posterior distributions and Markov chains:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_LB_PDistandMChains_o75_hist <- plot(lb_sho75_glmm_hist)
SH_AllDates_GLMM_LB_PDistandMChains_o75_hist

len <- length(SH_AllDates_GLMM_LB_PDistandMChains_o75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_LB_PDistandMChains_o75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_LB_PDistandMChains_o75_hist[i])
  dev.off()
}
```

<br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_LB_PPcheck_o75_hist <- pp_check(lb_sho75_glmm_hist)
SH_AllDates_GLMM_LB_PPcheck_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_LB_PPcheck_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_LB_PPcheck_o75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Marginal Effects Plots {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- Including the random effect of reef (i.e., managed area-wide credible interval): -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Marginal effects plot including random effects -->
<!-- lb_sho25_1 <- plot(conditional_effects(lb_sho25_glmm, re_formula = NULL), plot = FALSE)[[1]] -->
<!-- SH_AllDates_GLMM_LB_MEPrand_o25 <- lb_sho25_1 + -->
<!--   geom_point(data = lb_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_LB_MEPrand_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_LB_MEPrand_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_LB_MEPrand_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br> -->

<!-- Excluding the random effect of reef (i.e., sampled population credible interval): -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Marginal effects plot excluding random effects -->
<!-- lb_sho25_2 <- plot(conditional_effects(lb_sho25_glmm, re_formula = NA), plot = FALSE)[[1]] -->
<!-- SH_AllDates_GLMM_LB_MEPnorand_o25 <- lb_sho25_2 + -->
<!--   geom_point(data = lb_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_LB_MEPnorand_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_LB_MEPnorand_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_LB_MEPnorand_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br> -->

<!-- Individual effects plots: -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Individual effects plots -->
<!-- SH_AllDates_GLMM_LB_IEP_o25 <- lb_sho25 %>% -->
<!--   group_by(reefIDcrosswalk) %>% -->
<!--   add_fitted_draws(lb_sho25_glmm) %>% -->
<!--   ggplot(aes(x = RelYear, y = ShellHeight_mm, color = reefIDcrosswalk)) + -->
<!--   stat_lineribbon(aes(y = .value), size = 1) + -->
<!--   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) + -->
<!--   geom_point(data = lb_sho25) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") + -->
<!--   #geom_line(aes(y = .value), linetype = "dashed", color = "black") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   #scale_color_brewer(palette = "Set2") + -->
<!--   theme_bw() + -->
<!--   facet_wrap(~ reefIDcrosswalk, ncol = 3) -->
<!-- SH_AllDates_GLMM_LB_IEP_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_LB_IEP_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_LB_IEP_o25, -->
<!--        width = 10, -->
<!--        height = 30, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br> -->

###### Shell height 25-75mm

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects

#sort(unique(lb_sh25to75$Sample_mean_age))
labs1 <- c(1929, 1954, 1972, 1979, 1983, 1995, 2004, 2018)

set.seed(987)
lb_sh25to75_hist1 <- plot(conditional_effects(lb_sh25to75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]
SH_AllDates_GLMM_LB_MEPrand_25to75_hist <- lb_sh25to75_hist1 +
  geom_jitter(data = lb_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "red", lwd = 1) +
  #geom_boxplot(data = subset(lb_sh25to75, lb_sh25to75$LiveDate_Qualifier == "Exact"), aes(x = RelYear2, y = ShellHeight_mm), color = "blue", fill = "light blue", lwd = 1, alpha = 0.5, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(lb_sh25to75, lb_sh25to75$reefIDcrosswalk == 168801), aes(x = 80, y = ShellHeight_mm), color = "salmon", fill = "salmon", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(lb_sh25to75, lb_sh25to75$reefIDcrosswalk == 168802), aes(x = 83, y = ShellHeight_mm), color = "green", fill = "green", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(lb_sh25to75, lb_sh25to75$reefIDcrosswalk == 169320), aes(x = 86, y = ShellHeight_mm), color = "blue", fill = "blue", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_jitter(data = LBLiveSH_5035, aes(RelYear2, ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, color = "black", inherit.aes = FALSE) +
  geom_boxplot(data = LBLiveSH_5035, aes(RelYear2, ShellHeight_mm), color = "blue", fill = "white", alpha = 0.5, lwd = 1, width = 3, inherit.aes = FALSE) +
  geom_text(data = subset(lb_sh25to75, lb_sh25to75$Sample_mean_age %in% labs1), aes(y = 23, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = LBLiveSH_5035, aes(y = 22.4, label = "2018 \n(Live)", x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  #geom_text(aes(y = 23.5, label = "Real-time data \n by reef", x = 192), size = 2.6, col = "grey50", inherit.aes = FALSE) +
    #geom_text(data = subset(lb_sh25to75, lb_sh25to75$Sample_mean_age %in% labs2), aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") #+
  #theme(legend.position = "none") +
  #coord_cartesian(ylim = c(20, 80))
SH_AllDates_GLMM_LB_MEPrand_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_MEPrand_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_IRVBFP_MEPrand_25to75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
#sort(unique(lb_sh25to75$Sample_mean_age))
labs1 <- c(1929, 1954, 1972, 1979, 1983, 1995, 2004)

set.seed(987)
lb_sh25to75_hist2 <- plot(conditional_effects(lb_sh25to75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]
SH_AllDates_GLMM_LB_MEPnorand_25to75_hist <- lb_sh25to75_hist2 +
  geom_jitter(data = lb_sh25to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "red", lwd = 1) +
  #geom_boxplot(data = subset(lb_sh25to75, lb_sh25to75$LiveDate_Qualifier == "Exact"), aes(x = RelYear2, y = ShellHeight_mm), color = "blue", fill = "light blue", lwd = 1, alpha = 0.5, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(lb_sh25to75, lb_sh25to75$reefIDcrosswalk == 168801), aes(x = 80, y = ShellHeight_mm), color = "salmon", fill = "salmon", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(lb_sh25to75, lb_sh25to75$reefIDcrosswalk == 168802), aes(x = 83, y = ShellHeight_mm), color = "green", fill = "green", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  #geom_boxplot(data = subset(lb_sh25to75, lb_sh25to75$reefIDcrosswalk == 169320), aes(x = 86, y = ShellHeight_mm), color = "blue", fill = "blue", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_jitter(data = LBLiveSH_5035, aes(RelYear2, ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, color = "black", inherit.aes = FALSE) +
  geom_boxplot(data = LBLiveSH_5035, aes(RelYear2, ShellHeight_mm), color = "blue", fill = "white", alpha = 0.5, lwd = 1, width = 3, inherit.aes = FALSE) +
  geom_text(data = subset(lb_sh25to75, lb_sh25to75$Sample_mean_age %in% labs1), aes(y = 23, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = LBLiveSH_5035, aes(y = 22.4, label = "2018 \n(Live)", x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  #geom_text(aes(y = 23.5, label = "Real-time data \n by reef", x = 192), size = 2.6, col = "grey50", inherit.aes = FALSE) +
    #geom_text(data = subset(lb_sh25to75, lb_sh25to75$Sample_mean_age %in% labs2), aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") #+
  #theme(legend.position = "none") +
  #coord_cartesian(ylim = c(20, 80))
SH_AllDates_GLMM_LB_MEPnorand_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_IRVBFP_MEPnorand_25to75_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_IRVBFP_MEPnorand_25to75,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Individual effects plots
lb_sh25to75_hist <- subset(lb_sh25to75, lb_sh25to75$Sample_mean_age_qualifier == "Estimate")
#lb_sh25to75_hist$reefIDcrosswalk <- droplevels(lb_sh25to75_hist$reefIDcrosswalk)

SH_AllDates_GLMM_LB_IEP_25to75_hist <- lb_sh25to75_hist %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(lb_sh25to75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk), size = 3) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = lb_sh25to75_hist) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = lb_sh25to75_hist, aes(y = 15, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sh25to75, gtmn_sh25to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(lb_sh25to75_hist$RelYear2) - 1, max(lb_sh25to75_hist$RelYear2) + 1)) +
  #scale_y_continuous(limits = c(0, 50000)) +
  coord_cartesian(ylim = c(10, 75)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 1, scales = "free")
SH_AllDates_GLMM_LB_IEP_25to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_LB_MEPrand_25to75_hist", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_LB_MEPrand_25to75_hist,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Shell height >75mm

<br>

Important: note that time-averaging is not accounted for in the model fit for the data on shell height >75mm. The measurement error approach I was taking did not result in any models that converged, possibly because the combination of the data and degree of measurement error leads to multiple possible solutions. This means the model reported in this section makes the unrealistic assumption that the estimated sample ages are exactly correct.

<br>

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
#sort(unique(lb_sho75$Sample_mean_age))
labs1 <- c(1929, 1954, 1972, 1979, 1983, 1995, 2004)

set.seed(987)
lb_sho75_hist1 <- plot(conditional_effects(lb_sho75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]
SH_AllDates_GLMM_LB_MEPrand_o75_hist <- lb_sho75_hist1 +
  geom_jitter(data = lb_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "red", lwd = 1) +
  geom_vline(xintercept = 78, lwd = 0.5) +
  #geom_boxplot(data = subset(lb_sho75, lb_sho75$LiveDate_Qualifier == "Exact"), aes(x = RelYear2, y = ShellHeight_mm), color = "blue", fill = "light blue", lwd = 1, alpha = 0.5, inherit.aes = FALSE) +
  geom_boxplot(data = subset(lb_sho75, lb_sho75$reefIDcrosswalk == 168801), aes(x = 81.5, y = ShellHeight_mm), color = "salmon", fill = "salmon", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_boxplot(data = subset(lb_sho75, lb_sho75$reefIDcrosswalk == 168802), aes(x = 84.5, y = ShellHeight_mm), color = "green", fill = "green", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_boxplot(data = subset(lb_sho75, lb_sho75$reefIDcrosswalk == 169320), aes(x = 87.5, y = ShellHeight_mm), color = "blue", fill = "blue", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_text(data = subset(lb_sho75, lb_sho75$Sample_mean_age %in% labs1), aes(y = 73, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  geom_text(aes(y = 73.5, label = "All samples \n by reef", x = 84.5), size = 2.6, col = "grey50", inherit.aes = FALSE) +
  geom_text(aes(y = 105, label = "Note that time-averaging is not accounted for in this \n model fit (model makes the unrealistic assumption \n that the estimated sample ages are exactly correct).", x = 0), size = 3, col = "grey50", hjust = 0, inherit.aes = FALSE) +
    #geom_text(data = subset(lb_sho75, lb_sho75$Sample_mean_age %in% labs2), aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  #theme(legend.position = "none") +
  coord_cartesian(xlim = c(0.5, 86.5))
SH_AllDates_GLMM_LB_MEPrand_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_LB_MEPrand_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_LB_MEPrand_o75_hist,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
#sort(unique(lb_sho75$Sample_mean_age))
labs1 <- c(1929, 1954, 1972, 1979, 1983, 1995, 2004)

set.seed(986)
lb_sho75_hist2 <- plot(conditional_effects(lb_sho75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]
SH_AllDates_GLMM_LB_MEPnorand_o75_hist <- lb_sho75_hist2 +
  geom_jitter(data = lb_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "red", lwd = 1) +
  geom_vline(xintercept = 78, lwd = 0.5) +
  #geom_boxplot(data = subset(lb_sho75, lb_sho75$LiveDate_Qualifier == "Exact"), aes(x = RelYear2, y = ShellHeight_mm), color = "blue", fill = "light blue", lwd = 1, alpha = 0.5, inherit.aes = FALSE) +
  geom_boxplot(data = subset(lb_sho75, lb_sho75$reefIDcrosswalk == 168801), aes(x = 81.5, y = ShellHeight_mm), color = "salmon", fill = "salmon", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_boxplot(data = subset(lb_sho75, lb_sho75$reefIDcrosswalk == 168802), aes(x = 84.5, y = ShellHeight_mm), color = "green", fill = "green", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_boxplot(data = subset(lb_sho75, lb_sho75$reefIDcrosswalk == 169320), aes(x = 87.5, y = ShellHeight_mm), color = "blue", fill = "blue", lwd = 1, alpha = 0.5, width = 2, inherit.aes = FALSE) +
  geom_text(data = subset(lb_sho75, lb_sho75$Sample_mean_age %in% labs1), aes(y = 73, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  geom_text(aes(y = 73.5, label = "All samples \n by reef", x = 84.5), size = 2.6, col = "grey50", inherit.aes = FALSE) +
  geom_text(aes(y = 105, label = "Note that time-averaging is not accounted for in this \n model fit (model makes the unrealistic assumption \n that the estimated sample ages are exactly correct).", x = 0), size = 3, col = "grey50", hjust = 0, inherit.aes = FALSE) +
    #geom_text(data = subset(lb_sho75, lb_sho75$Sample_mean_age %in% labs2), aes(y = 18, label = Sample_mean_age, x = RelYear2), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID") +
  #theme(legend.position = "none") +
  coord_cartesian(xlim = c(0.5, 86.5))
SH_AllDates_GLMM_LB_MEPnorand_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_LB_MEPnorand_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_LB_MEPnorand_o75_hist,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}

#sort(unique(lb_sho75_hist$Sample_mean_age))
labs1 <- c(1929, 1954, 1972, 1979, 1983, 1992, 1994, 2003, 2004)

lb_sho75_hist <- subset(lb_sho75, lb_sho75$Sample_mean_age_qualifier == "Estimate")
#lb_sho75_hist$reefIDcrosswalk <- droplevels(lb_sho75_hist$reefIDcrosswalk)

SH_AllDates_GLMM_LB_IEP_o75_hist <- lb_sho75_hist %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(lb_sho75_glmm_hist) %>%
  ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk), size = 3) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = lb_sho75_hist) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(lb_sho75_hist, lb_sho75_hist$Sample_mean_age %in% labs1), aes(y = 70, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(gtmn_sho75, gtmn_sho75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(min(lb_sho75_hist$RelYear2) - 1, max(lb_sho75_hist$RelYear2) + 1)) +
  #scale_y_continuous(limits = c(0, 50000)) +
  coord_cartesian(ylim = c(68, 125)) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 1, scales = "free")
SH_AllDates_GLMM_LB_IEP_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_LB_IEP_o75_hist", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_LB_IEP_o75_hist,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

```{r include=FALSE}
# Remove created objects to save memory.
rm(lb_sho25, lb_sho25_glmm, 
   lb_sho75, lb_sho75_glmm, 
   SH_AllDates_GLMM_LB_PDistandMChains_o25, SH_AllDates_GLMM_LB_PDistandMChains_o75,
   SH_AllDates_GLMM_LB_PPcheck_o25, SH_AllDates_GLMM_LB_PPcheck_o75,
   SH_AllDates_GLMM_LB_MEPrand_o25, SH_AllDates_GLMM_LB_MEPrand_o75,
   SH_AllDates_GLMM_LB_MEPnorand_o25, SH_AllDates_GLMM_LB_MEPnorand_o75,
   SH_AllDates_GLMM_LB_IEP_o25, SH_AllDates_GLMM_LB_IEP_o75
   )

```

#### St. Martins Marsh_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}

smm_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "St. Martins Marsh_Natural")
smm_sho25[, QuadSize_m2 := as.factor(QuadSize_m2)]
smm_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
smm_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
smm_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(smm_sho25, here::here(paste0('GLMMs/AllDates/Data/smm_sho25_', Sys.Date(), '.rds')))
# 
# # registerDoFuture()
# # plan(list(tweak(multisession, workers = 15), tweak(multisession, workers = 3)))
# 
# smm_sho25_glmm %<-% brm(formula = ShellHeight_mm ~ me(RelYear, Sample_age_stdev) + (1 + RelYear|reefIDcrosswalk), data = smm_sho25, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3, future = TRUE)
# smm_sho25_glmm <- add_criterion(smm_sho25_glmm, "loo")
# 
# # #TEST LME, BASED ON MODEL KML USED FOR SAV BB DATA
# # #Using untransformed shell heights, the residuals were not normal (SEP3-distributed), so tried again with log-transformed sH
# # smm_sho25[, logSH := log(ShellHeight_mm)]
# #
# # #Let's try a mixed effects model to look for a trend.
# # #First row: Model BB over year
# # #Second row: vary slope and intercept of Year by ProgramLocationID
# # #Third row: omit NA's
# # #Fourth row: get the data from this dataset
# # ctrl <- lmeControl(opt='optim')
# # modelsmm_sho25 <- lme(ShellHeight_mm ~ RelYear,
# #                          random = ~ RelYear | reefIDcrosswalk,
# #                          na.action = na.omit,
# #                          control = ctrl,
# #                          data = smm_sho25)
# # 
# # #plot histogram of residuals to check for normality
# # hist(resid(modelsmm_sho25))
# # fitDist(resid(modelsmm_sho25))
# # histDist(resid(modelsmm_sho25), family = "NO")
# # #plot residuals
# # plot(modelsmm_sho25)
# # 
# # #print coefficients. Estimate tells you the trend, eg here, for every year you expect a .01%
# # #decrease. P-value shows (if) it is significant
# # piecewiseSEM::coefs(modelsmm_sho25)
# # irvbfp_sho25_coefs<-piecewiseSEM::coefs(modelsmm_sho25)
# # piecewiseSEM::rsquared(modelsmm_sho25)
# # 
# # #plot the actual model to visualize what the Estimate and p-value told you
# # library(effects)
# # plot(effect("RelYear", modelsmm_sho25))
# 
# 
ggplot(smm_sho25, aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(smm_sho25, aes(x = as.factor(RelYear2), y = Sample_mean_age_qualifier, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw()

ggplot(smm_sho25, aes(x = as.factor(RelYear2), y = QuadSize_m2, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

ggplot(smm_sho25, aes(x = as.factor(RelYear2), y = Subtidal, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

ggplot(smm_sho25, aes(x = as.factor(RelYear2), y = NumberMeasured_n, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

ggplot(smm_sho25, aes(x = as.factor(RelYear2), y = as.factor(MinimumSizeMeasured_mm), color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

# 
# 
# saveRDS(smm_sho25_glmm, here::here('GLMMs/AllDates/smm_sho25_glmm.rds'))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}

#Most years of data are from programs 5070 and 5072, which only included specimens 35mm and up.
smm_sh35to75 <- subset(smm_sho25, smm_sho25$ShellHeight_mm > 35 & smm_sho25$ShellHeight_mm < 75)
saveRDS(smm_sh35to75, here::here(paste0('GLMMs/AllDates/Data/smm_sh35to75_', Sys.Date(), '.rds')))

ggplot(smm_sh35to75, aes(x = as.factor(RelYear2), y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

#Converged, intercept was significant.
smm_sh35to75_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 35, ub = 75) ~ 1, data = subset(smm_sh35to75, smm_sh35to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/smm_sh35to75_glmm_hist1.rds")
smm_sh35to75_glmm_hist1 <- add_criterion(smm_sh35to75_glmm_hist1, "loo")

#model nearly converged
smm_sh35to75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 35, ub = 75) ~ RelYear2, data = subset(smm_sh35to75, smm_sh35to75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/smm_sh35to75_glmm_hist2.rds")
smm_sh35to75_glmm_hist2 <- add_criterion(smm_sh35to75_glmm_hist2, "loo")

```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}

smm_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "St. Martins Marsh_Natural")
smm_sho75[, QuadSize_m2 := as.factor(QuadSize_m2)]
smm_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
smm_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
smm_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(smm_sho75, here::here(paste0('GLMMs/AllDates/Data/smm_sho75_', Sys.Date(), '.rds')))

ggplot(smm_sho75, aes(x = as.factor(RelYear2), y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw()

#Converged, intercept is significant.
smm_sho75_glmm_hist1 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ 1, data = subset(smm_sho75, smm_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/smm_sho75_glmm_hist1.rds")
smm_sho75_glmm_hist1 <- add_criterion(smm_sho75_glmm_hist1, "loo")

#Model converged, RelYear term was not significant.
smm_sho75_glmm_hist2 <- brm(formula = ShellHeight_mm | trunc(lb = 75, ub = 250) ~ RelYear2, data = subset(smm_sho75, smm_sho75$Sample_mean_age_qualifier == "Estimate"), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/smm_sho75_glmm_hist2.rds")
smm_sho75_glmm_hist2 <- add_criterion(smm_sho75_glmm_hist2, "loo")

```

```{r message=FALSE, warning=FALSE, include=FALSE}
smm_sho25 <- subset(sh_o25, sh_o25$MA_plotlab == "St. Martins Marsh_Natural")
smm_sho25[, QuadSize_m2 := as.factor(QuadSize_m2)]
smm_sho25[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
smm_sho25[, RelYear := LiveDate2 - min(LiveDate2)]
smm_sho25[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(smm_sho25, here::here(paste0('GLMMs/AllDates/Data/smm_sho25_', Sys.Date(), '.rds')))

#smm_sho25_glmm <- readRDS(here::here('GLMMs/AllDates/smm_sho25_glmm.rds'))

smm_sh35to75 <- subset(smm_sho25, smm_sho25$ShellHeight_mm > 35 & smm_sho25$ShellHeight_mm < 75)
saveRDS(smm_sh35to75, here::here(paste0('GLMMs/AllDates/Data/smm_sh35to75_', Sys.Date(), '.rds')))

smm_sh35to75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/smm_sh35to75_glmm_hist2.rds'))

smm_sho75 <- subset(sh_o75, sh_o75$MA_plotlab == "St. Martins Marsh_Natural")
smm_sho75[, QuadSize_m2 := as.factor(QuadSize_m2)]
smm_sho75[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
smm_sho75[, RelYear := LiveDate2 - min(LiveDate2)]
smm_sho75[, RelYear2 := Sample_mean_age - min(Sample_mean_age)]
saveRDS(smm_sho75, here::here(paste0('GLMMs/AllDates/Data/smm_sho75_', Sys.Date(), '.rds')))

smm_sho75_glmm_hist <- readRDS(here::here('GLMMs/AllDates/smm_sho75_glmm_hist2.rds'))

```

##### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

smm_sho25[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
smm_sho25[, SampleDay := day(SampleDate)]

if(length(subset(smm_sho25, smm_sho25$Sample_mean_age_qualifier == "Exact")$ShellHeight_mm) > 0){
  sh_t <- copy(smm_sho25[0, ])
  sh_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
  for(i in unique(as.numeric(smm_sho25$Month))){
    mo <- subset(smm_sho25, as.numeric(smm_sho25$Month) == i)
    ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
           ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                  ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                         ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                                ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                       ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                              ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                     ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                            ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                   ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                          ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
    sh_t <- rbind(mo, sh_t)
  }
  
  monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))
  
  #Create the sampling dates correspondence plot
  SampleDatesPlot <- ggplot(subset(sh_t, sh_t$LiveDate_Qualifier == "Exact"), aes(x = DayNum, y = as.factor(ProgramID), color = Year, shape = Season)) +
                        geom_point(size = 3) +
                        geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                        geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                        xlim(1,365) +
                        scale_x_continuous(breaks = NULL) +
                        coord_cartesian(xlim = c(1, 366)) +
                        theme_bw()+labs(x = "Sample Date", y = "Program ID")
  print(SampleDatesPlot)
  
  #Remove the objects after the plot is done.
  rm(sh_t, monthnames, SampleDatesPlot)

} else{
  
  print("There are no real-time data for this managed area.")
  
}

```

<br><br><br>

##### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_specimens = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for size class 25-75mm first.
sh35to75_status <- subset(smm_sh35to75, smm_sh35to75$Sample_mean_age %in% StatusYears)
sh35to75_status[, `:=` (Indicator = "Size Class", 
                        SizeClass = "25-75mm", 
                        Year = as.numeric(Sample_mean_age), 
                        n_reefs = length(unique(ReefIdentifier)),
                        n_programs = length(unique(ProgramID)),
                        ProgIDs = list(unique(ProgramID)),
                        n_specimens = length(ShellHeight_mm),
                        Median = median(ShellHeight_mm),
                        Mean = round(mean(ShellHeight_mm), digits = 2),
                        SD = round(sd(ShellHeight_mm), digits = 2), 
                        Min. = min(ShellHeight_mm),
                        Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sh35to75_status <- unique(sh35to75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sh35to75_status <- sh35to75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sh35to75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sh35to75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = "25-75mm",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sh35to75_status <- rbind(sh35to75_status, MissingYr_i)
  }
}

#Build status table for size class >75mm next.
sho75_status <- subset(smm_sho75, smm_sho75$Sample_mean_age %in% StatusYears)
sho75_status[, `:=` (Indicator = "Size Class", 
                     SizeClass = ">75mm", 
                     Year = as.numeric(Sample_mean_age), 
                     n_reefs = length(unique(ReefIdentifier)),
                     n_programs = length(unique(ProgramID)),
                     ProgIDs = list(unique(ProgramID)),
                     n_specimens = length(ShellHeight_mm),
                     Median = median(ShellHeight_mm),
                     Mean = round(mean(ShellHeight_mm), digits = 2),
                     SD = round(sd(ShellHeight_mm), digits = 2), 
                     Min. = min(ShellHeight_mm),
                     Max. = max(ShellHeight_mm)),
                by = Sample_mean_age]

sho75_status <- unique(sho75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max."))
sho75_status <- sho75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_specimens", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, sho75_status$Year) == FALSE){
  for(i in setdiff(StatusYears, sho75_status$Year)){
    MissingYr_i <- data.table(Indicator = "Size Class", 
                              SizeClass = ">75mm",
                              Year = i,
                              n_reefs = ifelse(sh35to75_status[Year == i, n_reefs] > 0, sh35to75_status[Year == i, n_reefs], 0),
                              n_programs = ifelse(sh35to75_status[Year == i, n_programs] > 0, sh35to75_status[Year == i, n_programs], 0),
                              ProgIDs = ifelse(!is.na(sh35to75_status[Year == i, ProgIDs]), sh35to75_status[Year == i, ProgIDs], NA),
                              n_specimens = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    sho75_status <- rbind(sho75_status, MissingYr_i)
  }
}

#Merge individual size class tables and set row order
Status <- rbind(Status, sh35to75_status)
Status <- rbind(Status, sho75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) %>%
  kable_styling() %>%
  row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, sh25to75_status, MissingYr_i, sho75_status)
```

<br><br><br>

##### Variable Exploration:

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(smm_sho25, aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(smm_sho25, aes(x = as.factor(RelYear2), y = Sample_mean_age_qualifier, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw()

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
ggplot(smm_sho25, aes(x = as.factor(RelYear2), y = QuadSize_m2, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

ggplot(smm_sho25, aes(x = as.factor(RelYear2), y = Subtidal, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
ggplot(smm_sho25, aes(x = as.factor(RelYear2), y = NumberMeasured_n, color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

ggplot(smm_sho25, aes(x = as.factor(RelYear2), y = as.factor(MinimumSizeMeasured_mm), color = as.factor(ProgramID))) +
  geom_jitter() +
  theme_bw()

```

<br><br>

Note that for one of the years of the real-time data, a maximum of 25 specimens were measured per sample (see next plot showing counts of specimens per sample on the y axis and separate plots by NumberMeasured_n).

<br>

```{r echo=TRUE, message=FALSE, warning=FALSE, out.width="50%"}
smm_sho25[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", LiveDate2, "-", Month)]
numValves <- smm_sho25[, counts := length(ShellHeight_mm), by = c("rc_quad_yrmo")]
numValves <- unique(numValves[, c("ProgramID", "RelYear2", "counts", "rc_quad_yrmo", "Subtidal", "QuadSize_m2", "LiveDate_Qualifier", "NumberMeasured_n")])

ggplot(subset(numValves, numValves$LiveDate_Qualifier != "Estimate"), aes(x = RelYear2, y = counts)) +
  geom_jitter(aes(fill = rc_quad_yrmo), color = "black", shape = 21, width = 0.5, height = 0) +
  #geom_boxplot(aes(group = RelYear2, color = Subtidal), alpha = 0.5, lwd = 1) +
  facet_wrap(~ as.factor(NumberMeasured_n), scales = "free") +
  guides(fill = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(1846, 1852))

```

<br><br><br>

##### Model Output: {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- summary(smm_sho25_glmm) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height 25-75mm

Important: note that this analysis is focused on oyster specimens from surveys of archaeological middens and it assumes that the estimated sample ages are correct and that all specimens in a sample lived at the estimated age of the sample (i.e., time-averaging is not accounted for in the model), which is almost certainly not the case. Archaeological samples have an additional type of error that is not present for historical size class estimates from death assemblages (e.g., those from Program ID 5035), which is that they were gathered by humans, so they didn't die in-place; this means a single midden sample is possibly a mix of shells from oysters from multiple different reefs.

<br><br>

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(smm_sh35to75_glmm_hist)
```

<br><br><br>


###### Shell height >75mm

Important: note that this analysis is focused on oyster specimens from surveys of archaeological middens and it assumes that the estimated sample ages are correct and that all specimens in a sample lived at the estimated age of the sample (i.e., time-averaging is not accounted for in the model), which is almost certainly not the case. Archaeological samples have an additional type of error that is not present for historical size class estimates from death assemblages (e.g., those from Program ID 5035), which is that they were gathered by humans, so they didn't die in-place; this means a single midden sample is possibly a mix of shells from oysters from multiple different reefs.

<br><br>

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(smm_sho75_glmm_hist)
```

<br><br><br>

##### Diagnostic Plots {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- Posterior distributions and Markov chains: -->

<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_smm_PDistandMChains_o25 <- plot(smm_sho25_glmm) -->
<!-- SH_AllDates_GLMM_smm_PDistandMChains_o25 -->

<!-- len <- length(SH_AllDates_GLMM_smm_PDistandMChains_o25) -->
<!-- for(i in 1:len){ -->
<!--   jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_smm_PDistandMChains_o25_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300) -->
<!--   print(SH_AllDates_GLMM_smm_PDistandMChains_o25[i]) -->
<!--   dev.off() -->
<!-- } -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- Posterior predictive check plot: -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- SH_AllDates_GLMM_smm_PPcheck_o25 <- pp_check(smm_sho25_glmm) -->
<!-- SH_AllDates_GLMM_smm_PPcheck_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_smm_PPcheck_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_smm_PPcheck_o25, -->
<!--        width = 4, -->
<!--        height = 3, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height 25-75mm

Important: note that this analysis is focused on oyster specimens from surveys of archaeological middens and it assumes that the estimated sample ages are correct and that all specimens in a sample lived at the estimated age of the sample (i.e., time-averaging is not accounted for in the model), which is almost certainly not the case. Archaeological samples have an additional type of error that is not present for historical size class estimates from death assemblages (e.g., those from Program ID 5035), which is that they were gathered by humans, so they didn't die in-place; this means a single midden sample is possibly a mix of shells from oysters from multiple different reefs.

<br><br>

Posterior distributions and Markov chains:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_smm_PDistandMChains_35to75_hist <- plot(smm_sh35to75_glmm_hist)
SH_AllDates_GLMM_smm_PDistandMChains_35to75_hist

len <- length(SH_AllDates_GLMM_smm_PDistandMChains_35to75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_smm_PDistandMChains_35to75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_smm_PDistandMChains_35to75_hist[i])
  dev.off()
}
```

<br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_smm_PPcheck_35to75_hist <- pp_check(smm_sh35to75_glmm_hist)
SH_AllDates_GLMM_smm_PPcheck_35to75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_smm_PPcheck_35to75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_smm_PPcheck_35to75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>


###### Shell height >75mm

Important: note that this analysis is focused on oyster specimens from surveys of archaeological middens and it assumes that the estimated sample ages are correct and that all specimens in a sample lived at the estimated age of the sample (i.e., time-averaging is not accounted for in the model), which is almost certainly not the case. Archaeological samples have an additional type of error that is not present for historical size class estimates from death assemblages (e.g., those from Program ID 5035), which is that they were gathered by humans, so they didn't die in-place; this means a single midden sample is possibly a mix of shells from oysters from multiple different reefs.

<br><br>

Posterior distributions and Markov chains:

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_smm_PDistandMChains_o75_hist <- plot(smm_sho75_glmm_hist)
SH_AllDates_GLMM_smm_PDistandMChains_o75_hist

len <- length(SH_AllDates_GLMM_smm_PDistandMChains_o75_hist)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/SH_AllDates_GLMM_smm_PDistandMChains_o75_hist_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(SH_AllDates_GLMM_smm_PDistandMChains_o75_hist[i])
  dev.off()
}
```

<br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
SH_AllDates_GLMM_smm_PPcheck_o75_hist <- pp_check(smm_sho75_glmm_hist)
SH_AllDates_GLMM_smm_PPcheck_o75_hist

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_smm_PPcheck_o75_hist_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_smm_PPcheck_o75_hist,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Marginal Effects Plots {.tabset .tabset-fade .tabset-pills}

<!-- ###### Shell height >25mm -->

<!-- Including the random effect of reef (i.e., managed area-wide credible interval): -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Marginal effects plot including random effects -->
<!-- smm_sho25_1 <- plot(conditional_effects(smm_sho25_glmm, re_formula = NULL), plot = FALSE)[[1]] -->
<!-- SH_AllDates_GLMM_smm_MEPrand_o25 <- smm_sho25_1 + -->
<!--   geom_point(data = smm_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_smm_MEPrand_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_smm_MEPrand_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_smm_MEPrand_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- Excluding the random effect of reef (i.e., sampled population credible interval): -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Marginal effects plot excluding random effects -->
<!-- smm_sho25_2 <- plot(conditional_effects(smm_sho25_glmm, re_formula = NA), plot = FALSE)[[1]] -->
<!-- SH_AllDates_GLMM_smm_MEPnorand_o25 <- smm_sho25_2 + -->
<!--   geom_point(data = smm_sho25, aes(x = RelYear, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) + -->
<!--   theme_bw() -->
<!-- SH_AllDates_GLMM_smm_MEPnorand_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_smm_MEPnorand_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_smm_MEPnorand_o25, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

<!-- Individual effects plots: -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Individual effects plots -->
<!-- SH_AllDates_GLMM_smm_IEP_o25 <- smm_sho25 %>% -->
<!--   group_by(reefIDcrosswalk) %>% -->
<!--   add_fitted_draws(smm_sho25_glmm) %>% -->
<!--   ggplot(aes(x = RelYear, y = ShellHeight_mm, color = reefIDcrosswalk)) + -->
<!--   stat_lineribbon(aes(y = .value), size = 1) + -->
<!--   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) + -->
<!--   geom_point(data = smm_sho25) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") + -->
<!--   #geom_line(aes(y = .value), linetype = "dashed", color = "black") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   #scale_color_brewer(palette = "Set2") + -->
<!--   theme_bw() + -->
<!--   facet_wrap(~ reefIDcrosswalk, ncol = 3) -->
<!-- SH_AllDates_GLMM_smm_IEP_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_smm_IEP_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_smm_IEP_o25, -->
<!--        width = 10, -->
<!--        height = 30, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height 25-75mm

Important: note that this analysis is focused on oyster specimens from surveys of archaeological middens and it assumes that the estimated sample ages are correct and that all specimens in a sample lived at the estimated age of the sample (i.e., time-averaging is not accounted for in the model), which is almost certainly not the case. Archaeological samples have an additional type of error that is not present for historical size class estimates from death assemblages (e.g., those from Program ID 5035), which is that they were gathered by humans, so they didn't die in-place; this means a single midden sample is possibly a mix of shells from oysters from multiple different reefs.

<br><br>

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, fig.show="hold", message = FALSE, warning = FALSE, out.width="50%"}
#Marginal effects plot including random effects
#sort(unique(smm_sh35to75$Sample_mean_age))
labs1 <- c(167, 382, 644, 892, 2018)

set.seed(987)
smm_sh35to75_hist1 <- plot(conditional_effects(smm_sh35to75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]
SH_AllDates_GLMM_SMM_MEPrand_35to75_allYr <- smm_sh35to75_hist1 +
  geom_jitter(data = smm_sh35to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.1, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "red", lwd = 1) +
  geom_boxplot(data = subset(smm_sh35to75, smm_sh35to75$LiveDate_Qualifier == "Exact"), aes(x = 1850, y = ShellHeight_mm), color = "blue", lwd = 1, alpha = 0.5, width = 30, inherit.aes = FALSE) +
  geom_text(data = subset(smm_sh35to75, smm_sh35to75$Sample_mean_age %in% labs1), aes(y = 33, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID")
SH_AllDates_GLMM_SMM_MEPrand_35to75_allYr

SH_AllDates_GLMM_SMM_MEPrand_35to75_rtonly <- SH_AllDates_GLMM_SMM_MEPrand_35to75_allYr
SH_AllDates_GLMM_SMM_MEPrand_35to75_rtonly$layers[[5]] <- NULL
SH_AllDates_GLMM_SMM_MEPrand_35to75_rtonly <- SH_AllDates_GLMM_SMM_MEPrand_35to75_rtonly +
                                                    geom_boxplot(data = subset(smm_sh35to75, smm_sh35to75$Sample_mean_age_qualifier == "Exact"), aes(x = 1850, y = ShellHeight_mm), color = "blue", alpha = 0.15, lwd = 1, width = 4, inherit.aes = FALSE) +
                                                    coord_cartesian(xlim = c(1820, 1852)) +
                                                    theme(legend.position = "right")
SH_AllDates_GLMM_SMM_MEPrand_35to75_rtonly


ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_SMM_MEPrand_35to75_allYr_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_SMM_MEPrand_35to75_allYr,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_SMM_MEPrand_35to75_rtonly_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_SMM_MEPrand_35to75_rtonly,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):

```{r echo=TRUE, fig.show="hold", message = FALSE, warning = FALSE, out.width="50%"}
#Marginal effects plot excluding random effects
#sort(unique(smm_sh35to75$Sample_mean_age))
labs1 <- c(167, 382, 644, 892, 2018)

set.seed(765)
smm_sh35to75_hist2 <- plot(conditional_effects(smm_sh35to75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]
SH_AllDates_GLMM_SMM_MEPnorand_35to75_allYr <- smm_sh35to75_hist2 +
  geom_jitter(data = smm_sh35to75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.1, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "red", lwd = 1) +
  geom_boxplot(data = subset(smm_sh35to75, smm_sh35to75$LiveDate_Qualifier == "Exact"), aes(x = 1850, y = ShellHeight_mm), color = "blue", lwd = 1, alpha = 0.5, width = 30, inherit.aes = FALSE) +
  geom_text(data = subset(smm_sh35to75, smm_sh35to75$Sample_mean_age %in% labs1), aes(y = 33, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID")
SH_AllDates_GLMM_SMM_MEPnorand_35to75_allYr

SH_AllDates_GLMM_SMM_MEPnorand_35to75_rtonly <- SH_AllDates_GLMM_SMM_MEPnorand_35to75_allYr
SH_AllDates_GLMM_SMM_MEPnorand_35to75_rtonly$layers[[5]] <- NULL
SH_AllDates_GLMM_SMM_MEPnorand_35to75_rtonly <- SH_AllDates_GLMM_SMM_MEPnorand_35to75_rtonly +
                                                    geom_boxplot(data = subset(smm_sh35to75, smm_sh35to75$Sample_mean_age_qualifier == "Exact"), aes(x = 1850, y = ShellHeight_mm), color = "blue", alpha = 0.15, lwd = 1, width = 4, inherit.aes = FALSE) +
                                                    coord_cartesian(xlim = c(1820, 1852)) +
                                                    theme(legend.position = "right")
SH_AllDates_GLMM_SMM_MEPnorand_35to75_rtonly


ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_SMM_MEPnorand_35to75_allYr_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_SMM_MEPrand_35to75_allYr,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_SMM_MEPnorand_35to75_rtonly_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_SMM_MEPrand_35to75_rtonly,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

<!-- Individual effects plots: -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Individual effects plots -->
<!-- smm_sh35to75_hist <- subset(smm_sh35to75, smm_sh35to75$Sample_mean_age_qualifier == "Estimate") -->
<!-- #smm_sh35to75_hist$reefIDcrosswalk <- droplevels(smm_sh35to75_hist$reefIDcrosswalk) -->

<!-- SH_AllDates_GLMM_SMM_IEP_35to75_hist <- smm_sh35to75_hist %>% -->
<!--   group_by(reefIDcrosswalk) %>% -->
<!--   add_fitted_draws(smm_sh35to75_glmm_hist) %>% -->
<!--   ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk), size = 3) + -->
<!--   stat_lineribbon(aes(y = .value), size = 1) + -->
<!--   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) + -->
<!--   geom_point(data = smm_sh35to75_hist) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") + -->
<!--   #geom_line(aes(y = .value), linetype = "dashed", color = "black") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   #scale_color_brewer(palette = "Set2") + -->
<!--   geom_text(data = smm_sh35to75_hist, aes(y = 15, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) + -->
<!--   #geom_text(data = subset(gtmn_sh35to75, gtmn_sh35to75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) + -->
<!--   theme_bw() + theme(axis.line = element_line()) + -->
<!--   scale_x_continuous(limits = c(min(smm_sh35to75_hist$RelYear2) - 1, max(smm_sh35to75_hist$RelYear2) + 1)) + -->
<!--   #scale_y_continuous(limits = c(0, 50000)) + -->
<!--   coord_cartesian(ylim = c(10, 75)) + -->
<!--   #theme(legend.position = "none") + -->
<!--   labs(color = "Reef ID", fill = "Credible Interval") + -->
<!--   facet_wrap(~ reefIDcrosswalk, ncol = 1, scales = "free") -->
<!-- SH_AllDates_GLMM_SMM_IEP_35to75_hist -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_smm_MEPrand_35to75_hist", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_smm_MEPrand_35to75_hist, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<!-- <br><br><br><br> -->

###### Shell height >75mm

Important: note that this analysis is focused on oyster specimens from surveys of archaeological middens and it assumes that the estimated sample ages are correct and that all specimens in a sample lived at the estimated age of the sample (i.e., time-averaging is not accounted for in the model), which is almost certainly not the case. Archaeological samples have an additional type of error that is not present for historical size class estimates from death assemblages (e.g., those from Program ID 5035), which is that they were gathered by humans, so they didn't die in-place; this means a single midden sample is possibly a mix of shells from oysters from multiple different reefs.

<br><br>

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, fig.show="hold", message = FALSE, warning = FALSE, out.width="50%"}
#Marginal effects plot including random effects
#sort(unique(smm_sho75$Sample_mean_age))
labs1 <- c(167, 382, 644, 892, 2018)

set.seed(987)
smm_sho75_hist1 <- plot(conditional_effects(smm_sho75_glmm_hist, re_formula = NULL), plot = FALSE)[[1]]
SH_AllDates_GLMM_SMM_MEPrand_o75_allYr <- smm_sho75_hist1 +
  geom_jitter(data = smm_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.1, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "red", lwd = 1) +
  geom_boxplot(data = subset(smm_sho75, smm_sho75$LiveDate_Qualifier == "Exact"), aes(x = 1850, y = ShellHeight_mm), color = "blue", lwd = 1, alpha = 0.5, width = 30, inherit.aes = FALSE) +
  geom_text(data = subset(smm_sho75, smm_sho75$Sample_mean_age %in% labs1), aes(y = 72, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID")
SH_AllDates_GLMM_SMM_MEPrand_o75_allYr

SH_AllDates_GLMM_SMM_MEPrand_o75_rtonly <- SH_AllDates_GLMM_SMM_MEPrand_o75_allYr
SH_AllDates_GLMM_SMM_MEPrand_o75_rtonly$layers[[5]] <- NULL
SH_AllDates_GLMM_SMM_MEPrand_o75_rtonly <- SH_AllDates_GLMM_SMM_MEPrand_o75_rtonly +
                                                    geom_boxplot(data = subset(smm_sho75, smm_sho75$Sample_mean_age_qualifier == "Exact"), aes(x = 1850, y = ShellHeight_mm), color = "blue", alpha = 0.15, lwd = 1, width = 4, inherit.aes = FALSE) +
                                                    coord_cartesian(xlim = c(1820, 1852)) +
                                                    theme(legend.position = "right")
SH_AllDates_GLMM_SMM_MEPrand_o75_rtonly


ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_SMM_MEPrand_o75_allYr_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_SMM_MEPrand_o75_allYr,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_SMM_MEPrand_o75_rtonly_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_SMM_MEPrand_o75_rtonly,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, fig.show="hold", message = FALSE, warning = FALSE, out.width="50%"}
#Marginal effects plot excluding random effects
#sort(unique(smm_sho75$Sample_mean_age))
labs1 <- c(167, 382, 644, 892, 2018)

set.seed(765)
smm_sho75_hist2 <- plot(conditional_effects(smm_sho75_glmm_hist, re_formula = NA), plot = FALSE)[[1]]
SH_AllDates_GLMM_SMM_MEPnorand_o75_allYr <- smm_sho75_hist2 +
  geom_jitter(data = smm_sho75, aes(x = RelYear2, y = ShellHeight_mm, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.1, color = "black", inherit.aes = FALSE) +
  geom_ribbon(fill = "grey", alpha = 0.4) +
  geom_line(aes(y = estimate__), color = "red", lwd = 1) +
  geom_boxplot(data = subset(smm_sho75, smm_sho75$LiveDate_Qualifier == "Exact"), aes(x = 1850, y = ShellHeight_mm), color = "blue", lwd = 1, alpha = 0.5, width = 30, inherit.aes = FALSE) +
  geom_text(data = subset(smm_sho75, smm_sho75$Sample_mean_age %in% labs1), aes(y = 72, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) +
  theme_bw()  + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +
  labs(fill = "Reef ID")
SH_AllDates_GLMM_SMM_MEPnorand_o75_allYr

SH_AllDates_GLMM_SMM_MEPnorand_o75_rtonly <- SH_AllDates_GLMM_SMM_MEPnorand_o75_allYr
SH_AllDates_GLMM_SMM_MEPnorand_o75_rtonly$layers[[5]] <- NULL
SH_AllDates_GLMM_SMM_MEPnorand_o75_rtonly <- SH_AllDates_GLMM_SMM_MEPnorand_o75_rtonly +
                                                    geom_boxplot(data = subset(smm_sho75, smm_sho75$Sample_mean_age_qualifier == "Exact"), aes(x = 1850, y = ShellHeight_mm), color = "blue", alpha = 0.15, lwd = 1, width = 4, inherit.aes = FALSE) +
                                                    coord_cartesian(xlim = c(1820, 1852)) +
                                                    theme(legend.position = "right")
SH_AllDates_GLMM_SMM_MEPnorand_o75_rtonly


ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_SMM_MEPnorand_o75_allYr_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_SMM_MEPnorand_o75_allYr,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_SMM_MEPnorand_o75_rtonly_", Sys.Date(), ".jpeg")),
       SH_AllDates_GLMM_SMM_MEPnorand_o75_rtonly,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br><br>

<!-- Individual effects plots: -->
<!-- ```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"} -->
<!-- #Individual effects plots -->

<!-- sort(unique(smm_sho75_hist$Sample_mean_age)) -->
<!-- labs1 <- c(1929, 1954, 1972, 1979, 1983, 1992, 1994, 2003, 2004) -->

<!-- smm_sho75_hist <- subset(smm_sho75, smm_sho75$Sample_mean_age_qualifier == "Estimate") -->
<!-- #smm_sho75_hist$reefIDcrosswalk <- droplevels(smm_sho75_hist$reefIDcrosswalk) -->

<!-- SH_AllDates_GLMM_smm_IEP_o75_hist <- smm_sho75_hist %>% -->
<!--   group_by(reefIDcrosswalk) %>% -->
<!--   add_fitted_draws(smm_sho75_glmm_hist) %>% -->
<!--   ggplot(aes(x = RelYear2, y = ShellHeight_mm, color = reefIDcrosswalk), size = 3) + -->
<!--   stat_lineribbon(aes(y = .value), size = 1) + -->
<!--   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) + -->
<!--   geom_point(data = smm_sho75_hist) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") + -->
<!--   #geom_line(aes(y = .value), linetype = "dashed", color = "black") + -->
<!--   scale_fill_brewer(palette = "Greys") + -->
<!--   #scale_color_brewer(palette = "Set2") + -->
<!--   geom_text(data = subset(smm_sho75_hist, smm_sho75_hist$Sample_mean_age %in% labs1), aes(y = 70, label = Sample_mean_age, x = RelYear2), size = 3.5, col = "grey30", inherit.aes = FALSE) + -->
<!--   #geom_text(data = subset(gtmn_sho75, gtmn_sho75$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) + -->
<!--   theme_bw() + theme(axis.line = element_line()) + -->
<!--   scale_x_continuous(limits = c(min(smm_sho75_hist$RelYear2) - 1, max(smm_sho75_hist$RelYear2) + 1)) + -->
<!--   #scale_y_continuous(limits = c(0, 50000)) + -->
<!--   coord_cartesian(ylim = c(68, 125)) + -->
<!--   #theme(legend.position = "none") + -->
<!--   labs(color = "Reef ID", fill = "Credible Interval") + -->
<!--   facet_wrap(~ reefIDcrosswalk, ncol = 1, scales = "free") -->
<!-- SH_AllDates_GLMM_smm_IEP_o75_hist -->

<!-- ggsave(here::here(paste0("OA_plots/SH_AllDates_GLMM_smm_IEP_o75_hist", Sys.Date(), ".jpeg")), -->
<!--        SH_AllDates_GLMM_smm_IEP_o75_hist, -->
<!--        width = 10, -->
<!--        height = 6, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

```{r include=FALSE}
# Remove created objects to save memory.
rm(smm_sho25, smm_sh35to75, smm_sh35to75_glmm_hist, 
   smm_sho75, smm_sho75_glmm_hist, 
   SH_AllDates_GLMM_SMM_PDistandMChains_35to75, SH_AllDates_GLMM_SMM_PDistandMChains_o75,
   SH_AllDates_GLMM_SMM_PPcheck_35to75, SH_AllDates_GLMM_SMM_PPcheck_o75,
   SH_AllDates_GLMM_SMM_MEPrand_35to75, SH_AllDates_GLMM_SMM_MEPrand_o75,
   SH_AllDates_GLMM_SMM_MEPnorand_35to75_allYr, SH_AllDates_GLMM_SMM_MEPnorand_35to75_rtonly, 
   SH_AllDates_GLMM_SMM_MEPnorand_o75_allYr, SH_AllDates_GLMM_SMM_MEPnorand_o75_rtonly  #,
   #SH_AllDates_GLMM_SMM_IEP_35to75, SH_AllDates_GLMM_SMM_IEP_o75
   )

```

### Boxplots of shell height {.tabset .tabset-fade}

#### Shell height >25mm {.tabset .tabset-fade .tabset-pills}

##### 1950-2020

```{r AvgSHbyReefandYRo25-boxplots-1950-2020, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot boxplots of shell height (>25mm) by year (limited to 1950-2020)
SH_AllDates_BoxplotAvgModvHist1950to2020_o25 <- ggplot(sh_o25_avgmod_all, aes(LiveDate2, ShellHeight_mm)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_boxplot(color = "red") +
  geom_boxplot(data = sh_o25_histdat_all, aes(group = LiveDate2), color = "blue") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  xlim(1950, 2020)
SH_AllDates_BoxplotAvgModvHist1950to2020_o25

ggsave(here::here(paste0("OA_plots/SH_AllDates_BoxplotAvgModvHist1950to2020_o25_", Sys.Date(), ".jpeg")),
       SH_AllDates_BoxplotAvgModvHist1950to2020_o25,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

##### All years

```{r AvgSHbyReefandYRo25-boxplots-allyears, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot boxplots of shell height (>25mm) by year (all years)
SH_AllDates_BoxplotAvgModvHistAllYears_o25 <- ggplot(sh_o25_avgmod_all, aes(as.character(LiveDate2), ShellHeight_mm)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_boxplot(color = "red") +
  geom_boxplot(data = sh_o25_histdat_all, aes(group = as.character(LiveDate2)), color = "blue") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme(axis.text.x = element_text(angle = 90))
SH_AllDates_BoxplotAvgModvHistAllYears_o25

ggsave(here::here(paste0("OA_plots/SH_AllDates_BoxplotAvgModvHistAllYears_o25_", Sys.Date(), ".jpeg")),
       SH_AllDates_BoxplotAvgModvHistAllYears_o25,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

#### Shell height >75mm {.tabset .tabset-fade .tabset-pills}

##### 1950-2020

```{r AvgSHbyReefandYRo75-boxplots-1950-2020, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot boxplots of shell height (>75mm) by year (limited to 1950-2020)
SH_AllDates_BoxplotAvgModvHist1950to2020_o75 <- ggplot(sh_o75_avgmod_all, aes(LiveDate2, ShellHeight_mm)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_boxplot(color = "red") +
  geom_boxplot(data = sh_o75_histdat_all, aes(group = LiveDate2), color = "blue") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  xlim(1950, 2020)
SH_AllDates_BoxplotAvgModvHist1950to2020_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_BoxplotAvgModvHist1950to2020_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_BoxplotAvgModvHist1950to2020_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

##### All years

```{r AvgSHbyReefandYRo75-boxplots-allyears, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot boxplots of shell height (>75mm) by year (all years)
SH_AllDates_BoxplotAvgModvHistAllYears_o75 <- ggplot(sh_o75_avgmod_all, aes(as.character(LiveDate2), ShellHeight_mm)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_boxplot(color = "red") +
  geom_boxplot(data = sh_o75_histdat_all, aes(group = as.character(LiveDate2)), color = "blue") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme(axis.text.x = element_text(angle = 90))
SH_AllDates_BoxplotAvgModvHistAllYears_o75

ggsave(here::here(paste0("OA_plots/SH_AllDates_BoxplotAvgModvHistAllYears_o75_", Sys.Date(), ".jpeg")),
       SH_AllDates_BoxplotAvgModvHistAllYears_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```


<br><br><br>

***

## Live density

```{r DensitySetup, echo=TRUE, message=FALSE, warning=FALSE}
setDT(oysterraw_den)
# oysterraw_den <- oysterraw_den %>% mutate(SampleDate = mdy_hms(SampleDate))
# oysterraw_den[, Month := month(SampleDate)]
# oysterraw_den[, YrMo := paste0(Year, "-", Month)]

#More complicated conversion of date columns needed because ID_972 data do not have the hms format for time like the default in the combined table exports. When it eventually is corrected and fixed in the combined table export, then all program data should have the same SampleDate format and the above code should work again.
oysterraw_den_no972 <- setDT(subset(oysterraw_den, oysterraw_den$ProgramID != 972)) %>% mutate(SampleDate = mdy_hms(SampleDate))
oysterraw_den_no972[, Month := month(SampleDate)]
oysterraw_den_no972[, YrMo := paste0(Year, "-", Month)]

oysterraw_den_972 <- setDT(subset(oysterraw_den, oysterraw_den$ProgramID == 972)) %>% mutate(SampleDate = mdy_hm(SampleDate))
oysterraw_den_972[, Month := month(SampleDate)]
oysterraw_den_972[, YrMo := paste0(Year, "-", Month)]

oysterraw_den <- rbind(oysterraw_den_no972, oysterraw_den_972)

#Fix QuadID and ReefID columns for 2003 data in program 4014
Reefs_4014_2003 <- c('1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13')
Quads_4014_2003 <- c('1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '13', '14')
Fix4014 <- subset(oysterraw_den, oysterraw_den$ProgramID == 4014)
Fix4014[Year == 2003, QuadIdentifier := Quads_4014_2003]
Fix4014[Year == 2003, ReefIdentifier := Reefs_4014_2003]
Fix4014[Year == 2003, Density_m2 := Number_of_Oysters_Counted_Live_Count * 4]
no4014 <- subset(oysterraw_den, oysterraw_den$ProgramID != 4014)
oysterraw_den <- rbind(Fix4014, no4014)

#Fix density for program 972
#oysterraw_den <- oysterraw_den[ProgramID == 972, Density_m2 := (Number_of_Oysters_Counted_Live_Count/6) * 4]

#Fix density for program 4012
Fix4012 <- oysterraw_den[ProgramID == 4012, ][is.na(Density_m2), Density_m2 := Number_of_Oysters_Counted_Live_Count / as.numeric(QuadSize_m2)]
Fix4012 <- Fix4012[QuadIdentifier %like% "_Ref", HabitatClassification := "Natural"]
Fix4012 <- Fix4012[QuadIdentifier %like% "_C", HabitatClassification := "Natural"]
no4012 <- subset(oysterraw_den, oysterraw_den$ProgramID != 4012)
oysterraw_den <- rbind(Fix4012, no4012)

#Fix density for program 4042
Fix4042 <- oysterraw_den[ProgramID == 4042, ][is.na(Density_m2), Density_m2 := Number_of_Oysters_Counted_Live_Count / as.numeric(QuadSize_m2)]
no4042 <- subset(oysterraw_den, oysterraw_den$ProgramID != 4042)
oysterraw_den <- rbind(Fix4042, no4042)

#Fix density for program 4016
Fix4016 <- oysterraw_den[ProgramID == 4016, ][is.na(Density_m2), Density_m2 := Number_of_Oysters_Counted_Live_Count / as.numeric(QuadSize_m2)]
no4016 <- subset(oysterraw_den, oysterraw_den$ProgramID != 4016)
oysterraw_den <- rbind(Fix4016, no4016)

saveRDS(oysterraw_den, here::here(paste0("oysterraw_den_", Sys.Date(), ".rds")))
```

```{r echo=TRUE}
#Summarize density data by managed area
#oysterraw_den <- readRDS(here::here('oysterraw_den.rds'))
oysterraw_den_nona <- subset(oysterraw_den, !is.na(oysterraw_den$Density_m2))
oysterraw_den_nona[, Year := as.integer(Year)]
oysterraw_den_nona[ProgramID == 4000, QuadSize_m2 := 0.0625]
oysterraw_den_nona[ProgramID == 4000, Density_m2 := Number_of_Oysters_Counted_Total_Count/QuadSize_m2]
den_all_sum <- summarySE(oysterraw_den_nona, measurevar = 'Density_m2', groupvars = c('ManagedAreaName', 'Year'))

#Summarize density data by managed area (mean density 25mm <= x < 75)
oysterraw_den_r_seed <- readRDS(here::here('oysterraw_den_r_seed.rds'))
#Need to remove HOBS data and 5072 data from density because density of DA not comparable to live density.
oysterraw_den_r_seed_den <- subset(oysterraw_den_r_seed, oysterraw_den_r_seed$ProgramID != 5035)
oysterraw_den_r_seed_den <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$ProgramID != 5072)
oysterraw_den_r_seed_den[, meanDen_int := round(meanDen, digits = 0)]
den_25to75_sum <- summarySE(oysterraw_den_r_seed_den, measurevar = 'meanDen', groupvars = c('ManagedAreaName', 'LiveDate2'))
colnames(den_25to75_sum)[2] <- "Year"

#Summarize density data by managed area (mean density >= 75)
oysterraw_den_r_market <- readRDS(here::here('oysterraw_den_r_market.rds'))
#Need to remove HOBS data and 5072 data from density because density of DA not comparable to live density.
oysterraw_den_r_market_den <- subset(oysterraw_den_r_market, oysterraw_den_r_market$ProgramID != 5035)
oysterraw_den_r_market_den <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$ProgramID != 5072)
oysterraw_den_r_market_den[, meanDen_int := round(meanDen, digits = 0)]
den_o75_sum <- summarySE(oysterraw_den_r_market_den, measurevar = 'meanDen', groupvars = c('ManagedAreaName', 'LiveDate2'))
colnames(den_o75_sum)[2] <- "Year"

```

```{r DenSummaryTable-raw, echo=TRUE, message=FALSE, warning=FALSE}
#Create summary table showing number of reefs/programs of data included in oysterraw_den
oysterraw_den_nona[, nReefsbyMAandYr := length(unique(reefIDcrosswalk)), by = c('ManagedAreaName', 'Year')]
oysterraw_den_nona[, nProgsbyMAandYr := length(unique(ProgramID)), by = c('ManagedAreaName', 'Year')]
oysterraw_den_nona[, ProgsbyMAandYr := list(list(unique(ProgramID))), by = c('ManagedAreaName', 'Year')]
oysterraw_den_nona[, nProgsbyMA := length(unique(ProgramID)), by = 'ManagedAreaName']
oysterraw_den_nona[, ProgsbyMA := list(list(unique(ProgramID))), by = 'ManagedAreaName']

den_sum1 <- unique(oysterraw_den_nona[, .(ManagedAreaName, Year, nReefsbyMAandYr, nProgsbyMAandYr, nProgsbyMA)], by = c('ManagedAreaName', 'Year', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'nProgsbyMA'))
listcols <- oysterraw_den_nona[, .SD[1], by = c('ManagedAreaName', 'Year')][, .(ProgsbyMAandYr, ProgsbyMA)]
den_sum1 <- cbind(den_sum1, listcols)
setcolorder(den_sum1, c('ManagedAreaName', 'nProgsbyMA', 'ProgsbyMA', 'Year', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'))
setorder(den_sum1, ManagedAreaName, Year)

#Create easily readable table in knitted document
#Better column names
den_sum1_renamed <- setnames(den_sum1, c('nProgsbyMA', 'ProgsbyMA', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'), c('n progams_tot', 'programs_tot', 'n reefs_yr', 'n programs_yr', 'programs_yr'))

#Group names
groups <- c()
for(i in unique(den_sum1$ManagedAreaName)){
  name <- paste0(i, ", Total Programs = ", den_sum1[ManagedAreaName == i, 2][1], ": ", den_sum1[ManagedAreaName == i, 3][[1]])[1]
  groups <- append(groups, name)
}

```

<!-- ### Only 25-75mm shell height -->

```{r DenSummaryTable-25-75mm, echo=TRUE, message=FALSE, warning=FALSE}
#Create summary table showing number of reefs/programs of data included in oysterraw_den_r_seed_den
oysterraw_den_r_seed_den[, nReefsbyMAandYr := length(unique(reefIDcrosswalk)), by = c('ManagedAreaName', 'LiveDate2')]
oysterraw_den_r_seed_den[, nProgsbyMAandYr := length(unique(ProgramID)), by = c('ManagedAreaName', 'LiveDate2')]
oysterraw_den_r_seed_den[, ProgsbyMAandYr := list(list(unique(ProgramID))), by = c('ManagedAreaName', 'LiveDate2')]
oysterraw_den_r_seed_den[, nProgsbyMA := length(unique(ProgramID)), by = 'ManagedAreaName']
oysterraw_den_r_seed_den[, ProgsbyMA := list(list(unique(ProgramID))), by = 'ManagedAreaName']

den_sum1_seed <- unique(oysterraw_den_r_seed_den[, .(ManagedAreaName, LiveDate2, nReefsbyMAandYr, nProgsbyMAandYr, nProgsbyMA)], by = c('ManagedAreaName', 'LiveDate2', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'nProgsbyMA'))
listcols <- oysterraw_den_r_seed_den[, .SD[1], by = c('ManagedAreaName', 'LiveDate2')][, .(ProgsbyMAandYr, ProgsbyMA)]
den_sum1_seed <- cbind(den_sum1_seed, listcols)
setcolorder(den_sum1_seed, c('ManagedAreaName', 'nProgsbyMA', 'ProgsbyMA', 'LiveDate2', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'))
setorder(den_sum1_seed, ManagedAreaName, LiveDate2)

archeoyrs <- c(167, 382, 644, 892)
den_sum1_seed[, nReefsbyMAandYr := as.character(nReefsbyMAandYr)]
den_sum1_seed[LiveDate2 %in% archeoyrs, nReefsbyMAandYr := "Unknown"]


#Create easily readable table in knitted document
#Better column names
den_sum1_seed_renamed <- setnames(den_sum1_seed, c('nProgsbyMA', 'ProgsbyMA', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'), c('n progams_tot', 'programs_tot', 'n reefs_yr', 'n programs_yr', 'programs_yr'))

#Group names
groups <- c()
for(i in unique(den_sum1_seed$ManagedAreaName)){
  name <- paste0(i, ", Total Programs = ", den_sum1_seed[ManagedAreaName == i, 2][1], ": ", den_sum1_seed[ManagedAreaName == i, 3][[1]])[1]
  groups <- append(groups, name)
}

```

<!-- <br><br><br> -->

<!-- ### Only >75mm shell height -->

```{r DenSummaryTable-o75mm, echo=TRUE, message=FALSE, warning=FALSE}
#Create summary table showing number of reefs/programs of data included in oysterraw_den_r_market_den
oysterraw_den_r_market_den[, nReefsbyMAandYr := length(unique(reefIDcrosswalk)), by = c('ManagedAreaName', 'LiveDate2')]
oysterraw_den_r_market_den[, nProgsbyMAandYr := length(unique(ProgramID)), by = c('ManagedAreaName', 'LiveDate2')]
oysterraw_den_r_market_den[, ProgsbyMAandYr := list(list(unique(ProgramID))), by = c('ManagedAreaName', 'LiveDate2')]
oysterraw_den_r_market_den[, nProgsbyMA := length(unique(ProgramID)), by = 'ManagedAreaName']
oysterraw_den_r_market_den[, ProgsbyMA := list(list(unique(ProgramID))), by = 'ManagedAreaName']

den_sum1_market <- unique(oysterraw_den_r_market_den[, .(ManagedAreaName, LiveDate2, nReefsbyMAandYr, nProgsbyMAandYr, nProgsbyMA)], by = c('ManagedAreaName', 'LiveDate2', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'nProgsbyMA'))
listcols <- oysterraw_den_r_market_den[, .SD[1], by = c('ManagedAreaName', 'LiveDate2')][, .(ProgsbyMAandYr, ProgsbyMA)]
den_sum1_market <- cbind(den_sum1_market, listcols)
setcolorder(den_sum1_market, c('ManagedAreaName', 'nProgsbyMA', 'ProgsbyMA', 'LiveDate2', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'))
setorder(den_sum1_market, ManagedAreaName, LiveDate2)

archeoyrs <- c(167, 382, 644, 892)
den_sum1_market[, nReefsbyMAandYr := as.character(nReefsbyMAandYr)]
den_sum1_market[LiveDate2 %in% archeoyrs, nReefsbyMAandYr := "Unknown"]

#Create easily readable table in knitted document
#Better column names
den_sum1_market_renamed <- setnames(den_sum1_market, c('nProgsbyMA', 'ProgsbyMA', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'), c('n progams_tot', 'programs_tot', 'n reefs_yr', 'n programs_yr', 'programs_yr'))

#Group names
groups <- c()
for(i in unique(den_sum1_market$ManagedAreaName)){
  name <- paste0(i, ", Total Programs = ", den_sum1_market[ManagedAreaName == i, 2][1], ": ", den_sum1_market[ManagedAreaName == i, 3][[1]])[1]
  groups <- append(groups, name)
}

```

<!-- <br><br><br> -->

```{r AvgDenLive-setup-raw, message=FALSE, warning=FALSE, include=FALSE}
#Density, all and by reef
den_avg_all <- oysterraw_den_nona[, MeanDen := mean(Density_m2), by = c('ManagedAreaName', 'Year')][, sdDen := sd(Density_m2), by = c('Year', 'ManagedAreaName')][, semDen := sd(Density_m2)/sqrt(length(Density_m2)), by = c('Year', 'ManagedAreaName')][, nYears := length(unique(Year)), by = c('ManagedAreaName')][, MeanReefDen := mean(Density_m2), by = c('Year', 'ManagedAreaName', 'reefIDcrosswalk')][, sdReefDen := sd(Density_m2), by = c('Year', 'ManagedAreaName', 'reefIDcrosswalk')][, semReefDen := sd(Density_m2)/sqrt(length(Density_m2)), by = c('Year', 'ManagedAreaName', 'reefIDcrosswalk')][, nYearsReef := length(unique(Year)), by = c('ManagedAreaName', 'reefIDcrosswalk')]
#den_avg_reef <- unique(den_avg_all[, c(1:2, 8, 10, 12:15, 20, 22, 29:32)])
den_avg_reef <- unique(den_avg_all[, c("ProgramID", "ProgramName", "Year", "ManagedAreaName", "SurveyMethod", "HabitatClassification", "QuadSize_m2", "MADup", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "MeanReefDen", "sdReefDen", "semReefDen", "nYearsReef")])

```

<!-- <br><br><br> -->

```{r AvgDenLive-setup-25to75mm, message=FALSE, warning=FALSE, include=FALSE}
#Density, seed size and by reef
den_avg_seed_all <- oysterraw_den_r_seed_den[, MeanDen := mean(meanDen), by = c('ManagedAreaName', 'LiveDate2')][, sdDen := sd(meanDen), by = c('LiveDate2', 'ManagedAreaName')][, semDen := sd(meanDen)/sqrt(length(meanDen)), by = c('LiveDate2', 'ManagedAreaName')][, nYears := length(unique(LiveDate2)), by = c('ManagedAreaName')][, MeanReefDen := mean(meanDen), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk')][, sdReefDen := sd(meanDen), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk')][, semReefDen := sd(meanDen)/sqrt(length(meanDen)), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk')][, nYearsReef := length(unique(LiveDate2)), by = c('ManagedAreaName', 'reefIDcrosswalk')]
#den_avg_seed_reef <- unique(den_avg_seed_all[, c(1:2, 14, 16:21, 23:25, 42:45)])
den_avg_seed_reef <- unique(den_avg_seed_all[, c("ProgramID", "ProgramName", "ManagedAreaName", "SurveyMethod", "HabitatClassification", "MinimumSizeMeasured_mm", "NumberMeasured_n", "QuadSize_m2", "MADup", "reefIDcrosswalk", "LiveDate2", "MA_plotlab", "MeanReefDen", "sdReefDen", "semReefDen", "nYearsReef")])

```

<!-- <br><br><br> -->

```{r AvgDenLive-setup-o75mm, message=FALSE, warning=FALSE, include=FALSE}
#Density, market size and by reef
den_avg_market_all <- oysterraw_den_r_market_den[, MeanDen := mean(meanDen), by = c('ManagedAreaName', 'LiveDate2')][, sdDen := sd(meanDen), by = c('LiveDate2', 'ManagedAreaName')][, semDen := sd(meanDen)/sqrt(length(meanDen)), by = c('LiveDate2', 'ManagedAreaName')][, nYears := length(unique(LiveDate2)), by = c('ManagedAreaName')][, MeanReefDen := mean(meanDen), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk')][, sdReefDen := sd(meanDen), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk')][, semReefDen := sd(meanDen)/sqrt(length(meanDen)), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk')][, nYearsReef := length(unique(LiveDate2)), by = c('ManagedAreaName', 'reefIDcrosswalk')]
#den_avg_market_reef <- unique(den_avg_market_all[, c(1:2, 14, 16:21, 23:25, 42:45)])
den_avg_market_reef <- unique(den_avg_market_all[, c("ProgramID", "ProgramName", "ManagedAreaName", "SurveyMethod", "HabitatClassification", "MinimumSizeMeasured_mm", "NumberMeasured_n", "QuadSize_m2", "MADup", "reefIDcrosswalk", "LiveDate2", "MA_plotlab", "MeanReefDen", "sdReefDen", "semReefDen", "nYearsReef")])

```

<!-- <br><br><br> -->

### View the data {.tabset .tabset-fade}

#### Histograms {.tabset .tabset-fade .tabset-pills}

##### Raw density values

```{r AvgDenbyReefandYR-hist-raw, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#histogram of average shell height by reef and year
Den_AllDates_AvgbyReefandYr_raw <- ggplot(den_avg_reef, aes(MeanReefDen)) +
  geom_histogram(color = "black") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme_bw() + theme(axis.line = element_line()) #+
  #guides(color = FALSE) +
  #scale_x_continuous(limits = c(0, 150)) #+
  #scale_y_continuous(limits = c(0, 80))
  #coord_cartesian(ylim = c(-15, 40))
Den_AllDates_AvgbyReefandYr_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_AvgbyReefandYr_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_AvgbyReefandYr_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Only 25-75mm shell height

```{r AvgDenbyReefandYR-hist-25to75mm, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#histogram of average shell height by reef and year
Den_AllDates_AvgbyReefandYr_25to75 <- ggplot(den_avg_seed_reef, aes(MeanReefDen)) +
  theme_bw() +
  geom_histogram(color = "black") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme_bw() + theme(axis.line = element_line()) #+
  #guides(color = FALSE) +
  #scale_x_continuous(limits = c(0, 150)) #+
  #scale_y_continuous(limits = c(0, 80))
  #coord_cartesian(ylim = c(-15, 40)))
Den_AllDates_AvgbyReefandYr_25to75

ggsave(here::here(paste0("OA_plots/Den_AllDates_AvgbyReefandYr_25to75_", Sys.Date(), ".jpeg")),
       Den_AllDates_AvgbyReefandYr_25to75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Only >75mm shell height

```{r AvgDenbyReefandYR-hist-o75mm, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#histogram of average shell height by reef and year
Den_AllDates_AvgbyReefandYr_o75 <- ggplot(den_avg_market_reef, aes(MeanReefDen)) +
  theme_bw() +
  geom_histogram(color = "black") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme_bw() + theme(axis.line = element_line()) #+
  #guides(color = FALSE) +
  #scale_x_continuous(limits = c(0, 150)) #+
  #scale_y_continuous(limits = c(0, 80))
  #coord_cartesian(ylim = c(-15, 40)))
Den_AllDates_AvgbyReefandYr_o75

ggsave(here::here(paste0("OA_plots/Den_AllDates_AvgbyReefandYr_o75_", Sys.Date(), ".jpeg")),
       Den_AllDates_AvgbyReefandYr_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

#### Normal QQ plots {.tabset .tabset-fade .tabset-pills}

##### Raw density values

```{r AvgDenbyReefandYR-qqplot-raw, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#QQ plot of average shell height by reef and year
Den_AllDates_QQbyReefandYr_raw <- ggplot(den_avg_reef, aes(sample = MeanReefDen)) +
  theme_bw() +
  geom_qq(shape = 1) +
  geom_qq_line(color = "red") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme_bw() + theme(axis.line = element_line()) #+
  #guides(color = FALSE) +
  #scale_x_continuous(limits = c(0, 150)) #+
  #scale_y_continuous(limits = c(0, 80))
  #coord_cartesian(ylim = c(-15, 40)))
Den_AllDates_QQbyReefandYr_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_QQbyReefandYr_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_QQbyReefandYr_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Only 25-75mm shell height

```{r AvgDenbyReefandYR-qqplot-25to75mm, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#QQ plot of average shell height by reef and year
Den_AllDates_QQbyReefandYr_25to75 <- ggplot(den_avg_seed_reef, aes(sample = MeanReefDen)) +
  theme_bw() +
  geom_qq(shape = 1) +
  geom_qq_line(color = "red") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme_bw() + theme(axis.line = element_line()) #+
  #guides(color = FALSE) +
  #scale_x_continuous(limits = c(0, 150)) #+
  #scale_y_continuous(limits = c(0, 80))
  #coord_cartesian(ylim = c(-15, 40)))
Den_AllDates_QQbyReefandYr_25to75

ggsave(here::here(paste0("OA_plots/Den_AllDates_QQbyReefandYr_25to75_", Sys.Date(), ".jpeg")),
       Den_AllDates_QQbyReefandYr_25to75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Only >75mm shell height

```{r AvgDenbyReefandYR-qqplot-o75mm, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#QQ plot of average shell height by reef and year
Den_AllDates_QQbyReefandYr_o75 <- ggplot(den_avg_market_reef, aes(sample = MeanReefDen)) +
  theme_bw() +
  geom_qq(shape = 1) +
  geom_qq_line(color = "red") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme_bw() + theme(axis.line = element_line()) #+
  #guides(color = FALSE) +
  #scale_x_continuous(limits = c(0, 150)) #+
  #scale_y_continuous(limits = c(0, 80))
  #coord_cartesian(ylim = c(-15, 40)))
Den_AllDates_QQbyReefandYr_o75

ggsave(here::here(paste0("OA_plots/Den_AllDates_QQbyReefandYr_o75_", Sys.Date(), ".jpeg")),
       Den_AllDates_QQbyReefandYr_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

### Model summary tables {.tabset .tabset-fade}

#### Quantile regression {.tabset .tabset-fade .tabset-pills}

##### Raw density values

```{r AvgDenbyReefandYR-QuantReg-raw, echo=TRUE, message=FALSE, warning=FALSE}
#Run nonparametric regression (quantile regression) on average density reef-level data by year, if there are >4 years of data
#Followed quantile regression example here: https://rcompanion.org/handbook/F_12.html; accessed 10/14/2020
qreg_results_den <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), pvalue = numeric(), pseudoR2 = numeric())
for(i in unique(den_avg_reef$MA_plotlab)){
  qrdat <- den_avg_reef[MA_plotlab == i, ]
  if(length(unique(qrdat$Year)) < 5) next
  quantregs <- rq(MeanReefDen ~ Year, data = qrdat, tau = 0.5)
  nullmod <- rq(MeanReefDen ~ 1, data = qrdat, tau = 0.5)
  anov <- anova(quantregs, nullmod)
  PseudR <- nagelkerke(quantregs)
  iresult <- data.table(MA_plotlab = i, intercept = quantregs$coefficients[[1]], slope = quantregs$coefficients[[2]], pvalue = anov$table[[4]], pseudoR2 = PseudR$Pseudo.R.squared.for.model.vs.null[[3]])
  qreg_results_den <- rbind(qreg_results_den, iresult)
}

setorder(qreg_results_den, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
qreg_results_den_renamed <- setnames(qreg_results_den, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(qreg_results_den,'Managed Area_Habitat Class.', 'MA_plotlab')

qreg_results_den_renamed %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)
```

<br><br><br>

##### Only 25-75mm shell height

```{r AvgDenbyReefandYR-QuantReg-25to75mm, echo=TRUE, message=FALSE, warning=FALSE}
#Run nonparametric regression (quantile regression) on average density reef-level data by year, if there are >4 years of data
#Followed quantile regression example here: https://rcompanion.org/handbook/F_12.html; accessed 10/14/2020
qreg_results_den_seed <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), pvalue = numeric(), pseudoR2 = numeric())
for(i in unique(den_avg_seed_reef$MA_plotlab)){
  qrdat <- den_avg_seed_reef[MA_plotlab == i, ]
  if(length(unique(qrdat$LiveDate2)) < 5) next
  quantregs <- rq(MeanReefDen ~ LiveDate2, data = qrdat, tau = 0.5)
  nullmod <- rq(MeanReefDen ~ 1, data = qrdat, tau = 0.5)
  anov <- anova(quantregs, nullmod)
  PseudR <- nagelkerke(quantregs)
  iresult <- data.table(MA_plotlab = i, intercept = quantregs$coefficients[[1]], slope = quantregs$coefficients[[2]], pvalue = anov$table[[4]], pseudoR2 = PseudR$Pseudo.R.squared.for.model.vs.null[[3]])
  qreg_results_den_seed <- rbind(qreg_results_den_seed, iresult)
}

setorder(qreg_results_den_seed, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
qreg_results_den_seed_renamed <- setnames(qreg_results_den_seed, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(qreg_results_den_seed,'Managed Area_Habitat Class.', 'MA_plotlab')

qreg_results_den_seed_renamed %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)
```

<br><br><br>

##### Only >75mm shell height

```{r AvgDenbyReefandYR-QuantReg_o75mm, echo=TRUE, message=FALSE, warning=FALSE}
#Run nonparametric regression (quantile regression) on average density reef-level data by year, if there are >4 years of data
#Followed quantile regression example here: https://rcompanion.org/handbook/F_12.html; accessed 10/14/2020
qreg_results_den_market <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), pvalue = numeric(), pseudoR2 = numeric())
for(i in unique(den_avg_market_reef$MA_plotlab)){
  qrdat <- den_avg_market_reef[MA_plotlab == i, ]
  if(length(unique(qrdat$LiveDate2)) < 5) next
  quantregs <- rq(MeanReefDen ~ LiveDate2, data = qrdat, tau = 0.5)
  nullmod <- rq(MeanReefDen ~ 1, data = qrdat, tau = 0.5)
  anov <- anova(quantregs, nullmod)
  PseudR <- nagelkerke(quantregs)
  iresult <- data.table(MA_plotlab = i, intercept = quantregs$coefficients[[1]], slope = quantregs$coefficients[[2]], pvalue = anov$table[[4]], pseudoR2 = PseudR$Pseudo.R.squared.for.model.vs.null[[3]])
  qreg_results_den_market <- rbind(qreg_results_den_market, iresult)
}

setorder(qreg_results_den_market, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
qreg_results_den_market_renamed <- setnames(qreg_results_den_market, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(qreg_results_den_market,'Managed Area_Habitat Class.', 'MA_plotlab')

qreg_results_den_market_renamed %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)
```

<br><br><br>

#### Linear regression

```{r}
#Linear regression version
lm_results_den <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), Fstatistic = numeric(), numdf = numeric(), dendf = numeric(), pvalue = numeric(), adjustedR2 = numeric())
for(i in unique(den_avg_reef$MA_plotlab)){
  lmdat <- den_avg_reef[MA_plotlab == i, ]
  if(length(unique(lmdat$Year)) < 5) next
  lms <- lm(MeanReefDen ~ Year, data = lmdat)
  iresult <- data.table(MA_plotlab = i, intercept = lms$coefficients[[1]], slope = lms$coefficients[[2]], Fstatistic = summary(lms)$fstatistic[[1]], numdf = summary(lms)$fstatistic[[2]], dendf = summary(lms)$fstatistic[[3]], pvalue = anova(lms)$Pr[1], adjustedR2 = summary(lms)$adj.r.squared)
  lm_results_den <- rbind(lm_results_den, iresult)
}

setorder(lm_results_den, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
lm_results_den_renamed <- setnames(lm_results_den, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(lm_results_den, 'Managed Area_Habitat Class.', 'MA_plotlab')

lm_results_den_renamed %>% 
  kbl(align = "lccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)

```

<br><br><br>


### Linear regression diagnostic plots {.tabset .tabset-fade}

#### Apalachicola Bay_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 1)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 3)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Apalachicola Bay_Natural", ]), which = 4)

```

<br><br><br>

#### Apalachicola NERR_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 1)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 3)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Apalachicola NERR_Natural", ]), which = 4)

```

<br><br><br>

#### Estero Bay_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Estero Bay_Natural", ]), which = 1)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Estero Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Estero Bay_Natural", ]), which = 3)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Estero Bay_Natural", ]), which = 4)

```

<br><br><br>

#### Guana River Marsh_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 1)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 3)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Guana River Marsh_Natural", ]), which = 4)

```

<br><br><br>

#### Guana Tolomato Matanzas NERR_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 1)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 3)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 4)

```

<br><br><br>

#### Lemon Bay_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Lemon Bay_Natural", ]), which = 1)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Lemon Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Lemon Bay_Natural", ]), which = 3)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Lemon Bay_Natural", ]), which = 4)

```

<br><br><br>

#### Pine Island Sound_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Pine Island Sound_Natural", ]), which = 1)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Pine Island Sound_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Pine Island Sound_Natural", ]), which = 3)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Pine Island Sound_Natural", ]), which = 4)

```

<br><br><br>

#### Pine Island Sound_Restored

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Pine Island Sound_Restored", ]), which = 1)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Pine Island Sound_Restored", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Pine Island Sound_Restored", ]), which = 3)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef[MA_plotlab == "Pine Island Sound_Restored", ]), which = 4)

```

<br><br><br>

### Regression plots {.tabset .tabset-fade}

#### Quantile regression {.tabset .tabset-fade .tabset-pills}

##### Raw density values

```{r AvgDenbyReefandYR-QuantRegPlot, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}

#Plot reef-level average density, including quantile regression lines, as applicable, and full range of years.
Den_AllDates_QuantReg_raw <- ggplot(den_avg_reef, aes(Year, MeanReefDen, fill = reefIDcrosswalk)) +
  theme_bw() +
  geom_point(shape = 21) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = qreg_results_den, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 90), axis.line = element_line())
Den_AllDates_QuantReg_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_QuantReg_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_QuantReg_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Only 25-75mm shell height {.tabset .tabset-fade .tabset-pills}

```{r AvgDenbyReefandYR-QuantRegPlot-25to75mm-1950to2020, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}

#Plot reef-level average density (25-75mm SH only), including quantile regression lines, as applicable, and 1950-2020.
Den_AllDates_QuantReg1950to2020_25to75 <- ggplot(den_avg_seed_reef, aes(LiveDate2, MeanReefDen, fill = reefIDcrosswalk)) +
  theme_bw() +
  geom_point(shape = 21) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = qreg_results_den_seed, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 90), axis.line = element_line()) +
  xlim(2005, 2020)
Den_AllDates_QuantReg1950to2020_25to75

ggsave(here::here(paste0("OA_plots/Den_AllDates_QuantReg1950to2020_25to75_", Sys.Date(), ".jpeg")),
       Den_AllDates_QuantReg1950to2020_25to75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Only >75mm shell height {.tabset .tabset-fade .tabset-pills}

```{r AvgDenbyReefandYR-QuantRegPlot-o75mm-1950to2020, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}

#Plot reef-level average density (>75mm SH only), including quantile regression lines, as applicable, and 1950-2020.
Den_AllDates_QuantReg1950to2020_o75 <- ggplot(den_avg_market_reef, aes(LiveDate2, MeanReefDen, fill = reefIDcrosswalk)) +
  theme_bw() +
  geom_point(shape = 21) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = qreg_results_den_market, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 90), axis.line = element_line()) +
  xlim(2005, 2020)
Den_AllDates_QuantReg1950to2020_o75

ggsave(here::here(paste0("OA_plots/Den_AllDates_QuantReg1950to2020_o75_", Sys.Date(), ".jpeg")),
       Den_AllDates_QuantReg1950to2020_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

#### Linear regression

```{r AvgDenbyReefandYR-LinRegPlot, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
Den_AllDates_LinReg_raw <- ggplot(den_avg_reef, aes(Year, MeanReefDen, fill = reefIDcrosswalk)) +
  theme_bw() +
  geom_point(shape = 21) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = lm_results_den, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 90), axis.line = element_line())
Den_AllDates_LinReg_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_LinReg_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_LinReg_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

### Generalized Linear Mixed Effects Models {.tabset .tabset-fade}

#### Raw density values {.tabset .tabset-fade .tabset-pills}

##### Apalachicola Bay_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

ab_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Apalachicola Bay_Natural")
ab_n[, QuadSize_m2 := as.factor(QuadSize_m2)]
ab_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
ab_n[, Year := as.integer(Year)]
ab_n[, RelYear := Year - min(Year)]
ab_n[, Number_of_Oysters_Counted_Live_Count := Density_m2*as.numeric(QuadSize_m2)]
ab_n[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
ab_n[, Density_m2 := as.integer(Density_m2)]
saveRDS(ab_n, here::here(paste0('GLMMs/AllDates/Data/ab_n_', Sys.Date(), '.rds')))

ab_den_glmm <- brm(formula = Number_of_Oysters_Counted_Live_Count ~ RelYear + offset(log(QuadSize_m2)) + Subtidal + (1 + RelYear|reefIDcrosswalk), data = ab_n, family = zero_inflated_negbinomial(link = "log", link_shape = "log", link_zi = "logit"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
ab_den_glmm <- add_criterion(ab_den_glmm, "loo")

ggplot(ab_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(ab_n, aes(x = RelYear, y = Subtidal, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ab_den_glmm1 <- brm(formula = Density_m2 ~ RelYear, data = ab_n, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_glmm1.rds")
ab_den_glmm1 <- add_criterion(ab_den_glmm1, "loo")

ab_den_glmm2 <- brm(formula = Density_m2 ~ RelYear, data = ab_n, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_glmm2.rds")
ab_den_glmm2 <- add_criterion(ab_den_glmm2, "loo")

ab_den_glmm3 <- brm(formula = Density_m2 ~ RelYear, data = ab_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_glmm3.rds")
ab_den_glmm3 <- add_criterion(ab_den_glmm3, "loo")

#Model converged, Subtidal was not significant.
ab_den_glmm3b <- brm(formula = Density_m2 ~ Subtidal, data = ab_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_glmm3b.rds")
ab_den_glmm3b <- add_criterion(ab_den_glmm3b, "loo")

ab_den_glmm4 <- brm(formula = Density_m2 ~ RelYear, data = ab_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_glmm4.rds")
ab_den_glmm4 <- add_criterion(ab_den_glmm4, "loo")

ab_den_glmm5 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = ab_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_glmm5.rds")
ab_den_glmm5 <- add_criterion(ab_den_glmm5, "loo")

ab_den_glmm6 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = ab_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_glmm6.rds")
ab_den_glmm6 <- add_criterion(ab_den_glmm6, "loo")

ab_den_glmm7 <- brm(formula = Density_m2 ~ RelYear + (1 | reefIDcrosswalk), data = ab_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_glmm7.rds")
ab_den_glmm7 <- add_criterion(ab_den_glmm7, "loo")

ab_den_glmm8 <- brm(formula = Density_m2 ~ RelYear + (1 | reefIDcrosswalk), data = ab_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_glmm8.rds")
ab_den_glmm8 <- add_criterion(ab_den_glmm8, "loo")

ab_den_glmm9 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = ab_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_glmm9.rds")
ab_den_glmm9 <- add_criterion(ab_den_glmm9, "loo")

ab_den_glmm10 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = ab_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_glmm10.rds")
ab_den_glmm10 <- add_criterion(ab_den_glmm10, "loo")

#GLMM9 is the best fit to the data
loo_compare(ab_den_glmm1, ab_den_glmm2, ab_den_glmm3, ab_den_glmm4, ab_den_glmm5, ab_den_glmm6, ab_den_glmm7, ab_den_glmm8, ab_den_glmm9, ab_den_glmm10)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
ab_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Apalachicola Bay_Natural")
ab_n[, QuadSize_m2 := as.factor(QuadSize_m2)]
ab_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
ab_n[, RelYear := Year - min(Year)]
ab_n[, Number_of_Oysters_Counted_Live_Count := Density_m2*as.numeric(QuadSize_m2)]
ab_n[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]

ab_den_glmm <- readRDS(here::here('GLMMs/AllDates/ab_den_glmm9.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

ab_n[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
ab_n[, SampleDay := day(SampleDate)]


den_t <- copy(ab_n[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(ab_n$Month))){
  mo <- subset(ab_n, as.numeric(ab_n$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(ab_n, ab_n$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                        SizeClass = "All", 
                        Year = as.numeric(Year), 
                        n_reefs = length(unique(ReefIdentifier)),
                        n_programs = length(unique(ProgramID)),
                        ProgIDs = list(unique(ProgramID)),
                        n_samples = length(Density_m2),
                        Median = median(Density_m2),
                        Mean = round(mean(Density_m2), digits = 2),
                        SD = round(sd(Density_m2), digits = 2), 
                        Min. = min(Density_m2),
                        Max. = max(Density_m2)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(ab_sho75, ab_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(ab_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(ab_n, aes(x = RelYear, y = Subtidal, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(ab_den_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_AB_PDistandMChains_raw <- plot(ab_den_glmm)
Den_AllDates_GLMM_AB_PDistandMChains_raw

len <- length(Den_AllDates_GLMM_AB_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_AB_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_AB_PPcheck_raw <- pp_check(ab_den_glmm)
Den_AllDates_GLMM_AB_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_AB_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
ab1 <- plot(conditional_effects(ab_den_glmm, re_formula = NULL), plot = FALSE)[[1]]
Den_AllDates_GLMM_AB_MEPrand_raw <- ab1 +
  geom_point(data = ab_n, aes(x = RelYear, y = Density_m2, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
  geom_text(data = ab_n, aes(y = -25, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID")
Den_AllDates_GLMM_AB_MEPrand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_MEPrand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_AB_MEPrand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
ab2 <- plot(conditional_effects(ab_den_glmm, re_formula = NA), plot = FALSE)[[1]]
Den_AllDates_GLMM_AB_MEPnorand_raw <- ab2 +
  geom_point(data = ab_n, aes(x = RelYear, y = Density_m2, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
  geom_text(data = ab_n, aes(y = -25, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID")
Den_AllDates_GLMM_AB_MEPnorand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_MEPnorand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_AB_MEPnorand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=50, fig.width=10, out.width="100%"}
#Individual effects plots
Den_AllDates_GLMM_AB_IEP_raw <- ab_n %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(ab_den_glmm) %>%
  ggplot(aes(x = RelYear, y = Density_m2, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = ab_n) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = ab_n, aes(y = -125, label = Year, x = RelYear), size = 2, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(ab_n$RelYear) + 1)) +
  scale_y_continuous(limits = c(-125, 2500)) +
  labs(color = "Reef ID", fill = "Credible Interval") +
  #coord_cartesian(xlim = c(0, 7), ylim = c(-125, 2500)) +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
Den_AllDates_GLMM_AB_IEP_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_IEP_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_AB_IEP_raw,
       width = 10,
       height = 49,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(ab_n, ab_den_glmm, 
   Den_AllDates_GLMM_AB_PDistandMChains_raw,
   Den_AllDates_GLMM_AB_PPcheck_raw,
   Den_AllDates_GLMM_AB_MEPrand_raw,
   Den_AllDates_GLMM_AB_MEPnorand_raw,
   Den_AllDates_GLMM_AB_IEP_raw
   )

```

<br><br><br>

##### Apalachicola NERR_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

an_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Apalachicola NERR_Natural")
an_n[, QuadSize_m2 := as.factor(QuadSize_m2)]
an_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
an_n[, RelYear := Year - min(Year)]
an_n[, Number_of_Oysters_Counted_Live_Count := Density_m2*as.numeric(QuadSize_m2)]
an_n[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
an_n[, Density_m2 := as.integer(Density_m2)]
saveRDS(an_n, here::here(paste0('GLMMs/AllDates/Data/an_n_', Sys.Date(), '.rds')))

an_den_glmm <- brm(formula = Number_of_Oysters_Counted_Live_Count ~ RelYear + offset(log(QuadSize_m2)) + Subtidal + (1 + RelYear|reefIDcrosswalk), data = an_n, family = zero_inflated_negbinomial(link = "log", link_shape = "log", link_zi = "logit"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
an_den_glmm <- add_criterion(an_den_glmm, "loo")

ggplot(an_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(an_n, aes(x = RelYear, y = Subtidal, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

an_den_glmm1 <- brm(formula = Density_m2 ~ RelYear, data = an_n, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm1.rds")
an_den_glmm1 <- add_criterion(an_den_glmm1, "loo")

an_den_glmm2 <- brm(formula = Density_m2 ~ RelYear, data = an_n, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm2.rds")
an_den_glmm2 <- add_criterion(an_den_glmm2, "loo")

an_den_glmm3 <- brm(formula = Density_m2 ~ RelYear, data = an_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm3.rds")
an_den_glmm3 <- add_criterion(an_den_glmm3, "loo")

an_den_glmm4 <- brm(formula = Density_m2 ~ RelYear, data = an_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm4.rds")
an_den_glmm4 <- add_criterion(an_den_glmm4, "loo")

#Model converged, Subtidal was significant.
an_den_glmm4b <- brm(formula = Density_m2 ~ Subtidal, data = an_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm4b.rds")
an_den_glmm4b <- add_criterion(an_den_glmm4b, "loo")

an_den_glmm5 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = an_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm5.rds")
an_den_glmm5 <- add_criterion(an_den_glmm5, "loo")

an_den_glmm6 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = an_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm6.rds")
an_den_glmm6 <- add_criterion(an_den_glmm6, "loo")

an_den_glmm7 <- brm(formula = Density_m2 ~ RelYear + (1 | reefIDcrosswalk), data = an_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm7.rds")
an_den_glmm7 <- add_criterion(an_den_glmm7, "loo")

an_den_glmm8 <- brm(formula = Density_m2 ~ RelYear + (1 | reefIDcrosswalk), data = an_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm8.rds")
an_den_glmm8 <- add_criterion(an_den_glmm8, "loo")

an_den_glmm9 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = an_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm9.rds")
an_den_glmm9 <- add_criterion(an_den_glmm9, "loo")

an_den_glmm10 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = an_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm10.rds")
an_den_glmm10 <- add_criterion(an_den_glmm10, "loo")

an_den_glmm11 <- brm(formula = Density_m2 ~ RelYear + Subtidal + (0 + RelYear | reefIDcrosswalk), data = an_n, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm11.rds")
an_den_glmm11 <- add_criterion(an_den_glmm11, "loo")

an_den_glmm12 <- brm(formula = Density_m2 ~ RelYear + Subtidal + (0 + RelYear | reefIDcrosswalk), data = an_n, family = negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm12.rds")
an_den_glmm12 <- add_criterion(an_den_glmm12, "loo")

an_den_glmm13 <- brm(formula = Density_m2 ~ RelYear + Subtidal + (1 | reefIDcrosswalk), data = an_n, family = negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm13.rds")
an_den_glmm13 <- add_criterion(an_den_glmm13, "loo")

an_den_glmm14 <- brm(formula = Density_m2 ~ RelYear + Subtidal + (1 | reefIDcrosswalk), data = an_n, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_glmm14.rds")
an_den_glmm14 <- add_criterion(an_den_glmm14, "loo")

#GLMM10 is the best fit to the data
loo_compare(an_den_glmm1, an_den_glmm2, an_den_glmm3, an_den_glmm4, an_den_glmm5, an_den_glmm6, an_den_glmm7, an_den_glmm8, an_den_glmm9, an_den_glmm10)

#Testing previously best model against models including Subtidal. GLMM 10 was still the best model of the group, but GLMM 11 was close and best model that included Subtidal variable so I chose that one.
loo_compare(an_den_glmm10, an_den_glmm11, an_den_glmm12, an_den_glmm13, an_den_glmm14)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
an_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Apalachicola NERR_Natural")
an_n[, QuadSize_m2 := as.factor(QuadSize_m2)]
an_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
an_n[, RelYear := Year - min(Year)]
an_n[, Number_of_Oysters_Counted_Live_Count := Density_m2*as.numeric(QuadSize_m2)]
an_n[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
an_n[, Density_m2 := as.integer(Density_m2)]

an_den_glmm <- readRDS(here::here('GLMMs/AllDates/an_den_glmm11.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

an_n[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
an_n[, SampleDay := day(SampleDate)]


den_t <- copy(an_n[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(an_n$Month))){
  mo <- subset(an_n, as.numeric(an_n$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(an_n, an_n$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = "All", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(Density_m2),
                       Median = median(Density_m2),
                       Mean = round(mean(Density_m2), digits = 2),
                       SD = round(sd(Density_m2), digits = 2), 
                       Min. = min(Density_m2),
                       Max. = max(Density_m2)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(an_sho75, an_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(an_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(an_n, aes(x = RelYear, y = Subtidal, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(an_den_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_AN_PDistandMChains_raw <- plot(an_den_glmm)
Den_AllDates_GLMM_AN_PDistandMChains_raw

len <- length(Den_AllDates_GLMM_AN_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_AN_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_AN_PPcheck_raw <- pp_check(an_den_glmm)
Den_AllDates_GLMM_AN_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_AN_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
#Marginal effects plot including random effects
set.seed(987)
an1 <- plot(conditional_effects(an_den_glmm, re_formula = NULL), plot = FALSE)[[1]]
Den_AllDates_GLMM_AN_MEPrand_raw <- an1 +
  geom_jitter(data = an_n, aes(x = RelYear, y = Density_m2, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = an_n, aes(y = -900, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13),
    legend.position = "none") +
  labs(fill = NULL)
Den_AllDates_GLMM_AN_MEPrand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_MEPrand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_AN_MEPrand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
an2 <- plot(conditional_effects(an_den_glmm, re_formula = NA), plot = FALSE)[[1]]
Den_AllDates_GLMM_AN_MEPnorand_raw <- an2 +
  geom_jitter(data = an_n, aes(x = RelYear, y = Density_m2, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = an_n, aes(y = -120, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13),
    legend.position = "none") +
  labs(fill = NULL)
Den_AllDates_GLMM_AN_MEPnorand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_MEPnorand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_AN_MEPnorand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"}
#Individual effects plots
labs1 <- sort(unique(an_n$Year))[c(TRUE, FALSE)]
labs2 <- sort(unique(an_n$Year))[c(FALSE, TRUE)]

Den_AllDates_GLMM_AN_IEP_raw <- an_n %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(an_den_glmm) %>%
  ggplot(aes(x = RelYear, y = Density_m2, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = an_n) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(an_n, an_n$Year %in% labs1), aes(y = -150, label = Year, x = RelYear), size = 2, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(an_n, an_n$Year %in% labs2), aes(y = -300, label = Year, x = RelYear), size = 2, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(an_n$RelYear) + 1)) +
  scale_y_continuous(limits = c(-300, 3000)) +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
Den_AllDates_GLMM_AN_IEP_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_IEP_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_AN_IEP_raw,
       width = 10,
       height = 80,
       units = "in",
       dpi = 300,
       limitsize = FALSE)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(an_n, an_den_glmm, 
   Den_AllDates_GLMM_AN_PDistandMChains_raw,
   Den_AllDates_GLMM_AN_PPcheck_raw,
   Den_AllDates_GLMM_AN_MEPrand_raw,
   Den_AllDates_GLMM_AN_MEPnorand_raw,
   Den_AllDates_GLMM_AN_IEP_raw
   )

```

<br><br><br>

##### Estero Bay_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}
eb_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Estero Bay_Natural")
eb_n[, QuadSize_m2 := as.numeric(QuadSize_m2)]
eb_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
eb_n[, RelYear := Year - min(Year)]
eb_n[, Number_of_Oysters_Counted_Live_Count := Density_m2*QuadSize_m2]
eb_n[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
eb_n[, Density_m2 := as.integer(Density_m2)]
saveRDS(eb_n, here::here(paste0('GLMMs/AllDates/Data/eb_n_', Sys.Date(), '.rds')))

eb_den_glmm <- brm(formula = Number_of_Oysters_Counted_Live_Count ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = eb_n, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
eb_den_glmm <- add_criterion(eb_den_glmm, "loo")

ggplot(eb_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

eb_den_glmm1 <- brm(formula = Density_m2 ~ RelYear, data = eb_n, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm1.rds")
eb_den_glmm1 <- add_criterion(eb_den_glmm1, "loo")

eb_den_glmm2 <- brm(formula = Density_m2 ~ QuadSize_m2, data = eb_n, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm2.rds")
eb_den_glmm2 <- add_criterion(eb_den_glmm2, "loo")

eb_den_glmm3 <- brm(formula = Density_m2 ~ RelYear, data = eb_n, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm3.rds")
eb_den_glmm3 <- add_criterion(eb_den_glmm3, "loo")

eb_den_glmm4 <- brm(formula = Density_m2 ~ QuadSize_m2, data = eb_n, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm4.rds")
eb_den_glmm4 <- add_criterion(eb_den_glmm4, "loo")

eb_den_glmm5 <- brm(formula = Density_m2 ~ RelYear, data = eb_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm5.rds")
eb_den_glmm5 <- add_criterion(eb_den_glmm5, "loo")

eb_den_glmm6 <- brm(formula = Density_m2 ~ RelYear, data = eb_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm6.rds")
eb_den_glmm6 <- add_criterion(eb_den_glmm6, "loo")

eb_den_glmm7 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = eb_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm7.rds")
eb_den_glmm7 <- add_criterion(eb_den_glmm7, "loo")

eb_den_glmm8 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = eb_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm8.rds")
eb_den_glmm8 <- add_criterion(eb_den_glmm8, "loo")

eb_den_glmm9 <- brm(formula = Density_m2 ~ RelYear + (1 | reefIDcrosswalk), data = eb_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm9.rds")
eb_den_glmm9 <- add_criterion(eb_den_glmm9, "loo")

eb_den_glmm10 <- brm(formula = Density_m2 ~ RelYear + (1 | reefIDcrosswalk), data = eb_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm10.rds")
eb_den_glmm10 <- add_criterion(eb_den_glmm10, "loo")

eb_den_glmm11 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = eb_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm11.rds")
eb_den_glmm11 <- add_criterion(eb_den_glmm11, "loo")

eb_den_glmm12 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = eb_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm12.rds")
eb_den_glmm12 <- add_criterion(eb_den_glmm12, "loo")

eb_den_glmm13 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (1 | reefIDcrosswalk), data = eb_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm13.rds")
eb_den_glmm13 <- add_criterion(eb_den_glmm13, "loo")

eb_den_glmm14 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (1 | reefIDcrosswalk), data = eb_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm14.rds")
eb_den_glmm14 <- add_criterion(eb_den_glmm14, "loo")

eb_den_glmm15 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (0 + RelYear | reefIDcrosswalk), data = eb_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm15.rds")
eb_den_glmm15 <- add_criterion(eb_den_glmm15, "loo")

eb_den_glmm16 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (0 + RelYear | reefIDcrosswalk), data = eb_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_glmm16.rds")
eb_den_glmm16 <- add_criterion(eb_den_glmm16, "loo")

#GLMM10 is the best fit to the data
loo_compare(eb_den_glmm1, eb_den_glmm2, eb_den_glmm3, eb_den_glmm4, eb_den_glmm5, eb_den_glmm6, eb_den_glmm7, eb_den_glmm8, eb_den_glmm9, eb_den_glmm10, eb_den_glmm11, eb_den_glmm12, eb_den_glmm13, eb_den_glmm14, eb_den_glmm15, eb_den_glmm16)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
eb_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Estero Bay_Natural")
eb_n[, QuadSize_m2 := as.factor(QuadSize_m2)]
eb_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
eb_n[, RelYear := Year - min(Year)]
eb_n[, Number_of_Oysters_Counted_Live_Count := Density_m2*as.numeric(QuadSize_m2)]
eb_n[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]

eb_den_glmm <- readRDS(here::here('GLMMs/AllDates/eb_den_glmm10.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

eb_n[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
eb_n[, SampleDay := day(SampleDate)]


den_t <- copy(eb_n[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(eb_n$Month))){
  mo <- subset(eb_n, as.numeric(eb_n$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(eb_n, eb_n$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = "All", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(Density_m2),
                       Median = median(Density_m2),
                       Mean = round(mean(Density_m2), digits = 2),
                       SD = round(sd(Density_m2), digits = 2), 
                       Min. = min(Density_m2),
                       Max. = max(Density_m2)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(eb_sho75, eb_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, message=FALSE, warning=FALSE, out.width="50%"}

ggplot(eb_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(eb_den_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_EB_PDistandMChains_raw <- plot(eb_den_glmm)
Den_AllDates_GLMM_EB_PDistandMChains_raw

len <- length(Den_AllDates_GLMM_EB_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_EB_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_EB_PPcheck_raw <- pp_check(eb_den_glmm)
Den_AllDates_GLMM_EB_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_EB_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
set.seed(987)
eb1 <- plot(conditional_effects(eb_den_glmm, re_formula = NULL), plot = FALSE)[[1]]
Den_AllDates_GLMM_EB_MEPrand_raw <- eb1 +
  geom_jitter(data = eb_n, aes(x = RelYear, y = Density_m2, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = eb_n, aes(y = -300, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13),
    legend.position = "none") +
  labs(colour = NULL)
Den_AllDates_GLMM_EB_MEPrand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_MEPrand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_EB_MEPrand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
set.seed(988)
eb2 <- plot(conditional_effects(eb_den_glmm, re_formula = NA), plot = FALSE)[[1]]
Den_AllDates_GLMM_EB_MEPnorand_raw <- eb2 +
  geom_jitter(data = eb_n, aes(x = RelYear, y = Density_m2, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = eb_n, aes(y = -300, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13),
    legend.position = "none") +
  labs(colour = NULL)
Den_AllDates_GLMM_EB_MEPnorand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_MEPnorand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_EB_MEPnorand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=30, fig.width=10, out.width="100%"}
#Individual effects plots
Den_AllDates_GLMM_EB_IEP_raw <- eb_n %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(eb_den_glmm) %>%
  ggplot(aes(x = RelYear, y = Density_m2, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = eb_n) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = eb_n, aes(y = -300, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(eb_n$RelYear) + 1)) +
  scale_y_continuous(limits = c(-300, 5500)) +
  labs(color = "Reef ID", fill = "Credible Interval") +
  #coord_cartesian(ylim = c(-510, 5500)) +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
Den_AllDates_GLMM_EB_IEP_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_IEP_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_EB_IEP_raw,
       width = 10,
       height = 30,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(eb_n, eb_den_glmm, 
   Den_AllDates_GLMM_EB_PDistandMChains_raw,
   Den_AllDates_GLMM_EB_PPcheck_raw,
   Den_AllDates_GLMM_EB_MEPrand_raw,
   Den_AllDates_GLMM_EB_MEPnorand_raw,
   Den_AllDates_GLMM_EB_IEP_raw
   )

```

<br><br><br>

##### Guana River Marsh_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

grm_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Guana River Marsh_Natural")
grm_n[, QuadSize_m2 := as.numeric(QuadSize_m2)]
grm_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
grm_n[, RelYear := Year - min(Year)]
grm_n[, Number_of_Oysters_Counted_Live_Count := Density_m2*QuadSize_m2]
grm_n[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
grm_n[, Density_m2 := as.integer(Density_m2)]
saveRDS(grm_n, here::here(paste0('GLMMs/AllDates/Data/grm_n_', Sys.Date(), '.rds')))

grm_den_glmm <- brm(formula = Number_of_Oysters_Counted_Live_Count ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = grm_n, family = negbinomial(link = "log", link_shape = "log"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
grm_den_glmm <- add_criterion(grm_den_glmm, "loo")


ggplot(grm_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(grm_n, aes(x = as.factor(ProgramID), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() +
  theme(legend.position = "none")

grm_den_glmm1 <- brm(formula = Density_m2 ~ RelYear, data = grm_n, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_glmm1.rds")
grm_den_glmm1 <- add_criterion(grm_den_glmm1, "loo")

grm_den_glmm2 <- brm(formula = Density_m2 ~ RelYear, data = grm_n, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_glmm2.rds")
grm_den_glmm2 <- add_criterion(grm_den_glmm2, "loo")

grm_den_glmm3 <- brm(formula = Density_m2 ~ RelYear, data = grm_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_glmm3.rds")
grm_den_glmm3 <- add_criterion(grm_den_glmm3, "loo")

grm_den_glmm4 <- brm(formula = Density_m2 ~ RelYear, data = grm_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_glmm4.rds")
grm_den_glmm4 <- add_criterion(grm_den_glmm4, "loo")

grm_den_glmm5 <- brm(formula = Density_m2 ~ RelYear + (1 | reefIDcrosswalk), data = grm_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_glmm5.rds")
grm_den_glmm5 <- add_criterion(grm_den_glmm5, "loo")

grm_den_glmm6 <- brm(formula = Density_m2 ~ RelYear + (1 | reefIDcrosswalk), data = grm_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_glmm6.rds")
grm_den_glmm6 <- add_criterion(grm_den_glmm6, "loo")

grm_den_glmm7 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = grm_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_glmm7.rds")
grm_den_glmm7 <- add_criterion(grm_den_glmm7, "loo")

grm_den_glmm8 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = grm_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_glmm8.rds")
grm_den_glmm8 <- add_criterion(grm_den_glmm8, "loo")

#GLMM6 is the best fit to the data
loo_compare(grm_den_glmm1, grm_den_glmm2, grm_den_glmm3, grm_den_glmm4, grm_den_glmm5, grm_den_glmm6, grm_den_glmm7, grm_den_glmm8)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
grm_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Guana River Marsh_Natural")
grm_n[, QuadSize_m2 := as.factor(QuadSize_m2)]
grm_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
grm_n[, RelYear := Year - min(Year)]
grm_n[, Number_of_Oysters_Counted_Live_Count := Density_m2*as.numeric(QuadSize_m2)]
grm_n[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
grm_n[, Density_m2 := as.integer(Density_m2)]

grm_den_glmm <- readRDS(here::here('GLMMs/AllDates/grm_den_glmm6.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

grm_n[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
grm_n[, SampleDay := day(SampleDate)]


den_t <- copy(grm_n[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(grm_n$Month))){
  mo <- subset(grm_n, as.numeric(grm_n$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(grm_n, grm_n$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = "All", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(Density_m2),
                       Median = median(Density_m2),
                       Mean = round(mean(Density_m2), digits = 2),
                       SD = round(sd(Density_m2), digits = 2), 
                       Min. = min(Density_m2),
                       Max. = max(Density_m2)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(grm_sho75, grm_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(grm_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(grm_n, aes(x = as.factor(ProgramID), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(grm_den_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_GRM_PDistandMChains_raw <- plot(grm_den_glmm)
Den_AllDates_GLMM_GRM_PDistandMChains_raw

len <- length(Den_AllDates_GLMM_GRM_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_GRM_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_GRM_PPcheck_raw <- pp_check(grm_den_glmm)
Den_AllDates_GLMM_GRM_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GRM_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
grm1 <- plot(conditional_effects(grm_den_glmm, re_formula = NULL), plot = FALSE)[[1]]
Den_AllDates_GLMM_GRM_MEPrand_raw <- grm1 +
  geom_jitter(data = grm_n, aes(x = RelYear, y = Density_m2, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = grm_n, aes(y = -300, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13),
    legend.position = "none") +
  labs(colour = NULL)
Den_AllDates_GLMM_GRM_MEPrand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_MEPrand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GRM_MEPrand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
grm2 <- plot(conditional_effects(grm_den_glmm, re_formula = NA), plot = FALSE)[[1]]
Den_AllDates_GLMM_GRM_MEPnorand_raw <- grm2 +
  geom_jitter(data = grm_n, aes(x = RelYear, y = Density_m2, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = grm_n, aes(y = -300, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13),
    legend.position = "none") +
  labs(colour = NULL)
Den_AllDates_GLMM_GRM_MEPnorand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_MEPnorand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GRM_MEPnorand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"}
#Individual effects plots
labs1 <- sort(unique(grm_n$Year))[c(TRUE, FALSE)]
labs2 <- sort(unique(grm_n$Year))[c(FALSE, TRUE)]

Den_AllDates_GLMM_GRM_IEP_raw <- grm_n %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(grm_den_glmm) %>%
  ggplot(aes(x = RelYear, y = Density_m2, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = grm_n) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(grm_n, grm_n$Year %in% labs1), aes(y = -800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(grm_n, grm_n$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(grm_n$RelYear) + 1)) +
  scale_y_continuous(limits = c(-2000, 7000)) +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
Den_AllDates_GLMM_GRM_IEP_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_IEP_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GRM_IEP_raw,
       width = 10,
       height = 30,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(grm_n, grm_den_glmm, 
   Den_AllDates_GLMM_GRM_PDistandMChains_raw,
   Den_AllDates_GLMM_GRM_PPcheck_raw,
   Den_AllDates_GLMM_GRM_MEPrand_raw,
   Den_AllDates_GLMM_GRM_MEPnorand_raw,
   Den_AllDates_GLMM_GRM_IEP_raw
   )

```

<br><br><br>

##### Guana Tolomato Matanzas NERR_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

gtmn_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Guana Tolomato Matanzas NERR_Natural")
gtmn_n[, QuadSize_m2 := as.factor(QuadSize_m2)]
gtmn_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
gtmn_n[, RelYear := Year - min(Year)]
gtmn_n[, Number_of_Oysters_Counted_Live_Count := Density_m2*as.integer(QuadSize_m2)]
gtmn_n[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
gtmn_n[, Density_m2 := as.integer(Density_m2)]
saveRDS(gtmn_n, here::here(paste0('GLMMs/AllDates/Data/gtmn_n_', Sys.Date(), '.rds')))

gtmn_den_glmm <- brm(formula = Number_of_Oysters_Counted_Live_Count ~ RelYear + offset(log(QuadSize_m2)) + Region.y + (1 + RelYear|reefIDcrosswalk), data = gtmn_n, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
gtmn_den_glmm <- add_criterion(gtmn_den_glmm, "loo")


ggplot(gtmn_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(gtmn_n, aes(x = as.factor(ProgramID), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(gtmn_n, aes(x = RelYear, y = Region.y, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

gtmn_den_glmm1 <- brm(formula = Density_m2 ~ RelYear, data = gtmn_n, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm1.rds")
gtmn_den_glmm1 <- add_criterion(gtmn_den_glmm1, "loo")

gtmn_den_glmm2 <- brm(formula = Density_m2 ~ Region.y, data = gtmn_n, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm2.rds")
gtmn_den_glmm2 <- add_criterion(gtmn_den_glmm2, "loo")

gtmn_den_glmm3 <- brm(formula = Density_m2 ~ RelYear, data = gtmn_n, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm3.rds")
gtmn_den_glmm3 <- add_criterion(gtmn_den_glmm3, "loo")

gtmn_den_glmm4 <- brm(formula = Density_m2 ~ RelYear, data = gtmn_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm4.rds")
gtmn_den_glmm4 <- add_criterion(gtmn_den_glmm4, "loo")

gtmn_den_glmm5 <- brm(formula = Density_m2 ~ RelYear, data = gtmn_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm5.rds")
gtmn_den_glmm5 <- add_criterion(gtmn_den_glmm5, "loo")

gtmn_den_glmm6 <- brm(formula = Density_m2 ~ RelYear + Region.y, data = gtmn_n, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm6.rds")
gtmn_den_glmm6 <- add_criterion(gtmn_den_glmm6, "loo")

gtmn_den_glmm7 <- brm(formula = Density_m2 ~ RelYear + Region.y, data = gtmn_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm7.rds")
gtmn_den_glmm7 <- add_criterion(gtmn_den_glmm7, "loo")

gtmn_den_glmm8 <- brm(formula = Density_m2 ~ RelYear + Region.y, data = gtmn_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm8.rds")
gtmn_den_glmm8 <- add_criterion(gtmn_den_glmm8, "loo")

gtmn_den_glmm9 <- brm(formula = Density_m2 ~ RelYear + (1 | reefIDcrosswalk), data = gtmn_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm9.rds")
gtmn_den_glmm9 <- add_criterion(gtmn_den_glmm9, "loo")

gtmn_den_glmm10 <- brm(formula = Density_m2 ~ RelYear + (1 | reefIDcrosswalk), data = gtmn_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm10.rds")
gtmn_den_glmm10 <- add_criterion(gtmn_den_glmm10, "loo")

gtmn_den_glmm11 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = gtmn_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm11.rds")
gtmn_den_glmm11 <- add_criterion(gtmn_den_glmm11, "loo")

gtmn_den_glmm12 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = gtmn_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm12.rds")
gtmn_den_glmm12 <- add_criterion(gtmn_den_glmm12, "loo")

gtmn_den_glmm13 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (1 | reefIDcrosswalk), data = gtmn_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm13.rds")
gtmn_den_glmm13 <- add_criterion(gtmn_den_glmm13, "loo")

gtmn_den_glmm14 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (1 | reefIDcrosswalk), data = gtmn_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm14.rds")
gtmn_den_glmm14 <- add_criterion(gtmn_den_glmm14, "loo")

gtmn_den_glmm15 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (0 + RelYear | reefIDcrosswalk), data = gtmn_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm15.rds")
gtmn_den_glmm15 <- add_criterion(gtmn_den_glmm15, "loo")

gtmn_den_glmm16 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (0 + RelYear | reefIDcrosswalk), data = gtmn_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm16.rds")
gtmn_den_glmm16 <- add_criterion(gtmn_den_glmm16, "loo")

#Adding "Region.y" to GLMM 10
gtmn_den_glmm17 <- brm(formula = Density_m2 ~ RelYear + Region.y + (1 | reefIDcrosswalk), data = gtmn_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm17.rds")
gtmn_den_glmm17 <- add_criterion(gtmn_den_glmm17, "loo")

#Adding interaction to GLMM 17
gtmn_den_glmm18 <- brm(formula = Density_m2 ~ RelYear + Region.y + RelYear:Region.y + (1 | reefIDcrosswalk), data = gtmn_n, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_glmm18.rds")
gtmn_den_glmm18 <- add_criterion(gtmn_den_glmm18, "loo")

#GLMM17 is the best fit to the data (formerly GLMM10 was best, but I realized I never tried adding Region.y). GLMM 18 shows the trend over time for each region though, and the fit isn't much worse (18 is second best), so I think I will choose model 18 so we can plot the effects over time by region.
loo_compare(gtmn_den_glmm1, gtmn_den_glmm2, gtmn_den_glmm3, gtmn_den_glmm4, gtmn_den_glmm5, gtmn_den_glmm6, gtmn_den_glmm7, gtmn_den_glmm8, gtmn_den_glmm9, gtmn_den_glmm10, gtmn_den_glmm11, gtmn_den_glmm12, gtmn_den_glmm13, gtmn_den_glmm14, gtmn_den_glmm15, gtmn_den_glmm16, gtmn_den_glmm17, gtmn_den_glmm18)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
gtmn_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Guana Tolomato Matanzas NERR_Natural")
gtmn_n[, QuadSize_m2 := as.factor(QuadSize_m2)]
gtmn_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
gtmn_n[, RelYear := Year - min(Year)]
gtmn_n[, Number_of_Oysters_Counted_Live_Count := Density_m2*as.integer(QuadSize_m2)]
gtmn_n[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
gtmn_n[, Density_m2 := as.integer(Density_m2)]

gtmn_den_glmm <- readRDS(here::here('GLMMs/AllDates/gtmn_den_glmm18.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

gtmn_n[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
gtmn_n[, SampleDay := day(SampleDate)]


den_t <- copy(gtmn_n[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(gtmn_n$Month))){
  mo <- subset(gtmn_n, as.numeric(gtmn_n$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(gtmn_n, gtmn_n$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = "All", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(Density_m2),
                       Median = median(Density_m2),
                       Mean = round(mean(Density_m2), digits = 2),
                       SD = round(sd(Density_m2), digits = 2), 
                       Min. = min(Density_m2),
                       Max. = max(Density_m2)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(gtmn_sho75, gtmn_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>


###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(gtmn_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(gtmn_n, aes(x = as.factor(ProgramID), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() +
  theme(legend.position = "none")

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(gtmn_n, aes(x = RelYear, y = Region.y, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(gtmn_den_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_GTMNERR_PDistandMChains_raw <- plot(gtmn_den_glmm)
Den_AllDates_GLMM_GTMNERR_PDistandMChains_raw

len <- length(Den_AllDates_GLMM_GTMNERR_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_GTMNERR_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_GTMNERR_PPcheck_raw <- pp_check(gtmn_den_glmm)
Den_AllDates_GLMM_GTMNERR_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
gtmn1 <- plot(conditional_effects(gtmn_den_glmm, re_formula = NULL), plot = FALSE)[[1]]
Den_AllDates_GLMM_GTMNERR_MEPrand_raw <- gtmn1 +
  geom_jitter(data = gtmn_n, aes(x = RelYear, y = Density_m2, fill = Region.y), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = gtmn_n, aes(y = -500, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Region") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_AllDates_GLMM_GTMNERR_MEPrand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_MEPrand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_MEPrand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
meanDen_raw <- plot(conditional_effects(gtmn_den_glmm, re_formula = NULL), plot = FALSE)[[2]]$data
setnames(meanDen_raw, "effect1__", "Region")

Den_AllDates_GLMM_GTMNERR_MEPrand_raw_MeanRes <- ggplot(meanDen_raw, aes(x = Region, y = estimate__, ymin = lower__, ymax = upper__)) +
  geom_pointinterval(fill = "black", size = 3, fatten_point = 4, shape = 21, color = "black") +
  ylab("Density_m2") +
  theme_bw()  + 
  theme(axis.title = element_text(size = 13), 
        axis.text = element_text(size = 12), 
        legend.text = element_text(size = 12), 
        legend.title = element_text(size = 13))+labs(fill = NULL)
Den_AllDates_GLMM_GTMNERR_MEPrand_raw_MeanRes

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_MEPrand_raw_MeanRes_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_MEPrand_raw_MeanRes,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br><br>

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
RelYrbyRegion <- plot(conditional_effects(gtmn_den_glmm, re_formula = NULL), plot = FALSE)[[3]]
#setnames(meanDen_raw, "effect1__", "Region")

Den_AllDates_GLMM_GTMNERR_MEPrand_raw_RelYrbyRegion <- RelYrbyRegion +
  geom_point(data = gtmn_n, aes(x = RelYear, y = Density_m2, fill = Region.y), alpha = 0.5, shape = 21, size = 3, color = "black", inherit.aes = FALSE) +
  geom_text(data = gtmn_n, aes(y = 0, label = "2020", x = 6), size = 4, col = "grey30", inherit.aes = FALSE) +
  scale_x_continuous(limits = c(0, max(gtmn_n$RelYear) + 1)) +
  #ylab("Density_m2") +
  theme_bw()  + 
  theme(axis.title = element_text(size = 13), 
        axis.text = element_text(size = 12), 
        legend.text = element_text(size = 12), 
        legend.title = element_text(size = 13), 
        legend.position = "none") +
  facet_wrap(~ Region.y, ncol = 3, scales = "free")
Den_AllDates_GLMM_GTMNERR_MEPrand_raw_RelYrbyRegion

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_MEPrand_raw_RelYrbyRegion_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_MEPrand_raw_RelYrbyRegion,
       width = 10,
       height = 10,
       units = "in",
       dpi = 300)

```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
gtmn2 <- plot(conditional_effects(gtmn_den_glmm, re_formula = NA), plot = FALSE)[[1]]
Den_AllDates_GLMM_GTMNERR_MEPnorand_raw <- gtmn2 +
  geom_jitter(data = gtmn_n, aes(x = RelYear, y = Density_m2, fill = Region.y), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = gtmn_n, aes(y = -500, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Region") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_AllDates_GLMM_GTMNERR_MEPnorand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_MEPnorand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_MEPnorand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"}
#Individual effects plots
labs1 <- sort(unique(gtmn_n$Year))[c(TRUE, FALSE)]
labs2 <- sort(unique(gtmn_n$Year))[c(FALSE, TRUE)]

Den_AllDates_GLMM_GTMNERR_IEP_raw <- gtmn_n %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(gtmn_den_glmm) %>%
  ggplot(aes(x = RelYear, y = Density_m2, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = gtmn_n) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(gtmn_n, gtmn_n$Year %in% labs1), aes(y = -800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(gtmn_n, gtmn_n$Year %in% labs2), aes(y = -1800, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(gtmn_n$RelYear) + 1)) +
  scale_y_continuous(limits = c(-2000, 12000)) +
  theme(legend.position = "none") +
  #labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
Den_AllDates_GLMM_GTMNERR_IEP_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_IEP_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_IEP_raw,
       width = 10,
       height = 80,
       units = "in",
       dpi = 300,
       limitsize = FALSE)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(gtmn_n, gtmn_den_glmm, 
   Den_AllDates_GLMM_GTMNERR_PDistandMChains_raw,
   Den_AllDates_GLMM_GTMNERR_PPcheck_raw,
   Den_AllDates_GLMM_GTMNERR_MEPrand_raw,
   Den_AllDates_GLMM_GTMNERR_MEPnorand_raw,
   Den_AllDates_GLMM_GTMNERR_IEP_raw
   )

```

<br><br><br>

##### Lemon Bay {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}


lb_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Lemon Bay_Natural")
lb_n[, QuadSize_m2 := as.factor(QuadSize_m2)]
#lb_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
lb_n[, RelYear := Year - min(Year)]
lb_n[, Density_m2 := as.integer(Density_m2)]
lb_n[, Season := ifelse(Month == 5 | Month == 6, "Spring", "Fall")]
saveRDS(lb_n, here::here(paste0('GLMMs/AllDates/Data/lb_n_', Sys.Date(), '.rds')))

lb_den_glmm <- brm(formula = Number_of_Oysters_Counted_Live_Count ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = lb_n, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "log"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
lb_den_glmm <- add_criterion(lb_den_glmm, "loo")


ggplot(lb_n, aes(x = RelYear, y = QuadSize_m2, color = QuadIdentifier)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(lb_n, aes(x = as.factor(ProgramID), y = QuadSize_m2, color = RelYear)) +
  geom_jitter() +
  theme(legend.position = "none")

lb_den_glmm1 <- brm(formula = Density_m2 ~ RelYear, data = lb_n, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_den_glmm1.rds")
lb_den_glmm1 <- add_criterion(lb_den_glmm1, "loo")

lb_den_glmm2 <- brm(formula = Density_m2 ~ RelYear, data = lb_n, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_den_glmm2.rds")
lb_den_glmm2 <- add_criterion(lb_den_glmm2, "loo")

lb_den_glmm3 <- brm(formula = Density_m2 ~ RelYear, data = lb_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_den_glmm3.rds")
lb_den_glmm3 <- add_criterion(lb_den_glmm3, "loo")

lb_den_glmm4 <- brm(formula = Density_m2 ~ RelYear, data = lb_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_den_glmm4.rds")
lb_den_glmm4 <- add_criterion(lb_den_glmm4, "loo")

lb_den_glmm5 <- brm(formula = Density_m2 ~ RelYear + (1 | ReefIdentifier), data = lb_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_den_glmm5.rds")
lb_den_glmm5 <- add_criterion(lb_den_glmm5, "loo")

lb_den_glmm6 <- brm(formula = Density_m2 ~ RelYear + (1 | ReefIdentifier), data = lb_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_den_glmm6.rds")
lb_den_glmm6 <- add_criterion(lb_den_glmm6, "loo")

lb_den_glmm7 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | ReefIdentifier), data = lb_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_den_glmm7.rds")
lb_den_glmm7 <- add_criterion(lb_den_glmm7, "loo")

lb_den_glmm8 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | ReefIdentifier), data = lb_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_den_glmm8.rds")
lb_den_glmm8 <- add_criterion(lb_den_glmm8, "loo")

#Model converged, Season was not significant.
lb_den_glmm9 <- brm(formula = Density_m2 ~ Season, data = lb_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_den_glmm9.rds")
lb_den_glmm9 <- add_criterion(lb_den_glmm9, "loo")

#Model did not converge.
lb_den_glmm10 <- brm(formula = Density_m2 ~ RelYear + ReefIdentifier + RelYear:ReefIdentifier + (1 | Season), data = lb_n, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(3), file = "GLMMs/AllDates/lb_den_glmm10.rds")
lb_den_glmm10 <- add_criterion(lb_den_glmm10, "loo")

#GLMM6 is the best fit to the data
loo_compare(lb_den_glmm1, lb_den_glmm2, lb_den_glmm3, lb_den_glmm4, lb_den_glmm5, lb_den_glmm6, lb_den_glmm7, lb_den_glmm8)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
lb_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Lemon Bay_Natural")
lb_n[, QuadSize_m2 := as.factor(QuadSize_m2)]
#lb_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
lb_n[, RelYear := Year - min(Year)]
lb_n[, Density_m2 := as.integer(Density_m2)]
lb_n[, Season := ifelse(Month == 5 | Month == 6, "Spring", "Fall")]

lb_den_glmm <- readRDS(here::here('GLMMs/AllDates/lb_den_glmm6.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

lb_n[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
lb_n[, SampleDay := day(SampleDate)]


den_t <- copy(lb_n[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(lb_n$Month))){
  mo <- subset(lb_n, as.numeric(lb_n$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(lb_n, lb_n$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = "All", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(Density_m2),
                       Median = median(Density_m2),
                       Mean = round(mean(Density_m2), digits = 2),
                       SD = round(sd(Density_m2), digits = 2), 
                       Min. = min(Density_m2),
                       Max. = max(Density_m2)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(lb_sho75, lb_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>


###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(lb_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = ReefIdentifier)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(lb_n, aes(x = as.factor(ProgramID), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() +
  theme(legend.position = "none")

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(lb_n, aes(x = Season, y = Density_m2, color = ReefIdentifier)) +
  geom_jitter() #+
  #theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(lb_den_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_LB_PDistandMChains_raw <- plot(lb_den_glmm)
Den_AllDates_GLMM_LB_PDistandMChains_raw

len <- length(Den_AllDates_GLMM_LB_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_LB_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_LB_PPcheck_raw <- pp_check(lb_den_glmm)
Den_AllDates_GLMM_LB_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_LB_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
lb1 <- plot(conditional_effects(lb_den_glmm, re_formula = NULL), plot = FALSE)[[1]]
Den_AllDates_GLMM_LB_MEPrand_raw <- lb1 +
  geom_jitter(data = lb_n, aes(x = RelYear, y = Density_m2, fill = ReefIdentifier), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = lb_n, aes(y = -100, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_AllDates_GLMM_LB_MEPrand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_MEPrand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_LB_MEPrand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
lb2 <- plot(conditional_effects(lb_den_glmm, re_formula = NA), plot = FALSE)[[1]]
Den_AllDates_GLMM_LB_MEPnorand_raw <- lb2 +
  geom_jitter(data = lb_n, aes(x = RelYear, y = Density_m2, fill = ReefIdentifier), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = lb_n, aes(y = -100, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_AllDates_GLMM_LB_MEPnorand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_MEPnorand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_LB_MEPnorand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Individual effects plots
#labs1 <- sort(unique(lb_n$Year))[c(TRUE, FALSE)]
labs2 <- sort(unique(lb_n$Year))[c(FALSE, TRUE, FALSE)]

Den_AllDates_GLMM_LB_IEP_raw <- lb_n %>%
  group_by(ReefIdentifier) %>%
  add_fitted_draws(lb_den_glmm) %>%
  ggplot(aes(x = RelYear, y = Density_m2, color = ReefIdentifier)) +
  geom_hline(yintercept = 0, color = "black", lwd = 0.1) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = lb_n) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2") +
  #geom_text(data = subset(lb_n, lb_n$Year %in% labs1), aes(y = -110, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(lb_n, lb_n$Year %in% labs2), aes(y = -275, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(lb_n$RelYear) + 1)) +
  scale_y_continuous(limits = c(-300, 4000)) +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ ReefIdentifier, ncol = 3, scales = "free")
Den_AllDates_GLMM_LB_IEP_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_IEP_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_LB_IEP_raw,
       width = 10,
       height = 5,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(lb_n, lb_den_glmm, 
   Den_AllDates_GLMM_LB_PDistandMChains_raw,
   Den_AllDates_GLMM_LB_PPcheck_raw,
   Den_AllDates_GLMM_LB_MEPrand_raw,
   Den_AllDates_GLMM_LB_MEPnorand_raw,
   Den_AllDates_GLMM_LB_IEP_raw
   )

```

<br><br><br>

##### Pine Island Sound (Natural) {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

pis_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Pine Island Sound_Natural")
pis_n[, QuadSize_m2 := as.numeric(QuadSize_m2)]
pis_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
pis_n[, RelYear := Year - min(Year)]
pis_n[, Number_of_Oysters_Counted_Live_Count := Density_m2*QuadSize_m2]
pis_n[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
pis_n[, QuadSize_m2 := as.factor(QuadSize_m2)]
pis_n[, Density_m2 := as.integer(Density_m2)]
pis_n[, Treatment := ifelse(reefIDcrosswalk == 170711, "Reference", "Control")]
saveRDS(pis_n, here::here(paste0('GLMMs/AllDates/Data/pis_n_', Sys.Date(), '.rds')))

pis_den_glmm <- brm(formula = Number_of_Oysters_Counted_Live_Count ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = pis_n, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
pis_den_glmm <- add_criterion(pis_den_glmm, "loo")


ggplot(pis_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(pis_n, aes(x = as.factor(ProgramID), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() +
  theme(legend.position = "none")

pis_den_glmm1 <- brm(formula = Density_m2 ~ RelYear, data = pis_n, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm1.rds")
pis_den_glmm1 <- add_criterion(pis_den_glmm1, "loo")

pis_den_glmm2 <- brm(formula = Density_m2 ~ as.factor(QuadSize_m2), data = pis_n, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm2.rds")
pis_den_glmm2 <- add_criterion(pis_den_glmm2, "loo")

pis_den_glmm3 <- brm(formula = Density_m2 ~ RelYear, data = pis_n, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm3.rds")
pis_den_glmm3 <- add_criterion(pis_den_glmm3, "loo")

pis_den_glmm4 <- brm(formula = Density_m2 ~ RelYear, data = pis_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm4.rds")
pis_den_glmm4 <- add_criterion(pis_den_glmm4, "loo")

pis_den_glmm5 <- brm(formula = Density_m2 ~ RelYear, data = pis_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm5.rds")
pis_den_glmm5 <- add_criterion(pis_den_glmm5, "loo")

pis_den_glmm6 <- brm(formula = Density_m2 ~ RelYear + (1 | reefIDcrosswalk), data = pis_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm6.rds")
pis_den_glmm6 <- add_criterion(pis_den_glmm6, "loo")

pis_den_glmm7 <- brm(formula = Density_m2 ~ RelYear + (1 | reefIDcrosswalk), data = pis_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm7.rds")
pis_den_glmm7 <- add_criterion(pis_den_glmm7, "loo")

pis_den_glmm8 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = pis_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm8.rds")
pis_den_glmm8 <- add_criterion(pis_den_glmm8, "loo")

pis_den_glmm9 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = pis_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm9.rds")
pis_den_glmm9 <- add_criterion(pis_den_glmm9, "loo")

pis_den_glmm10 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (1 | reefIDcrosswalk), data = pis_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm10.rds")
pis_den_glmm10 <- add_criterion(pis_den_glmm10, "loo")

pis_den_glmm11 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (1 | reefIDcrosswalk), data = pis_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm11.rds")
pis_den_glmm11 <- add_criterion(pis_den_glmm11, "loo")

pis_den_glmm12 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (0 + RelYear | reefIDcrosswalk), data = pis_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm12.rds")
pis_den_glmm12 <- add_criterion(pis_den_glmm12, "loo")

pis_den_glmm13 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (0 + RelYear | reefIDcrosswalk), data = pis_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm13.rds")
pis_den_glmm13 <- add_criterion(pis_den_glmm13, "loo")

pis_den_glmm14 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (0 + RelYear | reefIDcrosswalk), data = pis_n, family = hurdle_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm14.rds")
pis_den_glmm14 <- add_criterion(pis_den_glmm14, "loo")

#Tried fitting a model with "Treatment" as a fixed effect instead of "reefIDcrosswalk" as a grouping variable. Model did not converge.
pis_den_glmm15 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + Treatment, data = pis_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pis_den_glmm15.rds")
pis_den_glmm15 <- add_criterion(pis_den_glmm15, "loo")

#GLMM13 is the best fit to the data, but the fit with the data looked really weird; for some reason the addition of QuadSize_m2 to the model (diff between GLMM13 and GLMM9) caused the trendline to become steeply positive and it looked like it bore no resemblance to the data in the marginal effects plots. Elpd_diff between them was only -10.9, so I went with the GLMM9 without the QuadSize_m2 variable. QuadSize_m2 is already a component of the calculated density values anyway, so I'm not sure it is necessary in the model.
loo_compare(pis_den_glmm1, pis_den_glmm2, pis_den_glmm3, pis_den_glmm4, pis_den_glmm5, pis_den_glmm6, pis_den_glmm7, pis_den_glmm8, pis_den_glmm9, pis_den_glmm10, pis_den_glmm11, pis_den_glmm12, pis_den_glmm13, pis_den_glmm14)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
pis_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Pine Island Sound_Natural")
pis_n[, QuadSize_m2 := as.numeric(QuadSize_m2)]
pis_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
pis_n[, RelYear := Year - min(Year)]
pis_n[, Number_of_Oysters_Counted_Live_Count := Density_m2*QuadSize_m2]
pis_n[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
pis_n[, Density_m2 := as.integer(Density_m2)]

pis_den_glmm <- readRDS(here::here('GLMMs/AllDates/pis_den_glmm9.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

pis_n[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
pis_n[, SampleDay := day(SampleDate)]


den_t <- copy(pis_n[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(pis_n$Month))){
  mo <- subset(pis_n, as.numeric(pis_n$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(pis_n, pis_n$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = "All", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(Density_m2),
                       Median = median(Density_m2),
                       Mean = round(mean(Density_m2), digits = 2),
                       SD = round(sd(Density_m2), digits = 2), 
                       Min. = min(Density_m2),
                       Max. = max(Density_m2)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(pis_sho75, pis_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(pis_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(pis_n, aes(x = as.factor(ProgramID), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(pis_den_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_PIS_PDistandMChains_raw <- plot(pis_den_glmm)
Den_AllDates_GLMM_PIS_PDistandMChains_raw

len <- length(Den_AllDates_GLMM_PIS_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_PIS_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_PIS_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_PIS_PPcheck_raw <- pp_check(pis_den_glmm) +
                                        xlim(0, 5000)
Den_AllDates_GLMM_PIS_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_PIS_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_PIS_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
set.seed(987)
pis1 <- plot(conditional_effects(pis_den_glmm, re_formula = NULL), plot = FALSE)[[1]]
Den_AllDates_GLMM_PIS_MEPrand_raw <- pis1 +
  geom_jitter(data = pis_n, aes(x = RelYear, y = Density_m2, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = pis_n, aes(y = -250, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  #ylim(0, 3000) +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_AllDates_GLMM_PIS_MEPrand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_PIS_MEPrand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_PIS_MEPrand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
set.seed(986)
pis2 <- plot(conditional_effects(pis_den_glmm, re_formula = NA), plot = FALSE)[[1]]
Den_AllDates_GLMM_PIS_MEPnorand_raw <- pis2 +
  geom_jitter(data = pis_n, aes(x = RelYear, y = Density_m2, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = pis_n, aes(y = -75, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(ylim = c(0, 3000)) +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_AllDates_GLMM_PIS_MEPnorand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_PIS_MEPnorand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_PIS_MEPnorand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Individual effects plots
#labs1 <- sort(unique(pis_n$Year))[c(TRUE, FALSE)]
#labs2 <- sort(unique(pis_n$Year))[c(FALSE, TRUE)]

Den_AllDates_GLMM_PIS_IEP_raw <- pis_n %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(pis_den_glmm) %>%
  ggplot(aes(x = RelYear, y = Density_m2, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = pis_n) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = pis_n, aes(y = -50, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(pis_n, pis_n$Year %in% labs1), aes(y = -50, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(pis_n, pis_n$Year %in% labs2), aes(y = -100, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(pis_n$RelYear) + 1)) +
  scale_y_continuous(limits = c(-50, 3000)) +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
Den_AllDates_GLMM_PIS_IEP_raw


ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_PIS_IEP_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_PIS_IEP_raw,
       width = 10,
       height = 5,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(pis_n, pis_den_glmm, 
   Den_AllDates_GLMM_PIS_PDistandMChains_raw,
   Den_AllDates_GLMM_PIS_PPcheck_raw,
   Den_AllDates_GLMM_PIS_MEPrand_raw,
   Den_AllDates_GLMM_PIS_MEPnorand_raw,
   Den_AllDates_GLMM_PIS_IEP_raw
   )

```

<br><br><br>

##### Pine Island Sound (Restored) {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

pisr_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Pine Island Sound_Restored")
pisr_n[, QuadSize_m2 := as.numeric(QuadSize_m2)]
pisr_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
pisr_n[, RelYear := Year - min(Year)]
pisr_n[, Number_of_Oysters_Counted_Live_Count := Density_m2*QuadSize_m2]
pisr_n[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
pisr_n[, Density_m2 := as.integer(Density_m2)]
saveRDS(pisr_n, here::here(paste0('GLMMs/AllDates/Data/pisr_n_', Sys.Date(), '.rds')))

pisr_den_glmm <- brm(formula = Number_of_Oysters_Counted_Live_Count ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = pisr_n, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
pisr_den_glmm <- add_criterion(pisr_den_glmm, "loo")

ggplot(pisr_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(pisr_n, aes(x = as.factor(reefIDcrosswalk), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() +
  theme(legend.position = "none")

pisr_den_glmm1 <- brm(formula = Density_m2 ~ RelYear, data = pisr_n, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pisr_den_glmm1.rds")
pisr_den_glmm1 <- add_criterion(pisr_den_glmm1, "loo")

pisr_den_glmm2 <- brm(formula = Density_m2 ~ as.factor(QuadSize_m2), data = pisr_n, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pisr_den_glmm2.rds")
pisr_den_glmm2 <- add_criterion(pisr_den_glmm2, "loo")

pisr_den_glmm3 <- brm(formula = Density_m2 ~ RelYear, data = pisr_n, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pisr_den_glmm3.rds")
pisr_den_glmm3 <- add_criterion(pisr_den_glmm3, "loo")

pisr_den_glmm4 <- brm(formula = Density_m2 ~ RelYear, data = pisr_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pisr_den_glmm4.rds")
pisr_den_glmm4 <- add_criterion(pisr_den_glmm4, "loo")

pisr_den_glmm5 <- brm(formula = Density_m2 ~ RelYear, data = pisr_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pisr_den_glmm5.rds")
pisr_den_glmm5 <- add_criterion(pisr_den_glmm5, "loo")

pisr_den_glmm6 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pisr_den_glmm6.rds")
pisr_den_glmm6 <- add_criterion(pisr_den_glmm6, "loo")

pisr_den_glmm7 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pisr_den_glmm7.rds")
pisr_den_glmm7 <- add_criterion(pisr_den_glmm7, "loo")

pisr_den_glmm8 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pisr_den_glmm8.rds")
pisr_den_glmm8 <- add_criterion(pisr_den_glmm8, "loo")

#Trying the best-fitting model again with custom priors because this is a restoration site, so it has a discrete beginning in 2015 with known low density to start.
pisr_den_glmm9 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n, family = zero_inflated_negbinomial, prior = c(set_prior("uniform(0,5)", class = "b", coef = "RelYear"), set_prior("uniform(0,50)", class = "Intercept")), cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pisr_den_glmm9.rds")
pisr_den_glmm9 <- add_criterion(pisr_den_glmm9, "loo")

#Previous model converged but got a warning saying I should define "lb" for the RelYear prior, so I try that below instead of defining coef.
pisr_den_glmm10 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n, family = zero_inflated_negbinomial, prior = c(set_prior("uniform(0,5)", class = "b", lb = 0), set_prior("uniform(0,50)", class = "Intercept")), cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pisr_den_glmm10.rds")
pisr_den_glmm10 <- add_criterion(pisr_den_glmm10, "loo")

#Previous model converged but got a warning saying I should define "ub" for the RelYear prior, so I try that below.
pisr_den_glmm11 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n, family = zero_inflated_negbinomial, prior = c(set_prior("uniform(0,5)", class = "b", lb = 0, ub = 5), set_prior("uniform(0,50)", class = "Intercept")), cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pisr_den_glmm11.rds")
pisr_den_glmm11 <- add_criterion(pisr_den_glmm11, "loo")

#Trying previous model again without the intercept prior.
pisr_den_glmm12 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n, family = zero_inflated_negbinomial, prior = set_prior("uniform(0,5)", class = "b", lb = 0, ub = 5), cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pisr_den_glmm12.rds")
pisr_den_glmm12 <- add_criterion(pisr_den_glmm12, "loo")

#Trying model 11 again without the RelYear prior.
pisr_den_glmm13 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n, family = zero_inflated_negbinomial, prior = set_prior("uniform(0,50)", class = "Intercept"), cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/pisr_den_glmm13.rds")
pisr_den_glmm13 <- add_criterion(pisr_den_glmm13, "loo")

#GLMM13 is the best fit to the data, but I think the lower bound of 0 on RelYear is important because that was the start date of the restored reef and the upper bound of 5 because you can't have years that haven't happened yet, so I have gone with model 12. The best fit models (8 and 13) show declining curves from impossible y-intercepts given that the restored reef really should start with low oyster density.
loo_compare(pisr_den_glmm1, pisr_den_glmm2, pisr_den_glmm3, pisr_den_glmm4, pisr_den_glmm5, pisr_den_glmm6, pisr_den_glmm7, pisr_den_glmm8, pisr_den_glmm9, pisr_den_glmm10, pisr_den_glmm11, pisr_den_glmm12, pisr_den_glmm13)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
pisr_n <- subset(oysterraw_den_nona, oysterraw_den_nona$MA_plotlab == "Pine Island Sound_Restored")
pisr_n[, QuadSize_m2 := as.numeric(QuadSize_m2)]
pisr_n[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
pisr_n[, RelYear := Year - min(Year)]
pisr_n[, Number_of_Oysters_Counted_Live_Count := Density_m2*QuadSize_m2]
pisr_n[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
pisr_n[, Density_m2 := as.integer(Density_m2)]

pisr_den_glmm <- readRDS(here::here('GLMMs/AllDates/pisr_den_glmm12.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

pisr_n[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
pisr_n[, SampleDay := day(SampleDate)]


den_t <- copy(pisr_n[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(pisr_n$Month))){
  mo <- subset(pisr_n, as.numeric(pisr_n$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(pisr_n, pisr_n$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = "All", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(Density_m2),
                       Median = median(Density_m2),
                       Mean = round(mean(Density_m2), digits = 2),
                       SD = round(sd(Density_m2), digits = 2), 
                       Min. = min(Density_m2),
                       Max. = max(Density_m2)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(pisr_sho75, pisr_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(pisr_n, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(pisr_n, aes(x = as.factor(reefIDcrosswalk), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(pisr_den_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_PISR_PDistandMChains_raw <- plot(pisr_den_glmm)
Den_AllDates_GLMM_PISR_PDistandMChains_raw

len <- length(Den_AllDates_GLMM_PISR_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_PISR_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_PISR_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_PISR_PPcheck_raw <- pp_check(pisr_den_glmm)
Den_AllDates_GLMM_PISR_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_PISR_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_PISR_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots


```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=4, fig.width=5, out.width="100%"}
#Marginal effects plot; this is the only one because there is no grouping variable in the model - the data are from a single restored reef.
pisr1 <- plot(conditional_effects(pisr_den_glmm), plot = FALSE)[[1]]
Den_AllDates_GLMM_PISR_MEPrand_raw <- pisr1 +
  geom_jitter(data = pisr_n, aes(x = RelYear, y = Density_m2, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = pisr_n, aes(y = -250, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  #ylim(0, 3000) +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_AllDates_GLMM_PISR_MEPrand_raw

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_PISR_MEPrand_raw_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_PISR_MEPrand_raw,
       width = 5,
       height = 4,
       units = "in",
       dpi = 300)
```

<br><br><br>

#### Only 25-75mm shell height {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ##### Apalachicola Bay_Natural {.tabset .tabset-fade .tabset-pills}
#
# #ONLY 4 YEARS OF DATA WITHOUT THE HISTORICAL COMPONENT
# 
# ab_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Apalachicola Bay_Natural")
# ab_n_r_seed[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# ab_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# ab_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(ab_n_r_seed, here::here(paste0('GLMMs/AllDates/Data/ab_n_r_seed_', Sys.Date(), '.rds')))
# 
# ab_den_r_seed_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + Subtidal + (1 + RelYear|reefIDcrosswalk), data = ab_n_r_seed, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# ab_den_r_seed_glmm <- add_criterion(ab_den_r_seed_glmm, "loo")
# 
# ggplot(ab_n_r_seed, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
#   geom_jitter() +
#   theme_bw()
# 
# ggplot(ab_n_r_seed, aes(x = reefIDcrosswalk, y = as.factor(QuadSize_m2), color = RelYear)) +
#   geom_jitter() +
#   theme_bw()
# 
# ggplot(ab_n_r_seed, aes(x = Subtidal, y = as.factor(QuadSize_m2), color = RelYear)) +
#   geom_jitter() +
#   theme_bw()
# 
# ab_den_r_seed_glmm1 <- brm(formula = meanDen ~ 1, data = ab_n_r_seed, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_r_seed_glmm1.rds")
# ab_den_r_seed_glmm1 <- add_criterion(ab_den_r_seed_glmm1, "loo")
# 
# ab_den_r_seed_glmm2 <- brm(formula = meanDen ~ RelYear, data = ab_n_r_seed, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_r_seed_glmm2.rds")
# ab_den_r_seed_glmm2 <- add_criterion(ab_den_r_seed_glmm2, "loo")
# 
# ab_den_r_seed_glmm3 <- brm(formula = meanDen ~ QuadSize_m2, data = ab_n_r_seed, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_r_seed_glmm3.rds")
# ab_den_r_seed_glmm3 <- add_criterion(ab_den_r_seed_glmm3, "loo")
# 
# ab_den_r_seed_glmm4 <- brm(formula = meanDen ~ Subtidal, data = ab_n_r_seed, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_r_seed_glmm4.rds")
# ab_den_r_seed_glmm4 <- add_criterion(ab_den_r_seed_glmm4, "loo")
# 
# ab_den_r_seed_glmm5 <- brm(formula = meanDen ~ RelYear + QuadSize_m2 + (1 | reefIDcrosswalk), data = ab_n_r_seed, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_r_seed_glmm5.rds")
# ab_den_r_seed_glmm5 <- add_criterion(ab_den_r_seed_glmm5, "loo")
# 
# ab_den_r_seed_glmm6 <- brm(formula = meanDen ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = ab_n_r_seed, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_r_seed_glmm6.rds")
# ab_den_r_seed_glmm6 <- add_criterion(ab_den_r_seed_glmm6, "loo")
# 
# ab_den_r_seed_glmm7 <- brm(formula = meanDen_int ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = ab_n_r_seed, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_r_seed_glmm7.rds")
# ab_den_r_seed_glmm7 <- add_criterion(ab_den_r_seed_glmm7, "loo")
# 
# ab_den_r_seed_glmm8 <- brm(formula = meanDen_int ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = ab_n_r_seed, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/ab_den_r_seed_glmm8.rds")
# ab_den_r_seed_glmm8 <- add_criterion(ab_den_r_seed_glmm8, "loo")
# 
# #GLMM7 is the best fit.
# loo_compare(ab_den_r_seed_glmm1, ab_den_r_seed_glmm2, ab_den_r_seed_glmm3, ab_den_r_seed_glmm4, ab_den_r_seed_glmm5, ab_den_r_seed_glmm6, ab_den_r_seed_glmm7, ab_den_r_seed_glmm8)
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# ab_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Apalachicola Bay_Natural")
# ab_n_r_seed[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# ab_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# ab_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
# 
# ab_den_r_seed_glmm <- readRDS(here::here('GLMMs/AllDates/ab_den_r_seed_glmm7.rds'))

```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Model Output
# 
# summary(ab_den_r_seed_glmm)
#
# <br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Diagnostic Plots
# 
# Posterior distributions and Markov chains:
# 
# Den_AllDates_GLMM_AB_PDistandMChains_r_seed <- plot(ab_den_r_seed_glmm)
# Den_AllDates_GLMM_AB_PDistandMChains_r_seed
# 
# len <- length(Den_AllDates_GLMM_AB_PDistandMChains_r_seed)
# for(i in 1:len){
#   jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_PDistandMChains_r_seed_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
#   print(Den_AllDates_GLMM_AB_PDistandMChains_r_seed[i])
#   dev.off()
# }

# <br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# Posterior predictive check plot:
# 
# Den_AllDates_GLMM_AB_PPcheck_r_seed <- pp_check(ab_den_r_seed_glmm)
# Den_AllDates_GLMM_AB_PPcheck_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_PPcheck_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_AB_PPcheck_r_seed,
#        width = 4,
#        height = 3,
#        units = "in",
#        dpi = 300)
```


```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Marginal Effects Plots
# 
# Including the random effect of reef (i.e., managed area-wide credible interval):
# 
# #Marginal effects plot including random effects
# ab1_r_seed <- plot(conditional_effects(ab_den_r_seed_glmm, re_formula = NULL), plot = FALSE)[[1]]
# Den_AllDates_GLMM_AB_MEPrand_r_seed <- ab1_r_seed +
#   geom_point(data = ab_n_r_seed, aes(x = RelYear, y = meanDen_int, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   geom_text(data = ab_n_r_seed, aes(y = -10, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
#   theme_bw() +
#   labs(fill = "Reef ID")
# Den_AllDates_GLMM_AB_MEPrand_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_MEPrand_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_AB_MEPrand_r_seed,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# <br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Excluding the random effect of reef (i.e., sampled population credible interval):
# 
# #Marginal effects plot excluding random effects
# ab2_r_seed <- plot(conditional_effects(ab_den_r_seed_glmm, re_formula = NA), plot = FALSE)[[1]]
# Den_AllDates_GLMM_AB_MEPnorand_r_seed <- ab2_r_seed +
#   geom_point(data = ab_n_r_seed, aes(x = RelYear, y = meanDen_int, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   geom_text(data = ab_n_r_seed, aes(y = -2, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
#   theme_bw() +
#   labs(fill = "Reef ID")
# Den_AllDates_GLMM_AB_MEPnorand_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_MEPnorand_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_AB_MEPnorand_r_seed,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
#
# #<br><br><br>
```

```{r eval=FALSE, fig.height=50, fig.width=10, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Individual effects plots:
# 
# #Individual effects plots
# Den_AllDates_GLMM_AB_IEP_r_seed <- ab_n_r_seed %>%
#   group_by(reefIDcrosswalk) %>%
#   add_fitted_draws(ab_den_r_seed_glmm) %>%
#   ggplot(aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
#   geom_hline(yintercept = 0, lwd = 0.5, color = "black") +
#   stat_lineribbon(aes(y = .value), size = 1) +
#   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
#   geom_point(data = ab_n_r_seed) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
#   #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
#   scale_fill_brewer(palette = "Greys") +
#   #scale_color_brewer(palette = "Set2") +
#   geom_text(data = ab_n_r_seed, aes(y = -8, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
#   theme_bw() + theme(axis.line = element_line()) +
#   scale_x_continuous(limits = c(-1, max(ab_n_r_seed$RelYear) + 1)) +
#   scale_y_continuous(limits = c(-10, 105)) +
#   labs(color = "Reef ID", fill = "Credible Interval") +
#   facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
# Den_AllDates_GLMM_AB_IEP_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_IEP_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_AB_IEP_r_seed,
#        width = 10,
#        height = 20,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# # Remove created objects to save memory.
# rm(ab_n_r_seed, ab_den_r_seed_glmm, 
#    Den_AllDates_GLMM_AB_PDistandMChains_r_seed,
#    Den_AllDates_GLMM_AB_PPcheck_r_seed,
#    Den_AllDates_GLMM_AB_MEPrand_r_seed,
#    Den_AllDates_GLMM_AB_MEPnorand_r_seed,
#    Den_AllDates_GLMM_AB_IEP_r_seed
#    )
# 
# #<br><br><br>
```

##### Apalachicola NERR_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

an_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Apalachicola NERR_Natural")
an_n_r_seed[, QuadSize_m2 := as.factor(QuadSize_m2)]
an_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
an_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
saveRDS(an_n_r_seed, here::here(paste0('GLMMs/AllDates/Data/an_n_r_seed_', Sys.Date(), '.rds')))

an_den_r_seed_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + Subtidal + (1 + RelYear|reefIDcrosswalk), data = an_n_r_seed, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
an_den_r_seed_glmm <- add_criterion(an_den_r_seed_glmm, "loo")

ggplot(an_n_r_seed, aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(an_n_r_seed, aes(x = RelYear, y = factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(an_n_r_seed, aes(x = RelYear, y = Subtidal, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

#Converged, intercept significant.
an_den_r_seed_glmm1 <- brm(formula = meanDen_int ~ 1, data = an_n_r_seed, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm1.rds")
an_den_r_seed_glmm1 <- add_criterion(an_den_r_seed_glmm1, "loo")

an_den_r_seed_glmm2 <- brm(formula = meanDen_int ~ RelYear, data = an_n_r_seed, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm2.rds")
an_den_r_seed_glmm2 <- add_criterion(an_den_r_seed_glmm2, "loo")

an_den_r_seed_glmm3 <- brm(formula = meanDen_int ~ RelYear, data = an_n_r_seed, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm3.rds")
an_den_r_seed_glmm3 <- add_criterion(an_den_r_seed_glmm3, "loo")

an_den_r_seed_glmm4 <- brm(formula = meanDen_int ~ RelYear, data = an_n_r_seed, family = zero_inflated_poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm4.rds")
an_den_r_seed_glmm4 <- add_criterion(an_den_r_seed_glmm4, "loo")

an_den_r_seed_glmm5 <- brm(formula = meanDen_int ~ RelYear, data = an_n_r_seed, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm5.rds")
an_den_r_seed_glmm5 <- add_criterion(an_den_r_seed_glmm5, "loo")

#Model 5 is the best of the initial fits, so I will use zero_inflated_negbinomial as the family for subsequent models.
loo_compare(an_den_r_seed_glmm1, an_den_r_seed_glmm2, an_den_r_seed_glmm3, an_den_r_seed_glmm4, an_den_r_seed_glmm5)

#Model converged; Subtidal was a significant variable
an_den_r_seed_glmm6 <- brm(formula = meanDen_int ~ Subtidal, data = an_n_r_seed, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm6.rds")
an_den_r_seed_glmm6 <- add_criterion(an_den_r_seed_glmm6, "loo")

#QuadSize_m2 was significant
an_den_r_seed_glmm6b <- brm(formula = meanDen_int ~ factor(QuadSize_m2), data = an_n_r_seed, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm6b.rds")
an_den_r_seed_glmm6b <- add_criterion(an_den_r_seed_glmm6b, "loo")

an_den_r_seed_glmm7 <- brm(formula = meanDen_int ~ RelYear + (1 | reefIDcrosswalk), data = an_n_r_seed, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm7.rds")
an_den_r_seed_glmm7 <- add_criterion(an_den_r_seed_glmm7, "loo")

an_den_r_seed_glmm8 <- brm(formula = meanDen_int ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = an_n_r_seed, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm8.rds")
an_den_r_seed_glmm8 <- add_criterion(an_den_r_seed_glmm8, "loo")

an_den_r_seed_glmm9 <- brm(formula = meanDen_int ~ RelYear + factor(QuadSize_m2), data = an_n_r_seed, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm9.rds")
an_den_r_seed_glmm9 <- add_criterion(an_den_r_seed_glmm9, "loo")

an_den_r_seed_glmm9b <- brm(formula = meanDen_int ~ RelYear + QuadSize_m2 + Subtidal, data = an_n_r_seed, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm9b.rds")
an_den_r_seed_glmm9b <- add_criterion(an_den_r_seed_glmm9b, "loo")

an_den_r_seed_glmm10 <- brm(formula = meanDen_int ~ RelYear + factor(QuadSize_m2) + (1 | reefIDcrosswalk), data = an_n_r_seed, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm10.rds")
an_den_r_seed_glmm10 <- add_criterion(an_den_r_seed_glmm10, "loo")

an_den_r_seed_glmm10b <- brm(formula = meanDen_int ~ RelYear + QuadSize_m2 + Subtidal + (1 | reefIDcrosswalk), data = an_n_r_seed, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm10b.rds")
an_den_r_seed_glmm10b <- add_criterion(an_den_r_seed_glmm10b, "loo")

an_den_r_seed_glmm11 <- brm(formula = meanDen_int ~ RelYear + factor(QuadSize_m2) + (0 + RelYear | reefIDcrosswalk), data = an_n_r_seed, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm11.rds")
an_den_r_seed_glmm11 <- add_criterion(an_den_r_seed_glmm11, "loo")

an_den_r_seed_glmm11b <- brm(formula = meanDen_int ~ RelYear + QuadSize_m2 + Subtidal + (0 + RelYear | reefIDcrosswalk), data = an_n_r_seed, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/an_den_r_seed_glmm11b.rds")
an_den_r_seed_glmm11b <- add_criterion(an_den_r_seed_glmm11b, "loo")

#GLMM 7 is the best fit to the data, but 10b is the best fit of the models that include QuadSize and Subtidal, so I am choosing that one.
loo_compare(an_den_r_seed_glmm6, an_den_r_seed_glmm6b, an_den_r_seed_glmm7, an_den_r_seed_glmm8, an_den_r_seed_glmm9, an_den_r_seed_glmm9b, an_den_r_seed_glmm10, an_den_r_seed_glmm10b, an_den_r_seed_glmm11, an_den_r_seed_glmm11b)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
an_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Apalachicola NERR_Natural")
an_n_r_seed[, QuadSize_m2 := as.factor(QuadSize_m2)]
an_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
an_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]

an_den_r_seed_glmm <- readRDS(here::here('GLMMs/AllDates/an_den_r_seed_glmm10b.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

an_n_r_seed[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
an_n_r_seed[, SampleDay := day(SampleDate)]


den_t <- copy(an_n_r_seed[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(an_n_r_seed$Month))){
  mo <- subset(an_n_r_seed, as.numeric(an_n_r_seed$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(an_n_r_seed, an_n_r_seed$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = "25-75mm", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(meanDen_int),
                       Median = median(meanDen_int),
                       Mean = round(mean(meanDen_int), digits = 2),
                       SD = round(sd(meanDen_int), digits = 2), 
                       Min. = min(meanDen_int),
                       Max. = max(meanDen_int)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "25-75mm",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(eb_sho75, eb_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(an_n_r_seed, aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(an_n_r_seed, aes(x = RelYear, y = factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(an_n_r_seed, aes(x = RelYear, y = Subtidal, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(an_den_r_seed_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_AN_PDistandMChains_r_seed <- plot(an_den_r_seed_glmm)
Den_AllDates_GLMM_AN_PDistandMChains_r_seed

len <- length(Den_AllDates_GLMM_AN_PDistandMChains_r_seed)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_PDistandMChains_r_seed_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_AN_PDistandMChains_r_seed[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_AN_PPcheck_r_seed <- pp_check(an_den_r_seed_glmm)
Den_AllDates_GLMM_AN_PPcheck_r_seed

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_PPcheck_r_seed_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_AN_PPcheck_r_seed,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
set.seed(987)
an1_r_seed <- plot(conditional_effects(an_den_r_seed_glmm, re_formula = NULL), plot = FALSE)[[1]]
Den_AllDates_GLMM_AN_MEPrand_r_seed <- an1_r_seed +
  geom_jitter(data = an_n_r_seed, aes(x = RelYear, y = meanDen_int, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = an_n_r_seed, aes(y = -10, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13),
    legend.position = "none") +
  labs(colour = NULL)
Den_AllDates_GLMM_AN_MEPrand_r_seed

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_MEPrand_r_seed_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_AN_MEPrand_r_seed,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
set.seed(988)
an2_r_seed <- plot(conditional_effects(an_den_r_seed_glmm, re_formula = NA), plot = FALSE)[[1]]
Den_AllDates_GLMM_AN_MEPnorand_r_seed <- an2_r_seed +
  geom_jitter(data = an_n_r_seed, aes(x = RelYear, y = meanDen_int, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = an_n_r_seed, aes(y = -10, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13),
    legend.position = "none") +
  labs(colour = NULL)
Den_AllDates_GLMM_AN_MEPnorand_r_seed

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_MEPnorand_r_seed_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_AN_MEPnorand_r_seed,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots (note that I could not get some of the 95% credible intervals to plot):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"}
#Individual effects plots
Den_AllDates_GLMM_AN_IEP_r_seed <- an_n_r_seed %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(an_den_r_seed_glmm) %>%
  ggplot(aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = an_n_r_seed) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = an_n_r_seed, aes(y = -20, label = Year, x = RelYear), size = 2, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(an_n_r_seed, an_n_r_seed$Year %in% labs2), aes(y = -300, label = Year, x = RelYear), size = 2, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(an_n_r_seed$RelYear) + 1)) +
  scale_y_continuous(limits = c(-25, 250)) +
  coord_cartesian(ylim = c(-25, 130)) +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
Den_AllDates_GLMM_AN_IEP_r_seed

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_IEP_r_seed_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_AN_IEP_r_seed,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(an_n_r_seed, an_den_r_seed_glmm, 
   Den_AllDates_GLMM_AN_PDistandMChains_r_seed,
   Den_AllDates_GLMM_AN_PPcheck_r_seed,
   Den_AllDates_GLMM_AN_MEPrand_r_seed,
   Den_AllDates_GLMM_AN_MEPnorand_r_seed,
   Den_AllDates_GLMM_AN_IEP_r_seed
   )

```

<br><br><br>

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ##### Big Bend Seagrasses_Natural {.tabset .tabset-fade .tabset-pills}
# 
# bbs_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Big Bend Seagrasses_Natural")
# bbs_n_r_seed[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# bbs_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# bbs_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(bbs_n_r_seed, here::here(paste0('GLMMs/AllDates/Data/bbs_n_r_seed_', Sys.Date(), '.rds')))
# 
# bbs_den_r_seed_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = bbs_n_r_seed, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# bbs_den_r_seed_glmm <- add_criterion(bbs_den_r_seed_glmm, "loo")
# 
# saveRDS(bbs_den_r_seed_glmm, here::here('GLMMs/AllDates/bbs_den_r_seed_glmm.rds'))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# bbs_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Big Bend Seagrasses_Natural")
# bbs_n_r_seed[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# bbs_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# bbs_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(bbs_n_r_seed, here::here(paste0('GLMMs/AllDates/Data/bbs_n_r_seed_', Sys.Date(), '.rds')))
# 
# bbs_den_r_seed_glmm <- readRDS(here::here('GLMMs/AllDates/bbs_den_r_seed_glmm.rds'))

```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Model Output
# 
# summary(bbs_den_r_seed_glmm)
# 
# <br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Diagnostic Plots
# 
# Posterior distributions and Markov chains:
# 
# Den_AllDates_GLMM_BBS_PDistandMChains_r_seed <- plot(bbs_den_r_seed_glmm)
# Den_AllDates_GLMM_BBS_PDistandMChains_r_seed
# 
# len <- length(Den_AllDates_GLMM_BBS_PDistandMChains_r_seed)
# for(i in 1:len){
#   jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_BBS_PDistandMChains_r_seed_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
#   print(Den_AllDates_GLMM_BBS_PDistandMChains_r_seed[i])
#   dev.off()
# }
# 
# <br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# Posterior predictive check plot:
# 
# Den_AllDates_GLMM_BBS_PPcheck_r_seed <- pp_check(bbs_den_r_seed_glmm)
# Den_AllDates_GLMM_BBS_PPcheck_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_BBS_PPcheck_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_BBS_PPcheck_r_seed,
#        width = 4,
#        height = 3,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Marginal Effects Plots
# 
# Including the random effect of reef (i.e., managed area-wide credible interval):
#   
# #Marginal effects plot including random effects
# bbs1_r_seed <- plot(conditional_effects(bbs_den_r_seed_glmm, re_formula = NULL), plot = FALSE)[[1]]
# Den_AllDates_GLMM_BBS_MEPrand_r_seed <- bbs1_r_seed +
#   geom_point(data = bbs_n_r_seed, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_BBS_MEPrand_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_BBS_MEPrand_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_BBS_MEPrand_r_seed,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# <br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Excluding the random effect of reef (i.e., sampled population credible interval):
#   
# #Marginal effects plot excluding random effects
# bbs2_r_seed <- plot(conditional_effects(bbs_den_r_seed_glmm, re_formula = NA), plot = FALSE)[[1]]
# Den_AllDates_GLMM_BBS_MEPnorand_r_seed <- bbs2_r_seed +
#   geom_point(data = bbs_n_r_seed, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_BBS_MEPnorand_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_BBS_MEPnorand_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_BBS_MEPnorand_r_seed,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>
```

```{r eval=FALSE, fig.height=80, fig.width=10, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Individual effects plots:
# 
# #Individual effects plots
# Den_AllDates_GLMM_BBS_IEP_r_seed <- bbs_n_r_seed %>%
#   group_by(reefIDcrosswalk) %>%
#   add_fitted_draws(bbs_den_r_seed_glmm) %>%
#   ggplot(aes(x = RelYear, y = meanCount, color = reefIDcrosswalk)) +
#   stat_lineribbon(aes(y = .value), size = 1) +
#   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
#   geom_point(data = bbs_n_r_seed) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
#   #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
#   scale_fill_brewer(palette = "Greys") +
#   #scale_color_brewer(palette = "Set2") +
#   theme_bw() +
#   facet_wrap(~ reefIDcrosswalk, ncol = 3)
# Den_AllDates_GLMM_BBS_IEP_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_BBS_IEP_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_BBS_IEP_r_seed,
#        width = 10,
#        height = 5,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# # Remove created objects to save memory.
# rm(bbs_n_r_seed, bbs_den_r_seed_glmm, 
#    Den_AllDates_GLMM_BBS_PDistandMChains_r_seed,
#    Den_AllDates_GLMM_BBS_PPcheck_r_seed,
#    Den_AllDates_GLMM_BBS_MEPrand_r_seed,
#    Den_AllDates_GLMM_BBS_MEPnorand_r_seed,
#    Den_AllDates_GLMM_BBS_IEP_r_seed
#    )

```

<br><br><br>

##### Estero Bay_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

eb_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Estero Bay_Natural")
eb_n_r_seed[, QuadSize_m2 := factor(QuadSize_m2)]
eb_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
eb_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
saveRDS(eb_n_r_seed, here::here(paste0('GLMMs/AllDates/Data/eb_n_r_seed_', Sys.Date(), '.rds')))

eb_den_r_seed_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = eb_n_r_seed, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
eb_den_r_seed_glmm <- add_criterion(eb_den_r_seed_glmm, "loo")

ggplot(eb_n_r_seed, aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(eb_n_r_seed, aes(x = RelYear, y = factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(eb_n_r_seed, aes(x = RelYear, y = reefIDcrosswalk, color = ProgramID)) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none")

#Converged, intercept significant.
eb_den_r_seed_glmm1 <- brm(formula = meanDen_int ~ 1, data = eb_n_r_seed, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_seed_glmm1.rds")
eb_den_r_seed_glmm1 <- add_criterion(eb_den_r_seed_glmm1, "loo")

eb_den_r_seed_glmm2 <- brm(formula = meanDen_int ~ RelYear, data = eb_n_r_seed, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_seed_glmm2.rds")
eb_den_r_seed_glmm2 <- add_criterion(eb_den_r_seed_glmm2, "loo")

eb_den_r_seed_glmm3 <- brm(formula = meanDen_int ~ RelYear, data = eb_n_r_seed, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_seed_glmm3.rds")
eb_den_r_seed_glmm3 <- add_criterion(eb_den_r_seed_glmm3, "loo")

eb_den_r_seed_glmm4 <- brm(formula = meanDen_int ~ RelYear, data = eb_n_r_seed, family = zero_inflated_poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_seed_glmm4.rds")
eb_den_r_seed_glmm4 <- add_criterion(eb_den_r_seed_glmm4, "loo")

eb_den_r_seed_glmm5 <- brm(formula = meanDen_int ~ RelYear, data = eb_n_r_seed, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_seed_glmm5.rds")
eb_den_r_seed_glmm5 <- add_criterion(eb_den_r_seed_glmm5, "loo")

#Model 3 is the best fit, so I will use negbinomial as the family for the rest of the models moving forward.
loo_compare(eb_den_r_seed_glmm1, eb_den_r_seed_glmm2, eb_den_r_seed_glmm3, eb_den_r_seed_glmm4, eb_den_r_seed_glmm5)

#QuadSize_m2 is significant as well.
eb_den_r_seed_glmm6 <- brm(formula = meanDen_int ~ QuadSize_m2, data = eb_n_r_seed, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_seed_glmm6.rds")
eb_den_r_seed_glmm6 <- add_criterion(eb_den_r_seed_glmm6, "loo")

eb_den_r_seed_glmm7 <- brm(formula = meanDen_int ~ RelYear + QuadSize_m2, data = eb_n_r_seed, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_seed_glmm7.rds")
eb_den_r_seed_glmm7 <- add_criterion(eb_den_r_seed_glmm7, "loo")

eb_den_r_seed_glmm8 <- brm(formula = meanDen_int ~ RelYear + QuadSize_m2 + (1 | reefIDcrosswalk), data = eb_n_r_seed, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_seed_glmm8.rds")
eb_den_r_seed_glmm8 <- add_criterion(eb_den_r_seed_glmm8, "loo")

eb_den_r_seed_glmm9 <- brm(formula = meanDen_int ~ RelYear + QuadSize_m2 + (0 + RelYear | reefIDcrosswalk), data = eb_n_r_seed, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_seed_glmm9.rds")
eb_den_r_seed_glmm9 <- add_criterion(eb_den_r_seed_glmm9, "loo")

eb_den_r_seed_glmm10 <- brm(formula = meanDen_int ~ RelYear + (1 | reefIDcrosswalk), data = eb_n_r_seed, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_seed_glmm10.rds")
eb_den_r_seed_glmm10 <- add_criterion(eb_den_r_seed_glmm10, "loo")

eb_den_r_seed_glmm11 <- brm(formula = meanDen_int ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = eb_n_r_seed, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_seed_glmm11.rds")
eb_den_r_seed_glmm11 <- add_criterion(eb_den_r_seed_glmm11, "loo")

#GLMM7 is the best fit. reefIDcrosswalk wasn't in the best model possibly because there is only one year of monitoring for all but one reef.
loo_compare(eb_den_r_seed_glmm6, eb_den_r_seed_glmm7, eb_den_r_seed_glmm8, eb_den_r_seed_glmm9, eb_den_r_seed_glmm10, eb_den_r_seed_glmm11)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
eb_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Estero Bay_Natural")
eb_n_r_seed[, QuadSize_m2 := as.factor(QuadSize_m2)]
eb_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
eb_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
saveRDS(eb_n_r_seed, here::here(paste0('GLMMs/AllDates/Data/eb_n_r_seed_', Sys.Date(), '.rds')))

eb_den_r_seed_glmm <- readRDS(here::here('GLMMs/AllDates/eb_den_r_seed_glmm7.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

eb_n_r_seed[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
eb_n_r_seed[, SampleDay := day(SampleDate)]


den_t <- copy(eb_n_r_seed[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(eb_n_r_seed$Month))){
  mo <- subset(eb_n_r_seed, as.numeric(eb_n_r_seed$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(eb_n_r_seed, eb_n_r_seed$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = "25-75mm", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(meanDen_int),
                       Median = median(meanDen_int),
                       Mean = round(mean(meanDen_int), digits = 2),
                       SD = round(sd(meanDen_int), digits = 2), 
                       Min. = min(meanDen_int),
                       Max. = max(meanDen_int)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "25-75mm",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(eb_sho75, eb_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(eb_n_r_seed, aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(eb_n_r_seed, aes(x = RelYear, y = factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")


```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(eb_n_r_seed, aes(x = RelYear, y = reefIDcrosswalk, color = ProgramID)) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(eb_den_r_seed_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_EB_PDistandMChains_r_seed <- plot(eb_den_r_seed_glmm)
Den_AllDates_GLMM_EB_PDistandMChains_r_seed

len <- length(Den_AllDates_GLMM_EB_PDistandMChains_r_seed)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_PDistandMChains_r_seed_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_EB_PDistandMChains_r_seed[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_EB_PPcheck_r_seed <- pp_check(eb_den_r_seed_glmm)
Den_AllDates_GLMM_EB_PPcheck_r_seed

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_PPcheck_r_seed_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_EB_PPcheck_r_seed,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
set.seed(987)
eb1_r_seed <- plot(conditional_effects(eb_den_r_seed_glmm, re_formula = NULL), plot = FALSE)[[1]]
Den_AllDates_GLMM_EB_MEP_r_seed <- eb1_r_seed +
  geom_jitter(data = eb_n_r_seed, aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk, shape = as.factor(QuadSize_m2)), alpha = 0.5, size = 3, width = 0.05, inherit.aes = FALSE) +
  geom_text(data = eb_n_r_seed, aes(y = -10, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(color = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) #,
    #legend.position = "none")
Den_AllDates_GLMM_EB_MEP_r_seed

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_MEP_r_seed_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_EB_MEP_r_seed,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
meanDen_r_seed <- plot(conditional_effects(eb_den_r_seed_glmm, re_formula = NULL), plot = FALSE)[[2]]$data
#setnames(meanDen_r_seed, "effect1__", "QuadSize_m2")

Den_AllDates_GLMM_EB_MEP_r_seed_MeanRes <- ggplot(meanDen_r_seed, aes(x = QuadSize_m2, y = estimate__, ymin = lower__, ymax = upper__)) +
  geom_pointinterval(fill = "black", size = 3, fatten_point = 4, shape = 21, color = "black") +
  ylab("Density_m2 (shell height 25-75mm") +
  theme_bw()  + 
  theme(axis.title = element_text(size = 13), 
        axis.text = element_text(size = 12), 
        legend.text = element_text(size = 12), 
        legend.title = element_text(size = 13))+labs(fill = NULL)
Den_AllDates_GLMM_EB_MEP_r_seed_MeanRes

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_MEP_r_seed_MeanRes_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_EB_MEP_r_seed_MeanRes,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br><br>

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Excluding the random effect of reef (i.e., sampled population credible interval):
# 
# #Marginal effects plot excluding random effects
# eb2_r_seed <- plot(conditional_effects(eb_den_r_seed_glmm, re_formula = NA), plot = FALSE)[[1]]
# Den_AllDates_GLMM_EB_MEPnorand_r_seed <- eb2_r_seed +
#   geom_point(data = eb_n_r_seed, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_EB_MEPnorand_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_MEPnorand_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_EB_MEPnorand_r_seed,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
#
# #<br><br><br>
```

```{r eval=FALSE, fig.height=80, fig.width=10, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Individual effects plots:
# 
# #Individual effects plots
# Den_AllDates_GLMM_EB_IEP_r_seed <- eb_n_r_seed %>%
#   group_by(reefIDcrosswalk) %>%
#   add_fitted_draws(eb_den_r_seed_glmm) %>%
#   ggplot(aes(x = RelYear, y = meanCount, color = reefIDcrosswalk)) +
#   stat_lineribbon(aes(y = .value), size = 1) +
#   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
#   geom_point(data = eb_n_r_seed) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
#   #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
#   scale_fill_brewer(palette = "Greys") +
#   #scale_color_brewer(palette = "Set2") +
#   theme_bw() +
#   facet_wrap(~ reefIDcrosswalk, ncol = 3)
# Den_AllDates_GLMM_EB_IEP_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_IEP_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_EB_IEP_r_seed,
#        width = 10,
#        height = 20,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(eb_n_r_seed, eb_den_r_seed_glmm, 
   Den_AllDates_GLMM_EB_PDistandMChains_r_seed,
   Den_AllDates_GLMM_EB_PPcheck_r_seed,
   Den_AllDates_GLMM_EB_MEPrand_r_seed,
   Den_AllDates_GLMM_EB_MEPnorand_r_seed,
   Den_AllDates_GLMM_EB_IEP_r_seed
   )

```

<br><br><br>

##### Guana River Marsh_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

grm_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Guana River Marsh_Natural")
grm_n_r_seed[, QuadSize_m2 := as.factor(QuadSize_m2)]
grm_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
grm_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
saveRDS(grm_n_r_seed, here::here(paste0('GLMMs/AllDates/Data/grm_n_r_seed_', Sys.Date(), '.rds')))

grm_den_r_seed_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = grm_n_r_seed, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "identity"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
grm_den_r_seed_glmm <- add_criterion(grm_den_r_seed_glmm, "loo")

ggplot(grm_n_r_seed, aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(grm_n_r_seed, aes(x = RelYear, y = QuadSize_m2, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(grm_n_r_seed, aes(x = RelYear, y = reefIDcrosswalk, color = reefIDcrosswalk)) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none")

#Model converged, intercept significant
grm_den_r_seed_glmm1 <- brm(formula = meanDen_int ~ 1, data = grm_n_r_seed, family = poisson, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_r_seed_glmm1.rds")
grm_den_r_seed_glmm1 <- add_criterion(grm_den_r_seed_glmm1, "loo")

grm_den_r_seed_glmm2 <- brm(formula = meanDen_int ~ RelYear, data = grm_n_r_seed, family = poisson, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_r_seed_glmm2.rds")
grm_den_r_seed_glmm2 <- add_criterion(grm_den_r_seed_glmm2, "loo")

grm_den_r_seed_glmm3 <- brm(formula = meanDen_int ~ RelYear, data = grm_n_r_seed, family = negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_r_seed_glmm3.rds")
grm_den_r_seed_glmm3 <- add_criterion(grm_den_r_seed_glmm3, "loo")

grm_den_r_seed_glmm4 <- brm(formula = meanDen_int ~ RelYear, data = grm_n_r_seed, family = zero_inflated_poisson, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_r_seed_glmm4.rds")
grm_den_r_seed_glmm4 <- add_criterion(grm_den_r_seed_glmm4, "loo")

grm_den_r_seed_glmm5 <- brm(formula = meanDen_int ~ RelYear, data = grm_n_r_seed, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_r_seed_glmm5.rds")
grm_den_r_seed_glmm5 <- add_criterion(grm_den_r_seed_glmm5, "loo")

#Model 3 is the best fit, so I will use negbinomial as the family for models moving forward.
loo_compare(grm_den_r_seed_glmm2, grm_den_r_seed_glmm3, grm_den_r_seed_glmm4, grm_den_r_seed_glmm5)

grm_den_r_seed_glmm6 <- brm(formula = meanDen_int ~ RelYear + (1 | reefIDcrosswalk), data = grm_n_r_seed, family = negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_r_seed_glmm6.rds")
grm_den_r_seed_glmm6 <- add_criterion(grm_den_r_seed_glmm6, "loo")

grm_den_r_seed_glmm7 <- brm(formula = meanDen_int ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = grm_n_r_seed, family = negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_r_seed_glmm7.rds")
grm_den_r_seed_glmm7 <- add_criterion(grm_den_r_seed_glmm7, "loo")

#GLMM 7 is the best fit to the data.
loo_compare(grm_den_r_seed_glmm3, grm_den_r_seed_glmm6, grm_den_r_seed_glmm7)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
grm_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Guana River Marsh_Natural")
grm_n_r_seed[, QuadSize_m2 := as.factor(QuadSize_m2)]
grm_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
grm_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
saveRDS(grm_n_r_seed, here::here(paste0('GLMMs/AllDates/Data/grm_n_r_seed_', Sys.Date(), '.rds')))

grm_den_r_seed_glmm <- readRDS(here::here('GLMMs/AllDates/grm_den_r_seed_glmm7.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

grm_n_r_seed[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
grm_n_r_seed[, SampleDay := day(SampleDate)]


den_t <- copy(grm_n_r_seed[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(grm_n_r_seed$Month))){
  mo <- subset(grm_n_r_seed, as.numeric(grm_n_r_seed$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(grm_n_r_seed, grm_n_r_seed$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = "25-75mm", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(meanDen_int),
                       Median = median(meanDen_int),
                       Mean = round(mean(meanDen_int), digits = 2),
                       SD = round(sd(meanDen_int), digits = 2), 
                       Min. = min(meanDen_int),
                       Max. = max(meanDen_int)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "25-75mm",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(grm_sho75, grm_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(grm_n_r_seed, aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(grm_n_r_seed, aes(x = RelYear, y = QuadSize_m2, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")


```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(grm_n_r_seed, aes(x = RelYear, y = reefIDcrosswalk, color = reefIDcrosswalk)) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(grm_den_r_seed_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_GRM_PDistandMChains_r_seed <- plot(grm_den_r_seed_glmm)
Den_AllDates_GLMM_GRM_PDistandMChains_r_seed

len <- length(Den_AllDates_GLMM_GRM_PDistandMChains_r_seed)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_PDistandMChains_r_seed_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_GRM_PDistandMChains_r_seed[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_GRM_PPcheck_r_seed <- pp_check(grm_den_r_seed_glmm)
Den_AllDates_GLMM_GRM_PPcheck_r_seed

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_PPcheck_r_seed_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GRM_PPcheck_r_seed,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
set.seed(987)
grm1_r_seed <- plot(conditional_effects(grm_den_r_seed_glmm, re_formula = NULL), plot = FALSE)[[1]]
Den_AllDates_GLMM_GRM_MEPrand_r_seed <- grm1_r_seed +
  geom_jitter(data = grm_n_r_seed, aes(x = RelYear, y = meanDen_int, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = grm_n_r_seed, aes(y = -10, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13),
    legend.position = "none") +
  labs(colour = NULL)
Den_AllDates_GLMM_GRM_MEPrand_r_seed

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_MEPrand_r_seed_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GRM_MEPrand_r_seed,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
set.seed(985)
grm2_r_seed <- plot(conditional_effects(grm_den_r_seed_glmm, re_formula = NA), plot = FALSE)[[1]]
Den_AllDates_GLMM_GRM_MEPnorand_r_seed <- grm2_r_seed +
  geom_jitter(data = grm_n_r_seed, aes(x = RelYear, y = meanDen_int, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = grm_n_r_seed, aes(y = -10, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13),
    legend.position = "none") +
  labs(colour = NULL)
Den_AllDates_GLMM_GRM_MEPnorand_r_seed

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_MEPnorand_r_seed_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GRM_MEPnorand_r_seed,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"}
#Individual effects plots
Den_AllDates_GLMM_GRM_IEP_r_seed <- grm_n_r_seed %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(grm_den_r_seed_glmm) %>%
  ggplot(aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = grm_n_r_seed, size = 2) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = grm_n_r_seed, aes(y = -20, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(an_n_r_seed, an_n_r_seed$Year %in% labs2), aes(y = -300, label = Year, x = RelYear), size = 2, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  guides(color = FALSE) +
  scale_x_continuous(limits = c(-1, max(grm_n_r_seed$RelYear) + 1)) +
  scale_y_continuous(limits = c(-25, 300)) +
  coord_cartesian(ylim = c(-25, 160)) +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
Den_AllDates_GLMM_GRM_IEP_r_seed

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_IEP_r_seed_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GRM_IEP_r_seed,
       width = 10,
       height = 49,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(grm_n_r_seed, grm_den_r_seed_glmm, 
   Den_AllDates_GLMM_GRM_PDistandMChains_r_seed,
   Den_AllDates_GLMM_GRM_PPcheck_r_seed,
   Den_AllDates_GLMM_GRM_MEPrand_r_seed,
   Den_AllDates_GLMM_GRM_MEPnorand_r_seed,
   Den_AllDates_GLMM_GRM_IEP_r_seed
   )

```

<br><br><br>

##### Guana Tolomato Matanzas NERR_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

gtmn_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Guana Tolomato Matanzas NERR_Natural")
gtmn_n_r_seed[, QuadSize_m2 := as.numeric(QuadSize_m2)]
gtmn_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
gtmn_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
saveRDS(gtmn_n_r_seed, here::here(paste0('GLMMs/AllDates/Data/gtmn_n_r_seed_', Sys.Date(), '.rds')))

gtmn_den_r_seed_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + Region.y + (1 + RelYear|reefIDcrosswalk), data = gtmn_n_r_seed, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "identity"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
gtmn_den_r_seed_glmm <- add_criterion(gtmn_den_r_seed_glmm, "loo")

ggplot(gtmn_n_r_seed, aes(x = RelYear, y = meanDen, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(gtmn_n_r_seed, aes(x = RelYear, y = factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(gtmn_n_r_seed, aes(x = RelYear, y = Region.y, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

#Gaussian family
gtmn_den_r_seed_glmm1 <- brm(formula = meanDen ~ 1, data = gtmn_n_r_seed, family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm1.rds")
gtmn_den_r_seed_glmm1 <- add_criterion(gtmn_den_r_seed_glmm1, "loo")

#Poisson family
gtmn_den_r_seed_glmm1b <- brm(formula = meanDen_int ~ 1, data = gtmn_n_r_seed, family = poisson, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm1b.rds")
gtmn_den_r_seed_glmm1b <- add_criterion(gtmn_den_r_seed_glmm1b, "loo")

gtmn_den_r_seed_glmm2 <- brm(formula = meanDen ~ RelYear, data = gtmn_n_r_seed, family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm2.rds")
gtmn_den_r_seed_glmm2 <- add_criterion(gtmn_den_r_seed_glmm2, "loo")

gtmn_den_r_seed_glmm2b <- brm(formula = meanDen_int ~ RelYear, data = gtmn_n_r_seed, family = poisson, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm2b.rds")
gtmn_den_r_seed_glmm2b <- add_criterion(gtmn_den_r_seed_glmm2b, "loo")

gtmn_den_r_seed_glmm3 <- brm(formula = meanDen ~ Region.y, data = gtmn_n_r_seed, family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm3.rds")
gtmn_den_r_seed_glmm3 <- add_criterion(gtmn_den_r_seed_glmm3, "loo")

gtmn_den_r_seed_glmm3b <- brm(formula = meanDen_int ~ Region.y, data = gtmn_n_r_seed, family = poisson, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm3b.rds")
gtmn_den_r_seed_glmm3b <- add_criterion(gtmn_den_r_seed_glmm3b, "loo")

gtmn_den_r_seed_glmm4 <- brm(formula = meanDen ~ RelYear + Region.y, data = gtmn_n_r_seed, family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm4.rds")
gtmn_den_r_seed_glmm4 <- add_criterion(gtmn_den_r_seed_glmm4, "loo")

gtmn_den_r_seed_glmm4b <- brm(formula = meanDen_int ~ RelYear + Region.y, data = gtmn_n_r_seed, family = poisson, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm4b.rds")
gtmn_den_r_seed_glmm4b <- add_criterion(gtmn_den_r_seed_glmm4b, "loo")

gtmn_den_r_seed_glmm5 <- brm(formula = meanDen ~ RelYear + Region.y + (1 | reefIDcrosswalk), data = gtmn_n_r_seed, family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm5.rds")
gtmn_den_r_seed_glmm5 <- add_criterion(gtmn_den_r_seed_glmm5, "loo")

gtmn_den_r_seed_glmm5b <- brm(formula = meanDen_int ~ RelYear + Region.y + (1 | reefIDcrosswalk), data = gtmn_n_r_seed, family = poisson, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm5b.rds")
gtmn_den_r_seed_glmm5b <- add_criterion(gtmn_den_r_seed_glmm5b, "loo")

#trying a negative binomial family.
gtmn_den_r_seed_glmm5c <- brm(formula = meanDen_int ~ RelYear + Region.y + (1 | reefIDcrosswalk), data = gtmn_n_r_seed, family = negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm5c.rds")
gtmn_den_r_seed_glmm5c <- add_criterion(gtmn_den_r_seed_glmm5c, "loo")

gtmn_den_r_seed_glmm6 <- brm(formula = meanDen ~ RelYear + Region.y + (0 + RelYear | reefIDcrosswalk), data = gtmn_n_r_seed, family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm6.rds")
gtmn_den_r_seed_glmm6 <- add_criterion(gtmn_den_r_seed_glmm6, "loo")

gtmn_den_r_seed_glmm6b <- brm(formula = meanDen_int ~ RelYear + Region.y + (0 + RelYear | reefIDcrosswalk), data = gtmn_n_r_seed, family = poisson, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm6b.rds")
gtmn_den_r_seed_glmm6b <- add_criterion(gtmn_den_r_seed_glmm6b, "loo")

#trying a negative binomial family.
gtmn_den_r_seed_glmm6c <- brm(formula = meanDen_int ~ RelYear + Region.y + (0 + RelYear | reefIDcrosswalk), data = gtmn_n_r_seed, family = negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm6c.rds")
gtmn_den_r_seed_glmm6c <- add_criterion(gtmn_den_r_seed_glmm6c, "loo")

gtmn_den_r_seed_glmm7 <- brm(formula = meanDen ~ RelYear + Region.y + (1 | reefIDcrosswalk), data = gtmn_n_r_seed, family = skew_normal, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_seed_glmm7.rds")
gtmn_den_r_seed_glmm7 <- add_criterion(gtmn_den_r_seed_glmm7, "loo")

#GLMM 5c is the best fit.
loo_compare(gtmn_den_r_seed_glmm1, gtmn_den_r_seed_glmm1b, gtmn_den_r_seed_glmm2, gtmn_den_r_seed_glmm2b, gtmn_den_r_seed_glmm3, gtmn_den_r_seed_glmm3b, gtmn_den_r_seed_glmm4, gtmn_den_r_seed_glmm4b, gtmn_den_r_seed_glmm5, gtmn_den_r_seed_glmm5b, gtmn_den_r_seed_glmm5c, gtmn_den_r_seed_glmm6, gtmn_den_r_seed_glmm6b, gtmn_den_r_seed_glmm6c, gtmn_den_r_seed_glmm7)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
gtmn_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Guana Tolomato Matanzas NERR_Natural")
gtmn_n_r_seed[, QuadSize_m2 := as.numeric(QuadSize_m2)]
gtmn_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
gtmn_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
saveRDS(gtmn_n_r_seed, here::here(paste0('GLMMs/AllDates/Data/gtmn_n_r_seed_', Sys.Date(), '.rds')))

gtmn_den_r_seed_glmm <- readRDS(here::here('GLMMs/AllDates/gtmn_den_r_seed_glmm5c.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

gtmn_n_r_seed[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
gtmn_n_r_seed[, SampleDay := day(SampleDate)]


den_t <- copy(gtmn_n_r_seed[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(gtmn_n_r_seed$Month))){
  mo <- subset(gtmn_n_r_seed, as.numeric(gtmn_n_r_seed$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(gtmn_n_r_seed, gtmn_n_r_seed$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = "25-75mm", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(meanDen_int),
                       Median = median(meanDen_int),
                       Mean = round(mean(meanDen_int), digits = 2),
                       SD = round(sd(meanDen_int), digits = 2), 
                       Min. = min(meanDen_int),
                       Max. = max(meanDen_int)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "25-75mm",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(gtmn_sho75, gtmn_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(gtmn_n_r_seed, aes(x = RelYear, y = meanDen, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(gtmn_n_r_seed, aes(x = RelYear, y = factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(gtmn_n_r_seed, aes(x = RelYear, y = Region.y, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(gtmn_den_r_seed_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_GTMNERR_PDistandMChains_r_seed <- plot(gtmn_den_r_seed_glmm)
Den_AllDates_GLMM_GTMNERR_PDistandMChains_r_seed

len <- length(Den_AllDates_GLMM_GTMNERR_PDistandMChains_r_seed)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_PDistandMChains_r_seed_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_GTMNERR_PDistandMChains_r_seed[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_GTMNERR_PPcheck_r_seed <- pp_check(gtmn_den_r_seed_glmm)
Den_AllDates_GLMM_GTMNERR_PPcheck_r_seed

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_PPcheck_r_seed_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_PPcheck_r_seed,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
gtmn1_r_seed <- plot(conditional_effects(gtmn_den_r_seed_glmm, re_formula = NULL), plot = FALSE)[[1]]
Den_AllDates_GLMM_GTMNERR_MEPrand_r_seed <- gtmn1_r_seed +
  geom_jitter(data = gtmn_n_r_seed, aes(x = RelYear, y = meanDen_int, fill = Region.y), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = gtmn_n_r_seed, aes(y = 10, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(xlim = c(-0.5,6.5)) +
  labs(fill = "Region") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_AllDates_GLMM_GTMNERR_MEPrand_r_seed

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_MEPrand_r_seed_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_MEPrand_r_seed,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
meanDen_r_seed <- plot(conditional_effects(gtmn_den_r_seed_glmm, re_formula = NULL), plot = FALSE)[[2]]$data
setnames(meanDen_r_seed, "effect1__", "Region")

Den_AllDates_GLMM_GTMNERR_MEPrand_r_seed_MeanRes <- ggplot(meanDen_r_seed, aes(x = Region, y = estimate__, ymin = lower__, ymax = upper__)) +
  geom_pointinterval(fill = "black", size = 3, fatten_point = 4, shape = 21, color = "black") +
  ylab("Density_m2 (shell height 25-75mm") +
  theme_bw()  + 
  theme(axis.title = element_text(size = 13), 
        axis.text = element_text(size = 12), 
        legend.text = element_text(size = 12), 
        legend.title = element_text(size = 13))+labs(fill = NULL)
Den_AllDates_GLMM_GTMNERR_MEPrand_r_seed_MeanRes

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_MEPrand_r_seed_MeanRes_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_MEPrand_r_seed_MeanRes,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
gtmn2_r_seed <- plot(conditional_effects(gtmn_den_r_seed_glmm, re_formula = NA), plot = FALSE)[[1]]
Den_AllDates_GLMM_GTMNERR_MEPnorand_r_seed <- gtmn2_r_seed +
  geom_jitter(data = gtmn_n_r_seed, aes(x = RelYear, y = meanDen_int, fill = Region.y), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = gtmn_n_r_seed, aes(y = 10, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(xlim = c(-0.5,6.5)) +
  labs(fill = "Region") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_AllDates_GLMM_GTMNERR_MEPnorand_r_seed

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_MEPnorand_r_seed_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_MEPnorand_r_seed,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"}
#Individual effects plots
Den_AllDates_GLMM_GTMNERR_IEP_r_seed <- gtmn_n_r_seed %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(gtmn_den_r_seed_glmm) %>%
  ggplot(aes(x = RelYear, y = meanDen_int, color = Region.y)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = gtmn_n_r_seed) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = gtmn_n_r_seed, aes(y = 0, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(gtmn_n_r_seed$RelYear) + 1)) +
  scale_y_continuous(limits = c(0, 350)) +
  #theme(legend.position = "none") +
  #labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
Den_AllDates_GLMM_GTMNERR_IEP_r_seed

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_IEP_r_seed_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_IEP_r_seed,
       width = 10,
       height = 80,
       units = "in",
       dpi = 300,
       limitsize = FALSE)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(gtmn_n_r_seed, gtmn_den_r_seed_glmm, 
   Den_AllDates_GLMM_GTMNERR_PDistandMChains_r_seed,
   Den_AllDates_GLMM_GTMNERR_PPcheck_r_seed,
   Den_AllDates_GLMM_GTMNERR_MEPrand_r_seed,
   Den_AllDates_GLMM_GTMNERR_MEPnorand_r_seed,
   Den_AllDates_GLMM_GTMNERR_IEP_r_seed
   )

```

<br><br><br>

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ##### Indian River-Vero Beach to Ft. Pierce {.tabset .tabset-fade .tabset-pills}
# 
# irvbfp_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural")
# irvbfp_n_r_seed[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# irvbfp_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# irvbfp_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(irvbfp_n_r_seed, here::here(paste0('GLMMs/AllDates/Data/irvbfp_n_r_seed_', Sys.Date(), '.rds')))
# 
# irvbfp_den_r_seed_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = irvbfp_n_r_seed, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# irvbfp_den_r_seed_glmm <- add_criterion(irvbfp_den_r_seed_glmm, "loo")
# 
# 
# #TEST LME, BASED ON MODEL KML USED FOR SAV BB DATA
# #Using untransformed shell heights, the residuals were not normal (SEP3-distributed), so tried again with log-transformed sH
# irvbfp_n_r_seed[, logSH := log(meanCount)]
# 
# #Let's try a mixed effects model to look for a trend.
# #First row: Model BB over year
# #Second row: vary slope and intercept of Year by ProgramLocationID
# #Third row: omit NA's
# #Fourth row: get the data from this dataset
# ctrl <- lmeControl(opt='optim')
# modelirvbfp_n_r_seed <- lme(meanCount ~ RelYear,
#                          random = ~ RelYear | reefIDcrosswalk,
#                          #na.action = na.omit,
#                          control = ctrl,
#                          data = irvbfp_n_r_seed)
# 
# #plot histogram of residuals to check for normality
# hist(resid(modelirvbfp_n_r_seed))
# fitDist(resid(modelirvbfp_n_r_seed))
# histDist(resid(modelirvbfp_n_r_seed), family = "NO")
# #plot residuals
# plot(modelirvbfp_n_r_seed)
# 
# #print coefficients. Estimate tells you the trend, eg here, for every year you expect a .01%
# #decrease. P-value shows (if) it is significant
# piecewiseSEM::coefs(modelirvbfp_n_r_seed)
# irvbfp_sho25_coefs<-piecewiseSEM::coefs(modelirvbfp_n_r_seed)
# piecewiseSEM::rsquared(modelirvbfp_n_r_seed)
# 
# #plot the actual model to visualize what the Estimate and p-value told you
# library(effects)
# plot(effect("RelYear", modelirvbfp_n_r_seed))
# 
# 
# saveRDS(irvbfp_den_r_seed_glmm, here::here('GLMMs/AllDates/irvbfp_den_r_seed_glmm.rds'))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# irvbfp_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural")
# irvbfp_n_r_seed[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# irvbfp_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# irvbfp_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(irvbfp_n_r_seed, here::here(paste0('GLMMs/AllDates/Data/irvbfp_n_r_seed_', Sys.Date(), '.rds')))
# 
# irvbfp_den_r_seed_glmm <- readRDS(here::here('GLMMs/AllDates/irvbfp_den_r_seed_glmm.rds'))

```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Model Output
# 
# summary(irvbfp_den_r_seed_glmm)
#
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Diagnostic Plots
# 
# #Posterior distributions and Markov chains:
#   
# Den_AllDates_GLMM_IRVBFP_PDistandMChains_r_seed <- plot(irvbfp_den_r_seed_glmm)
# Den_AllDates_GLMM_IRVBFP_PDistandMChains_r_seed
# 
# len <- length(Den_AllDates_GLMM_IRVBFP_PDistandMChains_r_seed)
# for(i in 1:len){
#   jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_IRVBFP_PDistandMChains_r_seed_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
#   print(Den_AllDates_GLMM_IRVBFP_PDistandMChains_r_seed[i])
#   dev.off()
# }
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Posterior predictive check plot:
# 
# Den_AllDates_GLMM_IRVBFP_PPcheck_r_seed <- pp_check(irvbfp_den_r_seed_glmm)
# Den_AllDates_GLMM_IRVBFP_PPcheck_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_IRVBFP_PPcheck_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_IRVBFP_PPcheck_r_seed,
#        width = 4,
#        height = 3,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Marginal Effects Plots
# 
# #Including the random effect of reef (i.e., managed area-wide credible interval):
# 
# #Marginal effects plot including random effects
# irvbfp1_r_seed <- plot(conditional_effects(irvbfp_den_r_seed_glmm, re_formula = NULL), plot = FALSE)[[1]]
# Den_AllDates_GLMM_IRVBFP_MEPrand_r_seed <- irvbfp1_r_seed +
#   geom_point(data = irvbfp_n_r_seed, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_IRVBFP_MEPrand_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_IRVBFP_MEPrand_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_IRVBFP_MEPrand_r_seed,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Excluding the random effect of reef (i.e., sampled population credible interval):
# 
# #Marginal effects plot excluding random effects
# irvbfp2_r_seed <- plot(conditional_effects(irvbfp_den_r_seed_glmm, re_formula = NA), plot = FALSE)[[1]]
# Den_AllDates_GLMM_IRVBFP_MEPnorand_r_seed <- irvbfp2_r_seed +
#   geom_point(data = irvbfp_n_r_seed, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_IRVBFP_MEPnorand_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_IRVBFP_MEPnorand_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_IRVBFP_MEPnorand_r_seed,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Individual effects plots:
# 
# #Individual effects plots
# Den_AllDates_GLMM_IRVBFP_IEP_r_seed <- irvbfp_n_r_seed %>%
#   group_by(reefIDcrosswalk) %>%
#   add_fitted_draws(irvbfp_den_r_seed_glmm) %>%
#   ggplot(aes(x = RelYear, y = meanCount, color = reefIDcrosswalk)) +
#   stat_lineribbon(aes(y = .value), size = 1) +
#   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
#   geom_point(data = irvbfp_n_r_seed) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
#   #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
#   scale_fill_brewer(palette = "Greys") +
#   scale_color_brewer(palette = "Set2") +
#   theme_bw() +
#   facet_wrap(~ reefIDcrosswalk)
# Den_AllDates_GLMM_IRVBFP_IEP_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_IRVBFP_IEP_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_IRVBFP_IEP_r_seed,
#        width = 10,
#        height = 5,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# # Remove created objects to save memory.
# rm(irvbfp_n_r_seed, irvbfp_den_r_seed_glmm, 
#    Den_AllDates_GLMM_IRVBFP_PDistandMChains_r_seed,
#    Den_AllDates_GLMM_IRVBFP_PPcheck_r_seed,
#    Den_AllDates_GLMM_IRVBFP_MEPrand_r_seed,
#    Den_AllDates_GLMM_IRVBFP_MEPnorand_r_seed,
#    Den_AllDates_GLMM_IRVBFP_IEP_r_seed
#    )
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ##### Lemon Bay {.tabset .tabset-fade .tabset-pills}
# 
# lb_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Lemon Bay_Natural")
# lb_n_r_seed[, QuadSize_m2 := as.factor(QuadSize_m2)]
# lb_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# lb_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(lb_n_r_seed, here::here(paste0('GLMMs/AllDates/Data/lb_n_r_seed_', Sys.Date(), '.rds')))
# 
# lb_den_r_seed_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = lb_n_r_seed, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# lb_den_r_seed_glmm <- add_criterion(lb_den_r_seed_glmm, "loo")
# 
# lb_den_r_seed_glmm9_yro <- brm(formula = meanCount | se(sdCount) ~ RelYear + QuadSize_m2 + (0 + RelYear|QuadIdentifier/reefIDcrosswalk), data = lb_n_r_seed, family = student, cores = 4, prior = c(set_prior("normal(0,1000)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 2000, warmup = 1000, chains = 4, inits = 0, thin = 3)
# 
# #TEST LME, BASED ON MODEL KML USED FOR SAV BB DATA
# #Using untransformed shell heights, the residuals were not normal (SEP3-distributed), so tried again with log-transformed sH
# lb_n_r_seed[, logSH := log(meanCount)]
# 
# #Let's try a mixed effects model to look for a trend.
# #First row: Model BB over year
# #Second row: vary slope and intercept of Year by ProgramLocationID
# #Third row: omit NA's
# #Fourth row: get the data from this dataset
# ctrl <- lmeControl(opt='optim')
# modellb_n_r_seed <- lme(meanDen ~ RelYear,
#                          random = ~ RelYear | reefIDcrosswalk,
#                          #na.action = na.omit,
#                          control = ctrl,
#                          data = lb_n_r_seed)
# 
# #plot histogram of residuals to check for normality
# hist(resid(modellb_n_r_seed))
# fitDist(resid(modellb_n_r_seed))
# histDist(resid(modellb_n_r_seed), family = "NO")
# #plot residuals
# plot(modellb_n_r_seed)
# 
# #print coefficients. Estimate tells you the trend, eg here, for every year you expect a .01%
# #decrease. P-value shows (if) it is significant
# piecewiseSEM::coefs(modellb_n_r_seed)
# lb_sho25_coefs<-piecewiseSEM::coefs(modellb_n_r_seed)
# piecewiseSEM::rsquared(modellb_n_r_seed)
# 
# #plot the actual model to visualize what the Estimate and p-value told you
# library(effects)
# plot(effect("RelYear", modellb_n_r_seed))
# 
# 
# saveRDS(lb_den_r_seed_glmm, here::here('GLMMs/AllDates/lb_den_r_seed_glmm.rds'))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# lb_n_r_seed <- subset(oysterraw_den_r_seed_den, oysterraw_den_r_seed_den$MA_plotlab == "Lemon Bay_Natural")
# lb_n_r_seed[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# lb_n_r_seed[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# lb_n_r_seed[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(lb_n_r_seed, here::here(paste0('GLMMs/AllDates/Data/lb_n_r_seed_', Sys.Date(), '.rds')))
# 
# lb_den_r_seed_glmm <- readRDS(here::here('GLMMs/AllDates/lb_den_r_seed_glmm.rds'))

```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Model Output
# summary(lb_den_r_seed_glmm)
# 
# <br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Diagnostic Plots
# 
# #Posterior distributions and Markov chains:
#   
# Den_AllDates_GLMM_LB_PDistandMChains_r_seed <- plot(lb_den_r_seed_glmm)
# Den_AllDates_GLMM_LB_PDistandMChains_r_seed
# 
# len <- length(Den_AllDates_GLMM_LB_PDistandMChains_r_seed)
# for(i in 1:len){
#   jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_PDistandMChains_r_seed_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
#   print(Den_AllDates_GLMM_LB_PDistandMChains_r_seed[i])
#   dev.off()
# }
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Posterior predictive check plot:
# 
# Den_AllDates_GLMM_LB_PPcheck_r_seed <- pp_check(lb_den_r_seed_glmm)
# Den_AllDates_GLMM_LB_PPcheck_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_PPcheck_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_LB_PPcheck_r_seed,
#        width = 4,
#        height = 3,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Marginal Effects Plots
# 
# #Including the random effect of reef (i.e., managed area-wide credible interval):
# 
# #Marginal effects plot including random effects
# lb1_r_seed <- plot(conditional_effects(lb_den_r_seed_glmm9_yro, re_formula = NULL), plot = FALSE)[[1]]
# Den_AllDates_GLMM_LB_MEPrand_r_seed <- lb1_r_seed +
# #  geom_point(data = lb_n_r_seed, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   geom_pointrange(data = lb_n_r_seed, aes(x = RelYear, y = meanCount, ymin = (meanCount - sdCount), ymax = (meanCount + sdCount), fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_LB_MEPrand_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_MEPrand_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_LB_MEPrand_r_seed,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Excluding the random effect of reef (i.e., sampled population credible interval):
#   
# #Marginal effects plot excluding random effects
# lb2_r_seed <- plot(conditional_effects(lb_den_r_seed_glmm, re_formula = NA), plot = FALSE)[[1]]
# Den_AllDates_GLMM_LB_MEPnorand_r_seed <- lb2_r_seed +
#   geom_point(data = lb_n_r_seed, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_LB_MEPnorand_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_MEPnorand_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_LB_MEPnorand_r_seed,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Individual effects plots:
# 
# #Individual effects plots
# Den_AllDates_GLMM_LB_IEP_r_seed <- lb_n_r_seed %>%
#   group_by(reefIDcrosswalk) %>%
#   add_fitted_draws(lb_den_r_seed_glmm) %>%
#   ggplot(aes(x = RelYear, y = meanCount, color = reefIDcrosswalk)) +
#   stat_lineribbon(aes(y = .value), size = 1) +
#   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
#   geom_point(data = lb_n_r_seed) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
#   #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
#   scale_fill_brewer(palette = "Greys") +
#   scale_color_brewer(palette = "Set2") +
#   theme_bw() +
#   facet_wrap(~ reefIDcrosswalk)
# Den_AllDates_GLMM_LB_IEP_r_seed
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_IEP_r_seed_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_LB_IEP_r_seed,
#        width = 10,
#        height = 5,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# # Remove created objects to save memory.
# rm(lb_n_r_seed, lb_den_r_seed_glmm, 
#    Den_AllDates_GLMM_LB_PDistandMChains_r_seed,
#    Den_AllDates_GLMM_LB_PPcheck_r_seed,
#    Den_AllDates_GLMM_LB_MEPrand_r_seed,
#    Den_AllDates_GLMM_LB_MEPnorand_r_seed,
#    Den_AllDates_GLMM_LB_IEP_r_seed
#    )
# 
# #<br><br><br>
```

#### Only >75mm shell height {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #only 4 years of data.
# ##### Apalachicola Bay_Natural {.tabset .tabset-fade .tabset-pills}
# 
# ab_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Apalachicola Bay_Natural")
# ab_n_r_market[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# ab_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# ab_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(ab_n_r_market, here::here(paste0('GLMMs/AllDates/Data/ab_n_r_market_', Sys.Date(), '.rds')))
# 
# ab_den_r_market_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + Subtidal + (1 + RelYear|reefIDcrosswalk), data = ab_n_r_market, family = hurdle_lognormal(link = "identity", link_sigma = "log", link_hu = "logit"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# ab_den_r_market_glmm <- add_criterion(ab_den_r_market_glmm, "loo")
# 
# saveRDS(ab_den_r_market_glmm, here::here('GLMMs/AllDates/ab_den_r_market_glmm.rds'))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# ab_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Apalachicola Bay_Natural")
# ab_n_r_market[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# ab_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# ab_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(ab_n_r_market, here::here(paste0('GLMMs/AllDates/Data/ab_n_r_market_', Sys.Date(), '.rds')))
# 
# ab_den_r_market_glmm <- readRDS(here::here('GLMMs/AllDates/ab_den_r_market_glmm.rds'))

```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Model Output
# 
# summary(ab_den_r_market_glmm)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Diagnostic Plots
# 
# #Posterior distributions and Markov chains:
# 
# Den_AllDates_GLMM_AB_PDistandMChains_r_market <- plot(ab_den_r_market_glmm)
# Den_AllDates_GLMM_AB_PDistandMChains_r_market
# 
# len <- length(Den_AllDates_GLMM_AB_PDistandMChains_r_market)
# for(i in 1:len){
#   jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_PDistandMChains_r_market_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
#   print(Den_AllDates_GLMM_AB_PDistandMChains_r_market[i])
#   dev.off()
# }
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Posterior predictive check plot:
#   
# Den_AllDates_GLMM_AB_PPcheck_r_market <- pp_check(ab_den_r_market_glmm)
# Den_AllDates_GLMM_AB_PPcheck_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_PPcheck_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_AB_PPcheck_r_market,
#        width = 4,
#        height = 3,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Marginal Effects Plots
# 
# #Including the random effect of reef (i.e., managed area-wide credible interval):
#   
# #Marginal effects plot including random effects
# ab1_r_market <- plot(conditional_effects(ab_den_r_market_glmm, re_formula = NULL), plot = FALSE)[[1]]
# Den_AllDates_GLMM_AB_MEPrand_r_market <- ab1_r_market +
#   geom_point(data = ab_n_r_market, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_AB_MEPrand_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_MEPrand_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_AB_MEPrand_r_market,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Excluding the random effect of reef (i.e., sampled population credible interval):
# 
# #Marginal effects plot excluding random effects
# ab2_r_market <- plot(conditional_effects(ab_den_r_market_glmm, re_formula = NA), plot = FALSE)[[1]]
# Den_AllDates_GLMM_AB_MEPnorand_r_market <- ab2_r_market +
#   geom_point(data = ab_n_r_market, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_AB_MEPnorand_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_MEPnorand_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_AB_MEPnorand_r_market,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>

```

```{r eval=FALSE, fig.height=50, fig.width=10, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Individual effects plots:
# 
# #Individual effects plots
# Den_AllDates_GLMM_AB_IEP_r_market <- ab_n_r_market %>%
#   group_by(reefIDcrosswalk) %>%
#   add_fitted_draws(ab_den_r_market_glmm) %>%
#   ggplot(aes(x = RelYear, y = meanCount, color = reefIDcrosswalk)) +
#   stat_lineribbon(aes(y = .value), size = 1) +
#   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
#   geom_point(data = ab_n_r_market) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
#   #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
#   scale_fill_brewer(palette = "Greys") +
#   #scale_color_brewer(palette = "Set2") +
#   theme_bw() +
#   facet_wrap(~ reefIDcrosswalk, ncol = 3)
# Den_AllDates_GLMM_AB_IEP_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AB_IEP_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_AB_IEP_r_market,
#        width = 10,
#        height = 20,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# # Remove created objects to save memory.
# rm(ab_n_r_market, ab_den_r_market_glmm, 
#    Den_AllDates_GLMM_AB_PDistandMChains_r_market,
#    Den_AllDates_GLMM_AB_PPcheck_r_market,
#    Den_AllDates_GLMM_AB_MEPrand_r_market,
#    Den_AllDates_GLMM_AB_MEPnorand_r_market,
#    Den_AllDates_GLMM_AB_IEP_r_market
#    )
# 
# <br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ##### Apalachicola NERR_Natural {.tabset .tabset-fade .tabset-pills}
# 
# an_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Apalachicola NERR_Natural")
# an_n_r_market[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# an_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# an_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(an_n_r_market, here::here(paste0('GLMMs/AllDates/Data/an_n_r_market_', Sys.Date(), '.rds')))
# 
# an_den_r_market_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + Subtidal + (1 + RelYear|reefIDcrosswalk), data = an_n_r_market, family = hurdle_gamma(link = "log", link_shape = "log", link_hu = "logit"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# an_den_r_market_glmm <- add_criterion(an_den_r_market_glmm, "loo")
# 
# saveRDS(an_den_r_market_glmm, here::here('GLMMs/AllDates/an_den_r_market_glmm.rds'))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# an_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Apalachicola NERR_Natural")
# an_n_r_market[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# an_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# an_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(an_n_r_market, here::here(paste0('GLMMs/AllDates/Data/an_n_r_market_', Sys.Date(), '.rds')))
# 
# an_den_r_market_glmm <- readRDS(here::here('GLMMs/AllDates/an_den_r_market_glmm.rds'))

```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Model Output
# 
# summary(an_den_r_market_glmm)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Diagnostic Plots
# 
# #Posterior distributions and Markov chains:
#   
# Den_AllDates_GLMM_AN_PDistandMChains_r_market <- plot(an_den_r_market_glmm)
# Den_AllDates_GLMM_AN_PDistandMChains_r_market
# 
# len <- length(Den_AllDates_GLMM_AN_PDistandMChains_r_market)
# for(i in 1:len){
#   jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_PDistandMChains_r_market_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
#   print(Den_AllDates_GLMM_AN_PDistandMChains_r_market[i])
#   dev.off()
# }
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Posterior predictive check plot:
# 
# Den_AllDates_GLMM_AN_PPcheck_r_market <- pp_check(an_den_r_market_glmm)
# Den_AllDates_GLMM_AN_PPcheck_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_PPcheck_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_AN_PPcheck_r_market,
#        width = 4,
#        height = 3,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Marginal Effects Plots
# 
# #Including the random effect of reef (i.e., managed area-wide credible interval):
# 
# #Marginal effects plot including random effects
# an1_r_market <- plot(conditional_effects(an_den_r_market_glmm, re_formula = NULL), plot = FALSE)[[1]]
# Den_AllDates_GLMM_AN_MEPrand_r_market <- an1_r_market +
#   geom_point(data = an_n_r_market, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_AN_MEPrand_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_MEPrand_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_AN_MEPrand_r_market,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Excluding the random effect of reef (i.e., sampled population credible interval):
# 
# #Marginal effects plot excluding random effects
# an2_r_market <- plot(conditional_effects(an_den_r_market_glmm, re_formula = NA), plot = FALSE)[[1]]
# Den_AllDates_GLMM_AN_MEPnorand_r_market <- an2_r_market +
#   geom_point(data = an_n_r_market, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_AN_MEPnorand_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_MEPnorand_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_AN_MEPnorand_r_market,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>
```

```{r eval=FALSE, fig.height=80, fig.width=10, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Individual effects plots:
# 
# #Individual effects plots
# Den_AllDates_GLMM_AN_IEP_r_market <- an_n_r_market %>%
#   group_by(reefIDcrosswalk) %>%
#   add_fitted_draws(an_den_r_market_glmm) %>%
#   ggplot(aes(x = RelYear, y = meanCount, color = reefIDcrosswalk)) +
#   stat_lineribbon(aes(y = .value), size = 1) +
#   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
#   geom_point(data = an_n_r_market) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
#   #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
#   scale_fill_brewer(palette = "Greys") +
#   #scale_color_brewer(palette = "Set2") +
#   theme_bw() +
#   facet_wrap(~ reefIDcrosswalk, ncol = 3)
# Den_AllDates_GLMM_AN_IEP_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_AN_IEP_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_AN_IEP_r_market,
#        width = 10,
#        height = 20,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# # Remove created objects to save memory.
# rm(an_n_r_market, an_den_r_market_glmm, 
#    Den_AllDates_GLMM_AN_PDistandMChains_r_market,
#    Den_AllDates_GLMM_AN_PPcheck_r_market,
#    Den_AllDates_GLMM_AN_MEPrand_r_market,
#    Den_AllDates_GLMM_AN_MEPnorand_r_market,
#    Den_AllDates_GLMM_AN_IEP_r_market
#    )
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ##### Big Bend Seagrasses_Natural {.tabset .tabset-fade .tabset-pills}
# 
# bbs_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Big Bend Seagrasses_Natural")
# bbs_n_r_market[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# bbs_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# bbs_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(bbs_n_r_market, here::here(paste0('GLMMs/AllDates/Data/bbs_n_r_market_', Sys.Date(), '.rds')))
# 
# bbs_den_r_market_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = bbs_n_r_market, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# bbs_den_r_market_glmm <- add_criterion(bbs_den_r_market_glmm, "loo")
# 
# saveRDS(bbs_den_r_market_glmm, here::here('GLMMs/AllDates/bbs_den_r_market_glmm.rds'))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# bbs_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Big Bend Seagrasses_Natural")
# bbs_n_r_market[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# bbs_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# bbs_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(bbs_n_r_market, here::here(paste0('GLMMs/AllDates/Data/bbs_n_r_market_', Sys.Date(), '.rds')))
# 
# bbs_den_r_market_glmm <- readRDS(here::here('GLMMs/AllDates/bbs_den_r_market_glmm.rds'))

```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Model Output
# 
# summary(bbs_den_r_market_glmm)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Diagnostic Plots
# 
# #Posterior distributions and Markov chains:
# 
# Den_AllDates_GLMM_BBS_PDistandMChains_r_market <- plot(bbs_den_r_market_glmm)
# Den_AllDates_GLMM_BBS_PDistandMChains_r_market
# 
# len <- length(Den_AllDates_GLMM_BBS_PDistandMChains_r_market)
# for(i in 1:len){
#   jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_BBS_PDistandMChains_r_market_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
#   print(Den_AllDates_GLMM_BBS_PDistandMChains_r_market[i])
#   dev.off()
# }
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Posterior predictive check plot:
# 
# Den_AllDates_GLMM_BBS_PPcheck_r_market <- pp_check(bbs_den_r_market_glmm)
# Den_AllDates_GLMM_BBS_PPcheck_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_BBS_PPcheck_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_BBS_PPcheck_r_market,
#        width = 4,
#        height = 3,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Marginal Effects Plots
# 
# #Including the random effect of reef (i.e., managed area-wide credible interval):
# 
# #Marginal effects plot including random effects
# bbs1_r_market <- plot(conditional_effects(bbs_den_r_market_glmm, re_formula = NULL), plot = FALSE)[[1]]
# Den_AllDates_GLMM_BBS_MEPrand_r_market <- bbs1_r_market +
#   geom_point(data = bbs_n_r_market, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_BBS_MEPrand_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_BBS_MEPrand_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_BBS_MEPrand_r_market,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Excluding the random effect of reef (i.e., sampled population credible interval):
# 
# #Marginal effects plot excluding random effects
# bbs2_r_market <- plot(conditional_effects(bbs_den_r_market_glmm, re_formula = NA), plot = FALSE)[[1]]
# Den_AllDates_GLMM_BBS_MEPnorand_r_market <- bbs2_r_market +
#   geom_point(data = bbs_n_r_market, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_BBS_MEPnorand_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_BBS_MEPnorand_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_BBS_MEPnorand_r_market,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>
```

```{r eval=FALSE, fig.height=80, fig.width=10, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Individual effects plots:
# 
# #Individual effects plots
# Den_AllDates_GLMM_BBS_IEP_r_market <- bbs_n_r_market %>%
#   group_by(reefIDcrosswalk) %>%
#   add_fitted_draws(bbs_den_r_market_glmm) %>%
#   ggplot(aes(x = RelYear, y = meanCount, color = reefIDcrosswalk)) +
#   stat_lineribbon(aes(y = .value), size = 1) +
#   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
#   geom_point(data = bbs_n_r_market) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
#   #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
#   scale_fill_brewer(palette = "Greys") +
#   #scale_color_brewer(palette = "Set2") +
#   theme_bw() +
#   facet_wrap(~ reefIDcrosswalk, ncol = 3)
# Den_AllDates_GLMM_BBS_IEP_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_BBS_IEP_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_BBS_IEP_r_market,
#        width = 10,
#        height = 5,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# # Remove created objects to save memory.
# rm(bbs_n_r_market, bbs_den_r_market_glmm, 
#    Den_AllDates_GLMM_BBS_PDistandMChains_r_market,
#    Den_AllDates_GLMM_BBS_PPcheck_r_market,
#    Den_AllDates_GLMM_BBS_MEPrand_r_market,
#    Den_AllDates_GLMM_BBS_MEPnorand_r_market,
#    Den_AllDates_GLMM_BBS_IEP_r_market
#    )
# 
# #<br><br><br>
```

##### Estero Bay_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

eb_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Estero Bay_Natural")
eb_n_r_market[, QuadSize_m2 := as.factor(QuadSize_m2)]
eb_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
eb_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
saveRDS(eb_n_r_market, here::here(paste0('GLMMs/AllDates/Data/eb_n_r_market_', Sys.Date(), '.rds')))

eb_den_r_market_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = eb_n_r_market, family = hurdle_lognormal(link = "identity", link_sigma = "log", link_hu = "logit"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
eb_den_r_market_glmm <- add_criterion(eb_den_r_market_glmm, "loo")

ggplot(eb_n_r_market, aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(eb_n_r_market, aes(x = RelYear, y = QuadSize_m2, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(eb_n_r_market, aes(x = RelYear, y = reefIDcrosswalk, color = ProgramID)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

#Converged, intercept significant.
eb_den_r_market_glmm1 <- brm(formula = meanDen_int ~ 1, data = eb_n_r_market, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_market_glmm1.rds")
eb_den_r_market_glmm1 <- add_criterion(eb_den_r_market_glmm1, "loo")

eb_den_r_market_glmm2 <- brm(formula = meanDen_int ~ RelYear, data = eb_n_r_market, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_market_glmm2.rds")
eb_den_r_market_glmm2 <- add_criterion(eb_den_r_market_glmm2, "loo")

eb_den_r_market_glmm3 <- brm(formula = meanDen_int ~ RelYear, data = eb_n_r_market, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_market_glmm3.rds")
eb_den_r_market_glmm3 <- add_criterion(eb_den_r_market_glmm3, "loo")

eb_den_r_market_glmm4 <- brm(formula = meanDen_int ~ RelYear, data = eb_n_r_market, family = zero_inflated_poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_market_glmm4.rds")
eb_den_r_market_glmm4 <- add_criterion(eb_den_r_market_glmm4, "loo")

eb_den_r_market_glmm5 <- brm(formula = meanDen_int ~ RelYear, data = eb_n_r_market, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_market_glmm5.rds")
eb_den_r_market_glmm5 <- add_criterion(eb_den_r_market_glmm5, "loo")

#Model 5 is the best fit, so I will use zero_inflated_negbinomial as the family for the rest of the models moving forward.
loo_compare(eb_den_r_market_glmm1, eb_den_r_market_glmm2, eb_den_r_market_glmm3, eb_den_r_market_glmm4, eb_den_r_market_glmm5)

#QuadSize_m2 is significant as well.
eb_den_r_market_glmm6 <- brm(formula = meanDen_int ~ QuadSize_m2, data = eb_n_r_market, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_market_glmm6.rds")
eb_den_r_market_glmm6 <- add_criterion(eb_den_r_market_glmm6, "loo")

eb_den_r_market_glmm7 <- brm(formula = meanDen_int ~ RelYear + QuadSize_m2, data = eb_n_r_market, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_market_glmm7.rds")
eb_den_r_market_glmm7 <- add_criterion(eb_den_r_market_glmm7, "loo")

eb_den_r_market_glmm8 <- brm(formula = meanDen_int ~ RelYear + QuadSize_m2 + (1 | reefIDcrosswalk), data = eb_n_r_market, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_market_glmm8.rds")
eb_den_r_market_glmm8 <- add_criterion(eb_den_r_market_glmm8, "loo")

eb_den_r_market_glmm9 <- brm(formula = meanDen_int ~ RelYear + QuadSize_m2 + (0 + RelYear | reefIDcrosswalk), data = eb_n_r_market, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_market_glmm9.rds")
eb_den_r_market_glmm9 <- add_criterion(eb_den_r_market_glmm9, "loo")

eb_den_r_market_glmm10 <- brm(formula = meanDen_int ~ RelYear + (1 | reefIDcrosswalk), data = eb_n_r_market, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_market_glmm10.rds")
eb_den_r_market_glmm10 <- add_criterion(eb_den_r_market_glmm10, "loo")

eb_den_r_market_glmm11 <- brm(formula = meanDen_int ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = eb_n_r_market, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/eb_den_r_market_glmm11.rds")
eb_den_r_market_glmm11 <- add_criterion(eb_den_r_market_glmm11, "loo")

#GLMM8 is the best fit.
loo_compare(eb_den_r_market_glmm6, eb_den_r_market_glmm7, eb_den_r_market_glmm8, eb_den_r_market_glmm9, eb_den_r_market_glmm10, eb_den_r_market_glmm11)


```

```{r message=FALSE, warning=FALSE, include=FALSE}
eb_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Estero Bay_Natural")
eb_n_r_market[, QuadSize_m2 := as.factor(QuadSize_m2)]
eb_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
eb_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
saveRDS(eb_n_r_market, here::here(paste0('GLMMs/AllDates/Data/eb_n_r_market_', Sys.Date(), '.rds')))

eb_den_r_market_glmm <- readRDS(here::here('GLMMs/AllDates/eb_den_r_market_glmm8.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

eb_n_r_market[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
eb_n_r_market[, SampleDay := day(SampleDate)]


den_t <- copy(eb_n_r_market[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(eb_n_r_market$Month))){
  mo <- subset(eb_n_r_market, as.numeric(eb_n_r_market$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(eb_n_r_market, eb_n_r_market$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = ">75mm", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(meanDen_int),
                       Median = median(meanDen_int),
                       Mean = round(mean(meanDen_int), digits = 2),
                       SD = round(sd(meanDen_int), digits = 2), 
                       Min. = min(meanDen_int),
                       Max. = max(meanDen_int)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = ">75mm",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(eb_sho75, eb_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(eb_n_r_market, aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(eb_n_r_market, aes(x = RelYear, y = QuadSize_m2, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(eb_n_r_market, aes(x = RelYear, y = reefIDcrosswalk, color = ProgramID)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(eb_den_r_market_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_EB_PDistandMChains_r_market <- plot(eb_den_r_market_glmm)
Den_AllDates_GLMM_EB_PDistandMChains_r_market

len <- length(Den_AllDates_GLMM_EB_PDistandMChains_r_market)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_PDistandMChains_r_market_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_EB_PDistandMChains_r_market[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_EB_PPcheck_r_market <- pp_check(eb_den_r_market_glmm)
Den_AllDates_GLMM_EB_PPcheck_r_market

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_PPcheck_r_market_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_EB_PPcheck_r_market,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
set.seed(987)
eb1_r_market <- plot(conditional_effects(eb_den_r_market_glmm, re_formula = NULL), plot = FALSE)[[1]]
Den_AllDates_GLMM_EB_MEPrand_r_market <- eb1_r_market +
  geom_jitter(data = eb_n_r_market, aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk, shape = as.factor(QuadSize_m2)), alpha = 0.5, size = 3, width = 0.05, inherit.aes = FALSE) +
  geom_text(data = eb_n_r_market, aes(y = -10, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(color = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) #,
    #legend.position = "none")
Den_AllDates_GLMM_EB_MEPrand_r_market

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_MEPrand_r_market_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_EB_MEPrand_r_market,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
set.seed(986)
eb2_r_market <- plot(conditional_effects(eb_den_r_market_glmm, re_formula = NA), plot = FALSE)[[1]]
Den_AllDates_GLMM_EB_MEPnorand_r_market <- eb2_r_market +
  geom_jitter(data = eb_n_r_market, aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk, shape = as.factor(QuadSize_m2)), alpha = 0.5, size = 3, width = 0.05, inherit.aes = FALSE) +
  geom_text(data = eb_n_r_market, aes(y = -10, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(color = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) #,
    #legend.position = "none")
Den_AllDates_GLMM_EB_MEPnorand_r_market

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_MEPnorand_r_market_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_EB_MEPnorand_r_market,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"}
#Individual effects plots
Den_AllDates_GLMM_EB_IEP_r_market <- eb_n_r_market %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(eb_den_r_market_glmm) %>%
  ggplot(aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = eb_n_r_market, size = 2) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = eb_n_r_market, aes(y = -11, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(an_n_r_market, an_n_r_market$Year %in% labs2), aes(y = -300, label = Year, x = RelYear), size = 2, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  guides(color = FALSE) +
  scale_x_continuous(limits = c(-1, max(eb_n_r_market$RelYear) + 1)) +
  scale_y_continuous(limits = c(-15, 300)) +
  coord_cartesian(ylim = c(-15, 40)) +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
Den_AllDates_GLMM_EB_IEP_r_market

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_EB_IEP_r_market_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_EB_IEP_r_market,
       width = 10,
       height = 30,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(eb_n_r_market, eb_den_r_market_glmm, 
   Den_AllDates_GLMM_EB_PDistandMChains_r_market,
   Den_AllDates_GLMM_EB_PPcheck_r_market,
   Den_AllDates_GLMM_EB_MEPrand_r_market,
   Den_AllDates_GLMM_EB_MEPnorand_r_market,
   Den_AllDates_GLMM_EB_IEP_r_market
   )

```

<br><br><br>

##### Guana River Marsh_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

grm_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Guana River Marsh_Natural")
grm_n_r_market[, QuadSize_m2 := as.factor(QuadSize_m2)]
grm_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
grm_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
saveRDS(grm_n_r_market, here::here(paste0('GLMMs/AllDates/Data/grm_n_r_market_', Sys.Date(), '.rds')))

grm_den_r_market_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = grm_n_r_market, family = hurdle_lognormal(link = "identity", link_sigma = "log", link_hu = "logit"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
grm_den_r_market_glmm <- add_criterion(grm_den_r_market_glmm, "loo")

ggplot(grm_n_r_market, aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(grm_n_r_market, aes(x = RelYear, y = QuadSize_m2, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(grm_n_r_market, aes(x = RelYear, y = reefIDcrosswalk, color = factor(ProgramID))) +
  geom_point() +
  theme_bw()

#Converged, intercept significant.
grm_den_r_market_glmm1 <- brm(formula = meanDen_int ~ 1, data = grm_n_r_market, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_r_market_glmm1.rds")
grm_den_r_market_glmm1 <- add_criterion(grm_den_r_market_glmm1, "loo")

grm_den_r_market_glmm2 <- brm(formula = meanDen_int ~ RelYear, data = grm_n_r_market, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_r_market_glmm2.rds")
grm_den_r_market_glmm2 <- add_criterion(grm_den_r_market_glmm2, "loo")

grm_den_r_market_glmm3 <- brm(formula = meanDen_int ~ RelYear, data = grm_n_r_market, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_r_market_glmm3.rds")
grm_den_r_market_glmm3 <- add_criterion(grm_den_r_market_glmm3, "loo")

grm_den_r_market_glmm4 <- brm(formula = meanDen_int ~ RelYear, data = grm_n_r_market, family = zero_inflated_poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_r_market_glmm4.rds")
grm_den_r_market_glmm4 <- add_criterion(grm_den_r_market_glmm4, "loo")

grm_den_r_market_glmm5 <- brm(formula = meanDen_int ~ RelYear, data = grm_n_r_market, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_r_market_glmm5.rds")
grm_den_r_market_glmm5 <- add_criterion(grm_den_r_market_glmm5, "loo")

#Model 5 is the best fit, so I will use zero_inflated_negbinomial as the family for the rest of the models moving forward.
loo_compare(grm_den_r_market_glmm1, grm_den_r_market_glmm2, grm_den_r_market_glmm3, grm_den_r_market_glmm4, grm_den_r_market_glmm5)

grm_den_r_market_glmm6 <- brm(formula = meanDen_int ~ RelYear + (1 | reefIDcrosswalk), data = grm_n_r_market, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_r_market_glmm6.rds")
grm_den_r_market_glmm6 <- add_criterion(grm_den_r_market_glmm6, "loo")

grm_den_r_market_glmm7 <- brm(formula = meanDen_int ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = grm_n_r_market, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_den_r_market_glmm7.rds")
grm_den_r_market_glmm7 <- add_criterion(grm_den_r_market_glmm7, "loo")

#GLMM6 is the best fit.
loo_compare(grm_den_r_market_glmm5, grm_den_r_market_glmm6, grm_den_r_market_glmm7)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
grm_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Guana River Marsh_Natural")
grm_n_r_market[, QuadSize_m2 := as.factor(QuadSize_m2)]
grm_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
grm_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
saveRDS(grm_n_r_market, here::here(paste0('GLMMs/AllDates/Data/grm_n_r_market_', Sys.Date(), '.rds')))

grm_den_r_market_glmm <- readRDS(here::here('GLMMs/AllDates/grm_den_r_market_glmm6.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

grm_n_r_market[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
grm_n_r_market[, SampleDay := day(SampleDate)]


den_t <- copy(grm_n_r_market[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(grm_n_r_market$Month))){
  mo <- subset(grm_n_r_market, as.numeric(grm_n_r_market$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(grm_n_r_market, grm_n_r_market$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = ">75mm", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(meanDen_int),
                       Median = median(meanDen_int),
                       Mean = round(mean(meanDen_int), digits = 2),
                       SD = round(sd(meanDen_int), digits = 2), 
                       Min. = min(meanDen_int),
                       Max. = max(meanDen_int)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = ">75mm",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(grm_sho75, grm_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(grm_n_r_market, aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(grm_n_r_market, aes(x = RelYear, y = QuadSize_m2, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(grm_n_r_market, aes(x = RelYear, y = reefIDcrosswalk, color = factor(ProgramID))) +
  geom_point() +
  theme_bw()

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(grm_den_r_market_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_GRM_PDistandMChains_r_market <- plot(grm_den_r_market_glmm)
Den_AllDates_GLMM_GRM_PDistandMChains_r_market

len <- length(Den_AllDates_GLMM_GRM_PDistandMChains_r_market)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_PDistandMChains_r_market_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_GRM_PDistandMChains_r_market[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_GRM_PPcheck_r_market <- pp_check(grm_den_r_market_glmm)
Den_AllDates_GLMM_GRM_PPcheck_r_market

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_PPcheck_r_market_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GRM_PPcheck_r_market,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
set.seed(987)
grm1_r_market <- plot(conditional_effects(grm_den_r_market_glmm, re_formula = NULL), plot = FALSE)[[1]]
Den_AllDates_GLMM_GRM_MEPrand_r_market <- grm1_r_market +
  geom_jitter(data = grm_n_r_market, aes(x = RelYear, y = meanDen_int, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = grm_n_r_market, aes(y = -5, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(color = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13),
    legend.position = "none")
Den_AllDates_GLMM_GRM_MEPrand_r_market

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_MEPrand_r_market_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GRM_MEPrand_r_market,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
set.seed(986)
grm2_r_market <- plot(conditional_effects(grm_den_r_market_glmm, re_formula = NA), plot = FALSE)[[1]]
Den_AllDates_GLMM_GRM_MEPnorand_r_market <- grm2_r_market +
  geom_jitter(data = grm_n_r_market, aes(x = RelYear, y = meanDen_int, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = grm_n_r_market, aes(y = -10, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(color = "Reef ID") + 
  theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13),
    legend.position = "none")
Den_AllDates_GLMM_GRM_MEPnorand_r_market

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_MEPnorand_r_market_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GRM_MEPnorand_r_market,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"}
#Individual effects plots
Den_AllDates_GLMM_GRM_IEP_r_market <- grm_n_r_market %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(grm_den_r_market_glmm) %>%
  ggplot(aes(x = RelYear, y = meanDen_int, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = grm_n_r_market, size = 2) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = grm_n_r_market, aes(y = -8, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(an_n_r_market, an_n_r_market$Year %in% labs2), aes(y = -300, label = Year, x = RelYear), size = 2, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  guides(color = FALSE) +
  scale_x_continuous(limits = c(-1, max(grm_n_r_market$RelYear) + 1)) +
  scale_y_continuous(limits = c(-10, 300)) +
  coord_cartesian(ylim = c(-10, 100)) +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
Den_AllDates_GLMM_GRM_IEP_r_market

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GRM_IEP_r_market_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GRM_IEP_r_market,
       width = 10,
       height = 49,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(grm_n_r_market, grm_den_r_market_glmm, 
   Den_AllDates_GLMM_GRM_PDistandMChains_r_market,
   Den_AllDates_GLMM_GRM_PPcheck_r_market,
   Den_AllDates_GLMM_GRM_MEPrand_r_market,
   Den_AllDates_GLMM_GRM_MEPnorand_r_market,
   Den_AllDates_GLMM_GRM_IEP_r_market
   )

```

<br><br><br>

##### Guana Tolomato Matanzas NERR_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

gtmn_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Guana Tolomato Matanzas NERR_Natural")
gtmn_n_r_market[, QuadSize_m2 := as.numeric(QuadSize_m2)]
gtmn_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
gtmn_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
saveRDS(gtmn_n_r_market, here::here(paste0('GLMMs/AllDates/Data/gtmn_n_r_market_', Sys.Date(), '.rds')))

gtmn_den_r_market_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + Region.y + (1 + RelYear|reefIDcrosswalk), data = gtmn_n_r_market, family = hurdle_lognormal(link = "identity", link_sigma = "log", link_hu = "logit"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
gtmn_den_r_market_glmm <- add_criterion(gtmn_den_r_market_glmm, "loo")

ggplot(gtmn_n_r_market, aes(x = RelYear, y = meanDen, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(gtmn_n_r_market, aes(x = RelYear, y = factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(gtmn_n_r_market, aes(x = RelYear, y = Region.y, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

gtmn_den_r_market_glmm1 <- brm(formula = meanDen_int ~ 1, data = gtmn_n_r_market, family = poisson, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_market_glmm1.rds")
gtmn_den_r_market_glmm1 <- add_criterion(gtmn_den_r_market_glmm1, "loo")

gtmn_den_r_market_glmm1b <- brm(formula = meanDen_int ~ 1, data = gtmn_n_r_market, family = negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_market_glmm1b.rds")
gtmn_den_r_market_glmm1b <- add_criterion(gtmn_den_r_market_glmm1b, "loo")

gtmn_den_r_market_glmm1c <- brm(formula = meanDen_int ~ 1, data = gtmn_n_r_market, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_market_glmm1c.rds")
gtmn_den_r_market_glmm1c <- add_criterion(gtmn_den_r_market_glmm1c, "loo")

gtmn_den_r_market_glmm2 <- brm(formula = meanDen_int ~ RelYear, data = gtmn_n_r_market, family = poisson, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_market_glmm2.rds")
gtmn_den_r_market_glmm2 <- add_criterion(gtmn_den_r_market_glmm2, "loo")

gtmn_den_r_market_glmm2b <- brm(formula = meanDen_int ~ RelYear, data = gtmn_n_r_market, family = negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_market_glmm2b.rds")
gtmn_den_r_market_glmm2b <- add_criterion(gtmn_den_r_market_glmm2b, "loo")

gtmn_den_r_market_glmm2c <- brm(formula = meanDen_int ~ RelYear, data = gtmn_n_r_market, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_market_glmm2c.rds")
gtmn_den_r_market_glmm2c <- add_criterion(gtmn_den_r_market_glmm2c, "loo")

#Looks like zero_inflated_negbinomial fits best.
loo_compare(gtmn_den_r_market_glmm2, gtmn_den_r_market_glmm2b, gtmn_den_r_market_glmm2c)

gtmn_den_r_market_glmm3 <- brm(formula = meanDen_int ~ Region.y, data = gtmn_n_r_market, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_market_glmm3.rds")
gtmn_den_r_market_glmm3 <- add_criterion(gtmn_den_r_market_glmm3, "loo")

gtmn_den_r_market_glmm4 <- brm(formula = meanDen_int ~ RelYear + Region.y, data = gtmn_n_r_market, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_market_glmm4.rds")
gtmn_den_r_market_glmm4 <- add_criterion(gtmn_den_r_market_glmm4, "loo")

gtmn_den_r_market_glmm5 <- brm(formula = meanDen_int ~ RelYear + Region.y + (1 | reefIDcrosswalk), data = gtmn_n_r_market, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_market_glmm5.rds")
gtmn_den_r_market_glmm5 <- add_criterion(gtmn_den_r_market_glmm5, "loo")

gtmn_den_r_market_glmm5b <- brm(formula = meanDen_int ~ RelYear + Region.y + (1 | reefIDcrosswalk), data = gtmn_n_r_market, family = negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_market_glmm5b.rds")
gtmn_den_r_market_glmm5b <- add_criterion(gtmn_den_r_market_glmm5b, "loo")

gtmn_den_r_market_glmm5c <- brm(formula = meanDen_int ~ RelYear + Region.y + (1 | reefIDcrosswalk), data = gtmn_n_r_market, family = poisson, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_market_glmm5c.rds")
gtmn_den_r_market_glmm5c <- add_criterion(gtmn_den_r_market_glmm5c, "loo")

gtmn_den_r_market_glmm6 <- brm(formula = meanDen_int ~ RelYear + Region.y + (0 + RelYear | reefIDcrosswalk), data = gtmn_n_r_market, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_den_r_market_glmm6.rds")
gtmn_den_r_market_glmm6 <- add_criterion(gtmn_den_r_market_glmm6, "loo")

#GLMM 5 is the best fit.
loo_compare(gtmn_den_r_market_glmm4, gtmn_den_r_market_glmm5, gtmn_den_r_market_glmm6)

#zero_inflated_negbinomial is the best fitting family
loo_compare(gtmn_den_r_market_glmm5, gtmn_den_r_market_glmm5b, gtmn_den_r_market_glmm5c)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
gtmn_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Guana Tolomato Matanzas NERR_Natural")
gtmn_n_r_market[, QuadSize_m2 := as.numeric(QuadSize_m2)]
gtmn_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
gtmn_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
saveRDS(gtmn_n_r_market, here::here(paste0('GLMMs/AllDates/Data/gtmn_n_r_market_', Sys.Date(), '.rds')))

gtmn_den_r_market_glmm <- readRDS(here::here('GLMMs/AllDates/gtmn_den_r_market_glmm5.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

gtmn_n_r_market[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
gtmn_n_r_market[, SampleDay := day(SampleDate)]


den_t <- copy(gtmn_n_r_market[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(gtmn_n_r_market$Month))){
  mo <- subset(gtmn_n_r_market, as.numeric(gtmn_n_r_market$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(gtmn_n_r_market, gtmn_n_r_market$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = ">75mm", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(meanDen_int),
                       Median = median(meanDen_int),
                       Mean = round(mean(meanDen_int), digits = 2),
                       SD = round(sd(meanDen_int), digits = 2), 
                       Min. = min(meanDen_int),
                       Max. = max(meanDen_int)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = ">75mm",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(gtmn_sho75, gtmn_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(gtmn_n_r_market, aes(x = RelYear, y = meanDen, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(gtmn_n_r_market, aes(x = RelYear, y = factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(gtmn_n_r_market, aes(x = RelYear, y = Region.y, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(gtmn_den_r_market_glmm)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_GTMNERR_PDistandMChains_r_market <- plot(gtmn_den_r_market_glmm)
Den_AllDates_GLMM_GTMNERR_PDistandMChains_r_market

len <- length(Den_AllDates_GLMM_GTMNERR_PDistandMChains_r_market)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_PDistandMChains_r_market_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_AllDates_GLMM_GTMNERR_PDistandMChains_r_market[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_AllDates_GLMM_GTMNERR_PPcheck_r_market <- pp_check(gtmn_den_r_market_glmm)
Den_AllDates_GLMM_GTMNERR_PPcheck_r_market

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_PPcheck_r_market_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_PPcheck_r_market,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
gtmn1_r_market <- plot(conditional_effects(gtmn_den_r_market_glmm, re_formula = NULL), plot = FALSE)[[1]]
Den_AllDates_GLMM_GTMNERR_MEPrand_r_market <- gtmn1_r_market +
  geom_jitter(data = gtmn_n_r_market, aes(x = RelYear, y = meanDen_int, fill = Region.y), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = gtmn_n_r_market, aes(y = -10, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(xlim = c(-0.5,6.5)) +
  labs(fill = "Region") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_AllDates_GLMM_GTMNERR_MEPrand_r_market

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_MEPrand_r_market_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_MEPrand_r_market,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
meanDen_r_market <- plot(conditional_effects(gtmn_den_r_market_glmm, re_formula = NULL), plot = FALSE)[[2]]$data
setnames(meanDen_r_market, "effect1__", "Region")

Den_AllDates_GLMM_GTMNERR_MEPrand_r_market_MeanRes <- ggplot(meanDen_r_market, aes(x = Region, y = estimate__, ymin = lower__, ymax = upper__)) +
  geom_pointinterval(fill = "black", size = 3, fatten_point = 4, shape = 21, color = "black") +
  ylab("Density_m2 (shell height >75mm)") +
  theme_bw()  + 
  theme(axis.title = element_text(size = 13), 
        axis.text = element_text(size = 12), 
        legend.text = element_text(size = 12), 
        legend.title = element_text(size = 13))+labs(fill = NULL)
Den_AllDates_GLMM_GTMNERR_MEPrand_r_market_MeanRes

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_MEPrand_r_market_MeanRes_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_MEPrand_r_market_MeanRes,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
gtmn2_r_market <- plot(conditional_effects(gtmn_den_r_market_glmm, re_formula = NA), plot = FALSE)[[1]]
Den_AllDates_GLMM_GTMNERR_MEPnorand_r_market <- gtmn2_r_market +
  geom_jitter(data = gtmn_n_r_market, aes(x = RelYear, y = meanDen_int, fill = Region.y), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = gtmn_n_r_market, aes(y = -10, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(xlim = c(-0.5,6.5)) +
  labs(fill = "Region") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_AllDates_GLMM_GTMNERR_MEPnorand_r_market

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_MEPnorand_r_market_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_MEPnorand_r_market,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"}
#Individual effects plots
Den_AllDates_GLMM_GTMNERR_IEP_r_market <- gtmn_n_r_market %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(gtmn_den_r_market_glmm) %>%
  ggplot(aes(x = RelYear, y = meanDen_int, color = Region.y)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = gtmn_n_r_market) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = gtmn_n_r_market, aes(y = -40, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(gtmn_n_r_market$RelYear) + 1)) +
  scale_y_continuous(limits = c(-50, 350)) +
  #theme(legend.position = "none") +
  #labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
Den_AllDates_GLMM_GTMNERR_IEP_r_market

ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_GTMNERR_IEP_r_market_", Sys.Date(), ".jpeg")),
       Den_AllDates_GLMM_GTMNERR_IEP_r_market,
       width = 10,
       height = 80,
       units = "in",
       dpi = 300,
       limitsize = FALSE)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(gtmn_n_r_market, gtmn_den_r_market_glmm, 
   Den_AllDates_GLMM_GTMNERR_PDistandMChains_r_market,
   Den_AllDates_GLMM_GTMNERR_PPcheck_r_market,
   Den_AllDates_GLMM_GTMNERR_MEPrand_r_market,
   Den_AllDates_GLMM_GTMNERR_MEPnorand_r_market,
   Den_AllDates_GLMM_GTMNERR_IEP_r_market
   )

```

<br><br><br>

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ##### Indian River-Vero Beach to Ft. Pierce {.tabset .tabset-fade .tabset-pills}
# 
# irvbfp_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural")
# irvbfp_n_r_market[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# irvbfp_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# irvbfp_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(irvbfp_n_r_market, here::here(paste0('GLMMs/AllDates/Data/irvbfp_n_r_market_', Sys.Date(), '.rds')))
# 
# irvbfp_den_r_market_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = irvbfp_n_r_market, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# irvbfp_den_r_market_glmm <- add_criterion(irvbfp_den_r_market_glmm, "loo")
# 
# saveRDS(irvbfp_den_r_market_glmm, here::here('GLMMs/AllDates/irvbfp_den_r_market_glmm.rds'))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# irvbfp_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Indian River-Vero Beach to Ft. Pierce_Natural")
# irvbfp_n_r_market[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# irvbfp_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# irvbfp_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(irvbfp_n_r_market, here::here(paste0('GLMMs/AllDates/Data/irvbfp_n_r_market_', Sys.Date(), '.rds')))
# 
# irvbfp_den_r_market_glmm <- readRDS(here::here('GLMMs/AllDates/irvbfp_den_r_market_glmm.rds'))

```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Model Output
# 
# summary(irvbfp_den_r_market_glmm)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Diagnostic Plots
# 
# #Posterior distributions and Markov chains:
#   
# Den_AllDates_GLMM_IRVBFP_PDistandMChains_r_market <- plot(irvbfp_den_r_market_glmm)
# Den_AllDates_GLMM_IRVBFP_PDistandMChains_r_market
# 
# len <- length(Den_AllDates_GLMM_IRVBFP_PDistandMChains_r_market)
# for(i in 1:len){
#   jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_IRVBFP_PDistandMChains_r_market_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
#   print(Den_AllDates_GLMM_IRVBFP_PDistandMChains_r_market[i])
#   dev.off()
# }
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Posterior predictive check plot:
#   
# Den_AllDates_GLMM_IRVBFP_PPcheck_r_market <- pp_check(irvbfp_den_r_market_glmm)
# Den_AllDates_GLMM_IRVBFP_PPcheck_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_IRVBFP_PPcheck_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_IRVBFP_PPcheck_r_market,
#        width = 4,
#        height = 3,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Marginal Effects Plots
# 
# #Including the random effect of reef (i.e., managed area-wide credible interval):
#   
# #Marginal effects plot including random effects
# irvbfp1_r_market <- plot(conditional_effects(irvbfp_den_r_market_glmm, re_formula = NULL), plot = FALSE)[[1]]
# Den_AllDates_GLMM_IRVBFP_MEPrand_r_market <- irvbfp1_r_market +
#   geom_point(data = irvbfp_n_r_market, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_IRVBFP_MEPrand_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_IRVBFP_MEPrand_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_IRVBFP_MEPrand_r_market,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Excluding the random effect of reef (i.e., sampled population credible interval):
#   
# #Marginal effects plot excluding random effects
# irvbfp2_r_market <- plot(conditional_effects(irvbfp_den_r_market_glmm, re_formula = NA), plot = FALSE)[[1]]
# Den_AllDates_GLMM_IRVBFP_MEPnorand_r_market <- irvbfp2_r_market +
#   geom_point(data = irvbfp_n_r_market, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_IRVBFP_MEPnorand_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_IRVBFP_MEPnorand_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_IRVBFP_MEPnorand_r_market,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Individual effects plots:
#   
# #Individual effects plots
# Den_AllDates_GLMM_IRVBFP_IEP_r_market <- irvbfp_n_r_market %>%
#   group_by(reefIDcrosswalk) %>%
#   add_fitted_draws(irvbfp_den_r_market_glmm) %>%
#   ggplot(aes(x = RelYear, y = meanCount, color = reefIDcrosswalk)) +
#   stat_lineribbon(aes(y = .value), size = 1) +
#   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
#   geom_point(data = irvbfp_n_r_market) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
#   #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
#   scale_fill_brewer(palette = "Greys") +
#   scale_color_brewer(palette = "Set2") +
#   theme_bw() +
#   facet_wrap(~ reefIDcrosswalk)
# Den_AllDates_GLMM_IRVBFP_IEP_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_IRVBFP_IEP_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_IRVBFP_IEP_r_market,
#        width = 10,
#        height = 5,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# # Remove created objects to save memory.
# rm(irvbfp_n_r_market, irvbfp_den_r_market_glmm, 
#    Den_AllDates_GLMM_IRVBFP_PDistandMChains_r_market,
#    Den_AllDates_GLMM_IRVBFP_PPcheck_r_market,
#    Den_AllDates_GLMM_IRVBFP_MEPrand_r_market,
#    Den_AllDates_GLMM_IRVBFP_MEPnorand_r_market,
#    Den_AllDates_GLMM_IRVBFP_IEP_r_market
#    )
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ##### Lemon Bay {.tabset .tabset-fade .tabset-pills}
# 
# lb_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Lemon Bay_Natural")
# lb_n_r_market[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# lb_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# lb_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(lb_n_r_market, here::here(paste0('GLMMs/AllDates/Data/lb_n_r_market_', Sys.Date(), '.rds')))
# 
# lb_den_r_market_glmm <- brm(formula = meanCount ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = lb_n_r_market, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.999, max_treedepth = 15), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# lb_den_r_market_glmm <- add_criterion(lb_den_r_market_glmm, "loo")
# 
# saveRDS(lb_den_r_market_glmm, here::here('GLMMs/AllDates/lb_den_r_market_glmm.rds'))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# lb_n_r_market <- subset(oysterraw_den_r_market_den, oysterraw_den_r_market_den$MA_plotlab == "Lemon Bay_Natural")
# lb_n_r_market[, QuadSize_m2 := as.numeric(QuadSize_m2)]
# lb_n_r_market[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
# lb_n_r_market[, RelYear := LiveDate2 - min(LiveDate2)]
# saveRDS(lb_n_r_market, here::here(paste0('GLMMs/AllDates/Data/lb_n_r_market_', Sys.Date(), '.rds')))
# 
# lb_den_r_market_glmm <- readRDS(here::here('GLMMs/AllDates/lb_den_r_market_glmm.rds'))

```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Model Output
# 
# summary(lb_den_r_market_glmm)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Diagnostic Plots
# 
# #Posterior distributions and Markov chains:
#   
# Den_AllDates_GLMM_LB_PDistandMChains_r_market <- plot(lb_den_r_market_glmm)
# Den_AllDates_GLMM_LB_PDistandMChains_r_market
# 
# len <- length(Den_AllDates_GLMM_LB_PDistandMChains_r_market)
# for(i in 1:len){
#   jpeg(filename = here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_PDistandMChains_r_market_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
#   print(Den_AllDates_GLMM_LB_PDistandMChains_r_market[i])
#   dev.off()
# }
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Posterior predictive check plot:
#   
# Den_AllDates_GLMM_LB_PPcheck_r_market <- pp_check(lb_den_r_market_glmm)
# Den_AllDates_GLMM_LB_PPcheck_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_PPcheck_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_LB_PPcheck_r_market,
#        width = 4,
#        height = 3,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# ###### Marginal Effects Plots
# 
# #Including the random effect of reef (i.e., managed area-wide credible interval):
#   
# #Marginal effects plot including random effects
# lb1_r_market <- plot(conditional_effects(lb_den_r_market_glmm, re_formula = NULL), plot = FALSE)[[1]]
# Den_AllDates_GLMM_LB_MEPrand_r_market <- lb1_r_market +
#   geom_point(data = lb_n_r_market, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_LB_MEPrand_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_MEPrand_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_LB_MEPrand_r_market,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Excluding the random effect of reef (i.e., sampled population credible interval):
# 
# #Marginal effects plot excluding random effects
# lb2_r_market <- plot(conditional_effects(lb_den_r_market_glmm, re_formula = NA), plot = FALSE)[[1]]
# Den_AllDates_GLMM_LB_MEPnorand_r_market <- lb2_r_market +
#   geom_point(data = lb_n_r_market, aes(x = RelYear, y = meanCount, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, color = "black", inherit.aes = FALSE) +
#   theme_bw()
# Den_AllDates_GLMM_LB_MEPnorand_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_MEPnorand_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_LB_MEPnorand_r_market,
#        width = 10,
#        height = 6,
#        units = "in",
#        dpi = 300)
# 
# #<br><br><br>
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="100%"}
# #Individual effects plots:
# 
# #Individual effects plots
# Den_AllDates_GLMM_LB_IEP_r_market <- lb_n_r_market %>%
#   group_by(reefIDcrosswalk) %>%
#   add_fitted_draws(lb_den_r_market_glmm) %>%
#   ggplot(aes(x = RelYear, y = meanCount, color = reefIDcrosswalk)) +
#   stat_lineribbon(aes(y = .value), size = 1) +
#   #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
#   geom_point(data = lb_n_r_market) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
#   #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
#   scale_fill_brewer(palette = "Greys") +
#   scale_color_brewer(palette = "Set2") +
#   theme_bw() +
#   facet_wrap(~ reefIDcrosswalk)
# Den_AllDates_GLMM_LB_IEP_r_market
# 
# ggsave(here::here(paste0("OA_plots/Den_AllDates_GLMM_LB_IEP_r_market_", Sys.Date(), ".jpeg")),
#        Den_AllDates_GLMM_LB_IEP_r_market,
#        width = 10,
#        height = 5,
#        units = "in",
#        dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# # Remove created objects to save memory.
# rm(lb_n_r_market, lb_den_r_market_glmm, 
#    Den_AllDates_GLMM_LB_PDistandMChains_r_market,
#    Den_AllDates_GLMM_LB_PPcheck_r_market,
#    Den_AllDates_GLMM_LB_MEPrand_r_market,
#    Den_AllDates_GLMM_LB_MEPnorand_r_market,
#    Den_AllDates_GLMM_LB_IEP_r_market
#    )

# #<br><br><br>
```

***

## Percent live

```{r Percent-live-data-setup-and-summarize, echo=TRUE, message=FALSE, warning=FALSE}

setDT(oysterraw_pct)
# oysterraw_pct <- oysterraw_pct %>% mutate(SampleDate = mdy_hms(SampleDate))
# oysterraw_pct[, Month := month(SampleDate)]
# oysterraw_pct[, YrMo := paste0(Year, "-", Month)]
# oysterraw_pct[PercentLiveMethod == "Point-Intercept", PercentLiveMethod := "Point-intercept"]

#More complicated conversion of date columns needed because ID_972 data do not have the hms format for time like the default in the combined table exports. When it eventually is corrected and fixed in the combined table export, then all program data should have the same SampleDate format and the above code should work again.
oysterraw_pct_no972 <- setDT(subset(oysterraw_pct, oysterraw_pct$ProgramID != 972)) %>% mutate(SampleDate = mdy_hms(SampleDate))
oysterraw_pct_no972[, Month := month(SampleDate)]
oysterraw_pct_no972[, YrMo := paste0(Year, "-", Month)]

oysterraw_pct_972 <- setDT(subset(oysterraw_pct, oysterraw_pct$ProgramID == 972)) %>% mutate(SampleDate = mdy_hm(SampleDate))
oysterraw_pct_972[, Month := month(SampleDate)]
oysterraw_pct_972[, YrMo := paste0(Year, "-", Month)]

oysterraw_pct <- rbind(oysterraw_pct_no972, oysterraw_pct_972)


#Fix QuadID and ReefID columns for 2003 data in program 4014
Reefs_4014_2003 <- c('1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13')
Quads_4014_2003 <- c('1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '13', '14')
Fix4014 <- oysterraw_pct[ProgramID == 4014, ][Year == 2003, QuadIdentifier := Quads_4014_2003][Year == 2003, ReefIdentifier := Reefs_4014_2003]
no4014 <- subset(oysterraw_pct, oysterraw_pct$ProgramID != 4014)
oysterraw_pct <- rbind(Fix4014, no4014)

#Fix HabitatClassification of 4012
oysterraw_pct[QuadIdentifier %like% "_Ref", HabitatClassification := "Natural"]
oysterraw_pct[QuadIdentifier %like% "_C", HabitatClassification := "Natural"]

#Summarize percent live data by managed area
oysterraw_pct_nona <- subset(oysterraw_pct, !is.na(oysterraw_pct$PercentLive_pct))
oysterraw_pct_nona[ProgramID == 4012, PercentLiveMethod := "Percent"]
oysterraw_pct_nona[PercentLiveMethod == "percent", PercentLiveMethod := "Percent"]
oysterraw_pct_nona[, Year := as.integer(Year)]
pct_all_sum <- summarySE(oysterraw_pct_nona, measurevar = 'PercentLive_pct', groupvars = c('ManagedAreaName', 'Year', 'PercentLiveMethod'))
```

<br><br><br>

```{r PctSummaryTable, echo=TRUE, message=FALSE, warning=FALSE}
#Create summary table showing number of reefs/programs of data included in oysterraw_pct
oysterraw_pct[, nReefsbyMAandYr := length(unique(reefIDcrosswalk)), by = c('MA_plotlab', 'Year')]
oysterraw_pct[, nProgsbyMAandYr := length(unique(ProgramID)), by = c('MA_plotlab', 'Year')]
oysterraw_pct[, ProgsbyMAandYr := list(list(unique(ProgramID))), by = c('MA_plotlab', 'Year')]
oysterraw_pct[, nProgsbyMA := length(unique(ProgramID)), by = 'MA_plotlab']
oysterraw_pct[, ProgsbyMA := list(list(unique(ProgramID))), by = 'MA_plotlab']

pct_sum1 <- unique(oysterraw_pct[, .(MA_plotlab, Year, nReefsbyMAandYr, nProgsbyMAandYr, nProgsbyMA)], by = c('MA_plotlab', 'Year', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'nProgsbyMA'))
listcols <- oysterraw_pct[, .SD[1], by = c('MA_plotlab', 'Year')][, .(ProgsbyMAandYr, ProgsbyMA)]
pct_sum1 <- cbind(pct_sum1, listcols)
setcolorder(pct_sum1, c('MA_plotlab', 'nProgsbyMA', 'ProgsbyMA', 'Year', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'))
setorder(pct_sum1, MA_plotlab, Year)

#Create easily readable table in knitted document
#Better column names
pct_sum1_renamed <- setnames(pct_sum1, c('nProgsbyMA', 'ProgsbyMA', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'), c('n progams_tot', 'programs_tot', 'n reefs_yr', 'n programs_yr', 'programs_yr'))

#Group names
groups <- c()
for(i in unique(pct_sum1$MA_plotlab)){
  name <- paste0(i, ", Total Programs = ", pct_sum1[MA_plotlab == i, 2][1], ": ", pct_sum1[MA_plotlab == i, 3][[1]])[1]
  groups <- append(groups, name)
}

oysterraw_pct_nona[, MA_plotlab := paste0(ManagedAreaName, "_", HabitatClassification)]

```  

```{r AvgPctLive-setup, echo=TRUE, message=FALSE, warning=FALSE}
#Pct live, all and by reef
pct_avg_all <- oysterraw_pct_nona[, MeanPct := mean(PercentLive_pct), by = c('ManagedAreaName', 'Year')][, sdPct := sd(PercentLive_pct), by = c('Year', 'ManagedAreaName')][, semPct := sd(PercentLive_pct)/sqrt(length(PercentLive_pct)), by = c('Year', 'ManagedAreaName')][, nYears := length(unique(Year)), by = c('ManagedAreaName')][, MeanReefPct := mean(PercentLive_pct), by = c('Year', 'ManagedAreaName', 'reefIDcrosswalk')][, sdReefPct := sd(PercentLive_pct), by = c('Year', 'ManagedAreaName', 'reefIDcrosswalk')][, semReefPct := sd(PercentLive_pct)/sqrt(length(PercentLive_pct)), by = c('Year', 'ManagedAreaName', 'reefIDcrosswalk')][, nYearsReef := length(unique(Year)), by = c('ManagedAreaName', 'reefIDcrosswalk')][, YrMo := format(as.Date(SampleDate), "%Y-%m")][, MeanReefPct_yrmo := mean(PercentLive_pct), by = c('YrMo', 'ManagedAreaName', 'reefIDcrosswalk')][, sdReefPct_yrmo := sd(PercentLive_pct), by = c('YrMo', 'ManagedAreaName', 'reefIDcrosswalk')][, semReefPct_yrmo := sd(PercentLive_pct)/sqrt(length(PercentLive_pct)), by = c('YrMo', 'ManagedAreaName', 'reefIDcrosswalk')][, nYearsReef_yrmo := length(unique(YrMo)), by = c('ManagedAreaName', 'reefIDcrosswalk')]
#pct_avg_reef <- unique(pct_avg_all[, c(1:2, 7:8, 10, 12:16, 21:23, 28:31)])
#pct_avg_reef_yr <- unique(pct_avg_all[, c(1:2, 8, 10, 12:16, 21:24, 30:33)])
pct_avg_reef_yr <- unique(pct_avg_all[, c("ProgramID", "ProgramName", "Year", "ManagedAreaName", "SurveyMethod", "PercentLiveMethod", "HabitatClassification", "QuadSize_m2", "MADup", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "MeanReefPct", "sdReefPct", "semReefPct", "nYearsReef")])
#pct_avg_reef_yrmo <- unique(pct_avg_all[, c(1:2, 8, 10, 12:16, 21:24, 34:37)])
pct_avg_reef_yrmo <- unique(pct_avg_all[, c("ProgramID", "ProgramName", "Year", "ManagedAreaName", "SurveyMethod", "PercentLiveMethod", "HabitatClassification", "QuadSize_m2", "MADup", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "MeanReefPct_yrmo", "sdReefPct_yrmo", "semReefPct_yrmo", "nYearsReef_yrmo")])

```

<br><br><br>

### View the data {.tabset .tabset-fade}

#### Histograms

```{r AvgPctbyReefandYR-hist, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#histogram of average shell height by reef and year
Pct_AllDates_AvgbyReefandYr_raw <- ggplot(pct_avg_reef_yr, aes(MeanReefPct)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_histogram(color = "black") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free")
Pct_AllDates_AvgbyReefandYr_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_AvgbyReefandYr_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_AvgbyReefandYr_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

#### Normal QQ plots

```{r AvgPctbyReefandYR-qqplot, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#QQ plot of average shell height by reef and year
Pct_AllDates_QQbyReefandYr_raw <- ggplot(pct_avg_reef_yr, aes(sample = MeanReefPct)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_qq(shape = 1) +
  geom_qq_line(color = "red") +
  facet_wrap(~MA_plotlab, ncol = 3, scale = "free")
Pct_AllDates_QQbyReefandYr_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_QQbyReefandYr_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_QQbyReefandYr_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

### Regression summary tables {.tabset .tabset-fade}

#### Quantile regression

```{r AvgPctbyReefandYR-QReg, echo=TRUE, message=FALSE, warning=FALSE}
#Run nonparametric regression (quantile regression) on average >25mm SH reef-level data by year, if there are >4 years of data
#Followed quantile regression example here: https://rcompanion.org/handbook/F_12.html; accessed 10/14/2020
qreg_results_pct <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), pvalue = numeric(), pseudoR2 = numeric())
for(i in unique(pct_avg_reef_yrmo$MA_plotlab)){
  qrdat <- pct_avg_reef_yrmo[MA_plotlab == i, ]
  if(length(unique(qrdat$Year)) < 5) next
  quantregs <- rq(MeanReefPct_yrmo ~ Year, data = qrdat, tau = 0.5)
  nullmod <- rq(MeanReefPct_yrmo ~ 1, data = qrdat, tau = 0.5)
  anov <- anova(quantregs, nullmod)
  PseudR <- nagelkerke(quantregs)
  iresult <- data.table(MA_plotlab = i, intercept = quantregs$coefficients[[1]], slope = quantregs$coefficients[[2]], pvalue = anov$table[[4]], pseudoR2 = PseudR$Pseudo.R.squared.for.model.vs.null[[3]])
  qreg_results_pct <- rbind(qreg_results_pct, iresult)
}

setorder(qreg_results_pct, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
qreg_results_pct_renamed <- setnames(qreg_results_pct, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(qreg_results_pct, 'Managed Area_Habitat Class.', 'MA_plotlab')

qreg_results_pct_renamed %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)
```

#### Linear regression

```{r AvgPctbyReefandYR-LinReg, echo=TRUE, message=FALSE, warning=FALSE}
#Linear regression version instead of quantile regression
lm_results_pct <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), Fstatistic = numeric(), numdf = numeric(), dendf = numeric(), pvalue = numeric(), adjustedR2 = numeric())
for(i in unique(pct_avg_reef_yr$MA_plotlab)){
  lmdat <- pct_avg_reef_yr[MA_plotlab == i, ]
  if(length(unique(lmdat$Year)) < 5) next
  lms <- lm(MeanReefPct ~ Year, data = lmdat)
  iresult <- data.table(MA_plotlab = i, intercept = lms$coefficients[[1]], slope = lms$coefficients[[2]], Fstatistic = summary(lms)$fstatistic[[1]], numdf = summary(lms)$fstatistic[[2]], dendf = summary(lms)$fstatistic[[3]], pvalue = anova(lms)$Pr[1], adjustedR2 = summary(lms)$adj.r.squared)
  lm_results_pct <- rbind(lm_results_pct, iresult)
}

setorder(lm_results_pct, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
lm_results_pct_renamed <- setnames(lm_results_pct, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(lm_results_pct, 'Managed Area_Habitat Class.', 'MA_plotlab')

lm_results_pct_renamed %>% 
  kbl(align = "lccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)

```

<br><br><br>

### Linear regression diagnostic plots {.tabset .tabset-fade}

#### Guana River Marsh_Natural

```{r echo=TRUE, fig.show="hold", out.width="50%"}

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr[MA_plotlab == "Guana River Marsh_Natural", ]), which = 1)

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr[MA_plotlab == "Guana River Marsh_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", out.width="50%"}

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr[MA_plotlab == "Guana River Marsh_Natural", ]), which = 3)

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr[MA_plotlab == "Guana River Marsh_Natural", ]), which = 4)

```

<br><br><br>

#### Guana Tolomato Matanzas NERR_Natural

```{r echo=TRUE, fig.show="hold", out.width="50%"}

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 1)

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", out.width="50%"}

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 3)

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr[MA_plotlab == "Guana Tolomato Matanzas NERR_Natural", ]), which = 4)

```

<br><br><br>

#### Lemon Bay_Natural

```{r echo=TRUE, fig.show="hold", out.width="50%"}

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr[MA_plotlab == "Lemon Bay_Natural", ]), which = 1)

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr[MA_plotlab == "Lemon Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", out.width="50%"}

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr[MA_plotlab == "Lemon Bay_Natural", ]), which = 3)

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr[MA_plotlab == "Lemon Bay_Natural", ]), which = 4)

```

<br><br><br>

### Regression plots {.tabset .tabset-fade}

#### Quantile regression

```{r AvgPctbyReefandYR-QuantRegPlot, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot reef-level average percent live, including quantile regression lines, as applicable, and full range of years.
Pct_AllDates_QuantReg_raw <- ggplot(pct_avg_reef_yrmo, aes(Year, MeanReefPct_yrmo, fill = reefIDcrosswalk)) +
  theme_bw() +
  geom_point(shape = 21) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = qreg_results_pct, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 90), axis.line = element_line())
Pct_AllDates_QuantReg_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_QuantReg_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_QuantReg_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

#### Linear regression

```{r AvgPctbyReefandYR-LinRegPlot, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
Pct_AllDates_LinReg_raw <- ggplot(pct_avg_reef_yr, aes(Year, MeanReefPct, fill = reefIDcrosswalk)) +
  theme_bw() +
  geom_point(shape = 21) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = lm_results_pct, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 90), axis.line = element_line())
Pct_AllDates_LinReg_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_LinReg_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_LinReg_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

### Generalized Linear Mixed Effects Models {.tabset .tabset-fade}

#### Guana River Marsh_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

grm_p <- subset(oysterraw_pct_nona, oysterraw_pct_nona$MA_plotlab == "Guana River Marsh_Natural")
grm_p[, QuadSize_m2 := as.factor(QuadSize_m2)]
grm_p[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
grm_p[, RelYear := Year - min(Year)]
grm_p[, PercentLive_dec := PercentLive_pct/100]
grm_p[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", Year, "-", Month)]
saveRDS(grm_p, here::here(paste0('GLMMs/AllDates/Data/grm_p_', Sys.Date(), '.rds')))

grm_p_binom <- data.table(ProgramID = character(), ProgramLocationID = character(), QuadIdentifier = character(), Year = integer(), ManagedAreaName = character(), PercentLiveMethod = character(), reefIDcrosswalk = factor(), rc_quad_yrmo = character(), Region.y = character(), MA_plotlab = character(), RelYear = integer(), PercentLive_pct = numeric(), LiveObs = logical())
for(i in 1:nrow(grm_p)){
  dat_i <- grm_p[i, c("ProgramID", "ProgramLocationID", "QuadIdentifier", "Year", "ManagedAreaName", "PercentLiveMethod", "reefIDcrosswalk", "rc_quad_yrmo", "Region.y", "MA_plotlab", "RelYear", "PercentLive_pct")]
  dat_l <- purrr::map_dfr(seq_len(round(dat_i$PercentLive_pct[1], digits = 0)), ~dat_i[, LiveObs := 1])
  dat_nl <- purrr::map_dfr(seq_len((100 - round(dat_i$PercentLive_pct[1], digits = 0))), ~dat_i[, LiveObs := 0])
  dat <- rbind(dat_l, dat_nl)
  grm_p_binom <- rbind(grm_p_binom, dat)
}
saveRDS(grm_p_binom, here::here(paste0('GLMMs/AllDates/Data/grm_p_binom_', Sys.Date(), '.rds')))

grm_pct_glmm <- brm(formula = PercentLive_pct ~ RelYear + QuadSize_m2 + (1 + RelYear|reefIDcrosswalk), data = grm_p, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
grm_pct_glmm <- add_criterion(grm_pct_glmm, "loo")

ggplot(grm_p, aes(x = RelYear, y = PercentLive_pct, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(grm_p, aes(x = RelYear, y = factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(grm_p, aes(x = RelYear, y = reefIDcrosswalk, color = factor(ProgramID))) +
  geom_point() +
  theme_bw() #+
  #theme(legend.position = "none")

grm_pct_glmm1 <- brm(formula = PercentLive_pct ~ 1, data = grm_p, family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_pct_glmm1.rds")
grm_pct_glmm1 <- add_criterion(grm_pct_glmm1, "loo")

grm_pct_glmm1b <- brm(formula = PercentLive_dec ~ 1, data = subset(grm_p, grm_p$PercentLive_dec > 0), family = Beta, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_pct_glmm1b.rds")
grm_pct_glmm1b <- add_criterion(grm_pct_glmm1b, "loo")

#I think logistic regression is the best fit for the percent cover data (0/1 outcomes x 100 "trials" for each quad)
grm_pct_glmm1c <- brm(formula = LiveObs ~ 1, data = grm_p_binom, family = bernoulli, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_pct_glmm1c.rds")
grm_pct_glmm1c <- add_criterion(grm_pct_glmm1c, "loo")

grm_pct_glmm2 <- brm(formula = LiveObs ~ RelYear, data = grm_p_binom, family = bernoulli, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_pct_glmm2.rds")
grm_pct_glmm2 <- add_criterion(grm_pct_glmm2, "loo")

grm_pct_glmm3 <- brm(formula = LiveObs ~ RelYear + (1 | reefIDcrosswalk), data = grm_p_binom, family = bernoulli, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_pct_glmm3.rds")
grm_pct_glmm3 <- add_criterion(grm_pct_glmm3, "loo")

grm_pct_glmm4 <- brm(formula = LiveObs ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = grm_p_binom, family = bernoulli, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_pct_glmm4.rds")
grm_pct_glmm4 <- add_criterion(grm_pct_glmm4, "loo")

#Didn't realize Guana River included some Tolomato River sites; Region.y is significant.
grm_pct_glmm5 <- brm(formula = LiveObs ~ Region.y, data = grm_p_binom, family = bernoulli, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_pct_glmm5.rds")
grm_pct_glmm5 <- add_criterion(grm_pct_glmm5, "loo")

#Adding Region.y to GLMM3
grm_pct_glmm6 <- brm(formula = LiveObs ~ RelYear + Region.y + (1 | reefIDcrosswalk), data = grm_p_binom, family = bernoulli, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/grm_pct_glmm6.rds")
grm_pct_glmm6 <- add_criterion(grm_pct_glmm6, "loo")

#GLMM 3 is the best fit.
loo_compare(grm_pct_glmm1c, grm_pct_glmm2, grm_pct_glmm3, grm_pct_glmm4, grm_pct_glmm5, grm_pct_glmm6)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
grm_p <- subset(oysterraw_pct_nona, oysterraw_pct_nona$MA_plotlab == "Guana River Marsh_Natural")
grm_p[, QuadSize_m2 := as.factor(QuadSize_m2)]
grm_p[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
grm_p[, RelYear := Year - min(Year)]
grm_p[, PercentLive_dec := PercentLive_pct/100]
grm_p[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", Year, "-", Month)]

grm_p_binom <- data.table(ProgramID = character(), ProgramLocationID = character(), QuadIdentifier = character(), Year = integer(), ManagedAreaName = character(), PercentLiveMethod = character(), reefIDcrosswalk = factor(), rc_quad_yrmo = character(), Region.y = character(), MA_plotlab = character(), RelYear = integer(), PercentLive_pct = numeric(), LiveObs = logical())
for(i in 1:nrow(grm_p)){
  dat_i <- grm_p[i, c("ProgramID", "ProgramLocationID", "QuadIdentifier", "Year", "ManagedAreaName", "PercentLiveMethod", "reefIDcrosswalk", "rc_quad_yrmo", "Region.y", "MA_plotlab", "RelYear", "PercentLive_pct")]
  dat_l <- purrr::map_dfr(seq_len(round(dat_i$PercentLive_pct[1], digits = 0)), ~dat_i[, LiveObs := 1])
  dat_nl <- purrr::map_dfr(seq_len((100 - round(dat_i$PercentLive_pct[1], digits = 0))), ~dat_i[, LiveObs := 0])
  dat <- rbind(dat_l, dat_nl)
  grm_p_binom <- rbind(grm_p_binom, dat)
}

grm_pct_glmm <- readRDS(here::here('GLMMs/AllDates/grm_pct_glmm3.rds'))

```

##### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

grm_p[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
grm_p[, SampleDay := day(SampleDate)]


pct_t <- copy(grm_p[0, ])
pct_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(grm_p$Month))){
  mo <- subset(grm_p, as.numeric(grm_p$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  pct_t <- rbind(mo, pct_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(pct_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(pct_t, monthnames, SampleDatesPlot)

```

<br><br><br>

##### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
pct_status <- subset(grm_p, grm_p$Year %in% StatusYears)
pct_status[, `:=` (Indicator = "Percent Live", 
                       SizeClass = "All", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(PercentLive_pct),
                       Median = median(PercentLive_pct),
                       Mean = round(mean(PercentLive_pct), digits = 2),
                       SD = round(sd(PercentLive_pct), digits = 2), 
                       Min. = min(PercentLive_pct),
                       Max. = max(PercentLive_pct)),
                by = Year]

pct_status <- unique(pct_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
pct_status <- pct_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, pct_status$Year) == FALSE){
  for(i in setdiff(StatusYears, pct_status$Year)){
    MissingYr_i <- data.table(Indicator = "Percent Live", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    pct_status <- rbind(pct_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(grm_sho75, grm_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, pct_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, pct_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

##### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(grm_p, aes(x = RelYear, y = PercentLive_pct, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(grm_p, aes(x = RelYear, y = factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(grm_p, aes(x = RelYear, y = reefIDcrosswalk, color = factor(ProgramID))) +
  geom_point() +
  theme_bw() #+
  #theme(legend.position = "none")

```

<br><br><br>

##### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(grm_pct_glmm)
```

<br><br><br>

##### Diagnostic Plots

###### Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Pct_AllDates_GLMM_GRM_PDistandMChains_raw <- plot(grm_pct_glmm)
Pct_AllDates_GLMM_GRM_PDistandMChains_raw

len <- length(Pct_AllDates_GLMM_GRM_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Pct_AllDates_GLMM_GRM_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Pct_AllDates_GLMM_GRM_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

###### Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Pct_AllDates_GLMM_GRM_PPcheck_raw <- pp_check(grm_pct_glmm)
Pct_AllDates_GLMM_GRM_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_GLMM_GRM_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_GLMM_GRM_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

##### Marginal Effects Plots

###### Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
set.seed(987)
grm_p1 <- plot(conditional_effects(grm_pct_glmm, re_formula = NULL), plot = FALSE)[[1]]
Pct_AllDates_GLMM_GRM_MEPrand_raw <- grm_p1 +
  geom_jitter(data = grm_p, aes(x = RelYear, y = PercentLive_dec, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = grm_p, aes(y = -0.05, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(xlim = c(-0.5,6.5), ylim = c(-0.05, 1)) +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13), 
    legend.position = "none") +labs(colour = NULL)
Pct_AllDates_GLMM_GRM_MEPrand_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_GLMM_GRM_MEPrand_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_GLMM_GRM_MEPrand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
set.seed(986)
grm_p2 <- plot(conditional_effects(grm_pct_glmm, re_formula = NA), plot = FALSE)[[1]]
Pct_AllDates_GLMM_GRM_MEPnorand_raw <- grm_p2 +
  geom_jitter(data = grm_p, aes(x = RelYear, y = PercentLive_dec, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = grm_p, aes(y = -0.05, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(xlim = c(-0.5,6.5), ylim = c(-0.05, 1)) +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13), 
    legend.position = "none") +labs(colour = NULL)
Pct_AllDates_GLMM_GRM_MEPnorand_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_GLMM_GRM_MEPnorand_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_GLMM_GRM_MEPnorand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"}
#Individual effects plots
Pct_AllDates_GLMM_GRM_IEP_raw <- grm_p %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(grm_pct_glmm) %>%
  ggplot(aes(x = RelYear, y = PercentLive_pct, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = grm_p) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  theme_bw() +
  facet_wrap(~ reefIDcrosswalk, ncol = 3)
Pct_AllDates_GLMM_GRM_IEP_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_GLMM_GRM_IEP_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_GLMM_GRM_IEP_raw,
       width = 10,
       height = 49,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(grm_p, grm_pct_glmm, 
   Pct_AllDates_GLMM_GRM_PDistandMChains_raw,
   Pct_AllDates_GLMM_GRM_PPcheck_raw,
   Pct_AllDates_GLMM_GRM_MEPrand_raw,
   Pct_AllDates_GLMM_GRM_MEPnorand_raw,
   Pct_AllDates_GLMM_GRM_IEP_raw
   )

```

<br><br><br>

#### Guana Tolomato Matanzas NERR_Natural {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

gtmn_p <- subset(oysterraw_pct_nona, oysterraw_pct_nona$MA_plotlab == "Guana Tolomato Matanzas NERR_Natural")
gtmn_p[, QuadSize_m2 := as.factor(QuadSize_m2)]
gtmn_p[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
gtmn_p[, RelYear := Year - min(Year)]
gtmn_p[, PercentLive_dec := PercentLive_pct/100]
gtmn_p[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", Year, "-", Month)]
saveRDS(gtmn_p, here::here(paste0('GLMMs/AllDates/Data/gtmn_p_', Sys.Date(), '.rds')))

gtmn_p_binom <- data.table(ProgramID = character(), ProgramLocationID = character(), QuadIdentifier = character(), Year = integer(), ManagedAreaName = character(), PercentLiveMethod = character(), reefIDcrosswalk = factor(), rc_quad_yrmo = character(), Region.y = character(), MA_plotlab = character(), RelYear = integer(), PercentLive_pct = numeric(), LiveObs = logical())
for(i in 1:nrow(gtmn_p)){
  dat_i <- gtmn_p[i, c("ProgramID", "ProgramLocationID", "QuadIdentifier", "Year", "ManagedAreaName", "PercentLiveMethod", "reefIDcrosswalk", "rc_quad_yrmo", "Region.y", "MA_plotlab", "RelYear", "PercentLive_pct")]
  dat_l <- purrr::map_dfr(seq_len(round(dat_i$PercentLive_pct[1], digits = 0)), ~dat_i[, LiveObs := 1])
  dat_nl <- purrr::map_dfr(seq_len((100 - round(dat_i$PercentLive_pct[1], digits = 0))), ~dat_i[, LiveObs := 0])
  dat <- rbind(dat_l, dat_nl)
  gtmn_p_binom <- rbind(gtmn_p_binom, dat)
}
saveRDS(gtmn_p_binom, here::here(paste0('GLMMs/AllDates/Data/gtmn_p_binom_', Sys.Date(), '.rds')))

gtmn_pct_glmm <- brm(formula = PercentLive_pct ~ RelYear + QuadSize_m2 + Region.y + (1 + RelYear|reefIDcrosswalk), data = gtmn_p, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
gtmn_pct_glmm <- add_criterion(gtmn_pct_glmm, "loo")

ggplot(subset(gtmn_p, gtmn_p$Region.y == "Fort Matanzas"), aes(x = RelYear, y = PercentLive_pct, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(gtmn_p, aes(x = RelYear, y = factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(gtmn_p, aes(x = RelYear, y = Region.y, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

gtmn_pct_glmm1 <- brm(formula = PercentLive_pct ~ 1, data = gtmn_p, family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_pct_glmm1.rds")
gtmn_pct_glmm1 <- add_criterion(gtmn_pct_glmm1, "loo")

gtmn_pct_glmm1b <- brm(formula = PercentLive_dec ~ 1, data = subset(gtmn_p, gtmn_p$PercentLive_dec > 0), family = Beta, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_pct_glmm1b.rds")
gtmn_pct_glmm1b <- add_criterion(gtmn_pct_glmm1b, "loo")

#I think logistic regression is the best fit for the percent cover data (0/1 outcomes x 100 "trials" for each quad)
gtmn_pct_glmm1c <- brm(formula = LiveObs ~ 1, data = gtmn_p_binom, family = bernoulli, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_pct_glmm1c.rds")
gtmn_pct_glmm1c <- add_criterion(gtmn_pct_glmm1c, "loo")

gtmn_pct_glmm2 <- brm(formula = LiveObs ~ RelYear, data = gtmn_p_binom, family = bernoulli, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_pct_glmm2.rds")
gtmn_pct_glmm2 <- add_criterion(gtmn_pct_glmm2, "loo")

gtmn_pct_glmm3 <- brm(formula = LiveObs ~ Region.y, data = gtmn_p_binom, family = bernoulli, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_pct_glmm3.rds")
gtmn_pct_glmm3 <- add_criterion(gtmn_pct_glmm3, "loo")

gtmn_pct_glmm4 <- brm(formula = LiveObs ~ RelYear + Region.y + (1 | reefIDcrosswalk), data = gtmn_p_binom, family = bernoulli, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_pct_glmm4.rds")
gtmn_pct_glmm4 <- add_criterion(gtmn_pct_glmm4, "loo")

#Aborted model run because several minutes had gone by without a chain showing progress.
gtmn_pct_glmm5 <- brm(formula = LiveObs ~ RelYear + Region.y + (0 + RelYear | reefIDcrosswalk), data = gtmn_p_binom, family = bernoulli, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_pct_glmm5.rds")
gtmn_pct_glmm5 <- add_criterion(gtmn_pct_glmm5, "loo")

gtmn_pct_glmm6 <- brm(formula = LiveObs ~ RelYear + Region.y + RelYear:Region.y + (1 | reefIDcrosswalk), data = gtmn_p_binom, family = bernoulli, cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(3), file = "GLMMs/AllDates/gtmn_pct_glmm6.rds")
gtmn_pct_glmm6 <- add_criterion(gtmn_pct_glmm6, "loo")

gtmn_pct_glmm7 <- brm(formula = LiveObs ~ RelYear + Region.y + RelYear:Region.y + (0 + RelYear | reefIDcrosswalk), data = gtmn_p_binom, family = bernoulli, cores = 4, control = list(adapt_delta = 0.8, max_treedepth = 10), iter = 3000, warmup = 1000, chains = 4, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/gtmn_pct_glmm7.rds")
gtmn_pct_glmm7 <- add_criterion(gtmn_pct_glmm7, "loo")

#GLMM 6 is the best fit.
loo_compare(gtmn_pct_glmm4, gtmn_pct_glmm6, gtmn_pct_glmm7)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
gtmn_p <- subset(oysterraw_pct_nona, oysterraw_pct_nona$MA_plotlab == "Guana Tolomato Matanzas NERR_Natural")
gtmn_p[, QuadSize_m2 := as.factor(QuadSize_m2)]
gtmn_p[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
gtmn_p[, RelYear := Year - min(Year)]
gtmn_p[, PercentLive_dec := PercentLive_pct/100]
gtmn_p[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", Year, "-", Month)]
saveRDS(gtmn_p, here::here(paste0('GLMMs/AllDates/Data/gtmn_p_', Sys.Date(), '.rds')))

gtmn_p_binom <- data.table(ProgramID = character(), ProgramLocationID = character(), QuadIdentifier = character(), Year = integer(), ManagedAreaName = character(), PercentLiveMethod = character(), reefIDcrosswalk = factor(), rc_quad_yrmo = character(), Region.y = character(), MA_plotlab = character(), RelYear = integer(), PercentLive_pct = numeric(), LiveObs = logical())
for(i in 1:nrow(gtmn_p)){
  dat_i <- gtmn_p[i, c("ProgramID", "ProgramLocationID", "QuadIdentifier", "Year", "ManagedAreaName", "PercentLiveMethod", "reefIDcrosswalk", "rc_quad_yrmo", "Region.y", "MA_plotlab", "RelYear", "PercentLive_pct")]
  dat_l <- purrr::map_dfr(seq_len(round(dat_i$PercentLive_pct[1], digits = 0)), ~dat_i[, LiveObs := 1])
  dat_nl <- purrr::map_dfr(seq_len((100 - round(dat_i$PercentLive_pct[1], digits = 0))), ~dat_i[, LiveObs := 0])
  dat <- rbind(dat_l, dat_nl)
  gtmn_p_binom <- rbind(gtmn_p_binom, dat)
}
saveRDS(gtmn_p_binom, here::here(paste0('GLMMs/AllDates/Data/gtmn_p_binom_', Sys.Date(), '.rds')))

gtmn_pct_glmm <- readRDS(here::here('GLMMs/AllDates/gtmn_pct_glmm6.rds'))

```

##### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

gtmn_p[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
gtmn_p[, SampleDay := day(SampleDate)]


pct_t <- copy(gtmn_p[0, ])
pct_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(gtmn_p$Month))){
  mo <- subset(gtmn_p, as.numeric(gtmn_p$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  pct_t <- rbind(mo, pct_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(pct_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(pct_t, monthnames, SampleDatesPlot)

```

<br><br><br>

##### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
pct_status <- subset(gtmn_p, gtmn_p$Year %in% StatusYears)
pct_status[, `:=` (Indicator = "Percent Live", 
                       SizeClass = "All", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(PercentLive_pct),
                       Median = median(PercentLive_pct),
                       Mean = round(mean(PercentLive_pct), digits = 2),
                       SD = round(sd(PercentLive_pct), digits = 2), 
                       Min. = min(PercentLive_pct),
                       Max. = max(PercentLive_pct)),
                by = Year]

pct_status <- unique(pct_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
pct_status <- pct_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, pct_status$Year) == FALSE){
  for(i in setdiff(StatusYears, pct_status$Year)){
    MissingYr_i <- data.table(Indicator = "Percent Live", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    pct_status <- rbind(pct_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(gtmn_sho75, gtmn_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, pct_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, pct_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

##### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(subset(gtmn_p, gtmn_p$Region.y == "Fort Matanzas"), aes(x = RelYear, y = PercentLive_pct, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

ggplot(gtmn_p, aes(x = RelYear, y = factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(gtmn_p, aes(x = RelYear, y = Region.y, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw() +
  theme(legend.position = "none")

```

<br><br><br>

##### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(gtmn_pct_glmm)
```

<br><br><br>

##### Diagnostic Plots

###### Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Pct_AllDates_GLMM_GTMNERR_PDistandMChains_raw <- plot(gtmn_pct_glmm)
Pct_AllDates_GLMM_GTMNERR_PDistandMChains_raw

len <- length(Pct_AllDates_GLMM_GTMNERR_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Pct_AllDates_GLMM_GTMNERR_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Pct_AllDates_GLMM_GTMNERR_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

###### Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Pct_AllDates_GLMM_GTMNERR_PPcheck_raw <- pp_check(gtmn_pct_glmm)
Pct_AllDates_GLMM_GTMNERR_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_GLMM_GTMNERR_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_GLMM_GTMNERR_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

##### Marginal Effects Plots

###### Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
set.seed(987)
gtmn_p1 <- plot(conditional_effects(gtmn_pct_glmm, re_formula = NULL), plot = FALSE)[[1]]
Pct_AllDates_GLMM_GTMNERR_MEPrand_raw <- gtmn_p1 +
  geom_jitter(data = gtmn_p, aes(x = RelYear, y = PercentLive_dec, fill = Region.y), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = gtmn_p, aes(y = -0.05, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(xlim = c(-0.5,6.5), ylim = c(-0.05, 1)) +
  labs(fill = "Region") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Pct_AllDates_GLMM_GTMNERR_MEPrand_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_GLMM_GTMNERR_MEPrand_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_GLMM_GTMNERR_MEPrand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
meanPct <- plot(conditional_effects(gtmn_pct_glmm, re_formula = NULL), plot = FALSE)[[2]]$data
setnames(meanPct, "effect1__", "Region")

Pct_AllDates_GLMM_GTMNERR_MEPrand_raw_MeanRes <- ggplot(meanPct, aes(x = Region, y = estimate__, ymin = lower__, ymax = upper__)) +
  geom_pointinterval(fill = "black", size = 3, fatten_point = 4, shape = 21, color = "black") +
  ylab("PercentLive_dec") +
  theme_bw()  + 
  theme(axis.title = element_text(size = 13), 
        axis.text = element_text(size = 12), 
        legend.text = element_text(size = 12), 
        legend.title = element_text(size = 13))+labs(fill = NULL)
Pct_AllDates_GLMM_GTMNERR_MEPrand_raw_MeanRes

ggsave(here::here(paste0("OA_plots/Pct_AllDates_GLMM_GTMNERR_MEPrand_raw_MeanRes_", Sys.Date(), ".jpeg")),
       Pct_AllDates_GLMM_GTMNERR_MEPrand_raw_MeanRes,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)

```

<br><br><br>

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=10, fig.width=10, out.width="100%"}
RelYrbyRegion <- plot(conditional_effects(gtmn_pct_glmm, re_formula = NULL), plot = FALSE)[[3]]
#setnames(meanDen_raw, "effect1__", "Region")

Pct_AllDates_GLMM_GTMNERR_MEPrand_raw_RelYrbyRegion <- RelYrbyRegion +
  geom_point(data = gtmn_p, aes(x = RelYear, y = PercentLive_dec, fill = Region.y), alpha = 0.5, shape = 21, size = 3, color = "black", inherit.aes = FALSE) +
  geom_text(data = gtmn_p, aes(y = 0, label = "2020", x = 6), size = 4, col = "grey30", inherit.aes = FALSE) +
  scale_x_continuous(limits = c(0, max(gtmn_p$RelYear) + 1)) +
  #ylab("Density_m2") +
  theme_bw()  + 
  theme(axis.title = element_text(size = 13), 
        axis.text = element_text(size = 12), 
        legend.text = element_text(size = 12), 
        legend.title = element_text(size = 13), 
        legend.position = "none") +
  facet_wrap(~ Region.y, ncol = 3, scales = "free")
Pct_AllDates_GLMM_GTMNERR_MEPrand_raw_RelYrbyRegion

ggsave(here::here(paste0("OA_plots/Pct_AllDates_GLMM_GTMNERR_MEPrand_raw_RelYrbyRegion_", Sys.Date(), ".jpeg")),
       Pct_AllDates_GLMM_GTMNERR_MEPrand_raw_RelYrbyRegion,
       width = 10,
       height = 10,
       units = "in",
       dpi = 300)

```

<br><br><br>

###### Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
set.seed(988)
gtmn_p2 <- plot(conditional_effects(gtmn_pct_glmm, re_formula = NA), plot = FALSE)[[1]]
Pct_AllDates_GLMM_GTMNERR_MEPnorand_raw <- gtmn_p2 +
  geom_jitter(data = gtmn_p, aes(x = RelYear, y = PercentLive_dec, fill = Region.y), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = gtmn_p, aes(y = -0.05, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(xlim = c(-0.5,6.5), ylim = c(-0.05, 1)) +
  labs(fill = "Region") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Pct_AllDates_GLMM_GTMNERR_MEPnorand_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_GLMM_GTMNERR_MEPnorand_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_GLMM_GTMNERR_MEPnorand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=80, fig.width=10, out.width="100%"}
#Individual effects plots
Pct_AllDates_GLMM_GTMNERR_IEP_raw <- gtmn_p %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(gtmn_pct_glmm) %>%
  ggplot(aes(x = RelYear, y = PercentLive_dec, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = gtmn_p) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = gtmn_p, aes(y = -0.08, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(gtmn_p$RelYear) + 1)) +
  scale_y_continuous(limits = c(-0.11, 1)) +
  #coord_cartesian(ylim = c(-40, 150)) +
  guides(color = FALSE) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 3, scales = "free")
Pct_AllDates_GLMM_GTMNERR_IEP_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_GLMM_GTMNERR_IEP_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_GLMM_GTMNERR_IEP_raw,
       width = 10,
       height = 80,
       units = "in",
       dpi = 300,
       limitsize = FALSE)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(gtmn_p, gtmn_pct_glmm, 
   Pct_AllDates_GLMM_GTMNERR_PDistandMChains_raw,
   Pct_AllDates_GLMM_GTMNERR_PPcheck_raw,
   Pct_AllDates_GLMM_GTMNERR_MEPrand_raw,
   Pct_AllDates_GLMM_GTMNERR_MEPnorand_raw,
   Pct_AllDates_GLMM_GTMNERR_IEP_raw
   )

```

<br><br><br>

#### Lemon Bay {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

lb_p <- subset(oysterraw_pct_nona, oysterraw_pct_nona$MA_plotlab == "Lemon Bay_Natural")
lb_p[, QuadSize_m2 := as.factor(QuadSize_m2)]
#lb_p[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
lb_p[, RelYear := Year - min(Year)]
lb_p[, PercentLive_dec := PercentLive_pct/100]
#lb_p[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", Year, "-", Month)]
saveRDS(lb_p, here::here(paste0('GLMMs/AllDates/Data/lb_p_', Sys.Date(), '.rds')))

# lb_pct_glmm <- brm(formula = PercentLive_pct ~ RelYear + QuadSize_m2 + (1 + RelYear|reefIDcrosswalk), data = lb_p, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# lb_pct_glmm <- add_criterion(lb_pct_glmm, "loo")

ggplot(lb_p, aes(x = RelYear, y = PercentLive_dec, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw()

ggplot(lb_p, aes(x = RelYear, y = QuadSize_m2, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw()

ggplot(lb_p, aes(x = RelYear, y = reefIDcrosswalk, color = factor(ProgramID))) +
  geom_point() +
  theme_bw()

#Model converged, intercept significant. 
lb_pct_glmm1 <- brm(formula = PercentLive_dec ~ 1, data = lb_p, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_pct_glmm1.rds")
lb_pct_glmm1 <- add_criterion(lb_pct_glmm1, "loo")

lb_pct_glmm2 <- brm(formula = PercentLive_dec ~ 1, data = subset(lb_p, lb_p$PercentLive_dec > 0), family = Beta, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_pct_glmm2.rds")
lb_pct_glmm2 <- add_criterion(lb_pct_glmm2, "loo")

lb_pct_glmm3 <- brm(formula = PercentLive_dec ~ 1, data = subset(lb_p, lb_p$PercentLive_dec > 0), family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_pct_glmm3.rds")
lb_pct_glmm3 <- add_criterion(lb_pct_glmm3, "loo")

#Beta distribution (GLMM 2) is the better fit, but note that this required dropping the one zero-value data point.
loo_compare(lb_pct_glmm2, lb_pct_glmm3)

#Model converged, RelYear was significant.
lb_pct_glmm4 <- brm(formula = PercentLive_dec ~ RelYear, data = subset(lb_p, lb_p$PercentLive_dec > 0), family = Beta, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_pct_glmm4.rds")
lb_pct_glmm4 <- add_criterion(lb_pct_glmm4, "loo")

#Model converged, RelYear was not significant.
lb_pct_glmm5 <- brm(formula = PercentLive_dec ~ RelYear + (1 | ReefIdentifier), data = subset(lb_p, lb_p$PercentLive_dec > 0), family = Beta, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_pct_glmm5.rds")
lb_pct_glmm5 <- add_criterion(lb_pct_glmm5, "loo")

#Model converged, RelYear was not significant.
lb_pct_glmm6 <- brm(formula = PercentLive_dec ~ RelYear + (0 + RelYear | ReefIdentifier), data = subset(lb_p, lb_p$PercentLive_dec > 0), family = Beta, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/AllDates/lb_pct_glmm6.rds")
lb_pct_glmm6 <- add_criterion(lb_pct_glmm6, "loo")

#GLMM 6 is the best fit.
loo_compare(lb_pct_glmm4, lb_pct_glmm5, lb_pct_glmm6)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
lb_p <- subset(oysterraw_pct_nona, oysterraw_pct_nona$MA_plotlab == "Lemon Bay_Natural")
lb_p[, QuadSize_m2 := as.numeric(QuadSize_m2)]
lb_p[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
lb_p[, RelYear := Year - min(Year)]
lb_p[, PercentLive_dec := PercentLive_pct/100]
lb_p[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", Year, "-", Month)]
saveRDS(lb_p, here::here(paste0('GLMMs/AllDates/Data/lb_p_', Sys.Date(), '.rds')))

lb_pct_glmm <- readRDS(here::here('GLMMs/AllDates/lb_pct_glmm6.rds'))

```

##### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

lb_p[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
lb_p[, SampleDay := day(SampleDate)]


pct_t <- copy(lb_p[0, ])
pct_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(lb_p$Month))){
  mo <- subset(lb_p, as.numeric(lb_p$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  pct_t <- rbind(mo, pct_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(pct_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(pct_t, monthnames, SampleDatesPlot)

```

<br><br><br>

##### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
pct_status <- subset(lb_p, lb_p$Year %in% StatusYears)
pct_status[, `:=` (Indicator = "Percent Live", 
                       SizeClass = "All", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(PercentLive_pct),
                       Median = median(PercentLive_pct),
                       Mean = round(mean(PercentLive_pct), digits = 2),
                       SD = round(sd(PercentLive_pct), digits = 2), 
                       Min. = min(PercentLive_pct),
                       Max. = max(PercentLive_pct)),
                by = Year]

pct_status <- unique(pct_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
pct_status <- pct_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, pct_status$Year) == FALSE){
  for(i in setdiff(StatusYears, pct_status$Year)){
    MissingYr_i <- data.table(Indicator = "Percent Live", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    pct_status <- rbind(pct_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(lb_sho75, lb_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, pct_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, pct_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

##### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(lb_p, aes(x = RelYear, y = PercentLive_dec, color = ReefIdentifier)) +
  geom_jitter() +
  theme_bw()

ggplot(lb_p, aes(x = RelYear, y = QuadSize_m2, color = ReefIdentifier)) +
  geom_jitter() +
  theme_bw()

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(lb_p, aes(x = RelYear, y = ReefIdentifier, color = factor(ProgramID))) +
  geom_point() +
  theme_bw()

```

<br><br><br>

##### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(lb_pct_glmm)
```

<br><br><br>

##### Diagnostic Plots

###### Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Pct_AllDates_GLMM_LB_PDistandMChains_raw <- plot(lb_pct_glmm)
Pct_AllDates_GLMM_LB_PDistandMChains_raw

len <- length(Pct_AllDates_GLMM_LB_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Pct_AllDates_GLMM_LB_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Pct_AllDates_GLMM_LB_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

###### Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Pct_AllDates_GLMM_LB_PPcheck_raw <- pp_check(lb_pct_glmm)
Pct_AllDates_GLMM_LB_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_GLMM_LB_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_GLMM_LB_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

##### Marginal Effects Plots

###### Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
set.seed(987)
lb_p1 <- plot(conditional_effects(lb_pct_glmm, re_formula = NULL), plot = FALSE)[[1]]
Pct_AllDates_GLMM_LB_MEPrand_raw <- lb_p1 +
  geom_jitter(data = lb_p, aes(x = RelYear, y = PercentLive_dec, fill = ReefIdentifier), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = lb_p, aes(y = -0.05, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(aes(y = 0.03, label = "Note: zero-value data points were \n excluded from the model fit", x = 3), size = 3, col = "grey60", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(xlim = c(-0.5,10.5), ylim = c(-0.05, 1)) +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Pct_AllDates_GLMM_LB_MEPrand_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_GLMM_LB_MEPrand_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_GLMM_LB_MEPrand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
set.seed(984)
lb_p2 <- plot(conditional_effects(lb_pct_glmm, re_formula = NA), plot = FALSE)[[1]]
Pct_AllDates_GLMM_LB_MEPnorand_raw <- lb_p2 +
  geom_jitter(data = lb_p, aes(x = RelYear, y = PercentLive_dec, fill = ReefIdentifier), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = lb_p, aes(y = -0.05, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  geom_text(aes(y = 0.03, label = "Note: zero-value data points were \n excluded from the model fit", x = 3), size = 3, col = "grey60", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(xlim = c(-0.5,10.5), ylim = c(-0.05, 1)) +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Pct_AllDates_GLMM_LB_MEPnorand_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_GLMM_LB_MEPnorand_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_GLMM_LB_MEPnorand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=10, fig.width=10, out.width="100%"}
#Individual effects plots
labs1 <- sort(unique(lb_p$Year))[c(FALSE, TRUE)]

Pct_AllDates_GLMM_LB_IEP_raw <- lb_p %>%
  group_by(ReefIdentifier) %>%
  add_fitted_draws(lb_pct_glmm) %>%
  ggplot(aes(x = RelYear, y = PercentLive_dec, color = ReefIdentifier)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = lb_p) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(lb_p, lb_p$Year %in% labs1), aes(y = -0.12, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(lb_p$RelYear) + 1)) +
  scale_y_continuous(limits = c(-0.17, 1)) +
  #coord_cartesian(ylim = c(-40, 150)) +
  guides(color = FALSE) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ ReefIdentifier, ncol = 3, scales = "free")
Pct_AllDates_GLMM_LB_IEP_raw

ggsave(here::here(paste0("OA_plots/Pct_AllDates_GLMM_LB_IEP_raw_", Sys.Date(), ".jpeg")),
       Pct_AllDates_GLMM_LB_IEP_raw,
       width = 10,
       height = 10,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(lb_p, lb_pct_glmm, 
   Pct_AllDates_GLMM_LB_PDistandMChains_raw,
   Pct_AllDates_GLMM_LB_PPcheck_raw,
   Pct_AllDates_GLMM_LB_MEPrand_raw,
   Pct_AllDates_GLMM_LB_MEPnorand_raw,
   Pct_AllDates_GLMM_LB_IEP_raw
   )

```

<br><br><br>

***

# Non-recruitment Sample Dates Only

```{r}
#Add a column for season (initially chosen to allow isolating the Jan-Mar non-recruitment season based on Steve Geiger's recommendation, but there was < 5 years of data for all managed areas for shell height and percent live, and only one managed area with at least 5 years of data for density when using those criteria, so I tried November to March instead, which is the non-recruitment season recommended by Nikki Dix.)
#oysterraw_nr <- oysterraw[, JantoMar := ifelse(Month == 1 | Month == 2 | Month == 3, 1, 0)]
#oysterraw <- oysterraw_nr[JantoMar == 1, ]

oysterraw_nr <- oysterraw[, NovtoMar := ifelse(Month == 11 | Month == 12 | Month == 1 | Month == 2 | Month == 3, 1, 0)]
oysterraw_nr <- oysterraw_nr[NovtoMar == 1, ]
```

```{r Indicator-data-subsets-nr, echo=TRUE, message = FALSE, warning = FALSE}
# Separate oyster data into broad categories by indicator

#Reformat dataframe so that metadata rows are not duplicated for each data column. Based on solution posted here: https://stackoverflow.com/questions/54132853/how-to-collapse-a-dataframe-with-duplicate-ids-and-varying-missing-values-per-id


#oysterraw_sh_nr <- oysterraw_nr[, c(2:24, 27, 32:35)] %>%
oysterraw_sh_nr <- oysterraw_nr[, c("ProgramID", "ProgramName", "ProgramLocationID", "QuadIdentifier", "ReefIdentifier", "LiveDate", "LiveDate_Qualifier", "LiveDate_MinEstDate", "LiveDate_MaxEstDate", "GISUniqueID", "SampleDate", "Year", "Month", "ManagedAreaName", "Region.x", "SurveyMethod", "HabitatClassification", "MinimumSizeMeasured_mm", "NumberMeasured_n", "QuadSize_m2", "MADup", "DataFileName", "ShellHeight_mm", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "SHIndex")] 
oysterraw_sh_nr <- oysterraw_sh_nr %>%
            dplyr::group_by(ProgramID, ProgramName, ProgramLocationID, QuadIdentifier, ReefIdentifier, 
                            LiveDate, LiveDate_Qualifier, LiveDate_MinEstDate, LiveDate_MaxEstDate, 
                            GISUniqueID, SampleDate, Year, Month, ManagedAreaName, Region.x, SurveyMethod, 
                            HabitatClassification, MinimumSizeMeasured_mm, NumberMeasured_n, QuadSize_m2, 
                            MADup, DataFileName, reefIDcrosswalk, Region.y, MA_plotlab, Subtidal) %>%
            tidyr::fill(ShellHeight_mm, SHIndex) %>%
            tidyr::fill(ShellHeight_mm, SHIndex, .direction = 'up') %>%
            dplyr::distinct()
oysterraw_sh_nr <- subset(oysterraw_sh_nr, !is.na(oysterraw_sh_nr$ShellHeight_mm) | !is.na(oysterraw_sh_nr$SHIndex))


#Create data table of density and counts
#oysterraw_den_nr <- oysterraw_nr[, c(2:6, 11:17, 19, 22:23, 25, 28:30, 32:35)]
oysterraw_den_nr <- oysterraw_nr[, c("ProgramID", "ProgramName", "ProgramLocationID", "QuadIdentifier", "ReefIdentifier", "GISUniqueID", "SampleDate", "Year", "Month", "ManagedAreaName", "Region.x", "SurveyMethod", "HabitatClassification", "QuadSize_m2", "MADup", "Density_m2", "Number_of_Oysters_Counted_Total_Count", "Number_of_Oysters_Counted_Live_Count", "Number_of_Oysters_Counted_Dead_Count", "DensIndex", "NTotIndex", "NLiveIndex", "NDeadIndex", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal")]
oysterraw_den_nr <- unique(oysterraw_den_nr)
oysterraw_den_nr <- oysterraw_den_nr %>% 
                     dplyr::group_by(ProgramID, ProgramName, ProgramLocationID, QuadIdentifier, 
                                     ReefIdentifier, GISUniqueID, SampleDate, Year, Month, ManagedAreaName,
                                     Region.x, SurveyMethod, HabitatClassification, QuadSize_m2, MADup, reefIDcrosswalk, 
                                     Region.y, MA_plotlab, Subtidal) %>%
                     tidyr::fill(Density_m2, Number_of_Oysters_Counted_Total_Count, 
                                 Number_of_Oysters_Counted_Live_Count, Number_of_Oysters_Counted_Dead_Count,
                                 DensIndex, NTotIndex, NLiveIndex, NDeadIndex) %>%
                     tidyr::fill(Density_m2, Number_of_Oysters_Counted_Total_Count, 
                                 Number_of_Oysters_Counted_Live_Count, Number_of_Oysters_Counted_Dead_Count, 
                                 DensIndex, NTotIndex, NLiveIndex, NDeadIndex, .direction = 'up') %>%
                     dplyr::distinct()



oysterraw_den_nr <- subset(oysterraw_den_nr, !is.na(oysterraw_den_nr$Density_m2) |
                             !is.na(oysterraw_den_nr$Number_of_Oysters_Counted_Total_Count) | 
                             !is.na(oysterraw_den_nr$Number_of_Oysters_Counted_Live_Count) | 
                             !is.na(oysterraw_den_nr$Number_of_Oysters_Counted_Dead_Count) |
                             !is.na(oysterraw_den_nr$DensIndex) | !is.na(oysterraw_den_nr$NTotIndex) |
                             !is.na(oysterraw_den_nr$NLiveIndex) | !is.na(oysterraw_den_nr$NDeadIndex))

#4/12/2021 - Adding in updated raw data for ID972 from "All_Parameters_but_Hectares-2021-Mar-12.csv" because it has MADup duplication issues that prevent me from running the script with it from the beginning.
new972_den_edited_nr <- subset(new972_den_edited, as.numeric(new972_den_edited$Month) > 10)

#setdiff(colnames(oysterraw_den_nr), colnames(new972_den_edited_nr))

oysterraw_den_nr_no972 <- subset(oysterraw_den_nr, oysterraw_den_nr$ProgramID != 972)
oysterraw_den_nr <- rbind(oysterraw_den_nr_no972, new972_den_edited_nr)


#Create data table of percent live
#oysterraw_pct_nr <- oysterraw_nr[, c(2:6, 11:17, 18:19, 22:23, 26, 28:30, 32:35)]
oysterraw_pct_nr <- oysterraw_nr[, c("ProgramID", "ProgramName", "ProgramLocationID", "QuadIdentifier", "ReefIdentifier", "GISUniqueID", "SampleDate", "Year", "Month", "ManagedAreaName", "Region.x", "SurveyMethod", "PercentLiveMethod", "HabitatClassification", "QuadSize_m2", "MADup", "PercentLive_pct", "Number_of_Oysters_Counted_Total_Count", "Number_of_Oysters_Counted_Live_Count", "Number_of_Oysters_Counted_Dead_Count", "PctIndex", "NTotIndex", "NLiveIndex", "NDeadIndex", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal")]
oysterraw_pct_nr <- unique(oysterraw_pct_nr)
oysterraw_pct_nr <- oysterraw_pct_nr %>% 
                     dplyr::group_by(ProgramID, ProgramName, ProgramLocationID, QuadIdentifier, 
                                     ReefIdentifier, GISUniqueID, SampleDate, Year, Month, ManagedAreaName,
                                     Region.x, SurveyMethod, PercentLiveMethod, HabitatClassification, QuadSize_m2, MADup, 
                                     reefIDcrosswalk, Region.y, MA_plotlab, Subtidal) %>%
                     tidyr::fill(PercentLive_pct, Number_of_Oysters_Counted_Total_Count, 
                                 Number_of_Oysters_Counted_Live_Count, Number_of_Oysters_Counted_Dead_Count, 
                                 PctIndex, NTotIndex, NLiveIndex, NDeadIndex) %>%
                     tidyr::fill(PercentLive_pct, Number_of_Oysters_Counted_Total_Count, 
                                 Number_of_Oysters_Counted_Live_Count, Number_of_Oysters_Counted_Dead_Count, 
                                 PctIndex, NTotIndex, NLiveIndex, NDeadIndex, .direction = 'up') %>%
                     dplyr::distinct()



oysterraw_pct_nr <- subset(oysterraw_pct_nr, !is.na(oysterraw_pct_nr$PercentLive_pct) |
                             !is.na(oysterraw_pct_nr$Number_of_Oysters_Counted_Total_Count) | 
                             !is.na(oysterraw_pct_nr$Number_of_Oysters_Counted_Live_Count) | 
                             !is.na(oysterraw_pct_nr$Number_of_Oysters_Counted_Dead_Count) |
                             !is.na(oysterraw_pct_nr$PctIndex) | !is.na(oysterraw_pct_nr$NTotIndex) |
                             !is.na(oysterraw_pct_nr$NLiveIndex) | !is.na(oysterraw_pct_nr$NDeadIndex))


#4/12/2021 - Adding in updated raw data for ID972 from "All_Parameters_but_Hectares-2021-Mar-12.csv" because it has MADup duplication issues that prevent me from running the script with it from the beginning.
new972_pct_edited_nr <- subset(new972_pct_edited, as.numeric(new972_pct_edited$Month) > 10)

#setdiff(colnames(oysterraw_pct_nr), colnames(new972_pct_edited_nr))

oysterraw_pct_nr_no972 <- subset(oysterraw_pct_nr, oysterraw_pct_nr$ProgramID != 972)
oysterraw_pct_nr <- rbind(oysterraw_pct_nr_no972, new972_pct_edited_nr)

```


<br><br><br>

***

## Oyster size class

```{r Process-and-summarize-shell-height-data-nr, echo=TRUE, message = FALSE, warning = FALSE}

setDT(oysterraw_sh_nr)
oysterraw_sh_nr <- oysterraw_sh_nr %>% mutate(SampleDate = mdy_hms(SampleDate)) #convert Time to a timestamp
oysterraw_sh_nr[, LiveDate2 := ifelse(LiveDate %in% "", year(SampleDate), ifelse(grepl("/", LiveDate, fixed = 
             TRUE), year(mdy(LiveDate)), ifelse(grepl("-", LiveDate, fixed = TRUE), year(ymd(LiveDate)), 
             LiveDate)))] 
oysterraw_sh_nr[, LiveDate2 := as.numeric(LiveDate2)][, ('LiveDate2') := round(.SD, 0), .SDcols = 'LiveDate2']
oysterraw_sh_nr <- oysterraw_sh_nr[!is.na(LiveDate2)]
oysterraw_sh_nr[, LiveDate2 := strptime(LiveDate2, "%Y")]
#oysterraw_sh_nr[, MinimumSizeMeasured_mm := as.integer(MinimumSizeMeasured_mm)][ProgramID == 5035, MinimumSizeMeasured_mm := 20][ProgramID == 4016, NumberMeasured_n := 50]
oysterraw_sh_nr[, LiveDate2 := year(ymd(LiveDate2))]
oysterraw_sh_nr[LiveDate_Qualifier == "Exact (for live specimens only)", LiveDate_Qualifier := "Exact"]

#Remove unrealistically high shell heights from ID_5017
Fix5017 <- oysterraw_sh_nr[ProgramID == 5017, ][ShellHeight_mm < 165, ]
no5017 <- oysterraw_sh_nr[ProgramID != 5017, ]
oysterraw_sh_nr <- rbind(Fix5017, no5017)

#save a copy for later use
saveRDS(oysterraw_sh_nr, here::here('oysterraw_sh_nr.rds'))

#summarize shell height data
sh_all_sum_nr <- summarySE(oysterraw_sh_nr, measurevar = 'ShellHeight_mm', groupvars = c('ManagedAreaName', 
                        'LiveDate_Qualifier', 'LiveDate2'))
```

```{r Subset-shell-heights-o25-and-create-summary-table-nr, echo=TRUE, message=FALSE, warning=FALSE}
#Subset to shell heights >25mm
sh_o25_nr <- oysterraw_sh_nr[ShellHeight_mm > 25, ]

sh_o25_nr[, nReefs := length(unique(reefIDcrosswalk)), by = c('ManagedAreaName', 'LiveDate_Qualifier', 'NumberMeasured_n', 'LiveDate2')]
sh_o25_nr[NumberMeasured_n != c(""), nReefsbyMAandLD_allLDQ_No20 := length(unique(reefIDcrosswalk)), by = c('ManagedAreaName', 'LiveDate2')]
sh_o25_nr[NumberMeasured_n != c(""), nProgsbyMAandLD_allLDQ_No20 := length(unique(ProgramID)), by = c('ManagedAreaName', 'LiveDate2')]
sh_o25_nr[NumberMeasured_n != c(""), ProgsbyMAandLD_allLDQ_No20 := list(list(unique(ProgramID))), by = c('ManagedAreaName', 'LiveDate2')]
sh_o25_nr[NumberMeasured_n != c(""), nProgsbyMA_allLD_allLDQ_No20 := length(unique(ProgramID)), by = c('ManagedAreaName')]
sh_o25_nr[NumberMeasured_n != c(""), ProgsbyMA_allLD_allLDQ_No20 := list(list(unique(ProgramID))), by = c('ManagedAreaName')]

#Create summary table showing number of reefs/programs of data included in sh_o25_nr
sh_o25_sum1_nr <- unique(sh_o25_nr[, .(ManagedAreaName, LiveDate2, nReefsbyMAandLD_allLDQ_No20, nProgsbyMAandLD_allLDQ_No20, nProgsbyMA_allLD_allLDQ_No20)], by = c('ManagedAreaName', 'LiveDate2', 'nReefsbyMAandLD_allLDQ_No20', 'nProgsbyMAandLD_allLDQ_No20', 'nProgsbyMA_allLD_allLDQ_No20'))
sh_o25_sum1_nr[, LiveDate := LiveDate2][, LiveDate2 := NULL]
listcols <- sh_o25_nr[, .SD[1], by = c('ManagedAreaName', 'LiveDate2')][, .(ProgsbyMAandLD_allLDQ_No20, ProgsbyMA_allLD_allLDQ_No20)]
sh_o25_sum1_nr <- cbind(sh_o25_sum1_nr, listcols)
setcolorder(sh_o25_sum1_nr, c('ManagedAreaName', 'nProgsbyMA_allLD_allLDQ_No20', 'ProgsbyMA_allLD_allLDQ_No20', 'LiveDate', 'nReefsbyMAandLD_allLDQ_No20', 'nProgsbyMAandLD_allLDQ_No20', 'ProgsbyMAandLD_allLDQ_No20'))
setorder(sh_o25_sum1_nr, ManagedAreaName, LiveDate)

#Create easily readable table in knitted document
#Better column names
sh_o25_sum1_renamed_nr <- setnames(sh_o25_sum1_nr, c('nProgsbyMA_allLD_allLDQ_No20', 'ProgsbyMA_allLD_allLDQ_No20', 'nReefsbyMAandLD_allLDQ_No20', 'nProgsbyMAandLD_allLDQ_No20', 'ProgsbyMAandLD_allLDQ_No20'), c('n progams_tot', 'programs_tot', 'n reefs_yr', 'n programs_yr', 'programs_yr'))

#Group names
groups_o25_nr <- c()
for(i in unique(sh_o25_sum1_nr$ManagedAreaName)){
  name <- paste0(i, ", Total Programs = ", sh_o25_sum1_nr[ManagedAreaName == i, 2][1], ": ", sh_o25_sum1_nr[ManagedAreaName == i, 3][[1]])[1]
  groups <- append(groups, name)
}

```

```{r Shell height >75mm summary table-nr, echo=TRUE, message = FALSE, warning = FALSE}
#Subset to only shell heights >75mm
sh_o75_nr <- oysterraw_sh_nr[ShellHeight_mm > 75, ]

sh_o75_nr[, nReefs := length(unique(reefIDcrosswalk)), by = c('ManagedAreaName', 'LiveDate_Qualifier', 'NumberMeasured_n', 'LiveDate2')]
sh_o75_nr[NumberMeasured_n != c("NA", "5", ""), nReefsbyMAandLD_allLDQ_No75 := length(unique(reefIDcrosswalk)), by = c('ManagedAreaName', 'LiveDate2')]
sh_o75_nr[NumberMeasured_n != c("NA", "5", ""), nProgsbyMAandLD_allLDQ_No75 := length(unique(ProgramID)), by = c('ManagedAreaName', 'LiveDate2')]
sh_o75_nr[NumberMeasured_n != c("NA", "5", ""), ProgsbyMAandLD_allLDQ_No75 := list(list(unique(ProgramID))), by = c('ManagedAreaName', 'LiveDate2')]
sh_o75_nr[NumberMeasured_n != c("NA", "5", ""), nProgsbyMA_allLD_allLDQ_No75 := length(unique(ProgramID)), by = c('ManagedAreaName')]
sh_o75_nr[NumberMeasured_n != c("NA", "5", ""), ProgsbyMA_allLD_allLDQ_No75 := list(list(unique(ProgramID))), by = c('ManagedAreaName')]

#Create summary table showing number of reefs/programs of data included in sh_o75_nr
sh_o75_sum1_nr <- unique(sh_o75_nr[, .(ManagedAreaName, LiveDate2, nReefsbyMAandLD_allLDQ_No75, nProgsbyMAandLD_allLDQ_No75, nProgsbyMA_allLD_allLDQ_No75)], by = c('ManagedAreaName', 'LiveDate2', 'nReefsbyMAandLD_allLDQ_No75', 'nProgsbyMAandLD_allLDQ_No75', 'nProgsbyMA_allLD_allLDQ_No75'))
sh_o75_sum1_nr[, LiveDate := LiveDate2][, LiveDate2 := NULL]
listcols <- sh_o75_nr[, .SD[1], by = c('ManagedAreaName', 'LiveDate2')][, .(ProgsbyMAandLD_allLDQ_No75, ProgsbyMA_allLD_allLDQ_No75)]
sh_o75_sum1_nr <- cbind(sh_o75_sum1_nr, listcols)
setcolorder(sh_o75_sum1_nr, c('ManagedAreaName', 'LiveDate', 'nReefsbyMAandLD_allLDQ_No75', 'nProgsbyMAandLD_allLDQ_No75', 'ProgsbyMAandLD_allLDQ_No75', 'nProgsbyMA_allLD_allLDQ_No75', 'ProgsbyMA_allLD_allLDQ_No75'))
setorder(sh_o75_sum1_nr, ManagedAreaName, LiveDate)

#Create easily readable table in knitted document
#Better column names
sh_o75_sum1_renamed <- setnames(sh_o75_sum1_nr, c('nProgsbyMA_allLD_allLDQ_No75', 'ProgsbyMA_allLD_allLDQ_No75', 'nReefsbyMAandLD_allLDQ_No75', 'nProgsbyMAandLD_allLDQ_No75', 'ProgsbyMAandLD_allLDQ_No75'), c('n progams_tot', 'programs_tot', 'n reefs_yr', 'n programs_yr', 'programs_yr'))

#Group names
groups <- c()
for(i in unique(sh_o75_sum1_nr$ManagedAreaName)){
  name <- paste0(i, ", Total Programs = ", sh_o75_sum1_nr[ManagedAreaName == i, 2][1], ": ", sh_o75_sum1_nr[ManagedAreaName == i, 3][[1]])[1]
  groups <- append(groups, name)
}

```

```{r TaveragedSHvModernSH-nr, echo=TRUE, message = FALSE, warning = FALSE}
#Compare time-averaged HOBS samples with average of modern oyster samples (>25mm shell height)
sh_o25_avgmod_all_nr <- sh_o25_nr[LiveDate_Qualifier != "Estimate", ][, MeanSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, sdModSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, semModSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, nYears := length(unique(LiveDate2)), by = c('ManagedAreaName', 'HabitatClassification')][, MeanReefSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, sdReefSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, semReefSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, nYearsReef := length(unique(LiveDate2)), by = c('ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')]
#sh_o25_avgmod_reef_nr <- unique(sh_o25_avgmod_all_nr[, c(1:2, 5, 7, 14, 25:29, 42:45)])
sh_o25_avgmod_reef_nr <- unique(sh_o25_avgmod_all_nr[, c("ProgramID", "ProgramName", "ReefIdentifier", "LiveDate_Qualifier", "ManagedAreaName", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "LiveDate2", "MeanReefSH", "sdReefSH", "semReefSH", "nYearsReef")])


sh_o25_histdat_all_nr <- sh_o25_nr[LiveDate_Qualifier == "Estimate", ][, MeanSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, sdModSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, semModSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, nYears := length(unique(LiveDate2)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, MeanReefSH := mean(ShellHeight_mm), by = c('LiveDate2','ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, sdReefSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, semReefSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, nYearsReef := length(unique(LiveDate2)), by = c('ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')]
#sh_o25_histdat_reef_nr <- unique(sh_o25_histdat_all_nr[, c(1:2, 5, 7, 14, 25:29, 42:45)])
sh_o25_histdat_reef_nr <- unique(sh_o25_histdat_all_nr[, c("ProgramID", "ProgramName", "ReefIdentifier", "LiveDate_Qualifier", "ManagedAreaName", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "LiveDate2", "MeanReefSH", "sdReefSH", "semReefSH", "nYearsReef")])

sh_o25_avgReef_nr <- rbind(sh_o25_avgmod_reef_nr, sh_o25_histdat_reef_nr)


#Compare time-averaged HOBS samples with average of modern oyster samples (>75mm shell height)
sh_o75_avgmod_all_nr <- sh_o75_nr[LiveDate_Qualifier != "Estimate", ][, MeanSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, sdModSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, semModSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, nYears := length(unique(LiveDate2)), by = c('ManagedAreaName', 'HabitatClassification')][, MeanReefSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, sdReefSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, semReefSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, nYearsReef := length(unique(LiveDate2)), by = c('ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')]
#sh_o75_avgmod_reef_nr <- unique(sh_o75_avgmod_all_nr[, c(1:2, 5, 7, 14, 25:29, 42:45)])
sh_o75_avgmod_reef_nr <- unique(sh_o75_avgmod_all_nr[, c("ProgramID", "ProgramName", "ReefIdentifier", "LiveDate_Qualifier", "ManagedAreaName", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "LiveDate2", "MeanReefSH", "sdReefSH", "semReefSH", "nYearsReef")])


sh_o75_histdat_all_nr <- sh_o75_nr[LiveDate_Qualifier == "Estimate", ][, MeanSH := mean(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, sdModSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, semModSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, nYears := length(unique(LiveDate2)), by = c('LiveDate2', 'ManagedAreaName', 'HabitatClassification')][, MeanReefSH := mean(ShellHeight_mm), by = c('LiveDate2','ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, sdReefSH := sd(ShellHeight_mm), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, semReefSH := sd(ShellHeight_mm)/sqrt(length(ShellHeight_mm)), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')][, nYearsReef := length(unique(LiveDate2)), by = c('ManagedAreaName', 'reefIDcrosswalk', 'HabitatClassification')]
#sh_o75_histdat_reef_nr <- unique(sh_o75_histdat_all_nr[, c(1:2, 5, 7, 14, 25:29, 42:45)])
sh_o75_histdat_reef_nr <- unique(sh_o75_histdat_all_nr[, c("ProgramID", "ProgramName", "ReefIdentifier", "LiveDate_Qualifier", "ManagedAreaName", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "LiveDate2", "MeanReefSH", "sdReefSH", "semReefSH", "nYearsReef")])

sh_o75_avgReef_nr <- rbind(sh_o75_avgmod_reef_nr, sh_o75_histdat_reef_nr)
```

### View the data {.tabset .tabset-fade}

#### Histograms (modern data only) {.tabset .tabset-fade .tabset-pills}

##### Shell height >25mm

```{r AvgSHbyReefandYRo25-hist-nr, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#histogram of average shell height by reef and year
SH_NovtoMar_byRandYR_o25 <- ggplot(sh_o25_avgmod_reef_nr, aes(MeanReefSH)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_histogram(color = "black") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free")
SH_NovtoMar_byRandYR_o25

ggsave(here::here(paste0("OA_plots/SH_NovtoMar_byRandYR_o25_", Sys.Date(), ".jpeg")),
       SH_NovtoMar_byRandYR_o25,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Shell height >75mm

```{r AvgSHbyReefandYRo75-hist-nr, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#histogram of average shell height by reef and year
SH_NovtoMar_byRandYR_o75 <- ggplot(sh_o75_avgmod_reef_nr, aes(MeanReefSH)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_histogram(color = "black") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free")
SH_NovtoMar_byRandYR_o75

ggsave(here::here(paste0("OA_plots/SH_NovtoMar_byRandYR_o75_", Sys.Date(), ".jpeg")),
       SH_NovtoMar_byRandYR_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

#### Normal QQ plots (modern data only) {.tabset .tabset-fade .tabset-pills}

##### Shell height >25mm

```{r AvgSHbyReefandYRo25-qqplot-nr, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#QQ plot of average shell height by reef and year
SH_NovtoMar_QQbyRandYR_o25 <- ggplot(sh_o25_avgmod_reef_nr, aes(sample = MeanReefSH)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_qq(shape = 1) +
  geom_qq_line(color = "red") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free")
SH_NovtoMar_QQbyRandYR_o25

ggsave(here::here(paste0("OA_plots/SH_NovtoMar_QQbyRandYR_o25_", Sys.Date(), ".jpeg")),
       SH_NovtoMar_QQbyRandYR_o25,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Shell height >75mm

```{r AvgSHbyReefandYRo75-qqplot-nr, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#QQ plot of average shell height by reef and year
SH_NovtoMar_QQbyRandYR_o75 <- ggplot(sh_o75_avgmod_reef_nr, aes(sample = MeanReefSH)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_qq(shape = 1) +
  geom_qq_line(color = "red") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free")
SH_NovtoMar_QQbyRandYR_o75

ggsave(here::here(paste0("OA_plots/SH_NovtoMar_QQbyRandYR_o75_", Sys.Date(), ".jpeg")),
       SH_NovtoMar_QQbyRandYR_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

### Regression summary tables {.tabset .tabset-fade}

#### Quantile Regression  {.tabset .tabset-fade .tabset-pills}

##### Shell height >25mm

No combinations of Managed Area and Habitat Classification had five or more years of data, so shell height trends could not be assessed.

```{r AvgSHbyReefandYRo25-QuantReg-nr, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#Run nonparametric regression (quantile regression) on average >25mm SH reef-level data by year, if there are >4 years of data
#Followed quantile regression example here: https://rcompanion.org/handbook/F_12.html; accessed 10/14/2020
qreg_results_o25_nr <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), pvalue = numeric(), pseudoR2 = numeric())
for(i in unique(sh_o25_avgReef_nr$MA_plotlab)){
  qrdat <- sh_o25_avgReef_nr[MA_plotlab == i, ]
  if(length(unique(qrdat$LiveDate2)) < 5) next
  quantregs <- rq(MeanReefSH ~ LiveDate2, data = qrdat, tau = 0.5)
  nullmod <- rq(MeanReefSH ~ 1, data = qrdat, tau = 0.5)
  anov <- anova(quantregs, nullmod)
  PseudR <- nagelkerke(quantregs)
  iresult <- data.table(MA_plotlab = i, intercept = quantregs$coefficients[[1]], slope = quantregs$coefficients[[2]], pvalue = anov$table[[4]], 
                        pseudoR2 = PseudR$Pseudo.R.squared.for.model.vs.null[[3]])
  qreg_results_o25_nr <- rbind(qreg_results_o25_nr, iresult)
}

setorder(qreg_results_o25_nr, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
qreg_results_o25_renamed_nr <- setnames(qreg_results_o25_nr, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(qreg_results_o25_nr, 'Managed Area_Habitat Class.', 'MA_plotlab')

qreg_results_o25_renamed_nr %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)

```

<br><br><br>

##### Shell height >75mm

No combinations of Managed Area and Habitat Classification had five or more years of data, so shell height trends could not be assessed.

```{r AvgSHbyReefandYRo75-QuantReg-nr, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#Run nonparametric regression (quantile regression) on average >75mm SH reef-level data by year, if there are >4 years of data
#Followed quantile regression example here: https://rcompanion.org/handbook/F_12.html; accessed 10/14/2020
qreg_results_o75_nr <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), pvalue = numeric(), pseudoR2 = numeric())
for(i in unique(sh_o75_avgReef_nr$MA_plotlab)){
  qrdat <- sh_o75_avgReef_nr[MA_plotlab == i, ]
  if(length(unique(qrdat$LiveDate2)) < 5) next
  quantregs <- rq(MeanReefSH ~ LiveDate2, data = qrdat, tau = 0.5)
  nullmod <- rq(MeanReefSH ~ 1, data = qrdat, tau = 0.5)
  anov <- anova(quantregs, nullmod)
  PseudR <- nagelkerke(quantregs)
  iresult <- data.table(MA_plotlab = i, intercept = quantregs$coefficients[[1]], slope = quantregs$coefficients[[2]], pvalue = anov$table[[4]], 
                        pseudoR2 = PseudR$Pseudo.R.squared.for.model.vs.null[[3]])
  qreg_results_o75_nr <- rbind(qreg_results_o75_nr, iresult)
}

setorder(qreg_results_o75_nr, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
qreg_results_o75_renamed_nr <- setnames(qreg_results_o75_nr, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(qreg_results_o75_nr, 'Managed Area_Habitat Class.', 'MA_plotlab')

qreg_results_o75_renamed_nr %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)

```

<br><br><br>

#### Linear Regression  {.tabset .tabset-fade .tabset-pills}

##### Shell height >25mm

No combinations of Managed Area and Habitat Classification had five or more years of data, so shell height trends could not be assessed.

```{r AvgSHbyReefandYRo25-LinReg-nr, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#Run linear regression on average >25mm SH reef-level data by year, if there are >4 years of data
lm_results_o25_nr <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), Fstatistic = numeric(), numdf = numeric(), dendf = numeric(), pvalue = numeric(), adjustedR2 = numeric())
for(i in unique(sh_o25_avgReef_nr$MA_plotlab)){
  lmdat <- sh_o25_avgReef_nr[MA_plotlab == i, ]
  if(length(unique(lmdat$LiveDate2)) < 5) next
  lms <- lm(MeanReefSH ~ LiveDate2, data = lmdat)
  iresult <- data.table(MA_plotlab = i, intercept = lms$coefficients[[1]], slope = lms$coefficients[[2]], Fstatistic = summary(lms)$fstatistic[[1]], numdf = summary(lms)$fstatistic[[2]], dendf = summary(lms)$fstatistic[[3]], pvalue = anova(lms)$Pr[1], adjustedR2 = summary(lms)$adj.r.squared)
  lm_results_o25_nr <- rbind(lm_results_o25_nr, iresult)
}

setorder(lm_results_o25_nr, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
lm_results_o25_renamed_nr <- setnames(lm_results_o25_nr, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(lm_results_o25_nr, 'Managed Area_Habitat Class.', 'MA_plotlab')

lm_results_o25_renamed_nr %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)

```

<br><br><br>

##### Shell height >75mm

No combinations of Managed Area and Habitat Classification had five or more years of data, so shell height trends could not be assessed.

```{r AvgSHbyReefandYRo75-LinReg-nr, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#Run linear regression on average >75mm SH reef-level data by year, if there are >4 years of data
lm_results_o75_nr <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), Fstatistic = numeric(), numdf = numeric(), dendf = numeric(), pvalue = numeric(), adjustedR2 = numeric())
for(i in unique(sh_o75_avgReef_nr$MA_plotlab)){
  lmdat <- sh_o75_avgReef_nr[MA_plotlab == i, ]
  if(length(unique(lmdat$LiveDate2)) < 5) next
  lms <- lm(MeanReefSH ~ LiveDate2, data = lmdat)
  iresult <- data.table(MA_plotlab = i, intercept = lms$coefficients[[1]], slope = lms$coefficients[[2]], Fstatistic = summary(lms)$fstatistic[[1]], numdf = summary(lms)$fstatistic[[2]], dendf = summary(lms)$fstatistic[[3]], pvalue = anova(lms)$Pr[1], adjustedR2 = summary(lms)$adj.r.squared)
  lm_results_o75_nr <- rbind(lm_results_o75_nr, iresult)
}

setorder(lm_results_o75_nr, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
lm_results_o75_renamed <- setnames(lm_results_o75_nr, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(lm_results_o75_nr, 'Managed Area_Habitat Class.', 'MA_plotlab')

lm_results_o75_renamed %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)

```

<br><br><br>


### Regression plots {.tabset .tabset-fade}

#### Quantile regression  {.tabset .tabset-fade}

##### Shell height >25mm {.tabset .tabset-fade .tabset-pills}

No combinations of Managed Area and Habitat Classification had five or more years of data, so shell height trends could not be assessed.

<br>

<!-- ```{r AvgSHbyReefandYRo25-QuantRegPlot-allyears-nr, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"} -->
<!-- #Plot reef-level average shell height >25mm, including quantile regression lines, as applicable, and full range of years. -->
<!-- SH_NovtoMar_QuantRegAllYears_o25 <- ggplot(sh_o25_avgmod_reef_nr, aes(LiveDate2, MeanReefSH, fill = ReefIdentifier)) + -->
<!--   theme_bw() + -->
<!--   geom_point(shape = 21) + -->
<!--   geom_point(data = sh_o25_histdat_reef_nr, shape = 24) + -->
<!--   facet_wrap(~MA_plotlab, ncol = 3) + -->
<!--   geom_abline(data = qreg_results_o25_nr, aes(intercept = intercept, slope = slope)) + -->
<!--   guides(fill = FALSE) + -->
<!--   theme(axis.text.x = element_text(angle = 90)) -->
<!-- SH_NovtoMar_QuantRegAllYears_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_NovtoMar_QuantRegAllYears_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_NovtoMar_QuantRegAllYears_o25, -->
<!--        width = 10, -->
<!--        height = 20, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<br><br><br>

##### Shell height >75mm {.tabset .tabset-fade .tabset-pills}

No combinations of Managed Area and Habitat Classification had five or more years of data, so shell height trends could not be assessed.

<!-- <br> -->

<!-- ```{r AvgSHbyReefandYRo75-QuantRegPlot-allyears-nr, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"} -->
<!-- #Plot reef-level average shell height >75mm, including quantile regression lines, as applicable, and full range of years. -->
<!-- SH_NovtoMar_QuantRegAllYears_o75 <- ggplot(sh_o75_avgmod_reef_nr, aes(LiveDate2, MeanReefSH, fill = ReefIdentifier)) + -->
<!--   theme_bw() + -->
<!--   geom_point(shape = 21) + -->
<!--   geom_point(data = sh_o75_histdat_reef_nr, shape = 24) + -->
<!--   facet_wrap(~MA_plotlab, ncol = 3) + -->
<!--   geom_abline(data = qreg_results_o75_nr, aes(intercept = intercept, slope = slope)) + -->
<!--   guides(fill = FALSE) + -->
<!--   theme(axis.text.x = element_text(angle = 90)) -->
<!-- SH_NovtoMar_QuantRegAllYears_o75 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_NovtoMar_QuantRegAllYears_o75_", Sys.Date(), ".jpeg")), -->
<!--        SH_NovtoMar_QuantRegAllYears_o75, -->
<!--        width = 10, -->
<!--        height = 20, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<br><br><br>

#### Linear regression  {.tabset .tabset-fade}

##### Shell height >25mm {.tabset .tabset-fade .tabset-pills}

No combinations of Managed Area and Habitat Classification had five or more years of data, so shell height trends could not be assessed.

<!-- <br> -->

<!-- ```{r AvgSHbyReefandYRo25-LinRegPlot-allyears-nr, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"} -->
<!-- #Plot reef-level average shell height >25mm, including quantile regression lines, as applicable, and full range of years. -->
<!-- SH_NovtoMar_LinRegAllYears_o25 <- ggplot(sh_o25_avgmod_reef_nr, aes(LiveDate2, MeanReefSH, fill = ReefIdentifier)) + -->
<!--   theme_bw() + -->
<!--   geom_point(shape = 21) + -->
<!--   geom_point(data = sh_o25_histdat_reef_nr, shape = 24) + -->
<!--   facet_wrap(~MA_plotlab, ncol = 3) + -->
<!--   geom_abline(data = lm_results_o25_nr, aes(intercept = intercept, slope = slope)) + -->
<!--   guides(fill = FALSE) + -->
<!--   theme(axis.text.x = element_text(angle = 90)) -->
<!-- SH_NovtoMar_LinRegAllYears_o25 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_NovtoMar_LinRegAllYears_o25_", Sys.Date(), ".jpeg")), -->
<!--        SH_NovtoMar_LinRegAllYears_o25, -->
<!--        width = 10, -->
<!--        height = 20, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<br><br><br>

##### Shell height >75mm {.tabset .tabset-fade .tabset-pills}

No combinations of Managed Area and Habitat Classification had five or more years of data, so shell height trends could not be assessed.

<!-- <br> -->

<!-- ```{r AvgSHbyReefandYRo75-LinRegPlot-allyears-nr, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"} -->
<!-- #Plot reef-level average shell height >75mm, including quantile regression lines, as applicable, and full range of years. -->
<!-- SH_NovtoMar_LinRegAllYears_o75 <- ggplot(sh_o75_avgmod_reef_nr, aes(LiveDate2, MeanReefSH, fill = ReefIdentifier)) + -->
<!--   theme_bw() + -->
<!--   geom_point(shape = 21) + -->
<!--   geom_point(data = sh_o75_histdat_reef_nr, shape = 24) + -->
<!--   facet_wrap(~MA_plotlab, ncol = 3) + -->
<!--   geom_abline(data = lm_results_o75_nr, aes(intercept = intercept, slope = slope)) + -->
<!--   guides(fill = FALSE) + -->
<!--   theme(axis.text.x = element_text(angle = 90)) -->
<!-- SH_NovtoMar_LinRegAllYears_o75 -->

<!-- ggsave(here::here(paste0("OA_plots/SH_NovtoMar_LinRegAllYears_o75_", Sys.Date(), ".jpeg")), -->
<!--        SH_NovtoMar_LinRegAllYears_o75, -->
<!--        width = 10, -->
<!--        height = 20, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<br><br><br>

### Generalized Linear Mixed Effects Models {.tabset .tabset-fade}

No combinations of Managed Area and Habitat Classification had five or more years of data, so shell height trends could not be assessed.

<br><br><br>

### Boxplots of shell height {.tabset .tabset-fade}

#### Shell height >25mm {.tabset .tabset-fade .tabset-pills}

No samples with an estimated age were collected in Nov. to Mar. timeframe, so none are available for comparison.

```{r AvgSHbyReefandYRo25-boxplots-allyears-nr, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot boxplots of shell height (>25mm) by year (all years)
SH_NovtoMar_BoxplotAvgModvHistAllYears_o25 <- ggplot(sh_o25_avgmod_all_nr, aes(as.character(LiveDate2), ShellHeight_mm)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_boxplot(color = "red") +
  geom_boxplot(data = sh_o25_histdat_all_nr, aes(group = as.character(LiveDate2)), color = "blue") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme(axis.text.x = element_text(angle = 90))
SH_NovtoMar_BoxplotAvgModvHistAllYears_o25

ggsave(here::here(paste0("OA_plots/SH_NovtoMar_BoxplotAvgModvHistAllYears_o25_", Sys.Date(), ".jpeg")),
       SH_NovtoMar_BoxplotAvgModvHistAllYears_o25,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

#### Shell height >75mm {.tabset .tabset-fade .tabset-pills}

No samples with an estimated age were collected in Nov. to Mar. timeframe, so none are available for comparison.

```{r AvgSHbyReefandYRo75-boxplots-allyears-nr, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot boxplots of shell height (>75mm) by year (all years)
SH_NovtoMar_BoxplotAvgModvHistAllYears_o75 <- ggplot(sh_o75_avgmod_all_nr, aes(as.character(LiveDate2), ShellHeight_mm)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_boxplot(color = "red") +
  geom_boxplot(data = sh_o75_histdat_all_nr, aes(group = as.character(LiveDate2)), color = "blue") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  theme(axis.text.x = element_text(angle = 90))
SH_NovtoMar_BoxplotAvgModvHistAllYears_o75

ggsave(here::here(paste0("OA_plots/SH_NovtoMar_BoxplotAvgModvHistAllYears_o75_", Sys.Date(), ".jpeg")),
       SH_NovtoMar_BoxplotAvgModvHistAllYears_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

***

## Live density

```{r DensitySetup-nr, echo=TRUE, message=FALSE, warning=FALSE}
setDT(oysterraw_den_nr)
# oysterraw_den_nr <- oysterraw_den_nr %>% mutate(SampleDate = mdy_hms(SampleDate))
# oysterraw_den_nr[, Month := month(SampleDate)]
# oysterraw_den_nr[, YrMo := paste0(Year, "-", Month)]

#More complicated conversion of date columns needed because ID_972 data do not have the hms format for time like the default in the combined table exports. When it eventually is corrected and fixed in the combined table export, then all program data should have the same SampleDate format and the above code should work again.
oysterraw_den_nr_no972 <- setDT(subset(oysterraw_den_nr, oysterraw_den_nr$ProgramID != 972)) %>% mutate(SampleDate = mdy_hms(SampleDate))
oysterraw_den_nr_no972[, Month := month(SampleDate)]
oysterraw_den_nr_no972[, YrMo := paste0(Year, "-", Month)]

oysterraw_den_nr_972 <- setDT(subset(oysterraw_den_nr, oysterraw_den_nr$ProgramID == 972)) %>% mutate(SampleDate = mdy_hm(SampleDate))
oysterraw_den_nr_972[, Month := month(SampleDate)]
oysterraw_den_nr_972[, YrMo := paste0(Year, "-", Month)]

oysterraw_den_nr <- rbind(oysterraw_den_nr_no972, oysterraw_den_nr_972)

#Fix QuadID and ReefID columns for 2003 data in program 4014
Reefs_4014_2003 <- c('1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13')
Quads_4014_2003 <- c('1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '13', '14')
Fix4014 <- oysterraw_den_nr[ProgramID == 4014, ][Year == 2003, QuadIdentifier := Quads_4014_2003][Year == 2003, ReefIdentifier := Reefs_4014_2003][Year == 2003, Density_m2 := Number_of_Oysters_Counted_Live_Count * 4]
no4014 <- subset(oysterraw_den_nr, oysterraw_den_nr$ProgramID != 4014)
oysterraw_den_nr <- rbind(Fix4014, no4014)

#Fix density for program 972
oysterraw_den_nr <- oysterraw_den_nr[ProgramID == 972, Density_m2 := (Number_of_Oysters_Counted_Live_Count/6) * 4]

#Fix density for program 4012
Fix4012 <- oysterraw_den_nr[ProgramID == 4012, ][is.na(Density_m2), Density_m2 := Number_of_Oysters_Counted_Live_Count / as.numeric(QuadSize_m2)]
Fix4012 <- Fix4012[QuadIdentifier %like% "_Ref", HabitatClassification := "Natural"]
Fix4012 <- Fix4012[QuadIdentifier %like% "_C", HabitatClassification := "Natural"]
no4012 <- subset(oysterraw_den_nr, oysterraw_den_nr$ProgramID != 4012)
oysterraw_den_nr <- rbind(Fix4012, no4012)

#Fix density for program 4042
Fix4042 <- oysterraw_den_nr[ProgramID == 4042, ][is.na(Density_m2), Density_m2 := Number_of_Oysters_Counted_Live_Count / as.numeric(QuadSize_m2)]
no4042 <- subset(oysterraw_den_nr, oysterraw_den_nr$ProgramID != 4042)
oysterraw_den_nr <- rbind(Fix4042, no4042)

#Fix density for program 4016
Fix4016 <- oysterraw_den_nr[ProgramID == 4016, ][is.na(Density_m2), Density_m2 := Number_of_Oysters_Counted_Live_Count / as.numeric(QuadSize_m2)]
no4016 <- subset(oysterraw_den_nr, oysterraw_den_nr$ProgramID != 4016)
oysterraw_den_nr <- rbind(Fix4016, no4016)

```

```{r echo=TRUE}
#Summarize density data by managed area
oysterraw_den_nona_nr <- subset(oysterraw_den_nr, !is.na(oysterraw_den_nr$Density_m2))
den_all_sum_nr <- summarySE(oysterraw_den_nona_nr, measurevar = 'Density_m2', groupvars = c('ManagedAreaName', 'Year'))

#Summarize density data by managed area (mean density 25mm <= x < 75)
oysterraw_den_r_seed_nr <- readRDS(here::here('oysterraw_den_r_seed_nr.rds'))
den_25to75_sum_nr <- summarySE(oysterraw_den_r_seed_nr, measurevar = 'meanDen', groupvars = c('ManagedAreaName', 'LiveDate2'))
colnames(den_25to75_sum_nr)[2] <- "Year"

#Summarize density data by managed area (mean density >= 75)
oysterraw_den_r_market_nr <- readRDS(here::here('oysterraw_den_r_market_nr.rds'))
den_o75_sum_nr <- summarySE(oysterraw_den_r_market_nr, measurevar = 'meanDen', groupvars = c('ManagedAreaName', 'LiveDate2'))
colnames(den_o75_sum_nr)[2] <- "Year"

```

```{r DenSummaryTable-raw-nr, echo=TRUE, message=FALSE, warning=FALSE}
#Create summary table showing number of reefs/programs of data included in oysterraw_den_nr
oysterraw_den_nr[, nReefsbyMAandYr := length(unique(reefIDcrosswalk)), by = c('ManagedAreaName', 'Year')]
oysterraw_den_nr[, nProgsbyMAandYr := length(unique(ProgramID)), by = c('ManagedAreaName', 'Year')]
oysterraw_den_nr[, ProgsbyMAandYr := list(list(unique(ProgramID))), by = c('ManagedAreaName', 'Year')]
oysterraw_den_nr[, nProgsbyMA := length(unique(ProgramID)), by = 'ManagedAreaName']
oysterraw_den_nr[, ProgsbyMA := list(list(unique(ProgramID))), by = 'ManagedAreaName']

den_sum1_nr <- unique(oysterraw_den_nr[, .(ManagedAreaName, Year, nReefsbyMAandYr, nProgsbyMAandYr, nProgsbyMA)], by = c('ManagedAreaName', 'Year', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'nProgsbyMA'))
listcols <- oysterraw_den_nr[, .SD[1], by = c('ManagedAreaName', 'Year')][, .(ProgsbyMAandYr, ProgsbyMA)]
den_sum1_nr <- cbind(den_sum1_nr, listcols)
setcolorder(den_sum1_nr, c('ManagedAreaName', 'nProgsbyMA', 'ProgsbyMA', 'Year', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'))
setorder(den_sum1_nr, ManagedAreaName, Year)

#Create easily readable table in knitted document
#Better column names
den_sum1_renamed_nr <- setnames(den_sum1_nr, c('nProgsbyMA', 'ProgsbyMA', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'), c('n progams_tot', 'programs_tot', 'n reefs_yr', 'n programs_yr', 'programs_yr'))

#Group names
groups <- c()
for(i in unique(den_sum1_nr$ManagedAreaName)){
  name <- paste0(i, ", Total Programs = ", den_sum1_nr[ManagedAreaName == i, 2][1], ": ", den_sum1_nr[ManagedAreaName == i, 3][[1]])[1]
  groups <- append(groups, name)
}

```

```{r DenSummaryTable-25-75mm-nr, echo=TRUE, message=FALSE, warning=FALSE}
#Create summary table showing number of reefs/programs of data included in oysterraw_den_r_seed_nr
oysterraw_den_r_seed_nr[, nReefsbyMAandYr := length(unique(reefIDcrosswalk)), by = c('ManagedAreaName', 'LiveDate2')]
oysterraw_den_r_seed_nr[, nProgsbyMAandYr := length(unique(ProgramID)), by = c('ManagedAreaName', 'LiveDate2')]
oysterraw_den_r_seed_nr[, ProgsbyMAandYr := list(list(unique(ProgramID))), by = c('ManagedAreaName', 'LiveDate2')]
oysterraw_den_r_seed_nr[, nProgsbyMA := length(unique(ProgramID)), by = 'ManagedAreaName']
oysterraw_den_r_seed_nr[, ProgsbyMA := list(list(unique(ProgramID))), by = 'ManagedAreaName']

den_sum1_seed_nr <- unique(oysterraw_den_r_seed_nr[, .(ManagedAreaName, LiveDate2, nReefsbyMAandYr, nProgsbyMAandYr, nProgsbyMA)], by = c('ManagedAreaName', 'LiveDate2', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'nProgsbyMA'))
listcols <- oysterraw_den_r_seed_nr[, .SD[1], by = c('ManagedAreaName', 'LiveDate2')][, .(ProgsbyMAandYr, ProgsbyMA)]
den_sum1_seed_nr <- cbind(den_sum1_seed_nr, listcols)
setcolorder(den_sum1_seed_nr, c('ManagedAreaName', 'nProgsbyMA', 'ProgsbyMA', 'LiveDate2', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'))
setorder(den_sum1_seed_nr, ManagedAreaName, LiveDate2)

#Create easily readable table in knitted document
#Better column names
den_sum1_seed_renamed_nr <- setnames(den_sum1_seed_nr, c('nProgsbyMA', 'ProgsbyMA', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'), c('n progams_tot', 'programs_tot', 'n reefs_yr', 'n programs_yr', 'programs_yr'))

#Group names
groups <- c()
for(i in unique(den_sum1_seed_nr$ManagedAreaName)){
  name <- paste0(i, ", Total Programs = ", den_sum1_seed_nr[ManagedAreaName == i, 2][1], ": ", den_sum1_seed_nr[ManagedAreaName == i, 3][[1]])[1]
  groups <- append(groups, name)
}

```

```{r DenSummaryTable-o75mm-nr, echo=TRUE, message=FALSE, warning=FALSE}
#Create summary table showing number of reefs/programs of data included in oysterraw_den_r_market_nr
oysterraw_den_r_market_nr[, nReefsbyMAandYr := length(unique(reefIDcrosswalk)), by = c('ManagedAreaName', 'LiveDate2')]
oysterraw_den_r_market_nr[, nProgsbyMAandYr := length(unique(ProgramID)), by = c('ManagedAreaName', 'LiveDate2')]
oysterraw_den_r_market_nr[, ProgsbyMAandYr := list(list(unique(ProgramID))), by = c('ManagedAreaName', 'LiveDate2')]
oysterraw_den_r_market_nr[, nProgsbyMA := length(unique(ProgramID)), by = 'ManagedAreaName']
oysterraw_den_r_market_nr[, ProgsbyMA := list(list(unique(ProgramID))), by = 'ManagedAreaName']

den_sum1_market_nr <- unique(oysterraw_den_r_market_nr[, .(ManagedAreaName, LiveDate2, nReefsbyMAandYr, nProgsbyMAandYr, nProgsbyMA)], by = c('ManagedAreaName', 'LiveDate2', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'nProgsbyMA'))
listcols <- oysterraw_den_r_market_nr[, .SD[1], by = c('ManagedAreaName', 'LiveDate2')][, .(ProgsbyMAandYr, ProgsbyMA)]
den_sum1_market_nr <- cbind(den_sum1_market_nr, listcols)
setcolorder(den_sum1_market_nr, c('ManagedAreaName', 'nProgsbyMA', 'ProgsbyMA', 'LiveDate2', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'))
setorder(den_sum1_market_nr, ManagedAreaName, LiveDate2)

#Create easily readable table in knitted document
#Better column names
den_sum1_market_renamed_nr <- setnames(den_sum1_market_nr, c('nProgsbyMA', 'ProgsbyMA', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'), c('n progams_tot', 'programs_tot', 'n reefs_yr', 'n programs_yr', 'programs_yr'))

#Group names
groups <- c()
for(i in unique(den_sum1_market_nr$ManagedAreaName)){
  name <- paste0(i, ", Total Programs = ", den_sum1_market_nr[ManagedAreaName == i, 2][1], ": ", den_sum1_market_nr[ManagedAreaName == i, 3][[1]])[1]
  groups <- append(groups, name)
}

```

```{r AvgDenLive-setup-raw-nr, message=FALSE, warning=FALSE, include=FALSE}
#Density, all and by reef
den_avg_all_nr <- oysterraw_den_nona_nr[, MeanDen := mean(Density_m2), by = c('ManagedAreaName', 'Year')][, sdDen := sd(Density_m2), by = c('Year', 'ManagedAreaName')][, semDen := sd(Density_m2)/sqrt(length(Density_m2)), by = c('Year', 'ManagedAreaName')][, nYears := length(unique(Year)), by = c('ManagedAreaName')][, MeanReefDen := mean(Density_m2), by = c('Year', 'ManagedAreaName', 'reefIDcrosswalk')][, sdReefDen := sd(Density_m2), by = c('Year', 'ManagedAreaName', 'reefIDcrosswalk')][, semReefDen := sd(Density_m2)/sqrt(length(Density_m2)), by = c('Year', 'ManagedAreaName', 'reefIDcrosswalk')][, nYearsReef := length(unique(Year)), by = c('ManagedAreaName', 'reefIDcrosswalk')]
#den_avg_reef_nr <- unique(den_avg_all_nr[, c(1:2, 8, 10, 12:15, 20:23, 29:32)])
den_avg_reef_nr <- unique(den_avg_all_nr[, c("ProgramID", "ProgramName", "Year", "ManagedAreaName" ,"SurveyMethod", "HabitatClassification", "QuadSize_m2", "MADup", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "MeanReefDen", "sdReefDen", "semReefDen", "nYearsReef")])
den_avg_reef_nr[, Year := as.integer(Year)]

```

```{r AvgDenLive-setup_25to75mm-nr, message=FALSE, warning=FALSE, include=FALSE}
#Density, seed size and by reef
den_avg_seed_all_nr <- oysterraw_den_r_seed_nr[, MeanDen := mean(meanDen), by = c('ManagedAreaName', 'LiveDate2')][, sdDen := sd(meanDen), by = c('LiveDate2', 'ManagedAreaName')][, semDen := sd(meanDen)/sqrt(length(meanDen)), by = c('LiveDate2', 'ManagedAreaName')][, nYears := length(unique(LiveDate2)), by = c('ManagedAreaName')][, MeanReefDen := mean(meanDen), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk')][, sdReefDen := sd(meanDen), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk')][, semReefDen := sd(meanDen)/sqrt(length(meanDen)), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk')][, nYearsReef := length(unique(LiveDate2)), by = c('ManagedAreaName', 'reefIDcrosswalk')]
#den_avg_seed_reef_nr <- unique(den_avg_seed_all_nr[, c(1:2, 14, 16:21, 23:25, 27:28, 42:45)])
den_avg_seed_reef_nr <- unique(den_avg_seed_all_nr[, c("ProgramID", "ProgramName", "ManagedAreaName", "SurveyMethod", "HabitatClassification", "MinimumSizeMeasured_mm", "NumberMeasured_n", "QuadSize_m2", "MADup", "reefIDcrosswalk", "LiveDate2", "MA_plotlab", "Region.y", "Subtidal", "MeanReefDen", "sdReefDen", "semReefDen", "nYearsReef")])

```

```{r AvgDenLive-setup_o75mm-nr, message=FALSE, warning=FALSE, include=FALSE}
#Density, market size and by reef
den_avg_market_all_nr <- oysterraw_den_r_market_nr[, MeanDen := mean(meanDen), by = c('ManagedAreaName', 'LiveDate2')][, sdDen := sd(meanDen), by = c('LiveDate2', 'ManagedAreaName')][, semDen := sd(meanDen)/sqrt(length(meanDen)), by = c('LiveDate2', 'ManagedAreaName')][, nYears := length(unique(LiveDate2)), by = c('ManagedAreaName')][, MeanReefDen := mean(meanDen), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk')][, sdReefDen := sd(meanDen), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk')][, semReefDen := sd(meanDen)/sqrt(length(meanDen)), by = c('LiveDate2', 'ManagedAreaName', 'reefIDcrosswalk')][, nYearsReef := length(unique(LiveDate2)), by = c('ManagedAreaName', 'reefIDcrosswalk')]
#den_avg_market_reef_nr <- unique(den_avg_market_all_nr[, c(1:2, 14, 16:21, 23:25, 27:28, 42:45)])
den_avg_market_reef_nr <- unique(den_avg_market_all_nr[, c("ProgramID", "ProgramName", "ManagedAreaName", "SurveyMethod", "HabitatClassification", "MinimumSizeMeasured_mm", "NumberMeasured_n", "QuadSize_m2", "MADup", "reefIDcrosswalk", "LiveDate2", "MA_plotlab", "Region.y", "Subtidal", "MeanReefDen", "sdReefDen", "semReefDen", "nYearsReef")])

```

<br><br><br>

### View the data {.tabset .tabset-fade}

#### Histograms {.tabset .tabset-fade .tabset-pills}

##### Raw density values

```{r AvgDenbyReefandYR-hist-nr, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#histogram of average shell height by reef and year
Den_NovtoMar_AvgbyReefandYr_raw <- ggplot(den_avg_reef_nr, aes(MeanReefDen)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_histogram(color = "black") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free")
Den_NovtoMar_AvgbyReefandYr_raw

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_AvgbyReefandYr_raw_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_AvgbyReefandYr_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Only 25-75mm shell height

```{r AvgDenbyReefandYR-hist-25to75mm-nr, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#histogram of average shell height by reef and year
Den_NovtoMar_AvgbyReefandYr_25to75 <- ggplot(den_avg_seed_reef_nr, aes(MeanReefDen)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_histogram(color = "black") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free")
Den_NovtoMar_AvgbyReefandYr_25to75

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_AvgbyReefandYr_25to75_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_AvgbyReefandYr_25to75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Only >75mm shell height

```{r AvgDenbyReefandYR-hist-o75mm-nr, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#histogram of average shell height by reef and year
Den_NovtoMar_AvgbyReefandYr_o75 <- ggplot(den_avg_market_reef_nr, aes(MeanReefDen)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_histogram(color = "black") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free")
Den_NovtoMar_AvgbyReefandYr_o75

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_AvgbyReefandYr_o75_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_AvgbyReefandYr_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

#### Normal QQ plots {.tabset .tabset-fade .tabset-pills}

##### Raw density values

```{r AvgDenbyReefandYR-qqplot-nr, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#QQ plot of average shell height by reef and year
Den_NovtoMar_QQbyReefandYr_raw <- ggplot(den_avg_reef_nr, aes(sample = MeanReefDen)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_qq(shape = 1) +
  geom_qq_line(color = "red") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free")
Den_NovtoMar_QQbyReefandYr_raw

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_QQbyReefandYr_raw_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_QQbyReefandYr_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Only 25-75mm shell height

```{r AvgDenbyReefandYR-qqplot-25to75mm-nr, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#QQ plot of average shell height by reef and year
Den_NovtoMar_QQbyReefandYr_25to75 <- ggplot(den_avg_seed_reef_nr, aes(sample = MeanReefDen)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_qq(shape = 1) +
  geom_qq_line(color = "red") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free")
Den_NovtoMar_QQbyReefandYr_25to75

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_QQbyReefandYr_25to75_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_QQbyReefandYr_25to75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Only >75mm shell height

```{r AvgDenbyReefandYR-qqplot-o75mm-nr, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#QQ plot of average shell height by reef and year
Den_NovtoMar_QQbyReefandYr_o75 <- ggplot(den_avg_market_reef_nr, aes(sample = MeanReefDen)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_qq(shape = 1) +
  geom_qq_line(color = "red") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free")
Den_NovtoMar_QQbyReefandYr_o75

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_QQbyReefandYr_o75_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_QQbyReefandYr_o75,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

### Model summary tables {.tabset .tabset-fade}

#### Quantile regression {.tabset .tabset-fade .tabset-pills}

##### Raw density values

```{r AvgDenbyReefandYR-QuantReg-raw-nr, echo=TRUE, message=FALSE, warning=FALSE}
#Run nonparametric regression (quantile regression) on average density reef-level data by year, if there are >4 years of data
#Followed quantile regression example here: https://rcompanion.org/handbook/F_12.html; accessed 10/14/2020
qreg_results_den_nr <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), pvalue = numeric(), pseudoR2 = numeric())
for(i in unique(den_avg_reef_nr$MA_plotlab)){
  qrdat <- den_avg_reef_nr[MA_plotlab == i, ]
  if(length(unique(qrdat$Year)) < 5) next
  if(length(qrdat$MeanReefDen) > length(unique(qrdat$Year))){
  quantregs <- rq(MeanReefDen ~ Year, data = qrdat, tau = 0.5)
  nullmod <- rq(MeanReefDen ~ 1, data = qrdat, tau = 0.5)
  anov <- anova(quantregs, nullmod)
  PseudR <- nagelkerke(quantregs)
  iresult <- data.table(MA_plotlab = i, intercept = quantregs$coefficients[[1]], slope = quantregs$coefficients[[2]], pvalue = anov$table[[4]], pseudoR2 = PseudR$Pseudo.R.squared.for.model.vs.null[[3]])
  }
  else{
    iresult <- data.table(MA_plotlab = paste0(i, "*"), intercept = numeric(), slope = numeric(), pvalue = numeric(), pseudoR2 = numeric())
  }
  qreg_results_den_nr <- rbind(qreg_results_den_nr, iresult)
}

setorder(qreg_results_den_nr, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
qreg_results_den_renamed_nr <- setnames(qreg_results_den_nr, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(qreg_results_den_nr,'Managed Area_Habitat Class.', 'MA_plotlab')

qreg_results_den_renamed_nr %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T) %>%
  add_footnote("Only one observation per year; 0 residual degrees of freedom.", notation = "symbol")
```

<br><br><br>

##### Only 25-75mm shell height

No combinations of Managed Area and Habitat Classification had five or more years of data, so density by size class trends could not be assessed.

```{r AvgDenbyReefandYR-QuantReg-25to75mm-nr, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#Run nonparametric regression (quantile regression) on average density reef-level data by year, if there are >4 years of data
#Followed quantile regression example here: https://rcompanion.org/handbook/F_12.html; accessed 10/14/2020
qreg_results_den_seed_nr <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), pvalue = numeric(), pseudoR2 = numeric())
for(i in unique(den_avg_seed_reef_nr$MA_plotlab)){
  qrdat <- den_avg_seed_reef_nr[MA_plotlab == i, ]
  if(length(unique(qrdat$LiveDate2)) < 5) next
  quantregs <- rq(MeanReefDen ~ LiveDate2, data = qrdat, tau = 0.5)
  nullmod <- rq(MeanReefDen ~ 1, data = qrdat, tau = 0.5)
  anov <- anova(quantregs, nullmod)
  PseudR <- nagelkerke(quantregs)
  iresult <- data.table(MA_plotlab = i, intercept = quantregs$coefficients[[1]], slope = quantregs$coefficients[[2]], pvalue = anov$table[[4]], pseudoR2 = PseudR$Pseudo.R.squared.for.model.vs.null[[3]])
  qreg_results_den_seed_nr <- rbind(qreg_results_den_seed_nr, iresult)
}

setorder(qreg_results_den_seed_nr, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
qreg_results_den_seed_renamed_nr <- setnames(qreg_results_den_seed_nr, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(qreg_results_den_seed_nr,'Managed Area_Habitat Class.', 'MA_plotlab')

qreg_results_den_seed_renamed_nr %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)
```

<br><br><br>

##### Only >75mm shell height

No combinations of Managed Area and Habitat Classification had five or more years of data, so density by size class trends could not be assessed.

```{r AvgDenbyReefandYR-QuantReg_o75mm-nr, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#Run nonparametric regression (quantile regression) on average density reef-level data by year, if there are >4 years of data
#Followed quantile regression example here: https://rcompanion.org/handbook/F_12.html; accessed 10/14/2020
qreg_results_den_market_nr <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), pvalue = numeric(), pseudoR2 = numeric())
for(i in unique(den_avg_market_reef_nr$MA_plotlab)){
  qrdat <- den_avg_market_reef_nr[MA_plotlab == i, ]
  if(length(unique(qrdat$LiveDate2)) < 5) next
  quantregs <- rq(MeanReefDen ~ LiveDate2, data = qrdat, tau = 0.5)
  nullmod <- rq(MeanReefDen ~ 1, data = qrdat, tau = 0.5)
  anov <- anova(quantregs, nullmod)
  PseudR <- nagelkerke(quantregs)
  iresult <- data.table(MA_plotlab = i, intercept = quantregs$coefficients[[1]], slope = quantregs$coefficients[[2]], pvalue = anov$table[[4]], pseudoR2 = PseudR$Pseudo.R.squared.for.model.vs.null[[3]])
  qreg_results_den_market_nr <- rbind(qreg_results_den_market_nr, iresult)
}

setorder(qreg_results_den_market_nr, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
qreg_results_den_market_renamed_nr <- setnames(qreg_results_den_market_nr, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(qreg_results_den_market_nr,'Managed Area_Habitat Class.', 'MA_plotlab')

qreg_results_den_market_renamed_nr %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)
```

<br><br><br>

#### Linear regression

```{r}
#Linear regression version
lm_results_den_nr <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), Fstatistic = numeric(), numdf = numeric(), dendf = numeric(), pvalue = numeric(), adjustedR2 = numeric())
for(i in unique(den_avg_reef_nr$MA_plotlab)){
  lmdat <- den_avg_reef_nr[MA_plotlab == i, ]
  if(length(unique(lmdat$Year)) < 5) next
  lms <- lm(MeanReefDen ~ Year, data = lmdat)
  if(length(lmdat$MeanReefDen) > length(unique(lmdat$Year))){
  iresult <- data.table(MA_plotlab = i, intercept = lms$coefficients[[1]], slope = lms$coefficients[[2]], Fstatistic = summary(lms)$fstatistic[[1]], numdf = summary(lms)$fstatistic[[2]], dendf = summary(lms)$fstatistic[[3]], pvalue = anova(lms)$Pr[1], adjustedR2 = summary(lms)$adj.r.squared)
  }
  else{
    iresult <- data.table(MA_plotlab = paste0(i, "*"), intercept = lms$coefficients[[1]], slope = lms$coefficients[[2]], Fstatistic = numeric(), numdf = summary(lms)$fstatistic[[2]], dendf = summary(lms)$fstatistic[[3]], pvalue = numeric(), adjustedR2 = numeric())
  }
  lm_results_den_nr <- rbind(lm_results_den_nr, iresult)
}

setorder(lm_results_den_nr, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
lm_results_den_renamed_nr <- setnames(lm_results_den_nr, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(lm_results_den_nr, 'Managed Area_Habitat Class.', 'MA_plotlab')

lm_results_den_renamed_nr %>% 
  kbl(align = "lccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T) %>%
  add_footnote("Only one observation per year; 0 residual degrees of freedom.", notation = "symbol")
```

<br><br><br>


### Linear regression diagnostic plots {.tabset .tabset-fade}

#### Lemon Bay_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef_nr[MA_plotlab == "Lemon Bay_Natural", ]), which = 1)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef_nr[MA_plotlab == "Lemon Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef_nr[MA_plotlab == "Lemon Bay_Natural", ]), which = 3)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef_nr[MA_plotlab == "Lemon Bay_Natural", ]), which = 4)

```

<br><br><br>

#### Pine Island Sound_Natural

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef_nr[MA_plotlab == "Pine Island Sound_Natural", ]), which = 1)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef_nr[MA_plotlab == "Pine Island Sound_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

plot(lm(MeanReefDen ~ Year, data = den_avg_reef_nr[MA_plotlab == "Pine Island Sound_Natural", ]), which = 3)

plot(lm(MeanReefDen ~ Year, data = den_avg_reef_nr[MA_plotlab == "Pine Island Sound_Natural", ]), which = 4)

```

<br><br><br>

#### Pine Island Sound_Restored

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

#Only one observation per year; 0 residual degrees of freedom.
plot(lm(MeanReefDen ~ Year, data = den_avg_reef_nr[MA_plotlab == "Pine Island Sound_Restored", ]), which = 1)

#plot(lm(MeanReefDen ~ Year, data = den_avg_reef_nr[MA_plotlab == "Pine Island Sound_Restored", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

#Only one observation per year; 0 residual degrees of freedom.
#plot(lm(MeanReefDen ~ Year, data = den_avg_reef_nr[MA_plotlab == "Pine Island Sound_Restored", ]), which = 3)

#plot(lm(MeanReefDen ~ Year, data = den_avg_reef_nr[MA_plotlab == "Pine Island Sound_Restored", ]), which = 4)

```

<br><br><br>

### Regression plots {.tabset .tabset-fade}

#### Quantile regression {.tabset .tabset-fade .tabset-pills}

##### Raw density values

```{r AvgDenbyReefandYR-QuantRegPlot-nr, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}

#Plot reef-level average density, including quantile regression lines, as applicable, and full range of years.
Den_NovtoMar_QuantReg_raw <- ggplot(den_avg_reef_nr, aes(Year, MeanReefDen, fill = reefIDcrosswalk)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_point(shape = 21) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = qreg_results_den_nr, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 90))
Den_NovtoMar_QuantReg_raw

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_QuantReg_raw_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_QuantReg_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

##### Only 25-75mm shell height {.tabset .tabset-fade .tabset-pills}

No combinations of Managed Area and Habitat Classification had five or more years of data, so density by size class trends could not be assessed.

<!-- ```{r AvgDenbyReefandYR-QuantRegPlot_25to75mm-allyears-nr, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"} -->

<!-- #Plot reef-level average density (25-75mm SH only), including quantile regression lines, as applicable, and full range of years. -->
<!-- Den_NovtoMar_QuantRegAllYears_25to75 <- ggplot(den_avg_seed_reef_nr, aes(LiveDate2, MeanReefDen, fill = reefIDcrosswalk)) + -->
<!--   theme_bw() + -->
<!--   geom_point(shape = 21) + -->
<!--   facet_wrap(~MA_plotlab, ncol = 3) + -->
<!--   geom_abline(data = qreg_results_den_seed_nr, aes(intercept = intercept, slope = slope)) + -->
<!--   guides(fill = FALSE) + -->
<!--   theme(axis.text.x = element_text(angle = 90)) -->
<!-- Den_NovtoMar_QuantRegAllYears_25to75 -->

<!-- ggsave(here::here(paste0("OA_plots/Den_NovtoMar_QuantRegAllYears_25to75_", Sys.Date(), ".jpeg")), -->
<!--        Den_NovtoMar_QuantRegAllYears_25to75, -->
<!--        width = 10, -->
<!--        height = 20, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<br><br><br>

##### Only >75mm shell height {.tabset .tabset-fade .tabset-pills}

No combinations of Managed Area and Habitat Classification had five or more years of data, so density by size class trends could not be assessed.

<!-- ```{r AvgDenbyReefandYR-QuantRegPlot_o75mm-allyears-nr, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"} -->

<!-- #Plot reef-level average density (>75mm SH only), including quantile regression lines, as applicable, and full range of years. -->
<!-- Den_NovtoMar_QuantRegAllYears_o75 <- ggplot(den_avg_market_reef_nr, aes(LiveDate2, MeanReefDen, fill = reefIDcrosswalk)) + -->
<!--   theme_bw() + -->
<!--   geom_point(shape = 21) + -->
<!--   facet_wrap(~MA_plotlab, ncol = 3) + -->
<!--   geom_abline(data = qreg_results_den_market_nr, aes(intercept = intercept, slope = slope)) + -->
<!--   guides(fill = FALSE) + -->
<!--   theme(axis.text.x = element_text(angle = 90)) -->
<!-- Den_NovtoMar_QuantRegAllYears_o75 -->

<!-- ggsave(here::here(paste0("OA_plots/Den_NovtoMar_QuantRegAllYears_o75_", Sys.Date(), ".jpeg")), -->
<!--        Den_NovtoMar_QuantRegAllYears_o75, -->
<!--        width = 10, -->
<!--        height = 20, -->
<!--        units = "in", -->
<!--        dpi = 300) -->
<!-- ``` -->

<br><br><br>

#### Linear regression

```{r AvgDenbyReefandYR-LinRegPlot-nr, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
Den_NovtoMar_LinReg_raw <- ggplot(den_avg_reef_nr, aes(Year, MeanReefDen, fill = reefIDcrosswalk)) +
  theme_bw() +
  geom_point(shape = 21) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = lm_results_den_nr, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 90), axis.line = element_line())
Den_NovtoMar_LinReg_raw

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_LinReg_raw_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_LinReg_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

### Generalized Linear Mixed Effects Models {.tabset .tabset-fade}

#### Raw density values {.tabset .tabset-fade .tabset-pills}

##### Lemon Bay {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

# lb_n$Density_m2 and lb_n_nr$Density_m2 are identical, so I updated the text, but only ran the best model from the AllDates models (GLMM 6) to save time, since the data are the same.

lb_n_nr <- subset(oysterraw_den_nona_nr, oysterraw_den_nona_nr$MA_plotlab == "Lemon Bay_Natural")
lb_n_nr[, QuadSize_m2 := as.factor(QuadSize_m2)]
#lb_n_nr[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
lb_n_nr[, RelYear := as.numeric(Year) - min(as.numeric(Year))]
lb_n_nr[, Density_m2 := as.integer(Density_m2)]
saveRDS(lb_n_nr, here::here(paste0('GLMMs/NovtoMar/Data/lb_n_nr_', Sys.Date(), '.rds')))

lb_den_glmm_nr <- brm(formula = Number_of_Oysters_Counted_Live_Count ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = lb_n_nr, family = skew_normal(link = "identity", link_sigma = "log", link_alpha = "log"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
lb_den_glmm_nr <- add_criterion(lb_den_glmm_nr, "loo")

ggplot(lb_n_nr, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(lb_n_nr, aes(x = as.factor(ProgramID), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() +
  theme(legend.position = "none")

lb_den_glmm_nr1 <- brm(formula = Density_m2 ~ RelYear, data = lb_n_nr, family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/lb_den_glmm_nr1.rds")
lb_den_glmm_nr1 <- add_criterion(lb_den_glmm_nr1, "loo")

lb_den_glmm_nr2 <- brm(formula = Density_m2 ~ RelYear, data = lb_n_nr, family = poisson, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/lb_den_glmm_nr2.rds")
lb_den_glmm_nr2 <- add_criterion(lb_den_glmm_nr2, "loo")

lb_den_glmm_nr3 <- brm(formula = Density_m2 ~ RelYear, data = lb_n_nr, family = negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/lb_den_glmm_nr3.rds")
lb_den_glmm_nr3 <- add_criterion(lb_den_glmm_nr3, "loo")

lb_den_glmm_nr4 <- brm(formula = Density_m2 ~ RelYear, data = lb_n_nr, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/lb_den_glmm_nr4.rds")
lb_den_glmm_nr4 <- add_criterion(lb_den_glmm_nr4, "loo")

#GLMM 3 is the best fit.
loo_compare(lb_den_glmm_nr1, lb_den_glmm_nr2, lb_den_glmm_nr3, lb_den_glmm_nr4)

lb_den_glmm_nr5 <- brm(formula = Density_m2 ~ RelYear + (1 | ReefIdentifier), data = lb_n_nr, family = negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/lb_den_glmm_nr5.rds")
lb_den_glmm_nr5 <- add_criterion(lb_den_glmm_nr5, "loo")

lb_den_glmm_nr6 <- brm(formula = Density_m2 ~ RelYear + (1 | ReefIdentifier), data = lb_n_nr, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/lb_den_glmm_nr6.rds")
lb_den_glmm_nr6 <- add_criterion(lb_den_glmm_nr6, "loo")

lb_den_glmm_nr7 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | ReefIdentifier), data = lb_n_nr, family = negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/lb_den_glmm_nr7.rds")
lb_den_glmm_nr7 <- add_criterion(lb_den_glmm_nr7, "loo")

lb_den_glmm_nr8 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | ReefIdentifier), data = lb_n_nr, family = zero_inflated_negbinomial, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/lb_den_glmm_nr8.rds")
lb_den_glmm_nr8 <- add_criterion(lb_den_glmm_nr8, "loo")

#GLMM7 is the best fit to the data
loo_compare(lb_den_glmm_nr1, lb_den_glmm_nr2, lb_den_glmm_nr3, lb_den_glmm_nr4, lb_den_glmm_nr5, lb_den_glmm_nr6, lb_den_glmm_nr7, lb_den_glmm_nr8)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
lb_n_nr <- subset(oysterraw_den_nona_nr, oysterraw_den_nona_nr$MA_plotlab == "Lemon Bay_Natural")
lb_n_nr[, QuadSize_m2 := as.factor(QuadSize_m2)]
#lb_n_nr[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
lb_n_nr[, RelYear := as.numeric(Year) - min(as.numeric(Year))]
lb_n_nr[, Density_m2 := as.integer(Density_m2)]
saveRDS(lb_n_nr, here::here(paste0('GLMMs/NovtoMar/Data/lb_n_nr_', Sys.Date(), '.rds')))

lb_den_glmm_nr <- readRDS(here::here('GLMMs/NovtoMar/lb_den_glmm_nr7.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

lb_n_nr[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
lb_n_nr[, SampleDay := day(SampleDate)]


den_t <- copy(lb_n_nr[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(lb_n_nr$Month))){
  mo <- subset(lb_n_nr, as.numeric(lb_n_nr$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(lb_n_nr, lb_n_nr$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = "All", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(Density_m2),
                       Median = median(Density_m2),
                       Mean = round(mean(Density_m2), digits = 2),
                       SD = round(sd(Density_m2), digits = 2), 
                       Min. = min(Density_m2),
                       Max. = max(Density_m2)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(lb_sho75, lb_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(lb_n_nr, aes(x = RelYear, y = as.factor(QuadSize_m2), color = ReefIdentifier)) +
  geom_jitter() #+
  #theme(legend.position = "none")

ggplot(lb_n_nr, aes(x = as.factor(ProgramID), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(lb_den_glmm_nr)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_NovtoMar_GLMM_LB_PDistandMChains_raw <- plot(lb_den_glmm_nr)
Den_NovtoMar_GLMM_LB_PDistandMChains_raw

len <- length(Den_NovtoMar_GLMM_LB_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_NovtoMar_GLMM_LB_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_NovtoMar_GLMM_LB_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_NovtoMar_GLMM_LB_PPcheck_raw <- pp_check(lb_den_glmm_nr)
Den_NovtoMar_GLMM_LB_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_GLMM_LB_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_GLMM_LB_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
lb1_nr <- plot(conditional_effects(lb_den_glmm_nr, re_formula = NULL), plot = FALSE)[[1]]
Den_NovtoMar_GLMM_LB_MEPrand_raw <- lb1_nr +
  geom_jitter(data = lb_n_nr, aes(x = RelYear, y = Density_m2, fill = ReefIdentifier), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = lb_n_nr, aes(y = -5, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_NovtoMar_GLMM_LB_MEPrand_raw

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_GLMM_LB_MEPrand_raw_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_GLMM_LB_MEPrand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
lb2_nr <- plot(conditional_effects(lb_den_glmm_nr, re_formula = NA), plot = FALSE)[[1]]
Den_NovtoMar_GLMM_LB_MEPnorand_raw <- lb2_nr +
  geom_jitter(data = lb_n_nr, aes(x = RelYear, y = Density_m2, fill = ReefIdentifier), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = lb_n_nr, aes(y = -5, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_NovtoMar_GLMM_LB_MEPnorand_raw

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_GLMM_LB_MEPnorand_raw_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_GLMM_LB_MEPnorand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Individual effects plots
#labs1 <- sort(unique(lb_n_nr$Year))[c(TRUE, FALSE)]
labs2 <- sort(unique(lb_n_nr$Year))#[c(FALSE, TRUE)]

Den_NovtoMar_GLMM_LB_IEP_raw <- lb_n_nr %>%
  group_by(ReefIdentifier) %>%
  add_fitted_draws(lb_den_glmm_nr) %>%
  ggplot(aes(x = RelYear, y = Density_m2, color = ReefIdentifier)) +
  geom_hline(yintercept = 0, color = "black", lwd = 0.1) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = lb_n_nr) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2") +
  #geom_text(data = subset(lb_n_nr, lb_n_nr$Year %in% labs1), aes(y = -110, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  geom_text(data = subset(lb_n_nr, lb_n_nr$Year %in% labs2), aes(y = -5, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(lb_n_nr$RelYear) + 1)) +
  #scale_y_continuous(limits = c(-300, 1200)) +
  #coord_cartesian(ylim = c(-40, 700)) +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ ReefIdentifier, ncol = 3, scales = "free")
Den_NovtoMar_GLMM_LB_IEP_raw

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_GLMM_LB_IEP_raw_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_GLMM_LB_IEP_raw,
       width = 10,
       height = 5,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(lb_n_nr, lb_den_glmm_nr, 
   Den_NovtoMar_GLMM_LB_PDistandMChains_raw,
   Den_NovtoMar_GLMM_LB_PPcheck_raw,
   Den_NovtoMar_GLMM_LB_MEPrand_raw,
   Den_NovtoMar_GLMM_LB_MEPnorand_raw,
   Den_NovtoMar_GLMM_LB_IEP_raw
   )

```

<br><br><br>

##### Pine Island Sound (Natural) {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

pis_n_nr <- subset(oysterraw_den_nona_nr, oysterraw_den_nona_nr$MA_plotlab == "Pine Island Sound_Natural")
pis_n_nr[, QuadSize_m2 := as.factor(QuadSize_m2)]
pis_n_nr[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
pis_n_nr[, RelYear := as.numeric(Year) - min(as.numeric(Year))]
pis_n_nr[, Number_of_Oysters_Counted_Live_Count := Density_m2*QuadSize_m2]
pis_n_nr[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
pis_n_nr[, Density_m2 := as.integer(Density_m2)]
pis_n_nr[, Treatment := ifelse(reefIDcrosswalk == 170711, "Reference", "Control")]
saveRDS(pis_n_nr, here::here(paste0('GLMMs/AllDates/Data/pis_n_nr_', Sys.Date(), '.rds')))

ggplot(pis_n_nr, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() #+
#  theme(legend.position = "none")

ggplot(pis_n_nr, aes(x = as.factor(ProgramID), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() #+
#  theme(legend.position = "none")

pis_den_glmm_nr1 <- brm(formula = Density_m2 ~ RelYear, data = pis_n_nr, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr1.rds")
pis_den_glmm_nr1 <- add_criterion(pis_den_glmm_nr1, "loo")

pis_den_glmm_nr2 <- brm(formula = Density_m2 ~ as.factor(QuadSize_m2), data = pis_n_nr, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr2.rds")
pis_den_glmm_nr2 <- add_criterion(pis_den_glmm_nr2, "loo")

pis_den_glmm_nr3 <- brm(formula = Density_m2 ~ RelYear, data = pis_n_nr, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr3.rds")
pis_den_glmm_nr3 <- add_criterion(pis_den_glmm_nr3, "loo")

pis_den_glmm_nr4 <- brm(formula = Density_m2 ~ RelYear, data = pis_n_nr, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr4.rds")
pis_den_glmm_nr4 <- add_criterion(pis_den_glmm_nr4, "loo")

pis_den_glmm_nr5 <- brm(formula = Density_m2 ~ RelYear, data = pis_n_nr, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr5.rds")
pis_den_glmm_nr5 <- add_criterion(pis_den_glmm_nr5, "loo")

pis_den_glmm_nr6 <- brm(formula = Density_m2 ~ RelYear + (1 | reefIDcrosswalk), data = pis_n_nr, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr6.rds")
pis_den_glmm_nr6 <- add_criterion(pis_den_glmm_nr6, "loo")

pis_den_glmm_nr7 <- brm(formula = Density_m2 ~ RelYear + (1 | reefIDcrosswalk), data = pis_n_nr, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr7.rds")
pis_den_glmm_nr7 <- add_criterion(pis_den_glmm_nr7, "loo")

pis_den_glmm_nr8 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = pis_n_nr, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr8.rds")
pis_den_glmm_nr8 <- add_criterion(pis_den_glmm_nr8, "loo")

pis_den_glmm_nr9 <- brm(formula = Density_m2 ~ RelYear + (0 + RelYear | reefIDcrosswalk), data = pis_n_nr, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr9.rds")
pis_den_glmm_nr9 <- add_criterion(pis_den_glmm_nr9, "loo")

pis_den_glmm_nr10 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (1 | reefIDcrosswalk), data = pis_n_nr, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr10.rds")
pis_den_glmm_nr10 <- add_criterion(pis_den_glmm_nr10, "loo")

pis_den_glmm_nr11 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (1 | reefIDcrosswalk), data = pis_n_nr, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr11.rds")
pis_den_glmm_nr11 <- add_criterion(pis_den_glmm_nr11, "loo")

pis_den_glmm_nr12 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (0 + RelYear | reefIDcrosswalk), data = pis_n_nr, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr12.rds")
pis_den_glmm_nr12 <- add_criterion(pis_den_glmm_nr12, "loo")

pis_den_glmm_nr13 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (0 + RelYear | reefIDcrosswalk), data = pis_n_nr, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr13.rds")
pis_den_glmm_nr13 <- add_criterion(pis_den_glmm_nr13, "loo")

pis_den_glmm_nr14 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + (0 + RelYear | reefIDcrosswalk), data = pis_n_nr, family = hurdle_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr14.rds")
pis_den_glmm_nr14 <- add_criterion(pis_den_glmm_nr14, "loo")

#Tried fitting a model with "Treatment" as a fixed effect instead of "reefIDcrosswalk" as a grouping variable. Model did not converge.
pis_den_glmm_nr15 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2 + Treatment, data = pis_n_nr, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pis_den_glmm_nr15.rds")
pis_den_glmm_nr15 <- add_criterion(pis_den_glmm_nr15, "loo")

#GLMM12 is the best fit to the data, but the fit with the data looked really weird; for some reason the addition of QuadSize_m2 to the model (diff between GLMM12 and GLMM7) caused the trendline to become steeply positive and it looked like it bore no resemblance to the data in the marginal effects plots. Elpd_diff between them was only -26.5, so I went with the GLMM9 without the QuadSize_m2 variable. QuadSize_m2 is already a component of the calculated density values anyway, so I'm not sure it is necessary in the model.
loo_compare(pis_den_glmm_nr1, pis_den_glmm_nr2, pis_den_glmm_nr3, pis_den_glmm_nr4, pis_den_glmm_nr5, pis_den_glmm_nr6, pis_den_glmm_nr7, pis_den_glmm_nr8, pis_den_glmm_nr9, pis_den_glmm_nr10, pis_den_glmm_nr11, pis_den_glmm_nr12, pis_den_glmm_nr13, pis_den_glmm_nr14)


```

```{r message=FALSE, warning=FALSE, include=FALSE}
pis_n_nr <- subset(oysterraw_den_nona_nr, oysterraw_den_nona_nr$MA_plotlab == "Pine Island Sound_Natural")
pis_n_nr[, QuadSize_m2 := as.factor(QuadSize_m2)]
pis_n_nr[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
pis_n_nr[, RelYear := as.integer(Year) - min(as.integer(Year))]
pis_n_nr[, Number_of_Oysters_Counted_Live_Count := Density_m2*QuadSize_m2]
pis_n_nr[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
pis_n_nr[, Density_m2 := as.integer(Density_m2)]
pis_n_nr[, Treatment := ifelse(reefIDcrosswalk == 170711, "Reference", "Control")]
saveRDS(pis_n_nr, here::here(paste0('GLMMs/NovtoMar/Data/pis_n_nr_', Sys.Date(), '.rds')))

pis_den_glmm_nr <- readRDS(here::here('GLMMs/NovtoMar/pis_den_glmm_nr9.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

pis_n_nr[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
pis_n_nr[, SampleDay := day(SampleDate)]


den_t <- copy(pis_n_nr[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(pis_n_nr$Month))){
  mo <- subset(pis_n_nr, as.numeric(pis_n_nr$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(pis_n_nr, pis_n_nr$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = "All", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(Density_m2),
                       Median = median(Density_m2),
                       Mean = round(mean(Density_m2), digits = 2),
                       SD = round(sd(Density_m2), digits = 2), 
                       Min. = min(Density_m2),
                       Max. = max(Density_m2)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(pis_sho75, pis_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(pis_n_nr, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() #+
#  theme(legend.position = "none")

ggplot(pis_n_nr, aes(x = as.factor(ProgramID), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() #+
#  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(pis_den_glmm_nr)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_NovtoMar_GLMM_PIS_PDistandMChains_raw <- plot(pis_den_glmm_nr)
Den_NovtoMar_GLMM_PIS_PDistandMChains_raw

len <- length(Den_NovtoMar_GLMM_PIS_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_NovtoMar_GLMM_PIS_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_NovtoMar_GLMM_PIS_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_NovtoMar_GLMM_PIS_PPcheck_raw <- pp_check(pis_den_glmm_nr)
Den_NovtoMar_GLMM_PIS_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_GLMM_PIS_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_GLMM_PIS_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

Including the random effect of reef (i.e., managed area-wide credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
set.seed(987)
pis1_nr <- plot(conditional_effects(pis_den_glmm_nr, re_formula = NULL), plot = FALSE)[[1]]
Den_NovtoMar_GLMM_PIS_MEPrand_raw <- pis1_nr +
  geom_jitter(data = pis_n_nr, aes(x = RelYear, y = Density_m2, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = pis_n_nr, aes(y = -250, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(ylim = c(-250, 3000)) +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_NovtoMar_GLMM_PIS_MEPrand_raw

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_GLMM_PIS_MEPrand_raw_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_GLMM_PIS_MEPrand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
set.seed(986)
pis2_nr <- plot(conditional_effects(pis_den_glmm_nr, re_formula = NA), plot = FALSE)[[1]]
Den_NovtoMar_GLMM_PIS_MEPnorand_raw <- pis2_nr +
  geom_jitter(data = pis_n_nr, aes(x = RelYear, y = Density_m2, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = pis_n_nr, aes(y = -100, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(ylim = c(-100, 3000)) +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_NovtoMar_GLMM_PIS_MEPnorand_raw

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_GLMM_PIS_MEPnorand_raw_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_GLMM_PIS_MEPnorand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

Individual effects plots:
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Individual effects plots
#labs1 <- sort(unique(pis_n$Year))[c(TRUE, FALSE)]
#labs2 <- sort(unique(pis_n$Year))[c(FALSE, TRUE)]

Den_NovtoMar_GLMM_PIS_IEP_raw <- pis_n_nr %>%
  group_by(reefIDcrosswalk) %>%
  add_fitted_draws(pis_den_glmm_nr) %>%
  ggplot(aes(x = RelYear, y = Density_m2, color = reefIDcrosswalk)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = pis_n_nr) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  #scale_color_brewer(palette = "Set2") +
  geom_text(data = pis_n_nr, aes(y = -50, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(pis_n, pis_n$Year %in% labs1), aes(y = -50, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  #geom_text(data = subset(pis_n, pis_n$Year %in% labs2), aes(y = -100, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(pis_n_nr$RelYear) + 1)) +
  #scale_y_continuous(limits = c(-50, 3000)) +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ reefIDcrosswalk, ncol = 1, scales = "free")
Den_NovtoMar_GLMM_PIS_IEP_raw

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_GLMM_PIS_IEP_raw_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_GLMM_PIS_IEP_raw,
       width = 10,
       height = 5,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(pis_n_nr, pis_den_glmm_nr, 
   Den_NovtoMar_GLMM_PIS_PDistandMChains_raw,
   Den_NovtoMar_GLMM_PIS_PPcheck_raw,
   Den_NovtoMar_GLMM_PIS_MEPrand_raw,
   Den_NovtoMar_GLMM_PIS_MEPnorand_raw,
   Den_NovtoMar_GLMM_PIS_IEP_raw
   )

```

<br><br><br>

##### Pine Island Sound (Restored) {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

pisr_n_nr <- subset(oysterraw_den_nona_nr, oysterraw_den_nona_nr$MA_plotlab == "Pine Island Sound_Restored")
pisr_n_nr[, QuadSize_m2 := as.numeric(QuadSize_m2)]
pisr_n_nr[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
pisr_n_nr[, RelYear := Year - min(Year)]
pisr_n_nr[, Number_of_Oysters_Counted_Live_Count := Density_m2*QuadSize_m2]
pisr_n_nr[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
saveRDS(pisr_n_nr, here::here(paste0('GLMMs/NovtoMar/Data/pisr_n_nr_', Sys.Date(), '.rds')))

pisr_den_glmm_nr <- brm(formula = Number_of_Oysters_Counted_Live_Count ~ RelYear + offset(log(QuadSize_m2)) + (1 + RelYear|reefIDcrosswalk), data = pisr_n_nr, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
pisr_den_glmm_nr <- add_criterion(pisr_den_glmm_nr, "loo")



pisr_n_nr <- subset(oysterraw_den_nona_nr, oysterraw_den_nona_nr$MA_plotlab == "Pine Island Sound_Restored")
pisr_n_nr[, QuadSize_m2 := as.numeric(QuadSize_m2)]
pisr_n_nr[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
pisr_n_nr[, RelYear := as.numeric(Year) - min(as.numeric(Year))]
pisr_n_nr[, Number_of_Oysters_Counted_Live_Count := Density_m2*QuadSize_m2]
pisr_n_nr[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
pisr_n_nr[, Density_m2 := as.integer(Density_m2)]
saveRDS(pisr_n_nr, here::here(paste0('GLMMs/NovtoMar/Data/pisr_n_nr_', Sys.Date(), '.rds')))

ggplot(pisr_n_nr, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(pisr_n_nr, aes(x = as.factor(reefIDcrosswalk), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() +
  theme(legend.position = "none")

pisr_den_glmm_nr1 <- brm(formula = Density_m2 ~ RelYear, data = pisr_n_nr, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pisr_den_glmm_nr1.rds")
pisr_den_glmm_nr1 <- add_criterion(pisr_den_glmm_nr1, "loo")

pisr_den_glmm_nr2 <- brm(formula = Density_m2 ~ as.factor(QuadSize_m2), data = pisr_n_nr, family = gaussian, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pisr_den_glmm_nr2.rds")
pisr_den_glmm_nr2 <- add_criterion(pisr_den_glmm_nr2, "loo")

pisr_den_glmm_nr3 <- brm(formula = Density_m2 ~ RelYear, data = pisr_n_nr, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pisr_den_glmm_nr3.rds")
pisr_den_glmm_nr3 <- add_criterion(pisr_den_glmm_nr3, "loo")

pisr_den_glmm_nr4 <- brm(formula = Density_m2 ~ RelYear, data = pisr_n_nr, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pisr_den_glmm_nr4.rds")
pisr_den_glmm_nr4 <- add_criterion(pisr_den_glmm_nr4, "loo")

pisr_den_glmm_nr5 <- brm(formula = Density_m2 ~ RelYear, data = pisr_n_nr, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pisr_den_glmm_nr5.rds")
pisr_den_glmm_nr5 <- add_criterion(pisr_den_glmm_nr5, "loo")

pisr_den_glmm_nr6 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n_nr, family = poisson, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pisr_den_glmm_nr6.rds")
pisr_den_glmm_nr6 <- add_criterion(pisr_den_glmm_nr6, "loo")

pisr_den_glmm_nr7 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n_nr, family = negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pisr_den_glmm_nr7.rds")
pisr_den_glmm_nr7 <- add_criterion(pisr_den_glmm_nr7, "loo")

pisr_den_glmm_nr8 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n_nr, family = zero_inflated_negbinomial, cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pisr_den_glmm_nr8.rds")
pisr_den_glmm_nr8 <- add_criterion(pisr_den_glmm_nr8, "loo")

#Trying the best-fitting model again with custom priors because this is a restoration site, so it has a discrete beginning in 2015 with known low density to start.
pisr_den_glmm_nr9 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n_nr, family = zero_inflated_negbinomial, prior = c(set_prior("uniform(0,5)", class = "b", coef = "RelYear"), set_prior("uniform(0,50)", class = "Intercept")), cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pisr_den_glmm_nr9.rds")
pisr_den_glmm_nr9 <- add_criterion(pisr_den_glmm_nr9, "loo")

pisr_den_glmm_nr10 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n_nr, family = zero_inflated_negbinomial, prior = c(set_prior("uniform(0,5)", class = "b", lb = 0, ub = 5), set_prior("uniform(0,50)", class = "Intercept")), cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pisr_den_glmm_nr10.rds")
pisr_den_glmm_nr10 <- add_criterion(pisr_den_glmm_nr10, "loo")

#Trying previous model again without the intercept prior.
pisr_den_glmm_nr11 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n_nr, family = zero_inflated_negbinomial, prior = set_prior("uniform(0,5)", class = "b", lb = 0, ub = 5), cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pisr_den_glmm_nr11.rds")
pisr_den_glmm_nr11 <- add_criterion(pisr_den_glmm_nr11, "loo")

#Trying model 10 again without the RelYear prior.
pisr_den_glmm_nr12 <- brm(formula = Density_m2 ~ RelYear + QuadSize_m2, data = pisr_n_nr, family = zero_inflated_negbinomial, prior = set_prior("uniform(0,50)", class = "Intercept"), cores = 2, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/pisr_den_glmm_nr12.rds")
pisr_den_glmm_nr12 <- add_criterion(pisr_den_glmm_nr12, "loo")

#GLMM12 is the best fit to the data, but I think the lower bound of 0 on RelYear is important because that was the start date of the restored reef and the upper bound of 5 because you can't have years that haven't happened yet, so I have gone with model 9. The best fit models (8 and 12) show declining curves from impossible y-intercepts given that the restored reef really should start with low oyster density.
loo_compare(pisr_den_glmm_nr1, pisr_den_glmm_nr2, pisr_den_glmm_nr3, pisr_den_glmm_nr4, pisr_den_glmm_nr5, pisr_den_glmm_nr6, pisr_den_glmm_nr7, pisr_den_glmm_nr8, pisr_den_glmm_nr9, pisr_den_glmm_nr10, pisr_den_glmm_nr11, pisr_den_glmm_nr12)


```

```{r message=FALSE, warning=FALSE, include=FALSE}
pisr_n_nr <- subset(oysterraw_den_nona_nr, oysterraw_den_nona_nr$MA_plotlab == "Pine Island Sound_Restored")
pisr_n_nr[, QuadSize_m2 := as.numeric(QuadSize_m2)]
pisr_n_nr[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
pisr_n_nr[, RelYear := as.integer(Year) - min(as.integer(Year))]
pisr_n_nr[, Number_of_Oysters_Counted_Live_Count := Density_m2*QuadSize_m2]
pisr_n_nr[, Number_of_Oysters_Counted_Live_Count := as.integer(Number_of_Oysters_Counted_Live_Count)]
saveRDS(pisr_n_nr, here::here(paste0('GLMMs/NovtoMar/Data/pisr_n_nr_', Sys.Date(), '.rds')))

pisr_den_glmm_nr <- readRDS(here::here('GLMMs/NovtoMar/pisr_den_glmm_nr9.rds'))

```

###### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

pisr_n_nr[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
pisr_n_nr[, SampleDay := day(SampleDate)]


den_t <- copy(pisr_n_nr[0, ])
den_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(pisr_n_nr$Month))){
  mo <- subset(pisr_n_nr, as.numeric(pisr_n_nr$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  den_t <- rbind(mo, den_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(den_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(den_t, monthnames, SampleDatesPlot)

```

<br><br><br>

###### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
den_raw_status <- subset(pisr_n_nr, pisr_n_nr$Year %in% StatusYears)
den_raw_status[, `:=` (Indicator = "Density", 
                       SizeClass = "All", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(Density_m2),
                       Median = median(Density_m2),
                       Mean = round(mean(Density_m2), digits = 2),
                       SD = round(sd(Density_m2), digits = 2), 
                       Min. = min(Density_m2),
                       Max. = max(Density_m2)),
                by = Year]

den_raw_status <- unique(den_raw_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
den_raw_status <- den_raw_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, den_raw_status$Year) == FALSE){
  for(i in setdiff(StatusYears, den_raw_status$Year)){
    MissingYr_i <- data.table(Indicator = "Density", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    den_raw_status <- rbind(den_raw_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(pisr_sho75, pisr_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, den_raw_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, den_raw_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

###### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(pisr_n_nr, aes(x = RelYear, y = as.factor(QuadSize_m2), color = reefIDcrosswalk)) +
  geom_jitter() +
  theme(legend.position = "none")

ggplot(pisr_n_nr, aes(x = as.factor(reefIDcrosswalk), y = as.factor(QuadSize_m2), color = RelYear)) +
  geom_jitter() +
  theme(legend.position = "none")

```

<br><br><br>

###### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(pisr_den_glmm_nr)
```

<br><br><br>

###### Diagnostic Plots

Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_NovtoMar_GLMM_PISR_PDistandMChains_raw <- plot(pisr_den_glmm_nr)
Den_NovtoMar_GLMM_PISR_PDistandMChains_raw

len <- length(Den_NovtoMar_GLMM_PISR_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Den_NovtoMar_GLMM_PISR_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Den_NovtoMar_GLMM_PISR_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Den_NovtoMar_GLMM_PISR_PPcheck_raw <- pp_check(pisr_den_glmm_nr)
Den_NovtoMar_GLMM_PISR_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_GLMM_PISR_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_GLMM_PISR_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

###### Marginal Effects Plots

```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=4, fig.width=5, out.width="100%"}
#Marginal effects plot including random effects
pisr1_nr <- plot(conditional_effects(pisr_den_glmm_nr), plot = FALSE)[[1]]
Den_NovtoMar_GLMM_PISR_MEP_raw <- pisr1_nr +
  geom_jitter(data = pisr_n_nr, aes(x = RelYear, y = Density_m2, fill = reefIDcrosswalk), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = pisr_n_nr, aes(y = -100, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  theme_bw() +
  #ylim(0, 3000) +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Den_NovtoMar_GLMM_PISR_MEP_raw

ggsave(here::here(paste0("OA_plots/Den_NovtoMar_GLMM_PISR_MEP_raw_", Sys.Date(), ".jpeg")),
       Den_NovtoMar_GLMM_PISR_MEP_raw,
       width = 5,
       height = 4,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(pisr_n_nr, pisr_den_glmm_nr, 
   Den_NovtoMar_GLMM_PISR_PDistandMChains_raw,
   Den_NovtoMar_GLMM_PISR_PPcheck_raw,
   Den_NovtoMar_GLMM_PISR_MEP_raw
   )

```

<br><br><br>

#### Only 25-75mm shell height {.tabset .tabset-fade .tabset-pills}

No combinations of Managed Area and Habitat Classification had five or more years of data, so density by size class trends were not assessed.

<br><br><br>

#### Only >75mm shell height {.tabset .tabset-fade .tabset-pills}

No combinations of Managed Area and Habitat Classification had five or more years of data, so density by size class trends were not assessed.

<br><br><br>

***

## Percent live

```{r Percent-live-data-setup-and-summarize-nr, echo=TRUE, message=FALSE, warning=FALSE}


setDT(oysterraw_pct_nr)
# oysterraw_pct_nr <- oysterraw_pct_nr %>% mutate(SampleDate = mdy_hms(SampleDate))
# oysterraw_pct_nr[, Month := month(SampleDate)]
# oysterraw_pct_nr[, YrMo := paste0(Year, "-", Month)]
# oysterraw_pct_nr[PercentLiveMethod == "Point-Intercept", PercentLiveMethod := "Point-intercept"]

#More complicated conversion of date columns needed because ID_972 data do not have the hms format for time like the default in the combined table exports. When it eventually is corrected and fixed in the combined table export, then all program data should have the same SampleDate format and the above code should work again.
oysterraw_pct_nr_no972 <- setDT(subset(oysterraw_pct_nr, oysterraw_pct_nr$ProgramID != 972)) %>% mutate(SampleDate = mdy_hms(SampleDate))
oysterraw_pct_nr_no972[, Month := month(SampleDate)]
oysterraw_pct_nr_no972[, YrMo := paste0(Year, "-", Month)]

oysterraw_pct_nr_972 <- setDT(subset(oysterraw_pct_nr, oysterraw_pct_nr$ProgramID == 972)) %>% mutate(SampleDate = mdy_hm(SampleDate))
oysterraw_pct_nr_972[, Month := month(SampleDate)]
oysterraw_pct_nr_972[, YrMo := paste0(Year, "-", Month)]

oysterraw_pct_nr <- rbind(oysterraw_pct_nr_no972, oysterraw_pct_nr_972)


#Fix QuadID and ReefID columns for 2003 data in program 4014
Reefs_4014_2003 <- c('1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13')
Quads_4014_2003 <- c('1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '13', '14')
Fix4014 <- oysterraw_pct_nr[ProgramID == 4014, ][Year == 2003, QuadIdentifier := Quads_4014_2003][Year == 2003, ReefIdentifier := Reefs_4014_2003]
no4014 <- subset(oysterraw_pct_nr, oysterraw_pct_nr$ProgramID != 4014)
oysterraw_pct_nr <- rbind(Fix4014, no4014)

#Fix HabitatClassification of 4012
oysterraw_pct_nr[QuadIdentifier %like% "_Ref", HabitatClassification := "Natural"]
oysterraw_pct_nr[QuadIdentifier %like% "_C", HabitatClassification := "Natural"]

saveRDS(oysterraw_pct_nr, here::here("oysterraw_pct_nr.rds"))

#Summarize percent live data by managed area
oysterraw_pct_nona_nr <- subset(oysterraw_pct_nr, !is.na(oysterraw_pct_nr$PercentLive_pct))
oysterraw_pct_nona_nr[, Year := as.integer(Year)]
oysterraw_pct_nona_nr[ProgramID == 4012, PercentLiveMethod := "Percent"]
oysterraw_pct_nona_nr[PercentLiveMethod == "percent", PercentLiveMethod := "Percent"]
pct_all_sum_nr <- setDT(summarySE(oysterraw_pct_nona_nr, measurevar = 'PercentLive_pct', groupvars = c('ManagedAreaName', 'Year', 'PercentLiveMethod')))
```

```{r PctSummaryTable-nr, echo=TRUE, message=FALSE, warning=FALSE}
#Create summary table showing number of reefs/programs of data included in oysterraw_pct_nr
oysterraw_pct_nona_nr[, nReefsbyMAandYr := length(unique(reefIDcrosswalk)), by = c('ManagedAreaName', 'Year')]
oysterraw_pct_nona_nr[, nProgsbyMAandYr := length(unique(ProgramID)), by = c('ManagedAreaName', 'Year')]
oysterraw_pct_nona_nr[, ProgsbyMAandYr := list(list(unique(ProgramID))), by = c('ManagedAreaName', 'Year')]
oysterraw_pct_nona_nr[, nProgsbyMA := length(unique(ProgramID)), by = 'ManagedAreaName']
oysterraw_pct_nona_nr[, ProgsbyMA := list(list(unique(ProgramID))), by = 'ManagedAreaName']

pct_sum1_nr <- unique(oysterraw_pct_nona_nr[, .(ManagedAreaName, Year, nReefsbyMAandYr, nProgsbyMAandYr, nProgsbyMA)], by = c('ManagedAreaName', 'Year', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'nProgsbyMA'))
listcols <- oysterraw_pct_nona_nr[, .SD[1], by = c('ManagedAreaName', 'Year')][, .(ProgsbyMAandYr, ProgsbyMA)]
pct_sum1_nr <- cbind(pct_sum1_nr, listcols)
setcolorder(pct_sum1_nr, c('ManagedAreaName', 'nProgsbyMA', 'ProgsbyMA', 'Year', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'))
setorder(pct_sum1_nr, ManagedAreaName, Year)

#Create easily readable table in knitted document
#Better column names
pct_sum1_renamed_nr <- setnames(pct_sum1_nr, c('nProgsbyMA', 'ProgsbyMA', 'nReefsbyMAandYr', 'nProgsbyMAandYr', 'ProgsbyMAandYr'), c('n progams_tot', 'programs_tot', 'n reefs_yr', 'n programs_yr', 'programs_yr'))

#Group names
groups <- c()
for(i in unique(pct_sum1_nr$ManagedAreaName)){
  name <- paste0(i, ", Total Programs = ", pct_sum1_nr[ManagedAreaName == i, 2][1], ": ", pct_sum1_nr[ManagedAreaName == i, 3][[1]])[1]
  groups <- append(groups, name)
}

```  

```{r AvgPctLive-setup-nr, echo=TRUE, message=FALSE, warning=FALSE}
#Pct live, all and by reef
pct_avg_all_nr <- oysterraw_pct_nona_nr[, MeanPct := mean(PercentLive_pct), by = c('ManagedAreaName', 'Year')][, sdPct := sd(PercentLive_pct), by = c('Year', 'ManagedAreaName')][, semPct := sd(PercentLive_pct)/sqrt(length(PercentLive_pct)), by = c('Year', 'ManagedAreaName')][, nYears := length(unique(Year)), by = c('ManagedAreaName')][, MeanReefPct := mean(PercentLive_pct), by = c('Year', 'ManagedAreaName', 'reefIDcrosswalk')][, sdReefPct := sd(PercentLive_pct), by = c('Year', 'ManagedAreaName', 'reefIDcrosswalk')][, semReefPct := sd(PercentLive_pct)/sqrt(length(PercentLive_pct)), by = c('Year', 'ManagedAreaName', 'reefIDcrosswalk')][, nYearsReef := length(unique(Year)), by = c('ManagedAreaName', 'reefIDcrosswalk')][, YrMo := format(as.Date(SampleDate), "%Y-%m")][, MeanReefPct_yrmo := mean(PercentLive_pct), by = c('YrMo', 'ManagedAreaName', 'reefIDcrosswalk')][, sdReefPct_yrmo := sd(PercentLive_pct), by = c('YrMo', 'ManagedAreaName', 'reefIDcrosswalk')][, semReefPct_yrmo := sd(PercentLive_pct)/sqrt(length(PercentLive_pct)), by = c('YrMo', 'ManagedAreaName', 'reefIDcrosswalk')][, nYearsReef_yrmo := length(unique(YrMo)), by = c('ManagedAreaName', 'reefIDcrosswalk')]
#pct_avg_reef <- unique(pct_avg_all_nr[, c(1:2, 7:8, 10, 12:16, 21:23, 28:31)])
#pct_avg_reef_yr_nr <- unique(pct_avg_all_nr[, c(1:2, 8, 10, 12:16, 21:24, 30:33)])
#pct_avg_reef_yrmo_nr <- unique(pct_avg_all_nr[, c(1:2, 8, 10, 12:16, 21:23, 34:37)])
pct_avg_reef_yr_nr <- unique(pct_avg_all_nr[, c("ProgramID", "ProgramName", "Year", "ManagedAreaName", "SurveyMethod", "PercentLiveMethod", "HabitatClassification", "QuadSize_m2", "MADup", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "MeanReefPct", "sdReefPct", "semReefPct", "nYearsReef")])
pct_avg_reef_yrmo_nr <- unique(pct_avg_all_nr[, c("ProgramID", "ProgramName", "Year", "ManagedAreaName", "SurveyMethod", "PercentLiveMethod", "HabitatClassification", "QuadSize_m2", "MADup", "reefIDcrosswalk", "Region.y", "MA_plotlab", "Subtidal", "MeanReefPct_yrmo", "sdReefPct_yrmo", "semReefPct_yrmo", "nYearsReef_yrmo")])

```

<br><br><br>

### View the data {.tabset .tabset-fade}

#### Histograms

```{r AvgPctbyReefandYR-hist-nr, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#histogram of average shell height by reef and year
Pct_NovtoMar_AvgbyReefandYr_raw <- ggplot(pct_avg_reef_yr_nr, aes(MeanReefPct)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_histogram(color = "black") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free")
Pct_NovtoMar_AvgbyReefandYr_raw

ggsave(here::here(paste0("OA_plots/Pct_NovtoMar_AvgbyReefandYr_raw_", Sys.Date(), ".jpeg")),
       Pct_NovtoMar_AvgbyReefandYr_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

#### Normal QQ plots

```{r AvgPctbyReefandYR-qqplot-nr, echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#QQ plot of average shell height by reef and year
Pct_NovtoMar_QQbyReefandYr_raw <- ggplot(pct_avg_reef_yr_nr, aes(sample = MeanReefPct)) +
  theme_bw() + theme(axis.line = element_line()) +
  geom_qq(shape = 1) +
  geom_qq_line(color = "red") +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free")
Pct_NovtoMar_QQbyReefandYr_raw

ggsave(here::here(paste0("OA_plots/Pct_NovtoMar_QQbyReefandYr_raw_", Sys.Date(), ".jpeg")),
       Pct_NovtoMar_QQbyReefandYr_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

### Regression summary tables {.tabset .tabset-fade}

#### Quantile regression

```{r AvgPctbyReefandYR-QReg-nr, echo=TRUE, message=FALSE, warning=FALSE}
#Run nonparametric regression (quantile regression) on average >25mm SH reef-level data by year, if there are >4 years of data
#Followed quantile regression example here: https://rcompanion.org/handbook/F_12.html; accessed 10/14/2020
qreg_results_pct_nr <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), pvalue = numeric(), pseudoR2 = numeric())
for(i in unique(pct_avg_reef_yrmo_nr$MA_plotlab)){
  qrdat <- pct_avg_reef_yrmo_nr[MA_plotlab == i, ]
  if(max(qrdat$Year) - min(qrdat$Year) < 5) next
  quantregs <- rq(MeanReefPct_yrmo ~ Year, data = qrdat, tau = 0.5)
  nullmod <- rq(MeanReefPct_yrmo ~ 1, data = qrdat, tau = 0.5)
  anov <- anova(quantregs, nullmod)
  PseudR <- nagelkerke(quantregs)
  iresult <- data.table(MA_plotlab = i, intercept = quantregs$coefficients[[1]], slope = quantregs$coefficients[[2]], pvalue = anov$table[[4]], pseudoR2 = PseudR$Pseudo.R.squared.for.model.vs.null[[3]])
  qreg_results_pct_nr <- rbind(qreg_results_pct_nr, iresult)
}

setorder(qreg_results_pct_nr, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
qreg_results_pct_renamed_nr <- setnames(qreg_results_pct_nr, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(qreg_results_pct_nr, 'Managed Area_Habitat Class.', 'MA_plotlab')

qreg_results_pct_renamed_nr %>% 
  kbl(align = "lcccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)
```

#### Linear regression

```{r AvgPctbyReefandYR-LinReg-nr, echo=TRUE, message=FALSE, warning=FALSE}
#Linear regression version instead of quantile regression
lm_results_pct_nr <- data.table(MA_plotlab = character(), intercept = numeric(), slope = numeric(), Fstatistic = numeric(), numdf = numeric(), dendf = numeric(), pvalue = numeric(), adjustedR2 = numeric())
for(i in unique(pct_avg_reef_yr_nr$MA_plotlab)){
  lmdat <- pct_avg_reef_yr_nr[MA_plotlab == i, ]
  if(max(lmdat$Year) - min(lmdat$Year) < 5) next
  lms <- lm(MeanReefPct ~ Year, data = lmdat)
  iresult <- data.table(MA_plotlab = i, intercept = lms$coefficients[[1]], slope = lms$coefficients[[2]], Fstatistic = summary(lms)$fstatistic[[1]], numdf = summary(lms)$fstatistic[[2]], dendf = summary(lms)$fstatistic[[3]], pvalue = anova(lms)$Pr[1], adjustedR2 = summary(lms)$adj.r.squared)
  lm_results_pct_nr <- rbind(lm_results_pct_nr, iresult)
}

setorder(lm_results_pct_nr, MA_plotlab)

#Create easily readable table in knitted document
#Better column name
lm_results_pct_renamed_nr <- setnames(lm_results_pct_nr, 'MA_plotlab', 'Managed Area_Habitat Class.')
setnames(lm_results_pct_nr, 'Managed Area_Habitat Class.', 'MA_plotlab')

lm_results_pct_renamed_nr %>% 
  kbl(align = "lccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  column_spec(1, bold = T)

```

<br><br><br>

### Linear regression diagnostic plots {.tabset .tabset-fade}

#### Lemon Bay_Natural

```{r echo=TRUE, fig.show="hold", out.width="50%"}

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr_nr[MA_plotlab == "Lemon Bay_Natural", ]), which = 1)

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr_nr[MA_plotlab == "Lemon Bay_Natural", ]), which = 2)

```

```{r echo=TRUE, fig.show="hold", out.width="50%"}

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr_nr[MA_plotlab == "Lemon Bay_Natural", ]), which = 3)

plot(lm(MeanReefPct ~ Year, data = pct_avg_reef_yr_nr[MA_plotlab == "Lemon Bay_Natural", ]), which = 4)

```

<br><br><br>

### Regression plots {.tabset .tabset-fade}

#### Quantile regression

```{r AvgPctbyReefandYR-QuantRegPlot-nr, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
#Plot reef-level average percent live, including quantile regression lines, as applicable, and full range of years.
Pct_NovtoMar_QuantReg_raw <- ggplot(pct_avg_reef_yrmo_nr, aes(Year, MeanReefPct_yrmo, fill = reefIDcrosswalk)) +
  theme_bw() +
  geom_point(shape = 21) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = qreg_results_pct_nr, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 90), axis.line = element_line())
Pct_NovtoMar_QuantReg_raw

ggsave(here::here(paste0("OA_plots/Pct_NovtoMar_QuantReg_raw_", Sys.Date(), ".jpeg")),
       Pct_NovtoMar_QuantReg_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

#### Linear regression

```{r AvgPctbyReefandYR-LinRegPlot-nr, echo=TRUE, message = FALSE, warning = FALSE, fig.height=20, fig.width=10, out.width="100%"}
Pct_NovtoMar_LinReg_raw <- ggplot(pct_avg_reef_yr_nr, aes(Year, MeanReefPct, fill = reefIDcrosswalk)) +
  theme_bw() +
  geom_point(shape = 21) +
  facet_wrap(~MA_plotlab, ncol = 3, scales = "free") +
  geom_abline(data = lm_results_pct_nr, aes(intercept = intercept, slope = slope)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 90), axis.line = element_line())
Pct_NovtoMar_LinReg_raw

ggsave(here::here(paste0("OA_plots/Pct_NovtoMar_LinReg_raw_", Sys.Date(), ".jpeg")),
       Pct_NovtoMar_LinReg_raw,
       width = 10,
       height = 20,
       units = "in",
       dpi = 300)
```

<br><br><br>

### Generalized Linear Mixed Effects Models {.tabset .tabset-fade}

#### Lemon Bay {.tabset .tabset-fade .tabset-pills}

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE, out.width="100%"}

lb_p_nr <- subset(oysterraw_pct_nona_nr, oysterraw_pct_nona_nr$MA_plotlab == "Lemon Bay_Natural")
lb_p_nr[, QuadSize_m2 := as.factor(QuadSize_m2)]
#lb_p_nr[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
lb_p_nr[, RelYear := as.numeric(Year) - min(as.numeric(Year))]
lb_p_nr[, PercentLive_dec := PercentLive_pct/100]
#lb_p_nr[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", Year, "-", Month)]
saveRDS(lb_p_nr, here::here(paste0('GLMMs/NovtoMar/Data/lb_p_nr_', Sys.Date(), '.rds')))

# lb_pct_glmm <- brm(formula = PercentLive_pct ~ RelYear + QuadSize_m2 + (1 + RelYear|reefIDcrosswalk), data = lb_p_nr, family = student(link = "identity", link_sigma = "log", link_nu = "logm1"), cores = 3, prior = c(set_prior("normal(0,10)", class = "b"), set_prior("cauchy(0,2", class = "sd")), control= list(adapt_delta = 0.99), iter = 8000, warmup = 1000, chains = 3, inits = 0, thin = 3)
# lb_pct_glmm <- add_criterion(lb_pct_glmm, "loo")

ggplot(lb_p_nr, aes(x = RelYear, y = PercentLive_dec, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw()

ggplot(lb_p_nr, aes(x = RelYear, y = QuadSize_m2, color = reefIDcrosswalk)) +
  geom_jitter() +
  theme_bw()

ggplot(lb_p_nr, aes(x = RelYear, y = reefIDcrosswalk, color = factor(ProgramID))) +
  geom_point() +
  theme_bw()

#Model converged, intercept significant. 
lb_pct_glmm_nr1 <- brm(formula = PercentLive_dec ~ 1, data = lb_p_nr, family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/lb_pct_glmm_nr1.rds")
lb_pct_glmm_nr1 <- add_criterion(lb_pct_glmm_nr1, "loo")

lb_pct_glmm_nr2 <- brm(formula = PercentLive_dec ~ 1, data = subset(lb_p_nr, lb_p_nr$PercentLive_dec > 0), family = Beta, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/lb_pct_glmm_nr2.rds")
lb_pct_glmm_nr2 <- add_criterion(lb_pct_glmm_nr2, "loo")

lb_pct_glmm_nr3 <- brm(formula = PercentLive_dec ~ 1, data = subset(lb_p_nr, lb_p_nr$PercentLive_dec > 0), family = gaussian, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/lb_pct_glmm_nr3.rds")
lb_pct_glmm_nr3 <- add_criterion(lb_pct_glmm_nr3, "loo")

#Beta distribution (GLMM 2) is the better fit, but note that this required dropping the one zero-value data point.
loo_compare(lb_pct_glmm_nr2, lb_pct_glmm_nr3)

lb_pct_glmm_nr4 <- brm(formula = PercentLive_dec ~ RelYear, data = subset(lb_p_nr, lb_p_nr$PercentLive_dec > 0), family = Beta, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/lb_pct_glmm_nr4.rds")
lb_pct_glmm_nr4 <- add_criterion(lb_pct_glmm_nr4, "loo")

lb_pct_glmm_nr5 <- brm(formula = PercentLive_dec ~ RelYear + (1 | ReefIdentifier), data = subset(lb_p_nr, lb_p_nr$PercentLive_dec > 0), family = Beta, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/lb_pct_glmm_nr5.rds")
lb_pct_glmm_nr5 <- add_criterion(lb_pct_glmm_nr5, "loo")

lb_pct_glmm_nr6 <- brm(formula = PercentLive_dec ~ RelYear + (0 + RelYear | ReefIdentifier), data = subset(lb_p_nr, lb_p_nr$PercentLive_dec > 0), family = Beta, cores = 4, control= list(adapt_delta = 0.99, max_treedepth = 15), iter = 3000, warmup = 1000, chains = 4, inits = 0, thin = 3, backend = "cmdstanr", threads = threading(2), file = "GLMMs/NovtoMar/lb_pct_glmm_nr6.rds")
lb_pct_glmm_nr6 <- add_criterion(lb_pct_glmm_nr6, "loo")

#GLMM 6 is the best fit.
loo_compare(lb_pct_glmm_nr4, lb_pct_glmm_nr5, lb_pct_glmm_nr6)


```

```{r message=FALSE, warning=FALSE, include=FALSE}
lb_p_nr <- subset(oysterraw_pct_nona_nr, oysterraw_pct_nona_nr$MA_plotlab == "Lemon Bay_Natural")
lb_p_nr[, QuadSize_m2 := as.factor(QuadSize_m2)]
#lb_p_nr[, reefIDcrosswalk := as.factor(reefIDcrosswalk)]
lb_p_nr[, RelYear := as.numeric(Year) - min(as.numeric(Year))]
lb_p_nr[, PercentLive_dec := PercentLive_pct/100]
#lb_p_nr[, rc_quad_yrmo := paste0(reefIDcrosswalk, "_", QuadIdentifier, "_", Year, "-", Month)]
saveRDS(lb_p_nr, here::here(paste0('GLMMs/AllDates/Data/lb_p_nr_', Sys.Date(), '.rds')))

lb_pct_glmm_nr <- readRDS(here::here('GLMMs/NovtoMar/lb_pct_glmm_nr6.rds'))

```

##### Program sample dates

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

lb_p_nr[, SampleMonthDay := paste0(month(SampleDate), "_", day(SampleDate))]
lb_p_nr[, SampleDay := day(SampleDate)]


pct_t <- copy(lb_p_nr[0, ])
pct_t[, `:=` (DayNum = as.numeric(), Season = as.character())]
for(i in unique(as.numeric(lb_p_nr$Month))){
  mo <- subset(lb_p_nr, as.numeric(lb_p_nr$Month) == i)
  ifelse(i == 1, mo[, `:=` (DayNum = 0 + SampleDay, Season = "Winter")],
         ifelse(i == 2, mo[, `:=` (DayNum = 31 + SampleDay, Season = "Winter")],
                ifelse(i == 3, mo[, `:=` (DayNum = 59 + SampleDay, Season = "Spring")],
                       ifelse(i == 4, mo[, `:=` (DayNum = 90 + SampleDay, Season = "Spring")],
                              ifelse(i == 5, mo[, `:=` (DayNum = 120 + SampleDay, Season = "Spring")],
                                     ifelse(i == 6, mo[, `:=` (DayNum = 151 + SampleDay, Season = "Summer")],
                                            ifelse(i == 7, mo[, `:=` (DayNum = 181 + SampleDay, Season = "Summer")],
                                                   ifelse(i == 8, mo[, `:=` (DayNum = 212 + SampleDay, Season = "Summer")],
                                                          ifelse(i == 9, mo[, `:=` (DayNum = 243 + SampleDay, Season = "Fall")],
                                                                 ifelse(i == 10, mo[, `:=` (DayNum = 273 + SampleDay, Season = "Fall")],
                                                                        ifelse(i == 11, mo[, `:=` (DayNum = 304 + SampleDay, Season = "Fall")], mo[, `:=` (DayNum = 334 + SampleDay, Season = "Winter")])))))))))))
  pct_t <- rbind(mo, pct_t)
}

monthnames <- data.table(months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), positions = c(3, 34, 62, 93, 123, 154, 184, 215, 246, 276, 307, 337))

#Create the sampling dates correspondence plot
SampleDatesPlot <- ggplot(pct_t, aes(x = DayNum, y = as.factor(ProgramID), color = as.factor(Year), shape = Season)) +
                      geom_point(size = 3) +
                      geom_vline(xintercept = c(1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366), lty = "dashed", color = "grey30") +
                      geom_text(data = monthnames, aes(y = 0.5, label = months, x = positions + 13), size = 4, col = "grey30", inherit.aes = FALSE) +
                      xlim(1,365) +
                      scale_x_continuous(breaks = NULL) +
                      coord_cartesian(xlim = c(1, 366)) +
                      theme_bw()+labs(x = "Sample Date", y = "Program ID")
print(SampleDatesPlot)

#Remove the objects after the plot is done.
rm(pct_t, monthnames, SampleDatesPlot)

```

<br><br><br>

##### Status statistics

<br>

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Status <- data.table(Indicator = as.character(), 
                     SizeClass = as.character(),
                     Year = as.numeric(),
                     n_reefs = as.numeric(),
                     n_programs = as.numeric(),
                     ProgIDs = list(),
                     n_samples = as.numeric(),
                     Median = as.numeric(), 
                     Mean = as.numeric(),
                     SD = as.numeric(),
                     Min. = as.numeric(),
                     Max. = as.numeric())

StatusYears <- c(2018, 2019, 2020)

#Build status table for raw density.
pct_status <- subset(lb_p_nr, lb_p_nr$Year %in% StatusYears)
pct_status[, `:=` (Indicator = "Percent Live", 
                       SizeClass = "All", 
                       Year = as.numeric(Year), 
                       n_reefs = length(unique(ReefIdentifier)),
                       n_programs = length(unique(ProgramID)),
                       ProgIDs = list(unique(ProgramID)),
                       n_samples = length(PercentLive_pct),
                       Median = median(PercentLive_pct),
                       Mean = round(mean(PercentLive_pct), digits = 2),
                       SD = round(sd(PercentLive_pct), digits = 2), 
                       Min. = min(PercentLive_pct),
                       Max. = max(PercentLive_pct)),
                by = Year]

pct_status <- unique(pct_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
pct_status <- pct_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]

#Fill in any missing years.
if(setequal(StatusYears, pct_status$Year) == FALSE){
  for(i in setdiff(StatusYears, pct_status$Year)){
    MissingYr_i <- data.table(Indicator = "Percent Live", 
                              SizeClass = "All",
                              Year = i,
                              n_reefs = 0,
                              n_programs = 0,
                              ProgIDs = list(NA),
                              n_samples = 0,
                              Median = NA, 
                              Mean = NA,
                              SD = NA,
                              Min. = NA,
                              Max. = NA)
    
    pct_status <- rbind(pct_status, MissingYr_i)
  }
}

# #Build status table for size class >75mm next.
# den_o75_status <- subset(lb_sho75, lb_sho75$Year %in% StatusYears)
# den_o75_status[, `:=` (Indicator = "Density", 
#                      SizeClass = ">75mm", 
#                      Year = as.numeric(Year), 
#                      n_reefs = length(unique(ReefIdentifier)),
#                      n_programs = length(unique(ProgramID)),
#                      ProgIDs = list(unique(ProgramID)),
#                      n_specimens = length(Density_m2),
#                      Median = median(Density_m2),
#                      Mean = round(mean(Density_m2), digits = 2),
#                      SD = round(sd(Density_m2), digits = 2), 
#                      Min. = min(Density_m2),
#                      Max. = max(Density_m2)),
#                 by = Year]
# 
# den_o75_status <- unique(den_o75_status, by = c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "n_samples", "Median", "Mean", "SD", "Min.", "Max."))
# den_o75_status <- den_o75_status[, c("Indicator", "SizeClass", "Year", "n_reefs", "n_programs", "ProgIDs", "n_samples", "Median", "Mean", "SD", "Min.", "Max.")]
# 
# #Fill in any missing years.
# if(setequal(StatusYears, den_o75_status$Year) == FALSE){
#   for(i in setdiff(StatusYears, den_o75_status$Year)){
#     MissingYr_i <- data.table(Indicator = "Density", 
#                               SizeClass = ">75mm",
#                               Year = i,
#                               n_reefs = ifelse(den_25to75_status[Year == i, n_reefs] > 0, den_25to75_status[Year == i, n_reefs], 0),
#                               n_programs = ifelse(den_25to75_status[Year == i, n_programs] > 0, den_25to75_status[Year == i, n_programs], 0),
#                               ProgIDs = ifelse(!is.na(den_25to75_status[Year == i, ProgIDs]), den_25to75_status[Year == i, ProgIDs], NA),
#                               n_specimens = 0,
#                               Median = NA, 
#                               Mean = NA,
#                               SD = NA,
#                               Min. = NA,
#                               Max. = NA)
#     
#     den_o75_status <- rbind(den_o75_status, MissingYr_i)
#   }
# }

#Merge individual size class tables and set row order
Status <- rbind(Status, pct_status)
# Status <- rbind(Status, den_o75_status)
setorder(Status, SizeClass, Year)

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}

#Create the table
Status[] %>% 
  kbl(align = "lllccccccccc") %>%
  kable_paper(bootstrap_options = c("hover", "condensed", "responsive"), full_width = F, fixed_thead = T) %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  kable_styling() %>%
  row_spec(which(Status$n_reefs > 0), bold = T) #%>%
  #kable_styling() %>%
  #row_spec(which(Status$SizeClass == ">75mm"), background = "lightgrey")

```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
#Remove objects
rm(Status, StatusYears, pct_status, MissingYr_i) #, sho75_status)
```

<br><br><br>

##### Variable Exploration

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(lb_p_nr, aes(x = RelYear, y = PercentLive_dec, color = ReefIdentifier)) +
  geom_jitter() +
  theme_bw()

ggplot(lb_p_nr, aes(x = RelYear, y = QuadSize_m2, color = ReefIdentifier)) +
  geom_jitter() +
  theme_bw()

```

<br><br>

```{r echo=TRUE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

ggplot(lb_p_nr, aes(x = RelYear, y = ReefIdentifier, color = factor(ProgramID))) +
  geom_point() +
  theme_bw()

```

<br><br><br>

##### Model Output

```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
summary(lb_pct_glmm_nr)
```

<br><br><br>

##### Diagnostic Plots

###### Posterior distributions and Markov chains:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Pct_NovtoMar_GLMM_LB_PDistandMChains_raw <- plot(lb_pct_glmm_nr)
Pct_NovtoMar_GLMM_LB_PDistandMChains_raw

len <- length(Pct_NovtoMar_GLMM_LB_PDistandMChains_raw)
for(i in 1:len){
  jpeg(filename = here::here(paste0("OA_plots/Pct_NovtoMar_GLMM_LB_PDistandMChains_raw_", i, "of", len, "_", Sys.Date(), ".jpeg")), width = 4, height = 6, units = "in", quality = 100, res = 300)
  print(Pct_NovtoMar_GLMM_LB_PDistandMChains_raw[i])
  dev.off()
}
```

<br><br><br>

###### Posterior predictive check plot:
```{r echo=TRUE, message = FALSE, warning = FALSE, out.width="100%"}
Pct_NovtoMar_GLMM_LB_PPcheck_raw <- pp_check(lb_pct_glmm_nr)
Pct_NovtoMar_GLMM_LB_PPcheck_raw

ggsave(here::here(paste0("OA_plots/Pct_NovtoMar_GLMM_LB_PPcheck_raw_", Sys.Date(), ".jpeg")),
       Pct_NovtoMar_GLMM_LB_PPcheck_raw,
       width = 4,
       height = 3,
       units = "in",
       dpi = 300)
```

##### Marginal Effects Plots

###### Including the random effect of reef (i.e., managed area-wide credible interval):

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot including random effects
set.seed(987)
lb_p1_nr <- plot(conditional_effects(lb_pct_glmm_nr, re_formula = NULL), plot = FALSE)[[1]]
Pct_NovtoMar_GLMM_LB_MEPrand_raw <- lb_p1_nr +
  geom_jitter(data = lb_p_nr, aes(x = RelYear, y = PercentLive_dec, fill = ReefIdentifier), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = lb_p_nr, aes(y = -0.05, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  #geom_text(aes(y = 0.03, label = "Note: zero-value data points were \n excluded from the model fit", x = 7.5), size = 3, col = "grey60", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(xlim = c(-0.5,10.5), ylim = c(-0.05, 1)) +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Pct_NovtoMar_GLMM_LB_MEPrand_raw

ggsave(here::here(paste0("OA_plots/Pct_NovtoMar_GLMM_LB_MEPrand_raw_", Sys.Date(), ".jpeg")),
       Pct_NovtoMar_GLMM_LB_MEPrand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Excluding the random effect of reef (i.e., sampled population credible interval):
```{r echo=TRUE, message = FALSE, warning = FALSE, fig.height=6, fig.width=10, out.width="100%"}
#Marginal effects plot excluding random effects
set.seed(984)
lb_p2_nr <- plot(conditional_effects(lb_pct_glmm_nr, re_formula = NA), plot = FALSE)[[1]]
Pct_NovtoMar_GLMM_LB_MEPnorand_raw <- lb_p2_nr +
  geom_jitter(data = lb_p_nr, aes(x = RelYear, y = PercentLive_dec, fill = ReefIdentifier), alpha = 0.5, shape = 21, size = 3, width = 0.05, color = "black", inherit.aes = FALSE) +
  geom_text(data = lb_p_nr, aes(y = -0.05, label = Year, x = RelYear), size = 4, col = "grey30", inherit.aes = FALSE) +
  #geom_text(aes(y = 0.03, label = "Note: zero-value data point was \n excluded from the model fit", x = 7.5), size = 3, col = "grey60", inherit.aes = FALSE) +
  theme_bw() +
  coord_cartesian(xlim = c(-0.5,10.5), ylim = c(-0.05, 1)) +
  labs(fill = "Reef ID") + theme(axis.title = element_text(size = 13), 
    axis.text = element_text(size = 12), 
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 13)) +labs(colour = NULL)
Pct_NovtoMar_GLMM_LB_MEPnorand_raw

ggsave(here::here(paste0("OA_plots/Pct_NovtoMar_GLMM_LB_MEPnorand_raw_", Sys.Date(), ".jpeg")),
       Pct_NovtoMar_GLMM_LB_MEPnorand_raw,
       width = 10,
       height = 6,
       units = "in",
       dpi = 300)
```

<br><br><br>

###### Individual effects plots:

```{r echo=TRUE, fig.height=10, fig.width=10, message=FALSE, warning=FALSE, out.width="100%"}
#Individual effects plots
#labs1 <- sort(unique(lb_p_nr$Year))[c(TRUE, FALSE)]
labs1 <- c(2011, 2016)

Pct_NovtoMar_GLMM_LB_IEP_raw <- lb_p_nr %>%
  group_by(ReefIdentifier) %>%
  add_fitted_draws(lb_pct_glmm_nr) %>%
  ggplot(aes(x = RelYear, y = PercentLive_dec, color = ReefIdentifier)) +
  stat_lineribbon(aes(y = .value), size = 1) +
  #geom_line(aes(y = .value, group = paste(reefIDcrosswalk, .draw)), alpha = 0.1) +
  geom_point(data = lb_p_nr) + #, aes(fill = reefIDcrosswalk), shape = 21, color = "black") +
  #geom_line(aes(y = .value), linetype = "dashed", color = "black") +
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2") +
  geom_text(data = subset(lb_p_nr, lb_p_nr$Year %in% labs1), aes(y = -0.12, label = Year, x = RelYear), size = 3, col = "grey30", inherit.aes = FALSE) +
  theme_bw() + theme(axis.line = element_line()) +
  scale_x_continuous(limits = c(-1, max(lb_p_nr$RelYear) + 1)) +
  scale_y_continuous(limits = c(-0.17, 1)) +
  #coord_cartesian(ylim = c(-40, 150)) +
  guides(color = FALSE) +
  #theme(legend.position = "none") +
  labs(color = "Reef ID", fill = "Credible Interval") +
  facet_wrap(~ ReefIdentifier, ncol = 3, scales = "free")
Pct_NovtoMar_GLMM_LB_IEP_raw

ggsave(here::here(paste0("OA_plots/Pct_NovtoMar_GLMM_LB_IEP_raw_", Sys.Date(), ".jpeg")),
       Pct_NovtoMar_GLMM_LB_IEP_raw,
       width = 10,
       height = 10,
       units = "in",
       dpi = 300)
```

```{r eval=FALSE, include=FALSE}
# Remove created objects to save memory.
rm(lb_p_nr, lb_pct_glmm_nr, 
   Pct_NovtoMar_GLMM_LB_PDistandMChains_raw,
   Pct_NovtoMar_GLMM_LB_PPcheck_raw,
   Pct_NovtoMar_GLMM_LB_MEPrand_raw,
   Pct_NovtoMar_GLMM_LB_MEPnorand_raw,
   Pct_NovtoMar_GLMM_LB_IEP_raw
   )

```

<br><br><br>

***

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>