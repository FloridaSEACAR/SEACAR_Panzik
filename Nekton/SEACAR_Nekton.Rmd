---
title: "SEACAR Nekton Analysis"
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 2
    dev: png
    keep_md: yes
  pdf_document:
    toc: TRUE
    toc_depth: 2
    dev: png
    extra_dependencies: ["float"]
---

# Important Notes
All scripts and outputs can be found on the SEACAR GitHub repository:

https://github.com/FloridaSEACAR/SEACAR_Panzik



# Libraries and Settings

Loads libraries used in the script. Loads the Segoe UI font for use in the figures. The inclusion of `scipen` option limits how frequently R defaults to scientific notation. Sets default settings for displaying warning and messages in created document, and sets figure dpi.

```{r libraries, message=FALSE}
library(knitr)
library(data.table)
library(dplyr)
library(lubridate)
library(ggplot2)
library(scales)
library(tidyr)
library(gridExtra)
library(tidyverse)
library(png)
windowsFonts(`Segoe UI` = windowsFont('Segoe UI'))
options(scipen=999)
opts_chunk$set(warning=FALSE, message=FALSE, dpi=200)
```



# File Import

Imports file that is determined in the SEACAR_Nekton_Render.R script. 

The command `fread` is used because of its improved speed while handling large data files. Only columns that are used by the script are imported from the file, and are designated in the `select` input.

The script then gets the name of the parameter as it appears in the data file and units of the parameter.

```{r file_import}
data <- fread(file_in, sep="|", header=TRUE, stringsAsFactors=FALSE,
             # select=c("ManagedAreaName", "ProgramID", "ProgramName",
             #            "ProgramLocationID", "SampleDate", "Year", "Month",
             #            "RelativeDepth", "ActivityType", "ParameterName",
             #            "ResultValue", "ParameterUnits", "ValueQualifier",
             #            "SEACAR_QAQCFlagCode", "Include"),
             na.strings="")
parameter <- unique(data$ParameterName)
if(parameter=="Presence"){
      parameter <- "Species Richness"
      param_name <- "SpeciesRichness"
}
unit <- unique(data$ParameterUnits)
```



# Data Filtering

Documentation on database filtering is provided here: [SEACAR Documentation- Analysis Filters and Calculations.docx](https://github.com/FloridaSEACAR/SEACAR_Panzik/blob/main/SEACAR%20Documentation%20-%20Analysis%20Filters%20and%20Calculations.docx)

The filtering that is performed by the script at this point removes rows that are missing values for `ResultValue` and `EffortCorrection_100m2`, and removes any `EffortCorrection_100m2` that is 0 because it will cause an infinite number when determining Species Richness.

A group of unique `ManagedAreaName`, `ProgramID`, `ProgramName`, `ProgramLocationID`, `SampleDate`, and `GearSize_m` are being considered a "reference" for measurement. For each "reference", the number of observed species is summed and then divided by the `EffortCorrection_100m2`to determine the Species Richness per 100 square meters.

The `ManagedAreaName` values from the data are actually shortened versions, and are merged with the full versions. The species richness data is then written to a file. And the list of Managed Areas with observations is stored.

```{r filtering}
data <- data[!is.na(data$EffortCorrection_100m2),]
data <- data[data$EffortCorrection_100m2!=0,]
data <- data[!is.na(data$ResultValue),]

data <- data %>%
   group_by(ManagedAreaName, ProgramID, ProgramName, ProgramLocationID,
            SampleDate, GearSize_m) %>%
   summarise(ParameterName=parameter,
             Year=unique(Year), Month=unique(Month),
             N_Species=sum(ResultValue),
             EffortCorrection_100m2=unique(EffortCorrection_100m2),
             SpeciesRichness=N_Species/unique(EffortCorrection_100m2))

setnames(data, c("ManagedAreaName"), c("ShortName"))

data <- merge.data.frame(MA_All[,c("AreaID", "ManagedAreaName", "ShortName")],
                          data, by="ShortName", all=TRUE)

data$ShortName <- NULL

fwrite(data, paste0(out_dir,"/Nekton_", param_name, "_UsedData.txt"), sep="|")

data$SampleDate <- as.Date(data$SampleDate)

MA_Include <- unique(data$ManagedAreaName[!is.na(data$N_Species)])
MA_Include <- MA_Include[order(MA_Include)]
n <- length(MA_Include)
```



# Managed Area Statistics

Gets summary statistics for each managed area. Uses piping from dplyr package to feed into subsequent steps. The following steps are performed:

1. Group data that have the same `ManagedAreaName`, `Year`, `Month`, and `GearSize_m`.
   + Second summary statistics do not use the `Month` grouping and are only for `ManagedAreaName` and `Year`.
   + Third summary statistics do not use `Year` grouping and are only for `ManagedAreaName` and `Month`

2. For each group, provide the following information: Parameter Name (ParameterName), Number of Entries (N_Data), Lowest Value (Min), Largest Value (Max), Median, Mean, Standard Deviation, and a list of all Program IDs included in these measurements.
3. Sort the data in ascending (A to Z and 0 to 9) order based on `ManagedAreaName` then `Year` then `Month`
4. Write summary stats to a pipe-delimited .txt file in the output directory
   + [Click this text to open Git directory with output files](https://github.com/FloridaSEACAR/SEACAR_Panzik/tree/main/output/WQ)


```{r managed_area_stats, message=FALSE}
MA_YM_Stats <- data %>%
   group_by(AreaID, ManagedAreaName, Year, Month, GearSize_m) %>%
   summarize(ParameterName=parameter,
             N_Data=length(na.omit(SpeciesRichness)),
             Min=min(SpeciesRichness),
             Max=max(SpeciesRichness),
             Median=median(SpeciesRichness),
             Mean=mean(SpeciesRichness),
             StandardDeviation=sd(SpeciesRichness),
             ProgramIDs=paste(sort(unique(ProgramID), decreasing=FALSE),
                              collapse=', '))
MA_YM_Stats <- as.data.table(MA_YM_Stats[order(MA_YM_Stats$ManagedAreaName,
                                               MA_YM_Stats$Year,
                                               MA_YM_Stats$Month,
                                               MA_YM_Stats$GearSize_m), ])
fwrite(MA_YM_Stats, paste0(out_dir,"/Nekton_", param_name,
                           "_ManagedArea_YearMonth_Stats.txt"), sep="|")
rm(MA_YM_Stats)

MA_Y_Stats <- data %>%
   group_by(AreaID, ManagedAreaName, Year, GearSize_m) %>%
   summarize(ParameterName=parameter,
             N_Data=length(na.omit(SpeciesRichness)),
             Min=min(SpeciesRichness),
             Max=max(SpeciesRichness),
             Median=median(SpeciesRichness),
             Mean=mean(SpeciesRichness),
             StandardDeviation=sd(SpeciesRichness),
             ProgramIDs=paste(sort(unique(ProgramID), decreasing=FALSE),
                              collapse=', '))
MA_Y_Stats <- as.data.table(MA_Y_Stats[order(MA_Y_Stats$ManagedAreaName,
                                             MA_Y_Stats$Year,
                                             MA_Y_Stats$GearSize_m), ])
fwrite(MA_Y_Stats, paste0(out_dir,"/Nekton_", param_name,
                          "_ManagedArea_Year_Stats.txt"), sep="|")

MA_M_Stats <- data %>%
   group_by(AreaID, ManagedAreaName, Month, GearSize_m) %>%
   summarize(ParameterName=parameter,
             N_Data=length(na.omit(SpeciesRichness)),
             Min=min(SpeciesRichness),
             Max=max(SpeciesRichness),
             Median=median(SpeciesRichness),
             Mean=mean(SpeciesRichness),
             StandardDeviation=sd(SpeciesRichness),
             ProgramIDs=paste(sort(unique(ProgramID), decreasing=FALSE),
                              collapse=', '))
MA_M_Stats <- as.data.table(MA_M_Stats[order(MA_M_Stats$ManagedAreaName,
                                             MA_M_Stats$Month,
                                             MA_M_Stats$GearSize_m), ])
fwrite(MA_M_Stats, paste0(out_dir,"/Nekton_", param_name,
                          "_ManagedArea_Month_Stats.txt"), sep="|")
rm(MA_M_Stats)

MA_Ov_Stats <- data %>%
   group_by(AreaID, ManagedAreaName, GearSize_m) %>%
   summarize(ParameterName=parameter,
             N_Years=length(unique(na.omit(Year))),
             EarliestYear=min(Year),
             LatestYear=max(Year),
             N_Data=length(na.omit(SpeciesRichness)),
             Min=min(SpeciesRichness),
             Max=max(SpeciesRichness),
             Median=median(SpeciesRichness),
             Mean=mean(SpeciesRichness),
             StandardDeviation=sd(SpeciesRichness),
             ProgramIDs=paste(sort(unique(ProgramID), decreasing=FALSE),
                              collapse=', '))
MA_Ov_Stats <- as.data.table(MA_Ov_Stats[order(MA_Ov_Stats$ManagedAreaName,
                                               MA_Ov_Stats$GearSize_m), ])
fwrite(MA_Ov_Stats, paste0(out_dir,"/Nekton_", param_name,
                           "_ManagedArea_Overall_Stats.txt"), sep="|")
MA_Ov_Stats <- MA_Ov_Stats[!is.na(MA_Ov_Stats$EarliestYear), ]
```



# Appendix I: Managed Area Species Richness

The plots shown here are the species richness for each managed area with a yearly average, separated by gear size.

1. Set common plot theme.
2. Determine the earliest and latest year of the data to create x-axis scale and intervals
3. Set the plot type as a point plot with the size of the points
4. Add the linear trend
5. Create the title, x-axis, y-axis, and color fill labels
6. Set the y and x limits
7. Apply common plot theme
8. Create file name to save figure
9. Save figure as png file

```{r Trendlines_ManagedArea, warning=FALSE, fig.height=6, fig.width=8, results="asis", eval=APP_Plots}
plot_theme <- theme_bw() +
      theme(text=element_text(family="Segoe UI"),
            title=element_text(face="bold"),
            plot.title=element_text(hjust=0.5, size=14, color="#314963"),
            plot.subtitle=element_text(hjust=0.5, size=10, color="#314963"),
            axis.title.x = element_text(margin = margin(t = 5, r = 0,
                                                        b = 10, l = 0)),
            axis.title.y = element_text(margin = margin(t = 0, r = 10,
                                                        b = 0, l = 0)),
            axis.text=element_text(size=10),
            axis.text.x=element_text(face="bold", angle = 60, hjust = 1),
            axis.text.y=element_text(face="bold"))

colorlist <- c("#00374f",
               "#004d68",
               "#006481",
               "#007c99",
               "#0094b0",
               "#00aec6",
               "#00c9db",
               "#00e4ee",
               "#00ffff")

if(n==0){
      print("There are no monitoring locations that qualify.")
} else {
      for (i in 1:n) {
            plot_data <- MA_Y_Stats[MA_Y_Stats$ManagedAreaName==MA_Include[i]]
            t_max <- max(MA_Ov_Stats$LatestYear[MA_Ov_Stats$ManagedAreaName==
                                                      MA_Include[i]])
            t_min <- min(MA_Ov_Stats$EarliestYear[MA_Ov_Stats$ManagedAreaName==
                                                        MA_Include[i]])
            t <- t_max-t_min
            
            if(t>=30){
                  brk <- -10
            }else if(t<30 & t>=10){
                  brk <-5
            }else if(t<10 & t>=4){
                  brk <- -2
            }else if(t<4){
                  brk <- -1
            }
            
            p1 <- ggplot(data=plot_data, group=as.factor(GearSize_m)) +
                  geom_point(aes(x=Year, y=Mean, fill=as.factor(GearSize_m)), shape=21,
                             size=3, color="#333333", alpha=0.75) +
                  geom_line(aes(x=Year, y=Mean, color=as.factor(GearSize_m)),
                            size=1.2, alpha=0.7) +
                  labs(title=MA_Include[i],
                       subtitle="Species Richness",
                       x="Year", y="Number of Species per 100 square meters",
                       fill="Gear Size (m)", color="Gear Size (m)") +
                  scale_x_continuous(limits=c(t_min-0.25,
                                              t_max+0.25),
                                     breaks=seq(t_max,
                                                t_min,
                                                brk)) +
                  plot_theme
            
            outname <- paste0("Nekton_", gsub(" ", "", MA_Include[i]), "_",
                              param_name, ".png")
            png(paste0(out_dir, "/Figures/", outname),
                width = 8,
                height = 4,
                units = "in",
                res = 200)
            rm(plot_data)
            
            print(p1)
            dev.off()
            
      
            ResultTable <- MA_Ov_Stats[MA_Ov_Stats$ManagedAreaName==MA_Include[i],]
            ResultTable <- ResultTable[,-c("AreaID", "ManagedAreaName",
                                             "ProgramIDs")]
            t1 <- ggtexttable(ResultTable, rows = NULL,
                              theme=ttheme(base_size=7))
            print(ggarrange(p1, t1, ncol=1, heights=c(0.85, 0.15)))
            
            cat("\n \n \n \n")
      }
}
```