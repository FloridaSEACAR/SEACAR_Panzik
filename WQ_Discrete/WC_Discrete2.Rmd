---
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 2
    dev: png
    keep_md: yes
  word_document:
    toc: TRUE
    toc_depth: 2
  pdf_document:
    toc: TRUE
    toc_depth: 2
    dev: png
    extra_dependencies: ["float"]
    keep_md: yes
urlcolor: blue
params:
  managedarea: ma,
  p_inc: included_params,
  a_inc: included_acts,
  d_inc: included_depths
title: '`r paste(ma)`'
subtitle: '`r paste("SEACAR Discrete Water Quality Analysis")`'
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(
   warning=FALSE,
   message=FALSE,
   echo=FALSE,
   dpi=200
)
```


```{r libraries, message=FALSE, echo=FALSE, warning=FALSE, include=FALSE}
library(knitr)
library(data.table)
library(dplyr)
library(lubridate)
library(ggplot2)
library(ggpubr)
library(scales)
library(EnvStats)
library(tidyr)
library(kableExtra)
library(glue)
options(scipen=999)
```



# Parameters



``` {r load_data_table function}

# Load Data Table Function
load_data_table <- function(p, a="All", d="All", table) {
  
  if (table == "data") {
    filename_string <- paste0(p,"_",table)
  } else {
    filename_string <- paste0(p,"_",a,"_",d,"_",table)
  }
  
  # subset file list to select desired table RDS file
  table_file <- paste0("output/tables/",str_subset(files, filename_string))
  
  # importing RDS files
  df <- lapply(table_file, readRDS)

  return(df)
}


```



```{r Trendlines_ManagedArea Function}

plot_trendlines <- function(p, a, d, activity_label, depth_label, y_labels, parameter) {
  
  MA_YM_Stats <- as.data.frame(load_data_table(p, a, d, "MA_MMYY_Stats"))
  skt_stats <- as.data.frame(load_data_table(p, a, d, "skt_stats"))
  
  ### SKT STATS ###
  # Gets x and y values for starting point for trendline
  KT.Plot <- skt_stats %>%
    group_by(ManagedAreaName) %>%
    summarize(x=decimal_date(EarliestSampleDate),
              y=(x-EarliestYear)*SennSlope+SennIntercept)
  # Gets x and y values for ending point for trendline
  KT.Plot2 <- skt_stats %>%
    group_by(ManagedAreaName) %>%
    summarize(x=decimal_date(LastSampleDate),
              y=(x-EarliestYear)*SennSlope+SennIntercept)
  # Combines the starting and endpoints for plotting the trendline
  KT.Plot <- bind_rows(KT.Plot, KT.Plot2)
  rm(KT.Plot2)
  KT.Plot <- as.data.table(KT.Plot[order(KT.Plot$ManagedAreaName), ])
  KT.Plot <- KT.Plot[!is.na(KT.Plot$y),]

  # Checking for missing values
  check_ym <- MA_YM_Stats %>%
    filter(ManagedAreaName == ma)
  
  if (nrow(check_ym) == 0) {
    invisible()
    # print("error")
  } else {
    # Gets data to be used in plot for managed area
    plot_data <- MA_YM_Stats[MA_YM_Stats$ManagedAreaName==ma,]

    # Gets trendline data for managed area
    KT.plot_data <- KT.Plot[KT.Plot$ManagedAreaName==ma,]

    #Determine max and min time (Year) for plot x-axis
    t_min <- min(plot_data$Year)
    t_max <- max(plot_data$YearMonthDec)
    t_max_brk <- as.integer(round(t_max, 0))
    t <- t_max-t_min
    min_RV <- min(plot_data$Mean)

    # Sets break intervals based on the number of years spanned by data
    if(t>=30){
      brk <- -10
    }else if(t<30 & t>=10){
      brk <- -5
    }else if(t<10 & t>=4){
      brk <- -2
    }else if(t<4){
      brk <- -1
    }

    # Create plot object with data and trendline
    p1 <- ggplot(data=plot_data,
          aes(x=YearMonthDec, y=Mean)) +
      # geom_line(size=0.75, color="#333333", alpha=0.6) +
      geom_point(shape=21, size=3, color="#333333", fill="#cccccc",
           alpha=0.75) +
      geom_line(data=KT.plot_data, aes(x=x, y=y),
          color="#000099", size=1.2, alpha=0.7) +
      labs(title=paste0(parameter,", ",activity_label, ", ",depth_label),
        subtitle=ma,
        x="Year", y=y_labels) +
      scale_x_continuous(limits=c(t_min-0.25, t_max+0.25),
                breaks=seq(t_max_brk, t_min, brk)) +
      plot_theme
    # Creates ResultTable to display statistics below plot
    ResultTable <- skt_stats[skt_stats$ManagedAreaName==ma, ] %>%
      select(RelativeDepth, N_Data, N_Years, Median, Independent, tau, p,
          SennSlope, SennIntercept, ChiSquared, pChiSquared, Trend)
    # Create table object
    t1 <- ggtexttable(ResultTable, rows=NULL,
            theme=ttheme(base_size=10)) %>%
      tab_add_footnote(text="p < 0.00005 appear as 0 due to rounding.\n
              SennIntercept is intercept value at beginning of
              record for monitoring location",
              size=10, face="italic")
    # Arrange and display plot and statistic table
    print(ggarrange(p1, t1, ncol=1, heights=c(0.85, 0.15)))
    # Add extra space at the end to prevent the next figure from being too
    # close.
    cat("\n \n \n")
    rm(plot_data)
    rm(MA_YM_Stats)
    # rm(KT.Plot)
    rm(skt_stats)
  }
}

```


```{r plot_boxplots function}

plot_boxplots <- function(p, a, d, activity_label, depth_label, y_labels, parameter) {
  data <- as.data.frame(load_data_table(p, a, d, "data"))
  
  plot_title <- paste0(parameter,", ",activity_label, ", ",depth_label)
  
  # Determine upper and lower bounds of time for x-axis
  plot_data <- data[data$SufficientData==TRUE &
             data$ManagedAreaName==ma,]
  year_lower <- min(plot_data$Year)
  year_upper <- max(plot_data$Year)
  
  # Determine upper and lower bounds of ResultValue for y-axis
  min_RV <- min(plot_data$ResultValue)
  mn_RV <- mean(plot_data$ResultValue[plot_data$ResultValue <
                      quantile(data$ResultValue, 0.98)])
  sd_RV <- sd(plot_data$ResultValue[plot_data$ResultValue <
                    quantile(data$ResultValue, 0.98)])
  # Sets x- and y-axis scale
  x_scale <- ifelse(year_upper - year_lower > 30, 10, 5)
  y_scale <- mn_RV + 4 * sd_RV
  
  ##Year plots
  # Create plot object for auto-scaled y-axis plot
  p1 <- ggplot(data=plot_data,
        aes(x=Year, y=ResultValue, group=Year)) +
    geom_boxplot(color="#333333", fill="#cccccc", outlier.shape=21,
           outlier.size=3, outlier.color="#333333",
           outlier.fill="#cccccc", outlier.alpha=0.75) +
    labs(subtitle="Autoscale",
      x="Year", y=y_labels) +
    scale_x_continuous(limits=c(year_lower - 1, year_upper + 1),
              breaks=rev(seq(year_upper,
                    year_lower, -x_scale))) +
    plot_theme
  # Create plot object for y-axis scaled plot
  p2 <- ggplot(data=plot_data,
        aes(x=Year, y=ResultValue, group=Year)) +
    geom_boxplot(color="#333333", fill="#cccccc", outlier.shape=21,
           outlier.size=3, outlier.color="#333333",
           outlier.fill="#cccccc", outlier.alpha=0.75) +
    labs(subtitle="Scaled to 4x Standard Deviation",
      x="Year", y=y_labels) +
    ylim(min_RV, y_scale) +
    scale_x_continuous(limits=c(year_lower - 1, year_upper + 1),
              breaks=rev(seq(year_upper,
                    year_lower, -x_scale))) +
    plot_theme
  # Create plot object for y-axis scaled plot for past 10 years
  p3 <- ggplot(data=plot_data[plot_data$Year >= year_upper - 10, ],
        aes(x=Year, y=ResultValue, group=Year)) +
    geom_boxplot(color="#333333", fill="#cccccc", outlier.shape=21,
           outlier.size=3, outlier.color="#333333",
           outlier.fill="#cccccc", outlier.alpha=0.75) +
    labs(subtitle="Scaled to 4x Standard Deviation, Last 10 Years",
      x="Year", y=y_labels) +
    ylim(min_RV, y_scale) +
    scale_x_continuous(limits=c(year_upper - 10.5, year_upper + 1),
              breaks=rev(seq(year_upper, year_upper - 10,-2))) +
    plot_theme
  # Arrange plot objects
  Yset <- ggarrange(p1, p2, p3, ncol=1)
  # Create plot title object
  p0 <- ggplot() + labs(title=plot_title,
              subtitle="By Year") +
    plot_theme + theme(panel.border=element_blank(),
              panel.grid.major=element_blank(),
              panel.grid.minor=element_blank(),
              axis.line=element_blank())
  
  
  ## Year & Month Plots
  # Create plot object for auto-scaled y-axis plot
  p4 <- ggplot(data=plot_data,
        aes(x=YearMonthDec, y=ResultValue,
            group=YearMonth, color=as.factor(Month))) +
    geom_boxplot(fill="#cccccc", outlier.size=1.5, outlier.alpha=0.75) +
    labs(subtitle="Autoscale",
      x="Year", y=y_labels, color="Month") +
    scale_x_continuous(limits=c(year_lower - 1, year_upper + 1),
              breaks=rev(seq(year_upper,
                    year_lower, -x_scale))) +
    plot_theme +
    theme(legend.position="none")
  # Create plot object for y-axis scaled plot
  p5 <- ggplot(data=plot_data,
        aes(x=YearMonthDec, y=ResultValue,
            group=YearMonth, color=as.factor(Month))) +
    geom_boxplot(fill="#cccccc", outlier.size=1.5, outlier.alpha=0.75) +
    labs(subtitle="Scaled to 4x Standard Deviation",
      x="Year", y=y_labels, color="Month") +
    ylim(min_RV, y_scale) +
    scale_x_continuous(limits=c(year_lower - 1, year_upper + 1),
              breaks=rev(seq(year_upper,
                    year_lower, -x_scale))) +
    plot_theme +
    theme(legend.position="top", legend.box="horizontal") +
    guides(color=guide_legend(nrow=1))
  # Create plot object for y-axis scaled plot for past 10 years
  p6 <- ggplot(data=plot_data[plot_data$Year >= year_upper - 10, ],
        aes(x=YearMonthDec, y=ResultValue,
            group=YearMonth, color=as.factor(Month))) +
    geom_boxplot(fill="#cccccc", outlier.size=1.5, outlier.alpha=0.75) +
    labs(subtitle="Scaled to 4x Standard Deviation, Last 10 Years",
      x="Year", y=y_labels, color="Month") +
    ylim(min_RV, y_scale) +
    scale_x_continuous(limits=c(year_upper - 10.5, year_upper + 1),
              breaks=rev(seq(year_upper, year_upper - 10,-2))) +
    plot_theme +
    theme(legend.position="none")
  # Create legend object
  leg1 <- get_legend(p5)
  # Arrange plots and legend
  YMset <- ggarrange(leg1, p4, p5 + theme(legend.position="none"), p6,
           ncol=1, heights=c(0.1, 1, 1, 1))
  # Create plot title object
  p00 <- ggplot() + labs(title=plot_title,
               subtitle="By Year & Month") + plot_theme +
    theme(panel.border=element_blank(),
       panel.grid.major=element_blank(),
       panel.grid.minor=element_blank(), axis.line=element_blank())
  
  ## Month Plots
  # Create plot object for auto-scaled y-axis plot
  p7 <- ggplot(data=plot_data,
        aes(x=Month, y=ResultValue,
            group=Month, fill=as.factor(Month))) +
    geom_boxplot(color="#333333", outlier.shape=21, outlier.size=3,
           outlier.color="#333333", outlier.alpha=0.75) +
    labs(subtitle="Autoscale",
      x="Month", y=y_labels, fill="Month") +
    scale_x_continuous(limits=c(0, 13), breaks=seq(3, 12, 3)) +
    plot_theme +
    theme(legend.position="none")
  # Create plot object for y-axis scaled plot
  p8 <- ggplot(data=plot_data,
        aes(x=Month, y=ResultValue,
            group=Month, fill=as.factor(Month))) +
    geom_boxplot(color="#333333", outlier.shape=21, outlier.size=3,
           outlier.color="#333333", outlier.alpha=0.75) +
    labs(subtitle="Scaled to 4x Standard Deviation",
      x="Month", y=y_labels, fill="Month") +
    ylim(min_RV, y_scale) +
    scale_x_continuous(limits=c(0, 13), breaks=seq(3, 12, 3)) +
    plot_theme +
    theme(legend.position="top", legend.box="horizontal") +
    guides(fill=guide_legend(nrow=1))
  # Create plot object for y-axis scaled plot for past 10 years
  p9 <- ggplot(data=plot_data[plot_data$Year >= year_upper - 10, ],
        aes(x=Month, y=ResultValue,
            group=Month, fill=as.factor(Month))) +
    geom_boxplot(color="#333333", outlier.shape=21, outlier.size=3,
           outlier.color="#333333", outlier.alpha=0.75) +
    labs(subtitle="Scaled to 4x Standard Deviation, Last 10 Years",
      x="Month", y=y_labels, fill="Month") +
    ylim(min_RV, y_scale) +
    scale_x_continuous(limits=c(0, 13), breaks=seq(3, 12, 3)) +
    plot_theme +
    theme(legend.position="none")
  # Create legend object
  leg2 <- get_legend(p8)
  # Arrange plots and legend
  Mset <- ggarrange(leg2, p7, p8 + theme(legend.position="none"), p9,
          ncol=1, heights=c(0.1, 1, 1, 1))
  # Create title object
  p000 <- ggplot() + labs(title=plot_title,
             subtitle="By Month") + plot_theme +
    theme(panel.border=element_blank(),
       panel.grid.major=element_blank(),
       panel.grid.minor=element_blank(), axis.line=element_blank())
  # Arrange and display plots with titles for all combinations
  print(ggarrange(p0, Yset, ncol=1, heights=c(0.07, 1)))
  print(ggarrange(p00, YMset, ncol=1, heights=c(0.07, 1)))
  print(ggarrange(p000, Mset, ncol=1, heights=c(0.07, 1, 0.7)))
  # Add extra space at the end to prevent the next figure from being too
  # close.
  cat("\n \n \n")
  
  rm(plot_data)
  rm(p1, p2, p3, p4, p5, p6, p7, p8, p9, p0, p00, p000, leg1, leg2,
    Yset, YMset, Mset)
}

```


```{r VQ_Summary Barplot function}

plot_vq_barplot <- function(p, a, d, activity_label, depth_label, y_labels, parameter) {
  VQ_Summary <- as.data.frame(load_data_table(p, a, d, "VQSummary"))
  
  # Filter and subset dataframe for managed area
  ma_vq_summary <- VQ_Summary %>% filter(ManagedAreaName == ma)

  # VQSummary conditions for qualifying VQ values
  vq_condition <- ma_vq_summary$N_H !=0 | ma_vq_summary$N_I != 0 | ma_vq_summary$N_Q != 0 | ma_vq_summary$N_S != 0 | ma_vq_summary$N_U != 0
  
  # apply VQ_conditions to subset dataframe
  filtered_vq <- ma_vq_summary[vq_condition, ]
  
  # check to see if there are any qualifying VQ values, if not, skip
  if (nrow(filtered_vq) != 0) {
    # select respective perc_vq columns
    plot_data <- filtered_vq %>% 
      select(Year, perc_H, perc_I, perc_Q, perc_S, perc_U)
    
    # convert data format to "long" for plotting
    plot_data_long <- tidyr::pivot_longer(plot_data, 
                                          cols = starts_with("perc_"), 
                                          names_to = "Category", 
                                          values_to = "Percentage")
    
    # set year bounds for upper and lower
    year_lower <- min(plot_data_long$Year)
    year_upper <- max(plot_data_long$Year)
    
    # Use similar x-scaling to previous charts # may change
    x_scale <- ifelse(year_upper - year_lower > 30, 10, 
                      ifelse(year_upper == year_lower, 1, 5))
    
    # set title label
    lab_title <- paste0("Percentage Distribution of Value Qualifiers by year for ", d," Depths -  ", parameter)
    
    # plot results
    vq_plot <- ggplot(plot_data_long, aes(x=Year, y=Percentage, fill=Category)) + 
      geom_bar(stat = "identity", position="stack") +
      labs(title = lab_title,
           subtitle = paste(ma),
           x = "Year",
           y = "Percentage") +
      ylim(0, 100) +
      scale_x_continuous(limits=c(year_lower - 1, year_upper + 1),
                         breaks=rev(seq(year_upper,
                                        year_lower, -x_scale))) +
      plot_theme
    
    # print plots
    print(vq_plot)
    
    # Add extra space at the end to prevent the next figure from being too
    # close.
    cat("\n \n \n")
    
    rm(VQ_Summary, filtered_vq, plot_data, plot_data_long, vq_plot)
  } else {
    cat(paste0("There are no qualifying Value Qualifiers for ", parameter, " in ", ma))
    cat("\n \n \n")
  }
}

```


```{r dynamic_variables}
# Create conditions to determine if plots/text are shown
dynamic_vars <- list()
for (param in p_inc) {
  val <- ifelse(param %in% p_inc, TRUE, FALSE)
  assign(paste0("show_", param), val, envir = .GlobalEnv)
  dynamic_vars[[param]] <- get(paste0("show_",param))
}
```


```{r Plotting, warning=FALSE, fig.height=9, fig.width=10, results="asis"}

# Start looping for each parameter
for (param in p_inc) {
  
  data <- as.data.frame(load_data_table(param, table="data"))
  
  # getting full parameter & unit names
  parameter <- unique(data$ParameterName)
  unit <- unique(data$ParameterUnits)
  
  # defining labels for y-axis
  y_labels <- ifelse(param == "pH", parameter, paste0(parameter, " (" , unit, ")"))
  # y_labels <- paste0(parameter, " (" , unit, ")")
  
  # Calling dynamic variables to create subtitles for each param
  if (get(paste0("show_", param))) {
    cat("\\newpage")
    subtitle <- glue("## {parameter}")
    cat(subtitle, "\n\n")
    cat("Parameter", parameter, "is included.\n\n")
  }
  
  #Because secchi depth is does not have a bottom measurement, this statement skips
  #Secchi depth for bottom
  if (param == "Secchi"){
    depth <- "Surface"
  } else {
    depth <- "All"
  }
  
  # Choosing which analyses to plot, when to combine 
  if (param == "ChlaC" |
      param == "Chla" |
      param == "CDOM" |
      param == "TN" |
      param == "TP") {activity = "Lab"} else if (
        param == "DO" |
        param == "DOS" |
        param == "pH" |
        param == "Secchi" |
        param == "TempW") {activity = "Field"} else if (
          param == "Sal" |
          param == "TSS" |
          param == "Turb") {activity = "All"}
    
  if (activity == "All") {
    activity_label <- "Lab and Field Combined"
  } else if (activity == "Field") {
    activity_label <- "Field"
  } else if (activity == "Lab") {
    activity_label <- "Lab"
  }
  
  if (depth == "All") {
    depth_label <- "All Depths"
  } else if (depth == "Surface") {
    depth_label <- "Surface"
  }
  
  # Produce trendplots
  plot_trendlines(param, activity, depth, activity_label, depth_label, y_labels, parameter)
  
  # Produce boxplots
  plot_boxplots(param, activity, depth, activity_label, depth_label, y_labels, parameter)
  
  # Produce VQ-plots
  plot_vq_barplot(param, activity, depth, activity_label, depth_label, y_labels, parameter)
}

```


